<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:39 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>channel.c</h1><a href="channel_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Channel Management</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;stdio.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="zapata_8h.html">asterisk/zapata.h</a>"</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="frame_8h.html">asterisk/frame.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="sched_8h.html">asterisk/sched.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="chanspy_8h.html">asterisk/chanspy.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="musiconhold_8h.html">asterisk/musiconhold.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="say_8h.html">asterisk/say.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="translate_8h.html">asterisk/translate.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="manager_8h.html">asterisk/manager.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="chanvars_8h.html">asterisk/chanvars.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="indications_8h.html">asterisk/indications.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="monitor_8h.html">asterisk/monitor.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="causes_8h.html">asterisk/causes.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="callerid_8h.html">asterisk/callerid.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="transcap_8h.html">asterisk/transcap.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="devicestate_8h.html">asterisk/devicestate.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="sha1_8h.html">asterisk/sha1.h</a>"</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include "<a class="code" href="threadstorage_8h.html">asterisk/threadstorage.h</a>"</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include "<a class="code" href="slinfactory_8h.html">asterisk/slinfactory.h</a>"</span>
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="structchannel__spy__trans.html">00070</a> <span class="keyword">struct </span><a class="code" href="structchannel__spy__trans.html">channel_spy_trans</a> {
<a name="l00071"></a><a class="code" href="structchannel__spy__trans.html#71a38f4cd0dc1438c6d9c308d49be0c1">00071</a>    <span class="keywordtype">int</span> <a class="code" href="structchannel__spy__trans.html#71a38f4cd0dc1438c6d9c308d49be0c1">last_format</a>;
<a name="l00072"></a><a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">00072</a>    <span class="keyword">struct </span><a class="code" href="structast__trans__pvt.html">ast_trans_pvt</a> *<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>;
<a name="l00073"></a>00073 };
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment">/*! \brief List of SPY structures </span>
<a name="l00076"></a>00076 <span class="comment">*/</span>
<a name="l00077"></a><a class="code" href="structast__channel__spy__list.html">00077</a> <span class="keyword">struct </span><a class="code" href="structast__channel__spy__list.html">ast_channel_spy_list</a> {
<a name="l00078"></a><a class="code" href="structast__channel__spy__list.html#c09aaaa2b00c752fcd138ba0065cefee">00078</a>    <span class="keyword">struct </span><a class="code" href="structchannel__spy__trans.html">channel_spy_trans</a> read_translator;
<a name="l00079"></a><a class="code" href="structast__channel__spy__list.html#7ba60a6f45d9737e1eb2978f6de8f22b">00079</a>    <span class="keyword">struct </span><a class="code" href="structchannel__spy__trans.html">channel_spy_trans</a> write_translator;
<a name="l00080"></a>00080    <a class="code" href="linkedlists_8h.html#0bcd5ca819474a5c8a780be977fef933">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__channel__spy.html">ast_channel_spy</a>) list;
<a name="l00081"></a>00081 };
<a name="l00082"></a>00082 <span class="comment"></span>
<a name="l00083"></a>00083 <span class="comment">/*! \brief Definition of the Whisper buffer */</span>
<a name="l00084"></a><a class="code" href="structast__channel__whisper__buffer.html">00084</a> struct <a class="code" href="structast__channel__whisper__buffer.html">ast_channel_whisper_buffer</a> {
<a name="l00085"></a><a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">00085</a>    <a class="code" href="lock_8h.html#55c65f4d641fac96608dabb20791a062">ast_mutex_t</a> <a class="code" href="event_8c.html#dce7c4174ce9323904a934a486c41288">lock</a>;
<a name="l00086"></a><a class="code" href="structast__channel__whisper__buffer.html#60d31eb37595dd44584be5ef363283e3">00086</a>    <span class="keyword">struct </span><a class="code" href="structast__slinfactory.html">ast_slinfactory</a> sf;
<a name="l00087"></a><a class="code" href="structast__channel__whisper__buffer.html#c8ae1c62d224b4f0a5c49e99a77ed792">00087</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> original_format;
<a name="l00088"></a><a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">00088</a>    <span class="keyword">struct </span><a class="code" href="structast__trans__pvt.html">ast_trans_pvt</a> *path;
<a name="l00089"></a>00089 };
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/* uncomment if you have problems with 'monitoring' synchronized files */</span>
<a name="l00092"></a>00092 <span class="preprocessor">#if 0</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#define MONITOR_CONSTANT_DELAY</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#define MONITOR_DELAY   150 * 8     </span><span class="comment">/*!&lt; 150 ms of MONITORING DELAY */</span>
<a name="l00095"></a>00095 <span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">/*! \brief Prevent new channel allocation if shutting down. */</span>
<a name="l00098"></a><a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">00098</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">shutting_down</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="channel_8c.html#49bb87cf832afb4af43db414e0391d75">00100</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#49bb87cf832afb4af43db414e0391d75">uniqueint</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="channel_8h.html#2173c5282c13757472cb6ac76d8ecdad">00102</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="channel_8c.html#fb1a13eb3cfac4d9cfb7c4b0d2865bde">global_fin</a>, <a class="code" href="channel_8c.html#2173c5282c13757472cb6ac76d8ecdad">global_fout</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <a class="code" href="threadstorage_8h.html#c681a874ed42c74a7042e5f6a41aacfe">AST_THREADSTORAGE</a>(state2str_threadbuf);
<a name="l00105"></a><a class="code" href="channel_8c.html#1e6dec0e2fbda212b36612175c9eebc3">00105</a> <span class="preprocessor">#define STATE2STR_BUFSIZE   32</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00107"></a>00107 <span class="comment">/*! Default amount of time to use when emulating a digit as a begin and end </span>
<a name="l00108"></a>00108 <span class="comment"> *  100ms */</span>
<a name="l00109"></a><a class="code" href="channel_8c.html#47410117e60cd124ee2dcacd28e59115">00109</a> <span class="preprocessor">#define AST_DEFAULT_EMULATE_DTMF_DURATION 100</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">/*! Minimum allowed digit length - 80ms */</span>
<a name="l00112"></a><a class="code" href="channel_8c.html#bdfac9ce5e240f345ccf9062efa2291b">00112</a> <span class="preprocessor">#define AST_MIN_DTMF_DURATION 80</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00114"></a>00114 <span class="comment">/*! Minimum amount of time between the end of the last digit and the beginning </span>
<a name="l00115"></a>00115 <span class="comment"> *  of a new one - 45ms */</span>
<a name="l00116"></a><a class="code" href="channel_8c.html#18bca10730d1ced80c262960c3f33c66">00116</a> <span class="preprocessor">#define AST_MIN_DTMF_GAP 45</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">/*! \brief List of channel drivers */</span>
<a name="l00119"></a><a class="code" href="structchanlist.html">00119</a> <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> {
<a name="l00120"></a><a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">00120</a>    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *tech;
<a name="l00121"></a>00121    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(<a class="code" href="structchanlist.html">chanlist</a>) list;
<a name="l00122"></a>00122 };
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">/*! \brief the list of registered channel types */</span>
<a name="l00125"></a>00125 static <a class="code" href="linkedlists_8h.html#c2fac4140618038d0d4f6a81e315cda6">AST_LIST_HEAD_NOLOCK_STATIC</a>(backends, <a class="code" href="structchanlist.html">chanlist</a>);
<a name="l00126"></a>00126 <span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">/*! \brief the list of channels we have. Note that the lock for this list is used for</span>
<a name="l00128"></a>00128 <span class="comment">    both the channels list and the backends list.  */</span>
<a name="l00129"></a>00129 static <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(channels, <a class="code" href="structast__channel.html">ast_channel</a>);
<a name="l00130"></a>00130 <span class="comment"></span>
<a name="l00131"></a>00131 <span class="comment">/*! \brief map AST_CAUSE's to readable string representations </span>
<a name="l00132"></a>00132 <span class="comment"> *</span>
<a name="l00133"></a>00133 <span class="comment"> * \ref causes.h</span>
<a name="l00134"></a>00134 <span class="comment">*/</span>
<a name="l00135"></a><a class="code" href="structast__cause.html">00135</a> const struct <a class="code" href="structast__cause.html">ast_cause</a> {
<a name="l00136"></a><a class="code" href="structast__cause.html#560220fc3242a805f094edce47f35702">00136</a>    <span class="keywordtype">int</span> cause;
<a name="l00137"></a><a class="code" href="structast__cause.html#b068931cc450442b63f5b3d276ea4297">00137</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>;
<a name="l00138"></a><a class="code" href="structast__cause.html#1dee80c7d5ab2c1c90aa8d2f7dd47256">00138</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__gtalk_8c.html#45c085ae9b1d6f46cf9e03f75b76fd83">desc</a>;
<a name="l00139"></a>00139 } <a class="code" href="channel_8c.html#1b1c2ab7cb4088770575bc4a46216449">causes</a>[] = {
<a name="l00140"></a>00140    { <a class="code" href="causes_8h.html#741517bf117a4510c79d1a6bed21a6c4">AST_CAUSE_UNALLOCATED</a>, <span class="stringliteral">"UNALLOCATED"</span>, <span class="stringliteral">"Unallocated (unassigned) number"</span> },
<a name="l00141"></a>00141    { <a class="code" href="causes_8h.html#f791977b11f55a3be19fe0cae757c89d">AST_CAUSE_NO_ROUTE_TRANSIT_NET</a>, <span class="stringliteral">"NO_ROUTE_TRANSIT_NET"</span>, <span class="stringliteral">"No route to specified transmit network"</span> },
<a name="l00142"></a>00142    { <a class="code" href="causes_8h.html#27e909f2c5906ff60d9e15d4e259fb7b">AST_CAUSE_NO_ROUTE_DESTINATION</a>, <span class="stringliteral">"NO_ROUTE_DESTINATION"</span>, <span class="stringliteral">"No route to destination"</span> },
<a name="l00143"></a>00143    { <a class="code" href="causes_8h.html#28e9ccf1ee7710d5d584cb834e12488f">AST_CAUSE_CHANNEL_UNACCEPTABLE</a>, <span class="stringliteral">"CHANNEL_UNACCEPTABLE"</span>, <span class="stringliteral">"Channel unacceptable"</span> },
<a name="l00144"></a>00144    { <a class="code" href="causes_8h.html#0144e24b76f51a9e4e0f656b634d4605">AST_CAUSE_CALL_AWARDED_DELIVERED</a>, <span class="stringliteral">"CALL_AWARDED_DELIVERED"</span>, <span class="stringliteral">"Call awarded and being delivered in an established channel"</span> },
<a name="l00145"></a>00145    { <a class="code" href="causes_8h.html#61909c9e8fcb106af7ca5b45729980f7">AST_CAUSE_NORMAL_CLEARING</a>, <span class="stringliteral">"NORMAL_CLEARING"</span>, <span class="stringliteral">"Normal Clearing"</span> },
<a name="l00146"></a>00146    { <a class="code" href="causes_8h.html#4a9efc81f6b873ce8f979eaa2f0af775">AST_CAUSE_USER_BUSY</a>, <span class="stringliteral">"USER_BUSY"</span>, <span class="stringliteral">"User busy"</span> },
<a name="l00147"></a>00147    { <a class="code" href="causes_8h.html#6764d94a159f6554eef33d50dbd7a3f7">AST_CAUSE_NO_USER_RESPONSE</a>, <span class="stringliteral">"NO_USER_RESPONSE"</span>, <span class="stringliteral">"No user responding"</span> },
<a name="l00148"></a>00148    { <a class="code" href="causes_8h.html#081ae4de037f35ba6ef323acd8c91bc7">AST_CAUSE_NO_ANSWER</a>, <span class="stringliteral">"NO_ANSWER"</span>, <span class="stringliteral">"User alerting, no answer"</span> },
<a name="l00149"></a>00149    { <a class="code" href="causes_8h.html#fe6f3490c1d22825bf8e1f4e50ec6cec">AST_CAUSE_CALL_REJECTED</a>, <span class="stringliteral">"CALL_REJECTED"</span>, <span class="stringliteral">"Call Rejected"</span> },
<a name="l00150"></a>00150    { <a class="code" href="causes_8h.html#364a06b7f3e3288534f0b321cccd5f09">AST_CAUSE_NUMBER_CHANGED</a>, <span class="stringliteral">"NUMBER_CHANGED"</span>, <span class="stringliteral">"Number changed"</span> },
<a name="l00151"></a>00151    { <a class="code" href="causes_8h.html#e7c366e1ab67667a7905cb46cb680573">AST_CAUSE_DESTINATION_OUT_OF_ORDER</a>, <span class="stringliteral">"DESTINATION_OUT_OF_ORDER"</span>, <span class="stringliteral">"Destination out of order"</span> },
<a name="l00152"></a>00152    { <a class="code" href="causes_8h.html#2fb2de3631d78c71c916bbf97938b8ad">AST_CAUSE_INVALID_NUMBER_FORMAT</a>, <span class="stringliteral">"INVALID_NUMBER_FORMAT"</span>, <span class="stringliteral">"Invalid number format"</span> },
<a name="l00153"></a>00153    { <a class="code" href="causes_8h.html#6f06120bb4079a83998d6ed9057f4ac6">AST_CAUSE_FACILITY_REJECTED</a>, <span class="stringliteral">"FACILITY_REJECTED"</span>, <span class="stringliteral">"Facility rejected"</span> },
<a name="l00154"></a>00154    { <a class="code" href="causes_8h.html#02abf8b113aef5d946f42954ed2acb9b">AST_CAUSE_RESPONSE_TO_STATUS_ENQUIRY</a>, <span class="stringliteral">"RESPONSE_TO_STATUS_ENQUIRY"</span>, <span class="stringliteral">"Response to STATus ENQuiry"</span> },
<a name="l00155"></a>00155    { <a class="code" href="causes_8h.html#d929c033817bb608fdc7c4d0d93f91b9">AST_CAUSE_NORMAL_UNSPECIFIED</a>, <span class="stringliteral">"NORMAL_UNSPECIFIED"</span>, <span class="stringliteral">"Normal, unspecified"</span> },
<a name="l00156"></a>00156    { <a class="code" href="causes_8h.html#e2abe8db16d6ab00ae077536fb63056f">AST_CAUSE_NORMAL_CIRCUIT_CONGESTION</a>, <span class="stringliteral">"NORMAL_CIRCUIT_CONGESTION"</span>, <span class="stringliteral">"Circuit/channel congestion"</span> },
<a name="l00157"></a>00157    { <a class="code" href="causes_8h.html#11c5addd797209ad404135399fa6342d">AST_CAUSE_NETWORK_OUT_OF_ORDER</a>, <span class="stringliteral">"NETWORK_OUT_OF_ORDER"</span>, <span class="stringliteral">"Network out of order"</span> },
<a name="l00158"></a>00158    { <a class="code" href="causes_8h.html#78fd8f1c40bfcfe9ab1af87e0fdecd9f">AST_CAUSE_NORMAL_TEMPORARY_FAILURE</a>, <span class="stringliteral">"NORMAL_TEMPORARY_FAILURE"</span>, <span class="stringliteral">"Temporary failure"</span> },
<a name="l00159"></a>00159    { <a class="code" href="causes_8h.html#582edf23d210d6c3c1f6387b0a0ba418">AST_CAUSE_SWITCH_CONGESTION</a>, <span class="stringliteral">"SWITCH_CONGESTION"</span>, <span class="stringliteral">"Switching equipment congestion"</span> },
<a name="l00160"></a>00160    { <a class="code" href="causes_8h.html#d728e19e259529d0c0790ecb686b2625">AST_CAUSE_ACCESS_INFO_DISCARDED</a>, <span class="stringliteral">"ACCESS_INFO_DISCARDED"</span>, <span class="stringliteral">"Access information discarded"</span> },
<a name="l00161"></a>00161    { <a class="code" href="causes_8h.html#efaa49c97395fc441e01731362e506f8">AST_CAUSE_REQUESTED_CHAN_UNAVAIL</a>, <span class="stringliteral">"REQUESTED_CHAN_UNAVAIL"</span>, <span class="stringliteral">"Requested channel not available"</span> },
<a name="l00162"></a>00162    { <a class="code" href="causes_8h.html#ed9e523abd3e44649e57192e76856513">AST_CAUSE_PRE_EMPTED</a>, <span class="stringliteral">"PRE_EMPTED"</span>, <span class="stringliteral">"Pre-empted"</span> },
<a name="l00163"></a>00163    { <a class="code" href="causes_8h.html#fb8a68f7383030ae9db69015d0c7107a">AST_CAUSE_FACILITY_NOT_SUBSCRIBED</a>, <span class="stringliteral">"FACILITY_NOT_SUBSCRIBED"</span>, <span class="stringliteral">"Facility not subscribed"</span> },
<a name="l00164"></a>00164    { <a class="code" href="causes_8h.html#f5b653f1d972d0fc811f6dc908bee839">AST_CAUSE_OUTGOING_CALL_BARRED</a>, <span class="stringliteral">"OUTGOING_CALL_BARRED"</span>, <span class="stringliteral">"Outgoing call barred"</span> },
<a name="l00165"></a>00165    { <a class="code" href="causes_8h.html#0ad340fef8c748b809b929c417742096">AST_CAUSE_INCOMING_CALL_BARRED</a>, <span class="stringliteral">"INCOMING_CALL_BARRED"</span>, <span class="stringliteral">"Incoming call barred"</span> },
<a name="l00166"></a>00166    { <a class="code" href="causes_8h.html#e4d70b0d1e80a189e9e7cb13fd1d1d88">AST_CAUSE_BEARERCAPABILITY_NOTAUTH</a>, <span class="stringliteral">"BEARERCAPABILITY_NOTAUTH"</span>, <span class="stringliteral">"Bearer capability not authorized"</span> },
<a name="l00167"></a>00167    { <a class="code" href="causes_8h.html#541f6970916b30e7429bb6c1fce86d1d">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>, <span class="stringliteral">"BEARERCAPABILITY_NOTAVAIL"</span>, <span class="stringliteral">"Bearer capability not available"</span> },
<a name="l00168"></a>00168    { <a class="code" href="causes_8h.html#e120aeacd07f77d26ecefb8374c905de">AST_CAUSE_BEARERCAPABILITY_NOTIMPL</a>, <span class="stringliteral">"BEARERCAPABILITY_NOTIMPL"</span>, <span class="stringliteral">"Bearer capability not implemented"</span> },
<a name="l00169"></a>00169    { <a class="code" href="causes_8h.html#4616e1f2330a284c44f93fe152c83e3e">AST_CAUSE_CHAN_NOT_IMPLEMENTED</a>, <span class="stringliteral">"CHAN_NOT_IMPLEMENTED"</span>, <span class="stringliteral">"Channel not implemented"</span> },
<a name="l00170"></a>00170    { <a class="code" href="causes_8h.html#a8f4e17870fee2f383dcbf57dffb2849">AST_CAUSE_FACILITY_NOT_IMPLEMENTED</a>, <span class="stringliteral">"FACILITY_NOT_IMPLEMENTED"</span>, <span class="stringliteral">"Facility not implemented"</span> },
<a name="l00171"></a>00171    { <a class="code" href="causes_8h.html#0d757ed9a42e86ee9f994496aa87dd1a">AST_CAUSE_INVALID_CALL_REFERENCE</a>, <span class="stringliteral">"INVALID_CALL_REFERENCE"</span>, <span class="stringliteral">"Invalid call reference value"</span> },
<a name="l00172"></a>00172    { <a class="code" href="causes_8h.html#ffad3d1bd75b7ba2460fc0dbdf39cd60">AST_CAUSE_INCOMPATIBLE_DESTINATION</a>, <span class="stringliteral">"INCOMPATIBLE_DESTINATION"</span>, <span class="stringliteral">"Incompatible destination"</span> },
<a name="l00173"></a>00173    { <a class="code" href="causes_8h.html#0cd1d16501d9770834d1ad52d39c372e">AST_CAUSE_INVALID_MSG_UNSPECIFIED</a>, <span class="stringliteral">"INVALID_MSG_UNSPECIFIED"</span>, <span class="stringliteral">"Invalid message unspecified"</span> },
<a name="l00174"></a>00174    { <a class="code" href="causes_8h.html#ff7a539b31b90c77836498dbd14bde75">AST_CAUSE_MANDATORY_IE_MISSING</a>, <span class="stringliteral">"MANDATORY_IE_MISSING"</span>, <span class="stringliteral">"Mandatory information element is missing"</span> },
<a name="l00175"></a>00175    { <a class="code" href="causes_8h.html#4264d8cba3668bb88929c124a0efac9f">AST_CAUSE_MESSAGE_TYPE_NONEXIST</a>, <span class="stringliteral">"MESSAGE_TYPE_NONEXIST"</span>, <span class="stringliteral">"Message type nonexist."</span> },
<a name="l00176"></a>00176    { <a class="code" href="causes_8h.html#db1a1db4a39f551ef0bed48e6b9e1bab">AST_CAUSE_WRONG_MESSAGE</a>, <span class="stringliteral">"WRONG_MESSAGE"</span>, <span class="stringliteral">"Wrong message"</span> },
<a name="l00177"></a>00177    { <a class="code" href="causes_8h.html#fbb0bd76751429b5955b0e4375c63ffd">AST_CAUSE_IE_NONEXIST</a>, <span class="stringliteral">"IE_NONEXIST"</span>, <span class="stringliteral">"Info. element nonexist or not implemented"</span> },
<a name="l00178"></a>00178    { <a class="code" href="causes_8h.html#bb23a7b85848b22cefcdac1a459a31a3">AST_CAUSE_INVALID_IE_CONTENTS</a>, <span class="stringliteral">"INVALID_IE_CONTENTS"</span>, <span class="stringliteral">"Invalid information element contents"</span> },
<a name="l00179"></a>00179    { <a class="code" href="causes_8h.html#3292f0ecb622341da8112c2d8f2e5c4c">AST_CAUSE_WRONG_CALL_STATE</a>, <span class="stringliteral">"WRONG_CALL_STATE"</span>, <span class="stringliteral">"Message not compatible with call state"</span> },
<a name="l00180"></a>00180    { <a class="code" href="causes_8h.html#19e2815d0d87c6b8e164e37b547dd50e">AST_CAUSE_RECOVERY_ON_TIMER_EXPIRE</a>, <span class="stringliteral">"RECOVERY_ON_TIMER_EXPIRE"</span>, <span class="stringliteral">"Recover on timer expiry"</span> },
<a name="l00181"></a>00181    { <a class="code" href="causes_8h.html#694647e12ae7963f62e01813d62d8092">AST_CAUSE_MANDATORY_IE_LENGTH_ERROR</a>, <span class="stringliteral">"MANDATORY_IE_LENGTH_ERROR"</span>, <span class="stringliteral">"Mandatory IE length error"</span> },
<a name="l00182"></a>00182    { <a class="code" href="causes_8h.html#a1b7c954e260c1bfba38b7c39ae15d0a">AST_CAUSE_PROTOCOL_ERROR</a>, <span class="stringliteral">"PROTOCOL_ERROR"</span>, <span class="stringliteral">"Protocol error, unspecified"</span> },
<a name="l00183"></a>00183    { <a class="code" href="causes_8h.html#4bfdf27db9e6483fd31285e49aed7662">AST_CAUSE_INTERWORKING</a>, <span class="stringliteral">"INTERWORKING"</span>, <span class="stringliteral">"Interworking, unspecified"</span> },
<a name="l00184"></a>00184 };
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="channel_8h.html#267d0942d73ed05c65b6702fd3d0f2e0">00186</a> <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="channel_8c.html#267d0942d73ed05c65b6702fd3d0f2e0">ast_channeltype_list</a>(<span class="keywordtype">void</span>)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *cl;
<a name="l00189"></a>00189    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>=NULL, *prev = NULL;
<a name="l00190"></a>00190    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, cl, list) {
<a name="l00191"></a>00191       <span class="keywordflow">if</span> (prev)  {
<a name="l00192"></a>00192          <span class="keywordflow">if</span> ((prev-&gt;next = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#67daf92c833c41c95db874e18fcb2786">description</a>)))
<a name="l00193"></a>00193             prev = prev-&gt;next;
<a name="l00194"></a>00194       } <span class="keywordflow">else</span> {
<a name="l00195"></a>00195          var = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#67daf92c833c41c95db874e18fcb2786">description</a>);
<a name="l00196"></a>00196          prev = var;
<a name="l00197"></a>00197       }
<a name="l00198"></a>00198    }
<a name="l00199"></a>00199    <span class="keywordflow">return</span> var;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 <span class="comment"></span>
<a name="l00202"></a>00202 <span class="comment">/*! \brief Show channel types - CLI command */</span>
<a name="l00203"></a><a class="code" href="channel_8c.html#ad208619cd5b868aecef822a11a47ee0">00203</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ad208619cd5b868aecef822a11a47ee0">show_channeltypes</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205 <span class="preprocessor">#define FORMAT  "%-10.10s  %-40.40s %-12.12s %-12.12s %-12.12s\n"</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *cl;
<a name="l00207"></a>00207    <span class="keywordtype">int</span> count_chan = 0;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <a class="code" href="asterisk_8c.html#47c8929b6152d540597c758853ff95a2">FORMAT</a>, <span class="stringliteral">"Type"</span>, <span class="stringliteral">"Description"</span>,       <span class="stringliteral">"Devicestate"</span>, <span class="stringliteral">"Indications"</span>, <span class="stringliteral">"Transfer"</span>);
<a name="l00210"></a>00210    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <a class="code" href="asterisk_8c.html#47c8929b6152d540597c758853ff95a2">FORMAT</a>, <span class="stringliteral">"----------"</span>, <span class="stringliteral">"-----------"</span>, <span class="stringliteral">"-----------"</span>, <span class="stringliteral">"-----------"</span>, <span class="stringliteral">"--------"</span>);
<a name="l00211"></a>00211    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels)) {
<a name="l00212"></a>00212       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to lock channel list\n"</span>);
<a name="l00213"></a>00213       <span class="keywordflow">return</span> -1;
<a name="l00214"></a>00214    }
<a name="l00215"></a>00215    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, cl, list) {
<a name="l00216"></a>00216       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <a class="code" href="asterisk_8c.html#47c8929b6152d540597c758853ff95a2">FORMAT</a>, cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#67daf92c833c41c95db874e18fcb2786">description</a>,
<a name="l00217"></a>00217          (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3038bc3503e3e2a47e7ea6538338e371">devicestate</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00218"></a>00218          (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00219"></a>00219          (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a63038a10451f49a8611b19e6c577d90">transfer</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>);
<a name="l00220"></a>00220       count_chan++;
<a name="l00221"></a>00221    }
<a name="l00222"></a>00222    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00223"></a>00223    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"----------\n%d channel drivers registered.\n"</span>, count_chan);
<a name="l00224"></a>00224    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="preprocessor">#undef FORMAT</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 <span class="comment"></span>
<a name="l00230"></a>00230 <span class="comment">/*! \brief Show details about a channel driver - CLI command */</span>
<a name="l00231"></a><a class="code" href="channel_8c.html#0e1c8383b75188759216ba931584c65c">00231</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#0e1c8383b75188759216ba931584c65c">show_channeltype</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *cl = NULL;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235    <span class="keywordflow">if</span> (argc != 4)
<a name="l00236"></a>00236       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00237"></a>00237    
<a name="l00238"></a>00238    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels)) {
<a name="l00239"></a>00239       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to lock channel list\n"</span>);
<a name="l00240"></a>00240       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00241"></a>00241    }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, cl, list) {
<a name="l00244"></a>00244       <span class="keywordflow">if</span> (!strncasecmp(cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, argv[3], strlen(cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>))) {
<a name="l00245"></a>00245          <span class="keywordflow">break</span>;
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247    }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00250"></a>00250    <span class="keywordflow">if</span> (!cl) {
<a name="l00251"></a>00251       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\n%s is not a registered channel driver.\n"</span>, argv[3]);
<a name="l00252"></a>00252       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00253"></a>00253       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00254"></a>00254    }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,
<a name="l00257"></a>00257       <span class="stringliteral">"-- Info about channel driver: %s --\n"</span>
<a name="l00258"></a>00258       <span class="stringliteral">"  Device State: %s\n"</span>
<a name="l00259"></a>00259       <span class="stringliteral">"    Indication: %s\n"</span>
<a name="l00260"></a>00260       <span class="stringliteral">"     Transfer : %s\n"</span>
<a name="l00261"></a>00261       <span class="stringliteral">"  Capabilities: %d\n"</span>
<a name="l00262"></a>00262       <span class="stringliteral">"   Digit Begin: %s\n"</span>
<a name="l00263"></a>00263       <span class="stringliteral">"     Digit End: %s\n"</span>
<a name="l00264"></a>00264       <span class="stringliteral">"    Send HTML : %s\n"</span>
<a name="l00265"></a>00265       <span class="stringliteral">" Image Support: %s\n"</span>
<a name="l00266"></a>00266       <span class="stringliteral">"  Text Support: %s\n"</span>,
<a name="l00267"></a>00267       cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>,
<a name="l00268"></a>00268       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3038bc3503e3e2a47e7ea6538338e371">devicestate</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00269"></a>00269       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00270"></a>00270       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a63038a10451f49a8611b19e6c577d90">transfer</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00271"></a>00271       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#f7b11037f2050959293aafb493b7653c">capabilities</a>) ? cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#f7b11037f2050959293aafb493b7653c">capabilities</a> : -1,
<a name="l00272"></a>00272       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00273"></a>00273       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#761141281062bdfd42f6bab526b73892">send_digit_end</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00274"></a>00274       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00275"></a>00275       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#c5d3075a7503e94d76c789f915ebcceb">send_image</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>,
<a name="l00276"></a>00276       (cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#fd5ce4dd24c70a0d6226a30b49fcf84b">send_text</a>) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>
<a name="l00277"></a>00277       
<a name="l00278"></a>00278    );
<a name="l00279"></a>00279 
<a name="l00280"></a>00280    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00281"></a>00281    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="channel_8c.html#6ed6cb98d5db95900d18435e58555246">00284</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#6ed6cb98d5db95900d18435e58555246">complete_channeltypes</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#6438c669e0d0de98e6929c2cc0fac474">line</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *word, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *cl;
<a name="l00287"></a>00287    <span class="keywordtype">int</span> which = 0;
<a name="l00288"></a>00288    <span class="keywordtype">int</span> wordlen;
<a name="l00289"></a>00289    <span class="keywordtype">char</span> *ret = NULL;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (pos != 3)
<a name="l00292"></a>00292       <span class="keywordflow">return</span> NULL;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294    wordlen = strlen(word);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, cl, list) {
<a name="l00297"></a>00297       <span class="keywordflow">if</span> (!strncasecmp(word, cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, wordlen) &amp;&amp; ++which &gt; state) {
<a name="l00298"></a>00298          ret = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(cl-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00299"></a>00299          <span class="keywordflow">break</span>;
<a name="l00300"></a>00300       }
<a name="l00301"></a>00301    }
<a name="l00302"></a>00302    
<a name="l00303"></a>00303    <span class="keywordflow">return</span> ret;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="channel_8c.html#9d77a9f7e56625db6b483d69e4d98524">00306</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="channel_8c.html#9d77a9f7e56625db6b483d69e4d98524">show_channeltypes_usage</a>[] =
<a name="l00307"></a>00307 <span class="stringliteral">"Usage: core show channeltypes\n"</span>
<a name="l00308"></a>00308 <span class="stringliteral">"       Lists available channel types registered in your Asterisk server.\n"</span>;
<a name="l00309"></a>00309 
<a name="l00310"></a><a class="code" href="channel_8c.html#9680005c0ee162d6d032a1cc9542f541">00310</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="channel_8c.html#9680005c0ee162d6d032a1cc9542f541">show_channeltype_usage</a>[] =
<a name="l00311"></a>00311 <span class="stringliteral">"Usage: core show channeltype &lt;name&gt;\n"</span>
<a name="l00312"></a>00312 <span class="stringliteral">"  Show details about the specified channel type, &lt;name&gt;.\n"</span>;
<a name="l00313"></a>00313 
<a name="l00314"></a><a class="code" href="channel_8c.html#21ec745a076182c96358f435eab3b6bc">00314</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_channel[] = {
<a name="l00315"></a>00315    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"channeltypes"</span>, NULL },
<a name="l00316"></a>00316    <a class="code" href="channel_8c.html#ad208619cd5b868aecef822a11a47ee0">show_channeltypes</a>, <span class="stringliteral">"List available channel types"</span>,
<a name="l00317"></a>00317    <a class="code" href="channel_8c.html#9d77a9f7e56625db6b483d69e4d98524">show_channeltypes_usage</a> },
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"channeltype"</span>, NULL },
<a name="l00320"></a>00320    <a class="code" href="channel_8c.html#0e1c8383b75188759216ba931584c65c">show_channeltype</a>, <span class="stringliteral">"Give more details on that channel type"</span>,
<a name="l00321"></a>00321    <a class="code" href="channel_8c.html#9680005c0ee162d6d032a1cc9542f541">show_channeltype_usage</a>, <a class="code" href="channel_8c.html#6ed6cb98d5db95900d18435e58555246">complete_channeltypes</a> },
<a name="l00322"></a>00322 };
<a name="l00323"></a>00323 <span class="comment"></span>
<a name="l00324"></a>00324 <span class="comment">/*! \brief Checks to see if a channel is needing hang up */</span>
<a name="l00325"></a><a class="code" href="channel_8h.html#042e64a8d465783855a52ec8c56a9373">00325</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a>)     <span class="comment">/* yes if soft hangup flag set */</span>
<a name="l00328"></a>00328       <span class="keywordflow">return</span> 1;
<a name="l00329"></a>00329    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>)    <span class="comment">/* yes if no technology private data */</span>
<a name="l00330"></a>00330       <span class="keywordflow">return</span> 1;
<a name="l00331"></a>00331    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a>)   <span class="comment">/* no if no hangup scheduled */</span>
<a name="l00332"></a>00332       <span class="keywordflow">return</span> 0;
<a name="l00333"></a>00333    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> &gt; time(NULL))   <span class="comment">/* no if hangup time has not come yet. */</span>
<a name="l00334"></a>00334       <span class="keywordflow">return</span> 0;
<a name="l00335"></a>00335    chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a12709ffb7179ec4c9b3ba505519ddc84e">AST_SOFTHANGUP_TIMEOUT</a>; <span class="comment">/* record event */</span>
<a name="l00336"></a>00336    <span class="keywordflow">return</span> 1;
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">00339</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">ast_check_hangup_locked</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341    <span class="keywordtype">int</span> res;
<a name="l00342"></a>00342    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l00343"></a>00343    res = <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan);
<a name="l00344"></a>00344    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l00345"></a>00345    <span class="keywordflow">return</span> res;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 <span class="comment"></span>
<a name="l00348"></a>00348 <span class="comment">/*! \brief Initiate system shutdown */</span>
<a name="l00349"></a><a class="code" href="channel_8h.html#a19b056dcfc49b0b46dd14462379314d">00349</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#a19b056dcfc49b0b46dd14462379314d">ast_begin_shutdown</a>(<span class="keywordtype">int</span> hangup)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l00352"></a>00352    <a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">shutting_down</a> = 1;
<a name="l00353"></a>00353    <span class="keywordflow">if</span> (hangup) {
<a name="l00354"></a>00354       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00355"></a>00355       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;channels, c, <a class="code" href="structchan__list.html">chan_list</a>)
<a name="l00356"></a>00356          <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(c, <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1e415ee9181158293f7c3d3cd1a98f4ee">AST_SOFTHANGUP_SHUTDOWN</a>);
<a name="l00357"></a>00357       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00358"></a>00358    }
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 <span class="comment"></span>
<a name="l00361"></a>00361 <span class="comment">/*! \brief returns number of active/allocated channels */</span>
<a name="l00362"></a><a class="code" href="channel_8h.html#126867ace3f9eaaf4d1cf954f5907451">00362</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#126867ace3f9eaaf4d1cf954f5907451">ast_active_channels</a>(<span class="keywordtype">void</span>)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l00365"></a>00365    <span class="keywordtype">int</span> cnt = 0;
<a name="l00366"></a>00366    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00367"></a>00367    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;channels, c, <a class="code" href="structchan__list.html">chan_list</a>)
<a name="l00368"></a>00368       cnt++;
<a name="l00369"></a>00369    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00370"></a>00370    <span class="keywordflow">return</span> cnt;
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 <span class="comment"></span>
<a name="l00373"></a>00373 <span class="comment">/*! \brief Cancel a shutdown in progress */</span>
<a name="l00374"></a><a class="code" href="channel_8h.html#1e8559a1ce1e9b3a1bc50aaf1013e429">00374</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#1e8559a1ce1e9b3a1bc50aaf1013e429">ast_cancel_shutdown</a>(<span class="keywordtype">void</span>)
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376    <a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">shutting_down</a> = 0;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 <span class="comment"></span>
<a name="l00379"></a>00379 <span class="comment">/*! \brief Returns non-zero if Asterisk is being shut down */</span>
<a name="l00380"></a><a class="code" href="channel_8h.html#b9bab70de71305f125a80502da266866">00380</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#b9bab70de71305f125a80502da266866">ast_shutting_down</a>(<span class="keywordtype">void</span>)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">shutting_down</a>;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 <span class="comment"></span>
<a name="l00385"></a>00385 <span class="comment">/*! \brief Set when to hangup channel */</span>
<a name="l00386"></a><a class="code" href="channel_8h.html#a572798172ac3e5c4a518e6c247da125">00386</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#a572798172ac3e5c4a518e6c247da125">ast_channel_setwhentohangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, time_t <a class="code" href="chan__alsa_8c.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388    chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> = offset ? time(NULL) + offset : 0;
<a name="l00389"></a>00389    <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(chan, &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>);
<a name="l00390"></a>00390    <span class="keywordflow">return</span>;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 <span class="comment"></span>
<a name="l00393"></a>00393 <span class="comment">/*! \brief Compare a offset with when to hangup channel */</span>
<a name="l00394"></a><a class="code" href="channel_8h.html#49102d6d12a437bf6928bc9916194549">00394</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#49102d6d12a437bf6928bc9916194549">ast_channel_cmpwhentohangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, time_t <a class="code" href="chan__alsa_8c.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396    time_t <a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a>;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> == 0) {
<a name="l00399"></a>00399       <span class="keywordflow">return</span> (offset == 0) ? 0 : -1;
<a name="l00400"></a>00400    } <span class="keywordflow">else</span> {
<a name="l00401"></a>00401       <span class="keywordflow">if</span> (offset == 0)  <span class="comment">/* XXX why is this special ? */</span>
<a name="l00402"></a>00402          <span class="keywordflow">return</span> (1);
<a name="l00403"></a>00403       <span class="keywordflow">else</span> {
<a name="l00404"></a>00404          whentohangup = offset + time (NULL);
<a name="l00405"></a>00405          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> &lt; whentohangup)
<a name="l00406"></a>00406             <span class="keywordflow">return</span> (1);
<a name="l00407"></a>00407          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> == whentohangup)
<a name="l00408"></a>00408             <span class="keywordflow">return</span> (0);
<a name="l00409"></a>00409          <span class="keywordflow">else</span>
<a name="l00410"></a>00410             <span class="keywordflow">return</span> (-1);
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412    }
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 <span class="comment"></span>
<a name="l00415"></a>00415 <span class="comment">/*! \brief Register a new telephony channel in Asterisk */</span>
<a name="l00416"></a><a class="code" href="channel_8h.html#1187446bddf5734a294a3ca0598584df">00416</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#1187446bddf5734a294a3ca0598584df">ast_channel_register</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>)
<a name="l00417"></a>00417 {
<a name="l00418"></a>00418    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, chan, list) {
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (!strcasecmp(tech-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)) {
<a name="l00424"></a>00424          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Already have a handler for type '%s'\n"</span>, tech-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00425"></a>00425          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00426"></a>00426          <span class="keywordflow">return</span> -1;
<a name="l00427"></a>00427       }
<a name="l00428"></a>00428    }
<a name="l00429"></a>00429    
<a name="l00430"></a>00430    <span class="keywordflow">if</span> (!(chan = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan)))) {
<a name="l00431"></a>00431       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00432"></a>00432       <span class="keywordflow">return</span> -1;
<a name="l00433"></a>00433    }
<a name="l00434"></a>00434    chan-&gt;tech = tech;
<a name="l00435"></a>00435    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;backends, chan, list);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00438"></a>00438       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Registered handler for '%s' (%s)\n"</span>, chan-&gt;tech-&gt;type, chan-&gt;tech-&gt;description);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l00441"></a>00441       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Registered channel type '%s' (%s)\n"</span>, chan-&gt;tech-&gt;type,
<a name="l00442"></a>00442              chan-&gt;tech-&gt;description);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00445"></a>00445    <span class="keywordflow">return</span> 0;
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 <span class="comment"></span>
<a name="l00448"></a>00448 <span class="comment">/*! \brief Unregister channel driver */</span>
<a name="l00449"></a><a class="code" href="channel_8h.html#f47e36ee9d2beb6eee7be098c604caea">00449</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#f47e36ee9d2beb6eee7be098c604caea">ast_channel_unregister</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>)
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00454"></a>00454       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Unregistering channel type '%s'\n"</span>, tech-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;backends, chan, list) {
<a name="l00459"></a>00459       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a> == tech) {
<a name="l00460"></a>00460          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;backends, list);
<a name="l00461"></a>00461          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan);
<a name="l00462"></a>00462          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l00463"></a>00463             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Unregistered channel type '%s'\n"</span>, tech-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00464"></a>00464          <span class="keywordflow">break</span>;   
<a name="l00465"></a>00465       }
<a name="l00466"></a>00466    }
<a name="l00467"></a>00467    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 <span class="comment"></span>
<a name="l00472"></a>00472 <span class="comment">/*! \brief Get handle to channel driver based on name */</span>
<a name="l00473"></a><a class="code" href="channel_8h.html#3a695cf963066b80546be9da976d27c8">00473</a> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *<a class="code" href="channel_8c.html#3a695cf963066b80546be9da976d27c8">ast_get_channel_tech</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *chanls;
<a name="l00476"></a>00476    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *ret = NULL;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels)) {
<a name="l00479"></a>00479       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to lock channel tech list\n"</span>);
<a name="l00480"></a>00480       <span class="keywordflow">return</span> NULL;
<a name="l00481"></a>00481    }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, chanls, list) {
<a name="l00484"></a>00484       <span class="keywordflow">if</span> (!strcasecmp(name, chanls-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)) {
<a name="l00485"></a>00485          ret = chanls-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>;
<a name="l00486"></a>00486          <span class="keywordflow">break</span>;
<a name="l00487"></a>00487       }
<a name="l00488"></a>00488    }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00491"></a>00491    
<a name="l00492"></a>00492    <span class="keywordflow">return</span> ret;
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 <span class="comment"></span>
<a name="l00495"></a>00495 <span class="comment">/*! \brief Gives the string form of a given hangup cause */</span>
<a name="l00496"></a><a class="code" href="channel_8h.html#b60af18c86af040d2efe4529056c8501">00496</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#817c0e10b26cbcb773516bb6583fb694">ast_cause2str</a>(<span class="keywordtype">int</span> cause)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498    <span class="keywordtype">int</span> x;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500    <span class="keywordflow">for</span> (x=0; x &lt; <span class="keyword">sizeof</span>(<a class="code" href="channel_8c.html#1b1c2ab7cb4088770575bc4a46216449">causes</a>) / <span class="keyword">sizeof</span>(causes[0]); x++) {
<a name="l00501"></a>00501       <span class="keywordflow">if</span> (causes[x].cause == cause)
<a name="l00502"></a>00502          <span class="keywordflow">return</span> causes[x].desc;
<a name="l00503"></a>00503    }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505    <span class="keywordflow">return</span> <span class="stringliteral">"Unknown"</span>;
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 <span class="comment"></span>
<a name="l00508"></a>00508 <span class="comment">/*! \brief Convert a symbolic hangup cause to number */</span>
<a name="l00509"></a><a class="code" href="channel_8h.html#bd5520dfe931a76ad3bea71e03887f59">00509</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#708c594c181120493746e2a7eac5527e">ast_str2cause</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511    <span class="keywordtype">int</span> x;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(<a class="code" href="channel_8c.html#1b1c2ab7cb4088770575bc4a46216449">causes</a>) / <span class="keyword">sizeof</span>(causes[0]); x++)
<a name="l00514"></a>00514       <span class="keywordflow">if</span> (strncasecmp(causes[x].name, name, strlen(causes[x].name)) == 0)
<a name="l00515"></a>00515          <span class="keywordflow">return</span> causes[x].cause;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <span class="keywordflow">return</span> -1;
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 <span class="comment"></span>
<a name="l00520"></a>00520 <span class="comment">/*! \brief Gives the string form of a given channel state.</span>
<a name="l00521"></a>00521 <span class="comment">   \note This function is not reentrant.</span>
<a name="l00522"></a>00522 <span class="comment"> */</span>
<a name="l00523"></a><a class="code" href="channel_8h.html#70f0f0cc9b725f5d2e6b99dcb2c4ea73">00523</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(<span class="keyword">enum</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a">ast_channel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <span class="keywordflow">switch</span> (state) {
<a name="l00528"></a>00528    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>:
<a name="l00529"></a>00529       <span class="keywordflow">return</span> <span class="stringliteral">"Down"</span>;
<a name="l00530"></a>00530    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a75a7d9c79e4a7c2732015d1c68908536">AST_STATE_RESERVED</a>:
<a name="l00531"></a>00531       <span class="keywordflow">return</span> <span class="stringliteral">"Rsrvd"</span>;
<a name="l00532"></a>00532    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a71b2dab052b5015d49144d52cf580735">AST_STATE_OFFHOOK</a>:
<a name="l00533"></a>00533       <span class="keywordflow">return</span> <span class="stringliteral">"OffHook"</span>;
<a name="l00534"></a>00534    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a4f25236a25abffd53bda3ef97e96296f">AST_STATE_DIALING</a>:
<a name="l00535"></a>00535       <span class="keywordflow">return</span> <span class="stringliteral">"Dialing"</span>;
<a name="l00536"></a>00536    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a0789c8ad2fe8eda2081eb587a0bfbe42">AST_STATE_RING</a>:
<a name="l00537"></a>00537       <span class="keywordflow">return</span> <span class="stringliteral">"Ring"</span>;
<a name="l00538"></a>00538    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a85da5b3ea10583d638bc7ce8fe638ec2">AST_STATE_RINGING</a>:
<a name="l00539"></a>00539       <span class="keywordflow">return</span> <span class="stringliteral">"Ringing"</span>;
<a name="l00540"></a>00540    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>:
<a name="l00541"></a>00541       <span class="keywordflow">return</span> <span class="stringliteral">"Up"</span>;
<a name="l00542"></a>00542    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a2081397aa15f6ea9b289237043aa1d1b">AST_STATE_BUSY</a>:
<a name="l00543"></a>00543       <span class="keywordflow">return</span> <span class="stringliteral">"Busy"</span>;
<a name="l00544"></a>00544    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87ae69544c47419fa57cd20045b09aa5b40">AST_STATE_DIALING_OFFHOOK</a>:
<a name="l00545"></a>00545       <span class="keywordflow">return</span> <span class="stringliteral">"Dialing Offhook"</span>;
<a name="l00546"></a>00546    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a0c8ef65931fb09184de67c7484cbbf47">AST_STATE_PRERING</a>:
<a name="l00547"></a>00547       <span class="keywordflow">return</span> <span class="stringliteral">"Pre-ring"</span>;
<a name="l00548"></a>00548    <span class="keywordflow">default</span>:
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (!(buf = ast_threadstorage_get(&amp;state2str_threadbuf, <a class="code" href="channel_8c.html#1e6dec0e2fbda212b36612175c9eebc3">STATE2STR_BUFSIZE</a>)))
<a name="l00550"></a>00550          <span class="keywordflow">return</span> <span class="stringliteral">"Unknown"</span>;
<a name="l00551"></a>00551       snprintf(buf, <a class="code" href="channel_8c.html#1e6dec0e2fbda212b36612175c9eebc3">STATE2STR_BUFSIZE</a>, <span class="stringliteral">"Unknown (%d)"</span>, state);
<a name="l00552"></a>00552       <span class="keywordflow">return</span> buf;
<a name="l00553"></a>00553    }
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 <span class="comment"></span>
<a name="l00556"></a>00556 <span class="comment">/*! \brief Gives the string form of a given transfer capability */</span>
<a name="l00557"></a><a class="code" href="channel_8h.html#85bf2a2910fd484add99db6bff044f97">00557</a> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#368b4d536fb019460679046558819901">ast_transfercapability2str</a>(<span class="keywordtype">int</span> transfercapability)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559    <span class="keywordflow">switch</span> (transfercapability) {
<a name="l00560"></a>00560    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#bfe67e9f7b726989840f83c68b0f5265">AST_TRANS_CAP_SPEECH</a>:
<a name="l00561"></a>00561       <span class="keywordflow">return</span> <span class="stringliteral">"SPEECH"</span>;
<a name="l00562"></a>00562    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#e58ab5d4b1bec6f3bfacfb3ddca7caed">AST_TRANS_CAP_DIGITAL</a>:
<a name="l00563"></a>00563       <span class="keywordflow">return</span> <span class="stringliteral">"DIGITAL"</span>;
<a name="l00564"></a>00564    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#697c16bed779a43f064dc72aa887d4fe">AST_TRANS_CAP_RESTRICTED_DIGITAL</a>:
<a name="l00565"></a>00565       <span class="keywordflow">return</span> <span class="stringliteral">"RESTRICTED_DIGITAL"</span>;
<a name="l00566"></a>00566    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#9bdb9646f688f88d627d0b9e41d46955">AST_TRANS_CAP_3_1K_AUDIO</a>:
<a name="l00567"></a>00567       <span class="keywordflow">return</span> <span class="stringliteral">"3K1AUDIO"</span>;
<a name="l00568"></a>00568    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#5295f404719293b4dc5ee05a5905bb9d">AST_TRANS_CAP_DIGITAL_W_TONES</a>:
<a name="l00569"></a>00569       <span class="keywordflow">return</span> <span class="stringliteral">"DIGITAL_W_TONES"</span>;
<a name="l00570"></a>00570    <span class="keywordflow">case</span> <a class="code" href="transcap_8h.html#36aa5cbfceeb15947818d618f7ec164d">AST_TRANS_CAP_VIDEO</a>:
<a name="l00571"></a>00571       <span class="keywordflow">return</span> <span class="stringliteral">"VIDEO"</span>;
<a name="l00572"></a>00572    <span class="keywordflow">default</span>:
<a name="l00573"></a>00573       <span class="keywordflow">return</span> <span class="stringliteral">"UNKNOWN"</span>;
<a name="l00574"></a>00574    }
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 <span class="comment"></span>
<a name="l00577"></a>00577 <span class="comment">/*! \brief Pick the best audio codec */</span>
<a name="l00578"></a><a class="code" href="channel_8h.html#8aa2203afc4fb127e46d5be40718dc13">00578</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(<span class="keywordtype">int</span> fmts)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580    <span class="comment">/* This just our opinion, expressed in code.  We are asked to choose</span>
<a name="l00581"></a>00581 <span class="comment">      the best codec to use, given no information */</span>
<a name="l00582"></a>00582    <span class="keywordtype">int</span> x;
<a name="l00583"></a>00583    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#e05b8c8d37568de69ae911d9e518b24d">prefs</a>[] =
<a name="l00584"></a>00584    {<span class="comment"></span>
<a name="l00585"></a>00585 <span class="comment">      /*! Okay, ulaw is used by all telephony equipment, so start with it */</span>
<a name="l00586"></a>00586       <a class="code" href="frame_8h.html#a71706b2c864525ec1c9fcf925ae3802">AST_FORMAT_ULAW</a>,<span class="comment"></span>
<a name="l00587"></a>00587 <span class="comment">      /*! Unless of course, you're a silly European, so then prefer ALAW */</span>
<a name="l00588"></a>00588       <a class="code" href="frame_8h.html#edc237300fef31677662db961c07484b">AST_FORMAT_ALAW</a>,<span class="comment"></span>
<a name="l00589"></a>00589 <span class="comment">      /*! G.722 is better then all below, but not as common as the above... so give ulaw and alaw priority */</span>
<a name="l00590"></a>00590       <a class="code" href="frame_8h.html#b418abcb13f17e85f68a691f34e99e1a">AST_FORMAT_G722</a>,<span class="comment"></span>
<a name="l00591"></a>00591 <span class="comment">      /*! Okay, well, signed linear is easy to translate into other stuff */</span>
<a name="l00592"></a>00592       <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>,<span class="comment"></span>
<a name="l00593"></a>00593 <span class="comment">      /*! G.726 is standard ADPCM, in RFC3551 packing order */</span>
<a name="l00594"></a>00594       <a class="code" href="frame_8h.html#a594899d5bea5f591eda7e20b5e2c161">AST_FORMAT_G726</a>,<span class="comment"></span>
<a name="l00595"></a>00595 <span class="comment">      /*! G.726 is standard ADPCM, in AAL2 packing order */</span>
<a name="l00596"></a>00596       <a class="code" href="frame_8h.html#3c0408e35d11793967a2e178f93256cd">AST_FORMAT_G726_AAL2</a>,<span class="comment"></span>
<a name="l00597"></a>00597 <span class="comment">      /*! ADPCM has great sound quality and is still pretty easy to translate */</span>
<a name="l00598"></a>00598       <a class="code" href="frame_8h.html#b1048e305f2ee62aebab30899c88f8ce">AST_FORMAT_ADPCM</a>,<span class="comment"></span>
<a name="l00599"></a>00599 <span class="comment">      /*! Okay, we're down to vocoders now, so pick GSM because it's small and easier to</span>
<a name="l00600"></a>00600 <span class="comment">          translate and sounds pretty good */</span>
<a name="l00601"></a>00601       <a class="code" href="frame_8h.html#9864508932a19f37d9afbbc7cabd5990">AST_FORMAT_GSM</a>,<span class="comment"></span>
<a name="l00602"></a>00602 <span class="comment">      /*! iLBC is not too bad */</span>
<a name="l00603"></a>00603       <a class="code" href="frame_8h.html#c2f4d8d1a79322d795824fd91fb2706c">AST_FORMAT_ILBC</a>,<span class="comment"></span>
<a name="l00604"></a>00604 <span class="comment">      /*! Speex is free, but computationally more expensive than GSM */</span>
<a name="l00605"></a>00605       <a class="code" href="frame_8h.html#a4f3a9e622d8cbe3fe3eed2a35923d8c">AST_FORMAT_SPEEX</a>,<span class="comment"></span>
<a name="l00606"></a>00606 <span class="comment">      /*! Ick, LPC10 sounds terrible, but at least we have code for it, if you're tacky enough</span>
<a name="l00607"></a>00607 <span class="comment">          to use it */</span>
<a name="l00608"></a>00608       <a class="code" href="frame_8h.html#87eb67578117e5f22d34386b7c989e08">AST_FORMAT_LPC10</a>,<span class="comment"></span>
<a name="l00609"></a>00609 <span class="comment">      /*! G.729a is faster than 723 and slightly less expensive */</span>
<a name="l00610"></a>00610       <a class="code" href="frame_8h.html#66b369abf91a6c6519ca7cad6c657ae7">AST_FORMAT_G729A</a>,<span class="comment"></span>
<a name="l00611"></a>00611 <span class="comment">      /*! Down to G.723.1 which is proprietary but at least designed for voice */</span>
<a name="l00612"></a>00612       <a class="code" href="frame_8h.html#0b4ea457c95753454e021c511a5daecc">AST_FORMAT_G723_1</a>,
<a name="l00613"></a>00613    };
<a name="l00614"></a>00614 
<a name="l00615"></a>00615    <span class="comment">/* Strip out video */</span>
<a name="l00616"></a>00616    fmts &amp;= <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>;
<a name="l00617"></a>00617    
<a name="l00618"></a>00618    <span class="comment">/* Find the first preferred codec in the format given */</span>
<a name="l00619"></a>00619    <span class="keywordflow">for</span> (x=0; x &lt; (<span class="keyword">sizeof</span>(prefs) / <span class="keyword">sizeof</span>(prefs[0]) ); x++)
<a name="l00620"></a>00620       <span class="keywordflow">if</span> (fmts &amp; prefs[x])
<a name="l00621"></a>00621          <span class="keywordflow">return</span> prefs[x];
<a name="l00622"></a>00622    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Don't know any of 0x%x formats\n"</span>, fmts);
<a name="l00623"></a>00623    <span class="keywordflow">return</span> 0;
<a name="l00624"></a>00624 }
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="channel_8c.html#688c6fbaa15436ff07568d12eac14d5b">00626</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html">ast_channel_tech</a> null_tech = {
<a name="l00627"></a>00627    .<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> = <span class="stringliteral">"NULL"</span>,
<a name="l00628"></a>00628    .description = <span class="stringliteral">"Null channel (should not see this)"</span>,
<a name="l00629"></a>00629 };
<a name="l00630"></a>00630 <span class="comment"></span>
<a name="l00631"></a>00631 <span class="comment">/*! \brief Create a new channel structure */</span>
<a name="l00632"></a><a class="code" href="channel_8h.html#3e12df96f6a8fc8b7293ad03b29c729f">00632</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(<span class="keywordtype">int</span> needqueue, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *acctcode, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> amaflag, <span class="keyword">const</span> <span class="keywordtype">char</span> *name_fmt, ...)
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *tmp;
<a name="l00635"></a>00635    <span class="keywordtype">int</span> x;
<a name="l00636"></a>00636    <span class="keywordtype">int</span> <a class="code" href="structast__channel.html#4e5868d676cb634aa75b125a0f741abf">flags</a>;
<a name="l00637"></a>00637    <span class="keyword">struct </span>varshead *headp;
<a name="l00638"></a>00638    va_list ap1, ap2;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640    <span class="comment">/* If shutting down, don't allocate any new channels */</span>
<a name="l00641"></a>00641    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#3fda132ec997ca296e81601dde1daf98">shutting_down</a>) {
<a name="l00642"></a>00642       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel allocation failed: Refusing due to active shutdown\n"</span>);
<a name="l00643"></a>00643       <span class="keywordflow">return</span> NULL;
<a name="l00644"></a>00644    }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp))))
<a name="l00647"></a>00647       <span class="keywordflow">return</span> NULL;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="keywordflow">if</span> (!(tmp-&gt;sched = <a class="code" href="sched_8c.html#4326fa64fd840788d03093b9931bb1fb">sched_context_create</a>())) {
<a name="l00650"></a>00650       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel allocation failed: Unable to create schedule context\n"</span>);
<a name="l00651"></a>00651       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00652"></a>00652       <span class="keywordflow">return</span> NULL;
<a name="l00653"></a>00653    }
<a name="l00654"></a>00654    
<a name="l00655"></a>00655    <a class="code" href="stringfields_8h.html#1b408288de2c46a54ecd65b3f3f8a51c">ast_string_field_init</a>(tmp, 128);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657    <span class="comment">/* Don't bother initializing the last two FD here, because they</span>
<a name="l00658"></a>00658 <span class="comment">      will *always* be set just a few lines down (AST_TIMING_FD,</span>
<a name="l00659"></a>00659 <span class="comment">      AST_ALERT_FD). */</span>
<a name="l00660"></a>00660    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a> - 2; x++)
<a name="l00661"></a>00661       tmp-&gt;fds[x] = -1;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>   tmp-&gt;timingfd = open(<span class="stringliteral">"/dev/zap/timer"</span>, O_RDWR);
<a name="l00665"></a>00665    <span class="keywordflow">if</span> (tmp-&gt;timingfd &gt; -1) {
<a name="l00666"></a>00666       <span class="comment">/* Check if timing interface supports new</span>
<a name="l00667"></a>00667 <span class="comment">         ping/pong scheme */</span>
<a name="l00668"></a>00668       flags = 1;
<a name="l00669"></a>00669       <span class="keywordflow">if</span> (!ioctl(tmp-&gt;timingfd, ZT_TIMERPONG, &amp;flags))
<a name="l00670"></a>00670          needqueue = 0;
<a name="l00671"></a>00671    }
<a name="l00672"></a>00672 <span class="preprocessor">#else</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span>   tmp-&gt;timingfd = -1;              
<a name="l00674"></a>00674 <span class="preprocessor">#endif               </span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>
<a name="l00676"></a>00676    <span class="keywordflow">if</span> (needqueue) {
<a name="l00677"></a>00677       <span class="keywordflow">if</span> (pipe(tmp-&gt;alertpipe)) {
<a name="l00678"></a>00678          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel allocation failed: Can't create alert pipe!\n"</span>);
<a name="l00679"></a>00679          <a class="code" href="stringfields_8h.html#772cf76139a5b96f329a48ae8307e142">ast_string_field_free_pools</a>(tmp);
<a name="l00680"></a>00680          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00681"></a>00681          <span class="keywordflow">return</span> NULL;
<a name="l00682"></a>00682       } <span class="keywordflow">else</span> {
<a name="l00683"></a>00683          flags = fcntl(tmp-&gt;alertpipe[0], F_GETFL);
<a name="l00684"></a>00684          fcntl(tmp-&gt;alertpipe[0], F_SETFL, flags | O_NONBLOCK);
<a name="l00685"></a>00685          flags = fcntl(tmp-&gt;alertpipe[1], F_GETFL);
<a name="l00686"></a>00686          fcntl(tmp-&gt;alertpipe[1], F_SETFL, flags | O_NONBLOCK);
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688    } <span class="keywordflow">else</span>   <span class="comment">/* Make sure we've got it done right if they don't */</span>
<a name="l00689"></a>00689       tmp-&gt;alertpipe[0] = tmp-&gt;alertpipe[1] = -1;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691    <span class="comment">/* Always watch the alertpipe */</span>
<a name="l00692"></a>00692    tmp-&gt;fds[<a class="code" href="channel_8h.html#187908de5f942fe7f493a6b9b5dacfc4">AST_ALERT_FD</a>] = tmp-&gt;alertpipe[0];
<a name="l00693"></a>00693    <span class="comment">/* And timing pipe */</span>
<a name="l00694"></a>00694    tmp-&gt;fds[<a class="code" href="channel_8h.html#0db74b98fb7363645274b7b92a5741f2">AST_TIMING_FD</a>] = tmp-&gt;timingfd;
<a name="l00695"></a>00695    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(tmp, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"**Unknown**"</span>);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697    <span class="comment">/* Initial state */</span>
<a name="l00698"></a>00698    tmp-&gt;_state = state;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700    tmp-&gt;streamid = -1;
<a name="l00701"></a>00701    
<a name="l00702"></a>00702    tmp-&gt;fin = <a class="code" href="channel_8c.html#fb1a13eb3cfac4d9cfb7c4b0d2865bde">global_fin</a>;
<a name="l00703"></a>00703    tmp-&gt;fout = <a class="code" href="channel_8c.html#2173c5282c13757472cb6ac76d8ecdad">global_fout</a>;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="asterisk_8c.html#0a0f8ba4c757a1da509a0cae1830025b">ast_config_AST_SYSTEM_NAME</a>)) {
<a name="l00706"></a>00706       <a class="code" href="stringfields_8h.html#4bcfc9a923120ec2704f7c6049e497f7">ast_string_field_build</a>(tmp, uniqueid, <span class="stringliteral">"%li.%d"</span>, (<span class="keywordtype">long</span>) time(NULL), 
<a name="l00707"></a>00707                    ast_atomic_fetchadd_int(&amp;<a class="code" href="channel_8c.html#49bb87cf832afb4af43db414e0391d75">uniqueint</a>, 1));
<a name="l00708"></a>00708    } <span class="keywordflow">else</span> {
<a name="l00709"></a>00709       <a class="code" href="stringfields_8h.html#4bcfc9a923120ec2704f7c6049e497f7">ast_string_field_build</a>(tmp, uniqueid, <span class="stringliteral">"%s-%li.%d"</span>, <a class="code" href="asterisk_8c.html#0a0f8ba4c757a1da509a0cae1830025b">ast_config_AST_SYSTEM_NAME</a>, 
<a name="l00710"></a>00710                    (<span class="keywordtype">long</span>) time(NULL), ast_atomic_fetchadd_int(&amp;<a class="code" href="channel_8c.html#49bb87cf832afb4af43db414e0391d75">uniqueint</a>, 1));
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713    tmp-&gt;cid.cid_name = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(cid_name);
<a name="l00714"></a>00714    tmp-&gt;cid.cid_num = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(cid_num);
<a name="l00715"></a>00715    
<a name="l00716"></a>00716    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name_fmt)) {
<a name="l00717"></a>00717       <span class="comment">/* Almost every channel is calling this function, and setting the name via the ast_string_field_build() call.</span>
<a name="l00718"></a>00718 <span class="comment">       * And they all use slightly different formats for their name string.</span>
<a name="l00719"></a>00719 <span class="comment">       * This means, to set the name here, we have to accept variable args, and call the string_field_build from here.</span>
<a name="l00720"></a>00720 <span class="comment">       * This means, that the stringfields must have a routine that takes the va_lists directly, and </span>
<a name="l00721"></a>00721 <span class="comment">       * uses them to build the string, instead of forming the va_lists internally from the vararg ... list.</span>
<a name="l00722"></a>00722 <span class="comment">       * This new function was written so this can be accomplished.</span>
<a name="l00723"></a>00723 <span class="comment">       */</span>
<a name="l00724"></a>00724       va_start(ap1, name_fmt);
<a name="l00725"></a>00725       va_start(ap2, name_fmt);
<a name="l00726"></a>00726       <a class="code" href="stringfields_8h.html#3c5e6dc0f1ef6c2e2c9dac4ee837d108">ast_string_field_build_va</a>(tmp, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, name_fmt, ap1, ap2);
<a name="l00727"></a>00727       va_end(ap1);
<a name="l00728"></a>00728       va_end(ap2);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730       <span class="comment">/* and now, since the channel structure is built, and has its name, let's call the</span>
<a name="l00731"></a>00731 <span class="comment">       * manager event generator with this Newchannel event. This is the proper and correct</span>
<a name="l00732"></a>00732 <span class="comment">       * place to make this call, but you sure do have to pass a lot of data into this func</span>
<a name="l00733"></a>00733 <span class="comment">       * to do it here!</span>
<a name="l00734"></a>00734 <span class="comment">       */</span>
<a name="l00735"></a>00735       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Newchannel"</span>,
<a name="l00736"></a>00736                <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l00737"></a>00737                <span class="stringliteral">"State: %s\r\n"</span>
<a name="l00738"></a>00738                <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l00739"></a>00739                <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l00740"></a>00740                <span class="stringliteral">"Uniqueid: %s\r\n"</span>,
<a name="l00741"></a>00741                tmp-&gt;name, <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(state),
<a name="l00742"></a>00742                <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(cid_num, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l00743"></a>00743                <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(cid_name, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l00744"></a>00744                tmp-&gt;uniqueid);
<a name="l00745"></a>00745    }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747    <span class="comment">/* Reminder for the future: under what conditions do we NOT want to track cdrs on channels? */</span>
<a name="l00748"></a>00748 
<a name="l00749"></a>00749    <span class="comment">/* These 4 variables need to be set up for the cdr_init() to work right */</span>
<a name="l00750"></a>00750    <span class="keywordflow">if</span> (amaflag)
<a name="l00751"></a>00751       tmp-&gt;amaflags = amaflag;
<a name="l00752"></a>00752    <span class="keywordflow">else</span>
<a name="l00753"></a>00753       tmp-&gt;amaflags = <a class="code" href="cdr_8c.html#d5268e5dc9c134f0ce5f28da7a447335">ast_default_amaflags</a>;
<a name="l00754"></a>00754    
<a name="l00755"></a>00755    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(acctcode))
<a name="l00756"></a>00756       <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(tmp, <a class="code" href="chan__iax2_8c.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>, acctcode);
<a name="l00757"></a>00757    <span class="keywordflow">else</span>
<a name="l00758"></a>00758       <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(tmp, <a class="code" href="chan__iax2_8c.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>, <a class="code" href="cdr_8c.html#77219a32a253309bd3900aedd6cf8d07">ast_default_accountcode</a>);
<a name="l00759"></a>00759       
<a name="l00760"></a>00760    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(context))
<a name="l00761"></a>00761       ast_copy_string(tmp-&gt;context, context, <span class="keyword">sizeof</span>(tmp-&gt;context));
<a name="l00762"></a>00762    <span class="keywordflow">else</span>
<a name="l00763"></a>00763       strcpy(tmp-&gt;context, <span class="stringliteral">"default"</span>);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(exten))
<a name="l00766"></a>00766       ast_copy_string(tmp-&gt;exten, exten, <span class="keyword">sizeof</span>(tmp-&gt;exten));
<a name="l00767"></a>00767    <span class="keywordflow">else</span>
<a name="l00768"></a>00768       strcpy(tmp-&gt;exten, <span class="stringliteral">"s"</span>);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770    tmp-&gt;priority = 1;
<a name="l00771"></a>00771       
<a name="l00772"></a>00772    tmp-&gt;cdr = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l00773"></a>00773    <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(tmp-&gt;cdr, tmp);
<a name="l00774"></a>00774    <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(tmp-&gt;cdr);
<a name="l00775"></a>00775    
<a name="l00776"></a>00776    headp = &amp;tmp-&gt;varshead;
<a name="l00777"></a>00777    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(headp);
<a name="l00778"></a>00778    
<a name="l00779"></a>00779    <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;tmp-&gt;lock);
<a name="l00780"></a>00780    
<a name="l00781"></a>00781    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;tmp-&gt;datastores);
<a name="l00782"></a>00782    
<a name="l00783"></a>00783    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(tmp, <a class="code" href="chan__alsa_8c.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, <a class="code" href="asterisk_8c.html#c8061c1fd1af2a0a5e244cf0bbae5043">defaultlanguage</a>);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785    tmp-&gt;tech = &amp;null_tech;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00788"></a>00788    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;channels, tmp, <a class="code" href="structchan__list.html">chan_list</a>);
<a name="l00789"></a>00789    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <span class="keywordflow">return</span> tmp;
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 <span class="comment"></span>
<a name="l00794"></a>00794 <span class="comment">/*! \brief Queue an outgoing media frame */</span>
<a name="l00795"></a><a class="code" href="channel_8h.html#d16a30a5843812777450bd333f0ce589">00795</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fin)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00798"></a>00798    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *cur;
<a name="l00799"></a>00799    <span class="keywordtype">int</span> blah = 1;
<a name="l00800"></a>00800    <span class="keywordtype">int</span> qlen = 0;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802    <span class="comment">/* Build us a copy and free the original one */</span>
<a name="l00803"></a>00803    <span class="keywordflow">if</span> (!(f = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(fin))) {
<a name="l00804"></a>00804       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to duplicate frame\n"</span>);
<a name="l00805"></a>00805       <span class="keywordflow">return</span> -1;
<a name="l00806"></a>00806    }
<a name="l00807"></a>00807    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809    <span class="comment">/* See if the last frame on the queue is a hangup, if so don't queue anything */</span>
<a name="l00810"></a>00810    <span class="keywordflow">if</span> ((cur = <a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;chan-&gt;readq)) &amp;&amp; (cur-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>) &amp;&amp; (cur-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>)) {
<a name="l00811"></a>00811       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00812"></a>00812       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l00813"></a>00813       <span class="keywordflow">return</span> 0;
<a name="l00814"></a>00814    }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816    <span class="comment">/* Count how many frames exist on the queue */</span>
<a name="l00817"></a>00817    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;chan-&gt;readq, cur, frame_list) {
<a name="l00818"></a>00818       qlen++;
<a name="l00819"></a>00819    }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821    <span class="comment">/* Allow up to 96 voice frames outstanding, and up to 128 total frames */</span>
<a name="l00822"></a>00822    <span class="keywordflow">if</span> (((fin-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) &amp;&amp; (qlen &gt; 96)) || (qlen  &gt; 128)) {
<a name="l00823"></a>00823       <span class="keywordflow">if</span> (fin-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) {
<a name="l00824"></a>00824          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Exceptionally long queue length queuing to %s\n"</span>, chan-&gt;name);
<a name="l00825"></a>00825          <a class="code" href="channel_8h.html#cef2f26f7da88da7db20faa12bd436c4">CRASH</a>;
<a name="l00826"></a>00826       } <span class="keywordflow">else</span> {
<a name="l00827"></a>00827          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00828"></a>00828             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Dropping voice to exceptionally long queue on %s\n"</span>, chan-&gt;name);
<a name="l00829"></a>00829          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00830"></a>00830          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l00831"></a>00831          <span class="keywordflow">return</span> 0;
<a name="l00832"></a>00832       }
<a name="l00833"></a>00833    }
<a name="l00834"></a>00834    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;chan-&gt;readq, f, frame_list);
<a name="l00835"></a>00835    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[1] &gt; -1) {
<a name="l00836"></a>00836       <span class="keywordflow">if</span> (write(chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[1], &amp;blah, <span class="keyword">sizeof</span>(blah)) != <span class="keyword">sizeof</span>(blah))
<a name="l00837"></a>00837          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to write to alert pipe on %s, frametype/subclass %d/%d (qlen = %d): %s!\n"</span>,
<a name="l00838"></a>00838             chan-&gt;name, f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, qlen, strerror(errno));
<a name="l00839"></a>00839 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1) {
<a name="l00841"></a>00841       ioctl(chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_TIMERPING, &amp;blah);
<a name="l00842"></a>00842 <span class="preprocessor">#endif            </span>
<a name="l00843"></a>00843 <span class="preprocessor"></span>   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>)) {
<a name="l00844"></a>00844       pthread_kill(chan-&gt;<a class="code" href="structast__channel.html#a38ba46bb4909bc27602645297913d86">blocker</a>, SIGURG);
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l00847"></a>00847    <span class="keywordflow">return</span> 0;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 <span class="comment"></span>
<a name="l00850"></a>00850 <span class="comment">/*! \brief Queue a hangup frame for channel */</span>
<a name="l00851"></a><a class="code" href="channel_8h.html#61f0a289387829da5c568c664f85e01c">00851</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#61f0a289387829da5c568c664f85e01c">ast_queue_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f = { <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a> };
<a name="l00854"></a>00854    <span class="comment">/* Yeah, let's not change a lock-critical value without locking */</span>
<a name="l00855"></a>00855    <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#ed66db8089c98c0615ab831f4eba520a">ast_channel_trylock</a>(chan)) {
<a name="l00856"></a>00856       chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1cbe3f9a2385d6a31eac6abced2a9f17d">AST_SOFTHANGUP_DEV</a>;
<a name="l00857"></a>00857       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l00858"></a>00858    }
<a name="l00859"></a>00859    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(chan, &amp;f);
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 <span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment">/*! \brief Queue a control frame */</span>
<a name="l00863"></a><a class="code" href="channel_8h.html#9c10dd50747025f5100adeb1da23c2e1">00863</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#9c10dd50747025f5100adeb1da23c2e1">ast_queue_control</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">enum</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389">ast_control_frame_type</a> control)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f = { <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>, };
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    f.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = control;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(chan, &amp;f);
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 <span class="comment"></span>
<a name="l00872"></a>00872 <span class="comment">/*! \brief Queue a control frame with payload */</span>
<a name="l00873"></a><a class="code" href="channel_8h.html#3336b8cfda88155ef5378ba728bef5c8">00873</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#3336b8cfda88155ef5378ba728bef5c8">ast_queue_control_data</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">enum</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389">ast_control_frame_type</a> control,
<a name="l00874"></a>00874             <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, size_t <a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>)
<a name="l00875"></a>00875 {
<a name="l00876"></a>00876    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f = { <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>, };
<a name="l00877"></a>00877 
<a name="l00878"></a>00878    f.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = control;
<a name="l00879"></a>00879    f.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = (<span class="keywordtype">void</span> *) data;
<a name="l00880"></a>00880    f.<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = datalen;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(chan, &amp;f);
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 <span class="comment"></span>
<a name="l00885"></a>00885 <span class="comment">/*! \brief Set defer DTMF flag on channel */</span>
<a name="l00886"></a><a class="code" href="channel_8h.html#c96b0dddc19825d46cc8a62ae92085ab">00886</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#c96b0dddc19825d46cc8a62ae92085ab">ast_channel_defer_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888    <span class="keywordtype">int</span> pre = 0;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890    <span class="keywordflow">if</span> (chan) {
<a name="l00891"></a>00891       pre = <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a>);
<a name="l00892"></a>00892       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a>);
<a name="l00893"></a>00893    }
<a name="l00894"></a>00894    <span class="keywordflow">return</span> pre;
<a name="l00895"></a>00895 }
<a name="l00896"></a>00896 <span class="comment"></span>
<a name="l00897"></a>00897 <span class="comment">/*! \brief Unset defer DTMF flag on channel */</span>
<a name="l00898"></a><a class="code" href="channel_8h.html#f73f024d0d929e70569cec47b297ee68">00898</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#f73f024d0d929e70569cec47b297ee68">ast_channel_undefer_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00899"></a>00899 {
<a name="l00900"></a>00900    <span class="keywordflow">if</span> (chan)
<a name="l00901"></a>00901       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a>);
<a name="l00902"></a>00902 }
<a name="l00903"></a>00903 <span class="comment"></span>
<a name="l00904"></a>00904 <span class="comment">/*!</span>
<a name="l00905"></a>00905 <span class="comment"> * \brief Helper function to find channels.</span>
<a name="l00906"></a>00906 <span class="comment"> *</span>
<a name="l00907"></a>00907 <span class="comment"> * It supports these modes:</span>
<a name="l00908"></a>00908 <span class="comment"> *</span>
<a name="l00909"></a>00909 <span class="comment"> * prev != NULL : get channel next in list after prev</span>
<a name="l00910"></a>00910 <span class="comment"> * name != NULL : get channel with matching name</span>
<a name="l00911"></a>00911 <span class="comment"> * name != NULL &amp;&amp; namelen != 0 : get channel whose name starts with prefix</span>
<a name="l00912"></a>00912 <span class="comment"> * exten != NULL : get channel whose exten or macroexten matches</span>
<a name="l00913"></a>00913 <span class="comment"> * context != NULL &amp;&amp; exten != NULL : get channel whose context or macrocontext</span>
<a name="l00914"></a>00914 <span class="comment"> *</span>
<a name="l00915"></a>00915 <span class="comment"> * It returns with the channel's lock held. If getting the individual lock fails,</span>
<a name="l00916"></a>00916 <span class="comment"> * unlock and retry quickly up to 10 times, then give up.</span>
<a name="l00917"></a>00917 <span class="comment"> *</span>
<a name="l00918"></a>00918 <span class="comment"> * \note XXX Note that this code has cost O(N) because of the need to verify</span>
<a name="l00919"></a>00919 <span class="comment"> * that the object is still on the global list.</span>
<a name="l00920"></a>00920 <span class="comment"> *</span>
<a name="l00921"></a>00921 <span class="comment"> * \note XXX also note that accessing fields (e.g. c-&gt;name in ast_log())</span>
<a name="l00922"></a>00922 <span class="comment"> * can only be done with the lock held or someone could delete the</span>
<a name="l00923"></a>00923 <span class="comment"> * object while we work on it. This causes some ugliness in the code.</span>
<a name="l00924"></a>00924 <span class="comment"> * Note that removing the first ast_log() may be harmful, as it would</span>
<a name="l00925"></a>00925 <span class="comment"> * shorten the retry period and possibly cause failures.</span>
<a name="l00926"></a>00926 <span class="comment"> * We should definitely go for a better scheme that is deadlock-free.</span>
<a name="l00927"></a>00927 <span class="comment"> */</span>
<a name="l00928"></a><a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">00928</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *prev,
<a name="l00929"></a>00929                       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> namelen,
<a name="l00930"></a>00930                       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a> = prev ? <span class="stringliteral">"deadlock"</span> : <span class="stringliteral">"initial deadlock"</span>;
<a name="l00933"></a>00933    <span class="keywordtype">int</span> retries;
<a name="l00934"></a>00934    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <span class="keywordflow">for</span> (retries = 0; retries &lt; 10; retries++) {
<a name="l00937"></a>00937       <span class="keywordtype">int</span> done;
<a name="l00938"></a>00938       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l00939"></a>00939       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;channels, c, <a class="code" href="structchan__list.html">chan_list</a>) {
<a name="l00940"></a>00940          <span class="keywordflow">if</span> (prev) { <span class="comment">/* look for next item */</span>
<a name="l00941"></a>00941             <span class="keywordflow">if</span> (c != prev) <span class="comment">/* not this one */</span>
<a name="l00942"></a>00942                <span class="keywordflow">continue</span>;
<a name="l00943"></a>00943             <span class="comment">/* found, prepare to return c-&gt;next */</span>
<a name="l00944"></a>00944             <span class="keywordflow">if</span> ((c = <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(c, <a class="code" href="structchan__list.html">chan_list</a>)) == NULL) <span class="keywordflow">break</span>;
<a name="l00945"></a>00945             <span class="comment">/* If prev was the last item on the channel list, then we just</span>
<a name="l00946"></a>00946 <span class="comment">             * want to return NULL, instead of trying to deref NULL in the</span>
<a name="l00947"></a>00947 <span class="comment">             * next section.</span>
<a name="l00948"></a>00948 <span class="comment">             */</span>
<a name="l00949"></a>00949          }
<a name="l00950"></a>00950          <span class="keywordflow">if</span> (name) { <span class="comment">/* want match by name */</span>
<a name="l00951"></a>00951             <span class="keywordflow">if</span> ((!namelen &amp;&amp; strcasecmp(c-&gt;name, name)) ||
<a name="l00952"></a>00952                 (namelen &amp;&amp; strncasecmp(c-&gt;name, name, namelen)))
<a name="l00953"></a>00953                <span class="keywordflow">continue</span>;   <span class="comment">/* name match failed */</span>
<a name="l00954"></a>00954          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (exten) {
<a name="l00955"></a>00955             <span class="keywordflow">if</span> (context &amp;&amp; strcasecmp(c-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, context) &amp;&amp;
<a name="l00956"></a>00956                 strcasecmp(c-&gt;<a class="code" href="structast__channel.html#d26b4f540a5723a140b9836f73cf62a4">macrocontext</a>, context))
<a name="l00957"></a>00957                <span class="keywordflow">continue</span>;   <span class="comment">/* context match failed */</span>
<a name="l00958"></a>00958             <span class="keywordflow">if</span> (strcasecmp(c-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, exten) &amp;&amp;
<a name="l00959"></a>00959                 strcasecmp(c-&gt;<a class="code" href="structast__channel.html#abf9ad08121b2a624ad15e74c17f2b59">macroexten</a>, exten))
<a name="l00960"></a>00960                <span class="keywordflow">continue</span>;   <span class="comment">/* exten match failed */</span>
<a name="l00961"></a>00961          }
<a name="l00962"></a>00962          <span class="comment">/* if we get here, c points to the desired record */</span>
<a name="l00963"></a>00963          <span class="keywordflow">break</span>;
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965       <span class="comment">/* exit if chan not found or mutex acquired successfully */</span>
<a name="l00966"></a>00966       <span class="comment">/* this is slightly unsafe, as we _should_ hold the lock to access c-&gt;name */</span>
<a name="l00967"></a>00967       done = c == NULL || <a class="code" href="lock_8h.html#ed66db8089c98c0615ab831f4eba520a">ast_channel_trylock</a>(c) == 0;
<a name="l00968"></a>00968       <span class="keywordflow">if</span> (!done) {
<a name="l00969"></a>00969          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00970"></a>00970             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Avoiding %s for channel '%p'\n"</span>, msg, c);
<a name="l00971"></a>00971       }
<a name="l00972"></a>00972       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l00973"></a>00973       <span class="keywordflow">if</span> (done)
<a name="l00974"></a>00974          <span class="keywordflow">return</span> c;
<a name="l00975"></a>00975       usleep(1);  <span class="comment">/* give other threads a chance before retrying */</span>
<a name="l00976"></a>00976    }
<a name="l00977"></a>00977    <span class="comment">/*</span>
<a name="l00978"></a>00978 <span class="comment">    * c is surely not null, but we don't have the lock so cannot</span>
<a name="l00979"></a>00979 <span class="comment">    * access c-&gt;name</span>
<a name="l00980"></a>00980 <span class="comment">    */</span>
<a name="l00981"></a>00981    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00982"></a>00982       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Failure, could not lock '%p' after %d retries!\n"</span>,
<a name="l00983"></a>00983          c, retries);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985    <span class="keywordflow">return</span> NULL;
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 <span class="comment"></span>
<a name="l00988"></a>00988 <span class="comment">/*! \brief Browse channels in use */</span>
<a name="l00989"></a><a class="code" href="channel_8h.html#8ada12445e0d71c8bcd465f6838bf4e5">00989</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#8ada12445e0d71c8bcd465f6838bf4e5">ast_channel_walk_locked</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *prev)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(prev, NULL, 0, NULL, NULL);
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 <span class="comment"></span>
<a name="l00994"></a>00994 <span class="comment">/*! \brief Get channel by name and lock it */</span>
<a name="l00995"></a><a class="code" href="channel_8h.html#5bb2284c9cf122c444b25bbabaf3af97">00995</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00996"></a>00996 {
<a name="l00997"></a>00997    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(NULL, name, 0, NULL, NULL);
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 <span class="comment"></span>
<a name="l01000"></a>01000 <span class="comment">/*! \brief Get channel by name prefix and lock it */</span>
<a name="l01001"></a><a class="code" href="channel_8h.html#73dcef78b8c7fc8cb85dde3ee0058c57">01001</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#73dcef78b8c7fc8cb85dde3ee0058c57">ast_get_channel_by_name_prefix_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> namelen)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(NULL, name, namelen, NULL, NULL);
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 <span class="comment"></span>
<a name="l01006"></a>01006 <span class="comment">/*! \brief Get next channel by name prefix and lock it */</span>
<a name="l01007"></a><a class="code" href="channel_8h.html#1eee0e9ee6288a0786551187875a49d2">01007</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#1eee0e9ee6288a0786551187875a49d2">ast_walk_channel_by_name_prefix_locked</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>,
<a name="l01008"></a>01008                         <span class="keyword">const</span> <span class="keywordtype">int</span> namelen)
<a name="l01009"></a>01009 {
<a name="l01010"></a>01010    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(chan, name, namelen, NULL, NULL);
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 <span class="comment"></span>
<a name="l01013"></a>01013 <span class="comment">/*! \brief Get channel by exten (and optionally context) and lock it */</span>
<a name="l01014"></a><a class="code" href="channel_8h.html#20c0f06f47ac708677674d6fe2007cc9">01014</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#20c0f06f47ac708677674d6fe2007cc9">ast_get_channel_by_exten_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(NULL, NULL, 0, context, exten);
<a name="l01017"></a>01017 }
<a name="l01018"></a>01018 <span class="comment"></span>
<a name="l01019"></a>01019 <span class="comment">/*! \brief Get next channel by exten (and optionally context) and lock it */</span>
<a name="l01020"></a><a class="code" href="channel_8h.html#76257a964ba665c0c5ff96edd1328d85">01020</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#76257a964ba665c0c5ff96edd1328d85">ast_walk_channel_by_exten_locked</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>,
<a name="l01021"></a>01021                        <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#188578d17e5577beb5ec3575458d3f71">channel_find_locked</a>(chan, NULL, 0, context, exten);
<a name="l01024"></a>01024 }
<a name="l01025"></a>01025 <span class="comment"></span>
<a name="l01026"></a>01026 <span class="comment">/*! \brief Wait, look for hangups and condition arg */</span>
<a name="l01027"></a><a class="code" href="channel_8h.html#2f6cb4adec26f68897163438dc02f2c7">01027</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#2f6cb4adec26f68897163438dc02f2c7">ast_safe_sleep_conditional</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> ms, <span class="keywordtype">int</span> (*<a class="code" href="event_8c.html#26542fb18a8b14c9775aa475f23c909f">cond</a>)(<span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l01028"></a>01028 {
<a name="l01029"></a>01029    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <span class="keywordflow">while</span> (ms &gt; 0) {
<a name="l01032"></a>01032       <span class="keywordflow">if</span> (cond &amp;&amp; ((*cond)(data) == 0))
<a name="l01033"></a>01033          <span class="keywordflow">return</span> 0;
<a name="l01034"></a>01034       ms = <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(chan, ms);
<a name="l01035"></a>01035       <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l01036"></a>01036          <span class="keywordflow">return</span> -1;
<a name="l01037"></a>01037       <span class="keywordflow">if</span> (ms &gt; 0) {
<a name="l01038"></a>01038          f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l01039"></a>01039          <span class="keywordflow">if</span> (!f)
<a name="l01040"></a>01040             <span class="keywordflow">return</span> -1;
<a name="l01041"></a>01041          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01042"></a>01042       }
<a name="l01043"></a>01043    }
<a name="l01044"></a>01044    <span class="keywordflow">return</span> 0;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 <span class="comment"></span>
<a name="l01047"></a>01047 <span class="comment">/*! \brief Wait, look for hangups */</span>
<a name="l01048"></a><a class="code" href="channel_8h.html#24a36b04429e3cdef17e161363c13900">01048</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> ms)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#2f6cb4adec26f68897163438dc02f2c7">ast_safe_sleep_conditional</a>(chan, ms, NULL, NULL);
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a><a class="code" href="channel_8c.html#ccea08979c0c8d9565d95c97bd022408">01053</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#ccea08979c0c8d9565d95c97bd022408">free_cid</a>(<span class="keyword">struct</span> <a class="code" href="structast__callerid.html">ast_callerid</a> *cid)
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055    <span class="keywordflow">if</span> (cid-&gt;<a class="code" href="structast__callerid.html#24ebe3d1b8eb2a6c8e3511a7a1461b75">cid_dnid</a>)
<a name="l01056"></a>01056       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cid-&gt;<a class="code" href="structast__callerid.html#24ebe3d1b8eb2a6c8e3511a7a1461b75">cid_dnid</a>);
<a name="l01057"></a>01057    <span class="keywordflow">if</span> (cid-&gt;<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)
<a name="l01058"></a>01058       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cid-&gt;<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);  
<a name="l01059"></a>01059    <span class="keywordflow">if</span> (cid-&gt;<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>)
<a name="l01060"></a>01060       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cid-&gt;<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>); 
<a name="l01061"></a>01061    <span class="keywordflow">if</span> (cid-&gt;<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a>)
<a name="l01062"></a>01062       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cid-&gt;<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a>);
<a name="l01063"></a>01063    <span class="keywordflow">if</span> (cid-&gt;<a class="code" href="structast__callerid.html#5601a9e1c149cb51bde32dcc877b10b0">cid_rdnis</a>)
<a name="l01064"></a>01064       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cid-&gt;<a class="code" href="structast__callerid.html#5601a9e1c149cb51bde32dcc877b10b0">cid_rdnis</a>);
<a name="l01065"></a>01065    cid-&gt;<a class="code" href="structast__callerid.html#24ebe3d1b8eb2a6c8e3511a7a1461b75">cid_dnid</a> = cid-&gt;<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a> = cid-&gt;<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a> = cid-&gt;<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a> = cid-&gt;<a class="code" href="structast__callerid.html#5601a9e1c149cb51bde32dcc877b10b0">cid_rdnis</a> = NULL;
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 <span class="comment"></span>
<a name="l01068"></a>01068 <span class="comment">/*! \brief Free a channel structure */</span>
<a name="l01069"></a><a class="code" href="channel_8h.html#b5c070531d4d02ac1e0e2b8aeaf6687e">01069</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#230a804b09060fecdf699c2c9613fff7">ast_channel_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071    <span class="keywordtype">int</span> fd;
<a name="l01072"></a>01072    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *vardata;
<a name="l01073"></a>01073    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01074"></a>01074    <span class="keyword">struct </span>varshead *headp;
<a name="l01075"></a>01075    <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *datastore = NULL;
<a name="l01076"></a>01076    <span class="keywordtype">char</span> <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>[<a class="code" href="channel_8h.html#57fb43d64b209037cdc198f3db578d39">AST_CHANNEL_NAME</a>];
<a name="l01077"></a>01077    
<a name="l01078"></a>01078    headp=&amp;chan-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>;
<a name="l01079"></a>01079    
<a name="l01080"></a>01080    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels);
<a name="l01081"></a>01081    <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;channels, chan, <a class="code" href="structchan__list.html">chan_list</a>);
<a name="l01082"></a>01082    <span class="comment">/* Lock and unlock the channel just to be sure nobody</span>
<a name="l01083"></a>01083 <span class="comment">      has it locked still */</span>
<a name="l01084"></a>01084    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01085"></a>01085    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01086"></a>01086    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>) {
<a name="l01087"></a>01087       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel '%s' may not have been hung up properly\n"</span>, chan-&gt;name);
<a name="l01088"></a>01088       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>);
<a name="l01089"></a>01089    }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>)
<a name="l01092"></a>01092       <a class="code" href="sched_8c.html#89e2eb9653fa462ad4ff62e05ad36050">sched_context_destroy</a>(chan-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    ast_copy_string(name, chan-&gt;name, <span class="keyword">sizeof</span>(name));
<a name="l01095"></a>01095 
<a name="l01096"></a>01096    <span class="comment">/* Stop monitoring */</span>
<a name="l01097"></a>01097    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>)
<a name="l01098"></a>01098       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#172ba70dfc80c54f386c2fa13574a011">stop</a>( chan, 0 );
<a name="l01099"></a>01099 
<a name="l01100"></a>01100    <span class="comment">/* If there is native format music-on-hold state, free it */</span>
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#e15d64fee78c33c64ef107f1bef4edd0">music_state</a>)
<a name="l01102"></a>01102       <a class="code" href="channel_8c.html#3c4d4ffc411bd181677307e95b6b8c7b">ast_moh_cleanup</a>(chan);
<a name="l01103"></a>01103 
<a name="l01104"></a>01104    <span class="comment">/* if someone is whispering on the channel, stop them */</span>
<a name="l01105"></a>01105    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>)
<a name="l01106"></a>01106       <a class="code" href="channel_8c.html#79598f580fc373516b4489bc5ebb7b02">ast_channel_whisper_stop</a>(chan);
<a name="l01107"></a>01107 
<a name="l01108"></a>01108    <span class="comment">/* Free translators */</span>
<a name="l01109"></a>01109    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>)
<a name="l01110"></a>01110       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>);
<a name="l01111"></a>01111    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>)
<a name="l01112"></a>01112       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>);
<a name="l01113"></a>01113    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a>)
<a name="l01114"></a>01114       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"PBX may not have been terminated properly on '%s'\n"</span>, chan-&gt;name);
<a name="l01115"></a>01115    <a class="code" href="channel_8c.html#ccea08979c0c8d9565d95c97bd022408">free_cid</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>);
<a name="l01116"></a>01116    <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01117"></a>01117    <span class="comment">/* Close pipes if appropriate */</span>
<a name="l01118"></a>01118    <span class="keywordflow">if</span> ((fd = chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[0]) &gt; -1)
<a name="l01119"></a>01119       close(fd);
<a name="l01120"></a>01120    <span class="keywordflow">if</span> ((fd = chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[1]) &gt; -1)
<a name="l01121"></a>01121       close(fd);
<a name="l01122"></a>01122    <span class="keywordflow">if</span> ((fd = chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>) &gt; -1)
<a name="l01123"></a>01123       close(fd);
<a name="l01124"></a>01124    <span class="keywordflow">while</span> ((f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;chan-&gt;readq, frame_list)))
<a name="l01125"></a>01125       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01126"></a>01126    
<a name="l01127"></a>01127    <span class="comment">/* Get rid of each of the data stores on the channel */</span>
<a name="l01128"></a>01128    <span class="keywordflow">while</span> ((datastore = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;chan-&gt;datastores, entry)))
<a name="l01129"></a>01129       <span class="comment">/* Free the data store */</span>
<a name="l01130"></a>01130       <a class="code" href="channel_8c.html#9b22e546aca18fcd4e4f512843f608c5">ast_channel_datastore_free</a>(datastore);
<a name="l01131"></a>01131    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;chan-&gt;datastores);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133    <span class="comment">/* loop over the variables list, freeing all data and deleting list items */</span>
<a name="l01134"></a>01134    <span class="comment">/* no need to lock the list, as the channel is already locked */</span>
<a name="l01135"></a>01135    
<a name="l01136"></a>01136    <span class="keywordflow">while</span> ((vardata = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(headp, entries)))
<a name="l01137"></a>01137       <a class="code" href="chanvars_8c.html#32e018d32324bab845a9cac601c175d8">ast_var_delete</a>(vardata);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <a class="code" href="app_8c.html#3004a5d883799913a0f73f5bbf16b3fd">ast_app_group_discard</a>(chan);
<a name="l01140"></a>01140 
<a name="l01141"></a>01141    <span class="comment">/* Destroy the jitterbuffer */</span>
<a name="l01142"></a>01142    <a class="code" href="abstract__jb_8c.html#38a4eb32a5c1425119f290654b6a4b0e">ast_jb_destroy</a>(chan);
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <a class="code" href="stringfields_8h.html#772cf76139a5b96f329a48ae8307e142">ast_string_field_free_pools</a>(chan);
<a name="l01145"></a>01145    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan);
<a name="l01146"></a>01146    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148    <a class="code" href="devicestate_8c.html#2416b5bb0bcab6392204637700a2d280">ast_device_state_changed_literal</a>(name);
<a name="l01149"></a>01149 }
<a name="l01150"></a>01150 
<a name="l01151"></a><a class="code" href="channel_8h.html#5a56e43ad0ea2cecbf51410e82ea7455">01151</a> <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *<a class="code" href="channel_8c.html#5a56e43ad0ea2cecbf51410e82ea7455">ast_channel_datastore_alloc</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__datastore__info.html">ast_datastore_info</a> *<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a>)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153    <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *datastore = NULL;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155    <span class="comment">/* Make sure we at least have type so we can identify this */</span>
<a name="l01156"></a>01156    <span class="keywordflow">if</span> (info == NULL) {
<a name="l01157"></a>01157       <span class="keywordflow">return</span> NULL;
<a name="l01158"></a>01158    }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160    <span class="comment">/* Allocate memory for datastore and clear it */</span>
<a name="l01161"></a>01161    datastore = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*datastore));
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (datastore == NULL) {
<a name="l01163"></a>01163       <span class="keywordflow">return</span> NULL;
<a name="l01164"></a>01164    }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166    datastore-&gt;info = info;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168    datastore-&gt;uid = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(uid);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <span class="keywordflow">return</span> datastore;
<a name="l01171"></a>01171 }
<a name="l01172"></a>01172 
<a name="l01173"></a><a class="code" href="channel_8h.html#9b22e546aca18fcd4e4f512843f608c5">01173</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#9b22e546aca18fcd4e4f512843f608c5">ast_channel_datastore_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__datastore.html">ast_datastore</a> *datastore)
<a name="l01174"></a>01174 {
<a name="l01175"></a>01175    <span class="keywordtype">int</span> res = 0;
<a name="l01176"></a>01176 
<a name="l01177"></a>01177    <span class="comment">/* Using the destroy function (if present) destroy the data */</span>
<a name="l01178"></a>01178    <span class="keywordflow">if</span> (datastore-&gt;<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>-&gt;<a class="code" href="structast__datastore__info.html#dcb7bbbeb2d36e8fbe0c9d592a992fd5">destroy</a> != NULL &amp;&amp; datastore-&gt;<a class="code" href="structast__datastore.html#8d777f385d3dfec8815d20f7496026dc">data</a> != NULL) {
<a name="l01179"></a>01179       datastore-&gt;<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>-&gt;<a class="code" href="structast__datastore__info.html#dcb7bbbeb2d36e8fbe0c9d592a992fd5">destroy</a>(datastore-&gt;<a class="code" href="structast__datastore.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l01180"></a>01180       datastore-&gt;<a class="code" href="structast__datastore.html#8d777f385d3dfec8815d20f7496026dc">data</a> = NULL;
<a name="l01181"></a>01181    }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183    <span class="comment">/* Free allocated UID memory */</span>
<a name="l01184"></a>01184    <span class="keywordflow">if</span> (datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a> != NULL) {
<a name="l01185"></a>01185       <a class="code" href="utils_8h.html#801d8022c2922d0d4f73ba9e72c93865">ast_free</a>(datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a>);
<a name="l01186"></a>01186       datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a> = NULL;
<a name="l01187"></a>01187    }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189    <span class="comment">/* Finally free memory used by ourselves */</span>
<a name="l01190"></a>01190    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(datastore);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <span class="keywordflow">return</span> res;
<a name="l01193"></a>01193 }
<a name="l01194"></a>01194 
<a name="l01195"></a><a class="code" href="channel_8h.html#7ccb0875d5b63754a9c968f5dbb92d99">01195</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#7ccb0875d5b63754a9c968f5dbb92d99">ast_channel_datastore_inherit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *from, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *to)
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197    <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *datastore = NULL, *datastore2;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;from-&gt;datastores, datastore, entry) {
<a name="l01200"></a>01200       <span class="keywordflow">if</span> (datastore-&gt;<a class="code" href="structast__datastore.html#5fed3411faf832174ef1f040028b2c21">inheritance</a> &gt; 0) {
<a name="l01201"></a>01201          datastore2 = <a class="code" href="channel_8c.html#5a56e43ad0ea2cecbf51410e82ea7455">ast_channel_datastore_alloc</a>(datastore-&gt;<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>, datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a>);
<a name="l01202"></a>01202          <span class="keywordflow">if</span> (datastore2) {
<a name="l01203"></a>01203             datastore2-&gt;data = datastore-&gt;<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>-&gt;<a class="code" href="structast__datastore__info.html#5269cd2ce9244cb1fe12923590c62067">duplicate</a>(datastore-&gt;<a class="code" href="structast__datastore.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l01204"></a>01204             datastore2-&gt;inheritance = datastore-&gt;<a class="code" href="structast__datastore.html#5fed3411faf832174ef1f040028b2c21">inheritance</a> == <a class="code" href="channel_8h.html#c6e71954f351d74faf8285b775ed08af">DATASTORE_INHERIT_FOREVER</a> ? <a class="code" href="channel_8h.html#c6e71954f351d74faf8285b775ed08af">DATASTORE_INHERIT_FOREVER</a> : datastore-&gt;<a class="code" href="structast__datastore.html#5fed3411faf832174ef1f040028b2c21">inheritance</a> - 1;
<a name="l01205"></a>01205             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;to-&gt;datastores, datastore2, entry);
<a name="l01206"></a>01206          }
<a name="l01207"></a>01207       }
<a name="l01208"></a>01208    }
<a name="l01209"></a>01209    <span class="keywordflow">return</span> 0;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a><a class="code" href="channel_8h.html#cbc50cd4e716fe4486cf2dc81222e30e">01212</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#cbc50cd4e716fe4486cf2dc81222e30e">ast_channel_datastore_add</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__datastore.html">ast_datastore</a> *datastore)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214    <span class="keywordtype">int</span> res = 0;
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;chan-&gt;datastores, datastore, entry);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218    <span class="keywordflow">return</span> res;
<a name="l01219"></a>01219 }
<a name="l01220"></a>01220 
<a name="l01221"></a><a class="code" href="channel_8h.html#2703596e193d96ac5e31ee1f0f3ef4ce">01221</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#2703596e193d96ac5e31ee1f0f3ef4ce">ast_channel_datastore_remove</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__datastore.html">ast_datastore</a> *datastore)
<a name="l01222"></a>01222 {
<a name="l01223"></a>01223    <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *datastore2 = NULL;
<a name="l01224"></a>01224    <span class="keywordtype">int</span> res = -1;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226    <span class="comment">/* Find our position and remove ourselves */</span>
<a name="l01227"></a>01227    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;datastores, datastore2, entry) {
<a name="l01228"></a>01228       <span class="keywordflow">if</span> (datastore2 == datastore) {
<a name="l01229"></a>01229          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;chan-&gt;datastores, entry);
<a name="l01230"></a>01230          res = 0;
<a name="l01231"></a>01231          <span class="keywordflow">break</span>;
<a name="l01232"></a>01232       }
<a name="l01233"></a>01233    }
<a name="l01234"></a>01234    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l01235"></a>01235 
<a name="l01236"></a>01236    <span class="keywordflow">return</span> res;
<a name="l01237"></a>01237 }
<a name="l01238"></a>01238 
<a name="l01239"></a><a class="code" href="channel_8h.html#a139501a58997c4f147764f1df0dccdd">01239</a> <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *<a class="code" href="channel_8c.html#a139501a58997c4f147764f1df0dccdd">ast_channel_datastore_find</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__datastore__info.html">ast_datastore_info</a> *<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a>)
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241    <span class="keyword">struct </span><a class="code" href="structast__datastore.html">ast_datastore</a> *datastore = NULL;
<a name="l01242"></a>01242    
<a name="l01243"></a>01243    <span class="keywordflow">if</span> (info == NULL)
<a name="l01244"></a>01244       <span class="keywordflow">return</span> NULL;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;datastores, datastore, entry) {
<a name="l01247"></a>01247       <span class="keywordflow">if</span> (datastore-&gt;<a class="code" href="structast__datastore.html#caf9b6b99962bf5c2264824231d7a40c">info</a> == info) {
<a name="l01248"></a>01248          <span class="keywordflow">if</span> (uid != NULL &amp;&amp; datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a> != NULL) {
<a name="l01249"></a>01249             <span class="keywordflow">if</span> (!strcasecmp(uid, datastore-&gt;<a class="code" href="structast__datastore.html#9871d3a2c554b27151cacf1422eec048">uid</a>)) {
<a name="l01250"></a>01250                <span class="comment">/* Matched by type AND uid */</span>
<a name="l01251"></a>01251                <span class="keywordflow">break</span>;
<a name="l01252"></a>01252             }
<a name="l01253"></a>01253          } <span class="keywordflow">else</span> {
<a name="l01254"></a>01254             <span class="comment">/* Matched by type at least */</span>
<a name="l01255"></a>01255             <span class="keywordflow">break</span>;
<a name="l01256"></a>01256          }
<a name="l01257"></a>01257       }
<a name="l01258"></a>01258    }
<a name="l01259"></a>01259    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l01260"></a>01260 
<a name="l01261"></a>01261    <span class="keywordflow">return</span> datastore;
<a name="l01262"></a>01262 }
<a name="l01263"></a>01263 
<a name="l01264"></a><a class="code" href="chanspy_8h.html#591849511705fdcff3f838155dadc90a">01264</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#591849511705fdcff3f838155dadc90a">ast_channel_spy_add</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy)
<a name="l01265"></a>01265 {
<a name="l01266"></a>01266    <span class="comment">/* Link the owner channel to the spy */</span>
<a name="l01267"></a>01267    spy-&gt;<a class="code" href="structast__channel__spy.html#26c322652770620e64ac90682eb6504c">chan</a> = chan;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65332bb902feb367d081da3c78c1e57341">CHANSPY_FORMAT_AUDIO</a>)) {
<a name="l01270"></a>01270       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not add channel spy '%s' to channel '%s', only audio format spies are supported.\n"</span>,
<a name="l01271"></a>01271          spy-&gt;<a class="code" href="structast__channel__spy.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, chan-&gt;name);
<a name="l01272"></a>01272       <span class="keywordflow">return</span> -1;
<a name="l01273"></a>01273    }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65182be74692abc8f01ed538bc4e42629c">CHANSPY_READ_VOLADJUST</a>) &amp;&amp; (spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l01276"></a>01276       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot provide volume adjustment on '%s' format spies\n"</span>,
<a name="l01277"></a>01277          <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>));
<a name="l01278"></a>01278       <span class="keywordflow">return</span> -1;
<a name="l01279"></a>01279    }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce650cddca71a0efa3c6c9f94e1b276046bd">CHANSPY_WRITE_VOLADJUST</a>) &amp;&amp; (spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l01282"></a>01282       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot provide volume adjustment on '%s' format spies\n"</span>,
<a name="l01283"></a>01283          <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>));
<a name="l01284"></a>01284       <span class="keywordflow">return</span> -1;
<a name="l01285"></a>01285    }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce651f319c5d4c24864a434e56ab93c72e72">CHANSPY_MIXAUDIO</a>) &amp;&amp;
<a name="l01288"></a>01288        ((spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>) ||
<a name="l01289"></a>01289         (spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>))) {
<a name="l01290"></a>01290       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot provide audio mixing on '%s'-'%s' format spies\n"</span>,
<a name="l01291"></a>01291          <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>), <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>));
<a name="l01292"></a>01292       <span class="keywordflow">return</span> -1;
<a name="l01293"></a>01293    }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>) {
<a name="l01296"></a>01296       <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)))) {
<a name="l01297"></a>01297          <span class="keywordflow">return</span> -1;
<a name="l01298"></a>01298       }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300       <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list);
<a name="l01301"></a>01301       <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list);
<a name="l01302"></a>01302    } <span class="keywordflow">else</span> {
<a name="l01303"></a>01303       <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list);
<a name="l01304"></a>01304    }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>) != <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65eea652b43493a4b39fb3895177943685">CHANSPY_TRIGGER_NONE</a>) {
<a name="l01307"></a>01307       <a class="code" href="lock_8h.html#26b556000e9ba452b40f732a86644de6">ast_cond_init</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>, NULL);
<a name="l01308"></a>01308       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce657ac2f35629f6a422837ce4fc6eed040a">CHANSPY_TRIGGER_READ</a>);
<a name="l01309"></a>01309       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65419ab3aa5960e1f296e9f4ab481a0741">CHANSPY_TRIGGER_WRITE</a>);
<a name="l01310"></a>01310    }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01313"></a>01313       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Spy %s added to channel %s\n"</span>,
<a name="l01314"></a>01314          spy-&gt;<a class="code" href="structast__channel__spy.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, chan-&gt;name);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316    <span class="keywordflow">return</span> 0;
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 <span class="comment">/* Clean up a channel's spy information */</span>
<a name="l01320"></a><a class="code" href="channel_8c.html#c00847a39b3ef850c25d058ac59264cc">01320</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#c00847a39b3ef850c25d058ac59264cc">spy_cleanup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01321"></a>01321 {
<a name="l01322"></a>01322    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list))
<a name="l01323"></a>01323       <span class="keywordflow">return</span>;
<a name="l01324"></a>01324    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#c09aaaa2b00c752fcd138ba0065cefee">read_translator</a>.<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>)
<a name="l01325"></a>01325       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#c09aaaa2b00c752fcd138ba0065cefee">read_translator</a>.<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>);
<a name="l01326"></a>01326    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#7ba60a6f45d9737e1eb2978f6de8f22b">write_translator</a>.<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>)
<a name="l01327"></a>01327       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#7ba60a6f45d9737e1eb2978f6de8f22b">write_translator</a>.<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>);
<a name="l01328"></a>01328    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>);
<a name="l01329"></a>01329    chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> = NULL;
<a name="l01330"></a>01330    <span class="keywordflow">return</span>;
<a name="l01331"></a>01331 }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333 <span class="comment">/* Detach a spy from it's channel */</span>
<a name="l01334"></a><a class="code" href="channel_8c.html#42536bea214e15b5d74b7a56c0cc304b">01334</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#42536bea214e15b5d74b7a56c0cc304b">spy_detach</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01335"></a>01335 {
<a name="l01336"></a>01336    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01337"></a>01337 
<a name="l01338"></a>01338    <span class="comment">/* We only need to poke them if they aren't already done */</span>
<a name="l01339"></a>01339    <span class="keywordflow">if</span> (spy-&gt;<a class="code" href="structast__channel__spy.html#9acb44549b41563697bb490144ec6258">status</a> != <a class="code" href="chanspy_8h.html#304d7c9f7a8c99380ef1fe3c955adf3f93c19bb62ffd2ffa5386b754ca90e136">CHANSPY_DONE</a>) {
<a name="l01340"></a>01340       <span class="comment">/* Indicate to the spy to stop */</span>
<a name="l01341"></a>01341       spy-&gt;<a class="code" href="structast__channel__spy.html#9acb44549b41563697bb490144ec6258">status</a> = <a class="code" href="chanspy_8h.html#304d7c9f7a8c99380ef1fe3c955adf3f54afba7a99f3a23e26f20f13434c5b8b">CHANSPY_STOP</a>;
<a name="l01342"></a>01342       spy-&gt;<a class="code" href="structast__channel__spy.html#26c322652770620e64ac90682eb6504c">chan</a> = NULL;
<a name="l01343"></a>01343       <span class="comment">/* Poke the spy if needed */</span>
<a name="l01344"></a>01344       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>) != <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65eea652b43493a4b39fb3895177943685">CHANSPY_TRIGGER_NONE</a>)
<a name="l01345"></a>01345          <a class="code" href="lock_8h.html#119b205a84b106ec84a3a496dbe88082">ast_cond_signal</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>);
<a name="l01346"></a>01346    }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348    <span class="comment">/* Print it out while we still have a lock so the structure can't go away (if signalled above) */</span>
<a name="l01349"></a>01349    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01350"></a>01350       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Spy %s removed from channel %s\n"</span>, spy-&gt;<a class="code" href="structast__channel__spy.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, chan-&gt;name);
<a name="l01351"></a>01351 
<a name="l01352"></a>01352    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354    <span class="keywordflow">return</span>;
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="chanspy_8h.html#0730397c6530683a40c8162da49fd69e">01357</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#0730397c6530683a40c8162da49fd69e">ast_channel_spy_stop_by_type</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359    <span class="keyword">struct </span><a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy = NULL;
<a name="l01360"></a>01360    
<a name="l01361"></a>01361    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)
<a name="l01362"></a>01362       <span class="keywordflow">return</span>;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list) {
<a name="l01365"></a>01365       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01366"></a>01366       <span class="keywordflow">if</span> ((spy-&gt;<a class="code" href="structast__channel__spy.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> == type) &amp;&amp; (spy-&gt;<a class="code" href="structast__channel__spy.html#9acb44549b41563697bb490144ec6258">status</a> == <a class="code" href="chanspy_8h.html#304d7c9f7a8c99380ef1fe3c955adf3f5166c25d27285982f469175514888813">CHANSPY_RUNNING</a>)) {
<a name="l01367"></a>01367          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01368"></a>01368          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, list);
<a name="l01369"></a>01369          <a class="code" href="channel_8c.html#42536bea214e15b5d74b7a56c0cc304b">spy_detach</a>(spy, chan);
<a name="l01370"></a>01370       } <span class="keywordflow">else</span>
<a name="l01371"></a>01371          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01372"></a>01372    }
<a name="l01373"></a>01373    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l01374"></a>01374    <a class="code" href="channel_8c.html#c00847a39b3ef850c25d058ac59264cc">spy_cleanup</a>(chan);
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a><a class="code" href="chanspy_8h.html#c9e9dc4c1549186228a46272aa69650d">01377</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#c9e9dc4c1549186228a46272aa69650d">ast_channel_spy_trigger_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy)
<a name="l01378"></a>01378 {
<a name="l01379"></a>01379    <span class="keyword">struct </span>timeval tv;
<a name="l01380"></a>01380    <span class="keyword">struct </span>timespec ts;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382    tv = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(ast_tvnow(), ast_samp2tv(50000, 1000));
<a name="l01383"></a>01383    ts.tv_sec = tv.tv_sec;
<a name="l01384"></a>01384    ts.tv_nsec = tv.tv_usec * 1000;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386    <a class="code" href="lock_8h.html#4e0093c0ebed37e7f2836835cd83a560">ast_cond_timedwait</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>, &amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>, &amp;ts);
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01389"></a><a class="code" href="chanspy_8h.html#cde5ef271aa7cb6fa771ffe14e91e0d2">01389</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#cde5ef271aa7cb6fa771ffe14e91e0d2">ast_channel_spy_remove</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy)
<a name="l01390"></a>01390 {
<a name="l01391"></a>01391    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)
<a name="l01392"></a>01392       <span class="keywordflow">return</span>;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394    <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list);
<a name="l01395"></a>01395    <a class="code" href="channel_8c.html#42536bea214e15b5d74b7a56c0cc304b">spy_detach</a>(spy, chan);
<a name="l01396"></a>01396    <a class="code" href="channel_8c.html#c00847a39b3ef850c25d058ac59264cc">spy_cleanup</a>(chan);
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a><a class="code" href="chanspy_8h.html#52f8fa2ea810b99986edab442ed4e2f6">01399</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#52f8fa2ea810b99986edab442ed4e2f6">ast_channel_spy_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy)
<a name="l01400"></a>01400 {
<a name="l01401"></a>01401    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403    <span class="keywordflow">if</span> (spy-&gt;<a class="code" href="structast__channel__spy.html#9acb44549b41563697bb490144ec6258">status</a> == <a class="code" href="chanspy_8h.html#304d7c9f7a8c99380ef1fe3c955adf3f93c19bb62ffd2ffa5386b754ca90e136">CHANSPY_DONE</a>)
<a name="l01404"></a>01404       <span class="keywordflow">return</span>;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406    <span class="comment">/* Switch status to done in case we get called twice */</span>
<a name="l01407"></a>01407    spy-&gt;<a class="code" href="structast__channel__spy.html#9acb44549b41563697bb490144ec6258">status</a> = <a class="code" href="chanspy_8h.html#304d7c9f7a8c99380ef1fe3c955adf3f93c19bb62ffd2ffa5386b754ca90e136">CHANSPY_DONE</a>;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409    <span class="comment">/* Drop any frames in the queue */</span>
<a name="l01410"></a>01410    <span class="keywordflow">while</span> ((f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list, frame_list)))
<a name="l01411"></a>01411       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01412"></a>01412    <span class="keywordflow">while</span> ((f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list, frame_list)))
<a name="l01413"></a>01413       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01414"></a>01414 
<a name="l01415"></a>01415    <span class="comment">/* Destroy the condition if in use */</span>
<a name="l01416"></a>01416    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>) != <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65eea652b43493a4b39fb3895177943685">CHANSPY_TRIGGER_NONE</a>)
<a name="l01417"></a>01417       <a class="code" href="lock_8h.html#137771c8825678eeb6d67193572919d1">ast_cond_destroy</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419    <span class="comment">/* Destroy our mutex since it is no longer in use */</span>
<a name="l01420"></a>01420    <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422    <span class="keywordflow">return</span>;
<a name="l01423"></a>01423 }
<a name="l01424"></a>01424 
<a name="l01425"></a><a class="code" href="channel_8c.html#f40ac2c82018d2d1726231f39a54f380">01425</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#f40ac2c82018d2d1726231f39a54f380">detach_spies</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01426"></a>01426 {
<a name="l01427"></a>01427    <span class="keyword">struct </span><a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy = NULL;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)
<a name="l01430"></a>01430       <span class="keywordflow">return</span>;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list) {
<a name="l01433"></a>01433       <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, list);
<a name="l01434"></a>01434       <a class="code" href="channel_8c.html#42536bea214e15b5d74b7a56c0cc304b">spy_detach</a>(spy, chan);
<a name="l01435"></a>01435    }
<a name="l01436"></a>01436    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <a class="code" href="channel_8c.html#c00847a39b3ef850c25d058ac59264cc">spy_cleanup</a>(chan);
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 <span class="comment"></span>
<a name="l01441"></a>01441 <span class="comment">/*! \brief Softly hangup a channel, don't lock */</span>
<a name="l01442"></a><a class="code" href="channel_8h.html#c969f5294a61165c99c9b6f65ecae173">01442</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#c969f5294a61165c99c9b6f65ecae173">ast_softhangup_nolock</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> cause)
<a name="l01443"></a>01443 {
<a name="l01444"></a>01444    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01445"></a>01445       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Soft-Hanging up channel '%s'\n"</span>, chan-&gt;name);
<a name="l01446"></a>01446    <span class="comment">/* Inform channel driver that we need to be hung up, if it cares */</span>
<a name="l01447"></a>01447    chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= cause;
<a name="l01448"></a>01448    <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(chan, &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>);
<a name="l01449"></a>01449    <span class="comment">/* Interrupt any poll call or such */</span>
<a name="l01450"></a>01450    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>))
<a name="l01451"></a>01451       pthread_kill(chan-&gt;<a class="code" href="structast__channel.html#a38ba46bb4909bc27602645297913d86">blocker</a>, SIGURG);
<a name="l01452"></a>01452    <span class="keywordflow">return</span> 0;
<a name="l01453"></a>01453 }
<a name="l01454"></a>01454 <span class="comment"></span>
<a name="l01455"></a>01455 <span class="comment">/*! \brief Softly hangup a channel, lock */</span>
<a name="l01456"></a><a class="code" href="channel_8h.html#a1a142039194e9f6dfb632b28a0c5eb5">01456</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> cause)
<a name="l01457"></a>01457 {
<a name="l01458"></a>01458    <span class="keywordtype">int</span> res;
<a name="l01459"></a>01459    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01460"></a>01460    res = <a class="code" href="channel_8c.html#c969f5294a61165c99c9b6f65ecae173">ast_softhangup_nolock</a>(chan, cause);
<a name="l01461"></a>01461    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01462"></a>01462    <span class="keywordflow">return</span> res;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a><a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886">01465</a> <span class="keyword">enum</span> <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886">spy_direction</a> {
<a name="l01466"></a>01466    <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>,
<a name="l01467"></a>01467    <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886e3b4d6702d1998b494bbab2603e96bcc">SPY_WRITE</a>,
<a name="l01468"></a>01468 };
<a name="l01469"></a>01469 
<a name="l01470"></a><a class="code" href="channel_8c.html#1436783f10d73e546c3be8d77072760c">01470</a> <span class="preprocessor">#define SPY_QUEUE_SAMPLE_LIMIT 4000       </span><span class="comment">/* half of one second */</span>
<a name="l01471"></a>01471 
<a name="l01472"></a><a class="code" href="channel_8c.html#b9e289822f77fb0615938e04d36255c1">01472</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#b9e289822f77fb0615938e04d36255c1">queue_frame_to_spies</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>, <span class="keyword">enum</span> <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886">spy_direction</a> <a class="code" href="adsistub_8c.html#736007832d2167baaae763fd3a3f3cf1">dir</a>)
<a name="l01473"></a>01473 {
<a name="l01474"></a>01474    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *translated_frame = NULL;
<a name="l01475"></a>01475    <span class="keyword">struct </span><a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy;
<a name="l01476"></a>01476    <span class="keyword">struct </span><a class="code" href="structchannel__spy__trans.html">channel_spy_trans</a> *trans;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478    trans = (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>) ? &amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#c09aaaa2b00c752fcd138ba0065cefee">read_translator</a> : &amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;<a class="code" href="structast__channel__spy__list.html#7ba60a6f45d9737e1eb2978f6de8f22b">write_translator</a>;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list) {
<a name="l01481"></a>01481       <span class="keyword">struct </span><a class="code" href="structast__channel__spy__queue.html">ast_channel_spy_queue</a> *queue;
<a name="l01482"></a>01482       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *duped_fr;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01485"></a>01485 
<a name="l01486"></a>01486       queue = (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>) ? &amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a> : &amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>;
<a name="l01487"></a>01487 
<a name="l01488"></a>01488       if ((queue-&gt;<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> == <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l01489"></a>01489          <span class="keywordflow">if</span> (!translated_frame) {
<a name="l01490"></a>01490             <span class="keywordflow">if</span> (trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a> &amp;&amp; (trans-&gt;<a class="code" href="structchannel__spy__trans.html#71a38f4cd0dc1438c6d9c308d49be0c1">last_format</a> != f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>)) {
<a name="l01491"></a>01491                <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>);
<a name="l01492"></a>01492                trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a> = NULL;
<a name="l01493"></a>01493             }
<a name="l01494"></a>01494             <span class="keywordflow">if</span> (!trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>) {
<a name="l01495"></a>01495                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01496"></a>01496                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Building translator from %s to SLINEAR for spies on channel %s\n"</span>,
<a name="l01497"></a>01497                      <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>), chan-&gt;name);
<a name="l01498"></a>01498                <span class="keywordflow">if</span> ((trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a> = <a class="code" href="translate_8c.html#46306313154b293cae4c398153ef6f75">ast_translator_build_path</a>(<a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>)) == NULL) {
<a name="l01499"></a>01499                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot build a path from %s to %s\n"</span>,
<a name="l01500"></a>01500                      <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>), <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(<a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>));
<a name="l01501"></a>01501                   <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01502"></a>01502                   <span class="keywordflow">continue</span>;
<a name="l01503"></a>01503                } <span class="keywordflow">else</span> {
<a name="l01504"></a>01504                   trans-&gt;<a class="code" href="structchannel__spy__trans.html#71a38f4cd0dc1438c6d9c308d49be0c1">last_format</a> = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l01505"></a>01505                }
<a name="l01506"></a>01506             }
<a name="l01507"></a>01507             <span class="keywordflow">if</span> (!(translated_frame = <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(trans-&gt;<a class="code" href="structchannel__spy__trans.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>, f, 0))) {
<a name="l01508"></a>01508                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Translation to %s failed, dropping frame for spies\n"</span>,
<a name="l01509"></a>01509                   <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(<a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>));
<a name="l01510"></a>01510                <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01511"></a>01511                <span class="keywordflow">break</span>;
<a name="l01512"></a>01512             }
<a name="l01513"></a>01513          }
<a name="l01514"></a>01514          duped_fr = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(translated_frame);
<a name="l01515"></a>01515       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != queue-&gt;<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>) {
<a name="l01516"></a>01516          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Spy '%s' on channel '%s' wants format '%s', but frame is '%s', dropping\n"</span>,
<a name="l01517"></a>01517             spy-&gt;<a class="code" href="structast__channel__spy.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, chan-&gt;name,
<a name="l01518"></a>01518             <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(queue-&gt;<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>), <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>));
<a name="l01519"></a>01519          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01520"></a>01520          <span class="keywordflow">continue</span>;
<a name="l01521"></a>01521       } <span class="keywordflow">else</span>
<a name="l01522"></a>01522          duped_fr = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(f);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524       <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;queue-&gt;list, duped_fr, frame_list);
<a name="l01525"></a>01525 
<a name="l01526"></a>01526       queue-&gt;<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> += f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l01527"></a>01527 
<a name="l01528"></a>01528       <span class="keywordflow">if</span> (queue-&gt;<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> &gt; <a class="code" href="channel_8c.html#1436783f10d73e546c3be8d77072760c">SPY_QUEUE_SAMPLE_LIMIT</a>) {
<a name="l01529"></a>01529          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>) != <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65eea652b43493a4b39fb3895177943685">CHANSPY_TRIGGER_NONE</a>) {
<a name="l01530"></a>01530             <span class="keywordflow">switch</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>)) {
<a name="l01531"></a>01531             <span class="keywordflow">case</span> <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce657ac2f35629f6a422837ce4fc6eed040a">CHANSPY_TRIGGER_READ</a>:
<a name="l01532"></a>01532                <span class="keywordflow">if</span> (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886e3b4d6702d1998b494bbab2603e96bcc">SPY_WRITE</a>) {
<a name="l01533"></a>01533                   <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65419ab3aa5960e1f296e9f4ab481a0741">CHANSPY_TRIGGER_WRITE</a>);
<a name="l01534"></a>01534                   <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce657ac2f35629f6a422837ce4fc6eed040a">CHANSPY_TRIGGER_READ</a>);
<a name="l01535"></a>01535                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01536"></a>01536                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Switching spy '%s' on '%s' to write-trigger mode\n"</span>,
<a name="l01537"></a>01537                         spy-&gt;type, chan-&gt;name);
<a name="l01538"></a>01538                }
<a name="l01539"></a>01539                <span class="keywordflow">break</span>;
<a name="l01540"></a>01540             <span class="keywordflow">case</span> <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65419ab3aa5960e1f296e9f4ab481a0741">CHANSPY_TRIGGER_WRITE</a>:
<a name="l01541"></a>01541                <span class="keywordflow">if</span> (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>) {
<a name="l01542"></a>01542                   <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce657ac2f35629f6a422837ce4fc6eed040a">CHANSPY_TRIGGER_READ</a>);
<a name="l01543"></a>01543                   <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65419ab3aa5960e1f296e9f4ab481a0741">CHANSPY_TRIGGER_WRITE</a>);
<a name="l01544"></a>01544                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01545"></a>01545                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Switching spy '%s' on '%s' to read-trigger mode\n"</span>,
<a name="l01546"></a>01546                         spy-&gt;type, chan-&gt;name);
<a name="l01547"></a>01547                }
<a name="l01548"></a>01548                <span class="keywordflow">break</span>;
<a name="l01549"></a>01549             }
<a name="l01550"></a>01550             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01551"></a>01551                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Triggering queue flush for spy '%s' on '%s'\n"</span>,
<a name="l01552"></a>01552                   spy-&gt;type, chan-&gt;name);
<a name="l01553"></a>01553             <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce6560bd57b07eeb3eb997c1a0fb15e2cdf1">CHANSPY_TRIGGER_FLUSH</a>);
<a name="l01554"></a>01554             <a class="code" href="lock_8h.html#119b205a84b106ec84a3a496dbe88082">ast_cond_signal</a>(&amp;spy-&gt;trigger);
<a name="l01555"></a>01555          } <span class="keywordflow">else</span> {
<a name="l01556"></a>01556             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01557"></a>01557                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Spy '%s' on channel '%s' %s queue too long, dropping frames\n"</span>,
<a name="l01558"></a>01558                   spy-&gt;type, chan-&gt;name, (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>) ? <span class="stringliteral">"read"</span> : <span class="stringliteral">"write"</span>);
<a name="l01559"></a>01559             <span class="keywordflow">while</span> (queue-&gt;<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> &gt; <a class="code" href="channel_8c.html#1436783f10d73e546c3be8d77072760c">SPY_QUEUE_SAMPLE_LIMIT</a>) {
<a name="l01560"></a>01560                <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *drop = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;queue-&gt;list, frame_list);
<a name="l01561"></a>01561                queue-&gt;<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> -= drop-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l01562"></a>01562                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(drop);
<a name="l01563"></a>01563             }
<a name="l01564"></a>01564          }
<a name="l01565"></a>01565       } <span class="keywordflow">else</span> {
<a name="l01566"></a>01566          <span class="keywordflow">switch</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65ea04baee2d87b4e411e069984bbea6d2">CHANSPY_TRIGGER_MODE</a>)) {
<a name="l01567"></a>01567          <span class="keywordflow">case</span> <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce657ac2f35629f6a422837ce4fc6eed040a">CHANSPY_TRIGGER_READ</a>:
<a name="l01568"></a>01568             <span class="keywordflow">if</span> (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>)
<a name="l01569"></a>01569                <a class="code" href="lock_8h.html#119b205a84b106ec84a3a496dbe88082">ast_cond_signal</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>);
<a name="l01570"></a>01570             <span class="keywordflow">break</span>;
<a name="l01571"></a>01571          <span class="keywordflow">case</span> <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65419ab3aa5960e1f296e9f4ab481a0741">CHANSPY_TRIGGER_WRITE</a>:
<a name="l01572"></a>01572             <span class="keywordflow">if</span> (dir == <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886e3b4d6702d1998b494bbab2603e96bcc">SPY_WRITE</a>)
<a name="l01573"></a>01573                <a class="code" href="lock_8h.html#119b205a84b106ec84a3a496dbe88082">ast_cond_signal</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#c7d08e09a44d2b453e7eeecebf0a8daf">trigger</a>);
<a name="l01574"></a>01574             <span class="keywordflow">break</span>;
<a name="l01575"></a>01575          }
<a name="l01576"></a>01576       }
<a name="l01577"></a>01577 
<a name="l01578"></a>01578       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01579"></a>01579    }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581    <span class="keywordflow">if</span> (translated_frame)
<a name="l01582"></a>01582       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(translated_frame);
<a name="l01583"></a>01583 }
<a name="l01584"></a>01584 
<a name="l01585"></a><a class="code" href="channel_8c.html#58f25e1132c752853fc0e73a67964c37">01585</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#58f25e1132c752853fc0e73a67964c37">free_translation</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *clone)
<a name="l01586"></a>01586 {
<a name="l01587"></a>01587    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>)
<a name="l01588"></a>01588       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(clone-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>);
<a name="l01589"></a>01589    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>)
<a name="l01590"></a>01590       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(clone-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>);
<a name="l01591"></a>01591    clone-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a> = NULL;
<a name="l01592"></a>01592    clone-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a> = NULL;
<a name="l01593"></a>01593    clone-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a> = clone-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l01594"></a>01594    clone-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a> = clone-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 <span class="comment"></span>
<a name="l01597"></a>01597 <span class="comment">/*! \brief Hangup a channel */</span>
<a name="l01598"></a><a class="code" href="channel_8h.html#ff55e854df5692f9b3b8dc64c95a5619">01598</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01599"></a>01599 {
<a name="l01600"></a>01600    <span class="keywordtype">int</span> res = 0;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602    <span class="comment">/* Don't actually hang up a channel that will masquerade as someone else, or</span>
<a name="l01603"></a>01603 <span class="comment">      if someone is going to masquerade as us */</span>
<a name="l01604"></a>01604    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01605"></a>01605 
<a name="l01606"></a>01606    <a class="code" href="channel_8c.html#f40ac2c82018d2d1726231f39a54f380">detach_spies</a>(chan);     <span class="comment">/* get rid of spies */</span>
<a name="l01607"></a>01607 
<a name="l01608"></a>01608    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>) {
<a name="l01609"></a>01609       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(chan))
<a name="l01610"></a>01610          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform masquerade\n"</span>);
<a name="l01611"></a>01611    }
<a name="l01612"></a>01612 
<a name="l01613"></a>01613    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>) {
<a name="l01614"></a>01614       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s getting hung up, but someone is trying to masq into us?!?\n"</span>, chan-&gt;name);
<a name="l01615"></a>01615       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01616"></a>01616       <span class="keywordflow">return</span> 0;
<a name="l01617"></a>01617    }
<a name="l01618"></a>01618    <span class="comment">/* If this channel is one which will be masqueraded into something,</span>
<a name="l01619"></a>01619 <span class="comment">      mark it as a zombie already, so we know to free it later */</span>
<a name="l01620"></a>01620    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a>) {
<a name="l01621"></a>01621       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>);
<a name="l01622"></a>01622       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01623"></a>01623       <span class="keywordflow">return</span> 0;
<a name="l01624"></a>01624    }
<a name="l01625"></a>01625    <a class="code" href="channel_8c.html#58f25e1132c752853fc0e73a67964c37">free_translation</a>(chan);
<a name="l01626"></a>01626    <span class="comment">/* Close audio stream */</span>
<a name="l01627"></a>01627    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>) {
<a name="l01628"></a>01628       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>);
<a name="l01629"></a>01629       chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a> = NULL;
<a name="l01630"></a>01630    }
<a name="l01631"></a>01631    <span class="comment">/* Close video stream */</span>
<a name="l01632"></a>01632    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>) {
<a name="l01633"></a>01633       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>);
<a name="l01634"></a>01634       chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a> = NULL;
<a name="l01635"></a>01635    }
<a name="l01636"></a>01636    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>) {
<a name="l01637"></a>01637       <a class="code" href="sched_8c.html#89e2eb9653fa462ad4ff62e05ad36050">sched_context_destroy</a>(chan-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>);
<a name="l01638"></a>01638       chan-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a> = NULL;
<a name="l01639"></a>01639    }
<a name="l01640"></a>01640    
<a name="l01641"></a>01641    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>)   <span class="comment">/* Clear any tone stuff remaining */</span>
<a name="l01642"></a>01642       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>)
<a name="l01643"></a>01643          chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>);
<a name="l01644"></a>01644    chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;
<a name="l01645"></a>01645    chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> = NULL;
<a name="l01646"></a>01646    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {     <span class="comment">/* End the CDR if it hasn't already */</span>
<a name="l01647"></a>01647       <a class="code" href="cdr_8c.html#545d0bb7a87e9317b6eb3ce2245145cc">ast_cdr_end</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01648"></a>01648       <a class="code" href="cdr_8c.html#b20947a5170d08a12a3cee0498e07614">ast_cdr_detach</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>); <span class="comment">/* Post and Free the CDR */</span>
<a name="l01649"></a>01649       chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = NULL;
<a name="l01650"></a>01650    }
<a name="l01651"></a>01651    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>)) {
<a name="l01652"></a>01652       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Hard hangup called by thread %ld on %s, while fd "</span>
<a name="l01653"></a>01653                <span class="stringliteral">"is blocked by thread %ld in procedure %s!  Expect a failure\n"</span>,
<a name="l01654"></a>01654                (<span class="keywordtype">long</span>)pthread_self(), chan-&gt;name, (<span class="keywordtype">long</span>)chan-&gt;<a class="code" href="structast__channel.html#a38ba46bb4909bc27602645297913d86">blocker</a>, chan-&gt;<a class="code" href="structast__channel.html#0c1ba8c20fea058c120da59f7730055e">blockproc</a>);
<a name="l01655"></a>01655       <a class="code" href="channel_8h.html#cef2f26f7da88da7db20faa12bd436c4">CRASH</a>;
<a name="l01656"></a>01656    }
<a name="l01657"></a>01657    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>)) {
<a name="l01658"></a>01658       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01659"></a>01659          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Hanging up channel '%s'\n"</span>, chan-&gt;name);
<a name="l01660"></a>01660       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#453321d0ff441f44936f3ce5e7c059d6">hangup</a>)
<a name="l01661"></a>01661          res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#453321d0ff441f44936f3ce5e7c059d6">hangup</a>(chan);
<a name="l01662"></a>01662    } <span class="keywordflow">else</span> {
<a name="l01663"></a>01663       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01664"></a>01664          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Hanging up zombie '%s'\n"</span>, chan-&gt;name);
<a name="l01665"></a>01665    }
<a name="l01666"></a>01666          
<a name="l01667"></a>01667    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01668"></a>01668    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Hangup"</span>,
<a name="l01669"></a>01669          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l01670"></a>01670          <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l01671"></a>01671          <span class="stringliteral">"Cause: %d\r\n"</span>
<a name="l01672"></a>01672          <span class="stringliteral">"Cause-txt: %s\r\n"</span>,
<a name="l01673"></a>01673          chan-&gt;name,
<a name="l01674"></a>01674          chan-&gt;uniqueid,
<a name="l01675"></a>01675          chan-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>,
<a name="l01676"></a>01676          <a class="code" href="channel_8c.html#817c0e10b26cbcb773516bb6583fb694">ast_cause2str</a>(chan-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>)
<a name="l01677"></a>01677          );
<a name="l01678"></a>01678    <a class="code" href="channel_8c.html#230a804b09060fecdf699c2c9613fff7">ast_channel_free</a>(chan);
<a name="l01679"></a>01679    <span class="keywordflow">return</span> res;
<a name="l01680"></a>01680 }
<a name="l01681"></a>01681 
<a name="l01682"></a><a class="code" href="channel_8h.html#71deef3d79d1ff4755afdf2b2cfffdda">01682</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#71deef3d79d1ff4755afdf2b2cfffdda">__ast_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> delay)
<a name="l01683"></a>01683 {
<a name="l01684"></a>01684    <span class="keywordtype">int</span> res = 0;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688    <span class="comment">/* You can't answer an outbound call */</span>
<a name="l01689"></a>01689    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73007a1bed17a368c12201a64ef3122bf6f6">AST_FLAG_OUTGOING</a>)) {
<a name="l01690"></a>01690       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01691"></a>01691       <span class="keywordflow">return</span> 0;
<a name="l01692"></a>01692    }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l01695"></a>01695    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l01696"></a>01696       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01697"></a>01697       <span class="keywordflow">return</span> -1;
<a name="l01698"></a>01698    }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700    <span class="keywordflow">switch</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>) {
<a name="l01701"></a>01701    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a85da5b3ea10583d638bc7ce8fe638ec2">AST_STATE_RINGING</a>:
<a name="l01702"></a>01702    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a0789c8ad2fe8eda2081eb587a0bfbe42">AST_STATE_RING</a>:
<a name="l01703"></a>01703       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#bf8caf3c591a413499e37b01bdcf07fa">answer</a>)
<a name="l01704"></a>01704          res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#bf8caf3c591a413499e37b01bdcf07fa">answer</a>(chan);
<a name="l01705"></a>01705       <a class="code" href="channel_8c.html#c3e562760bdf7c23ebd561ce1352399e">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>);
<a name="l01706"></a>01706       <a class="code" href="cdr_8c.html#aa59616c49400bc9f58095b2b3f73781">ast_cdr_answer</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01707"></a>01707       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01708"></a>01708       <span class="keywordflow">if</span> (delay)
<a name="l01709"></a>01709          <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(chan, delay);
<a name="l01710"></a>01710       <span class="keywordflow">return</span> res;
<a name="l01711"></a>01711       <span class="keywordflow">break</span>;
<a name="l01712"></a>01712    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>:
<a name="l01713"></a>01713       <a class="code" href="cdr_8c.html#aa59616c49400bc9f58095b2b3f73781">ast_cdr_answer</a>(chan-&gt;cdr);
<a name="l01714"></a>01714       <span class="keywordflow">break</span>;
<a name="l01715"></a>01715    <span class="keywordflow">default</span>:
<a name="l01716"></a>01716       <span class="keywordflow">break</span>;
<a name="l01717"></a>01717    }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01720"></a>01720 
<a name="l01721"></a>01721    <span class="keywordflow">return</span> res;
<a name="l01722"></a>01722 }
<a name="l01723"></a>01723 
<a name="l01724"></a><a class="code" href="channel_8h.html#9e089c979b071a1df466a09497fdfa31">01724</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01725"></a>01725 {
<a name="l01726"></a>01726    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#71deef3d79d1ff4755afdf2b2cfffdda">__ast_answer</a>(chan, 500);
<a name="l01727"></a>01727 }
<a name="l01728"></a>01728 
<a name="l01729"></a><a class="code" href="channel_8h.html#e4e0e5c1767576b38fb1a893dfd8cb2b">01729</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l01730"></a>01730 {
<a name="l01731"></a>01731    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01732"></a>01732    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>) {
<a name="l01733"></a>01733       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>)
<a name="l01734"></a>01734          chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>);
<a name="l01735"></a>01735       chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;
<a name="l01736"></a>01736       chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> = NULL;
<a name="l01737"></a>01737       chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[<a class="code" href="channel_8h.html#eba2b7656ee8c07b3f916e990b567b02">AST_GENERATOR_FD</a>] = -1;
<a name="l01738"></a>01738       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730015fb5a488ff560040b677433b270fb5e">AST_FLAG_WRITE_INT</a>);
<a name="l01739"></a>01739       <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(chan, 0, NULL, NULL);
<a name="l01740"></a>01740    }
<a name="l01741"></a>01741    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01742"></a>01742 }
<a name="l01743"></a>01743 
<a name="l01744"></a><a class="code" href="channel_8c.html#e4622c5b41999a7ddad23f05242dca4d">01744</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#e4622c5b41999a7ddad23f05242dca4d">generator_force</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l01745"></a>01745 {
<a name="l01746"></a>01746    <span class="comment">/* Called if generator doesn't have data */</span>
<a name="l01747"></a>01747    <span class="keywordtype">void</span> *tmp;
<a name="l01748"></a>01748    <span class="keywordtype">int</span> res;
<a name="l01749"></a>01749    int (*generate)(<span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *tmp, <span class="keywordtype">int</span> datalen, <span class="keywordtype">int</span> samples);
<a name="l01750"></a>01750    <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan = data;
<a name="l01751"></a>01751    tmp = chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>;
<a name="l01752"></a>01752    chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;
<a name="l01753"></a>01753    generate = chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#359c44da76fd570826dcd60f0f6da36c">generate</a>;
<a name="l01754"></a>01754    res = generate(chan, tmp, 0, 160);
<a name="l01755"></a>01755    chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = tmp;
<a name="l01756"></a>01756    <span class="keywordflow">if</span> (res) {
<a name="l01757"></a>01757       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01758"></a>01758          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Auto-deactivating generator\n"</span>);
<a name="l01759"></a>01759       <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l01760"></a>01760    }
<a name="l01761"></a>01761    <span class="keywordflow">return</span> 0;
<a name="l01762"></a>01762 }
<a name="l01763"></a>01763 
<a name="l01764"></a><a class="code" href="channel_8h.html#51350b9fba7a6a2428e1b3a13a131d54">01764</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#51350b9fba7a6a2428e1b3a13a131d54">ast_activate_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__generator.html">ast_generator</a> *<a class="code" href="app__externalivr_8c.html#daffed346e29c5654f54133d1fc65ccb">gen</a>, <span class="keywordtype">void</span> *params)
<a name="l01765"></a>01765 {
<a name="l01766"></a>01766    <span class="keywordtype">int</span> res = 0;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>) {
<a name="l01771"></a>01771       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>)
<a name="l01772"></a>01772          chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>);
<a name="l01773"></a>01773       chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;
<a name="l01774"></a>01774    }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776    <a class="code" href="channel_8c.html#1e5a4ef714eb64bfdc55813ba363bd67">ast_prod</a>(chan);
<a name="l01777"></a>01777    <span class="keywordflow">if</span> (gen-&gt;<a class="code" href="structast__generator.html#ec716dadc257b3894e8a1a75177d4283">alloc</a> &amp;&amp; !(chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = gen-&gt;<a class="code" href="structast__generator.html#ec716dadc257b3894e8a1a75177d4283">alloc</a>(chan, params))) {
<a name="l01778"></a>01778       res = -1;
<a name="l01779"></a>01779    }
<a name="l01780"></a>01780    
<a name="l01781"></a>01781    <span class="keywordflow">if</span> (!res) {
<a name="l01782"></a>01782       <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(chan, 160, <a class="code" href="channel_8c.html#e4622c5b41999a7ddad23f05242dca4d">generator_force</a>, chan);
<a name="l01783"></a>01783       chan-&gt;generator = gen;
<a name="l01784"></a>01784    }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01787"></a>01787 
<a name="l01788"></a>01788    <span class="keywordflow">return</span> res;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 <span class="comment"></span>
<a name="l01791"></a>01791 <span class="comment">/*! \brief Wait for x amount of time on a file descriptor to have input.  */</span>
<a name="l01792"></a><a class="code" href="channel_8h.html#7bda1d2f937087ca98166e5463740b64">01792</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#7bda1d2f937087ca98166e5463740b64">ast_waitfor_n_fd</a>(<span class="keywordtype">int</span> *<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> *ms, <span class="keywordtype">int</span> *exception)
<a name="l01793"></a>01793 {
<a name="l01794"></a>01794    <span class="keywordtype">int</span> winner = -1;
<a name="l01795"></a>01795    <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(NULL, 0, fds, n, exception, &amp;winner, ms);
<a name="l01796"></a>01796    <span class="keywordflow">return</span> winner;
<a name="l01797"></a>01797 }
<a name="l01798"></a>01798 <span class="comment"></span>
<a name="l01799"></a>01799 <span class="comment">/*! \brief Wait for x amount of time on a file descriptor to have input.  */</span>
<a name="l01800"></a><a class="code" href="channel_8h.html#2efb5d945c0350d0fa3abe4f1838d3c3">01800</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **c, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> *<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>, <span class="keywordtype">int</span> nfds,
<a name="l01801"></a>01801    <span class="keywordtype">int</span> *exception, <span class="keywordtype">int</span> *outfd, <span class="keywordtype">int</span> *ms)
<a name="l01802"></a>01802 {
<a name="l01803"></a>01803    <span class="keyword">struct </span>timeval start = { 0 , 0 };
<a name="l01804"></a>01804    <span class="keyword">struct </span><a class="code" href="structpollfd.html">pollfd</a> *pfds;
<a name="l01805"></a>01805    <span class="keywordtype">int</span> res;
<a name="l01806"></a>01806    <span class="keywordtype">long</span> rms;
<a name="l01807"></a>01807    <span class="keywordtype">int</span> x, y, max;
<a name="l01808"></a>01808    <span class="keywordtype">int</span> sz;
<a name="l01809"></a>01809    time_t now = 0;
<a name="l01810"></a>01810    <span class="keywordtype">long</span> whentohangup = 0, diff;
<a name="l01811"></a>01811    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *winner = NULL;
<a name="l01812"></a>01812    <span class="keyword">struct </span>fdmap {
<a name="l01813"></a>01813       <span class="keywordtype">int</span> chan;
<a name="l01814"></a>01814       <span class="keywordtype">int</span> fdno;
<a name="l01815"></a>01815    } *fdmap;
<a name="l01816"></a>01816 
<a name="l01817"></a>01817    sz = n * <a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a> + nfds;
<a name="l01818"></a>01818    pfds = alloca(<span class="keyword">sizeof</span>(*pfds) * sz);
<a name="l01819"></a>01819    fdmap = alloca(<span class="keyword">sizeof</span>(*fdmap) * sz);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821    <span class="keywordflow">if</span> (outfd)
<a name="l01822"></a>01822       *outfd = -99999;
<a name="l01823"></a>01823    <span class="keywordflow">if</span> (exception)
<a name="l01824"></a>01824       *exception = 0;
<a name="l01825"></a>01825    
<a name="l01826"></a>01826    <span class="comment">/* Perform any pending masquerades */</span>
<a name="l01827"></a>01827    <span class="keywordflow">for</span> (x=0; x &lt; n; x++) {
<a name="l01828"></a>01828       <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(c[x]);
<a name="l01829"></a>01829       <span class="keywordflow">if</span> (c[x]-&gt;masq) {
<a name="l01830"></a>01830          <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(c[x])) {
<a name="l01831"></a>01831             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Masquerade failed\n"</span>);
<a name="l01832"></a>01832             *ms = -1;
<a name="l01833"></a>01833             <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c[x]);
<a name="l01834"></a>01834             <span class="keywordflow">return</span> NULL;
<a name="l01835"></a>01835          }
<a name="l01836"></a>01836       }
<a name="l01837"></a>01837       <span class="keywordflow">if</span> (c[x]-&gt;whentohangup) {
<a name="l01838"></a>01838          <span class="keywordflow">if</span> (!whentohangup)
<a name="l01839"></a>01839             time(&amp;now);
<a name="l01840"></a>01840          diff = c[x]-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> - now;
<a name="l01841"></a>01841          <span class="keywordflow">if</span> (diff &lt; 1) {
<a name="l01842"></a>01842             <span class="comment">/* Should already be hungup */</span>
<a name="l01843"></a>01843             c[x]-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a12709ffb7179ec4c9b3ba505519ddc84e">AST_SOFTHANGUP_TIMEOUT</a>;
<a name="l01844"></a>01844             <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c[x]);
<a name="l01845"></a>01845             <span class="keywordflow">return</span> c[x];
<a name="l01846"></a>01846          }
<a name="l01847"></a>01847          <span class="keywordflow">if</span> (!whentohangup || (diff &lt; whentohangup))
<a name="l01848"></a>01848             whentohangup = diff;
<a name="l01849"></a>01849       }
<a name="l01850"></a>01850       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c[x]);
<a name="l01851"></a>01851    }
<a name="l01852"></a>01852    <span class="comment">/* Wait full interval */</span>
<a name="l01853"></a>01853    rms = *ms;
<a name="l01854"></a>01854    <span class="keywordflow">if</span> (whentohangup) {
<a name="l01855"></a>01855       rms = whentohangup * 1000;              <span class="comment">/* timeout in milliseconds */</span>
<a name="l01856"></a>01856       <span class="keywordflow">if</span> (*ms &gt;= 0 &amp;&amp; *ms &lt; rms)    <span class="comment">/* original *ms still smaller */</span>
<a name="l01857"></a>01857          rms =  *ms;
<a name="l01858"></a>01858    }
<a name="l01859"></a>01859    <span class="comment">/*</span>
<a name="l01860"></a>01860 <span class="comment">    * Build the pollfd array, putting the channels' fds first,</span>
<a name="l01861"></a>01861 <span class="comment">    * followed by individual fds. Order is important because</span>
<a name="l01862"></a>01862 <span class="comment">    * individual fd's must have priority over channel fds.</span>
<a name="l01863"></a>01863 <span class="comment">    */</span>
<a name="l01864"></a>01864    max = 0;
<a name="l01865"></a>01865    <span class="keywordflow">for</span> (x=0; x&lt;n; x++) {
<a name="l01866"></a>01866       <span class="keywordflow">for</span> (y=0; y&lt;<a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a>; y++) {
<a name="l01867"></a>01867          fdmap[max].fdno = y;  <span class="comment">/* fd y is linked to this pfds */</span>
<a name="l01868"></a>01868          fdmap[max].chan = x;  <span class="comment">/* channel x is linked to this pfds */</span>
<a name="l01869"></a>01869          max += <a class="code" href="channel_8h.html#ac55a99c346024715138883ba689718c">ast_add_fd</a>(&amp;pfds[max], c[x]-&gt;fds[y]);
<a name="l01870"></a>01870       }
<a name="l01871"></a>01871       <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(c[x]);
<a name="l01872"></a>01872    }
<a name="l01873"></a>01873    <span class="comment">/* Add the individual fds */</span>
<a name="l01874"></a>01874    <span class="keywordflow">for</span> (x=0; x&lt;nfds; x++) {
<a name="l01875"></a>01875       fdmap[max].chan = -1;
<a name="l01876"></a>01876       max += <a class="code" href="channel_8h.html#ac55a99c346024715138883ba689718c">ast_add_fd</a>(&amp;pfds[max], fds[x]);
<a name="l01877"></a>01877    }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879    <span class="keywordflow">if</span> (*ms &gt; 0)
<a name="l01880"></a>01880       start = ast_tvnow();
<a name="l01881"></a>01881    
<a name="l01882"></a>01882    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) == 4) { <span class="comment">/* XXX fix timeout &gt; 600000 on linux x86-32 */</span>
<a name="l01883"></a>01883       <span class="keywordflow">do</span> {
<a name="l01884"></a>01884          <span class="keywordtype">int</span> kbrms = rms;
<a name="l01885"></a>01885          <span class="keywordflow">if</span> (kbrms &gt; 600000)
<a name="l01886"></a>01886             kbrms = 600000;
<a name="l01887"></a>01887          res = <a class="code" href="poll_8c.html#490c34aebc91a7dfe2524a13104fd13e">poll</a>(pfds, max, kbrms);
<a name="l01888"></a>01888          <span class="keywordflow">if</span> (!res)
<a name="l01889"></a>01889             rms -= kbrms;
<a name="l01890"></a>01890       } <span class="keywordflow">while</span> (!res &amp;&amp; (rms &gt; 0));
<a name="l01891"></a>01891    } <span class="keywordflow">else</span> {
<a name="l01892"></a>01892       res = <a class="code" href="poll_8c.html#490c34aebc91a7dfe2524a13104fd13e">poll</a>(pfds, max, rms);
<a name="l01893"></a>01893    }
<a name="l01894"></a>01894    <span class="keywordflow">for</span> (x=0; x&lt;n; x++)
<a name="l01895"></a>01895       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c[x], <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l01896"></a>01896    <span class="keywordflow">if</span> (res &lt; 0) { <span class="comment">/* Simulate a timeout if we were interrupted */</span>
<a name="l01897"></a>01897       <span class="keywordflow">if</span> (errno != EINTR)
<a name="l01898"></a>01898          *ms = -1;
<a name="l01899"></a>01899       <span class="keywordflow">return</span> NULL;
<a name="l01900"></a>01900    }
<a name="l01901"></a>01901    <span class="keywordflow">if</span> (whentohangup) {   <span class="comment">/* if we have a timeout, check who expired */</span>
<a name="l01902"></a>01902       time(&amp;now);
<a name="l01903"></a>01903       <span class="keywordflow">for</span> (x=0; x&lt;n; x++) {
<a name="l01904"></a>01904          <span class="keywordflow">if</span> (c[x]-&gt;whentohangup &amp;&amp; now &gt;= c[x]-&gt;whentohangup) {
<a name="l01905"></a>01905             c[x]-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a12709ffb7179ec4c9b3ba505519ddc84e">AST_SOFTHANGUP_TIMEOUT</a>;
<a name="l01906"></a>01906             <span class="keywordflow">if</span> (winner == NULL)
<a name="l01907"></a>01907                winner = c[x];
<a name="l01908"></a>01908          }
<a name="l01909"></a>01909       }
<a name="l01910"></a>01910    }
<a name="l01911"></a>01911    <span class="keywordflow">if</span> (res == 0) { <span class="comment">/* no fd ready, reset timeout and done */</span>
<a name="l01912"></a>01912       *ms = 0; <span class="comment">/* XXX use 0 since we may not have an exact timeout. */</span>
<a name="l01913"></a>01913       <span class="keywordflow">return</span> winner;
<a name="l01914"></a>01914    }
<a name="l01915"></a>01915    <span class="comment">/*</span>
<a name="l01916"></a>01916 <span class="comment">    * Then check if any channel or fd has a pending event.</span>
<a name="l01917"></a>01917 <span class="comment">    * Remember to check channels first and fds last, as they</span>
<a name="l01918"></a>01918 <span class="comment">    * must have priority on setting 'winner'</span>
<a name="l01919"></a>01919 <span class="comment">    */</span>
<a name="l01920"></a>01920    <span class="keywordflow">for</span> (x = 0; x &lt; max; x++) {
<a name="l01921"></a>01921       res = pfds[x].revents;
<a name="l01922"></a>01922       <span class="keywordflow">if</span> (res == 0)
<a name="l01923"></a>01923          <span class="keywordflow">continue</span>;
<a name="l01924"></a>01924       <span class="keywordflow">if</span> (fdmap[x].chan &gt;= 0) {  <span class="comment">/* this is a channel */</span>
<a name="l01925"></a>01925          winner = c[fdmap[x].chan]; <span class="comment">/* override previous winners */</span>
<a name="l01926"></a>01926          <span class="keywordflow">if</span> (res &amp; <a class="code" href="poll-compat_8h.html#eb4a8029b132eaf617bfae72e35f8595">POLLPRI</a>)
<a name="l01927"></a>01927             <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(winner, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l01928"></a>01928          <span class="keywordflow">else</span>
<a name="l01929"></a>01929             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(winner, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l01930"></a>01930          winner-&gt;fdno = fdmap[x].fdno;
<a name="l01931"></a>01931       } <span class="keywordflow">else</span> {       <span class="comment">/* this is an fd */</span>
<a name="l01932"></a>01932          <span class="keywordflow">if</span> (outfd)
<a name="l01933"></a>01933             *outfd = pfds[x].fd;
<a name="l01934"></a>01934          <span class="keywordflow">if</span> (exception)
<a name="l01935"></a>01935             *exception = (res &amp; <a class="code" href="poll-compat_8h.html#eb4a8029b132eaf617bfae72e35f8595">POLLPRI</a>) ? -1 : 0;
<a name="l01936"></a>01936          winner = NULL;
<a name="l01937"></a>01937       }
<a name="l01938"></a>01938    }
<a name="l01939"></a>01939    <span class="keywordflow">if</span> (*ms &gt; 0) {
<a name="l01940"></a>01940       *ms -= ast_tvdiff_ms(ast_tvnow(), start);
<a name="l01941"></a>01941       <span class="keywordflow">if</span> (*ms &lt; 0)
<a name="l01942"></a>01942          *ms = 0;
<a name="l01943"></a>01943    }
<a name="l01944"></a>01944    <span class="keywordflow">return</span> winner;
<a name="l01945"></a>01945 }
<a name="l01946"></a>01946 
<a name="l01947"></a><a class="code" href="channel_8h.html#9233eec93dd9d3660844802b767036b7">01947</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#96a31a1429603c4049e5ef10d7ce2470">ast_waitfor_n</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **c, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> *ms)
<a name="l01948"></a>01948 {
<a name="l01949"></a>01949    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(c, n, NULL, 0, NULL, NULL, ms);
<a name="l01950"></a>01950 }
<a name="l01951"></a>01951 
<a name="l01952"></a><a class="code" href="channel_8h.html#cad81a17a0fa70c35b08e0c9b40f1877">01952</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">int</span> ms)
<a name="l01953"></a>01953 {
<a name="l01954"></a>01954    <span class="keywordtype">int</span> oldms = ms;   <span class="comment">/* -1 if no timeout */</span>
<a name="l01955"></a>01955 
<a name="l01956"></a>01956    <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(&amp;c, 1, NULL, 0, NULL, NULL, &amp;ms);
<a name="l01957"></a>01957    <span class="keywordflow">if</span> ((ms &lt; 0) &amp;&amp; (oldms &lt; 0))
<a name="l01958"></a>01958       ms = 0;
<a name="l01959"></a>01959    <span class="keywordflow">return</span> ms;
<a name="l01960"></a>01960 }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962 <span class="comment">/* XXX never to be called with ms = -1 */</span>
<a name="l01963"></a><a class="code" href="channel_8h.html#b02063e7425e3cfb63ba24edf8081835">01963</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#b02063e7425e3cfb63ba24edf8081835">ast_waitfordigit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">int</span> ms)
<a name="l01964"></a>01964 {
<a name="l01965"></a>01965    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(c, ms, -1, -1);
<a name="l01966"></a>01966 }
<a name="l01967"></a>01967 
<a name="l01968"></a><a class="code" href="channel_8h.html#031ef8a01f979ba2f40451d97a515e80">01968</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">int</span> samples, <span class="keywordtype">int</span> (*<a class="code" href="manager_8h.html#7df4935f4a5a2865191ef74f64df8754">func</a>)(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>), <span class="keywordtype">void</span> *data)
<a name="l01969"></a>01969 {
<a name="l01970"></a>01970    <span class="keywordtype">int</span> res = -1;
<a name="l01971"></a>01971 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l01972"></a>01972 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1) {
<a name="l01973"></a>01973       <span class="keywordflow">if</span> (!func) {
<a name="l01974"></a>01974          samples = 0;
<a name="l01975"></a>01975          data = 0;
<a name="l01976"></a>01976       }
<a name="l01977"></a>01977       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01978"></a>01978          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Scheduling timer at %d sample intervals\n"</span>, samples);
<a name="l01979"></a>01979       res = ioctl(c-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_TIMERCONFIG, &amp;samples);
<a name="l01980"></a>01980       c-&gt;<a class="code" href="structast__channel.html#a576c60b7b1ab7e59be8ad75ecc55ef9">timingfunc</a> = func;
<a name="l01981"></a>01981       c-&gt;<a class="code" href="structast__channel.html#3de60c1425f97e3ddc8b149272742e6d">timingdata</a> = data;
<a name="l01982"></a>01982    }
<a name="l01983"></a>01983 <span class="preprocessor">#endif   </span>
<a name="l01984"></a>01984 <span class="preprocessor"></span>   <span class="keywordflow">return</span> res;
<a name="l01985"></a>01985 }
<a name="l01986"></a>01986 
<a name="l01987"></a><a class="code" href="channel_8h.html#37046471dc78265c045a341d785ae484">01987</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">int</span> ms, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> cmdfd)
<a name="l01988"></a>01988 {
<a name="l01989"></a>01989 
<a name="l01990"></a>01990    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l01991"></a>01991    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(c))
<a name="l01992"></a>01992       <span class="keywordflow">return</span> -1;
<a name="l01993"></a>01993    <span class="comment">/* Wait for a digit, no more than ms milliseconds total. */</span>
<a name="l01994"></a>01994    <span class="keywordflow">while</span> (ms) {
<a name="l01995"></a>01995       <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *rchan;
<a name="l01996"></a>01996       <span class="keywordtype">int</span> outfd;
<a name="l01997"></a>01997 
<a name="l01998"></a>01998       errno = 0;
<a name="l01999"></a>01999       rchan = <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(&amp;c, 1, &amp;cmdfd, (cmdfd &gt; -1) ? 1 : 0, NULL, &amp;outfd, &amp;ms);
<a name="l02000"></a>02000       <span class="keywordflow">if</span> (!rchan &amp;&amp; outfd &lt; 0 &amp;&amp; ms) {
<a name="l02001"></a>02001          <span class="keywordflow">if</span> (errno == 0 || errno == EINTR)
<a name="l02002"></a>02002             <span class="keywordflow">continue</span>;
<a name="l02003"></a>02003          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Wait failed (%s)\n"</span>, strerror(errno));
<a name="l02004"></a>02004          <span class="keywordflow">return</span> -1;
<a name="l02005"></a>02005       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) {
<a name="l02006"></a>02006          <span class="comment">/* The FD we were watching has something waiting */</span>
<a name="l02007"></a>02007          <span class="keywordflow">return</span> 1;
<a name="l02008"></a>02008       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rchan) {
<a name="l02009"></a>02009          <span class="keywordtype">int</span> res;
<a name="l02010"></a>02010          <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(c);
<a name="l02011"></a>02011          <span class="keywordflow">if</span> (!f)
<a name="l02012"></a>02012             <span class="keywordflow">return</span> -1;
<a name="l02013"></a>02013 
<a name="l02014"></a>02014          <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>) {
<a name="l02015"></a>02015          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#41e7a80287a24ece13159c2d8b1b9375">AST_FRAME_DTMF</a>:
<a name="l02016"></a>02016             res = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l02017"></a>02017             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02018"></a>02018             <span class="keywordflow">return</span> res;
<a name="l02019"></a>02019          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>:
<a name="l02020"></a>02020             <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l02021"></a>02021             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>:
<a name="l02022"></a>02022                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02023"></a>02023                <span class="keywordflow">return</span> -1;
<a name="l02024"></a>02024             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l02025"></a>02025             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l02026"></a>02026                <span class="comment">/* Unimportant */</span>
<a name="l02027"></a>02027                <span class="keywordflow">break</span>;
<a name="l02028"></a>02028             <span class="keywordflow">default</span>:
<a name="l02029"></a>02029                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unexpected control subclass '%d'\n"</span>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l02030"></a>02030                <span class="keywordflow">break</span>;
<a name="l02031"></a>02031             }
<a name="l02032"></a>02032             <span class="keywordflow">break</span>;
<a name="l02033"></a>02033          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>:
<a name="l02034"></a>02034             <span class="comment">/* Write audio if appropriate */</span>
<a name="l02035"></a>02035             <span class="keywordflow">if</span> (audiofd &gt; -1)
<a name="l02036"></a>02036                write(audiofd, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l02037"></a>02037          <span class="keywordflow">default</span>:
<a name="l02038"></a>02038             <span class="comment">/* Ignore */</span>
<a name="l02039"></a>02039             <span class="keywordflow">break</span>;
<a name="l02040"></a>02040          }
<a name="l02041"></a>02041          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02042"></a>02042       }
<a name="l02043"></a>02043    }
<a name="l02044"></a>02044    <span class="keywordflow">return</span> 0; <span class="comment">/* Time is up */</span>
<a name="l02045"></a>02045 }
<a name="l02046"></a>02046 
<a name="l02047"></a><a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">02047</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">send_dtmf_event</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *direction, <span class="keyword">const</span> <span class="keywordtype">char</span> digit, <span class="keyword">const</span> <span class="keywordtype">char</span> *begin, <span class="keyword">const</span> <span class="keywordtype">char</span> *end)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#d069fd0c9177a3b1a91cee305ddbeed3">EVENT_FLAG_DTMF</a>,
<a name="l02050"></a>02050          <span class="stringliteral">"DTMF"</span>,
<a name="l02051"></a>02051          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l02052"></a>02052          <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l02053"></a>02053          <span class="stringliteral">"Digit: %c\r\n"</span>
<a name="l02054"></a>02054          <span class="stringliteral">"Direction: %s\r\n"</span>
<a name="l02055"></a>02055          <span class="stringliteral">"Begin: %s\r\n"</span>
<a name="l02056"></a>02056          <span class="stringliteral">"End: %s\r\n"</span>,
<a name="l02057"></a>02057          chan-&gt;name, chan-&gt;uniqueid, digit, direction, begin, end);
<a name="l02058"></a>02058 }
<a name="l02059"></a>02059 
<a name="l02060"></a><a class="code" href="channel_8c.html#89920218d5243f8f1f37ffd60cfa5f2b">02060</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="channel_8c.html#89920218d5243f8f1f37ffd60cfa5f2b">__ast_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> dropaudio)
<a name="l02061"></a>02061 {
<a name="l02062"></a>02062    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;   <span class="comment">/* the return value */</span>
<a name="l02063"></a>02063    <span class="keywordtype">int</span> blah;
<a name="l02064"></a>02064    <span class="keywordtype">int</span> prestate;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066    <span class="comment">/* this function is very long so make sure there is only one return</span>
<a name="l02067"></a>02067 <span class="comment">    * point at the end (there is only one exception to this).</span>
<a name="l02068"></a>02068 <span class="comment">    */</span>
<a name="l02069"></a>02069    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02070"></a>02070    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>) {
<a name="l02071"></a>02071       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(chan))
<a name="l02072"></a>02072          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform masquerade\n"</span>);
<a name="l02073"></a>02073       <span class="keywordflow">else</span>
<a name="l02074"></a>02074          f =  &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02075"></a>02075       <span class="keywordflow">goto</span> done;
<a name="l02076"></a>02076    }
<a name="l02077"></a>02077 
<a name="l02078"></a>02078    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l02079"></a>02079    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l02080"></a>02080       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>)
<a name="l02081"></a>02081          <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l02082"></a>02082       <span class="keywordflow">goto</span> done;
<a name="l02083"></a>02083    }
<a name="l02084"></a>02084    prestate = chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>;
<a name="l02085"></a>02085 
<a name="l02086"></a>02086    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a> | <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a> | <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300a63f30ad9ccc9888e23f0d887864fe03">AST_FLAG_IN_DTMF</a>) &amp;&amp; 
<a name="l02087"></a>02087        !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) &amp;&amp; 
<a name="l02088"></a>02088       (ast_tvzero(chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) || ast_tvdiff_ms(ast_tvnow(), chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &gt; <a class="code" href="channel_8c.html#18bca10730d1ced80c262960c3f33c66">AST_MIN_DTMF_GAP</a>) ) {
<a name="l02089"></a>02089       <span class="comment">/* We have DTMF that has been deferred.  Return it now */</span>
<a name="l02090"></a>02090       chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>[0];
<a name="l02091"></a>02091       <span class="comment">/* Drop first digit from the buffer */</span>
<a name="l02092"></a>02092       memmove(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>, chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a> + 1, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) - 1);
<a name="l02093"></a>02093       f = &amp;chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>;
<a name="l02094"></a>02094       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>))
<a name="l02095"></a>02095          chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>.<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>;
<a name="l02096"></a>02096       <span class="keywordflow">else</span> {
<a name="l02097"></a>02097          chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>.<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>;
<a name="l02098"></a>02098          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>);
<a name="l02099"></a>02099          chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a> = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l02100"></a>02100          chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = <a class="code" href="channel_8c.html#47410117e60cd124ee2dcacd28e59115">AST_DEFAULT_EMULATE_DTMF_DURATION</a>;
<a name="l02101"></a>02101       }
<a name="l02102"></a>02102       chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = ast_tvnow();
<a name="l02103"></a>02103       <span class="keywordflow">goto</span> done;
<a name="l02104"></a>02104    }
<a name="l02105"></a>02105    
<a name="l02106"></a>02106    <span class="comment">/* Read and ignore anything on the alertpipe, but read only</span>
<a name="l02107"></a>02107 <span class="comment">      one sizeof(blah) per frame that we send from it */</span>
<a name="l02108"></a>02108    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[0] &gt; -1)
<a name="l02109"></a>02109       read(chan-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[0], &amp;blah, <span class="keyword">sizeof</span>(blah));
<a name="l02110"></a>02110 
<a name="l02111"></a>02111 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l02112"></a>02112 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1 &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#105e7c128b4aa547fdb820f23269be2e">fdno</a> == <a class="code" href="channel_8h.html#0db74b98fb7363645274b7b92a5741f2">AST_TIMING_FD</a> &amp;&amp; <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>)) {
<a name="l02113"></a>02113       <span class="keywordtype">int</span> res;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l02116"></a>02116       blah = -1;
<a name="l02117"></a>02117       <span class="comment">/* IF we can't get event, assume it's an expired as-per the old interface */</span>
<a name="l02118"></a>02118       res = ioctl(chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_GETEVENT, &amp;blah);
<a name="l02119"></a>02119       <span class="keywordflow">if</span> (res)
<a name="l02120"></a>02120          blah = ZT_EVENT_TIMER_EXPIRED;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122       <span class="keywordflow">if</span> (blah == ZT_EVENT_TIMER_PING) {
<a name="l02123"></a>02123          <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;chan-&gt;readq) || !<a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;chan-&gt;readq), frame_list)) {
<a name="l02124"></a>02124             <span class="comment">/* Acknowledge PONG unless we need it again */</span>
<a name="l02125"></a>02125             <span class="keywordflow">if</span> (ioctl(chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_TIMERPONG, &amp;blah)) {
<a name="l02126"></a>02126                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to pong timer on '%s': %s\n"</span>, chan-&gt;name, strerror(errno));
<a name="l02127"></a>02127             }
<a name="l02128"></a>02128          }
<a name="l02129"></a>02129       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blah == ZT_EVENT_TIMER_EXPIRED) {
<a name="l02130"></a>02130          ioctl(chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_TIMERACK, &amp;blah);
<a name="l02131"></a>02131          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a576c60b7b1ab7e59be8ad75ecc55ef9">timingfunc</a>) {
<a name="l02132"></a>02132             <span class="comment">/* save a copy of func/data before unlocking the channel */</span>
<a name="l02133"></a>02133             int (*func)(<span class="keywordtype">void</span> *) = chan-&gt;<a class="code" href="structast__channel.html#a576c60b7b1ab7e59be8ad75ecc55ef9">timingfunc</a>;
<a name="l02134"></a>02134             <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = chan-&gt;<a class="code" href="structast__channel.html#3de60c1425f97e3ddc8b149272742e6d">timingdata</a>;
<a name="l02135"></a>02135             <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02136"></a>02136             <a class="code" href="manager_8h.html#7df4935f4a5a2865191ef74f64df8754">func</a>(<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l02137"></a>02137          } <span class="keywordflow">else</span> {
<a name="l02138"></a>02138             blah = 0;
<a name="l02139"></a>02139             ioctl(chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>, ZT_TIMERCONFIG, &amp;blah);
<a name="l02140"></a>02140             chan-&gt;<a class="code" href="structast__channel.html#3de60c1425f97e3ddc8b149272742e6d">timingdata</a> = NULL;
<a name="l02141"></a>02141             <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02142"></a>02142          }
<a name="l02143"></a>02143          <span class="comment">/* cannot 'goto done' because the channel is already unlocked */</span>
<a name="l02144"></a>02144          <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02145"></a>02145       } <span class="keywordflow">else</span>
<a name="l02146"></a>02146          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"No/unknown event '%d' on timer for '%s'?\n"</span>, blah, chan-&gt;name);
<a name="l02147"></a>02147    } <span class="keywordflow">else</span>
<a name="l02148"></a>02148 <span class="preprocessor">#endif</span>
<a name="l02149"></a>02149 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[<a class="code" href="channel_8h.html#eba2b7656ee8c07b3f916e990b567b02">AST_GENERATOR_FD</a>] &gt; -1 &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#105e7c128b4aa547fdb820f23269be2e">fdno</a> == <a class="code" href="channel_8h.html#eba2b7656ee8c07b3f916e990b567b02">AST_GENERATOR_FD</a>) {
<a name="l02150"></a>02150       <span class="comment">/* if the AST_GENERATOR_FD is set, call the generator with args</span>
<a name="l02151"></a>02151 <span class="comment">       * set to -1 so it can do whatever it needs to.</span>
<a name="l02152"></a>02152 <span class="comment">       */</span>
<a name="l02153"></a>02153       <span class="keywordtype">void</span> *tmp = chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>;
<a name="l02154"></a>02154       chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;     <span class="comment">/* reset to let ast_write get through */</span>
<a name="l02155"></a>02155       chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#359c44da76fd570826dcd60f0f6da36c">generate</a>(chan, tmp, -1, -1);
<a name="l02156"></a>02156       chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = tmp;
<a name="l02157"></a>02157       f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02158"></a>02158       <span class="keywordflow">goto</span> done;
<a name="l02159"></a>02159    }
<a name="l02160"></a>02160 
<a name="l02161"></a>02161    <span class="comment">/* Check for pending read queue */</span>
<a name="l02162"></a>02162    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;chan-&gt;readq)) {
<a name="l02163"></a>02163       f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;chan-&gt;readq, frame_list);
<a name="l02164"></a>02164       <span class="comment">/* Interpret hangup and return NULL */</span>
<a name="l02165"></a>02165       <span class="comment">/* XXX why not the same for frames from the channel ? */</span>
<a name="l02166"></a>02166       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>) {
<a name="l02167"></a>02167          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02168"></a>02168          f = NULL;
<a name="l02169"></a>02169       }
<a name="l02170"></a>02170    } <span class="keywordflow">else</span> {
<a name="l02171"></a>02171       chan-&gt;<a class="code" href="structast__channel.html#a38ba46bb4909bc27602645297913d86">blocker</a> = pthread_self();
<a name="l02172"></a>02172       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>)) {
<a name="l02173"></a>02173          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#1c8f938a9482d8c9c0a080157b646937">exception</a>)
<a name="l02174"></a>02174             f = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#1c8f938a9482d8c9c0a080157b646937">exception</a>(chan);
<a name="l02175"></a>02175          <span class="keywordflow">else</span> {
<a name="l02176"></a>02176             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Exception flag set on '%s', but no exception handler\n"</span>, chan-&gt;name);
<a name="l02177"></a>02177             f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02178"></a>02178          }
<a name="l02179"></a>02179          <span class="comment">/* Clear the exception flag */</span>
<a name="l02180"></a>02180          <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l02181"></a>02181       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3a38881ee9b03ce9fa5a7c46a00a4913">read</a>)
<a name="l02182"></a>02182          f = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3a38881ee9b03ce9fa5a7c46a00a4913">read</a>(chan);
<a name="l02183"></a>02183       <span class="keywordflow">else</span>
<a name="l02184"></a>02184          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No read routine on channel %s\n"</span>, chan-&gt;name);
<a name="l02185"></a>02185    }
<a name="l02186"></a>02186 
<a name="l02187"></a>02187    <span class="keywordflow">if</span> (f) {
<a name="l02188"></a>02188       <span class="comment">/* if the channel driver returned more than one frame, stuff the excess</span>
<a name="l02189"></a>02189 <span class="comment">         into the readq for the next ast_read call (note that we can safely assume</span>
<a name="l02190"></a>02190 <span class="comment">         that the readq is empty, because otherwise we would not have called into</span>
<a name="l02191"></a>02191 <span class="comment">         the channel driver and f would be only a single frame)</span>
<a name="l02192"></a>02192 <span class="comment">      */</span>
<a name="l02193"></a>02193       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(f, frame_list)) {
<a name="l02194"></a>02194          <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;chan-&gt;readq, <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(f, frame_list));
<a name="l02195"></a>02195          <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(f, frame_list) = NULL;
<a name="l02196"></a>02196       }
<a name="l02197"></a>02197 
<a name="l02198"></a>02198       <span class="keywordflow">switch</span> (f-&gt;frametype) {
<a name="l02199"></a>02199       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>:
<a name="l02200"></a>02200          <span class="keywordflow">if</span> (f-&gt;subclass == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>) {
<a name="l02201"></a>02201             <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73007a1bed17a368c12201a64ef3122bf6f6">AST_FLAG_OUTGOING</a>)) {
<a name="l02202"></a>02202                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02203"></a>02203                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Ignoring answer on an inbound call!\n"</span>);
<a name="l02204"></a>02204                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02205"></a>02205                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02206"></a>02206             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prestate == <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) {
<a name="l02207"></a>02207                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02208"></a>02208                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Dropping duplicate answer!\n"</span>);
<a name="l02209"></a>02209                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02210"></a>02210                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02211"></a>02211             } <span class="keywordflow">else</span> {
<a name="l02212"></a>02212                <span class="comment">/* Answer the CDR */</span>
<a name="l02213"></a>02213                <a class="code" href="channel_8c.html#c3e562760bdf7c23ebd561ce1352399e">ast_setstate</a>(chan, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>);
<a name="l02214"></a>02214                <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) { <span class="comment">/* up till now, this insertion hasn't been done. Therefore,</span>
<a name="l02215"></a>02215 <span class="comment">                               to keep from throwing off the basic order of the universe,</span>
<a name="l02216"></a>02216 <span class="comment">                               we will try to keep this cdr from getting posted. */</span>
<a name="l02217"></a>02217                   chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l02218"></a>02218                   <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, chan);
<a name="l02219"></a>02219                   <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l02220"></a>02220                }
<a name="l02221"></a>02221                
<a name="l02222"></a>02222                <a class="code" href="cdr_8c.html#aa59616c49400bc9f58095b2b3f73781">ast_cdr_answer</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l02223"></a>02223             }
<a name="l02224"></a>02224          }
<a name="l02225"></a>02225          <span class="keywordflow">break</span>;
<a name="l02226"></a>02226       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>:
<a name="l02227"></a>02227          <a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">send_dtmf_event</a>(chan, <span class="stringliteral">"Received"</span>, f-&gt;subclass, <span class="stringliteral">"No"</span>, <span class="stringliteral">"Yes"</span>);
<a name="l02228"></a>02228          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#c4c2b6b3ec500c918825c31bad563b4c">LOG_DTMF</a>, <span class="stringliteral">"DTMF end '%c' received on %s, duration %ld ms\n"</span>, f-&gt;subclass, chan-&gt;name, f-&gt;len);
<a name="l02229"></a>02229          <span class="comment">/* Queue it up if DTMF is deffered, or if DTMF emulation is forced.</span>
<a name="l02230"></a>02230 <span class="comment">          * However, only let emulation be forced if the other end cares about BEGIN frames */</span>
<a name="l02231"></a>02231          <span class="keywordflow">if</span> ( <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a>) ||
<a name="l02232"></a>02232             (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>) &amp;&amp; !<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>)) ) {
<a name="l02233"></a>02233             <span class="keywordflow">if</span> (strlen(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) &lt; <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) - 2)
<a name="l02234"></a>02234                chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>[strlen(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>)] = f-&gt;subclass;
<a name="l02235"></a>02235             <span class="keywordflow">else</span>
<a name="l02236"></a>02236                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Dropping deferred DTMF digits on %s\n"</span>, chan-&gt;name);
<a name="l02237"></a>02237             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02238"></a>02238             f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02239"></a>02239          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300a63f30ad9ccc9888e23f0d887864fe03">AST_FLAG_IN_DTMF</a> | <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>)) {
<a name="l02240"></a>02240             <span class="keywordflow">if</span> (!ast_tvzero(chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &amp;&amp; 
<a name="l02241"></a>02241                 ast_tvdiff_ms(ast_tvnow(), chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &lt; <a class="code" href="channel_8c.html#18bca10730d1ced80c262960c3f33c66">AST_MIN_DTMF_GAP</a>) {
<a name="l02242"></a>02242                <span class="comment">/* If it hasn't been long enough, defer this digit */</span>
<a name="l02243"></a>02243                <span class="keywordflow">if</span> (strlen(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) &lt; <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>) - 2)
<a name="l02244"></a>02244                   chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>[strlen(chan-&gt;<a class="code" href="structast__channel.html#4daf3fe101e6d9c5bf96be1dd5354ac3">dtmfq</a>)] = f-&gt;subclass;
<a name="l02245"></a>02245                <span class="keywordflow">else</span>
<a name="l02246"></a>02246                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Dropping deferred DTMF digits on %s\n"</span>, chan-&gt;name);
<a name="l02247"></a>02247                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02248"></a>02248                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02249"></a>02249             } <span class="keywordflow">else</span> {
<a name="l02250"></a>02250                <span class="comment">/* There was no begin, turn this into a begin and send the end later */</span>
<a name="l02251"></a>02251                f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>;
<a name="l02252"></a>02252                <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>);
<a name="l02253"></a>02253                chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a> = f-&gt;subclass;
<a name="l02254"></a>02254                chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = ast_tvnow();
<a name="l02255"></a>02255                <span class="keywordflow">if</span> (f-&gt;len) {
<a name="l02256"></a>02256                   <span class="keywordflow">if</span> (f-&gt;len &gt; <a class="code" href="channel_8c.html#bdfac9ce5e240f345ccf9062efa2291b">AST_MIN_DTMF_DURATION</a>)
<a name="l02257"></a>02257                      chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = f-&gt;len;
<a name="l02258"></a>02258                   <span class="keywordflow">else</span> 
<a name="l02259"></a>02259                      chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = <a class="code" href="channel_8c.html#bdfac9ce5e240f345ccf9062efa2291b">AST_MIN_DTMF_DURATION</a>;
<a name="l02260"></a>02260                } <span class="keywordflow">else</span>
<a name="l02261"></a>02261                   chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = <a class="code" href="channel_8c.html#47410117e60cd124ee2dcacd28e59115">AST_DEFAULT_EMULATE_DTMF_DURATION</a>;
<a name="l02262"></a>02262             }
<a name="l02263"></a>02263          } <span class="keywordflow">else</span> {
<a name="l02264"></a>02264             <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l02265"></a>02265             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300a63f30ad9ccc9888e23f0d887864fe03">AST_FLAG_IN_DTMF</a>);
<a name="l02266"></a>02266             <span class="keywordflow">if</span> (!f-&gt;len)
<a name="l02267"></a>02267                f-&gt;len = ast_tvdiff_ms(now, chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>);
<a name="l02268"></a>02268             <span class="keywordflow">if</span> (f-&gt;len &lt; <a class="code" href="channel_8c.html#bdfac9ce5e240f345ccf9062efa2291b">AST_MIN_DTMF_DURATION</a>) {
<a name="l02269"></a>02269                <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>);
<a name="l02270"></a>02270                chan-&gt;emulate_dtmf_digit = f-&gt;subclass;
<a name="l02271"></a>02271                chan-&gt;emulate_dtmf_duration = <a class="code" href="channel_8c.html#bdfac9ce5e240f345ccf9062efa2291b">AST_MIN_DTMF_DURATION</a> - f-&gt;len;
<a name="l02272"></a>02272                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02273"></a>02273             } <span class="keywordflow">else</span>
<a name="l02274"></a>02274                chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = now;
<a name="l02275"></a>02275          }
<a name="l02276"></a>02276          <span class="keywordflow">break</span>;
<a name="l02277"></a>02277       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>:
<a name="l02278"></a>02278          <a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">send_dtmf_event</a>(chan, <span class="stringliteral">"Received"</span>, f-&gt;subclass, <span class="stringliteral">"Yes"</span>, <span class="stringliteral">"No"</span>);
<a name="l02279"></a>02279          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#c4c2b6b3ec500c918825c31bad563b4c">LOG_DTMF</a>, <span class="stringliteral">"DTMF begin '%c' received on %s\n"</span>, f-&gt;subclass, chan-&gt;name);
<a name="l02280"></a>02280          <span class="keywordflow">if</span> ( <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730023cf26f45cc26e3a993f7dc09b130f33">AST_FLAG_DEFER_DTMF</a> | <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>) || 
<a name="l02281"></a>02281              (!ast_tvzero(chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &amp;&amp; 
<a name="l02282"></a>02282                ast_tvdiff_ms(ast_tvnow(), chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &lt; <a class="code" href="channel_8c.html#18bca10730d1ced80c262960c3f33c66">AST_MIN_DTMF_GAP</a>) ) {
<a name="l02283"></a>02283             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02284"></a>02284             f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02285"></a>02285          } <span class="keywordflow">else</span> {
<a name="l02286"></a>02286             <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300a63f30ad9ccc9888e23f0d887864fe03">AST_FLAG_IN_DTMF</a>);
<a name="l02287"></a>02287             chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = ast_tvnow();
<a name="l02288"></a>02288          }
<a name="l02289"></a>02289          <span class="keywordflow">break</span>;
<a name="l02290"></a>02290       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92eaf38b643259d44fcc0a869ab36609b1">AST_FRAME_NULL</a>:
<a name="l02291"></a>02291          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>)) {
<a name="l02292"></a>02292             <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l02293"></a>02293             <span class="keywordflow">if</span> (ast_tvdiff_ms(now, chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &gt;= chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a>) {
<a name="l02294"></a>02294                chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = 0;
<a name="l02295"></a>02295                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02296"></a>02296                f = &amp;chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>;
<a name="l02297"></a>02297                f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>;
<a name="l02298"></a>02298                f-&gt;subclass = chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a>;
<a name="l02299"></a>02299                f-&gt;len = ast_tvdiff_ms(now, chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>);
<a name="l02300"></a>02300                chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = now;
<a name="l02301"></a>02301                <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>);
<a name="l02302"></a>02302                chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a> = 0;
<a name="l02303"></a>02303             }
<a name="l02304"></a>02304          }
<a name="l02305"></a>02305          <span class="keywordflow">break</span>;
<a name="l02306"></a>02306       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>:
<a name="l02307"></a>02307          <span class="comment">/* The EMULATE_DTMF flag must be cleared here as opposed to when the duration</span>
<a name="l02308"></a>02308 <span class="comment">          * is reached , because we want to make sure we pass at least one</span>
<a name="l02309"></a>02309 <span class="comment">          * voice frame through before starting the next digit, to ensure a gap</span>
<a name="l02310"></a>02310 <span class="comment">          * between DTMF digits. */</span>
<a name="l02311"></a>02311          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>) &amp;&amp; !chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a>) {
<a name="l02312"></a>02312             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>);
<a name="l02313"></a>02313             chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a> = 0;
<a name="l02314"></a>02314          }
<a name="l02315"></a>02315 
<a name="l02316"></a>02316          <span class="keywordflow">if</span> (dropaudio || <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300a63f30ad9ccc9888e23f0d887864fe03">AST_FLAG_IN_DTMF</a>)) {
<a name="l02317"></a>02317             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02318"></a>02318             f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02319"></a>02319          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300f97b9e8c75156f109b64547f27eb8034">AST_FLAG_EMULATE_DTMF</a>)) {
<a name="l02320"></a>02320             <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l02321"></a>02321             <span class="keywordflow">if</span> (ast_tvdiff_ms(now, chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>) &gt;= chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a>) {
<a name="l02322"></a>02322                chan-&gt;<a class="code" href="structast__channel.html#2e2c509196cfc2fde72a4890063c63bc">emulate_dtmf_duration</a> = 0;
<a name="l02323"></a>02323                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02324"></a>02324                f = &amp;chan-&gt;<a class="code" href="structast__channel.html#3b22764bdbf260af201d3c9996882f9d">dtmff</a>;
<a name="l02325"></a>02325                f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>;
<a name="l02326"></a>02326                f-&gt;subclass = chan-&gt;<a class="code" href="structast__channel.html#e489989f50c7c6d96febac3c5978afa6">emulate_dtmf_digit</a>;
<a name="l02327"></a>02327                f-&gt;len = ast_tvdiff_ms(now, chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a>);
<a name="l02328"></a>02328                chan-&gt;<a class="code" href="structast__channel.html#b6a0d327b0788523eb70d8168560573b">dtmf_tv</a> = now;
<a name="l02329"></a>02329             } <span class="keywordflow">else</span> {
<a name="l02330"></a>02330                <span class="comment">/* Drop voice frames while we're still in the middle of the digit */</span>
<a name="l02331"></a>02331                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02332"></a>02332                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02333"></a>02333             }
<a name="l02334"></a>02334          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(f-&gt;subclass &amp; chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>)) {
<a name="l02335"></a>02335             <span class="comment">/* This frame can't be from the current native formats -- drop it on the</span>
<a name="l02336"></a>02336 <span class="comment">               floor */</span>
<a name="l02337"></a>02337             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Dropping incompatible voice frame on %s of format %s since our native format has changed to %s\n"</span>,
<a name="l02338"></a>02338                chan-&gt;name, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;subclass), <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>));
<a name="l02339"></a>02339             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02340"></a>02340             f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02341"></a>02341          } <span class="keywordflow">else</span> {
<a name="l02342"></a>02342             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)
<a name="l02343"></a>02343                <a class="code" href="channel_8c.html#b9e289822f77fb0615938e04d36255c1">queue_frame_to_spies</a>(chan, f, <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886aba31c5f0bdacfcf2dfb5fdf2e60bbe2">SPY_READ</a>);
<a name="l02344"></a>02344             
<a name="l02345"></a>02345             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a> ) {
<a name="l02346"></a>02346                <span class="comment">/* XXX what does this do ? */</span>
<a name="l02347"></a>02347 <span class="preprocessor">#ifndef MONITOR_CONSTANT_DELAY</span>
<a name="l02348"></a>02348 <span class="preprocessor"></span>               <span class="keywordtype">int</span> jump = chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> - 4 * f-&gt;samples;
<a name="l02349"></a>02349                <span class="keywordflow">if</span> (jump &gt;= 0) {
<a name="l02350"></a>02350                   jump = chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a>;
<a name="l02351"></a>02351                   <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>, jump, <a class="code" href="file_8h.html#c499fc238ba5577289a5455d9118a510">SEEK_FORCECUR</a>) == -1)
<a name="l02352"></a>02352                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform seek in monitoring read stream, synchronization between the files may be broken\n"</span>);
<a name="l02353"></a>02353                   chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> += jump + f-&gt;samples;
<a name="l02354"></a>02354                } <span class="keywordflow">else</span>
<a name="l02355"></a>02355                   chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a>+= f-&gt;samples;
<a name="l02356"></a>02356 <span class="preprocessor">#else</span>
<a name="l02357"></a>02357 <span class="preprocessor"></span>               <span class="keywordtype">int</span> jump = chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a>;
<a name="l02358"></a>02358                <span class="keywordflow">if</span> (jump - MONITOR_DELAY &gt;= 0) {
<a name="l02359"></a>02359                   <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>, jump - f-&gt;samples, <a class="code" href="file_8h.html#c499fc238ba5577289a5455d9118a510">SEEK_FORCECUR</a>) == -1)
<a name="l02360"></a>02360                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform seek in monitoring read stream, synchronization between the files may be broken\n"</span>);
<a name="l02361"></a>02361                   chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> += jump;
<a name="l02362"></a>02362                } <span class="keywordflow">else</span>
<a name="l02363"></a>02363                   chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> += f-&gt;samples;
<a name="l02364"></a>02364 <span class="preprocessor">#endif</span>
<a name="l02365"></a>02365 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#9ed39e2ea931586b6a985a6942ef573e">state</a> == <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>) {
<a name="l02366"></a>02366                   <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>, f) &lt; 0)
<a name="l02367"></a>02367                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to write data to channel monitor read stream\n"</span>);
<a name="l02368"></a>02368                }
<a name="l02369"></a>02369             }
<a name="l02370"></a>02370 
<a name="l02371"></a>02371             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a> &amp;&amp; (f = <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(chan-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>, f, 1)) == NULL)
<a name="l02372"></a>02372                f = &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>;
<a name="l02373"></a>02373 
<a name="l02374"></a>02374             <span class="comment">/* Run generator sitting on the line if timing device not available</span>
<a name="l02375"></a>02375 <span class="comment">            * and synchronous generation of outgoing frames is necessary       */</span>
<a name="l02376"></a>02376             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> &amp;&amp;  !<a class="code" href="channel_8c.html#73d63296a76525785cf9f1f379e1d6b4">ast_internal_timing_enabled</a>(chan)) {
<a name="l02377"></a>02377                <span class="keywordtype">void</span> *tmp = chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>;
<a name="l02378"></a>02378                <span class="keywordtype">int</span> res;
<a name="l02379"></a>02379 
<a name="l02380"></a>02380                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a576c60b7b1ab7e59be8ad75ecc55ef9">timingfunc</a>) {
<a name="l02381"></a>02381                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l02382"></a>02382                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Generator got voice, switching to phase locked mode\n"</span>);
<a name="l02383"></a>02383                   <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(chan, 0, NULL, NULL);
<a name="l02384"></a>02384                }
<a name="l02385"></a>02385 
<a name="l02386"></a>02386                chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = NULL;   <span class="comment">/* reset, to let writes go through */</span>
<a name="l02387"></a>02387                res = chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#359c44da76fd570826dcd60f0f6da36c">generate</a>(chan, tmp, f-&gt;datalen, f-&gt;samples);
<a name="l02388"></a>02388                chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> = tmp;
<a name="l02389"></a>02389                <span class="keywordflow">if</span> (res) {
<a name="l02390"></a>02390                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l02391"></a>02391                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Auto-deactivating generator\n"</span>);
<a name="l02392"></a>02392                   <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l02393"></a>02393                }
<a name="l02394"></a>02394 
<a name="l02395"></a>02395             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;frametype == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9223556e0be95cdd997b0f01e84b1a5a0f">AST_FRAME_CNG</a>) {
<a name="l02396"></a>02396                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> &amp;&amp; !chan-&gt;<a class="code" href="structast__channel.html#a576c60b7b1ab7e59be8ad75ecc55ef9">timingfunc</a> &amp;&amp; (chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1)) {
<a name="l02397"></a>02397                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l02398"></a>02398                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Generator got CNG, switching to timed mode\n"</span>);
<a name="l02399"></a>02399                   <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(chan, 160, <a class="code" href="channel_8c.html#e4622c5b41999a7ddad23f05242dca4d">generator_force</a>, chan);
<a name="l02400"></a>02400                }
<a name="l02401"></a>02401             }
<a name="l02402"></a>02402          }
<a name="l02403"></a>02403       <span class="keywordflow">default</span>:
<a name="l02404"></a>02404          <span class="comment">/* Just pass it on! */</span>
<a name="l02405"></a>02405          <span class="keywordflow">break</span>;
<a name="l02406"></a>02406       }
<a name="l02407"></a>02407    } <span class="keywordflow">else</span> {
<a name="l02408"></a>02408       <span class="comment">/* Make sure we always return NULL in the future */</span>
<a name="l02409"></a>02409       chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1cbe3f9a2385d6a31eac6abced2a9f17d">AST_SOFTHANGUP_DEV</a>;
<a name="l02410"></a>02410       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>)
<a name="l02411"></a>02411          <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l02412"></a>02412       <span class="comment">/* End the CDR if appropriate */</span>
<a name="l02413"></a>02413       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>)
<a name="l02414"></a>02414          <a class="code" href="cdr_8c.html#545d0bb7a87e9317b6eb3ce2245145cc">ast_cdr_end</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l02415"></a>02415    }
<a name="l02416"></a>02416 
<a name="l02417"></a>02417    <span class="comment">/* High bit prints debugging */</span>
<a name="l02418"></a>02418    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d79695776a5b40f7cadbee1f91a85c82">fin</a> &amp; <a class="code" href="channel_8h.html#121c28674a9262e968ca5860c9f3e511">DEBUGCHAN_FLAG</a>)
<a name="l02419"></a>02419       <a class="code" href="frame_8c.html#11dff4ae984427c6c3511b38359fe34a">ast_frame_dump</a>(chan-&gt;name, f, <span class="stringliteral">"&lt;&lt;"</span>);
<a name="l02420"></a>02420    chan-&gt;<a class="code" href="structast__channel.html#d79695776a5b40f7cadbee1f91a85c82">fin</a> = <a class="code" href="channel_8h.html#b6dc83815263d1b5a94deeee2f90ef5e">FRAMECOUNT_INC</a>(chan-&gt;<a class="code" href="structast__channel.html#d79695776a5b40f7cadbee1f91a85c82">fin</a>);
<a name="l02421"></a>02421 
<a name="l02422"></a>02422 done:
<a name="l02423"></a>02423    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#e15d64fee78c33c64ef107f1bef4edd0">music_state</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#56a1fd6811fd8aa358f1543f64fe4545">digit</a> &amp;&amp; f &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>)
<a name="l02424"></a>02424       chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>-&gt;<a class="code" href="structast__generator.html#56a1fd6811fd8aa358f1543f64fe4545">digit</a>(chan, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l02425"></a>02425 
<a name="l02426"></a>02426    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02427"></a>02427    <span class="keywordflow">return</span> f;
<a name="l02428"></a>02428 }
<a name="l02429"></a>02429 
<a name="l02430"></a><a class="code" href="channel_8h.html#73d63296a76525785cf9f1f379e1d6b4">02430</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#73d63296a76525785cf9f1f379e1d6b4">ast_internal_timing_enabled</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l02431"></a>02431 {
<a name="l02432"></a>02432    <span class="keywordtype">int</span> ret = <a class="code" href="options_8h.html#f869989ac3f79ef2a407cdc298ad9e5c">ast_opt_internal_timing</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1;
<a name="l02433"></a>02433    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 4)
<a name="l02434"></a>02434       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Internal timing is %s (option_internal_timing=%d chan-&gt;timingfd=%d)\n"</span>, ret? <span class="stringliteral">"enabled"</span>: <span class="stringliteral">"disabled"</span>, <a class="code" href="options_8h.html#f869989ac3f79ef2a407cdc298ad9e5c">ast_opt_internal_timing</a>, chan-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>);
<a name="l02435"></a>02435    <span class="keywordflow">return</span> ret;
<a name="l02436"></a>02436 }
<a name="l02437"></a>02437 
<a name="l02438"></a><a class="code" href="channel_8h.html#1446a8c0bddf626bf26b000fbeae117f">02438</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l02439"></a>02439 {
<a name="l02440"></a>02440    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#89920218d5243f8f1f37ffd60cfa5f2b">__ast_read</a>(chan, 0);
<a name="l02441"></a>02441 }
<a name="l02442"></a>02442 
<a name="l02443"></a><a class="code" href="channel_8h.html#ee2f7baed67b1012d314a42203fca91c">02443</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="channel_8c.html#ee2f7baed67b1012d314a42203fca91c">ast_read_noaudio</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l02444"></a>02444 {
<a name="l02445"></a>02445    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#89920218d5243f8f1f37ffd60cfa5f2b">__ast_read</a>(chan, 1);
<a name="l02446"></a>02446 }
<a name="l02447"></a>02447 
<a name="l02448"></a><a class="code" href="channel_8h.html#90b88ba4c6f05bc0b655583c899c0269">02448</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> condition)
<a name="l02449"></a>02449 {
<a name="l02450"></a>02450    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(chan, condition, NULL, 0);
<a name="l02451"></a>02451 }
<a name="l02452"></a>02452 
<a name="l02453"></a><a class="code" href="channel_8h.html#f1b18b170d0068311ca47c2e0d0ede5c">02453</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, size_t <a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>)
<a name="l02454"></a>02454 {
<a name="l02455"></a>02455    <span class="keywordtype">int</span> res = -1;
<a name="l02456"></a>02456 
<a name="l02457"></a>02457    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02458"></a>02458    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l02459"></a>02459    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l02460"></a>02460       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02461"></a>02461       <span class="keywordflow">return</span> -1;
<a name="l02462"></a>02462    }
<a name="l02463"></a>02463    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a>)
<a name="l02464"></a>02464       res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a>(chan, condition, data, datalen);
<a name="l02465"></a>02465    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02466"></a>02466    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a> || res) {
<a name="l02467"></a>02467       <span class="comment">/*</span>
<a name="l02468"></a>02468 <span class="comment">       * Device does not support (that) indication, lets fake</span>
<a name="l02469"></a>02469 <span class="comment">       * it by doing our own tone generation. (PM2002)</span>
<a name="l02470"></a>02470 <span class="comment">       */</span>
<a name="l02471"></a>02471       <span class="keywordflow">if</span> (condition &lt; 0)
<a name="l02472"></a>02472          <a class="code" href="indications_8c.html#58be04c13701ac7140bfeec76ba55ce9">ast_playtones_stop</a>(chan);
<a name="l02473"></a>02473       <span class="keywordflow">else</span> {
<a name="l02474"></a>02474          <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *ts = NULL;
<a name="l02475"></a>02475          <span class="keywordflow">switch</span> (condition) {
<a name="l02476"></a>02476          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l02477"></a>02477             ts = <a class="code" href="indications_8c.html#f8dc11a7ba1a39a19fc805ef5d914c4d">ast_get_indication_tone</a>(chan-&gt;<a class="code" href="structast__channel.html#a84e5f25e7f6d5de9b82ce3f64d1b8fa">zone</a>, <span class="stringliteral">"ring"</span>);
<a name="l02478"></a>02478             <span class="keywordflow">break</span>;
<a name="l02479"></a>02479          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l02480"></a>02480             ts = <a class="code" href="indications_8c.html#f8dc11a7ba1a39a19fc805ef5d914c4d">ast_get_indication_tone</a>(chan-&gt;<a class="code" href="structast__channel.html#a84e5f25e7f6d5de9b82ce3f64d1b8fa">zone</a>, <span class="stringliteral">"busy"</span>);
<a name="l02481"></a>02481             <span class="keywordflow">break</span>;
<a name="l02482"></a>02482          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l02483"></a>02483             ts = <a class="code" href="indications_8c.html#f8dc11a7ba1a39a19fc805ef5d914c4d">ast_get_indication_tone</a>(chan-&gt;<a class="code" href="structast__channel.html#a84e5f25e7f6d5de9b82ce3f64d1b8fa">zone</a>, <span class="stringliteral">"congestion"</span>);
<a name="l02484"></a>02484             <span class="keywordflow">break</span>;
<a name="l02485"></a>02485          }
<a name="l02486"></a>02486          <span class="keywordflow">if</span> (ts &amp;&amp; ts-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a>[0]) {
<a name="l02487"></a>02487             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02488"></a>02488                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Driver for channel '%s' does not support indication %d, emulating it\n"</span>, chan-&gt;name, condition);
<a name="l02489"></a>02489             <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(chan,0,ts-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a>, 1);
<a name="l02490"></a>02490             res = 0;
<a name="l02491"></a>02491          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389ba3a8e0de0c6348205ffdc9e446af14f">AST_CONTROL_PROGRESS</a>) {
<a name="l02492"></a>02492             <span class="comment">/* ast_playtones_stop(chan); */</span>
<a name="l02493"></a>02493          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e3f77da12f7cbd7a9abfd7c8ce7bfb2b">AST_CONTROL_PROCEEDING</a>) {
<a name="l02494"></a>02494             <span class="comment">/* Do nothing, really */</span>
<a name="l02495"></a>02495          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>) {
<a name="l02496"></a>02496             <span class="comment">/* Do nothing.... */</span>
<a name="l02497"></a>02497          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>) {
<a name="l02498"></a>02498             <span class="comment">/* Do nothing.... */</span>
<a name="l02499"></a>02499          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>) {
<a name="l02500"></a>02500             <span class="comment">/* Do nothing.... */</span>
<a name="l02501"></a>02501          } <span class="keywordflow">else</span> {
<a name="l02502"></a>02502             <span class="comment">/* not handled */</span>
<a name="l02503"></a>02503             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to handle indication %d for '%s'\n"</span>, condition, chan-&gt;name);
<a name="l02504"></a>02504             res = -1;
<a name="l02505"></a>02505          }
<a name="l02506"></a>02506       }
<a name="l02507"></a>02507    }
<a name="l02508"></a>02508    <span class="keywordflow">return</span> res;
<a name="l02509"></a>02509 }
<a name="l02510"></a>02510 
<a name="l02511"></a><a class="code" href="channel_8h.html#36dd07166fc2565f54fc5e7350b2fbe7">02511</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#36dd07166fc2565f54fc5e7350b2fbe7">ast_recvchar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> timeout)
<a name="l02512"></a>02512 {
<a name="l02513"></a>02513    <span class="keywordtype">int</span> c;
<a name="l02514"></a>02514    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> = <a class="code" href="channel_8c.html#985b0a0ce0ab536a6d9a1f88f55ace1a">ast_recvtext</a>(chan, timeout);
<a name="l02515"></a>02515    <span class="keywordflow">if</span> (buf == NULL)
<a name="l02516"></a>02516       <span class="keywordflow">return</span> -1;  <span class="comment">/* error or timeout */</span>
<a name="l02517"></a>02517    c = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)buf;
<a name="l02518"></a>02518    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(buf);
<a name="l02519"></a>02519    <span class="keywordflow">return</span> c;
<a name="l02520"></a>02520 }
<a name="l02521"></a>02521 
<a name="l02522"></a><a class="code" href="channel_8h.html#985b0a0ce0ab536a6d9a1f88f55ace1a">02522</a> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#985b0a0ce0ab536a6d9a1f88f55ace1a">ast_recvtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> timeout)
<a name="l02523"></a>02523 {
<a name="l02524"></a>02524    <span class="keywordtype">int</span> res, done = 0;
<a name="l02525"></a>02525    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> = NULL;
<a name="l02526"></a>02526    
<a name="l02527"></a>02527    <span class="keywordflow">while</span> (!done) {
<a name="l02528"></a>02528       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l02529"></a>02529       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan))
<a name="l02530"></a>02530          <span class="keywordflow">break</span>;
<a name="l02531"></a>02531       res = <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(chan, timeout);
<a name="l02532"></a>02532       <span class="keywordflow">if</span> (res &lt;= 0) <span class="comment">/* timeout or error */</span>
<a name="l02533"></a>02533          <span class="keywordflow">break</span>;
<a name="l02534"></a>02534       timeout = res; <span class="comment">/* update timeout */</span>
<a name="l02535"></a>02535       f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l02536"></a>02536       <span class="keywordflow">if</span> (f == NULL)
<a name="l02537"></a>02537          <span class="keywordflow">break</span>; <span class="comment">/* no frame */</span>
<a name="l02538"></a>02538       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>)
<a name="l02539"></a>02539          done = 1;   <span class="comment">/* force a break */</span>
<a name="l02540"></a>02540       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92696800d27feca415d5c80113fb740f44">AST_FRAME_TEXT</a>) {      <span class="comment">/* what we want */</span>
<a name="l02541"></a>02541          buf = <a class="code" href="utils_8h.html#be543d8da561eeb7942ffd9c42d319c0">ast_strndup</a>((<span class="keywordtype">char</span> *) f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);   <span class="comment">/* dup and break */</span>
<a name="l02542"></a>02542          done = 1;
<a name="l02543"></a>02543       }
<a name="l02544"></a>02544       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02545"></a>02545    }
<a name="l02546"></a>02546    <span class="keywordflow">return</span> buf;
<a name="l02547"></a>02547 }
<a name="l02548"></a>02548 
<a name="l02549"></a><a class="code" href="channel_8h.html#3274faaaeb7a5646df6beead26f9ce8f">02549</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#3274faaaeb7a5646df6beead26f9ce8f">ast_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>)
<a name="l02550"></a>02550 {
<a name="l02551"></a>02551    <span class="keywordtype">int</span> res = 0;
<a name="l02552"></a>02552    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l02553"></a>02553    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan))
<a name="l02554"></a>02554       <span class="keywordflow">return</span> -1;
<a name="l02555"></a>02555    <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(chan);
<a name="l02556"></a>02556    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#fd5ce4dd24c70a0d6226a30b49fcf84b">send_text</a>)
<a name="l02557"></a>02557       res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#fd5ce4dd24c70a0d6226a30b49fcf84b">send_text</a>(chan, text);
<a name="l02558"></a>02558    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l02559"></a>02559    <span class="keywordflow">return</span> res;
<a name="l02560"></a>02560 }
<a name="l02561"></a>02561 
<a name="l02562"></a><a class="code" href="channel_8h.html#2fef33f939432bce542a9ccb28145652">02562</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#2fef33f939432bce542a9ccb28145652">ast_senddigit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> digit)
<a name="l02563"></a>02563 {
<a name="l02564"></a>02564    <span class="comment">/* Device does not support DTMF tones, lets fake</span>
<a name="l02565"></a>02565 <span class="comment">    * it by doing our own generation. */</span>
<a name="l02566"></a>02566    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* dtmf_tones[] = {
<a name="l02567"></a>02567       <span class="stringliteral">"941+1336"</span>, <span class="comment">/* 0 */</span>
<a name="l02568"></a>02568       <span class="stringliteral">"697+1209"</span>, <span class="comment">/* 1 */</span>
<a name="l02569"></a>02569       <span class="stringliteral">"697+1336"</span>, <span class="comment">/* 2 */</span>
<a name="l02570"></a>02570       <span class="stringliteral">"697+1477"</span>, <span class="comment">/* 3 */</span>
<a name="l02571"></a>02571       <span class="stringliteral">"770+1209"</span>, <span class="comment">/* 4 */</span>
<a name="l02572"></a>02572       <span class="stringliteral">"770+1336"</span>, <span class="comment">/* 5 */</span>
<a name="l02573"></a>02573       <span class="stringliteral">"770+1477"</span>, <span class="comment">/* 6 */</span>
<a name="l02574"></a>02574       <span class="stringliteral">"852+1209"</span>, <span class="comment">/* 7 */</span>
<a name="l02575"></a>02575       <span class="stringliteral">"852+1336"</span>, <span class="comment">/* 8 */</span>
<a name="l02576"></a>02576       <span class="stringliteral">"852+1477"</span>, <span class="comment">/* 9 */</span>
<a name="l02577"></a>02577       <span class="stringliteral">"697+1633"</span>, <span class="comment">/* A */</span>
<a name="l02578"></a>02578       <span class="stringliteral">"770+1633"</span>, <span class="comment">/* B */</span>
<a name="l02579"></a>02579       <span class="stringliteral">"852+1633"</span>, <span class="comment">/* C */</span>
<a name="l02580"></a>02580       <span class="stringliteral">"941+1633"</span>, <span class="comment">/* D */</span>
<a name="l02581"></a>02581       <span class="stringliteral">"941+1209"</span>, <span class="comment">/* * */</span>
<a name="l02582"></a>02582       <span class="stringliteral">"941+1477"</span>  <span class="comment">/* # */</span>
<a name="l02583"></a>02583    };
<a name="l02584"></a>02584 
<a name="l02585"></a>02585    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>)
<a name="l02586"></a>02586       <span class="keywordflow">return</span> 0;
<a name="l02587"></a>02587 
<a name="l02588"></a>02588    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>(chan, digit))
<a name="l02589"></a>02589       <span class="keywordflow">return</span> 0;
<a name="l02590"></a>02590 
<a name="l02591"></a>02591    <span class="keywordflow">if</span> (digit &gt;= <span class="charliteral">'0'</span> &amp;&amp; digit &lt;=<span class="charliteral">'9'</span>)
<a name="l02592"></a>02592       <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(chan, 0, dtmf_tones[digit-<span class="charliteral">'0'</span>], 0);
<a name="l02593"></a>02593    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit &gt;= <span class="charliteral">'A'</span> &amp;&amp; digit &lt;= <span class="charliteral">'D'</span>)
<a name="l02594"></a>02594       <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(chan, 0, dtmf_tones[digit-<span class="charliteral">'A'</span>+10], 0);
<a name="l02595"></a>02595    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">'*'</span>)
<a name="l02596"></a>02596       <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(chan, 0, dtmf_tones[14], 0);
<a name="l02597"></a>02597    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">'#'</span>)
<a name="l02598"></a>02598       <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(chan, 0, dtmf_tones[15], 0);
<a name="l02599"></a>02599    <span class="keywordflow">else</span> {
<a name="l02600"></a>02600       <span class="comment">/* not handled */</span>
<a name="l02601"></a>02601       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02602"></a>02602          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Unable to generate DTMF tone '%c' for '%s'\n"</span>, digit, chan-&gt;name);
<a name="l02603"></a>02603    }
<a name="l02604"></a>02604 
<a name="l02605"></a>02605    <span class="keywordflow">return</span> 0;
<a name="l02606"></a>02606 }
<a name="l02607"></a>02607 
<a name="l02608"></a><a class="code" href="channel_8h.html#90ad873bd7f75ca212db0ab089def9f6">02608</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#90ad873bd7f75ca212db0ab089def9f6">ast_senddigit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l02609"></a>02609 {
<a name="l02610"></a>02610    <span class="keywordtype">int</span> res = -1;
<a name="l02611"></a>02611 
<a name="l02612"></a>02612    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#761141281062bdfd42f6bab526b73892">send_digit_end</a>)
<a name="l02613"></a>02613       res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#761141281062bdfd42f6bab526b73892">send_digit_end</a>(chan, digit, duration);
<a name="l02614"></a>02614 
<a name="l02615"></a>02615    <span class="keywordflow">if</span> (res &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>)
<a name="l02616"></a>02616       <a class="code" href="indications_8c.html#58be04c13701ac7140bfeec76ba55ce9">ast_playtones_stop</a>(chan);
<a name="l02617"></a>02617    
<a name="l02618"></a>02618    <span class="keywordflow">return</span> 0;
<a name="l02619"></a>02619 }
<a name="l02620"></a>02620 
<a name="l02621"></a><a class="code" href="channel_8h.html#2f720daf878ec71dc8eed814c5128fe1">02621</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#2f720daf878ec71dc8eed814c5128fe1">ast_senddigit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> digit)
<a name="l02622"></a>02622 {
<a name="l02623"></a>02623    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>) {
<a name="l02624"></a>02624       <a class="code" href="channel_8c.html#2fef33f939432bce542a9ccb28145652">ast_senddigit_begin</a>(chan, digit);
<a name="l02625"></a>02625       <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(chan, 100); <span class="comment">/* XXX 100ms ... probably should be configurable */</span>
<a name="l02626"></a>02626    }
<a name="l02627"></a>02627    
<a name="l02628"></a>02628    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#90ad873bd7f75ca212db0ab089def9f6">ast_senddigit_end</a>(chan, digit, 100);
<a name="l02629"></a>02629 }
<a name="l02630"></a>02630 
<a name="l02631"></a><a class="code" href="channel_8h.html#1e5a4ef714eb64bfdc55813ba363bd67">02631</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#1e5a4ef714eb64bfdc55813ba363bd67">ast_prod</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l02632"></a>02632 {
<a name="l02633"></a>02633    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> a = { <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a> };
<a name="l02634"></a>02634    <span class="keywordtype">char</span> nothing[128];
<a name="l02635"></a>02635 
<a name="l02636"></a>02636    <span class="comment">/* Send an empty audio frame to get things moving */</span>
<a name="l02637"></a>02637    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) {
<a name="l02638"></a>02638       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02639"></a>02639          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Prodding channel '%s'\n"</span>, chan-&gt;name);
<a name="l02640"></a>02640       a.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = chan-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a>;
<a name="l02641"></a>02641       a.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = nothing + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l02642"></a>02642       a.<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> = <span class="stringliteral">"ast_prod"</span>;
<a name="l02643"></a>02643       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(chan, &amp;a))
<a name="l02644"></a>02644          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Prodding channel '%s' failed\n"</span>, chan-&gt;name);
<a name="l02645"></a>02645    }
<a name="l02646"></a>02646    <span class="keywordflow">return</span> 0;
<a name="l02647"></a>02647 }
<a name="l02648"></a>02648 
<a name="l02649"></a><a class="code" href="channel_8h.html#cc48da89fee89a00916d78c6fb74e525">02649</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#8d80983b66ac0aa6f9ff858bababac16">ast_write_video</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr)
<a name="l02650"></a>02650 {
<a name="l02651"></a>02651    <span class="keywordtype">int</span> res;
<a name="l02652"></a>02652    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b07ef32caa20658e63dce83d24dfdd1b">write_video</a>)
<a name="l02653"></a>02653       <span class="keywordflow">return</span> 0;
<a name="l02654"></a>02654    res = <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(chan, fr);
<a name="l02655"></a>02655    <span class="keywordflow">if</span> (!res)
<a name="l02656"></a>02656       res = 1;
<a name="l02657"></a>02657    <span class="keywordflow">return</span> res;
<a name="l02658"></a>02658 }
<a name="l02659"></a>02659 
<a name="l02660"></a><a class="code" href="channel_8h.html#23f7af42552121e87bc52c819df4af48">02660</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr)
<a name="l02661"></a>02661 {
<a name="l02662"></a>02662    <span class="keywordtype">int</span> res = -1;
<a name="l02663"></a>02663    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l02664"></a>02664 
<a name="l02665"></a>02665    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l02666"></a>02666    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02667"></a>02667    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan))
<a name="l02668"></a>02668       <span class="keywordflow">goto</span> done;
<a name="l02669"></a>02669 
<a name="l02670"></a>02670    <span class="comment">/* Handle any pending masquerades */</span>
<a name="l02671"></a>02671    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a> &amp;&amp; <a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(chan)) {
<a name="l02672"></a>02672       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform masquerade\n"</span>);
<a name="l02673"></a>02673       <span class="keywordflow">goto</span> done;
<a name="l02674"></a>02674    }
<a name="l02675"></a>02675    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a>) {
<a name="l02676"></a>02676       res = 0; <span class="comment">/* XXX explain, why 0 ? */</span>
<a name="l02677"></a>02677       <span class="keywordflow">goto</span> done;
<a name="l02678"></a>02678    }
<a name="l02679"></a>02679    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a>) {
<a name="l02680"></a>02680       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730015fb5a488ff560040b677433b270fb5e">AST_FLAG_WRITE_INT</a>))
<a name="l02681"></a>02681          <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l02682"></a>02682       <span class="keywordflow">else</span> {
<a name="l02683"></a>02683          <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>) {
<a name="l02684"></a>02684             <span class="comment">/* There is a generator running while we're in the middle of a digit.</span>
<a name="l02685"></a>02685 <span class="comment">             * It's probably inband DTMF, so go ahead and pass it so it can</span>
<a name="l02686"></a>02686 <span class="comment">             * stop the generator */</span>
<a name="l02687"></a>02687             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l02688"></a>02688             <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02689"></a>02689             res = <a class="code" href="channel_8c.html#90ad873bd7f75ca212db0ab089def9f6">ast_senddigit_end</a>(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l02690"></a>02690             <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02691"></a>02691             <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(chan);
<a name="l02692"></a>02692          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> &amp;&amp; fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>) {
<a name="l02693"></a>02693             <span class="comment">/* This is a side case where Echo is basically being called and the person put themselves on hold and took themselves off hold */</span>
<a name="l02694"></a>02694             res = (chan-&gt;tech-&gt;indicate == NULL) ? 0 :
<a name="l02695"></a>02695                chan-&gt;tech-&gt;indicate(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l02696"></a>02696          }
<a name="l02697"></a>02697          res = 0; <span class="comment">/* XXX explain, why 0 ? */</span>
<a name="l02698"></a>02698          <span class="keywordflow">goto</span> done;
<a name="l02699"></a>02699       }
<a name="l02700"></a>02700    }
<a name="l02701"></a>02701    <span class="comment">/* High bit prints debugging */</span>
<a name="l02702"></a>02702    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#048e72dbb3bdc2353732740741a72fe4">fout</a> &amp; <a class="code" href="channel_8h.html#121c28674a9262e968ca5860c9f3e511">DEBUGCHAN_FLAG</a>)
<a name="l02703"></a>02703       <a class="code" href="frame_8c.html#11dff4ae984427c6c3511b38359fe34a">ast_frame_dump</a>(chan-&gt;name, fr, <span class="stringliteral">"&gt;&gt;"</span>);
<a name="l02704"></a>02704    <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(chan);
<a name="l02705"></a>02705    <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>) {
<a name="l02706"></a>02706    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>:
<a name="l02707"></a>02707       res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a> == NULL) ? 0 :
<a name="l02708"></a>02708          chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#3d2fea14faebc9196821215b29f70fbd">indicate</a>(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l02709"></a>02709       <span class="keywordflow">break</span>;
<a name="l02710"></a>02710    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>:
<a name="l02711"></a>02711       <a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">send_dtmf_event</a>(chan, <span class="stringliteral">"Sent"</span>, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, <span class="stringliteral">"Yes"</span>, <span class="stringliteral">"No"</span>);
<a name="l02712"></a>02712       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l02713"></a>02713       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02714"></a>02714       res = <a class="code" href="channel_8c.html#2fef33f939432bce542a9ccb28145652">ast_senddigit_begin</a>(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l02715"></a>02715       <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02716"></a>02716       <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(chan);
<a name="l02717"></a>02717       <span class="keywordflow">break</span>;
<a name="l02718"></a>02718    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>:
<a name="l02719"></a>02719       <a class="code" href="channel_8c.html#3b05b7a251816dfb6e4ded85a57f083b">send_dtmf_event</a>(chan, <span class="stringliteral">"Sent"</span>, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, <span class="stringliteral">"No"</span>, <span class="stringliteral">"Yes"</span>);
<a name="l02720"></a>02720       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l02721"></a>02721       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02722"></a>02722       res = <a class="code" href="channel_8c.html#90ad873bd7f75ca212db0ab089def9f6">ast_senddigit_end</a>(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l02723"></a>02723       <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02724"></a>02724       <a class="code" href="channel_8h.html#722e76a74a7a5f5eb3efcd3cf30e7772">CHECK_BLOCKING</a>(chan);
<a name="l02725"></a>02725       <span class="keywordflow">break</span>;
<a name="l02726"></a>02726    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92696800d27feca415d5c80113fb740f44">AST_FRAME_TEXT</a>:
<a name="l02727"></a>02727       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#e6ebe929c12bba52018c17fa9fdf2265">AST_FORMAT_T140</a>) {
<a name="l02728"></a>02728          res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a2427e74e53df159c998ddc8ab87124c">write_text</a> == NULL) ? 0 :
<a name="l02729"></a>02729             chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a2427e74e53df159c998ddc8ab87124c">write_text</a>(chan, fr);
<a name="l02730"></a>02730       } <span class="keywordflow">else</span> {
<a name="l02731"></a>02731          res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#fd5ce4dd24c70a0d6226a30b49fcf84b">send_text</a> == NULL) ? 0 :
<a name="l02732"></a>02732             chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#fd5ce4dd24c70a0d6226a30b49fcf84b">send_text</a>(chan, (<span class="keywordtype">char</span> *) fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l02733"></a>02733       }
<a name="l02734"></a>02734       <span class="keywordflow">break</span>;
<a name="l02735"></a>02735    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92a9ac2233f0025ec1b3d23e720cee92be">AST_FRAME_HTML</a>:
<a name="l02736"></a>02736       res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a> == NULL) ? 0 :
<a name="l02737"></a>02737          chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a>(chan, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, (<span class="keywordtype">char</span> *) fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l02738"></a>02738       <span class="keywordflow">break</span>;
<a name="l02739"></a>02739    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92f3104666df07b461099e43be37983393">AST_FRAME_VIDEO</a>:
<a name="l02740"></a>02740       <span class="comment">/* XXX Handle translation of video codecs one day XXX */</span>
<a name="l02741"></a>02741       res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b07ef32caa20658e63dce83d24dfdd1b">write_video</a> == NULL) ? 0 :
<a name="l02742"></a>02742          chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b07ef32caa20658e63dce83d24dfdd1b">write_video</a>(chan, fr);
<a name="l02743"></a>02743       <span class="keywordflow">break</span>;
<a name="l02744"></a>02744    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9258a9185f9370d3f1076917c963b0de50">AST_FRAME_MODEM</a>:
<a name="l02745"></a>02745       res = (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#dd9091ec5b5622ed21050e04562a2efe">write</a> == NULL) ? 0 :
<a name="l02746"></a>02746          chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#dd9091ec5b5622ed21050e04562a2efe">write</a>(chan, fr);
<a name="l02747"></a>02747       <span class="keywordflow">break</span>;
<a name="l02748"></a>02748    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>:
<a name="l02749"></a>02749       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#dd9091ec5b5622ed21050e04562a2efe">write</a> == NULL)
<a name="l02750"></a>02750          <span class="keywordflow">break</span>;   <span class="comment">/*! \todo XXX should return 0 maybe ? */</span>
<a name="l02751"></a>02751 
<a name="l02752"></a>02752       <span class="comment">/* If someone is whispering on this channel then we must ensure that we are always getting signed linear frames */</span>
<a name="l02753"></a>02753       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>)) {
<a name="l02754"></a>02754          <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)
<a name="l02755"></a>02755             f = fr;
<a name="l02756"></a>02756          <span class="keywordflow">else</span> {
<a name="l02757"></a>02757             <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02758"></a>02758             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>) {
<a name="l02759"></a>02759                <span class="comment">/* Rebuild the translation path and set our write format back to signed linear */</span>
<a name="l02760"></a>02760                chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#c8ae1c62d224b4f0a5c49e99a77ed792">original_format</a> = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l02761"></a>02761                <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>);
<a name="l02762"></a>02762                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>)
<a name="l02763"></a>02763                   <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>);
<a name="l02764"></a>02764                chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a> = <a class="code" href="translate_8c.html#46306313154b293cae4c398153ef6f75">ast_translator_build_path</a>(<a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#c8ae1c62d224b4f0a5c49e99a77ed792">original_format</a>);
<a name="l02765"></a>02765             }
<a name="l02766"></a>02766             <span class="comment">/* Translate frame using the above translation path */</span>
<a name="l02767"></a>02767             f = (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>) ? <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>, fr, 0) : fr;
<a name="l02768"></a>02768             <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02769"></a>02769          }
<a name="l02770"></a>02770       } <span class="keywordflow">else</span> {
<a name="l02771"></a>02771          <span class="comment">/* If the frame is in the raw write format, then it's easy... just use the frame - otherwise we will have to translate */</span>
<a name="l02772"></a>02772          <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == chan-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a>)
<a name="l02773"></a>02773             f = fr;
<a name="l02774"></a>02774          <span class="keywordflow">else</span>
<a name="l02775"></a>02775             f = (chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>) ? <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>, fr, 0) : fr;
<a name="l02776"></a>02776       }
<a name="l02777"></a>02777 
<a name="l02778"></a>02778       <span class="comment">/* If we have no frame of audio, then we have to bail out */</span>
<a name="l02779"></a>02779       <span class="keywordflow">if</span> (f == NULL) {
<a name="l02780"></a>02780          res = 0;
<a name="l02781"></a>02781          <span class="keywordflow">break</span>;
<a name="l02782"></a>02782       }
<a name="l02783"></a>02783 
<a name="l02784"></a>02784       <span class="comment">/* If spies are on the channel then queue the frame out to them */</span>
<a name="l02785"></a>02785       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>)
<a name="l02786"></a>02786          <a class="code" href="channel_8c.html#b9e289822f77fb0615938e04d36255c1">queue_frame_to_spies</a>(chan, f, <a class="code" href="channel_8c.html#3b5e30bd80e0b933a8ec0690ee5ba886e3b4d6702d1998b494bbab2603e96bcc">SPY_WRITE</a>);
<a name="l02787"></a>02787 
<a name="l02788"></a>02788       <span class="comment">/* If Monitor is running on this channel, then we have to write frames out there too */</span>
<a name="l02789"></a>02789       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>) {
<a name="l02790"></a>02790          <span class="comment">/* XXX must explain this code */</span>
<a name="l02791"></a>02791 <span class="preprocessor">#ifndef MONITOR_CONSTANT_DELAY</span>
<a name="l02792"></a>02792 <span class="preprocessor"></span>         <span class="keywordtype">int</span> jump = chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> - 4 * f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l02793"></a>02793          <span class="keywordflow">if</span> (jump &gt;= 0) {
<a name="l02794"></a>02794             jump = chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a>;
<a name="l02795"></a>02795             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>, jump, <a class="code" href="file_8h.html#c499fc238ba5577289a5455d9118a510">SEEK_FORCECUR</a>) == -1)
<a name="l02796"></a>02796                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform seek in monitoring write stream, synchronization between the files may be broken\n"</span>);
<a name="l02797"></a>02797             chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> += jump + f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l02798"></a>02798          } <span class="keywordflow">else</span>
<a name="l02799"></a>02799             chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> += f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l02800"></a>02800 <span class="preprocessor">#else</span>
<a name="l02801"></a>02801 <span class="preprocessor"></span>         <span class="keywordtype">int</span> jump = chan-&gt;<a class="code" href="structast__channel.html#04c934dbb3734166a2e68efce91d9b23">insmpl</a> - chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a>;
<a name="l02802"></a>02802          <span class="keywordflow">if</span> (jump - MONITOR_DELAY &gt;= 0) {
<a name="l02803"></a>02803             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>, jump - f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>, <a class="code" href="file_8h.html#c499fc238ba5577289a5455d9118a510">SEEK_FORCECUR</a>) == -1)
<a name="l02804"></a>02804                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to perform seek in monitoring write stream, synchronization between the files may be broken\n"</span>);
<a name="l02805"></a>02805             chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> += jump;
<a name="l02806"></a>02806          } <span class="keywordflow">else</span>
<a name="l02807"></a>02807             chan-&gt;<a class="code" href="structast__channel.html#9a22e94d51f281bd5308fb3ca9384735">outsmpl</a> += f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l02808"></a>02808 <span class="preprocessor">#endif</span>
<a name="l02809"></a>02809 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#9ed39e2ea931586b6a985a6942ef573e">state</a> == <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>) {
<a name="l02810"></a>02810             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>, f) &lt; 0)
<a name="l02811"></a>02811                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to write data to channel monitor write stream\n"</span>);
<a name="l02812"></a>02812          }
<a name="l02813"></a>02813       }
<a name="l02814"></a>02814 
<a name="l02815"></a>02815       <span class="comment">/* Finally the good part! Write this out to the channel */</span>
<a name="l02816"></a>02816       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>)) {
<a name="l02817"></a>02817          <span class="comment">/* frame is assumed to be in SLINEAR, since that is</span>
<a name="l02818"></a>02818 <span class="comment">            required for whisper mode */</span>
<a name="l02819"></a>02819          <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(f, -2);
<a name="l02820"></a>02820          <span class="keywordflow">if</span> (<a class="code" href="slinfactory_8c.html#2bcf3999b8a7aee054494209c1a709dd">ast_slinfactory_available</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#60d31eb37595dd44584be5ef363283e3">sf</a>) &gt;= f-&gt;samples) {
<a name="l02821"></a>02821             <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[f-&gt;samples];
<a name="l02822"></a>02822             <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> whisper = {
<a name="l02823"></a>02823                .<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>,
<a name="l02824"></a>02824                .subclass = <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>,
<a name="l02825"></a>02825                .data = buf,
<a name="l02826"></a>02826                .datalen = <span class="keyword">sizeof</span>(buf),
<a name="l02827"></a>02827                .samples = f-&gt;samples,
<a name="l02828"></a>02828             };
<a name="l02829"></a>02829             
<a name="l02830"></a>02830             <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02831"></a>02831             <span class="keywordflow">if</span> (<a class="code" href="slinfactory_8c.html#baa9b4f450e0462abfe22b6f31e8c006">ast_slinfactory_read</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#60d31eb37595dd44584be5ef363283e3">sf</a>, buf, f-&gt;samples))
<a name="l02832"></a>02832                <a class="code" href="frame_8c.html#8a78ed734b1cafea2ab42e1363a330d0">ast_frame_slinear_sum</a>(f, &amp;whisper);
<a name="l02833"></a>02833             <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02834"></a>02834          }
<a name="l02835"></a>02835          <span class="comment">/* and now put it through the regular translator */</span>
<a name="l02836"></a>02836          f = (chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>) ? <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>, f, 0) : f;
<a name="l02837"></a>02837       }
<a name="l02838"></a>02838       res = f ? chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#dd9091ec5b5622ed21050e04562a2efe">write</a>(chan, f) : 0;
<a name="l02839"></a>02839       <span class="keywordflow">break</span>;
<a name="l02840"></a>02840    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92eaf38b643259d44fcc0a869ab36609b1">AST_FRAME_NULL</a>:
<a name="l02841"></a>02841    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92bf1d9c403ffb2c4b26845d97d1bce16e">AST_FRAME_IAX</a>:
<a name="l02842"></a>02842       <span class="comment">/* Ignore these */</span>
<a name="l02843"></a>02843       res = 0;
<a name="l02844"></a>02844       <span class="keywordflow">break</span>;
<a name="l02845"></a>02845    <span class="keywordflow">default</span>:
<a name="l02846"></a>02846       <span class="comment">/* At this point, fr is the incoming frame and f is NULL.  Channels do</span>
<a name="l02847"></a>02847 <span class="comment">       * not expect to get NULL as a frame pointer and will segfault.  Hence,</span>
<a name="l02848"></a>02848 <span class="comment">       * we output the original frame passed in. */</span>
<a name="l02849"></a>02849       res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#dd9091ec5b5622ed21050e04562a2efe">write</a>(chan, fr);
<a name="l02850"></a>02850       <span class="keywordflow">break</span>;
<a name="l02851"></a>02851    }
<a name="l02852"></a>02852 
<a name="l02853"></a>02853    <span class="keywordflow">if</span> (f &amp;&amp; f != fr)
<a name="l02854"></a>02854       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l02855"></a>02855    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>);
<a name="l02856"></a>02856    <span class="comment">/* Consider a write failure to force a soft hangup */</span>
<a name="l02857"></a>02857    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l02858"></a>02858       chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> |= <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1cbe3f9a2385d6a31eac6abced2a9f17d">AST_SOFTHANGUP_DEV</a>;
<a name="l02859"></a>02859    <span class="keywordflow">else</span> {
<a name="l02860"></a>02860       chan-&gt;<a class="code" href="structast__channel.html#048e72dbb3bdc2353732740741a72fe4">fout</a> = <a class="code" href="channel_8h.html#b6dc83815263d1b5a94deeee2f90ef5e">FRAMECOUNT_INC</a>(chan-&gt;<a class="code" href="structast__channel.html#048e72dbb3bdc2353732740741a72fe4">fout</a>);
<a name="l02861"></a>02861    }
<a name="l02862"></a>02862 done:
<a name="l02863"></a>02863    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02864"></a>02864    <span class="keywordflow">return</span> res;
<a name="l02865"></a>02865 }
<a name="l02866"></a>02866 
<a name="l02867"></a><a class="code" href="channel_8c.html#18a87d054f2631c20245c5b935f0bf7d">02867</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#18a87d054f2631c20245c5b935f0bf7d">set_format</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, <span class="keywordtype">int</span> *rawformat, <span class="keywordtype">int</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,
<a name="l02868"></a>02868             <span class="keyword">struct</span> <a class="code" href="structast__trans__pvt.html">ast_trans_pvt</a> **trans, <span class="keyword">const</span> <span class="keywordtype">int</span> direction)
<a name="l02869"></a>02869 {
<a name="l02870"></a>02870    <span class="keywordtype">int</span> native;
<a name="l02871"></a>02871    <span class="keywordtype">int</span> res;
<a name="l02872"></a>02872    
<a name="l02873"></a>02873    <span class="comment">/* Make sure we only consider audio */</span>
<a name="l02874"></a>02874    fmt &amp;= <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>;
<a name="l02875"></a>02875    
<a name="l02876"></a>02876    native = chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l02877"></a>02877    <span class="comment">/* Find a translation path from the native format to one of the desired formats */</span>
<a name="l02878"></a>02878    <span class="keywordflow">if</span> (!direction)
<a name="l02879"></a>02879       <span class="comment">/* reading */</span>
<a name="l02880"></a>02880       res = <a class="code" href="translate_8c.html#e244e18a275707185dba3f62a32a6eca">ast_translator_best_choice</a>(&amp;fmt, &amp;native);
<a name="l02881"></a>02881    <span class="keywordflow">else</span>
<a name="l02882"></a>02882       <span class="comment">/* writing */</span>
<a name="l02883"></a>02883       res = <a class="code" href="translate_8c.html#e244e18a275707185dba3f62a32a6eca">ast_translator_best_choice</a>(&amp;native, &amp;fmt);
<a name="l02884"></a>02884 
<a name="l02885"></a>02885    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02886"></a>02886       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to find a codec translation path from %s to %s\n"</span>,
<a name="l02887"></a>02887          <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(native), <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(fmt));
<a name="l02888"></a>02888       <span class="keywordflow">return</span> -1;
<a name="l02889"></a>02889    }
<a name="l02890"></a>02890    
<a name="l02891"></a>02891    <span class="comment">/* Now we have a good choice for both. */</span>
<a name="l02892"></a>02892    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l02893"></a>02893 
<a name="l02894"></a>02894    <span class="keywordflow">if</span> ((*rawformat == native) &amp;&amp; (*format == fmt) &amp;&amp; ((*rawformat == *format) || (*trans))) {
<a name="l02895"></a>02895       <span class="comment">/* the channel is already in these formats, so nothing to do */</span>
<a name="l02896"></a>02896       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02897"></a>02897       <span class="keywordflow">return</span> 0;
<a name="l02898"></a>02898    }
<a name="l02899"></a>02899 
<a name="l02900"></a>02900    *rawformat = native;
<a name="l02901"></a>02901    <span class="comment">/* User perspective is fmt */</span>
<a name="l02902"></a>02902    *format = fmt;
<a name="l02903"></a>02903    <span class="comment">/* Free any read translation we have right now */</span>
<a name="l02904"></a>02904    <span class="keywordflow">if</span> (*trans)
<a name="l02905"></a>02905       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(*trans);
<a name="l02906"></a>02906    <span class="comment">/* Build a translation path from the raw format to the desired format */</span>
<a name="l02907"></a>02907    <span class="keywordflow">if</span> (!direction)
<a name="l02908"></a>02908       <span class="comment">/* reading */</span>
<a name="l02909"></a>02909       *trans = <a class="code" href="translate_8c.html#46306313154b293cae4c398153ef6f75">ast_translator_build_path</a>(*format, *rawformat);
<a name="l02910"></a>02910    <span class="keywordflow">else</span>
<a name="l02911"></a>02911       <span class="comment">/* writing */</span>
<a name="l02912"></a>02912       *trans = <a class="code" href="translate_8c.html#46306313154b293cae4c398153ef6f75">ast_translator_build_path</a>(*rawformat, *format);
<a name="l02913"></a>02913    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l02914"></a>02914    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02915"></a>02915       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Set channel %s to %s format %s\n"</span>, chan-&gt;name,
<a name="l02916"></a>02916          direction ? <span class="stringliteral">"write"</span> : <span class="stringliteral">"read"</span>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(fmt));
<a name="l02917"></a>02917    <span class="keywordflow">return</span> 0;
<a name="l02918"></a>02918 }
<a name="l02919"></a>02919 
<a name="l02920"></a><a class="code" href="channel_8h.html#b1aa4e7fc4d8ab22cc83a6b164851c56">02920</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>)
<a name="l02921"></a>02921 {
<a name="l02922"></a>02922    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#18a87d054f2631c20245c5b935f0bf7d">set_format</a>(chan, fmt, &amp;chan-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a>, &amp;chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>,
<a name="l02923"></a>02923            &amp;chan-&gt;<a class="code" href="structast__channel.html#2c3e2372b54538a2ddf46c00fd6a0f8b">readtrans</a>, 0);
<a name="l02924"></a>02924 }
<a name="l02925"></a>02925 
<a name="l02926"></a><a class="code" href="channel_8h.html#56370d56599555d0f1abde0d1d9685a6">02926</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>)
<a name="l02927"></a>02927 {
<a name="l02928"></a>02928    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#18a87d054f2631c20245c5b935f0bf7d">set_format</a>(chan, fmt, &amp;chan-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a>, &amp;chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>,
<a name="l02929"></a>02929            &amp;chan-&gt;<a class="code" href="structast__channel.html#539a57bca8693e9a17639bc306123548">writetrans</a>, 1);
<a name="l02930"></a>02930 }
<a name="l02931"></a>02931 
<a name="l02932"></a><a class="code" href="channel_8h.html#84fcc4e022cb699f8f14c9f3aaeadd2b">02932</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#8537f62a5cf4153cbafae491fb365303">__ast_request_and_dial</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *outstate, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, <span class="keyword">struct</span> <a class="code" href="structoutgoing__helper.html">outgoing_helper</a> *oh)
<a name="l02933"></a>02933 {
<a name="l02934"></a>02934    <span class="keywordtype">int</span> dummy_outstate;
<a name="l02935"></a>02935    <span class="keywordtype">int</span> cause = 0;
<a name="l02936"></a>02936    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *chan;
<a name="l02937"></a>02937    <span class="keywordtype">int</span> res = 0;
<a name="l02938"></a>02938    
<a name="l02939"></a>02939    <span class="keywordflow">if</span> (outstate)
<a name="l02940"></a>02940       *outstate = 0;
<a name="l02941"></a>02941    <span class="keywordflow">else</span>
<a name="l02942"></a>02942       outstate = &amp;dummy_outstate;   <span class="comment">/* make outstate always a valid pointer */</span>
<a name="l02943"></a>02943 
<a name="l02944"></a>02944    chan = <a class="code" href="channel_8c.html#e6f72d6b14d12c48f2e224412f10fb99">ast_request</a>(type, format, data, &amp;cause);
<a name="l02945"></a>02945    <span class="keywordflow">if</span> (!chan) {
<a name="l02946"></a>02946       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to request channel %s/%s\n"</span>, type, (<span class="keywordtype">char</span> *)data);
<a name="l02947"></a>02947       <span class="comment">/* compute error and return */</span>
<a name="l02948"></a>02948       <span class="keywordflow">if</span> (cause == <a class="code" href="causes_8h.html#e8b101dee08334fa50ac3eceb4261151">AST_CAUSE_BUSY</a>)
<a name="l02949"></a>02949          *outstate = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>;
<a name="l02950"></a>02950       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cause == <a class="code" href="causes_8h.html#a1614c968769ae08b46b0d0f000b85e8">AST_CAUSE_CONGESTION</a>)
<a name="l02951"></a>02951          *outstate = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>;
<a name="l02952"></a>02952       <span class="keywordflow">return</span> NULL;
<a name="l02953"></a>02953    }
<a name="l02954"></a>02954 
<a name="l02955"></a>02955    <span class="keywordflow">if</span> (oh) {
<a name="l02956"></a>02956       <span class="keywordflow">if</span> (oh-&gt;<a class="code" href="structoutgoing__helper.html#b63119da730344b345cdc8f62a4711e9">vars</a>)  
<a name="l02957"></a>02957          <a class="code" href="channel_8c.html#ee674fb53b907cc57dda6e54ac24a637">ast_set_variables</a>(chan, oh-&gt;<a class="code" href="structoutgoing__helper.html#b63119da730344b345cdc8f62a4711e9">vars</a>);
<a name="l02958"></a>02958       <span class="comment">/* XXX why is this necessary, for the parent_channel perhaps ? */</span>
<a name="l02959"></a>02959       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>))
<a name="l02960"></a>02960          <a class="code" href="channel_8c.html#7f8abba078071d5d796f25ebc9198974">ast_set_callerid</a>(chan, oh-&gt;<a class="code" href="structoutgoing__helper.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, oh-&gt;<a class="code" href="structoutgoing__helper.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, oh-&gt;<a class="code" href="structoutgoing__helper.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l02961"></a>02961       <span class="keywordflow">if</span> (oh-&gt;<a class="code" href="structoutgoing__helper.html#61b4aeaf61a5a027c4783915d73aa2ae">parent_channel</a>) {
<a name="l02962"></a>02962          <a class="code" href="channel_8c.html#8fb30ace7afdc2899f9b9cdafbf49ff7">ast_channel_inherit_variables</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#61b4aeaf61a5a027c4783915d73aa2ae">parent_channel</a>, chan);
<a name="l02963"></a>02963          <a class="code" href="channel_8c.html#7ccb0875d5b63754a9c968f5dbb92d99">ast_channel_datastore_inherit</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#61b4aeaf61a5a027c4783915d73aa2ae">parent_channel</a>, chan);
<a name="l02964"></a>02964       }
<a name="l02965"></a>02965       <span class="keywordflow">if</span> (oh-&gt;<a class="code" href="structoutgoing__helper.html#e268443e43d93dab7ebef303bbe9642f">account</a>)
<a name="l02966"></a>02966          <a class="code" href="cdr_8c.html#8aa58d36e6bd15ba7d10e367d9870e60">ast_cdr_setaccount</a>(chan, oh-&gt;<a class="code" href="structoutgoing__helper.html#e268443e43d93dab7ebef303bbe9642f">account</a>); 
<a name="l02967"></a>02967    }
<a name="l02968"></a>02968    <a class="code" href="channel_8c.html#7f8abba078071d5d796f25ebc9198974">ast_set_callerid</a>(chan, cid_num, cid_name, cid_num);
<a name="l02969"></a>02969 
<a name="l02970"></a>02970    
<a name="l02971"></a>02971 
<a name="l02972"></a>02972    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) { <span class="comment">/* up till now, this insertion hasn't been done. Therefore,</span>
<a name="l02973"></a>02973 <span class="comment">            to keep from throwing off the basic order of the universe,</span>
<a name="l02974"></a>02974 <span class="comment">            we will try to keep this cdr from getting posted. */</span>
<a name="l02975"></a>02975       chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l02976"></a>02976       <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, chan);
<a name="l02977"></a>02977       <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l02978"></a>02978    }
<a name="l02979"></a>02979    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#37e2b9b65c43c783c6b43552cd20b438">ast_call</a>(chan, data, 0)) {   <span class="comment">/* ast_call failed... */</span>
<a name="l02980"></a>02980       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to call channel %s/%s\n"</span>, type, (<span class="keywordtype">char</span> *)data);
<a name="l02981"></a>02981    } <span class="keywordflow">else</span> {
<a name="l02982"></a>02982       res = 1; <span class="comment">/* mark success in case chan-&gt;_state is already AST_STATE_UP */</span>
<a name="l02983"></a>02983       <span class="keywordflow">while</span> (timeout &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) {
<a name="l02984"></a>02984          <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l02985"></a>02985          res = <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(chan, timeout);
<a name="l02986"></a>02986          <span class="keywordflow">if</span> (res &lt;= 0) <span class="comment">/* error, timeout, or done */</span>
<a name="l02987"></a>02987             <span class="keywordflow">break</span>;
<a name="l02988"></a>02988          <span class="keywordflow">if</span> (timeout &gt; -1)
<a name="l02989"></a>02989             timeout = res;
<a name="l02990"></a>02990          f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l02991"></a>02991          <span class="keywordflow">if</span> (!f) {
<a name="l02992"></a>02992             *outstate = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>;
<a name="l02993"></a>02993             res = 0;
<a name="l02994"></a>02994             <span class="keywordflow">break</span>;
<a name="l02995"></a>02995          }
<a name="l02996"></a>02996          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>) {
<a name="l02997"></a>02997             <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l02998"></a>02998             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:  <span class="comment">/* record but keep going */</span>
<a name="l02999"></a>02999                *outstate = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l03000"></a>03000                <span class="keywordflow">break</span>;
<a name="l03001"></a>03001 
<a name="l03002"></a>03002             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l03003"></a>03003             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l03004"></a>03004             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l03005"></a>03005                *outstate = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l03006"></a>03006                timeout = 0;      <span class="comment">/* trick to force exit from the while() */</span>
<a name="l03007"></a>03007                <span class="keywordflow">break</span>;
<a name="l03008"></a>03008 
<a name="l03009"></a>03009             <span class="comment">/* Ignore these */</span>
<a name="l03010"></a>03010             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389ba3a8e0de0c6348205ffdc9e446af14f">AST_CONTROL_PROGRESS</a>:
<a name="l03011"></a>03011             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e3f77da12f7cbd7a9abfd7c8ce7bfb2b">AST_CONTROL_PROCEEDING</a>:
<a name="l03012"></a>03012             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>:
<a name="l03013"></a>03013             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>:
<a name="l03014"></a>03014             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>:
<a name="l03015"></a>03015             <span class="keywordflow">case</span> -1:       <span class="comment">/* Ignore -- just stopping indications */</span>
<a name="l03016"></a>03016                <span class="keywordflow">break</span>;
<a name="l03017"></a>03017 
<a name="l03018"></a>03018             <span class="keywordflow">default</span>:
<a name="l03019"></a>03019                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Don't know what to do with control frame %d\n"</span>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l03020"></a>03020             }
<a name="l03021"></a>03021          }
<a name="l03022"></a>03022          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l03023"></a>03023       }
<a name="l03024"></a>03024    }
<a name="l03025"></a>03025 
<a name="l03026"></a>03026    <span class="comment">/* Final fixups */</span>
<a name="l03027"></a>03027    <span class="keywordflow">if</span> (oh) {
<a name="l03028"></a>03028       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#5c18ef72771564b7f43c497dc507aeab">context</a>))
<a name="l03029"></a>03029          ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, oh-&gt;<a class="code" href="structoutgoing__helper.html#5c18ef72771564b7f43c497dc507aeab">context</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>));
<a name="l03030"></a>03030       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(oh-&gt;<a class="code" href="structoutgoing__helper.html#3963aa6c69c239f72ae38e92b2ce0f48">exten</a>))
<a name="l03031"></a>03031          ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, oh-&gt;<a class="code" href="structoutgoing__helper.html#3963aa6c69c239f72ae38e92b2ce0f48">exten</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>));
<a name="l03032"></a>03032       <span class="keywordflow">if</span> (oh-&gt;<a class="code" href="structoutgoing__helper.html#b988295c268025b49dfb3df26171ddc3">priority</a>) 
<a name="l03033"></a>03033          chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = oh-&gt;<a class="code" href="structoutgoing__helper.html#b988295c268025b49dfb3df26171ddc3">priority</a>;
<a name="l03034"></a>03034    }
<a name="l03035"></a>03035    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> == <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l03036"></a>03036       *outstate = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>;
<a name="l03037"></a>03037 
<a name="l03038"></a>03038    <span class="keywordflow">if</span> (res &lt;= 0) {
<a name="l03039"></a>03039       <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> &amp;&amp; (chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>()))
<a name="l03040"></a>03040          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, chan);
<a name="l03041"></a>03041       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {
<a name="l03042"></a>03042          <span class="keywordtype">char</span> tmp[256];
<a name="l03043"></a>03043          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s/%s"</span>, type, (<span class="keywordtype">char</span> *)data);
<a name="l03044"></a>03044          <a class="code" href="cdr_8c.html#018b6c8a00209b6cf1fd7386b493f930">ast_cdr_setapp</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>,<span class="stringliteral">"Dial"</span>,tmp);
<a name="l03045"></a>03045          <a class="code" href="cdr_8c.html#0247fba893abcaf42f3861b4982361db">ast_cdr_update</a>(chan);
<a name="l03046"></a>03046          <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l03047"></a>03047          <a class="code" href="cdr_8c.html#545d0bb7a87e9317b6eb3ce2245145cc">ast_cdr_end</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l03048"></a>03048          <span class="comment">/* If the cause wasn't handled properly */</span>
<a name="l03049"></a>03049          <span class="keywordflow">if</span> (<a class="code" href="cdr_8c.html#995ca95113dc7070faca1a0969a72eb9">ast_cdr_disposition</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>,chan-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>))
<a name="l03050"></a>03050             <a class="code" href="cdr_8c.html#3f2e573eb7fde7a250ca8aa95a0d367d">ast_cdr_failed</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l03051"></a>03051       }
<a name="l03052"></a>03052       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(chan);
<a name="l03053"></a>03053       chan = NULL;
<a name="l03054"></a>03054    }
<a name="l03055"></a>03055    <span class="keywordflow">return</span> chan;
<a name="l03056"></a>03056 }
<a name="l03057"></a>03057 
<a name="l03058"></a><a class="code" href="channel_8h.html#951f5f530d12c122c81bf1be5f69ba58">03058</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#354090aed9318ebfbf7629d0a4e5fb7c">ast_request_and_dial</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *outstate, <span class="keyword">const</span> <span class="keywordtype">char</span> *cidnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *cidname)
<a name="l03059"></a>03059 {
<a name="l03060"></a>03060    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#8537f62a5cf4153cbafae491fb365303">__ast_request_and_dial</a>(type, format, data, timeout, outstate, cidnum, cidname, NULL);
<a name="l03061"></a>03061 }
<a name="l03062"></a>03062 
<a name="l03063"></a><a class="code" href="channel_8h.html#18fe0a44ab0842c23ceb444817baecd7">03063</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#e6f72d6b14d12c48f2e224412f10fb99">ast_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> *cause)
<a name="l03064"></a>03064 {
<a name="l03065"></a>03065    <span class="keyword">struct </span><a class="code" href="structchanlist.html">chanlist</a> *chan;
<a name="l03066"></a>03066    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l03067"></a>03067    <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#f7b11037f2050959293aafb493b7653c">capabilities</a>;
<a name="l03068"></a>03068    <span class="keywordtype">int</span> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>;
<a name="l03069"></a>03069    <span class="keywordtype">int</span> res;
<a name="l03070"></a>03070    <span class="keywordtype">int</span> foo;
<a name="l03071"></a>03071    <span class="keywordtype">int</span> videoformat = format &amp; <a class="code" href="frame_8h.html#1d77bc03d9b7e7ec73ac3d49ff1d0360">AST_FORMAT_VIDEO_MASK</a>;
<a name="l03072"></a>03072    <span class="keywordtype">int</span> textformat = format &amp; <a class="code" href="frame_8h.html#dd3aa8954987a10a8e400f853cda70b8">AST_FORMAT_TEXT_MASK</a>;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074    <span class="keywordflow">if</span> (!cause)
<a name="l03075"></a>03075       cause = &amp;foo;
<a name="l03076"></a>03076    *cause = <a class="code" href="causes_8h.html#26616baee17891fc7244df139b296b4d">AST_CAUSE_NOTDEFINED</a>;
<a name="l03077"></a>03077 
<a name="l03078"></a>03078    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;channels)) {
<a name="l03079"></a>03079       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to lock channel list\n"</span>);
<a name="l03080"></a>03080       <span class="keywordflow">return</span> NULL;
<a name="l03081"></a>03081    }
<a name="l03082"></a>03082 
<a name="l03083"></a>03083    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;backends, chan, list) {
<a name="l03084"></a>03084       <span class="keywordflow">if</span> (strcasecmp(type, chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>))
<a name="l03085"></a>03085          <span class="keywordflow">continue</span>;
<a name="l03086"></a>03086 
<a name="l03087"></a>03087       capabilities = chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#f7b11037f2050959293aafb493b7653c">capabilities</a>;
<a name="l03088"></a>03088       fmt = format &amp; <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>;
<a name="l03089"></a>03089       res = <a class="code" href="translate_8c.html#e244e18a275707185dba3f62a32a6eca">ast_translator_best_choice</a>(&amp;fmt, &amp;capabilities);
<a name="l03090"></a>03090       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03091"></a>03091          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No translator path exists for channel type %s (native %d) to %d\n"</span>, type, chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#f7b11037f2050959293aafb493b7653c">capabilities</a>, format);
<a name="l03092"></a>03092          *cause = <a class="code" href="causes_8h.html#541f6970916b30e7429bb6c1fce86d1d">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>;
<a name="l03093"></a>03093          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l03094"></a>03094          <span class="keywordflow">return</span> NULL;
<a name="l03095"></a>03095       }
<a name="l03096"></a>03096       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l03097"></a>03097       <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#19015c7009167d3f93d33c1c1e5fe0f7">requester</a>)
<a name="l03098"></a>03098          <span class="keywordflow">return</span> NULL;
<a name="l03099"></a>03099       
<a name="l03100"></a>03100       <span class="keywordflow">if</span> (!(c = chan-&gt;<a class="code" href="structchanlist.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#19015c7009167d3f93d33c1c1e5fe0f7">requester</a>(type, capabilities | videoformat | textformat, data, cause)))
<a name="l03101"></a>03101          <span class="keywordflow">return</span> NULL;
<a name="l03102"></a>03102       
<a name="l03103"></a>03103       <span class="comment">/* no need to generate a Newchannel event here; it is done in the channel_alloc call */</span>
<a name="l03104"></a>03104       <span class="keywordflow">return</span> c;
<a name="l03105"></a>03105    }
<a name="l03106"></a>03106 
<a name="l03107"></a>03107    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No channel type registered for '%s'\n"</span>, type);
<a name="l03108"></a>03108    *cause = <a class="code" href="causes_8h.html#bffef2c3175892d112f3522e10ec08b1">AST_CAUSE_NOSUCHDRIVER</a>;
<a name="l03109"></a>03109    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;channels);
<a name="l03110"></a>03110 
<a name="l03111"></a>03111    <span class="keywordflow">return</span> NULL;
<a name="l03112"></a>03112 }
<a name="l03113"></a>03113 
<a name="l03114"></a><a class="code" href="channel_8h.html#37e2b9b65c43c783c6b43552cd20b438">03114</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#37e2b9b65c43c783c6b43552cd20b438">ast_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *addr, <span class="keywordtype">int</span> timeout)
<a name="l03115"></a>03115 {
<a name="l03116"></a>03116    <span class="comment">/* Place an outgoing call, but don't wait any longer than timeout ms before returning.</span>
<a name="l03117"></a>03117 <span class="comment">      If the remote end does not answer within the timeout, then do NOT hang up, but</span>
<a name="l03118"></a>03118 <span class="comment">      return anyway.  */</span>
<a name="l03119"></a>03119    <span class="keywordtype">int</span> res = -1;
<a name="l03120"></a>03120    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l03121"></a>03121    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l03122"></a>03122    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) &amp;&amp; !<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l03123"></a>03123       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#2293a71ef97e6c794add8e3ef252d22f">call</a>)
<a name="l03124"></a>03124          res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#2293a71ef97e6c794add8e3ef252d22f">call</a>(chan, addr, timeout);
<a name="l03125"></a>03125       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73007a1bed17a368c12201a64ef3122bf6f6">AST_FLAG_OUTGOING</a>);
<a name="l03126"></a>03126    }
<a name="l03127"></a>03127    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l03128"></a>03128    <span class="keywordflow">return</span> res;
<a name="l03129"></a>03129 }
<a name="l03130"></a>03130 <span class="comment"></span>
<a name="l03131"></a>03131 <span class="comment">/*!</span>
<a name="l03132"></a>03132 <span class="comment">  \brief Transfer a call to dest, if the channel supports transfer</span>
<a name="l03133"></a>03133 <span class="comment"></span>
<a name="l03134"></a>03134 <span class="comment">  Called by:</span>
<a name="l03135"></a>03135 <span class="comment">    \arg app_transfer</span>
<a name="l03136"></a>03136 <span class="comment">    \arg the manager interface</span>
<a name="l03137"></a>03137 <span class="comment">*/</span>
<a name="l03138"></a><a class="code" href="channel_8h.html#0a6d03e8efda8ed8121bbe278e60c7ad">03138</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#0a6d03e8efda8ed8121bbe278e60c7ad">ast_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *dest)
<a name="l03139"></a>03139 {
<a name="l03140"></a>03140    <span class="keywordtype">int</span> res = -1;
<a name="l03141"></a>03141 
<a name="l03142"></a>03142    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l03143"></a>03143    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(chan);
<a name="l03144"></a>03144    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) &amp;&amp; !<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l03145"></a>03145       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a63038a10451f49a8611b19e6c577d90">transfer</a>) {
<a name="l03146"></a>03146          res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a63038a10451f49a8611b19e6c577d90">transfer</a>(chan, dest);
<a name="l03147"></a>03147          <span class="keywordflow">if</span> (!res)
<a name="l03148"></a>03148             res = 1;
<a name="l03149"></a>03149       } <span class="keywordflow">else</span>
<a name="l03150"></a>03150          res = 0;
<a name="l03151"></a>03151    }
<a name="l03152"></a>03152    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l03153"></a>03153    <span class="keywordflow">return</span> res;
<a name="l03154"></a>03154 }
<a name="l03155"></a>03155 
<a name="l03156"></a><a class="code" href="channel_8h.html#9b1cd169a6bd0641ef663976f0dc20c2">03156</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#a548e6593830bf5eaf09c25bee20dc62">ast_readstring</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> ftimeout, <span class="keywordtype">char</span> *enders)
<a name="l03157"></a>03157 {
<a name="l03158"></a>03158    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#1f31f24701fb6ddcecb9ccb05ad327b8">ast_readstring_full</a>(c, s, len, timeout, ftimeout, enders, -1, -1);
<a name="l03159"></a>03159 }
<a name="l03160"></a>03160 
<a name="l03161"></a><a class="code" href="channel_8h.html#92e6bac85bd90ccfe326aad8232894a5">03161</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#1f31f24701fb6ddcecb9ccb05ad327b8">ast_readstring_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> ftimeout, <span class="keywordtype">char</span> *enders, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l03162"></a>03162 {
<a name="l03163"></a>03163    <span class="keywordtype">int</span> pos = 0;   <span class="comment">/* index in the buffer where we accumulate digits */</span>
<a name="l03164"></a>03164    <span class="keywordtype">int</span> to = ftimeout;
<a name="l03165"></a>03165 
<a name="l03166"></a>03166    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l03167"></a>03167    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(c))
<a name="l03168"></a>03168       <span class="keywordflow">return</span> -1;
<a name="l03169"></a>03169    <span class="keywordflow">if</span> (!len)
<a name="l03170"></a>03170       <span class="keywordflow">return</span> -1;
<a name="l03171"></a>03171    <span class="keywordflow">for</span> (;;) {
<a name="l03172"></a>03172       <span class="keywordtype">int</span> d;
<a name="l03173"></a>03173       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>) {
<a name="l03174"></a>03174          d = <a class="code" href="file_8c.html#7be3107f4ff5bc2975b1f52fa552cb6a">ast_waitstream_full</a>(c, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>, audiofd, ctrlfd);
<a name="l03175"></a>03175          <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(c);
<a name="l03176"></a>03176          usleep(1000);
<a name="l03177"></a>03177          <span class="keywordflow">if</span> (!d)
<a name="l03178"></a>03178             d = <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(c, to, audiofd, ctrlfd);
<a name="l03179"></a>03179       } <span class="keywordflow">else</span> {
<a name="l03180"></a>03180          d = <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(c, to, audiofd, ctrlfd);
<a name="l03181"></a>03181       }
<a name="l03182"></a>03182       <span class="keywordflow">if</span> (d &lt; 0)
<a name="l03183"></a>03183          <span class="keywordflow">return</span> -1;
<a name="l03184"></a>03184       <span class="keywordflow">if</span> (d == 0) {
<a name="l03185"></a>03185          s[pos]=<span class="charliteral">'\0'</span>;
<a name="l03186"></a>03186          <span class="keywordflow">return</span> 1;
<a name="l03187"></a>03187       }
<a name="l03188"></a>03188       <span class="keywordflow">if</span> (d == 1) {
<a name="l03189"></a>03189          s[pos]=<span class="charliteral">'\0'</span>;
<a name="l03190"></a>03190          <span class="keywordflow">return</span> 2;
<a name="l03191"></a>03191       }
<a name="l03192"></a>03192       <span class="keywordflow">if</span> (!strchr(enders, d))
<a name="l03193"></a>03193          s[pos++] = d;
<a name="l03194"></a>03194       <span class="keywordflow">if</span> (strchr(enders, d) || (pos &gt;= len)) {
<a name="l03195"></a>03195          s[pos]=<span class="charliteral">'\0'</span>;
<a name="l03196"></a>03196          <span class="keywordflow">return</span> 0;
<a name="l03197"></a>03197       }
<a name="l03198"></a>03198       to = timeout;
<a name="l03199"></a>03199    }
<a name="l03200"></a>03200    <span class="comment">/* Never reached */</span>
<a name="l03201"></a>03201    <span class="keywordflow">return</span> 0;
<a name="l03202"></a>03202 }
<a name="l03203"></a>03203 
<a name="l03204"></a><a class="code" href="channel_8h.html#3c70e41f9d8d7f139a047a5c0db514b6">03204</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#4fb6bc30cb01c33bc8b10c356f2fa45d">ast_channel_supports_html</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l03205"></a>03205 {
<a name="l03206"></a>03206    <span class="keywordflow">return</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a>) ? 1 : 0;
<a name="l03207"></a>03207 }
<a name="l03208"></a>03208 
<a name="l03209"></a><a class="code" href="channel_8h.html#0f66478027b42c17d2be4906671da404">03209</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#117e5372c6521fad97e632610e428451">ast_channel_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> subclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> datalen)
<a name="l03210"></a>03210 {
<a name="l03211"></a>03211    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a>)
<a name="l03212"></a>03212       <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b5688a161e75fbbe138b4d165d4b75f5">send_html</a>(chan, subclass, data, datalen);
<a name="l03213"></a>03213    <span class="keywordflow">return</span> -1;
<a name="l03214"></a>03214 }
<a name="l03215"></a>03215 
<a name="l03216"></a><a class="code" href="channel_8h.html#3833447fb6c948c99cd67de25c565179">03216</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ba474c69366c6126a6e5fea82e090a90">ast_channel_sendurl</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *url)
<a name="l03217"></a>03217 {
<a name="l03218"></a>03218    <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#117e5372c6521fad97e632610e428451">ast_channel_sendhtml</a>(chan, <a class="code" href="frame_8h.html#5049521fc1c798b9ff0afb2b34eca0b4">AST_HTML_URL</a>, url, strlen(url) + 1);
<a name="l03219"></a>03219 }
<a name="l03220"></a>03220 <span class="comment"></span>
<a name="l03221"></a>03221 <span class="comment">/*! \brief Set up translation from one channel to another */</span>
<a name="l03222"></a><a class="code" href="channel_8c.html#363733c9ea643796300b9d91632d97ea">03222</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#363733c9ea643796300b9d91632d97ea">ast_channel_make_compatible_helper</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *from, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *to)
<a name="l03223"></a>03223 {
<a name="l03224"></a>03224    <span class="keywordtype">int</span> src;
<a name="l03225"></a>03225    <span class="keywordtype">int</span> dst;
<a name="l03226"></a>03226 
<a name="l03227"></a>03227    <span class="comment">/* Set up translation from the 'from' channel to the 'to' channel */</span>
<a name="l03228"></a>03228    src = from-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l03229"></a>03229    dst = to-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l03230"></a>03230    <span class="keywordflow">if</span> (<a class="code" href="translate_8c.html#e244e18a275707185dba3f62a32a6eca">ast_translator_best_choice</a>(&amp;dst, &amp;src) &lt; 0) {
<a name="l03231"></a>03231       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No path to translate from %s(%d) to %s(%d)\n"</span>, from-&gt;name, src, to-&gt;name, dst);
<a name="l03232"></a>03232       <span class="keywordflow">return</span> -1;
<a name="l03233"></a>03233    }
<a name="l03234"></a>03234 
<a name="l03235"></a>03235    <span class="comment">/* if the best path is not 'pass through', then</span>
<a name="l03236"></a>03236 <span class="comment">      transcoding is needed; if desired, force transcode path</span>
<a name="l03237"></a>03237 <span class="comment">      to use SLINEAR between channels, but only if there is</span>
<a name="l03238"></a>03238 <span class="comment">      no direct conversion available */</span>
<a name="l03239"></a>03239    <span class="keywordflow">if</span> ((src != dst) &amp;&amp; <a class="code" href="options_8h.html#f0fad769157f066f4507dcf28c84b73c">ast_opt_transcode_via_slin</a> &amp;&amp;
<a name="l03240"></a>03240        (<a class="code" href="translate_8c.html#e7314233a10ef8e62cf836959a2a8605">ast_translate_path_steps</a>(dst, src) != 1))
<a name="l03241"></a>03241       dst = <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>;
<a name="l03242"></a>03242    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(from, dst) &lt; 0) {
<a name="l03243"></a>03243       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set read format on channel %s to %d\n"</span>, from-&gt;name, dst);
<a name="l03244"></a>03244       <span class="keywordflow">return</span> -1;
<a name="l03245"></a>03245    }
<a name="l03246"></a>03246    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(to, dst) &lt; 0) {
<a name="l03247"></a>03247       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set write format on channel %s to %d\n"</span>, to-&gt;name, dst);
<a name="l03248"></a>03248       <span class="keywordflow">return</span> -1;
<a name="l03249"></a>03249    }
<a name="l03250"></a>03250    <span class="keywordflow">return</span> 0;
<a name="l03251"></a>03251 }
<a name="l03252"></a>03252 
<a name="l03253"></a><a class="code" href="channel_8h.html#7481b2c2ff025b987fb82ae18bb8389e">03253</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer)
<a name="l03254"></a>03254 {
<a name="l03255"></a>03255    <span class="comment">/* Some callers do not check return code, and we must try to set all call legs correctly */</span>
<a name="l03256"></a>03256    <span class="keywordtype">int</span> rc = 0;
<a name="l03257"></a>03257 
<a name="l03258"></a>03258    <span class="comment">/* Set up translation from the chan to the peer */</span>
<a name="l03259"></a>03259    rc = <a class="code" href="channel_8c.html#363733c9ea643796300b9d91632d97ea">ast_channel_make_compatible_helper</a>(chan, peer);
<a name="l03260"></a>03260 
<a name="l03261"></a>03261    <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l03262"></a>03262       <span class="keywordflow">return</span> rc;
<a name="l03263"></a>03263 
<a name="l03264"></a>03264    <span class="comment">/* Set up translation from the peer to the chan */</span>
<a name="l03265"></a>03265    rc = <a class="code" href="channel_8c.html#363733c9ea643796300b9d91632d97ea">ast_channel_make_compatible_helper</a>(peer, chan);
<a name="l03266"></a>03266 
<a name="l03267"></a>03267    <span class="keywordflow">return</span> rc;
<a name="l03268"></a>03268 }
<a name="l03269"></a>03269 
<a name="l03270"></a><a class="code" href="channel_8h.html#8e30c09190bd2388188cd8bab35ba595">03270</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *original, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *clone)
<a name="l03271"></a>03271 {
<a name="l03272"></a>03272    <span class="keywordtype">int</span> res = -1;
<a name="l03273"></a>03273    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *final_orig = original, *final_clone = clone;
<a name="l03274"></a>03274 
<a name="l03275"></a>03275    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(original);
<a name="l03276"></a>03276    <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#ed66db8089c98c0615ab831f4eba520a">ast_channel_trylock</a>(clone)) {
<a name="l03277"></a>03277       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(original);
<a name="l03278"></a>03278       usleep(1);
<a name="l03279"></a>03279       <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(original);
<a name="l03280"></a>03280    }
<a name="l03281"></a>03281 
<a name="l03282"></a>03282    <span class="comment">/* each of these channels may be sitting behind a channel proxy (i.e. chan_agent)</span>
<a name="l03283"></a>03283 <span class="comment">      and if so, we don't really want to masquerade it, but its proxy */</span>
<a name="l03284"></a>03284    <span class="keywordflow">if</span> (original-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> &amp;&amp; (original-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> != <a class="code" href="channel_8c.html#8f80b59690710acfe4fc82cfcbbf9ee9">ast_bridged_channel</a>(original)) &amp;&amp; (original-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> != original))
<a name="l03285"></a>03285       final_orig = original-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>;
<a name="l03286"></a>03286 
<a name="l03287"></a>03287    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> &amp;&amp; (clone-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> != <a class="code" href="channel_8c.html#8f80b59690710acfe4fc82cfcbbf9ee9">ast_bridged_channel</a>(clone)) &amp;&amp; (clone-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> != clone))
<a name="l03288"></a>03288       final_clone = clone-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>;
<a name="l03289"></a>03289 
<a name="l03290"></a>03290    <span class="keywordflow">if</span> ((final_orig != original) || (final_clone != clone)) {
<a name="l03291"></a>03291       <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(final_orig);
<a name="l03292"></a>03292       <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#ed66db8089c98c0615ab831f4eba520a">ast_channel_trylock</a>(final_clone)) {
<a name="l03293"></a>03293          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(final_orig);
<a name="l03294"></a>03294          usleep(1);
<a name="l03295"></a>03295          <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(final_orig);
<a name="l03296"></a>03296       }
<a name="l03297"></a>03297       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03298"></a>03298       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(original);
<a name="l03299"></a>03299       original = final_orig;
<a name="l03300"></a>03300       clone = final_clone;
<a name="l03301"></a>03301    }
<a name="l03302"></a>03302 
<a name="l03303"></a>03303    <span class="keywordflow">if</span> (original == clone) {
<a name="l03304"></a>03304       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't masquerade channel '%s' into itself!\n"</span>, original-&gt;name);
<a name="l03305"></a>03305       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03306"></a>03306       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(original);
<a name="l03307"></a>03307       <span class="keywordflow">return</span> -1;
<a name="l03308"></a>03308    }
<a name="l03309"></a>03309 
<a name="l03310"></a>03310    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03311"></a>03311       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Planning to masquerade channel %s into the structure of %s\n"</span>,
<a name="l03312"></a>03312          clone-&gt;name, original-&gt;name);
<a name="l03313"></a>03313    <span class="keywordflow">if</span> (original-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>) {
<a name="l03314"></a>03314       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is already going to masquerade as %s\n"</span>,
<a name="l03315"></a>03315          original-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>-&gt;name, original-&gt;name);
<a name="l03316"></a>03316    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a>) {
<a name="l03317"></a>03317       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is already going to masquerade as %s\n"</span>,
<a name="l03318"></a>03318          clone-&gt;name, clone-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a>-&gt;name);
<a name="l03319"></a>03319    } <span class="keywordflow">else</span> {
<a name="l03320"></a>03320       original-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a> = clone;
<a name="l03321"></a>03321       clone-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a> = original;
<a name="l03322"></a>03322       <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(original, &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>);
<a name="l03323"></a>03323       <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(clone, &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>);
<a name="l03324"></a>03324       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03325"></a>03325          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Done planning to masquerade channel %s into the structure of %s\n"</span>, clone-&gt;name, original-&gt;name);
<a name="l03326"></a>03326       res = 0;
<a name="l03327"></a>03327    }
<a name="l03328"></a>03328 
<a name="l03329"></a>03329    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03330"></a>03330    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(original);
<a name="l03331"></a>03331 
<a name="l03332"></a>03332    <span class="keywordflow">return</span> res;
<a name="l03333"></a>03333 }
<a name="l03334"></a>03334 
<a name="l03335"></a><a class="code" href="channel_8h.html#897cb5bfee52c4e4dbed64b003828811">03335</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#897cb5bfee52c4e4dbed64b003828811">ast_change_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *newname)
<a name="l03336"></a>03336 {
<a name="l03337"></a>03337    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Rename"</span>, <span class="stringliteral">"Oldname: %s\r\nNewname: %s\r\nUniqueid: %s\r\n"</span>, chan-&gt;name, newname, chan-&gt;uniqueid);
<a name="l03338"></a>03338    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(chan, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, newname);
<a name="l03339"></a>03339 }
<a name="l03340"></a>03340 
<a name="l03341"></a><a class="code" href="channel_8h.html#8fb30ace7afdc2899f9b9cdafbf49ff7">03341</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#8fb30ace7afdc2899f9b9cdafbf49ff7">ast_channel_inherit_variables</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *parent, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *child)
<a name="l03342"></a>03342 {
<a name="l03343"></a>03343    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *current, *newvar;
<a name="l03344"></a>03344    <span class="keyword">const</span> <span class="keywordtype">char</span> *varname;
<a name="l03345"></a>03345 
<a name="l03346"></a>03346    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;parent-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>, current, entries) {
<a name="l03347"></a>03347       <span class="keywordtype">int</span> vartype = 0;
<a name="l03348"></a>03348 
<a name="l03349"></a>03349       varname = <a class="code" href="chanvars_8c.html#3ba7832cf0571fcb31d671de79e3210f">ast_var_full_name</a>(current);
<a name="l03350"></a>03350       <span class="keywordflow">if</span> (!varname)
<a name="l03351"></a>03351          <span class="keywordflow">continue</span>;
<a name="l03352"></a>03352 
<a name="l03353"></a>03353       <span class="keywordflow">if</span> (varname[0] == <span class="charliteral">'_'</span>) {
<a name="l03354"></a>03354          vartype = 1;
<a name="l03355"></a>03355          <span class="keywordflow">if</span> (varname[1] == <span class="charliteral">'_'</span>)
<a name="l03356"></a>03356             vartype = 2;
<a name="l03357"></a>03357       }
<a name="l03358"></a>03358 
<a name="l03359"></a>03359       <span class="keywordflow">switch</span> (vartype) {
<a name="l03360"></a>03360       <span class="keywordflow">case</span> 1:
<a name="l03361"></a>03361          newvar = <a class="code" href="chanvars_8c.html#4d0028e2dbd755ae38d2fe4204ad9071">ast_var_assign</a>(&amp;varname[1], <a class="code" href="chanvars_8c.html#6aa089cff5424a26ade21a520e443f82">ast_var_value</a>(current));
<a name="l03362"></a>03362          <span class="keywordflow">if</span> (newvar) {
<a name="l03363"></a>03363             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;child-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>, newvar, entries);
<a name="l03364"></a>03364             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03365"></a>03365                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Copying soft-transferable variable %s.\n"</span>, <a class="code" href="chanvars_8c.html#29d40dfad3c6b59de315b3a0d2ed0a23">ast_var_name</a>(newvar));
<a name="l03366"></a>03366          }
<a name="l03367"></a>03367          <span class="keywordflow">break</span>;
<a name="l03368"></a>03368       <span class="keywordflow">case</span> 2:
<a name="l03369"></a>03369          newvar = <a class="code" href="chanvars_8c.html#4d0028e2dbd755ae38d2fe4204ad9071">ast_var_assign</a>(<a class="code" href="chanvars_8c.html#3ba7832cf0571fcb31d671de79e3210f">ast_var_full_name</a>(current), <a class="code" href="chanvars_8c.html#6aa089cff5424a26ade21a520e443f82">ast_var_value</a>(current));
<a name="l03370"></a>03370          <span class="keywordflow">if</span> (newvar) {
<a name="l03371"></a>03371             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;child-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>, newvar, entries);
<a name="l03372"></a>03372             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03373"></a>03373                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Copying hard-transferable variable %s.\n"</span>, <a class="code" href="chanvars_8c.html#29d40dfad3c6b59de315b3a0d2ed0a23">ast_var_name</a>(newvar));
<a name="l03374"></a>03374          }
<a name="l03375"></a>03375          <span class="keywordflow">break</span>;
<a name="l03376"></a>03376       <span class="keywordflow">default</span>:
<a name="l03377"></a>03377          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03378"></a>03378             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Not copying variable %s.\n"</span>, <a class="code" href="chanvars_8c.html#29d40dfad3c6b59de315b3a0d2ed0a23">ast_var_name</a>(current));
<a name="l03379"></a>03379          <span class="keywordflow">break</span>;
<a name="l03380"></a>03380       }
<a name="l03381"></a>03381    }
<a name="l03382"></a>03382 }
<a name="l03383"></a>03383 <span class="comment"></span>
<a name="l03384"></a>03384 <span class="comment">/*!</span>
<a name="l03385"></a>03385 <span class="comment">  \brief Clone channel variables from 'clone' channel into 'original' channel</span>
<a name="l03386"></a>03386 <span class="comment"></span>
<a name="l03387"></a>03387 <span class="comment">  All variables except those related to app_groupcount are cloned.</span>
<a name="l03388"></a>03388 <span class="comment">  Variables are actually _removed_ from 'clone' channel, presumably</span>
<a name="l03389"></a>03389 <span class="comment">  because it will subsequently be destroyed.</span>
<a name="l03390"></a>03390 <span class="comment"></span>
<a name="l03391"></a>03391 <span class="comment">  \note Assumes locks will be in place on both channels when called.</span>
<a name="l03392"></a>03392 <span class="comment">*/</span>
<a name="l03393"></a><a class="code" href="channel_8c.html#07c73c9b04242eaffbf7168469004920">03393</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#07c73c9b04242eaffbf7168469004920">clone_variables</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *original, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *clone)
<a name="l03394"></a>03394 {
<a name="l03395"></a>03395    <span class="comment">/* Append variables from clone channel into original channel */</span>
<a name="l03396"></a>03396    <span class="comment">/* XXX Is this always correct?  We have to in order to keep MACROS working XXX */</span>
<a name="l03397"></a>03397    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>))
<a name="l03398"></a>03398       <a class="code" href="linkedlists_8h.html#52bbed6274589a6420116ddf0da986ff">AST_LIST_APPEND_LIST</a>(&amp;original-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>, &amp;clone-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>, entries);
<a name="l03399"></a>03399 }
<a name="l03400"></a>03400 <span class="comment"></span>
<a name="l03401"></a>03401 <span class="comment">/*!</span>
<a name="l03402"></a>03402 <span class="comment">  \brief Masquerade a channel</span>
<a name="l03403"></a>03403 <span class="comment"></span>
<a name="l03404"></a>03404 <span class="comment">  \note Assumes channel will be locked when called</span>
<a name="l03405"></a>03405 <span class="comment">*/</span>
<a name="l03406"></a><a class="code" href="channel_8h.html#1f4ea7c056969bf5b3f718be85b5f703">03406</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *original)
<a name="l03407"></a>03407 {
<a name="l03408"></a>03408    <span class="keywordtype">int</span> x,i;
<a name="l03409"></a>03409    <span class="keywordtype">int</span> res=0;
<a name="l03410"></a>03410    <span class="keywordtype">int</span> origstate;
<a name="l03411"></a>03411    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *cur;
<a name="l03412"></a>03412    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html">ast_channel_tech</a> *t;
<a name="l03413"></a>03413    <span class="keywordtype">void</span> *t_pvt;
<a name="l03414"></a>03414    <span class="keyword">struct </span><a class="code" href="structast__callerid.html">ast_callerid</a> tmpcid;
<a name="l03415"></a>03415    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *clone = original-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a>;
<a name="l03416"></a>03416    <span class="keyword">struct </span><a class="code" href="structast__channel__spy__list.html">ast_channel_spy_list</a> *spy_list = NULL;
<a name="l03417"></a>03417    <span class="keyword">struct </span><a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy = NULL;
<a name="l03418"></a>03418    <span class="keyword">struct </span><a class="code" href="structast__cdr.html">ast_cdr</a> *cdr;
<a name="l03419"></a>03419    <span class="keywordtype">int</span> rformat = original-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l03420"></a>03420    <span class="keywordtype">int</span> wformat = original-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l03421"></a>03421    <span class="keywordtype">char</span> newn[100];
<a name="l03422"></a>03422    <span class="keywordtype">char</span> orig[100];
<a name="l03423"></a>03423    <span class="keywordtype">char</span> masqn[100];
<a name="l03424"></a>03424    <span class="keywordtype">char</span> zombn[100];
<a name="l03425"></a>03425 
<a name="l03426"></a>03426    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 3)
<a name="l03427"></a>03427       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Actually Masquerading %s(%d) into the structure of %s(%d)\n"</span>,
<a name="l03428"></a>03428          clone-&gt;name, clone-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>, original-&gt;name, original-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>);
<a name="l03429"></a>03429 
<a name="l03430"></a>03430    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Masquerade"</span>, <span class="stringliteral">"Clone: %s\r\nCloneState: %s\r\nOriginal: %s\r\nOriginalState: %s\r\n"</span>,
<a name="l03431"></a>03431             clone-&gt;name, <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(clone-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>), original-&gt;name, <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(original-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>));
<a name="l03432"></a>03432 
<a name="l03433"></a>03433    <span class="comment">/* XXX This is a seriously wacked out operation.  We're essentially putting the guts of</span>
<a name="l03434"></a>03434 <span class="comment">      the clone channel into the original channel.  Start by killing off the original</span>
<a name="l03435"></a>03435 <span class="comment">      channel's backend.   I'm not sure we're going to keep this function, because</span>
<a name="l03436"></a>03436 <span class="comment">      while the features are nice, the cost is very high in terms of pure nastiness. XXX */</span>
<a name="l03437"></a>03437 
<a name="l03438"></a>03438    <span class="comment">/* We need the clone's lock, too */</span>
<a name="l03439"></a>03439    <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(clone);
<a name="l03440"></a>03440 
<a name="l03441"></a>03441    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l03442"></a>03442       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Got clone lock for masquerade on '%s' at %p\n"</span>, clone-&gt;name, &amp;clone-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03443"></a>03443 
<a name="l03444"></a>03444    <span class="comment">/* Having remembered the original read/write formats, we turn off any translation on either</span>
<a name="l03445"></a>03445 <span class="comment">      one */</span>
<a name="l03446"></a>03446    <a class="code" href="channel_8c.html#58f25e1132c752853fc0e73a67964c37">free_translation</a>(clone);
<a name="l03447"></a>03447    <a class="code" href="channel_8c.html#58f25e1132c752853fc0e73a67964c37">free_translation</a>(original);
<a name="l03448"></a>03448 
<a name="l03449"></a>03449 
<a name="l03450"></a>03450    <span class="comment">/* Unlink the masquerade */</span>
<a name="l03451"></a>03451    original-&gt;<a class="code" href="structast__channel.html#f980faa30a783f7d18ceb4783afc1c69">masq</a> = NULL;
<a name="l03452"></a>03452    clone-&gt;<a class="code" href="structast__channel.html#407a336ed0d13fc2cea1c71a81ad05df">masqr</a> = NULL;
<a name="l03453"></a>03453    
<a name="l03454"></a>03454    <span class="comment">/* Save the original name */</span>
<a name="l03455"></a>03455    ast_copy_string(orig, original-&gt;name, <span class="keyword">sizeof</span>(orig));
<a name="l03456"></a>03456    <span class="comment">/* Save the new name */</span>
<a name="l03457"></a>03457    ast_copy_string(newn, clone-&gt;name, <span class="keyword">sizeof</span>(newn));
<a name="l03458"></a>03458    <span class="comment">/* Create the masq name */</span>
<a name="l03459"></a>03459    snprintf(masqn, <span class="keyword">sizeof</span>(masqn), <span class="stringliteral">"%s&lt;MASQ&gt;"</span>, newn);
<a name="l03460"></a>03460       
<a name="l03461"></a>03461    <span class="comment">/* Copy the name from the clone channel */</span>
<a name="l03462"></a>03462    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(original, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, newn);
<a name="l03463"></a>03463 
<a name="l03464"></a>03464    <span class="comment">/* Mangle the name of the clone channel */</span>
<a name="l03465"></a>03465    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(clone, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, masqn);
<a name="l03466"></a>03466    
<a name="l03467"></a>03467    <span class="comment">/* Notify any managers of the change, first the masq then the other */</span>
<a name="l03468"></a>03468    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Rename"</span>, <span class="stringliteral">"Oldname: %s\r\nNewname: %s\r\nUniqueid: %s\r\n"</span>, newn, masqn, clone-&gt;uniqueid);
<a name="l03469"></a>03469    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Rename"</span>, <span class="stringliteral">"Oldname: %s\r\nNewname: %s\r\nUniqueid: %s\r\n"</span>, orig, newn, original-&gt;uniqueid);
<a name="l03470"></a>03470 
<a name="l03471"></a>03471    <span class="comment">/* Swap the technologies */</span>   
<a name="l03472"></a>03472    t = original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>;
<a name="l03473"></a>03473    original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a> = clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>;
<a name="l03474"></a>03474    clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a> = t;
<a name="l03475"></a>03475 
<a name="l03476"></a>03476    <span class="comment">/* Swap the cdrs */</span>
<a name="l03477"></a>03477    cdr = original-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>;
<a name="l03478"></a>03478    original-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = clone-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>;
<a name="l03479"></a>03479    clone-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = cdr;
<a name="l03480"></a>03480 
<a name="l03481"></a>03481    t_pvt = original-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>;
<a name="l03482"></a>03482    original-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a> = clone-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>;
<a name="l03483"></a>03483    clone-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a> = t_pvt;
<a name="l03484"></a>03484 
<a name="l03485"></a>03485    <span class="comment">/* Swap the readq's */</span>
<a name="l03486"></a>03486    cur = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;original-&gt;readq);
<a name="l03487"></a>03487    <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;original-&gt;readq, <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;readq));
<a name="l03488"></a>03488    <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;clone-&gt;readq, cur);
<a name="l03489"></a>03489 
<a name="l03490"></a>03490    <span class="comment">/* Swap the alertpipes */</span>
<a name="l03491"></a>03491    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l03492"></a>03492       x = original-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[i];
<a name="l03493"></a>03493       original-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[i] = clone-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[i];
<a name="l03494"></a>03494       clone-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[i] = x;
<a name="l03495"></a>03495    }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497    <span class="comment">/* Swap the raw formats */</span>
<a name="l03498"></a>03498    x = original-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a>;
<a name="l03499"></a>03499    original-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a> = clone-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a>;
<a name="l03500"></a>03500    clone-&gt;<a class="code" href="structast__channel.html#48a7f76581d0241312dff0e2a647a9a1">rawreadformat</a> = x;
<a name="l03501"></a>03501    x = original-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a>;
<a name="l03502"></a>03502    original-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a> = clone-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a>;
<a name="l03503"></a>03503    clone-&gt;<a class="code" href="structast__channel.html#331ec3b1c98b3ffed254938780cac119">rawwriteformat</a> = x;
<a name="l03504"></a>03504 
<a name="l03505"></a>03505    <span class="comment">/* Swap the spies */</span>
<a name="l03506"></a>03506    spy_list = original-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>;
<a name="l03507"></a>03507    original-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> = clone-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>;
<a name="l03508"></a>03508    clone-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> = spy_list;
<a name="l03509"></a>03509 
<a name="l03510"></a>03510    <span class="comment">/* Update channel on respective spy lists if present */</span>
<a name="l03511"></a>03511    <span class="keywordflow">if</span> (original-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>) {
<a name="l03512"></a>03512       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;original-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list) {
<a name="l03513"></a>03513          <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03514"></a>03514          spy-&gt;<a class="code" href="structast__channel__spy.html#26c322652770620e64ac90682eb6504c">chan</a> = original;
<a name="l03515"></a>03515          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03516"></a>03516       }
<a name="l03517"></a>03517    }
<a name="l03518"></a>03518    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>) {
<a name="l03519"></a>03519       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;clone-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a>-&gt;list, spy, list) {
<a name="l03520"></a>03520          <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03521"></a>03521          spy-&gt;<a class="code" href="structast__channel__spy.html#26c322652770620e64ac90682eb6504c">chan</a> = clone;
<a name="l03522"></a>03522          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03523"></a>03523       }
<a name="l03524"></a>03524    }
<a name="l03525"></a>03525 
<a name="l03526"></a>03526    <span class="comment">/* Save any pending frames on both sides.  Start by counting</span>
<a name="l03527"></a>03527 <span class="comment">    * how many we're going to need... */</span>
<a name="l03528"></a>03528    x = 0;
<a name="l03529"></a>03529    <span class="keywordflow">if</span> (original-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[1] &gt; -1) {
<a name="l03530"></a>03530       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;clone-&gt;readq, cur, frame_list)
<a name="l03531"></a>03531          x++;
<a name="l03532"></a>03532    }
<a name="l03533"></a>03533 
<a name="l03534"></a>03534    <span class="comment">/* If we had any, prepend them to the ones already in the queue, and </span>
<a name="l03535"></a>03535 <span class="comment">    * load up the alertpipe */</span>
<a name="l03536"></a>03536    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;readq)) {
<a name="l03537"></a>03537       <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;clone-&gt;readq, <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;original-&gt;readq), frame_list);
<a name="l03538"></a>03538       <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;original-&gt;readq, <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;readq));
<a name="l03539"></a>03539       <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;clone-&gt;readq, NULL);
<a name="l03540"></a>03540       <span class="keywordflow">for</span> (i = 0; i &lt; x; i++)
<a name="l03541"></a>03541          write(original-&gt;<a class="code" href="structast__channel.html#edfa4b7986a2ee7cd0db044fa4f67e8e">alertpipe</a>[1], &amp;x, <span class="keyword">sizeof</span>(x));
<a name="l03542"></a>03542    }
<a name="l03543"></a>03543    
<a name="l03544"></a>03544    clone-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1cbe3f9a2385d6a31eac6abced2a9f17d">AST_SOFTHANGUP_DEV</a>;
<a name="l03545"></a>03545 
<a name="l03546"></a>03546 
<a name="l03547"></a>03547    <span class="comment">/* And of course, so does our current state.  Note we need not</span>
<a name="l03548"></a>03548 <span class="comment">      call ast_setstate since the event manager doesn't really consider</span>
<a name="l03549"></a>03549 <span class="comment">      these separate.  We do this early so that the clone has the proper</span>
<a name="l03550"></a>03550 <span class="comment">      state of the original channel. */</span>
<a name="l03551"></a>03551    origstate = original-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>;
<a name="l03552"></a>03552    original-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = clone-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>;
<a name="l03553"></a>03553    clone-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = origstate;
<a name="l03554"></a>03554 
<a name="l03555"></a>03555    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b40e56e9e5c13638ad74ddab4b82747c">fixup</a>){
<a name="l03556"></a>03556       res = clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b40e56e9e5c13638ad74ddab4b82747c">fixup</a>(original, clone);
<a name="l03557"></a>03557       <span class="keywordflow">if</span> (res)
<a name="l03558"></a>03558          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Fixup failed on channel %s, strange things may happen.\n"</span>, clone-&gt;name);
<a name="l03559"></a>03559    }
<a name="l03560"></a>03560 
<a name="l03561"></a>03561    <span class="comment">/* Start by disconnecting the original's physical side */</span>
<a name="l03562"></a>03562    <span class="keywordflow">if</span> (clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#453321d0ff441f44936f3ce5e7c059d6">hangup</a>)
<a name="l03563"></a>03563       res = clone-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#453321d0ff441f44936f3ce5e7c059d6">hangup</a>(clone);
<a name="l03564"></a>03564    <span class="keywordflow">if</span> (res) {
<a name="l03565"></a>03565       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Hangup failed!  Strange things may happen!\n"</span>);
<a name="l03566"></a>03566       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03567"></a>03567       <span class="keywordflow">return</span> -1;
<a name="l03568"></a>03568    }
<a name="l03569"></a>03569    
<a name="l03570"></a>03570    snprintf(zombn, <span class="keyword">sizeof</span>(zombn), <span class="stringliteral">"%s&lt;ZOMBIE&gt;"</span>, orig);
<a name="l03571"></a>03571    <span class="comment">/* Mangle the name of the clone channel */</span>
<a name="l03572"></a>03572    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(clone, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, zombn);
<a name="l03573"></a>03573    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Rename"</span>, <span class="stringliteral">"Oldname: %s\r\nNewname: %s\r\nUniqueid: %s\r\n"</span>, masqn, zombn, clone-&gt;uniqueid);
<a name="l03574"></a>03574 
<a name="l03575"></a>03575    <span class="comment">/* Update the type. */</span>
<a name="l03576"></a>03576    t_pvt = original-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>;
<a name="l03577"></a>03577    original-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = clone-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>;
<a name="l03578"></a>03578    clone-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = t_pvt;
<a name="l03579"></a>03579    
<a name="l03580"></a>03580    <span class="comment">/* Keep the same language.  */</span>
<a name="l03581"></a>03581    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(original, <a class="code" href="chan__alsa_8c.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, clone-&gt;language);
<a name="l03582"></a>03582    <span class="comment">/* Copy the FD's other than the generator fd */</span>
<a name="l03583"></a>03583    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a>; x++) {
<a name="l03584"></a>03584       <span class="keywordflow">if</span> (x != <a class="code" href="channel_8h.html#eba2b7656ee8c07b3f916e990b567b02">AST_GENERATOR_FD</a>)
<a name="l03585"></a>03585          original-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x] = clone-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x];
<a name="l03586"></a>03586    }
<a name="l03587"></a>03587 
<a name="l03588"></a>03588    <a class="code" href="app_8c.html#c94bb500018ff1d24a0e380554d74899">ast_app_group_update</a>(clone, original);
<a name="l03589"></a>03589 
<a name="l03590"></a>03590    <span class="comment">/* move any whisperer over */</span>
<a name="l03591"></a>03591    <a class="code" href="channel_8c.html#79598f580fc373516b4489bc5ebb7b02">ast_channel_whisper_stop</a>(original);
<a name="l03592"></a>03592    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(clone, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>)) {
<a name="l03593"></a>03593       original-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a> = clone-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>;
<a name="l03594"></a>03594       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(original, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>);
<a name="l03595"></a>03595       clone-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a> = NULL;
<a name="l03596"></a>03596       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(clone, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>);
<a name="l03597"></a>03597    }
<a name="l03598"></a>03598 
<a name="l03599"></a>03599    <span class="comment">/* Move data stores over */</span>
<a name="l03600"></a>03600    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;datastores))
<a name="l03601"></a>03601                 <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;original-&gt;datastores, <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;clone-&gt;datastores), entry);
<a name="l03602"></a>03602    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;clone-&gt;datastores);
<a name="l03603"></a>03603 
<a name="l03604"></a>03604    <a class="code" href="channel_8c.html#07c73c9b04242eaffbf7168469004920">clone_variables</a>(original, clone);
<a name="l03605"></a>03605    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;clone-&gt;<a class="code" href="structast__channel.html#104b87f05b6aae74d9ba38d4c91f2e11">varshead</a>);
<a name="l03606"></a>03606    <span class="comment">/* Presense of ADSI capable CPE follows clone */</span>
<a name="l03607"></a>03607    original-&gt;<a class="code" href="structast__channel.html#89c64e070078b5f6dcd6e241d2eb986e">adsicpe</a> = clone-&gt;<a class="code" href="structast__channel.html#89c64e070078b5f6dcd6e241d2eb986e">adsicpe</a>;
<a name="l03608"></a>03608    <span class="comment">/* Bridge remains the same */</span>
<a name="l03609"></a>03609    <span class="comment">/* CDR fields remain the same */</span>
<a name="l03610"></a>03610    <span class="comment">/* XXX What about blocking, softhangup, blocker, and lock and blockproc? XXX */</span>
<a name="l03611"></a>03611    <span class="comment">/* Application and data remain the same */</span>
<a name="l03612"></a>03612    <span class="comment">/* Clone exception  becomes real one, as with fdno */</span>
<a name="l03613"></a>03613    <a class="code" href="utils_8h.html#7963ad5058a8544f02f00fc94199cbc3">ast_copy_flags</a>(original, clone, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l03614"></a>03614    original-&gt;<a class="code" href="structast__channel.html#105e7c128b4aa547fdb820f23269be2e">fdno</a> = clone-&gt;<a class="code" href="structast__channel.html#105e7c128b4aa547fdb820f23269be2e">fdno</a>;
<a name="l03615"></a>03615    <span class="comment">/* Schedule context remains the same */</span>
<a name="l03616"></a>03616    <span class="comment">/* Stream stuff stays the same */</span>
<a name="l03617"></a>03617    <span class="comment">/* Keep the original state.  The fixup code will need to work with it most likely */</span>
<a name="l03618"></a>03618 
<a name="l03619"></a>03619    <span class="comment">/* Just swap the whole structures, nevermind the allocations, they'll work themselves</span>
<a name="l03620"></a>03620 <span class="comment">      out. */</span>
<a name="l03621"></a>03621    tmpcid = original-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>;
<a name="l03622"></a>03622    original-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a> = clone-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>;
<a name="l03623"></a>03623    clone-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a> = tmpcid;
<a name="l03624"></a>03624    
<a name="l03625"></a>03625    <span class="comment">/* Restore original timing file descriptor */</span>
<a name="l03626"></a>03626    original-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[<a class="code" href="channel_8h.html#0db74b98fb7363645274b7b92a5741f2">AST_TIMING_FD</a>] = original-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a>;
<a name="l03627"></a>03627    
<a name="l03628"></a>03628    <span class="comment">/* Our native formats are different now */</span>
<a name="l03629"></a>03629    original-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a> = clone-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l03630"></a>03630    
<a name="l03631"></a>03631    <span class="comment">/* Context, extension, priority, app data, jump table,  remain the same */</span>
<a name="l03632"></a>03632    <span class="comment">/* pvt switches.  pbx stays the same, as does next */</span>
<a name="l03633"></a>03633    
<a name="l03634"></a>03634    <span class="comment">/* Set the write format */</span>
<a name="l03635"></a>03635    <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(original, wformat);
<a name="l03636"></a>03636 
<a name="l03637"></a>03637    <span class="comment">/* Set the read format */</span>
<a name="l03638"></a>03638    <a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(original, rformat);
<a name="l03639"></a>03639 
<a name="l03640"></a>03640    <span class="comment">/* Copy the music class */</span>
<a name="l03641"></a>03641    <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(original, <a class="code" href="chan__mgcp_8c.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, clone-&gt;musicclass);
<a name="l03642"></a>03642 
<a name="l03643"></a>03643    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03644"></a>03644       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Putting channel %s in %d/%d formats\n"</span>, original-&gt;name, wformat, rformat);
<a name="l03645"></a>03645 
<a name="l03646"></a>03646    <span class="comment">/* Okay.  Last thing is to let the channel driver know about all this mess, so he</span>
<a name="l03647"></a>03647 <span class="comment">      can fix up everything as best as possible */</span>
<a name="l03648"></a>03648    <span class="keywordflow">if</span> (original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b40e56e9e5c13638ad74ddab4b82747c">fixup</a>) {
<a name="l03649"></a>03649       res = original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#b40e56e9e5c13638ad74ddab4b82747c">fixup</a>(clone, original);
<a name="l03650"></a>03650       <span class="keywordflow">if</span> (res) {
<a name="l03651"></a>03651          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel for type '%s' could not fixup channel %s\n"</span>,
<a name="l03652"></a>03652             original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, original-&gt;name);
<a name="l03653"></a>03653          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03654"></a>03654          <span class="keywordflow">return</span> -1;
<a name="l03655"></a>03655       }
<a name="l03656"></a>03656    } <span class="keywordflow">else</span>
<a name="l03657"></a>03657       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Channel type '%s' does not have a fixup routine (for %s)!  Bad things may happen.\n"</span>,
<a name="l03658"></a>03658          original-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, original-&gt;name);
<a name="l03659"></a>03659    
<a name="l03660"></a>03660    <span class="comment">/* Now, at this point, the "clone" channel is totally F'd up.  We mark it as</span>
<a name="l03661"></a>03661 <span class="comment">      a zombie so nothing tries to touch it.  If it's already been marked as a</span>
<a name="l03662"></a>03662 <span class="comment">      zombie, then free it now (since it already is considered invalid). */</span>
<a name="l03663"></a>03663    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(clone, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>)) {
<a name="l03664"></a>03664       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03665"></a>03665          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Destroying channel clone '%s'\n"</span>, clone-&gt;name);
<a name="l03666"></a>03666       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03667"></a>03667       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Hangup"</span>,
<a name="l03668"></a>03668          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l03669"></a>03669          <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l03670"></a>03670          <span class="stringliteral">"Cause: %d\r\n"</span>
<a name="l03671"></a>03671          <span class="stringliteral">"Cause-txt: %s\r\n"</span>,
<a name="l03672"></a>03672          clone-&gt;name,
<a name="l03673"></a>03673          clone-&gt;uniqueid,
<a name="l03674"></a>03674          clone-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>,
<a name="l03675"></a>03675          <a class="code" href="channel_8c.html#817c0e10b26cbcb773516bb6583fb694">ast_cause2str</a>(clone-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>)
<a name="l03676"></a>03676          );
<a name="l03677"></a>03677       <a class="code" href="channel_8c.html#230a804b09060fecdf699c2c9613fff7">ast_channel_free</a>(clone);
<a name="l03678"></a>03678    } <span class="keywordflow">else</span> {
<a name="l03679"></a>03679       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03680"></a>03680          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Released clone lock on '%s'\n"</span>, clone-&gt;name);
<a name="l03681"></a>03681       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(clone, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>);
<a name="l03682"></a>03682       <a class="code" href="channel_8c.html#c02f134e64b4fc85c1efd80b8685b635">ast_queue_frame</a>(clone, &amp;<a class="code" href="frame_8c.html#8bfe1415e256ff41d93a3ce9396e815f">ast_null_frame</a>);
<a name="l03683"></a>03683       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(clone);
<a name="l03684"></a>03684    }
<a name="l03685"></a>03685    
<a name="l03686"></a>03686    <span class="comment">/* Signal any blocker */</span>
<a name="l03687"></a>03687    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(original, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300770f2eb0c3db1b6cd4b4d1b9cf363672">AST_FLAG_BLOCKING</a>))
<a name="l03688"></a>03688       pthread_kill(original-&gt;<a class="code" href="structast__channel.html#a38ba46bb4909bc27602645297913d86">blocker</a>, SIGURG);
<a name="l03689"></a>03689    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03690"></a>03690       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Done Masquerading %s (%d)\n"</span>, original-&gt;name, original-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>);
<a name="l03691"></a>03691    <span class="keywordflow">return</span> 0;
<a name="l03692"></a>03692 }
<a name="l03693"></a>03693 
<a name="l03694"></a><a class="code" href="channel_8h.html#2a53bdcc725eb9e81eb4a666ff695873">03694</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#7f8abba078071d5d796f25ebc9198974">ast_set_callerid</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *calleridname, <span class="keyword">const</span> <span class="keywordtype">char</span> *ani)
<a name="l03695"></a>03695 {
<a name="l03696"></a>03696    <span class="keywordflow">if</span> (callerid) {
<a name="l03697"></a>03697       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)
<a name="l03698"></a>03698          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l03699"></a>03699       chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(callerid);
<a name="l03700"></a>03700    }
<a name="l03701"></a>03701    <span class="keywordflow">if</span> (calleridname) {
<a name="l03702"></a>03702       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>)
<a name="l03703"></a>03703          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>);
<a name="l03704"></a>03704       chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(calleridname);
<a name="l03705"></a>03705    }
<a name="l03706"></a>03706    <span class="keywordflow">if</span> (ani) {
<a name="l03707"></a>03707       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a>)
<a name="l03708"></a>03708          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a>);
<a name="l03709"></a>03709       chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(ani);
<a name="l03710"></a>03710    }
<a name="l03711"></a>03711    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>)
<a name="l03712"></a>03712       <a class="code" href="cdr_8c.html#845a92535bcaac4752ddee76f665e408">ast_cdr_setcid</a>(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, chan);
<a name="l03713"></a>03713    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Newcallerid"</span>,
<a name="l03714"></a>03714             <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l03715"></a>03715             <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l03716"></a>03716             <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l03717"></a>03717             <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l03718"></a>03718             <span class="stringliteral">"CID-CallingPres: %d (%s)\r\n"</span>,
<a name="l03719"></a>03719             chan-&gt;name,
<a name="l03720"></a>03720             <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"&lt;Unknown&gt;"</span>),
<a name="l03721"></a>03721             <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"&lt;Unknown&gt;"</span>),
<a name="l03722"></a>03722             chan-&gt;uniqueid,
<a name="l03723"></a>03723             chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#872e42fb90e7d76ff7350f6741f567ff">cid_pres</a>,
<a name="l03724"></a>03724             <a class="code" href="callerid_8c.html#b5dfc57cf569e2ba434a743b1d53af4f">ast_describe_caller_presentation</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#872e42fb90e7d76ff7350f6741f567ff">cid_pres</a>)
<a name="l03725"></a>03725             );
<a name="l03726"></a>03726 }
<a name="l03727"></a>03727 
<a name="l03728"></a><a class="code" href="channel_8h.html#4545ff02284db8d61db9c8cf01803b95">03728</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#c3e562760bdf7c23ebd561ce1352399e">ast_setstate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">enum</span> <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a">ast_channel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l03729"></a>03729 {
<a name="l03730"></a>03730    <span class="keywordtype">int</span> oldstate = chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>;
<a name="l03731"></a>03731 
<a name="l03732"></a>03732    <span class="keywordflow">if</span> (oldstate == state)
<a name="l03733"></a>03733       <span class="keywordflow">return</span> 0;
<a name="l03734"></a>03734 
<a name="l03735"></a>03735    chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = state;
<a name="l03736"></a>03736    <a class="code" href="devicestate_8c.html#2416b5bb0bcab6392204637700a2d280">ast_device_state_changed_literal</a>(chan-&gt;name);
<a name="l03737"></a>03737    <span class="comment">/* setstate used to conditionally report Newchannel; this is no more */</span>
<a name="l03738"></a>03738    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>,
<a name="l03739"></a>03739             <span class="stringliteral">"Newstate"</span>,
<a name="l03740"></a>03740             <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l03741"></a>03741             <span class="stringliteral">"State: %s\r\n"</span>
<a name="l03742"></a>03742             <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l03743"></a>03743             <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l03744"></a>03744             <span class="stringliteral">"Uniqueid: %s\r\n"</span>,
<a name="l03745"></a>03745             chan-&gt;name, <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>),
<a name="l03746"></a>03746             <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l03747"></a>03747             <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l03748"></a>03748             chan-&gt;uniqueid);
<a name="l03749"></a>03749 
<a name="l03750"></a>03750    <span class="keywordflow">return</span> 0;
<a name="l03751"></a>03751 }
<a name="l03752"></a>03752 <span class="comment"></span>
<a name="l03753"></a>03753 <span class="comment">/*! \brief Find bridged channel */</span>
<a name="l03754"></a><a class="code" href="channel_8h.html#8f80b59690710acfe4fc82cfcbbf9ee9">03754</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="channel_8c.html#8f80b59690710acfe4fc82cfcbbf9ee9">ast_bridged_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l03755"></a>03755 {
<a name="l03756"></a>03756    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *bridged;
<a name="l03757"></a>03757    bridged = chan-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>;
<a name="l03758"></a>03758    <span class="keywordflow">if</span> (bridged &amp;&amp; bridged-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#d068860c943a563e72d994cc95b19b33">bridged_channel</a>)
<a name="l03759"></a>03759       bridged = bridged-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#d068860c943a563e72d994cc95b19b33">bridged_channel</a>(chan, bridged);
<a name="l03760"></a>03760    <span class="keywordflow">return</span> bridged;
<a name="l03761"></a>03761 }
<a name="l03762"></a>03762 
<a name="l03763"></a><a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">03763</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structsound.html">sound</a>, <span class="keywordtype">int</span> remain)
<a name="l03764"></a>03764 {
<a name="l03765"></a>03765    <span class="keywordtype">int</span> min = 0, <a class="code" href="adsistub_8c.html#74459ca3cf85a81df90da95ff6e7a207">sec</a> = 0, check;
<a name="l03766"></a>03766 
<a name="l03767"></a>03767    check = <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(peer);
<a name="l03768"></a>03768    <span class="keywordflow">if</span> (check)
<a name="l03769"></a>03769       <span class="keywordflow">return</span>;
<a name="l03770"></a>03770 
<a name="l03771"></a>03771    <span class="keywordflow">if</span> (remain &gt; 0) {
<a name="l03772"></a>03772       <span class="keywordflow">if</span> (remain / 60 &gt; 1) {
<a name="l03773"></a>03773          min = remain / 60;
<a name="l03774"></a>03774          <a class="code" href="adsistub_8c.html#74459ca3cf85a81df90da95ff6e7a207">sec</a> = remain % 60;
<a name="l03775"></a>03775       } <span class="keywordflow">else</span> {
<a name="l03776"></a>03776          <a class="code" href="adsistub_8c.html#74459ca3cf85a81df90da95ff6e7a207">sec</a> = remain;
<a name="l03777"></a>03777       }
<a name="l03778"></a>03778    }
<a name="l03779"></a>03779    
<a name="l03780"></a>03780    <span class="keywordflow">if</span> (!strcmp(sound,<span class="stringliteral">"timeleft"</span>)) { <span class="comment">/* Queue support */</span>
<a name="l03781"></a>03781       <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(chan, <span class="stringliteral">"vm-youhave"</span>, <span class="stringliteral">""</span>);
<a name="l03782"></a>03782       <span class="keywordflow">if</span> (min) {
<a name="l03783"></a>03783          <a class="code" href="channel_8c.html#ae819935343a14b1f61b331ff85fc214">ast_say_number</a>(chan, min, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l03784"></a>03784          <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(chan, <span class="stringliteral">"queue-minutes"</span>, <span class="stringliteral">""</span>);
<a name="l03785"></a>03785       }
<a name="l03786"></a>03786       <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#74459ca3cf85a81df90da95ff6e7a207">sec</a>) {
<a name="l03787"></a>03787          <a class="code" href="channel_8c.html#ae819935343a14b1f61b331ff85fc214">ast_say_number</a>(chan, <a class="code" href="adsistub_8c.html#74459ca3cf85a81df90da95ff6e7a207">sec</a>, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l03788"></a>03788          <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(chan, <span class="stringliteral">"queue-seconds"</span>, <span class="stringliteral">""</span>);
<a name="l03789"></a>03789       }
<a name="l03790"></a>03790    } <span class="keywordflow">else</span> {
<a name="l03791"></a>03791       <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(chan, sound, <span class="stringliteral">""</span>);
<a name="l03792"></a>03792    }
<a name="l03793"></a>03793 
<a name="l03794"></a>03794    <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(peer);
<a name="l03795"></a>03795 }
<a name="l03796"></a>03796 
<a name="l03797"></a><a class="code" href="channel_8c.html#4f79ef2dc27d26c29b18b9ab40b5d56b">03797</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19">ast_bridge_result</a> <a class="code" href="channel_8c.html#4f79ef2dc27d26c29b18b9ab40b5d56b">ast_generic_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c1,
<a name="l03798"></a>03798                    <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> **fo,
<a name="l03799"></a>03799                    <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **rc, <span class="keyword">struct</span> timeval bridge_end)
<a name="l03800"></a>03800 {
<a name="l03801"></a>03801    <span class="comment">/* Copy voice back and forth between the two channels. */</span>
<a name="l03802"></a>03802    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *cs[3];
<a name="l03803"></a>03803    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l03804"></a>03804    <span class="keyword">enum</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19">ast_bridge_result</a> res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19fd37b17491849eb3a8d0cd996d69fe1f">AST_BRIDGE_COMPLETE</a>;
<a name="l03805"></a>03805    <span class="keywordtype">int</span> o0nativeformats;
<a name="l03806"></a>03806    <span class="keywordtype">int</span> o1nativeformats;
<a name="l03807"></a>03807    <span class="keywordtype">int</span> watch_c0_dtmf;
<a name="l03808"></a>03808    <span class="keywordtype">int</span> watch_c1_dtmf;
<a name="l03809"></a>03809    <span class="keywordtype">void</span> *pvt0, *pvt1;
<a name="l03810"></a>03810    <span class="comment">/* Indicates whether a frame was queued into a jitterbuffer */</span>
<a name="l03811"></a>03811    <span class="keywordtype">int</span> frame_put_in_jb = 0;
<a name="l03812"></a>03812    <span class="keywordtype">int</span> jb_in_use;
<a name="l03813"></a>03813    <span class="keywordtype">int</span> to;
<a name="l03814"></a>03814    
<a name="l03815"></a>03815    cs[0] = c0;
<a name="l03816"></a>03816    cs[1] = c1;
<a name="l03817"></a>03817    pvt0 = c0-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>;
<a name="l03818"></a>03818    pvt1 = c1-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a>;
<a name="l03819"></a>03819    o0nativeformats = c0-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l03820"></a>03820    o1nativeformats = c1-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l03821"></a>03821    watch_c0_dtmf = config-&gt;<a class="code" href="structast__bridge__config.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="channel_8h.html#8681ed1fe1fa7446abae5740777a5778">AST_BRIDGE_DTMF_CHANNEL_0</a>;
<a name="l03822"></a>03822    watch_c1_dtmf = config-&gt;<a class="code" href="structast__bridge__config.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="channel_8h.html#2919689ff25adb292a33ffc670ff5663">AST_BRIDGE_DTMF_CHANNEL_1</a>;
<a name="l03823"></a>03823 
<a name="l03824"></a>03824    <span class="comment">/* Check the need of a jitterbuffer for each channel */</span>
<a name="l03825"></a>03825    jb_in_use = <a class="code" href="abstract__jb_8c.html#d3d628e70cc3a782b0017fe3e6b36fd4">ast_jb_do_usecheck</a>(c0, c1);
<a name="l03826"></a>03826 
<a name="l03827"></a>03827    <span class="keywordflow">for</span> (;;) {
<a name="l03828"></a>03828       <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *who, *other;
<a name="l03829"></a>03829 
<a name="l03830"></a>03830       <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a> != pvt0) || (c1-&gt;<a class="code" href="structast__channel.html#25ab83fd9a6fe57f4133e359f88bb9d1">tech_pvt</a> != pvt1) ||
<a name="l03831"></a>03831           (o0nativeformats != c0-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>) ||
<a name="l03832"></a>03832           (o1nativeformats != c1-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>)) {
<a name="l03833"></a>03833          <span class="comment">/* Check for Masquerade, codec changes, etc */</span>
<a name="l03834"></a>03834          res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19ebe331af24cd5342764adc6f1b59fbec">AST_BRIDGE_RETRY</a>;
<a name="l03835"></a>03835          <span class="keywordflow">break</span>;
<a name="l03836"></a>03836       }
<a name="l03837"></a>03837       <span class="keywordflow">if</span> (bridge_end.tv_sec) {
<a name="l03838"></a>03838          to = ast_tvdiff_ms(bridge_end, ast_tvnow());
<a name="l03839"></a>03839          <span class="keywordflow">if</span> (to &lt;= 0) {
<a name="l03840"></a>03840             <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>)
<a name="l03841"></a>03841                res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19ebe331af24cd5342764adc6f1b59fbec">AST_BRIDGE_RETRY</a>;
<a name="l03842"></a>03842             <span class="keywordflow">else</span>
<a name="l03843"></a>03843                res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19fd37b17491849eb3a8d0cd996d69fe1f">AST_BRIDGE_COMPLETE</a>;
<a name="l03844"></a>03844             <span class="keywordflow">break</span>;
<a name="l03845"></a>03845          }
<a name="l03846"></a>03846       } <span class="keywordflow">else</span>
<a name="l03847"></a>03847          to = -1;
<a name="l03848"></a>03848       <span class="comment">/* Calculate the appropriate max sleep interval - in general, this is the time,</span>
<a name="l03849"></a>03849 <span class="comment">         left to the closest jb delivery moment */</span>
<a name="l03850"></a>03850       <span class="keywordflow">if</span> (jb_in_use)
<a name="l03851"></a>03851          to = <a class="code" href="abstract__jb_8c.html#08b86b2a178bd6636b3f1b81a418af46">ast_jb_get_when_to_wakeup</a>(c0, c1, to);
<a name="l03852"></a>03852       who = <a class="code" href="channel_8c.html#96a31a1429603c4049e5ef10d7ce2470">ast_waitfor_n</a>(cs, 2, &amp;to);
<a name="l03853"></a>03853       <span class="keywordflow">if</span> (!who) {
<a name="l03854"></a>03854          <span class="comment">/* No frame received within the specified timeout - check if we have to deliver now */</span>
<a name="l03855"></a>03855          <span class="keywordflow">if</span> (jb_in_use)
<a name="l03856"></a>03856             <a class="code" href="abstract__jb_8c.html#7c4d2833527a961fc976861441579116">ast_jb_get_and_deliver</a>(c0, c1);
<a name="l03857"></a>03857          <span class="keywordflow">if</span> (c0-&gt;_softhangup == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a> || c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>) {
<a name="l03858"></a>03858             <span class="keywordflow">if</span> (c0-&gt;_softhangup == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>)
<a name="l03859"></a>03859                c0-&gt;_softhangup = 0;
<a name="l03860"></a>03860             <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>)
<a name="l03861"></a>03861                c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l03862"></a>03862             c0-&gt;_bridge = c1;
<a name="l03863"></a>03863             c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = c0;
<a name="l03864"></a>03864          }
<a name="l03865"></a>03865          <span class="keywordflow">continue</span>;
<a name="l03866"></a>03866       }
<a name="l03867"></a>03867       f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(who);
<a name="l03868"></a>03868       <span class="keywordflow">if</span> (!f) {
<a name="l03869"></a>03869          *fo = NULL;
<a name="l03870"></a>03870          *rc = who;
<a name="l03871"></a>03871          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03872"></a>03872             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Didn't get a frame from channel: %s\n"</span>,who-&gt;name);
<a name="l03873"></a>03873          <span class="keywordflow">break</span>;
<a name="l03874"></a>03874       }
<a name="l03875"></a>03875 
<a name="l03876"></a>03876       other = (who == c0) ? c1 : c0; <span class="comment">/* the 'other' channel */</span>
<a name="l03877"></a>03877       <span class="comment">/* Try add the frame info the who's bridged channel jitterbuff */</span>
<a name="l03878"></a>03878       <span class="keywordflow">if</span> (jb_in_use)
<a name="l03879"></a>03879          frame_put_in_jb = !<a class="code" href="abstract__jb_8c.html#01a93200bfbbbe54704b408154bbd877">ast_jb_put</a>(other, f);
<a name="l03880"></a>03880 
<a name="l03881"></a>03881       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>) &amp;&amp; !(config-&gt;<a class="code" href="structast__bridge__config.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="channel_8h.html#8aeaf48a8524e827ce2842ee5e5aa8e8">AST_BRIDGE_IGNORE_SIGS</a>)) {
<a name="l03882"></a>03882          <span class="keywordtype">int</span> bridge_exit = 0;
<a name="l03883"></a>03883 
<a name="l03884"></a>03884          <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l03885"></a>03885          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>:
<a name="l03886"></a>03886          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>:
<a name="l03887"></a>03887          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>:
<a name="l03888"></a>03888             <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(other, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l03889"></a>03889             <span class="keywordflow">break</span>;
<a name="l03890"></a>03890          <span class="keywordflow">default</span>:
<a name="l03891"></a>03891             *fo = f;
<a name="l03892"></a>03892             *rc = who;
<a name="l03893"></a>03893             bridge_exit = 1;
<a name="l03894"></a>03894             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03895"></a>03895                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Got a FRAME_CONTROL (%d) frame on channel %s\n"</span>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, who-&gt;name);
<a name="l03896"></a>03896             <span class="keywordflow">break</span>;
<a name="l03897"></a>03897          }
<a name="l03898"></a>03898          <span class="keywordflow">if</span> (bridge_exit)
<a name="l03899"></a>03899             <span class="keywordflow">break</span>;
<a name="l03900"></a>03900       }
<a name="l03901"></a>03901       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) ||
<a name="l03902"></a>03902           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>) ||
<a name="l03903"></a>03903           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#41e7a80287a24ece13159c2d8b1b9375">AST_FRAME_DTMF</a>) ||
<a name="l03904"></a>03904           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92f3104666df07b461099e43be37983393">AST_FRAME_VIDEO</a>) ||
<a name="l03905"></a>03905           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927e5b7994ea6aabfce7d738e4c8278e1e">AST_FRAME_IMAGE</a>) ||
<a name="l03906"></a>03906           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92a9ac2233f0025ec1b3d23e720cee92be">AST_FRAME_HTML</a>) ||
<a name="l03907"></a>03907           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9258a9185f9370d3f1076917c963b0de50">AST_FRAME_MODEM</a>) ||
<a name="l03908"></a>03908           (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92696800d27feca415d5c80113fb740f44">AST_FRAME_TEXT</a>)) {
<a name="l03909"></a>03909          <span class="comment">/* monitored dtmf causes exit from bridge */</span>
<a name="l03910"></a>03910          <span class="keywordtype">int</span> monitored_source = (who == c0) ? watch_c0_dtmf : watch_c1_dtmf;
<a name="l03911"></a>03911 
<a name="l03912"></a>03912          <span class="keywordflow">if</span> (monitored_source &amp;&amp; 
<a name="l03913"></a>03913             (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a> || 
<a name="l03914"></a>03914             f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>)) {
<a name="l03915"></a>03915             *fo = f;
<a name="l03916"></a>03916             *rc = who;
<a name="l03917"></a>03917             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03918"></a>03918                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Got DTMF %s on channel (%s)\n"</span>, 
<a name="l03919"></a>03919                   f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a> ? <span class="stringliteral">"end"</span> : <span class="stringliteral">"begin"</span>,
<a name="l03920"></a>03920                   who-&gt;name);
<a name="l03921"></a>03921             <span class="keywordflow">break</span>;
<a name="l03922"></a>03922          }
<a name="l03923"></a>03923          <span class="comment">/* Write immediately frames, not passed through jb */</span>
<a name="l03924"></a>03924          <span class="keywordflow">if</span> (!frame_put_in_jb)
<a name="l03925"></a>03925             <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(other, f);
<a name="l03926"></a>03926             
<a name="l03927"></a>03927          <span class="comment">/* Check if we have to deliver now */</span>
<a name="l03928"></a>03928          <span class="keywordflow">if</span> (jb_in_use)
<a name="l03929"></a>03929             <a class="code" href="abstract__jb_8c.html#7c4d2833527a961fc976861441579116">ast_jb_get_and_deliver</a>(c0, c1);
<a name="l03930"></a>03930       }
<a name="l03931"></a>03931       <span class="comment">/* XXX do we want to pass on also frames not matched above ? */</span>
<a name="l03932"></a>03932       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l03933"></a>03933 
<a name="l03934"></a>03934       <span class="comment">/* Swap who gets priority */</span>
<a name="l03935"></a>03935       cs[2] = cs[0];
<a name="l03936"></a>03936       cs[0] = cs[1];
<a name="l03937"></a>03937       cs[1] = cs[2];
<a name="l03938"></a>03938    }
<a name="l03939"></a>03939    <span class="keywordflow">return</span> res;
<a name="l03940"></a>03940 }
<a name="l03941"></a>03941 <span class="comment"></span>
<a name="l03942"></a>03942 <span class="comment">/*! \brief Bridge two channels together (early) */</span>
<a name="l03943"></a><a class="code" href="channel_8h.html#4d00d0fe6e56604455705983fd7eb828">03943</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#4d00d0fe6e56604455705983fd7eb828">ast_channel_early_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c1)
<a name="l03944"></a>03944 {
<a name="l03945"></a>03945    <span class="comment">/* Make sure we can early bridge, if not error out */</span>
<a name="l03946"></a>03946    <span class="keywordflow">if</span> (!c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#e648abe892e6f95be12bfc78cf0bf5fe">early_bridge</a> || (c1 &amp;&amp; (!c1-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#e648abe892e6f95be12bfc78cf0bf5fe">early_bridge</a> || c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#e648abe892e6f95be12bfc78cf0bf5fe">early_bridge</a> != c1-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#e648abe892e6f95be12bfc78cf0bf5fe">early_bridge</a>)))
<a name="l03947"></a>03947       <span class="keywordflow">return</span> -1;
<a name="l03948"></a>03948 
<a name="l03949"></a>03949    <span class="keywordflow">return</span> c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#e648abe892e6f95be12bfc78cf0bf5fe">early_bridge</a>(c0, c1);
<a name="l03950"></a>03950 }
<a name="l03951"></a>03951 <span class="comment"></span>
<a name="l03952"></a>03952 <span class="comment">/*! \brief Bridge two channels together */</span>
<a name="l03953"></a><a class="code" href="channel_8h.html#63ab4d8e95fedaabf03d0f492368e930">03953</a> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19">ast_bridge_result</a> <a class="code" href="channel_8c.html#63ab4d8e95fedaabf03d0f492368e930">ast_channel_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c1,
<a name="l03954"></a>03954                  <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **rc)
<a name="l03955"></a>03955 {
<a name="l03956"></a>03956    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *who = NULL;
<a name="l03957"></a>03957    <span class="keyword">enum</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19">ast_bridge_result</a> res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19fd37b17491849eb3a8d0cd996d69fe1f">AST_BRIDGE_COMPLETE</a>;
<a name="l03958"></a>03958    <span class="keywordtype">int</span> nativefailed=0;
<a name="l03959"></a>03959    <span class="keywordtype">int</span> firstpass;
<a name="l03960"></a>03960    <span class="keywordtype">int</span> o0nativeformats;
<a name="l03961"></a>03961    <span class="keywordtype">int</span> o1nativeformats;
<a name="l03962"></a>03962    <span class="keywordtype">long</span> time_left_ms=0;
<a name="l03963"></a>03963    <span class="keyword">struct </span>timeval nexteventts = { 0, };
<a name="l03964"></a>03964    <span class="keywordtype">char</span> caller_warning = 0;
<a name="l03965"></a>03965    <span class="keywordtype">char</span> callee_warning = 0;
<a name="l03966"></a>03966 
<a name="l03967"></a>03967    <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>) {
<a name="l03968"></a>03968       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is already in a bridge with %s\n"</span>,
<a name="l03969"></a>03969          c0-&gt;name, c0-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>-&gt;name);
<a name="l03970"></a>03970       <span class="keywordflow">return</span> -1;
<a name="l03971"></a>03971    }
<a name="l03972"></a>03972    <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>) {
<a name="l03973"></a>03973       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is already in a bridge with %s\n"</span>,
<a name="l03974"></a>03974          c1-&gt;name, c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>-&gt;name);
<a name="l03975"></a>03975       <span class="keywordflow">return</span> -1;
<a name="l03976"></a>03976    }
<a name="l03977"></a>03977    
<a name="l03978"></a>03978    <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l03979"></a>03979    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">ast_check_hangup_locked</a>(c0) ||
<a name="l03980"></a>03980        <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">ast_check_hangup_locked</a>(c1))
<a name="l03981"></a>03981       <span class="keywordflow">return</span> -1;
<a name="l03982"></a>03982 
<a name="l03983"></a>03983    *fo = NULL;
<a name="l03984"></a>03984    firstpass = config-&gt;<a class="code" href="structast__bridge__config.html#b9313589eca257aaed154d3517ab7f0f">firstpass</a>;
<a name="l03985"></a>03985    config-&gt;<a class="code" href="structast__bridge__config.html#b9313589eca257aaed154d3517ab7f0f">firstpass</a> = 0;
<a name="l03986"></a>03986 
<a name="l03987"></a>03987    <span class="keywordflow">if</span> (ast_tvzero(config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>))
<a name="l03988"></a>03988       config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a> = ast_tvnow();
<a name="l03989"></a>03989    time_left_ms = config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>;
<a name="l03990"></a>03990 
<a name="l03991"></a>03991    caller_warning = <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;config-&gt;<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>, <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04040ce118987e724063d0b58eafd9b4f">AST_FEATURE_PLAY_WARNING</a>);
<a name="l03992"></a>03992    callee_warning = <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;config-&gt;<a class="code" href="structast__bridge__config.html#fa6efc124166cce0351265506b27ec86">features_callee</a>, <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04040ce118987e724063d0b58eafd9b4f">AST_FEATURE_PLAY_WARNING</a>);
<a name="l03993"></a>03993 
<a name="l03994"></a>03994    <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#2dd6d1b658d4294b5eefd558b669488e">start_sound</a> &amp;&amp; firstpass) {
<a name="l03995"></a>03995       <span class="keywordflow">if</span> (caller_warning)
<a name="l03996"></a>03996          <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c0, c1, config-&gt;<a class="code" href="structast__bridge__config.html#2dd6d1b658d4294b5eefd558b669488e">start_sound</a>, time_left_ms / 1000);
<a name="l03997"></a>03997       <span class="keywordflow">if</span> (callee_warning)
<a name="l03998"></a>03998          <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c1, c0, config-&gt;<a class="code" href="structast__bridge__config.html#2dd6d1b658d4294b5eefd558b669488e">start_sound</a>, time_left_ms / 1000);
<a name="l03999"></a>03999    }
<a name="l04000"></a>04000 
<a name="l04001"></a>04001    <span class="comment">/* Keep track of bridge */</span>
<a name="l04002"></a>04002    c0-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = c1;
<a name="l04003"></a>04003    c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = c0;
<a name="l04004"></a>04004 
<a name="l04005"></a>04005    <span class="comment">/* \todo  XXX here should check that cid_num is not NULL */</span>
<a name="l04006"></a>04006    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Link"</span>,
<a name="l04007"></a>04007             <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l04008"></a>04008             <span class="stringliteral">"Channel2: %s\r\n"</span>
<a name="l04009"></a>04009             <span class="stringliteral">"Uniqueid1: %s\r\n"</span>
<a name="l04010"></a>04010             <span class="stringliteral">"Uniqueid2: %s\r\n"</span>
<a name="l04011"></a>04011             <span class="stringliteral">"CallerID1: %s\r\n"</span>
<a name="l04012"></a>04012             <span class="stringliteral">"CallerID2: %s\r\n"</span>,
<a name="l04013"></a>04013             c0-&gt;name, c1-&gt;name, c0-&gt;uniqueid, c1-&gt;uniqueid, c0-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, c1-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l04014"></a>04014 
<a name="l04015"></a>04015    o0nativeformats = c0-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l04016"></a>04016    o1nativeformats = c1-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l04017"></a>04017 
<a name="l04018"></a>04018    <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a>) {
<a name="l04019"></a>04019       nexteventts = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>, ast_samp2tv(config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a>, 1000));
<a name="l04020"></a>04020    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>) {
<a name="l04021"></a>04021       nexteventts = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>, ast_samp2tv(config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>, 1000));
<a name="l04022"></a>04022       <span class="keywordflow">if</span> (caller_warning || callee_warning)
<a name="l04023"></a>04023          nexteventts = <a class="code" href="utils_8c.html#fd14d2161a764b21024b6623154e5f9d">ast_tvsub</a>(nexteventts, ast_samp2tv(config-&gt;<a class="code" href="structast__bridge__config.html#09928184e097afa29194fffb0063815f">play_warning</a>, 1000));
<a name="l04024"></a>04024    }
<a name="l04025"></a>04025 
<a name="l04026"></a>04026    <span class="keywordflow">if</span> (!c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>)
<a name="l04027"></a>04027       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l04028"></a>04028    <span class="keywordflow">if</span> (!c1-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#6ae7eea3e6476134e4193e09abb5dff3">send_digit_begin</a>)
<a name="l04029"></a>04029       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l04030"></a>04030 
<a name="l04031"></a>04031    <span class="keywordflow">for</span> (<span class="comment">/* ever */</span>;;) {
<a name="l04032"></a>04032       <span class="keyword">struct </span>timeval now = { 0, };
<a name="l04033"></a>04033       <span class="keywordtype">int</span> to;
<a name="l04034"></a>04034 
<a name="l04035"></a>04035       to = -1;
<a name="l04036"></a>04036 
<a name="l04037"></a>04037       <span class="keywordflow">if</span> (!ast_tvzero(nexteventts)) {
<a name="l04038"></a>04038          now = ast_tvnow();
<a name="l04039"></a>04039          to = ast_tvdiff_ms(nexteventts, now);
<a name="l04040"></a>04040          <span class="keywordflow">if</span> (to &lt;= 0) {
<a name="l04041"></a>04041             <span class="keywordflow">if</span> (!config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>) {
<a name="l04042"></a>04042                res = <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19fd37b17491849eb3a8d0cd996d69fe1f">AST_BRIDGE_COMPLETE</a>;
<a name="l04043"></a>04043                <span class="keywordflow">break</span>;
<a name="l04044"></a>04044             }
<a name="l04045"></a>04045             to = 0;
<a name="l04046"></a>04046          }
<a name="l04047"></a>04047       }
<a name="l04048"></a>04048 
<a name="l04049"></a>04049       <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>) {
<a name="l04050"></a>04050          time_left_ms = config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a> - ast_tvdiff_ms(now, config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>);
<a name="l04051"></a>04051          <span class="keywordflow">if</span> (time_left_ms &lt; to)
<a name="l04052"></a>04052             to = time_left_ms;
<a name="l04053"></a>04053 
<a name="l04054"></a>04054          <span class="keywordflow">if</span> (time_left_ms &lt;= 0) {
<a name="l04055"></a>04055             <span class="keywordflow">if</span> (caller_warning &amp;&amp; config-&gt;<a class="code" href="structast__bridge__config.html#9a91b3041002dbc3bdeef606ad9a28be">end_sound</a>)
<a name="l04056"></a>04056                <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c0, c1, config-&gt;<a class="code" href="structast__bridge__config.html#9a91b3041002dbc3bdeef606ad9a28be">end_sound</a>, 0);
<a name="l04057"></a>04057             <span class="keywordflow">if</span> (callee_warning &amp;&amp; config-&gt;<a class="code" href="structast__bridge__config.html#9a91b3041002dbc3bdeef606ad9a28be">end_sound</a>)
<a name="l04058"></a>04058                <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c1, c0, config-&gt;<a class="code" href="structast__bridge__config.html#9a91b3041002dbc3bdeef606ad9a28be">end_sound</a>, 0);
<a name="l04059"></a>04059             *fo = NULL;
<a name="l04060"></a>04060             <span class="keywordflow">if</span> (who)
<a name="l04061"></a>04061                *rc = who;
<a name="l04062"></a>04062             res = 0;
<a name="l04063"></a>04063             <span class="keywordflow">break</span>;
<a name="l04064"></a>04064          }
<a name="l04065"></a>04065          
<a name="l04066"></a>04066          <span class="keywordflow">if</span> (!to) {
<a name="l04067"></a>04067             <span class="keywordflow">if</span> (time_left_ms &gt;= 5000 &amp;&amp; config-&gt;<a class="code" href="structast__bridge__config.html#9e189dff12c1fb230c009fc4ab527943">warning_sound</a> &amp;&amp; config-&gt;<a class="code" href="structast__bridge__config.html#09928184e097afa29194fffb0063815f">play_warning</a>) {
<a name="l04068"></a>04068                <span class="keywordtype">int</span> t = (time_left_ms + 500) / 1000; <span class="comment">/* round to nearest second */</span>
<a name="l04069"></a>04069                <span class="keywordflow">if</span> (caller_warning)
<a name="l04070"></a>04070                   <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c0, c1, config-&gt;<a class="code" href="structast__bridge__config.html#9e189dff12c1fb230c009fc4ab527943">warning_sound</a>, t);
<a name="l04071"></a>04071                <span class="keywordflow">if</span> (callee_warning)
<a name="l04072"></a>04072                   <a class="code" href="channel_8c.html#5acc06bc5b686545ac14a9906edd53fb">bridge_playfile</a>(c1, c0, config-&gt;<a class="code" href="structast__bridge__config.html#9e189dff12c1fb230c009fc4ab527943">warning_sound</a>, t);
<a name="l04073"></a>04073             }
<a name="l04074"></a>04074             <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#fcf98f20f13092d41dfe08cb2aec545b">warning_freq</a> &amp;&amp; (time_left_ms &gt; (config-&gt;<a class="code" href="structast__bridge__config.html#fcf98f20f13092d41dfe08cb2aec545b">warning_freq</a> + 5000)))
<a name="l04075"></a>04075                nexteventts = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(nexteventts, ast_samp2tv(config-&gt;<a class="code" href="structast__bridge__config.html#fcf98f20f13092d41dfe08cb2aec545b">warning_freq</a>, 1000));
<a name="l04076"></a>04076             <span class="keywordflow">else</span>
<a name="l04077"></a>04077                nexteventts = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>, ast_samp2tv(config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a>, 1000));
<a name="l04078"></a>04078          }
<a name="l04079"></a>04079       }
<a name="l04080"></a>04080 
<a name="l04081"></a>04081       <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a> || c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>) {
<a name="l04082"></a>04082          <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>)
<a name="l04083"></a>04083             c0-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l04084"></a>04084          <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>)
<a name="l04085"></a>04085             c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l04086"></a>04086          c0-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = c1;
<a name="l04087"></a>04087          c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = c0;
<a name="l04088"></a>04088          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04089"></a>04089             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Unbridge signal received. Ending native bridge.\n"</span>);
<a name="l04090"></a>04090          <span class="keywordflow">continue</span>;
<a name="l04091"></a>04091       }
<a name="l04092"></a>04092       
<a name="l04093"></a>04093       <span class="comment">/* Stop if we're a zombie or need a soft hangup */</span>
<a name="l04094"></a>04094       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">ast_check_hangup_locked</a>(c0) ||
<a name="l04095"></a>04095           <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) || <a class="code" href="channel_8c.html#f72ecf6c6a107f089ffe657ff4c1e9b2">ast_check_hangup_locked</a>(c1)) {
<a name="l04096"></a>04096          *fo = NULL;
<a name="l04097"></a>04097          <span class="keywordflow">if</span> (who)
<a name="l04098"></a>04098             *rc = who;
<a name="l04099"></a>04099          res = 0;
<a name="l04100"></a>04100          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04101"></a>04101             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Bridge stops because we're zombie or need a soft hangup: c0=%s, c1=%s, flags: %s,%s,%s,%s\n"</span>,
<a name="l04102"></a>04102                c0-&gt;name, c1-&gt;name,
<a name="l04103"></a>04103                <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>,
<a name="l04104"></a>04104                <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(c0) ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>,
<a name="l04105"></a>04105                <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73003b8f6382b28b120cf101972539ed03d5">AST_FLAG_ZOMBIE</a>) ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>,
<a name="l04106"></a>04106                <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(c1) ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>);
<a name="l04107"></a>04107          <span class="keywordflow">break</span>;
<a name="l04108"></a>04108       }
<a name="l04109"></a>04109 
<a name="l04110"></a>04110       <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#4c0be0704b102072d0c6885e304ee6a3">bridge</a> &amp;&amp;
<a name="l04111"></a>04111           (config-&gt;<a class="code" href="structast__bridge__config.html#c20456384feb648b4692b700ec570d42">timelimit</a> == 0) &amp;&amp;
<a name="l04112"></a>04112           (c0-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#4c0be0704b102072d0c6885e304ee6a3">bridge</a> == c1-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#4c0be0704b102072d0c6885e304ee6a3">bridge</a>) &amp;&amp;
<a name="l04113"></a>04113           !nativefailed &amp;&amp; !c0-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> &amp;&amp; !c1-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> &amp;&amp;
<a name="l04114"></a>04114           !c0-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> &amp;&amp; !c1-&gt;<a class="code" href="structast__channel.html#5e6a55de0bea527db5f05883c77f39a6">spies</a> &amp;&amp; !<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#fa6efc124166cce0351265506b27ec86">features_callee</a>),<a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>) &amp;&amp;
<a name="l04115"></a>04115           !<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>),<a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>) ) {
<a name="l04116"></a>04116          <span class="comment">/* Looks like they share a bridge method and nothing else is in the way */</span>
<a name="l04117"></a>04117          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04118"></a>04118          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04119"></a>04119          <span class="keywordflow">if</span> ((res = c0-&gt;tech-&gt;bridge(c0, c1, config-&gt;<a class="code" href="structast__bridge__config.html#4e5868d676cb634aa75b125a0f741abf">flags</a>, fo, rc, to)) == <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19fd37b17491849eb3a8d0cd996d69fe1f">AST_BRIDGE_COMPLETE</a>) {
<a name="l04120"></a>04120             <span class="comment">/* \todo  XXX here should check that cid_num is not NULL */</span>
<a name="l04121"></a>04121             <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Unlink"</span>,
<a name="l04122"></a>04122                      <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l04123"></a>04123                      <span class="stringliteral">"Channel2: %s\r\n"</span>
<a name="l04124"></a>04124                      <span class="stringliteral">"Uniqueid1: %s\r\n"</span>
<a name="l04125"></a>04125                      <span class="stringliteral">"Uniqueid2: %s\r\n"</span>
<a name="l04126"></a>04126                      <span class="stringliteral">"CallerID1: %s\r\n"</span>
<a name="l04127"></a>04127                      <span class="stringliteral">"CallerID2: %s\r\n"</span>,
<a name="l04128"></a>04128                      c0-&gt;name, c1-&gt;name, c0-&gt;uniqueid, c1-&gt;uniqueid, c0-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, c1-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l04129"></a>04129             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04130"></a>04130                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Returning from native bridge, channels: %s, %s\n"</span>, c0-&gt;name, c1-&gt;name);
<a name="l04131"></a>04131 
<a name="l04132"></a>04132             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04133"></a>04133             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04134"></a>04134 
<a name="l04135"></a>04135             <span class="keywordflow">if</span> (c0-&gt;_softhangup == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a> || c1-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> == <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1f3fe293730d3200b678a1daaa67ea5c5">AST_SOFTHANGUP_UNBRIDGE</a>)
<a name="l04136"></a>04136                <span class="keywordflow">continue</span>;
<a name="l04137"></a>04137 
<a name="l04138"></a>04138             c0-&gt;_bridge = NULL;
<a name="l04139"></a>04139             c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = NULL;
<a name="l04140"></a>04140 
<a name="l04141"></a>04141             <span class="keywordflow">return</span> res;
<a name="l04142"></a>04142          } <span class="keywordflow">else</span> {
<a name="l04143"></a>04143             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04144"></a>04144             <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300b38fcf240d912cfa60d488dea99cab31">AST_FLAG_NBRIDGE</a>);
<a name="l04145"></a>04145          }
<a name="l04146"></a>04146          <span class="keywordflow">switch</span> (res) {
<a name="l04147"></a>04147          <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19ebe331af24cd5342764adc6f1b59fbec">AST_BRIDGE_RETRY</a>:
<a name="l04148"></a>04148             <span class="keywordflow">continue</span>;
<a name="l04149"></a>04149          <span class="keywordflow">default</span>:
<a name="l04150"></a>04150             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l04151"></a>04151                <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Native bridging %s and %s ended\n"</span>,
<a name="l04152"></a>04152                       c0-&gt;name, c1-&gt;name);
<a name="l04153"></a>04153             <span class="comment">/* fallthrough */</span>
<a name="l04154"></a>04154          <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19c05a72efa9f8f1c8ebcfaf8e6fe97524">AST_BRIDGE_FAILED_NOWARN</a>:
<a name="l04155"></a>04155             nativefailed++;
<a name="l04156"></a>04156             <span class="keywordflow">break</span>;
<a name="l04157"></a>04157          }
<a name="l04158"></a>04158       }
<a name="l04159"></a>04159    
<a name="l04160"></a>04160       <span class="keywordflow">if</span> (((c0-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> != c1-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>) || (c0-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> != c1-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>) ||
<a name="l04161"></a>04161           (c0-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a> != o0nativeformats) || (c1-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a> != o1nativeformats)) &amp;&amp;
<a name="l04162"></a>04162           !(c0-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a> || c1-&gt;<a class="code" href="structast__channel.html#dac9630aec642a428cd73f4be0a03569">generator</a>)) {
<a name="l04163"></a>04163          <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(c0, c1)) {
<a name="l04164"></a>04164             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't make %s and %s compatible\n"</span>, c0-&gt;name, c1-&gt;name);
<a name="l04165"></a>04165             <span class="comment">/* \todo  XXX here should check that cid_num is not NULL */</span>
<a name="l04166"></a>04166                                 <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Unlink"</span>,
<a name="l04167"></a>04167                      <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l04168"></a>04168                      <span class="stringliteral">"Channel2: %s\r\n"</span>
<a name="l04169"></a>04169                      <span class="stringliteral">"Uniqueid1: %s\r\n"</span>
<a name="l04170"></a>04170                      <span class="stringliteral">"Uniqueid2: %s\r\n"</span>
<a name="l04171"></a>04171                      <span class="stringliteral">"CallerID1: %s\r\n"</span>
<a name="l04172"></a>04172                      <span class="stringliteral">"CallerID2: %s\r\n"</span>,
<a name="l04173"></a>04173                      c0-&gt;name, c1-&gt;name, c0-&gt;uniqueid, c1-&gt;uniqueid, c0-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, c1-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l04174"></a>04174             <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d198b00ec8ed330d763fd4f579d7c513d1d">AST_BRIDGE_FAILED</a>;
<a name="l04175"></a>04175          }
<a name="l04176"></a>04176          o0nativeformats = c0-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l04177"></a>04177          o1nativeformats = c1-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>;
<a name="l04178"></a>04178       }
<a name="l04179"></a>04179       res = <a class="code" href="channel_8c.html#4f79ef2dc27d26c29b18b9ab40b5d56b">ast_generic_bridge</a>(c0, c1, config, fo, rc, nexteventts);
<a name="l04180"></a>04180       <span class="keywordflow">if</span> (res != <a class="code" href="channel_8h.html#8bba128582c81d1af777c11278bd4d19ebe331af24cd5342764adc6f1b59fbec">AST_BRIDGE_RETRY</a>)
<a name="l04181"></a>04181          <span class="keywordflow">break</span>;
<a name="l04182"></a>04182    }
<a name="l04183"></a>04183 
<a name="l04184"></a>04184    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c0, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l04185"></a>04185    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(c1, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a73000ecdf5f8a5869727e38bf9e1ca5a6cae">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l04186"></a>04186 
<a name="l04187"></a>04187    c0-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = NULL;
<a name="l04188"></a>04188    c1-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a> = NULL;
<a name="l04189"></a>04189 
<a name="l04190"></a>04190    <span class="comment">/* \todo  XXX here should check that cid_num is not NULL */</span>
<a name="l04191"></a>04191    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"Unlink"</span>,
<a name="l04192"></a>04192             <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l04193"></a>04193             <span class="stringliteral">"Channel2: %s\r\n"</span>
<a name="l04194"></a>04194             <span class="stringliteral">"Uniqueid1: %s\r\n"</span>
<a name="l04195"></a>04195             <span class="stringliteral">"Uniqueid2: %s\r\n"</span>
<a name="l04196"></a>04196             <span class="stringliteral">"CallerID1: %s\r\n"</span>
<a name="l04197"></a>04197             <span class="stringliteral">"CallerID2: %s\r\n"</span>,
<a name="l04198"></a>04198             c0-&gt;name, c1-&gt;name, c0-&gt;uniqueid, c1-&gt;uniqueid, c0-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, c1-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>);
<a name="l04199"></a>04199    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04200"></a>04200       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Bridge stops bridging channels %s and %s\n"</span>, c0-&gt;name, c1-&gt;name);
<a name="l04201"></a>04201 
<a name="l04202"></a>04202    <span class="keywordflow">return</span> res;
<a name="l04203"></a>04203 }
<a name="l04204"></a>04204 <span class="comment"></span>
<a name="l04205"></a>04205 <span class="comment">/*! \brief Sets an option on a channel */</span>
<a name="l04206"></a><a class="code" href="channel_8h.html#8455f544c874bf1316d542cec38a2ab9">04206</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#fd050188748d1697051e8176fb5fee36">ast_channel_setoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> option, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> datalen, <span class="keywordtype">int</span> block)
<a name="l04207"></a>04207 {
<a name="l04208"></a>04208    <span class="keywordtype">int</span> res;
<a name="l04209"></a>04209 
<a name="l04210"></a>04210    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#23d58d6d97fa0932dda059f8b09d62e0">setoption</a>) {
<a name="l04211"></a>04211       res = chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#23d58d6d97fa0932dda059f8b09d62e0">setoption</a>(chan, option, data, datalen);
<a name="l04212"></a>04212       <span class="keywordflow">if</span> (res &lt; 0)
<a name="l04213"></a>04213          <span class="keywordflow">return</span> res;
<a name="l04214"></a>04214    } <span class="keywordflow">else</span> {
<a name="l04215"></a>04215       errno = ENOSYS;
<a name="l04216"></a>04216       <span class="keywordflow">return</span> -1;
<a name="l04217"></a>04217    }
<a name="l04218"></a>04218    <span class="keywordflow">if</span> (block) {
<a name="l04219"></a>04219       <span class="comment">/* XXX Implement blocking -- just wait for our option frame reply, discarding</span>
<a name="l04220"></a>04220 <span class="comment">         intermediate packets. XXX */</span>
<a name="l04221"></a>04221       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"XXX Blocking not implemented yet XXX\n"</span>);
<a name="l04222"></a>04222       <span class="keywordflow">return</span> -1;
<a name="l04223"></a>04223    }
<a name="l04224"></a>04224    <span class="keywordflow">return</span> 0;
<a name="l04225"></a>04225 }
<a name="l04226"></a>04226 
<a name="l04227"></a><a class="code" href="structtonepair__def.html">04227</a> <span class="keyword">struct </span><a class="code" href="structtonepair__def.html">tonepair_def</a> {
<a name="l04228"></a><a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">04228</a>    <span class="keywordtype">int</span> freq1;
<a name="l04229"></a><a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">04229</a>    <span class="keywordtype">int</span> freq2;
<a name="l04230"></a><a class="code" href="structtonepair__def.html#b85ec314bf443b797ef8a66b3b03f8a4">04230</a>    <span class="keywordtype">int</span> duration;
<a name="l04231"></a><a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">04231</a>    <span class="keywordtype">int</span> vol;
<a name="l04232"></a>04232 };
<a name="l04233"></a>04233 
<a name="l04234"></a><a class="code" href="structtonepair__state.html">04234</a> <span class="keyword">struct </span><a class="code" href="structtonepair__state.html">tonepair_state</a> {
<a name="l04235"></a><a class="code" href="structtonepair__state.html#7874a31cb70449f5854eb3d86cb15dde">04235</a>    <span class="keywordtype">int</span> fac1;
<a name="l04236"></a><a class="code" href="structtonepair__state.html#151fb3908501dd115d22330471c438cb">04236</a>    <span class="keywordtype">int</span> fac2;
<a name="l04237"></a><a class="code" href="structtonepair__state.html#4f397565e46919bce9d36b3c6a9cafc0">04237</a>    <span class="keywordtype">int</span> v1_1;
<a name="l04238"></a><a class="code" href="structtonepair__state.html#c2222e1f89d77cabb87e1622253f8ab0">04238</a>    <span class="keywordtype">int</span> v2_1;
<a name="l04239"></a><a class="code" href="structtonepair__state.html#3fce96fee06d49ae6172f00121123837">04239</a>    <span class="keywordtype">int</span> v3_1;
<a name="l04240"></a><a class="code" href="structtonepair__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">04240</a>    <span class="keywordtype">int</span> v1_2;
<a name="l04241"></a><a class="code" href="structtonepair__state.html#44c182d153f336e0e823a8293472af14">04241</a>    <span class="keywordtype">int</span> v2_2;
<a name="l04242"></a><a class="code" href="structtonepair__state.html#31905888f7d6f7dfd2b88beb2763646e">04242</a>    <span class="keywordtype">int</span> v3_2;
<a name="l04243"></a><a class="code" href="structtonepair__state.html#b3001a6ee2c48154e670d0b11806bfac">04243</a>    <span class="keywordtype">int</span> origwfmt;
<a name="l04244"></a><a class="code" href="structtonepair__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">04244</a>    <span class="keywordtype">int</span> pos;
<a name="l04245"></a><a class="code" href="structtonepair__state.html#b85ec314bf443b797ef8a66b3b03f8a4">04245</a>    <span class="keywordtype">int</span> duration;
<a name="l04246"></a><a class="code" href="structtonepair__state.html#15e95cb1264e3dfced379f625e5773d3">04246</a>    <span class="keywordtype">int</span> modulate;
<a name="l04247"></a><a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">04247</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f;
<a name="l04248"></a><a class="code" href="structtonepair__state.html#2415fcbd6a0c6ae3edd8e4012db4dd40">04248</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>[<a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>];
<a name="l04249"></a><a class="code" href="structtonepair__state.html#2f4b8456c4e369259547c6c0728dbad8">04249</a>    <span class="keywordtype">short</span> <a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>[4000];
<a name="l04250"></a>04250 };
<a name="l04251"></a>04251 
<a name="l04252"></a><a class="code" href="channel_8c.html#4a0a43b1e38bf4893144d753ea8273bb">04252</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#4a0a43b1e38bf4893144d753ea8273bb">tonepair_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)
<a name="l04253"></a>04253 {
<a name="l04254"></a>04254    <span class="keyword">struct </span><a class="code" href="structtonepair__state.html">tonepair_state</a> *ts = params;
<a name="l04255"></a>04255 
<a name="l04256"></a>04256    <span class="keywordflow">if</span> (chan)
<a name="l04257"></a>04257       <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, ts-&gt;<a class="code" href="structtonepair__state.html#b3001a6ee2c48154e670d0b11806bfac">origwfmt</a>);
<a name="l04258"></a>04258    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ts);
<a name="l04259"></a>04259 }
<a name="l04260"></a>04260 
<a name="l04261"></a><a class="code" href="channel_8c.html#dd972695f4d3b955d57458579a5509c3">04261</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="channel_8c.html#dd972695f4d3b955d57458579a5509c3">tonepair_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)
<a name="l04262"></a>04262 {
<a name="l04263"></a>04263    <span class="keyword">struct </span><a class="code" href="structtonepair__state.html">tonepair_state</a> *ts;
<a name="l04264"></a>04264    <span class="keyword">struct </span><a class="code" href="structtonepair__def.html">tonepair_def</a> *td = params;
<a name="l04265"></a>04265 
<a name="l04266"></a>04266    <span class="keywordflow">if</span> (!(ts = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ts))))
<a name="l04267"></a>04267       <span class="keywordflow">return</span> NULL;
<a name="l04268"></a>04268    ts-&gt;origwfmt = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l04269"></a>04269    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l04270"></a>04270       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set '%s' to signed linear format (write)\n"</span>, chan-&gt;name);
<a name="l04271"></a>04271       <a class="code" href="channel_8c.html#4a0a43b1e38bf4893144d753ea8273bb">tonepair_release</a>(NULL, ts);
<a name="l04272"></a>04272       ts = NULL;
<a name="l04273"></a>04273    } <span class="keywordflow">else</span> {
<a name="l04274"></a>04274       ts-&gt;fac1 = 2.0 * <a class="code" href="chan__h323_8c.html#4d00d79b6733c9cc066584a02ed03410">cos</a>(2.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">freq1</a> / 8000.0)) * 32768.0;
<a name="l04275"></a>04275       ts-&gt;v1_1 = 0;
<a name="l04276"></a>04276       ts-&gt;v2_1 = sin(-4.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">freq1</a> / 8000.0)) * td-&gt;<a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l04277"></a>04277       ts-&gt;v3_1 = sin(-2.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">freq1</a> / 8000.0)) * td-&gt;<a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l04278"></a>04278       ts-&gt;v2_1 = 0;
<a name="l04279"></a>04279       ts-&gt;fac2 = 2.0 * <a class="code" href="chan__h323_8c.html#4d00d79b6733c9cc066584a02ed03410">cos</a>(2.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">freq2</a> / 8000.0)) * 32768.0;
<a name="l04280"></a>04280       ts-&gt;v2_2 = sin(-4.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">freq2</a> / 8000.0)) * td-&gt;<a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l04281"></a>04281       ts-&gt;v3_2 = sin(-2.0 * M_PI * (td-&gt;<a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">freq2</a> / 8000.0)) * td-&gt;<a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l04282"></a>04282       ts-&gt;duration = td-&gt;<a class="code" href="structtonepair__def.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a>;
<a name="l04283"></a>04283       ts-&gt;modulate = 0;
<a name="l04284"></a>04284    }
<a name="l04285"></a>04285    <span class="comment">/* Let interrupts interrupt :) */</span>
<a name="l04286"></a>04286    <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730015fb5a488ff560040b677433b270fb5e">AST_FLAG_WRITE_INT</a>);
<a name="l04287"></a>04287    <span class="keywordflow">return</span> ts;
<a name="l04288"></a>04288 }
<a name="l04289"></a>04289 
<a name="l04290"></a><a class="code" href="channel_8c.html#1da8f1ae85508a5cf259bed9a8620b0a">04290</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#1da8f1ae85508a5cf259bed9a8620b0a">tonepair_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, <span class="keywordtype">int</span> samples)
<a name="l04291"></a>04291 {
<a name="l04292"></a>04292    <span class="keyword">struct </span><a class="code" href="structtonepair__state.html">tonepair_state</a> *ts = data;
<a name="l04293"></a>04293    <span class="keywordtype">int</span> x;
<a name="l04294"></a>04294 
<a name="l04295"></a>04295    <span class="comment">/* we need to prepare a frame with 16 * timelen samples as we're</span>
<a name="l04296"></a>04296 <span class="comment">    * generating SLIN audio</span>
<a name="l04297"></a>04297 <span class="comment">    */</span>
<a name="l04298"></a>04298    len = samples * 2;
<a name="l04299"></a>04299 
<a name="l04300"></a>04300    <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(ts-&gt;<a class="code" href="structtonepair__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>) / 2 - 1) {
<a name="l04301"></a>04301       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't generate that much data!\n"</span>);
<a name="l04302"></a>04302       <span class="keywordflow">return</span> -1;
<a name="l04303"></a>04303    }
<a name="l04304"></a>04304    memset(&amp;ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>, 0, <span class="keyword">sizeof</span>(ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>));
<a name="l04305"></a>04305    <span class="keywordflow">for</span> (x=0;x&lt;len/2;x++) {
<a name="l04306"></a>04306       ts-&gt;<a class="code" href="structtonepair__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a> = ts-&gt;<a class="code" href="structtonepair__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a>;
<a name="l04307"></a>04307       ts-&gt;<a class="code" href="structtonepair__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a> = ts-&gt;<a class="code" href="structtonepair__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a>;
<a name="l04308"></a>04308       ts-&gt;<a class="code" href="structtonepair__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> = (ts-&gt;<a class="code" href="structtonepair__state.html#7874a31cb70449f5854eb3d86cb15dde">fac1</a> * ts-&gt;<a class="code" href="structtonepair__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a> &gt;&gt; 15) - ts-&gt;<a class="code" href="structtonepair__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a>;
<a name="l04309"></a>04309       
<a name="l04310"></a>04310       ts-&gt;<a class="code" href="structtonepair__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a> = ts-&gt;<a class="code" href="structtonepair__state.html#44c182d153f336e0e823a8293472af14">v2_2</a>;
<a name="l04311"></a>04311       ts-&gt;<a class="code" href="structtonepair__state.html#44c182d153f336e0e823a8293472af14">v2_2</a> = ts-&gt;<a class="code" href="structtonepair__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a>;
<a name="l04312"></a>04312       ts-&gt;<a class="code" href="structtonepair__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a> = (ts-&gt;<a class="code" href="structtonepair__state.html#151fb3908501dd115d22330471c438cb">fac2</a> * ts-&gt;<a class="code" href="structtonepair__state.html#44c182d153f336e0e823a8293472af14">v2_2</a> &gt;&gt; 15) - ts-&gt;<a class="code" href="structtonepair__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a>;
<a name="l04313"></a>04313       <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="structtonepair__state.html#15e95cb1264e3dfced379f625e5773d3">modulate</a>) {
<a name="l04314"></a>04314          <span class="keywordtype">int</span> p;
<a name="l04315"></a>04315          p = ts-&gt;<a class="code" href="structtonepair__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a> - 32768;
<a name="l04316"></a>04316          <span class="keywordflow">if</span> (p &lt; 0) p = -p;
<a name="l04317"></a>04317          p = ((p * 9) / 10) + 1;
<a name="l04318"></a>04318          ts-&gt;<a class="code" href="structtonepair__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>[x] = (ts-&gt;<a class="code" href="structtonepair__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> * p) &gt;&gt; 15;
<a name="l04319"></a>04319       } <span class="keywordflow">else</span>
<a name="l04320"></a>04320          ts-&gt;<a class="code" href="structtonepair__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>[x] = ts-&gt;<a class="code" href="structtonepair__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> + ts-&gt;<a class="code" href="structtonepair__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a>; 
<a name="l04321"></a>04321    }
<a name="l04322"></a>04322    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>;
<a name="l04323"></a>04323    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>;
<a name="l04324"></a>04324    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = len;
<a name="l04325"></a>04325    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> = samples;
<a name="l04326"></a>04326    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l04327"></a>04327    ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = ts-&gt;<a class="code" href="structtonepair__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>;
<a name="l04328"></a>04328    <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(chan, &amp;ts-&gt;<a class="code" href="structtonepair__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l04329"></a>04329    ts-&gt;<a class="code" href="structtonepair__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a> += x;
<a name="l04330"></a>04330    <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="structtonepair__state.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> &gt; 0) {
<a name="l04331"></a>04331       <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="structtonepair__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a> &gt;= ts-&gt;<a class="code" href="structtonepair__state.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> * 8)
<a name="l04332"></a>04332          <span class="keywordflow">return</span> -1;
<a name="l04333"></a>04333    }
<a name="l04334"></a>04334    <span class="keywordflow">return</span> 0;
<a name="l04335"></a>04335 }
<a name="l04336"></a>04336 
<a name="l04337"></a><a class="code" href="channel_8c.html#eb7077a8acd7946b1f81a9d8665b16ef">04337</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> tonepair = {
<a name="l04338"></a>04338    <a class="code" href="structast__generator.html#ec716dadc257b3894e8a1a75177d4283">alloc</a>: <a class="code" href="channel_8c.html#dd972695f4d3b955d57458579a5509c3">tonepair_alloc</a>,
<a name="l04339"></a>04339    <a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>: <a class="code" href="channel_8c.html#4a0a43b1e38bf4893144d753ea8273bb">tonepair_release</a>,
<a name="l04340"></a>04340    <a class="code" href="structast__generator.html#359c44da76fd570826dcd60f0f6da36c">generate</a>: <a class="code" href="channel_8c.html#1da8f1ae85508a5cf259bed9a8620b0a">tonepair_generator</a>,
<a name="l04341"></a>04341 };
<a name="l04342"></a>04342 
<a name="l04343"></a><a class="code" href="channel_8h.html#df9ad031f8e78a39603595ad088b0877">04343</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#df9ad031f8e78a39603595ad088b0877">ast_tonepair_start</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> freq1, <span class="keywordtype">int</span> freq2, <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> vol)
<a name="l04344"></a>04344 {
<a name="l04345"></a>04345    <span class="keyword">struct </span><a class="code" href="structtonepair__def.html">tonepair_def</a> d = { 0, };
<a name="l04346"></a>04346 
<a name="l04347"></a>04347    d.<a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">freq1</a> = freq1;
<a name="l04348"></a>04348    d.<a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">freq2</a> = freq2;
<a name="l04349"></a>04349    d.<a class="code" href="structtonepair__def.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> = duration;
<a name="l04350"></a>04350    d.<a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a> = (vol &lt; 1) ? 8192 : vol; <span class="comment">/* force invalid to 8192 */</span>
<a name="l04351"></a>04351    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#51350b9fba7a6a2428e1b3a13a131d54">ast_activate_generator</a>(chan, &amp;tonepair, &amp;d))
<a name="l04352"></a>04352       <span class="keywordflow">return</span> -1;
<a name="l04353"></a>04353    <span class="keywordflow">return</span> 0;
<a name="l04354"></a>04354 }
<a name="l04355"></a>04355 
<a name="l04356"></a><a class="code" href="channel_8h.html#547c90e9a23e85d52e4cfacbc5cb9f73">04356</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#547c90e9a23e85d52e4cfacbc5cb9f73">ast_tonepair_stop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l04357"></a>04357 {
<a name="l04358"></a>04358    <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l04359"></a>04359 }
<a name="l04360"></a>04360 
<a name="l04361"></a><a class="code" href="channel_8h.html#ae5bd12fec5fb4b99bf70379e02ba7a5">04361</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ae5bd12fec5fb4b99bf70379e02ba7a5">ast_tonepair</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> <a class="code" href="structtonepair__def.html#e7594ca7647a7bdd1b06f415835a5f57">freq1</a>, <span class="keywordtype">int</span> <a class="code" href="structtonepair__def.html#122628a6eae120b13983ec3feb760420">freq2</a>, <span class="keywordtype">int</span> <a class="code" href="structtonepair__def.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a>, <span class="keywordtype">int</span> <a class="code" href="structtonepair__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>)
<a name="l04362"></a>04362 {
<a name="l04363"></a>04363    <span class="keywordtype">int</span> res;
<a name="l04364"></a>04364 
<a name="l04365"></a>04365    <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8c.html#df9ad031f8e78a39603595ad088b0877">ast_tonepair_start</a>(chan, freq1, freq2, duration, vol)))
<a name="l04366"></a>04366       <span class="keywordflow">return</span> res;
<a name="l04367"></a>04367 
<a name="l04368"></a>04368    <span class="comment">/* Give us some wiggle room */</span>
<a name="l04369"></a>04369    <span class="keywordflow">while</span> (chan-&gt;<a class="code" href="structast__channel.html#68e80cee708fd0cdfb20807a8663721d">generatordata</a> &amp;&amp; <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(chan, 100) &gt;= 0) {
<a name="l04370"></a>04370       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l04371"></a>04371       <span class="keywordflow">if</span> (f)
<a name="l04372"></a>04372          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l04373"></a>04373       <span class="keywordflow">else</span>
<a name="l04374"></a>04374          <span class="keywordflow">return</span> -1;
<a name="l04375"></a>04375    }
<a name="l04376"></a>04376    <span class="keywordflow">return</span> 0;
<a name="l04377"></a>04377 }
<a name="l04378"></a>04378 
<a name="l04379"></a><a class="code" href="channel_8h.html#3afd78a60ecfe19f643ed5124981a023">04379</a> <a class="code" href="channel_8h.html#f46fa02de8676dd1b9163c5dd428e610">ast_group_t</a> <a class="code" href="channel_8c.html#3afd78a60ecfe19f643ed5124981a023">ast_get_group</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l04380"></a>04380 {
<a name="l04381"></a>04381    <span class="keywordtype">char</span> *piece;
<a name="l04382"></a>04382    <span class="keywordtype">char</span> *c;
<a name="l04383"></a>04383    <span class="keywordtype">int</span> start=0, finish=0, x;
<a name="l04384"></a>04384    <a class="code" href="channel_8h.html#f46fa02de8676dd1b9163c5dd428e610">ast_group_t</a> <a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a> = 0;
<a name="l04385"></a>04385 
<a name="l04386"></a>04386    c = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(s);
<a name="l04387"></a>04387    
<a name="l04388"></a>04388    <span class="keywordflow">while</span> ((piece = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;c, <span class="stringliteral">","</span>))) {
<a name="l04389"></a>04389       <span class="keywordflow">if</span> (sscanf(piece, <span class="stringliteral">"%d-%d"</span>, &amp;start, &amp;finish) == 2) {
<a name="l04390"></a>04390          <span class="comment">/* Range */</span>
<a name="l04391"></a>04391       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(piece, <span class="stringliteral">"%d"</span>, &amp;start)) {
<a name="l04392"></a>04392          <span class="comment">/* Just one */</span>
<a name="l04393"></a>04393          finish = start;
<a name="l04394"></a>04394       } <span class="keywordflow">else</span> {
<a name="l04395"></a>04395          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Syntax error parsing group configuration '%s' at '%s'. Ignoring.\n"</span>, s, piece);
<a name="l04396"></a>04396          <span class="keywordflow">continue</span>;
<a name="l04397"></a>04397       }
<a name="l04398"></a>04398       <span class="keywordflow">for</span> (x = start; x &lt;= finish; x++) {
<a name="l04399"></a>04399          <span class="keywordflow">if</span> ((x &gt; 63) || (x &lt; 0)) {
<a name="l04400"></a>04400             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Ignoring invalid group %d (maximum group is 63)\n"</span>, x);
<a name="l04401"></a>04401          } <span class="keywordflow">else</span>
<a name="l04402"></a>04402             group |= ((<a class="code" href="channel_8h.html#f46fa02de8676dd1b9163c5dd428e610">ast_group_t</a>) 1 &lt;&lt; x);
<a name="l04403"></a>04403       }
<a name="l04404"></a>04404    }
<a name="l04405"></a>04405    <span class="keywordflow">return</span> group;
<a name="l04406"></a>04406 }
<a name="l04407"></a>04407 
<a name="l04408"></a><a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">04408</a> <span class="keyword">static</span> int (*<a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">ast_moh_start_ptr</a>)(<span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *) = NULL;
<a name="l04409"></a><a class="code" href="channel_8c.html#6348f2aef7491f04aa84d26e670fd237">04409</a> <span class="keyword">static</span> <span class="keywordtype">void</span> (*<a class="code" href="channel_8c.html#6348f2aef7491f04aa84d26e670fd237">ast_moh_stop_ptr</a>)(<span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *) = NULL;
<a name="l04410"></a><a class="code" href="channel_8c.html#331ef01c56d45e93e327f7dfe8f34e2a">04410</a> <span class="keyword">static</span> <span class="keywordtype">void</span> (*<a class="code" href="channel_8c.html#331ef01c56d45e93e327f7dfe8f34e2a">ast_moh_cleanup_ptr</a>)(<span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *) = NULL;
<a name="l04411"></a>04411 
<a name="l04412"></a><a class="code" href="musiconhold_8h.html#8aa19b3c9b2ae3e35e726487f89a5671">04412</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#8aa19b3c9b2ae3e35e726487f89a5671">ast_install_music_functions</a>(<span class="keywordtype">int</span> (*start_ptr)(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *),
<a name="l04413"></a>04413              <span class="keywordtype">void</span> (*stop_ptr)(<span class="keyword">struct</span> ast_channel *),
<a name="l04414"></a>04414              <span class="keywordtype">void</span> (*cleanup_ptr)(<span class="keyword">struct</span> ast_channel *))
<a name="l04415"></a>04415 {
<a name="l04416"></a>04416    <a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">ast_moh_start_ptr</a> = start_ptr;
<a name="l04417"></a>04417    ast_moh_stop_ptr = stop_ptr;
<a name="l04418"></a>04418    ast_moh_cleanup_ptr = cleanup_ptr;
<a name="l04419"></a>04419 }
<a name="l04420"></a>04420 
<a name="l04421"></a><a class="code" href="musiconhold_8h.html#18b76b278491b079fc7ee95e4b64a5b7">04421</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#18b76b278491b079fc7ee95e4b64a5b7">ast_uninstall_music_functions</a>(<span class="keywordtype">void</span>)
<a name="l04422"></a>04422 {
<a name="l04423"></a>04423    <a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">ast_moh_start_ptr</a> = NULL;
<a name="l04424"></a>04424    ast_moh_stop_ptr = NULL;
<a name="l04425"></a>04425    ast_moh_cleanup_ptr = NULL;
<a name="l04426"></a>04426 }
<a name="l04427"></a>04427 <span class="comment"></span>
<a name="l04428"></a>04428 <span class="comment">/*! \brief Turn on music on hold on a given channel */</span>
<a name="l04429"></a><a class="code" href="musiconhold_8h.html#8b713a18df0470dcb9ad2b97c33b6e6a">04429</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#8b713a18df0470dcb9ad2b97c33b6e6a">ast_moh_start</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *interpclass)
<a name="l04430"></a>04430 {
<a name="l04431"></a>04431    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">ast_moh_start_ptr</a>)
<a name="l04432"></a>04432       <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#0fffdeb6ac5a772964006bde2a33b994">ast_moh_start_ptr</a>(chan, mclass, interpclass);
<a name="l04433"></a>04433 
<a name="l04434"></a>04434    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) {
<a name="l04435"></a>04435       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Music class %s requested but no musiconhold loaded.\n"</span>, 
<a name="l04436"></a>04436          mclass ? mclass : (interpclass ? interpclass : <span class="stringliteral">"default"</span>));
<a name="l04437"></a>04437    }
<a name="l04438"></a>04438 
<a name="l04439"></a>04439    <span class="keywordflow">return</span> 0;
<a name="l04440"></a>04440 }
<a name="l04441"></a>04441 <span class="comment"></span>
<a name="l04442"></a>04442 <span class="comment">/*! \brief Turn off music on hold on a given channel */</span>
<a name="l04443"></a><a class="code" href="musiconhold_8h.html#db35d3bab46e0655f359b751cdca0ce3">04443</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#db35d3bab46e0655f359b751cdca0ce3">ast_moh_stop</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04444"></a>04444 {
<a name="l04445"></a>04445    <span class="keywordflow">if</span> (ast_moh_stop_ptr)
<a name="l04446"></a>04446       <a class="code" href="channel_8c.html#6348f2aef7491f04aa84d26e670fd237">ast_moh_stop_ptr</a>(chan);
<a name="l04447"></a>04447 }
<a name="l04448"></a>04448 
<a name="l04449"></a><a class="code" href="musiconhold_8h.html#3c4d4ffc411bd181677307e95b6b8c7b">04449</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#3c4d4ffc411bd181677307e95b6b8c7b">ast_moh_cleanup</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04450"></a>04450 {
<a name="l04451"></a>04451    <span class="keywordflow">if</span> (ast_moh_cleanup_ptr)
<a name="l04452"></a>04452       <a class="code" href="channel_8c.html#331ef01c56d45e93e327f7dfe8f34e2a">ast_moh_cleanup_ptr</a>(chan);
<a name="l04453"></a>04453 }
<a name="l04454"></a>04454 
<a name="l04455"></a><a class="code" href="asterisk_8h.html#ea40c04ddba9d91880686eb95e400008">04455</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#ea40c04ddba9d91880686eb95e400008">ast_channels_init</a>(<span class="keywordtype">void</span>)
<a name="l04456"></a>04456 {
<a name="l04457"></a>04457    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_channel, <span class="keyword">sizeof</span>(cli_channel) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l04458"></a>04458 }
<a name="l04459"></a>04459 <span class="comment"></span>
<a name="l04460"></a>04460 <span class="comment">/*! \brief Print call group and pickup group ---*/</span>
<a name="l04461"></a><a class="code" href="channel_8h.html#68e3e84e623c83dd308276466ccf7a35">04461</a> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#68e3e84e623c83dd308276466ccf7a35">ast_print_group</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, <span class="keywordtype">int</span> buflen, <a class="code" href="channel_8h.html#f46fa02de8676dd1b9163c5dd428e610">ast_group_t</a> <a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>)
<a name="l04462"></a>04462 {
<a name="l04463"></a>04463    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l04464"></a>04464    <span class="keywordtype">int</span> first=1;
<a name="l04465"></a>04465    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>[3];
<a name="l04466"></a>04466 
<a name="l04467"></a>04467    buf[0] = <span class="charliteral">'\0'</span>;
<a name="l04468"></a>04468    
<a name="l04469"></a>04469    <span class="keywordflow">if</span> (!group) <span class="comment">/* Return empty string if no group */</span>
<a name="l04470"></a>04470       <span class="keywordflow">return</span> buf;
<a name="l04471"></a>04471 
<a name="l04472"></a>04472    <span class="keywordflow">for</span> (i = 0; i &lt;= 63; i++) {   <span class="comment">/* Max group is 63 */</span>
<a name="l04473"></a>04473       <span class="keywordflow">if</span> (group &amp; ((<a class="code" href="channel_8h.html#f46fa02de8676dd1b9163c5dd428e610">ast_group_t</a>) 1 &lt;&lt; i)) {
<a name="l04474"></a>04474             <span class="keywordflow">if</span> (!first) {
<a name="l04475"></a>04475             strncat(buf, <span class="stringliteral">", "</span>, buflen);
<a name="l04476"></a>04476          } <span class="keywordflow">else</span> {
<a name="l04477"></a>04477             first=0;
<a name="l04478"></a>04478          }
<a name="l04479"></a>04479          snprintf(num, <span class="keyword">sizeof</span>(num), <span class="stringliteral">"%u"</span>, i);
<a name="l04480"></a>04480          strncat(buf, num, buflen);
<a name="l04481"></a>04481       }
<a name="l04482"></a>04482    }
<a name="l04483"></a>04483    <span class="keywordflow">return</span> buf;
<a name="l04484"></a>04484 }
<a name="l04485"></a>04485 
<a name="l04486"></a><a class="code" href="channel_8h.html#ee674fb53b907cc57dda6e54ac24a637">04486</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#ee674fb53b907cc57dda6e54ac24a637">ast_set_variables</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *vars)
<a name="l04487"></a>04487 {
<a name="l04488"></a>04488    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *cur;
<a name="l04489"></a>04489 
<a name="l04490"></a>04490    <span class="keywordflow">for</span> (cur = vars; cur; cur = cur-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>)
<a name="l04491"></a>04491       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, cur-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, cur-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);  
<a name="l04492"></a>04492 }
<a name="l04493"></a>04493 
<a name="l04494"></a><a class="code" href="channel_8c.html#ce1d4e7d0dec35a7cefdedbc14bc356a">04494</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#ce1d4e7d0dec35a7cefdedbc14bc356a">copy_data_from_queue</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel__spy__queue.html">ast_channel_spy_queue</a> *queue, <span class="keywordtype">short</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> samples)
<a name="l04495"></a>04495 {
<a name="l04496"></a>04496    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l04497"></a>04497    <span class="keywordtype">int</span> tocopy;
<a name="l04498"></a>04498    <span class="keywordtype">int</span> bytestocopy;
<a name="l04499"></a>04499 
<a name="l04500"></a>04500    <span class="keywordflow">while</span> (samples) {
<a name="l04501"></a>04501       <span class="keywordflow">if</span> (!(f = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;queue-&gt;list))) {
<a name="l04502"></a>04502          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Ran out of frames before buffer filled!\n"</span>);
<a name="l04503"></a>04503          <span class="keywordflow">break</span>;
<a name="l04504"></a>04504       }
<a name="l04505"></a>04505 
<a name="l04506"></a>04506       tocopy = (f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> &gt; samples) ? samples : f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l04507"></a>04507       bytestocopy = <a class="code" href="frame_8c.html#86a66efeb5a412e9c1cae13f92043c47">ast_codec_get_len</a>(queue-&gt;<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, tocopy);
<a name="l04508"></a>04508       memcpy(buf, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, bytestocopy);
<a name="l04509"></a>04509       samples -= tocopy;
<a name="l04510"></a>04510       buf += tocopy;
<a name="l04511"></a>04511       f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> -= tocopy;
<a name="l04512"></a>04512       f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> += bytestocopy;
<a name="l04513"></a>04513       f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> -= bytestocopy;
<a name="l04514"></a>04514       f-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> += bytestocopy;
<a name="l04515"></a>04515       queue-&gt;<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> -= tocopy;
<a name="l04516"></a>04516 
<a name="l04517"></a>04517       <span class="keywordflow">if</span> (!f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>)
<a name="l04518"></a>04518          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(<a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;queue-&gt;list, frame_list));
<a name="l04519"></a>04519    }
<a name="l04520"></a>04520 }
<a name="l04521"></a>04521 
<a name="l04522"></a><a class="code" href="chanspy_8h.html#35d3e31fe12732e028f01173e83c2228">04522</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="channel_8c.html#35d3e31fe12732e028f01173e83c2228">ast_channel_spy_read_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel__spy.html">ast_channel_spy</a> *spy, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> samples)
<a name="l04523"></a>04523 {
<a name="l04524"></a>04524    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a>;
<a name="l04525"></a>04525    <span class="comment">/* buffers are allocated to hold SLINEAR, which is the largest format */</span>
<a name="l04526"></a>04526         <span class="keywordtype">short</span> read_buf[samples];
<a name="l04527"></a>04527         <span class="keywordtype">short</span> write_buf[samples];
<a name="l04528"></a>04528    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *read_frame;
<a name="l04529"></a>04529    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *write_frame;
<a name="l04530"></a>04530    <span class="keywordtype">int</span> need_dup;
<a name="l04531"></a>04531    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> stack_read_frame = { .<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>,
<a name="l04532"></a>04532                      .subclass = spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,
<a name="l04533"></a>04533                      .data = read_buf,
<a name="l04534"></a>04534                      .samples = samples,
<a name="l04535"></a>04535                      .datalen = <a class="code" href="frame_8c.html#86a66efeb5a412e9c1cae13f92043c47">ast_codec_get_len</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, samples),
<a name="l04536"></a>04536    };
<a name="l04537"></a>04537    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> stack_write_frame = { .<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>,
<a name="l04538"></a>04538                       .subclass = spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,
<a name="l04539"></a>04539                       .data = write_buf,
<a name="l04540"></a>04540                       .samples = samples,
<a name="l04541"></a>04541                       .datalen = <a class="code" href="frame_8c.html#86a66efeb5a412e9c1cae13f92043c47">ast_codec_get_len</a>(spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, samples),
<a name="l04542"></a>04542    };
<a name="l04543"></a>04543 
<a name="l04544"></a>04544    <span class="comment">/* if a flush has been requested, dump everything in whichever queue is larger */</span>
<a name="l04545"></a>04545    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce6560bd57b07eeb3eb997c1a0fb15e2cdf1">CHANSPY_TRIGGER_FLUSH</a>)) {
<a name="l04546"></a>04546       <span class="keywordflow">if</span> (spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> &gt; spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a>) {
<a name="l04547"></a>04547          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65182be74692abc8f01ed538bc4e42629c">CHANSPY_READ_VOLADJUST</a>)) {
<a name="l04548"></a>04548             <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list, result, frame_list)
<a name="l04549"></a>04549                <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(result, spy-&gt;<a class="code" href="structast__channel__spy.html#a2809e43a74b947388f86f57ab866476">read_vol_adjustment</a>);
<a name="l04550"></a>04550          }
<a name="l04551"></a>04551          result = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list);
<a name="l04552"></a>04552          <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list, NULL);
<a name="l04553"></a>04553          spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> = 0;
<a name="l04554"></a>04554       } <span class="keywordflow">else</span> {
<a name="l04555"></a>04555          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce650cddca71a0efa3c6c9f94e1b276046bd">CHANSPY_WRITE_VOLADJUST</a>)) {
<a name="l04556"></a>04556             <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list, result, frame_list)
<a name="l04557"></a>04557                <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(result, spy-&gt;<a class="code" href="structast__channel__spy.html#905842b829622d5a7a4f83c1441aadbc">write_vol_adjustment</a>);
<a name="l04558"></a>04558          }
<a name="l04559"></a>04559          result = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list);
<a name="l04560"></a>04560          <a class="code" href="linkedlists_8h.html#96c2ff3700d9bb6033bdf522c7984566">AST_LIST_HEAD_SET_NOLOCK</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list, NULL);
<a name="l04561"></a>04561          spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> = 0;
<a name="l04562"></a>04562       }
<a name="l04563"></a>04563       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce6560bd57b07eeb3eb997c1a0fb15e2cdf1">CHANSPY_TRIGGER_FLUSH</a>);
<a name="l04564"></a>04564       <span class="keywordflow">return</span> result;
<a name="l04565"></a>04565    }
<a name="l04566"></a>04566 
<a name="l04567"></a>04567    <span class="keywordflow">if</span> ((spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> &lt; samples) || (spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> &lt; samples))
<a name="l04568"></a>04568       <span class="keywordflow">return</span> NULL;
<a name="l04569"></a>04569 
<a name="l04570"></a>04570    <span class="comment">/* short-circuit if both head frames have exactly what we want */</span>
<a name="l04571"></a>04571    <span class="keywordflow">if</span> ((<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list)-&gt;samples == samples) &amp;&amp;
<a name="l04572"></a>04572        (<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list)-&gt;samples == samples)) {
<a name="l04573"></a>04573       read_frame = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.list, frame_list);
<a name="l04574"></a>04574       write_frame = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.list, frame_list);
<a name="l04575"></a>04575 
<a name="l04576"></a>04576       spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> -= samples;
<a name="l04577"></a>04577       spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>.<a class="code" href="structast__channel__spy__queue.html#6ef9161b900632671022358216c7dfe7">samples</a> -= samples;
<a name="l04578"></a>04578 
<a name="l04579"></a>04579       need_dup = 0;
<a name="l04580"></a>04580    } <span class="keywordflow">else</span> {
<a name="l04581"></a>04581       <a class="code" href="channel_8c.html#ce1d4e7d0dec35a7cefdedbc14bc356a">copy_data_from_queue</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#6fc28b06536d6947665598be732383aa">read_queue</a>, read_buf, samples);
<a name="l04582"></a>04582       <a class="code" href="channel_8c.html#ce1d4e7d0dec35a7cefdedbc14bc356a">copy_data_from_queue</a>(&amp;spy-&gt;<a class="code" href="structast__channel__spy.html#13e9b2fb4e074ff362693715b23ab877">write_queue</a>, write_buf, samples);
<a name="l04583"></a>04583 
<a name="l04584"></a>04584       read_frame = &amp;stack_read_frame;
<a name="l04585"></a>04585       write_frame = &amp;stack_write_frame;
<a name="l04586"></a>04586       need_dup = 1;
<a name="l04587"></a>04587    }
<a name="l04588"></a>04588    
<a name="l04589"></a>04589    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce65182be74692abc8f01ed538bc4e42629c">CHANSPY_READ_VOLADJUST</a>))
<a name="l04590"></a>04590       <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(read_frame, spy-&gt;<a class="code" href="structast__channel__spy.html#a2809e43a74b947388f86f57ab866476">read_vol_adjustment</a>);
<a name="l04591"></a>04591 
<a name="l04592"></a>04592    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce650cddca71a0efa3c6c9f94e1b276046bd">CHANSPY_WRITE_VOLADJUST</a>))
<a name="l04593"></a>04593       <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(write_frame, spy-&gt;<a class="code" href="structast__channel__spy.html#905842b829622d5a7a4f83c1441aadbc">write_vol_adjustment</a>);
<a name="l04594"></a>04594 
<a name="l04595"></a>04595    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(spy, <a class="code" href="chanspy_8h.html#0531fc877d377d51e324d7afd13cce651f319c5d4c24864a434e56ab93c72e72">CHANSPY_MIXAUDIO</a>)) {
<a name="l04596"></a>04596       <a class="code" href="frame_8c.html#8a78ed734b1cafea2ab42e1363a330d0">ast_frame_slinear_sum</a>(read_frame, write_frame);
<a name="l04597"></a>04597 
<a name="l04598"></a>04598       <span class="keywordflow">if</span> (need_dup)
<a name="l04599"></a>04599          result = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(read_frame);
<a name="l04600"></a>04600       <span class="keywordflow">else</span> {
<a name="l04601"></a>04601          result = read_frame;
<a name="l04602"></a>04602          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(write_frame);
<a name="l04603"></a>04603       }
<a name="l04604"></a>04604    } <span class="keywordflow">else</span> {
<a name="l04605"></a>04605       <span class="keywordflow">if</span> (need_dup) {
<a name="l04606"></a>04606          result = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(read_frame);
<a name="l04607"></a>04607          <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(result, frame_list) = <a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(write_frame);
<a name="l04608"></a>04608       } <span class="keywordflow">else</span> {
<a name="l04609"></a>04609          result = read_frame;
<a name="l04610"></a>04610          <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(result, frame_list) = write_frame;
<a name="l04611"></a>04611       }
<a name="l04612"></a>04612    }
<a name="l04613"></a>04613 
<a name="l04614"></a>04614    <span class="keywordflow">return</span> result;
<a name="l04615"></a>04615 }
<a name="l04616"></a>04616 
<a name="l04617"></a><a class="code" href="channel_8c.html#7077ac3e8ad93c2054c918e8f753498e">04617</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="channel_8c.html#7077ac3e8ad93c2054c918e8f753498e">silence_generator_alloc</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">void</span> *data)
<a name="l04618"></a>04618 {
<a name="l04619"></a>04619    <span class="comment">/* just store the data pointer in the channel structure */</span>
<a name="l04620"></a>04620    <span class="keywordflow">return</span> data;
<a name="l04621"></a>04621 }
<a name="l04622"></a>04622 
<a name="l04623"></a><a class="code" href="channel_8c.html#4f6fb17040f74b7b0322406197362212">04623</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#4f6fb17040f74b7b0322406197362212">silence_generator_release</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">void</span> *data)
<a name="l04624"></a>04624 {
<a name="l04625"></a>04625    <span class="comment">/* nothing to do */</span>
<a name="l04626"></a>04626 }
<a name="l04627"></a>04627 
<a name="l04628"></a><a class="code" href="channel_8c.html#71439a6cab7595c880df7914cbf7c187">04628</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#71439a6cab7595c880df7914cbf7c187">silence_generator_generate</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> samples)
<a name="l04629"></a>04629 {
<a name="l04630"></a>04630    <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[samples];
<a name="l04631"></a>04631    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> frame = {
<a name="l04632"></a>04632       .<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>,
<a name="l04633"></a>04633       .subclass = <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>,
<a name="l04634"></a>04634       .data = buf,
<a name="l04635"></a>04635       .samples = samples,
<a name="l04636"></a>04636       .datalen = <span class="keyword">sizeof</span>(buf),
<a name="l04637"></a>04637    };
<a name="l04638"></a>04638    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l04639"></a>04639    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(chan, &amp;frame))
<a name="l04640"></a>04640       <span class="keywordflow">return</span> -1;
<a name="l04641"></a>04641    <span class="keywordflow">return</span> 0;
<a name="l04642"></a>04642 }
<a name="l04643"></a>04643 
<a name="l04644"></a><a class="code" href="channel_8c.html#f6b0b17253eb9e88697ec93cd107f232">04644</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> silence_generator = {
<a name="l04645"></a>04645    .<a class="code" href="structast__generator.html#ec716dadc257b3894e8a1a75177d4283">alloc</a> = <a class="code" href="channel_8c.html#7077ac3e8ad93c2054c918e8f753498e">silence_generator_alloc</a>,
<a name="l04646"></a>04646    .release = <a class="code" href="channel_8c.html#4f6fb17040f74b7b0322406197362212">silence_generator_release</a>,
<a name="l04647"></a>04647    .generate = <a class="code" href="channel_8c.html#71439a6cab7595c880df7914cbf7c187">silence_generator_generate</a>,
<a name="l04648"></a>04648 };
<a name="l04649"></a>04649 
<a name="l04650"></a><a class="code" href="structast__silence__generator.html">04650</a> <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> {
<a name="l04651"></a><a class="code" href="structast__silence__generator.html#ad9a1725ddc8a612d7c0f0c273901cc5">04651</a>    <span class="keywordtype">int</span> old_write_format;
<a name="l04652"></a>04652 };
<a name="l04653"></a>04653 
<a name="l04654"></a><a class="code" href="channel_8h.html#df0067eebc6d6ba27b24f955cd779a7f">04654</a> <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *<a class="code" href="channel_8c.html#df0067eebc6d6ba27b24f955cd779a7f">ast_channel_start_silence_generator</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04655"></a>04655 {
<a name="l04656"></a>04656    <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *<a class="code" href="structstate.html">state</a>;
<a name="l04657"></a>04657 
<a name="l04658"></a>04658    <span class="keywordflow">if</span> (!(state = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*state)))) {
<a name="l04659"></a>04659       <span class="keywordflow">return</span> NULL;
<a name="l04660"></a>04660    }
<a name="l04661"></a>04661 
<a name="l04662"></a>04662    state-&gt;<a class="code" href="structast__silence__generator.html#ad9a1725ddc8a612d7c0f0c273901cc5">old_write_format</a> = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l04663"></a>04663 
<a name="l04664"></a>04664    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>) &lt; 0) {
<a name="l04665"></a>04665       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Could not set write format to SLINEAR\n"</span>);
<a name="l04666"></a>04666       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(state);
<a name="l04667"></a>04667       <span class="keywordflow">return</span> NULL;
<a name="l04668"></a>04668    }
<a name="l04669"></a>04669 
<a name="l04670"></a>04670    <a class="code" href="channel_8c.html#51350b9fba7a6a2428e1b3a13a131d54">ast_activate_generator</a>(chan, &amp;silence_generator, state);
<a name="l04671"></a>04671 
<a name="l04672"></a>04672    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04673"></a>04673       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Started silence generator on '%s'\n"</span>, chan-&gt;name);
<a name="l04674"></a>04674 
<a name="l04675"></a>04675    <span class="keywordflow">return</span> state;
<a name="l04676"></a>04676 }
<a name="l04677"></a>04677 
<a name="l04678"></a><a class="code" href="channel_8h.html#925b5f1e2127332abaf35b5106ca9df4">04678</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#925b5f1e2127332abaf35b5106ca9df4">ast_channel_stop_silence_generator</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">struct</span> <a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *<a class="code" href="structstate.html">state</a>)
<a name="l04679"></a>04679 {
<a name="l04680"></a>04680    <span class="keywordflow">if</span> (!state)
<a name="l04681"></a>04681       <span class="keywordflow">return</span>;
<a name="l04682"></a>04682 
<a name="l04683"></a>04683    <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l04684"></a>04684 
<a name="l04685"></a>04685    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04686"></a>04686       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Stopped silence generator on '%s'\n"</span>, chan-&gt;name);
<a name="l04687"></a>04687 
<a name="l04688"></a>04688    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, state-&gt;<a class="code" href="structast__silence__generator.html#ad9a1725ddc8a612d7c0f0c273901cc5">old_write_format</a>) &lt; 0)
<a name="l04689"></a>04689       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Could not return write format to its original state\n"</span>);
<a name="l04690"></a>04690 
<a name="l04691"></a>04691    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(state);
<a name="l04692"></a>04692 }
<a name="l04693"></a>04693 
<a name="l04694"></a>04694 <span class="comment"></span>
<a name="l04695"></a>04695 <span class="comment">/*! \ brief Convert channel reloadreason (ENUM) to text string for manager event */</span>
<a name="l04696"></a><a class="code" href="channel_8h.html#877faf4f25816c15c87b3b95c439ce1e">04696</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#877faf4f25816c15c87b3b95c439ce1e">channelreloadreason2txt</a>(<span class="keyword">enum</span> <a class="code" href="channel_8h.html#a49c7ae4d656ef2e220ceae47cb045f2">channelreloadreason</a> reason)
<a name="l04697"></a>04697 {
<a name="l04698"></a>04698    <span class="keywordflow">switch</span> (reason) {
<a name="l04699"></a>04699    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#a49c7ae4d656ef2e220ceae47cb045f2704c328f9fec2df0f273fc084c46bb5c">CHANNEL_MODULE_LOAD</a>:
<a name="l04700"></a>04700       <span class="keywordflow">return</span> <span class="stringliteral">"LOAD (Channel module load)"</span>;
<a name="l04701"></a>04701 
<a name="l04702"></a>04702    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#a49c7ae4d656ef2e220ceae47cb045f2a6546d2270d01e15c994b899c015a868">CHANNEL_MODULE_RELOAD</a>:
<a name="l04703"></a>04703       <span class="keywordflow">return</span> <span class="stringliteral">"RELOAD (Channel module reload)"</span>;
<a name="l04704"></a>04704 
<a name="l04705"></a>04705    <span class="keywordflow">case</span> <a class="code" href="channel_8h.html#a49c7ae4d656ef2e220ceae47cb045f2950ce6983714a51f62494c5b16daf99d">CHANNEL_CLI_RELOAD</a>:
<a name="l04706"></a>04706       <span class="keywordflow">return</span> <span class="stringliteral">"CLIRELOAD (Channel module reload by CLI command)"</span>;
<a name="l04707"></a>04707 
<a name="l04708"></a>04708    <span class="keywordflow">default</span>:
<a name="l04709"></a>04709       <span class="keywordflow">return</span> <span class="stringliteral">"MANAGERRELOAD (Channel module reload by manager)"</span>;
<a name="l04710"></a>04710    }
<a name="l04711"></a>04711 };
<a name="l04712"></a>04712 
<a name="l04713"></a>04713 <span class="preprocessor">#ifdef DEBUG_CHANNEL_LOCKS</span>
<a name="l04714"></a>04714 <span class="preprocessor"></span><span class="comment"></span>
<a name="l04715"></a>04715 <span class="comment">/*! \brief Unlock AST channel (and print debugging output) </span>
<a name="l04716"></a>04716 <span class="comment">\note You need to enable DEBUG_CHANNEL_LOCKS for this function</span>
<a name="l04717"></a>04717 <span class="comment">*/</span>
<a name="l04718"></a>04718 <span class="keywordtype">int</span> <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04719"></a>04719 {
<a name="l04720"></a>04720    <span class="keywordtype">int</span> res = 0;
<a name="l04721"></a>04721    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 2) 
<a name="l04722"></a>04722       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Unlocking AST channel %s\n"</span>, chan-&gt;name);
<a name="l04723"></a>04723    
<a name="l04724"></a>04724    <span class="keywordflow">if</span> (!chan) {
<a name="l04725"></a>04725       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04726"></a>04726          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Unlocking non-existing channel \n"</span>);
<a name="l04727"></a>04727       <span class="keywordflow">return</span> 0;
<a name="l04728"></a>04728    }
<a name="l04729"></a>04729 
<a name="l04730"></a>04730    res = <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04731"></a>04731 
<a name="l04732"></a>04732    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 2) {
<a name="l04733"></a>04733 <span class="preprocessor">#ifdef DEBUG_THREADS</span>
<a name="l04734"></a>04734 <span class="preprocessor"></span>      <span class="keywordtype">int</span> count = 0;
<a name="l04735"></a>04735       <span class="keywordflow">if</span> ((count = chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>.reentrancy))
<a name="l04736"></a>04736          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04737"></a>04737             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">":::=== Still have %d locks (recursive)\n"</span>, count);
<a name="l04738"></a>04738 <span class="preprocessor">#endif</span>
<a name="l04739"></a>04739 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!res)
<a name="l04740"></a>04740          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l04741"></a>04741             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was unlocked\n"</span>, chan-&gt;name);
<a name="l04742"></a>04742          <span class="keywordflow">if</span> (res == EINVAL) {
<a name="l04743"></a>04743             <span class="keywordflow">if</span> (option_debug)
<a name="l04744"></a>04744                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s had no lock by this thread. Failed unlocking\n"</span>, chan-&gt;name);
<a name="l04745"></a>04745          }
<a name="l04746"></a>04746       }
<a name="l04747"></a>04747       <span class="keywordflow">if</span> (res == EPERM) {
<a name="l04748"></a>04748          <span class="comment">/* We had no lock, so okay any way*/</span>
<a name="l04749"></a>04749          <span class="keywordflow">if</span> (option_debug &gt; 3)
<a name="l04750"></a>04750             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was not locked at all \n"</span>, chan-&gt;name);
<a name="l04751"></a>04751       res = 0;
<a name="l04752"></a>04752    }
<a name="l04753"></a>04753    <span class="keywordflow">return</span> res;
<a name="l04754"></a>04754 }
<a name="l04755"></a>04755 <span class="comment"></span>
<a name="l04756"></a>04756 <span class="comment">/*! \brief Lock AST channel (and print debugging output)</span>
<a name="l04757"></a>04757 <span class="comment">\note You need to enable DEBUG_CHANNEL_LOCKS for this function */</span>
<a name="l04758"></a>04758 <span class="keywordtype">int</span> <a class="code" href="lock_8h.html#0a2d3319a8f002f769ab38110cef9699">ast_channel_lock</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04759"></a>04759 {
<a name="l04760"></a>04760    <span class="keywordtype">int</span> res;
<a name="l04761"></a>04761 
<a name="l04762"></a>04762    <span class="keywordflow">if</span> (option_debug &gt; 3)
<a name="l04763"></a>04763       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"====:::: Locking AST channel %s\n"</span>, chan-&gt;name);
<a name="l04764"></a>04764 
<a name="l04765"></a>04765    res = <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04766"></a>04766 
<a name="l04767"></a>04767    <span class="keywordflow">if</span> (option_debug &gt; 3) {
<a name="l04768"></a>04768 <span class="preprocessor">#ifdef DEBUG_THREADS</span>
<a name="l04769"></a>04769 <span class="preprocessor"></span>      <span class="keywordtype">int</span> count = 0;
<a name="l04770"></a>04770       <span class="keywordflow">if</span> ((count = chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>.reentrancy))
<a name="l04771"></a>04771          <span class="keywordflow">if</span> (option_debug)
<a name="l04772"></a>04772             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">":::=== Now have %d locks (recursive)\n"</span>, count);
<a name="l04773"></a>04773 <span class="preprocessor">#endif</span>
<a name="l04774"></a>04774 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!res)
<a name="l04775"></a>04775          <span class="keywordflow">if</span> (option_debug)
<a name="l04776"></a>04776             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was locked\n"</span>, chan-&gt;name);
<a name="l04777"></a>04777       <span class="keywordflow">if</span> (res == EDEADLK) {
<a name="l04778"></a>04778          <span class="comment">/* We had no lock, so okey any way */</span>
<a name="l04779"></a>04779          <span class="keywordflow">if</span> (option_debug &gt; 3)
<a name="l04780"></a>04780             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was not locked by us. Lock would cause deadlock.\n"</span>, chan-&gt;name);
<a name="l04781"></a>04781       }
<a name="l04782"></a>04782       <span class="keywordflow">if</span> (res == EINVAL) {
<a name="l04783"></a>04783          <span class="keywordflow">if</span> (option_debug &gt; 3)
<a name="l04784"></a>04784             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s lock failed. No mutex.\n"</span>, chan-&gt;name);
<a name="l04785"></a>04785       }
<a name="l04786"></a>04786    }
<a name="l04787"></a>04787    <span class="keywordflow">return</span> res;
<a name="l04788"></a>04788 }
<a name="l04789"></a>04789 <span class="comment"></span>
<a name="l04790"></a>04790 <span class="comment">/*! \brief Lock AST channel (and print debugging output)</span>
<a name="l04791"></a>04791 <span class="comment">\note You need to enable DEBUG_CHANNEL_LOCKS for this function */</span>
<a name="l04792"></a>04792 <span class="keywordtype">int</span> <a class="code" href="lock_8h.html#ed66db8089c98c0615ab831f4eba520a">ast_channel_trylock</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04793"></a>04793 {
<a name="l04794"></a>04794    <span class="keywordtype">int</span> res;
<a name="l04795"></a>04795 
<a name="l04796"></a>04796    <span class="keywordflow">if</span> (option_debug &gt; 2)
<a name="l04797"></a>04797       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"====:::: Trying to lock AST channel %s\n"</span>, chan-&gt;name);
<a name="l04798"></a>04798 
<a name="l04799"></a>04799    res = <a class="code" href="lock_8h.html#95eeb25d5a8ccfa3adff8168c75d70e0">ast_mutex_trylock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04800"></a>04800 
<a name="l04801"></a>04801    <span class="keywordflow">if</span> (option_debug &gt; 2) {
<a name="l04802"></a>04802 <span class="preprocessor">#ifdef DEBUG_THREADS</span>
<a name="l04803"></a>04803 <span class="preprocessor"></span>      <span class="keywordtype">int</span> count = 0;
<a name="l04804"></a>04804       <span class="keywordflow">if</span> ((count = chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>.reentrancy))
<a name="l04805"></a>04805          <span class="keywordflow">if</span> (option_debug)
<a name="l04806"></a>04806             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">":::=== Now have %d locks (recursive)\n"</span>, count);
<a name="l04807"></a>04807 <span class="preprocessor">#endif</span>
<a name="l04808"></a>04808 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!res)
<a name="l04809"></a>04809          <span class="keywordflow">if</span> (option_debug)
<a name="l04810"></a>04810             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was locked\n"</span>, chan-&gt;name);
<a name="l04811"></a>04811       <span class="keywordflow">if</span> (res == EBUSY) {
<a name="l04812"></a>04812          <span class="comment">/* We failed to lock */</span>
<a name="l04813"></a>04813          <span class="keywordflow">if</span> (option_debug &gt; 2)
<a name="l04814"></a>04814             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s failed to lock. Not waiting around...\n"</span>, chan-&gt;name);
<a name="l04815"></a>04815       }
<a name="l04816"></a>04816       <span class="keywordflow">if</span> (res == EDEADLK) {
<a name="l04817"></a>04817          <span class="comment">/* We had no lock, so okey any way*/</span>
<a name="l04818"></a>04818          <span class="keywordflow">if</span> (option_debug &gt; 2)
<a name="l04819"></a>04819             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s was not locked. Lock would cause deadlock.\n"</span>, chan-&gt;name);
<a name="l04820"></a>04820       }
<a name="l04821"></a>04821       <span class="keywordflow">if</span> (res == EINVAL &amp;&amp; option_debug &gt; 2)
<a name="l04822"></a>04822          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"::::==== Channel %s lock failed. No mutex.\n"</span>, chan-&gt;name);
<a name="l04823"></a>04823    }
<a name="l04824"></a>04824    <span class="keywordflow">return</span> res;
<a name="l04825"></a>04825 }
<a name="l04826"></a>04826 
<a name="l04827"></a>04827 <span class="preprocessor">#endif</span>
<a name="l04828"></a>04828 <span class="preprocessor"></span>
<a name="l04829"></a>04829 <span class="comment">/*</span>
<a name="l04830"></a>04830 <span class="comment"> * Wrappers for various ast_say_*() functions that call the full version</span>
<a name="l04831"></a>04831 <span class="comment"> * of the same functions.</span>
<a name="l04832"></a>04832 <span class="comment"> * The proper place would be say.c, but that file is optional and one</span>
<a name="l04833"></a>04833 <span class="comment"> * must be able to build asterisk even without it (using a loadable 'say'</span>
<a name="l04834"></a>04834 <span class="comment"> * implementation that only supplies the 'full' version of the functions.</span>
<a name="l04835"></a>04835 <span class="comment"> */</span>
<a name="l04836"></a>04836 
<a name="l04837"></a><a class="code" href="say_8h.html#af2305e9f7f0f44bf3e4c6cd963c91bd">04837</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#ae819935343a14b1f61b331ff85fc214">ast_say_number</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>,
<a name="l04838"></a>04838    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *options)
<a name="l04839"></a>04839 {
<a name="l04840"></a>04840         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#c282d0a1ae2cb14bace6bcd9fcd3a29a">ast_say_number_full</a>(chan, num, ints, language, options, -1, -1);
<a name="l04841"></a>04841 }
<a name="l04842"></a>04842 
<a name="l04843"></a><a class="code" href="say_8h.html#73ec8bd4511ebd0f9885cb6714200338">04843</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#dccd68ea5e352faae1303c689cf82f37">ast_say_enumeration</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>,
<a name="l04844"></a>04844    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *options)
<a name="l04845"></a>04845 {
<a name="l04846"></a>04846         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#2110aafbfbfe693cade93fa32df214b4">ast_say_enumeration_full</a>(chan, num, ints, language, options, -1, -1);
<a name="l04847"></a>04847 }
<a name="l04848"></a>04848 
<a name="l04849"></a><a class="code" href="say_8h.html#e02ce58f997ad8095efa170689df89cf">04849</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#e02ce58f997ad8095efa170689df89cf">ast_say_digits</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>,
<a name="l04850"></a>04850    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l04851"></a>04851 {
<a name="l04852"></a>04852         <span class="keywordflow">return</span> <a class="code" href="channel_8c.html#9d8a7312dbbb895f83d190b85eefb0f4">ast_say_digits_full</a>(chan, num, ints, lang, -1, -1);
<a name="l04853"></a>04853 }
<a name="l04854"></a>04854 
<a name="l04855"></a><a class="code" href="say_8h.html#3c8fd5f52d1fcccf0562a10c2f2c2897">04855</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#39bff415a7dcb7271c386495e8f90984">ast_say_digit_str</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *str,
<a name="l04856"></a>04856    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l04857"></a>04857 {
<a name="l04858"></a>04858         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#83e81d19c0309c5b3ea4cc721b243878">ast_say_digit_str_full</a>(chan, str, ints, lang, -1, -1);
<a name="l04859"></a>04859 }
<a name="l04860"></a>04860 
<a name="l04861"></a><a class="code" href="say_8h.html#13b62aedb587bb33c238be645ac523bd">04861</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#21b43fd85379f13bafbc47156bceebbb">ast_say_character_str</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *str,
<a name="l04862"></a>04862    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l04863"></a>04863 {
<a name="l04864"></a>04864         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#1e2d922534f1b45df77ae617e55ec8b4">ast_say_character_str_full</a>(chan, str, ints, lang, -1, -1);
<a name="l04865"></a>04865 }
<a name="l04866"></a>04866 
<a name="l04867"></a><a class="code" href="say_8h.html#d62ab504f8d7e8bb82e25b270d809b4b">04867</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#d785e228f61ef3808a94532aa1655d63">ast_say_phonetic_str</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *str,
<a name="l04868"></a>04868    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l04869"></a>04869 {
<a name="l04870"></a>04870         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#6aa62c71e9dc7aab8f6150ebc7a5f72e">ast_say_phonetic_str_full</a>(chan, str, ints, lang, -1, -1);
<a name="l04871"></a>04871 }
<a name="l04872"></a>04872 
<a name="l04873"></a><a class="code" href="say_8h.html#9d8a7312dbbb895f83d190b85eefb0f4">04873</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#9d8a7312dbbb895f83d190b85eefb0f4">ast_say_digits_full</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>,
<a name="l04874"></a>04874    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l04875"></a>04875 {
<a name="l04876"></a>04876         <span class="keywordtype">char</span> buf[256];
<a name="l04877"></a>04877 
<a name="l04878"></a>04878         snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%d"</span>, num);
<a name="l04879"></a>04879         <span class="keywordflow">return</span> <a class="code" href="say_8h.html#83e81d19c0309c5b3ea4cc721b243878">ast_say_digit_str_full</a>(chan, buf, ints, lang, audiofd, ctrlfd);
<a name="l04880"></a>04880 }
<a name="l04881"></a>04881 
<a name="l04882"></a><a class="code" href="channel_8h.html#eadc89eb057511322a2aebad4074df6a">04882</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#eadc89eb057511322a2aebad4074df6a">ast_channel_whisper_start</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04883"></a>04883 {
<a name="l04884"></a>04884    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>)
<a name="l04885"></a>04885       <span class="keywordflow">return</span> -1;
<a name="l04886"></a>04886 
<a name="l04887"></a>04887    <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a> = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>))))
<a name="l04888"></a>04888       <span class="keywordflow">return</span> -1;
<a name="l04889"></a>04889 
<a name="l04890"></a>04890    <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04891"></a>04891    <a class="code" href="slinfactory_8c.html#8d2bd2b35c60c1eac6e16829d6c013f8">ast_slinfactory_init</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#60d31eb37595dd44584be5ef363283e3">sf</a>);
<a name="l04892"></a>04892    <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>);
<a name="l04893"></a>04893 
<a name="l04894"></a>04894    <span class="keywordflow">return</span> 0;
<a name="l04895"></a>04895 }
<a name="l04896"></a>04896 
<a name="l04897"></a><a class="code" href="channel_8h.html#c45fab3584a74234dc1c9662ba76e8f1">04897</a> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#c45fab3584a74234dc1c9662ba76e8f1">ast_channel_whisper_feed</a>(<span class="keyword">struct</span> ast_channel *chan, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>)
<a name="l04898"></a>04898 {
<a name="l04899"></a>04899    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>)
<a name="l04900"></a>04900       <span class="keywordflow">return</span> -1;
<a name="l04901"></a>04901 
<a name="l04902"></a>04902    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04903"></a>04903    <a class="code" href="slinfactory_8c.html#9fc1819fc7a7eae55d77524c91133126">ast_slinfactory_feed</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#60d31eb37595dd44584be5ef363283e3">sf</a>, f);
<a name="l04904"></a>04904    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l04905"></a>04905 
<a name="l04906"></a>04906    <span class="keywordflow">return</span> 0;
<a name="l04907"></a>04907 }
<a name="l04908"></a>04908 
<a name="l04909"></a><a class="code" href="channel_8h.html#79598f580fc373516b4489bc5ebb7b02">04909</a> <span class="keywordtype">void</span> <a class="code" href="channel_8c.html#79598f580fc373516b4489bc5ebb7b02">ast_channel_whisper_stop</a>(<span class="keyword">struct</span> ast_channel *chan)
<a name="l04910"></a>04910 {
<a name="l04911"></a>04911    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>)
<a name="l04912"></a>04912       <span class="keywordflow">return</span>;
<a name="l04913"></a>04913 
<a name="l04914"></a>04914    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730059fb89e0dc785928def8b9daa1a2d316">AST_FLAG_WHISPER</a>);
<a name="l04915"></a>04915    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>)
<a name="l04916"></a>04916       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#d6fe1d0be6347b8ef2427fa629c04485">path</a>);
<a name="l04917"></a>04917    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#c8ae1c62d224b4f0a5c49e99a77ed792">original_format</a> &amp;&amp; chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> == <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)
<a name="l04918"></a>04918       <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#24412aa365632abdcbf6a6b047647146">whisper</a>-&gt;<a class="code" href="structast__channel__whisper__buffer.html#c8ae1c62d224b4f0a5c49e99a77ed792">original_format</a>);
<a name="l04919"></a>04919    <a class="code" href="slinfactory_8c.html#da832a838a40d7af123a1611df14aaea">ast_slinfactory_destroy</a>(&amp;chan-&gt;whisper-&gt;sf);
<a name="l04920"></a>04920    <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;chan-&gt;whisper-&gt;lock);
<a name="l04921"></a>04921    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;whisper);
<a name="l04922"></a>04922    chan-&gt;whisper = NULL;
<a name="l04923"></a>04923 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:39 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
