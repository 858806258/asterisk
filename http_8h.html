<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:32 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2F.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2Fasterisk_2F.html">asterisk</a></div>
<h1>http.h File Reference</h1>Support for Private Asterisk HTTP Servers. <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="config_8h-source.html">asterisk/config.h</a>&quot;</code><br>

<p>
<a href="http_8h-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__http__uri.html">ast_http_uri</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Definition of a URI reachable in the embedded HTTP server.  <a href="structast__http__uri.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structserver__args.html">server_args</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structserver__instance.html">server_instance</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structSSL.html">SSL</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structSSL__CTX.html">SSL_CTX</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structtls__config.html">tls_config</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#681deafbde5165912b512a6dfc3a4cbc">AST_CERTFILE</a>&nbsp;&nbsp;&nbsp;&quot;asterisk.pem&quot;</td></tr>

<tr><td colspan="2"><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">typedef <a class="el" href="structast__str.html">ast_str</a> *(*&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#dca32e3e0108390666f417e89f383ddc">ast_http_callback</a> )(struct sockaddr_in *requestor, const char *uri, struct <a class="el" href="structast__variable.html">ast_variable</a> *params, int *status, char **title, int *contentlength)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">HTTP Callbacks take the socket.  <a href="#dca32e3e0108390666f417e89f383ddc"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#d2f8473f573a2c0dd699a68d1ff970ef">ast_http_error</a> (int status, const char *title, const char *extra_header, const char *<a class="el" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Return an <a class="el" href="structast__str.html">ast_str</a> <a class="el" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc()</a>'d string containing an HTTP error message.  <a href="#d2f8473f573a2c0dd699a68d1ff970ef"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#fcf20a2fc34d0f0f3f1f8f691969ce83">ast_http_init</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#7a134db060c1f44d65fdf437f11e7ab0">ast_http_reload</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#b43e116f1ee48f3877277fc83fa39c2f">ast_http_uri_link</a> (struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urihandler)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Link into the Asterisk HTTP server.  <a href="#b43e116f1ee48f3877277fc83fa39c2f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#f5b1e65776547f6a325f4651e67beebc">ast_http_uri_unlink</a> (struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *urihandler)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Destroy an HTTP server.  <a href="#f5b1e65776547f6a325f4651e67beebc"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#abef5638078d2be6908d698ee8c3e47b">server_root</a> (void *)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#78825d347437f6b39162f2bb595118fb">server_start</a> (struct <a class="el" href="structserver__args.html">server_args</a> *<a class="el" href="cdr__sqlite3__custom_8c.html#1dee80c7d5ab2c1c90aa8d2f7dd47256">desc</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="http_8h.html#099674f856134f6c71303eceb54558dd">ssl_setup</a> (struct <a class="el" href="structtls__config.html">tls_config</a> *cfg)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Support for Private Asterisk HTTP Servers. 
<p>
<dl compact><dt><b>Note:</b></dt><dd>Note: The Asterisk HTTP servers are extremely simple and minimal and only support the "GET" method.</dd></dl>
<dl compact><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt;</dd></dl>
<dl compact><dt><b>Note:</b></dt><dd>In order to have TLS/SSL support, we need the openssl libraries. Still we can decide whether or not to use them by commenting in or out the DO_SSL macro. TLS/SSL support is basically implemented by reading from a config file (currently http.conf) the names of the certificate and cipher to use, and then run <a class="el" href="http_8c.html#099674f856134f6c71303eceb54558dd">ssl_setup()</a> to create an appropriate <a class="el" href="structSSL__CTX.html">SSL_CTX</a> (ssl_ctx) If we support multiple domains, presumably we need to read multiple certificates. When we are requested to open a TLS socket, we run <a class="el" href="http_8c.html#70c3c179c45462372a3a311bc6d01ab3">make_file_from_fd()</a> on the socket, to do the necessary setup. At the moment the context's name is hardwired in the function, but we can certainly make it into an extra parameter to the function. We declare most of ssl support variables unconditionally, because their number is small and this simplifies the code.<p>
: the ssl-support variables (ssl_ctx, do_ssl, certfile, cipher) and their setup should be moved to a more central place, e.g. asterisk.conf and the source files that processes it. Similarly, <a class="el" href="http_8c.html#099674f856134f6c71303eceb54558dd">ssl_setup()</a> should be run earlier in the startup process so modules have it available. </dd></dl>

<p>
Definition in file <a class="el" href="http_8h-source.html">http.h</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="681deafbde5165912b512a6dfc3a4cbc"></a><!-- doxytag: member="http.h::AST_CERTFILE" ref="681deafbde5165912b512a6dfc3a4cbc" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define AST_CERTFILE&nbsp;&nbsp;&nbsp;&quot;asterisk.pem&quot;          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<a class="el" href="structSSL.html">SSL</a> support 
<p>
Definition at line <a class="el" href="http_8h-source.html#l00067">67</a> of file <a class="el" href="http_8h-source.html">http.h</a>.
<p>
Referenced by <a class="el" href="http_8c-source.html#l01148">__ast_http_load()</a>, and <a class="el" href="manager_8c-source.html#l03215">init_manager()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="dca32e3e0108390666f417e89f383ddc"></a><!-- doxytag: member="http.h::ast_http_callback" ref="dca32e3e0108390666f417e89f383ddc" args=")(struct sockaddr_in *requestor, const char *uri, struct ast_variable *params, int *status, char **title, int *contentlength)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">typedef struct <a class="el" href="structast__str.html">ast_str</a>*(* <a class="el" href="http_8h.html#dca32e3e0108390666f417e89f383ddc">ast_http_callback</a>)(struct sockaddr_in *requestor, const char *uri, struct <a class="el" href="structast__variable.html">ast_variable</a> *params, int *status, char **title, int *contentlength)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
HTTP Callbacks take the socket. 
<p>
<dl compact><dt><b>Note:</b></dt><dd>The method and the path as arguments and should return the content, allocated with <a class="el" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc()</a>. Status should be changed to reflect the status of the request if it isn't 200 and title may be set to a <a class="el" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc()</a>'d string to an appropriate title for non-200 responses. Content length may also be specified. The return value may include additional headers at the front and MUST include a blank line with <br>
 to provide separation between user headers and content (even if no content is specified) </dd></dl>

<p>
Definition at line <a class="el" href="http_8h-source.html#l00148">148</a> of file <a class="el" href="http_8h-source.html">http.h</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="d2f8473f573a2c0dd699a68d1ff970ef"></a><!-- doxytag: member="http.h::ast_http_error" ref="d2f8473f573a2c0dd699a68d1ff970ef" args="(int status, const char *title, const char *extra_header, const char *text)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__str.html">ast_str</a>* ast_http_error           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>title</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>extra_header</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>text</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return an <a class="el" href="structast__str.html">ast_str</a> <a class="el" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc()</a>'d string containing an HTTP error message. 
<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l00280">280</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
Referenced by <a class="el" href="manager_8c-source.html#l02988">generic_http_callback()</a>, <a class="el" href="http_8c-source.html#l00416">handle_post()</a>, <a class="el" href="http_8c-source.html#l00566">handle_uri()</a>, <a class="el" href="http_8c-source.html#l00756">httpd_helper_thread()</a>, and <a class="el" href="http_8c-source.html#l00160">static_callback()</a>.<div class="fragment"><pre class="fragment"><a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *out = ast_str_create(512);
<a name="l00283"></a>00283    <span class="keywordflow">if</span> (out == NULL)
<a name="l00284"></a>00284       <span class="keywordflow">return</span> out;
<a name="l00285"></a>00285    ast_str_set(&amp;out, 0,
<a name="l00286"></a>00286       <span class="stringliteral">"Content-type: text/html\r\n"</span>
<a name="l00287"></a>00287       <span class="stringliteral">"%s"</span>
<a name="l00288"></a>00288       <span class="stringliteral">"\r\n"</span>
<a name="l00289"></a>00289       <span class="stringliteral">"&lt;!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\"&gt;\r\n"</span>
<a name="l00290"></a>00290       <span class="stringliteral">"&lt;html&gt;&lt;head&gt;\r\n"</span>
<a name="l00291"></a>00291       <span class="stringliteral">"&lt;title&gt;%d %s&lt;/title&gt;\r\n"</span>
<a name="l00292"></a>00292       <span class="stringliteral">"&lt;/head&gt;&lt;body&gt;\r\n"</span>
<a name="l00293"></a>00293       <span class="stringliteral">"&lt;h1&gt;%s&lt;/h1&gt;\r\n"</span>
<a name="l00294"></a>00294       <span class="stringliteral">"&lt;p&gt;%s&lt;/p&gt;\r\n"</span>
<a name="l00295"></a>00295       <span class="stringliteral">"&lt;hr /&gt;\r\n"</span>
<a name="l00296"></a>00296       <span class="stringliteral">"&lt;address&gt;Asterisk Server&lt;/address&gt;\r\n"</span>
<a name="l00297"></a>00297       <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;\r\n"</span>,
<a name="l00298"></a>00298          (extra_header ? extra_header : <span class="stringliteral">""</span>), status, title, title, <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>);
<a name="l00299"></a>00299    <span class="keywordflow">return</span> out;
<a name="l00300"></a>00300 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="fcf20a2fc34d0f0f3f1f8f691969ce83"></a><!-- doxytag: member="http.h::ast_http_init" ref="fcf20a2fc34d0f0f3f1f8f691969ce83" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_http_init           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l01318">1318</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="http_8c-source.html#l01148">__ast_http_load()</a>, <a class="el" href="cli_8c-source.html#l01352">ast_cli_register_multiple()</a>, and <a class="el" href="http_8c-source.html#l00311">ast_http_uri_link()</a>.
<p>
Referenced by <a class="el" href="asterisk_8c-source.html#l02570">main()</a>.<div class="fragment"><pre class="fragment"><a name="l01319"></a>01319 {
<a name="l01320"></a>01320    mm_library_init();
<a name="l01321"></a>01321    mm_codec_registerdefaultcodecs();
<a name="l01322"></a>01322 
<a name="l01323"></a>01323    <a class="code" href="http_8c.html#6842958ab454952c76e8111211b76e5a">ast_http_uri_link</a>(&amp;<a class="code" href="http_8c.html#6ccc136e1031aec89f80496f12ecb592">statusuri</a>);
<a name="l01324"></a>01324    <a class="code" href="http_8c.html#6842958ab454952c76e8111211b76e5a">ast_http_uri_link</a>(&amp;<a class="code" href="http_8c.html#c1637e1cc08de9c8d8b7f1e204e2680a">staticuri</a>);
<a name="l01325"></a>01325    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(<a class="code" href="http_8c.html#7d1caf92f71efb482202f36a264d4880">cli_http</a>, <span class="keyword">sizeof</span>(<a class="code" href="http_8c.html#7d1caf92f71efb482202f36a264d4880">cli_http</a>) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l01326"></a>01326 
<a name="l01327"></a>01327    <span class="keywordflow">return</span> <a class="code" href="http_8c.html#ecf7faa82141d973a44edb3e7055e5ce">__ast_http_load</a>(0);
<a name="l01328"></a>01328 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="7a134db060c1f44d65fdf437f11e7ab0"></a><!-- doxytag: member="http.h::ast_http_reload" ref="7a134db060c1f44d65fdf437f11e7ab0" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_http_reload           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l01303">1303</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="http_8c-source.html#l01148">__ast_http_load()</a>.<div class="fragment"><pre class="fragment"><a name="l01304"></a>01304 {
<a name="l01305"></a>01305    <span class="keywordflow">return</span> <a class="code" href="http_8c.html#ecf7faa82141d973a44edb3e7055e5ce">__ast_http_load</a>(1);
<a name="l01306"></a>01306 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b43e116f1ee48f3877277fc83fa39c2f"></a><!-- doxytag: member="http.h::ast_http_uri_link" ref="b43e116f1ee48f3877277fc83fa39c2f" args="(struct ast_http_uri *urihandler)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_http_uri_link           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>urih</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Link into the Asterisk HTTP server. 
<p>
They are sorted by length of the string, not alphabetically. Duplicate entries are not replaced, but the insertion order (using &lt;= and not just &lt;) makes sure that more recent insertions hide older ones. On a lookup, we just scan the list and stop at the first matching entry. 
<p>
Definition at line <a class="el" href="http_8c-source.html#l00311">311</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00415">AST_RWLIST_EMPTY</a>, <a class="el" href="linkedlists_8h-source.html#l00387">AST_RWLIST_FIRST</a>, <a class="el" href="linkedlists_8h-source.html#l00641">AST_RWLIST_INSERT_AFTER</a>, <a class="el" href="linkedlists_8h-source.html#l00657">AST_RWLIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h-source.html#l00680">AST_RWLIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h-source.html#l00405">AST_RWLIST_NEXT</a>, <a class="el" href="linkedlists_8h-source.html#l00456">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h-source.html#l00115">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h-source.html#l00049">AST_RWLIST_WRLOCK</a>, <a class="el" href="utils_8h-source.html#l00386">len</a>, and <a class="el" href="http_8h-source.html#l00154">ast_http_uri::uri</a>.
<p>
Referenced by <a class="el" href="http_8c-source.html#l01318">ast_http_init()</a>, and <a class="el" href="manager_8c-source.html#l03215">init_manager()</a>.<div class="fragment"><pre class="fragment"><a name="l00312"></a>00312 {
<a name="l00313"></a>00313    <span class="keyword">struct </span><a class="code" href="structast__http__uri.html">ast_http_uri</a> *<a class="code" href="structast__http__uri.html#9305b73d359bd06734fee0b3638079e1">uri</a>;
<a name="l00314"></a>00314    <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = strlen(urih-&gt;<a class="code" href="structast__http__uri.html#9305b73d359bd06734fee0b3638079e1">uri</a>);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;uris);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318    <span class="keywordflow">if</span> ( <a class="code" href="linkedlists_8h.html#020b0bebdc89708ef3af28762efc67d6">AST_RWLIST_EMPTY</a>(&amp;uris) || strlen(<a class="code" href="linkedlists_8h.html#8600701a3803b234e586a326b513acf8">AST_RWLIST_FIRST</a>(&amp;uris)-&gt;uri) &lt;= len ) {
<a name="l00319"></a>00319       <a class="code" href="linkedlists_8h.html#b4592c522c6b3831f739508553316599">AST_RWLIST_INSERT_HEAD</a>(&amp;uris, urih, entry);
<a name="l00320"></a>00320       <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;uris);
<a name="l00321"></a>00321       <span class="keywordflow">return</span> 0;
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;uris, uri, entry) {
<a name="l00325"></a>00325       <span class="keywordflow">if</span> ( <a class="code" href="linkedlists_8h.html#04a4aa761cd2212562b40eae9f1e2d17">AST_RWLIST_NEXT</a>(uri, entry) 
<a name="l00326"></a>00326          &amp;&amp; strlen(<a class="code" href="linkedlists_8h.html#04a4aa761cd2212562b40eae9f1e2d17">AST_RWLIST_NEXT</a>(uri, entry)-&gt;uri) &lt;= len ) {
<a name="l00327"></a>00327          <a class="code" href="linkedlists_8h.html#655e8a8273d25cecbdc5f6a89f9d46c6">AST_RWLIST_INSERT_AFTER</a>(&amp;uris, uri, urih, entry);
<a name="l00328"></a>00328          <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;uris); 
<a name="l00329"></a>00329          <span class="keywordflow">return</span> 0;
<a name="l00330"></a>00330       }
<a name="l00331"></a>00331    }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333    <a class="code" href="linkedlists_8h.html#64b41a3e9f2e6a867c09431dfae7ce21">AST_RWLIST_INSERT_TAIL</a>(&amp;uris, urih, entry);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;uris);
<a name="l00336"></a>00336    
<a name="l00337"></a>00337    <span class="keywordflow">return</span> 0;
<a name="l00338"></a>00338 }  
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="f5b1e65776547f6a325f4651e67beebc"></a><!-- doxytag: member="http.h::ast_http_uri_unlink" ref="f5b1e65776547f6a325f4651e67beebc" args="(struct ast_http_uri *urihandler)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ast_http_uri_unlink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__http__uri.html">ast_http_uri</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>urihandler</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Destroy an HTTP server. 
<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l00340">340</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00749">AST_RWLIST_REMOVE</a>, <a class="el" href="linkedlists_8h-source.html#l00115">AST_RWLIST_UNLOCK</a>, and <a class="el" href="linkedlists_8h-source.html#l00049">AST_RWLIST_WRLOCK</a>.
<p>
Referenced by <a class="el" href="manager_8c-source.html#l03215">init_manager()</a>.<div class="fragment"><pre class="fragment"><a name="l00341"></a>00341 {
<a name="l00342"></a>00342    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;uris);
<a name="l00343"></a>00343    <a class="code" href="linkedlists_8h.html#dd27d7fa9f70ab8e5e35161cafdd0459">AST_RWLIST_REMOVE</a>(&amp;uris, urih, entry);
<a name="l00344"></a>00344    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;uris);
<a name="l00345"></a>00345 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="abef5638078d2be6908d698ee8c3e47b"></a><!-- doxytag: member="http.h::server_root" ref="abef5638078d2be6908d698ee8c3e47b" args="(void *)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void* server_root           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l00902">902</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="http_8h-source.html#l00125">server_args::accept_fd</a>, <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h-source.html#l00312">ast_pthread_create_detached_background</a>, <a class="el" href="utils_8c-source.html#l00624">ast_wait_for_input()</a>, <a class="el" href="chan__gtalk_8c-source.html#l00172">desc</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="http_8c-source.html#l00715">make_file_from_fd()</a>, <a class="el" href="structserver__args.html#ce87ae1254acc66d50f56124e62e38cf">server_args::periodic_fn</a>, and <a class="el" href="http_8h-source.html#l00126">server_args::poll_timeout</a>.<div class="fragment"><pre class="fragment"><a name="l00903"></a>00903 {
<a name="l00904"></a>00904    <span class="keyword">struct </span><a class="code" href="structserver__args.html">server_args</a> *<a class="code" href="chan__gtalk_8c.html#45c085ae9b1d6f46cf9e03f75b76fd83">desc</a> = data;
<a name="l00905"></a>00905    <span class="keywordtype">int</span> fd;
<a name="l00906"></a>00906    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00907"></a>00907    socklen_t sinlen;
<a name="l00908"></a>00908    <span class="keyword">struct </span><a class="code" href="structserver__instance.html">server_instance</a> *ser;
<a name="l00909"></a>00909    pthread_t launched;
<a name="l00910"></a>00910    
<a name="l00911"></a>00911    <span class="keywordflow">for</span> (;;) {
<a name="l00912"></a>00912       <span class="keywordtype">int</span> i, flags;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914       <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structserver__args.html#ce87ae1254acc66d50f56124e62e38cf">periodic_fn</a>)
<a name="l00915"></a>00915          desc-&gt;<a class="code" href="structserver__args.html#ce87ae1254acc66d50f56124e62e38cf">periodic_fn</a>(desc);
<a name="l00916"></a>00916       i = <a class="code" href="utils_8c.html#88e6eaa2c6fb4d77011df76d5d193728">ast_wait_for_input</a>(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, desc-&gt;<a class="code" href="structserver__args.html#5d611f5d5b5a8c20ae2ac51ecc6c738a">poll_timeout</a>);
<a name="l00917"></a>00917       <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l00918"></a>00918          <span class="keywordflow">continue</span>;
<a name="l00919"></a>00919       sinlen = <span class="keyword">sizeof</span>(sin);
<a name="l00920"></a>00920       fd = accept(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, (<span class="keyword">struct</span> sockaddr *)&amp;sin, &amp;sinlen);
<a name="l00921"></a>00921       <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00922"></a>00922          <span class="keywordflow">if</span> ((errno != EAGAIN) &amp;&amp; (errno != EINTR))
<a name="l00923"></a>00923             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Accept failed: %s\n"</span>, strerror(errno));
<a name="l00924"></a>00924          <span class="keywordflow">continue</span>;
<a name="l00925"></a>00925       }
<a name="l00926"></a>00926       ser = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ser));
<a name="l00927"></a>00927       <span class="keywordflow">if</span> (!ser) {
<a name="l00928"></a>00928          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No memory for new session: %s\n"</span>, strerror(errno));
<a name="l00929"></a>00929          close(fd);
<a name="l00930"></a>00930          <span class="keywordflow">continue</span>;
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932       flags = fcntl(fd, F_GETFL);
<a name="l00933"></a>00933       fcntl(fd, F_SETFL, flags &amp; ~O_NONBLOCK);
<a name="l00934"></a>00934       ser-&gt;<a class="code" href="structserver__instance.html#36eba1e1e343279857ea7f69a597324e">fd</a> = fd;
<a name="l00935"></a>00935       ser-&gt;<a class="code" href="structserver__instance.html#d0e45878043844ffc41aac437e86b602">parent</a> = desc;
<a name="l00936"></a>00936       memcpy(&amp;ser-&gt;<a class="code" href="structserver__instance.html#560115e15fdc6b37096d514904104a57">requestor</a>, &amp;sin, <span class="keyword">sizeof</span>(ser-&gt;<a class="code" href="structserver__instance.html#560115e15fdc6b37096d514904104a57">requestor</a>));
<a name="l00937"></a>00937          
<a name="l00938"></a>00938       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#ca64243ae8a976c50a48a88de8eea818">ast_pthread_create_detached_background</a>(&amp;launched, NULL, <a class="code" href="http_8c.html#70c3c179c45462372a3a311bc6d01ab3">make_file_from_fd</a>, ser)) {
<a name="l00939"></a>00939          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to launch helper thread: %s\n"</span>, strerror(errno));
<a name="l00940"></a>00940          close(ser-&gt;<a class="code" href="structserver__instance.html#36eba1e1e343279857ea7f69a597324e">fd</a>);
<a name="l00941"></a>00941          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ser);
<a name="l00942"></a>00942       }
<a name="l00943"></a>00943 
<a name="l00944"></a>00944    }
<a name="l00945"></a>00945    <span class="keywordflow">return</span> NULL;
<a name="l00946"></a>00946 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="78825d347437f6b39162f2bb595118fb"></a><!-- doxytag: member="http.h::server_start" ref="78825d347437f6b39162f2bb595118fb" args="(struct server_args *desc)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void server_start           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structserver__args.html">server_args</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>desc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This is a generic (re)start routine for a TCP server, which does the socket/bind/listen and starts a thread for handling accept(). 
<p>
Definition at line <a class="el" href="http_8c-source.html#l00987">987</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="http_8h-source.html#l00125">server_args::accept_fd</a>, <a class="el" href="structserver__args.html#16497136cadef2aaedc26131afebadca">server_args::accept_fn</a>, <a class="el" href="utils_8c-source.html#l00493">ast_inet_ntoa()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h-source.html#l00307">ast_pthread_create_background</a>, <a class="el" href="lock_8h-source.html#l00074">AST_PTHREADT_NULL</a>, <a class="el" href="dlfcn_8c-source.html#l00196">error()</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="http_8h-source.html#l00127">server_args::master</a>, <a class="el" href="http_8h-source.html#l00131">server_args::name</a>, <a class="el" href="http_8h-source.html#l00123">server_args::oldsin</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, and <a class="el" href="http_8h-source.html#l00122">server_args::sin</a>.
<p>
Referenced by <a class="el" href="http_8c-source.html#l01148">__ast_http_load()</a>, and <a class="el" href="manager_8c-source.html#l03215">init_manager()</a>.<div class="fragment"><pre class="fragment"><a name="l00988"></a>00988 {
<a name="l00989"></a>00989    <span class="keywordtype">int</span> flags;
<a name="l00990"></a>00990    <span class="keywordtype">int</span> x = 1;
<a name="l00991"></a>00991    
<a name="l00992"></a>00992    <span class="comment">/* Do nothing if nothing has changed */</span>
<a name="l00993"></a>00993    <span class="keywordflow">if</span> (!memcmp(&amp;desc-&gt;<a class="code" href="structserver__args.html#ecb90d759ff1db450f5ffab507ac5542">oldsin</a>, &amp;desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structserver__args.html#ecb90d759ff1db450f5ffab507ac5542">oldsin</a>))) {
<a name="l00994"></a>00994       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00995"></a>00995          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Nothing changed in %s\n"</span>, desc-&gt;<a class="code" href="structserver__args.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00996"></a>00996       <span class="keywordflow">return</span>;
<a name="l00997"></a>00997    }
<a name="l00998"></a>00998    
<a name="l00999"></a>00999    desc-&gt;<a class="code" href="structserver__args.html#ecb90d759ff1db450f5ffab507ac5542">oldsin</a> = desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>;
<a name="l01000"></a>01000    
<a name="l01001"></a>01001    <span class="comment">/* Shutdown a running server if there is one */</span>
<a name="l01002"></a>01002    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structserver__args.html#eb0a191797624dd3a48fa681d3061212">master</a> != <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>) {
<a name="l01003"></a>01003       pthread_cancel(desc-&gt;<a class="code" href="structserver__args.html#eb0a191797624dd3a48fa681d3061212">master</a>);
<a name="l01004"></a>01004       pthread_kill(desc-&gt;<a class="code" href="structserver__args.html#eb0a191797624dd3a48fa681d3061212">master</a>, SIGURG);
<a name="l01005"></a>01005       pthread_join(desc-&gt;<a class="code" href="structserver__args.html#eb0a191797624dd3a48fa681d3061212">master</a>, NULL);
<a name="l01006"></a>01006    }
<a name="l01007"></a>01007    
<a name="l01008"></a>01008    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> != -1)
<a name="l01009"></a>01009       close(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011    <span class="comment">/* If there's no new server, stop here */</span>
<a name="l01012"></a>01012    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_family == 0)
<a name="l01013"></a>01013       <span class="keywordflow">return</span>;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015    desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> = socket(AF_INET, SOCK_STREAM, 0);
<a name="l01016"></a>01016    <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> &lt; 0) {
<a name="l01017"></a>01017       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to allocate socket for %s: %s\n"</span>,
<a name="l01018"></a>01018          desc-&gt;<a class="code" href="structserver__args.html#b068931cc450442b63f5b3d276ea4297">name</a>, strerror(errno));
<a name="l01019"></a>01019       <span class="keywordflow">return</span>;
<a name="l01020"></a>01020    }
<a name="l01021"></a>01021    
<a name="l01022"></a>01022    setsockopt(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, SOL_SOCKET, SO_REUSEADDR, &amp;x, <span class="keyword">sizeof</span>(x));
<a name="l01023"></a>01023    <span class="keywordflow">if</span> (bind(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, (<span class="keyword">struct</span> sockaddr *)&amp;desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>))) {
<a name="l01024"></a>01024       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to bind %s to %s:%d: %s\n"</span>,
<a name="l01025"></a>01025          desc-&gt;<a class="code" href="structserver__args.html#b068931cc450442b63f5b3d276ea4297">name</a>,
<a name="l01026"></a>01026          <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port),
<a name="l01027"></a>01027          strerror(errno));
<a name="l01028"></a>01028       <span class="keywordflow">goto</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a>;
<a name="l01029"></a>01029    }
<a name="l01030"></a>01030    <span class="keywordflow">if</span> (listen(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, 10)) {
<a name="l01031"></a>01031       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_NOTICE, <span class="stringliteral">"Unable to listen for %s!\n"</span>, desc-&gt;<a class="code" href="structserver__args.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01032"></a>01032       <span class="keywordflow">goto</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a>;
<a name="l01033"></a>01033    }
<a name="l01034"></a>01034    flags = fcntl(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, F_GETFL);
<a name="l01035"></a>01035    fcntl(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>, F_SETFL, flags | O_NONBLOCK);
<a name="l01036"></a>01036    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#351b78c7aeb62b2b57eb447287cdd9d4">ast_pthread_create_background</a>(&amp;desc-&gt;<a class="code" href="structserver__args.html#eb0a191797624dd3a48fa681d3061212">master</a>, NULL, desc-&gt;<a class="code" href="structserver__args.html#16497136cadef2aaedc26131afebadca">accept_fn</a>, desc)) {
<a name="l01037"></a>01037       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_NOTICE, <span class="stringliteral">"Unable to launch %s on %s:%d: %s\n"</span>,
<a name="l01038"></a>01038          desc-&gt;<a class="code" href="structserver__args.html#b068931cc450442b63f5b3d276ea4297">name</a>,
<a name="l01039"></a>01039          <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), ntohs(desc-&gt;<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port),
<a name="l01040"></a>01040          strerror(errno));
<a name="l01041"></a>01041       <span class="keywordflow">goto</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a>;
<a name="l01042"></a>01042    }
<a name="l01043"></a>01043    <span class="keywordflow">return</span>;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a>:
<a name="l01046"></a>01046    close(desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a>);
<a name="l01047"></a>01047    desc-&gt;<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> = -1;
<a name="l01048"></a>01048 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="099674f856134f6c71303eceb54558dd"></a><!-- doxytag: member="http.h::ssl_setup" ref="099674f856134f6c71303eceb54558dd" args="(struct tls_config *cfg)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ssl_setup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structtls__config.html">tls_config</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>cfg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="http_8c-source.html#l00948">948</a> of file <a class="el" href="http_8c-source.html">http.c</a>.
<p>
References <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="logger_8c-source.html#l00989">ast_verbose()</a>, <a class="el" href="http_8h-source.html#l00071">tls_config::certfile</a>, <a class="el" href="http_8h-source.html#l00072">tls_config::cipher</a>, <a class="el" href="http_8h-source.html#l00070">tls_config::enabled</a>, and <a class="el" href="http_8h-source.html#l00073">tls_config::ssl_ctx</a>.
<p>
Referenced by <a class="el" href="http_8c-source.html#l01148">__ast_http_load()</a>, and <a class="el" href="manager_8c-source.html#l03215">init_manager()</a>.<div class="fragment"><pre class="fragment"><a name="l00949"></a>00949 {
<a name="l00950"></a>00950 <span class="preprocessor">#ifndef DO_SSL</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span>   cfg-&gt;<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a> = 0;
<a name="l00952"></a>00952    <span class="keywordflow">return</span> 0;
<a name="l00953"></a>00953 <span class="preprocessor">#else</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!cfg-&gt;<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a>)
<a name="l00955"></a>00955       <span class="keywordflow">return</span> 0;
<a name="l00956"></a>00956    SSL_load_error_strings();
<a name="l00957"></a>00957    SSLeay_add_ssl_algorithms();
<a name="l00958"></a>00958    cfg-&gt;<a class="code" href="structtls__config.html#0829c3c12defa57caf9fbb607779ca64">ssl_ctx</a> = SSL_CTX_new( SSLv23_server_method() );
<a name="l00959"></a>00959    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cfg-&gt;<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>)) {
<a name="l00960"></a>00960       <span class="keywordflow">if</span> (SSL_CTX_use_certificate_file(cfg-&gt;<a class="code" href="structtls__config.html#0829c3c12defa57caf9fbb607779ca64">ssl_ctx</a>, cfg-&gt;<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>, SSL_FILETYPE_PEM) == 0 ||
<a name="l00961"></a>00961           SSL_CTX_use_PrivateKey_file(cfg-&gt;<a class="code" href="structtls__config.html#0829c3c12defa57caf9fbb607779ca64">ssl_ctx</a>, cfg-&gt;<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>, SSL_FILETYPE_PEM) == 0 ||
<a name="l00962"></a>00962           SSL_CTX_check_private_key(cfg-&gt;<a class="code" href="structtls__config.html#0829c3c12defa57caf9fbb607779ca64">ssl_ctx</a>) == 0 ) {
<a name="l00963"></a>00963          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"ssl cert error &lt;%s&gt;"</span>, cfg-&gt;<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>);
<a name="l00964"></a>00964          sleep(2);
<a name="l00965"></a>00965          cfg-&gt;<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a> = 0;
<a name="l00966"></a>00966          <span class="keywordflow">return</span> 0;
<a name="l00967"></a>00967       }
<a name="l00968"></a>00968    }
<a name="l00969"></a>00969    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cfg-&gt;<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>)) {
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (SSL_CTX_set_cipher_list(cfg-&gt;<a class="code" href="structtls__config.html#0829c3c12defa57caf9fbb607779ca64">ssl_ctx</a>, cfg-&gt;<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>) == 0 ) {
<a name="l00971"></a>00971          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"ssl cipher error &lt;%s&gt;"</span>, cfg-&gt;<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>);
<a name="l00972"></a>00972          sleep(2);
<a name="l00973"></a>00973          cfg-&gt;<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a> = 0;
<a name="l00974"></a>00974          <span class="keywordflow">return</span> 0;
<a name="l00975"></a>00975       }
<a name="l00976"></a>00976    }
<a name="l00977"></a>00977    <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"ssl cert ok"</span>);
<a name="l00978"></a>00978    <span class="keywordflow">return</span> 1;
<a name="l00979"></a>00979 <span class="preprocessor">#endif</span>
<a name="l00980"></a>00980 <span class="preprocessor"></span>}
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:32 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
