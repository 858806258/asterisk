<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:47 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>sched.c File Reference</h1>Scheduler Routines (from cheops-NG). <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="asterisk_8h-source.html">asterisk.h</a>&quot;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;sys/time.h&gt;</code><br>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &quot;<a class="el" href="sched_8h-source.html">asterisk/sched.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="logger_8h-source.html">asterisk/logger.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="channel_8h-source.html">asterisk/channel.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="lock_8h-source.html">asterisk/lock.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="utils_8h-source.html">asterisk/utils.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="linkedlists_8h-source.html">asterisk/linkedlists.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="options_8h-source.html">asterisk/options.h</a>&quot;</code><br>

<p>
<a href="sched_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsched.html">sched</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsched__context.html">sched_context</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(a)</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#d8304ea2ef7bcdee5012e64ab1356d96">ast_sched_add</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, int when, <a class="el" href="sched_8h.html#9605936bee6e17b484c63739763f2dfd">ast_sched_cb</a> callback, void *data)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Adds a scheduled event Schedule an event to take place at some point in the future. callback will be called with data as the argument, when milliseconds into the future (approximately) If callback returns 0, no further events will be re-scheduled.  <a href="#d8304ea2ef7bcdee5012e64ab1356d96"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#5e691064a5722460631d25cabf3b7756">ast_sched_add_variable</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, int when, <a class="el" href="sched_8h.html#9605936bee6e17b484c63739763f2dfd">ast_sched_cb</a> callback, void *data, int variable)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Schedule callback(data) to happen when ms into the future.  <a href="#5e691064a5722460631d25cabf3b7756"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#4a0b784f64b9caf71932a3344c9c7c49">ast_sched_del</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, int <a class="el" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Deletes a scheduled event Remove this event from being run. A procedure should not remove its own event, but return 0 instead.  <a href="#4a0b784f64b9caf71932a3344c9c7c49"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#7f890ed471e466f5c4e339bae5f253f4">ast_sched_dump</a> (const struct <a class="el" href="structsched__context.html">sched_context</a> *con)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Dumps the scheduler contents Debugging: Dump the contents of the scheduler to stderr.  <a href="#7f890ed471e466f5c4e339bae5f253f4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#2ea97d35de659fe307e6d5c6c4e11ffc">ast_sched_runq</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Runs the queue.  <a href="#2ea97d35de659fe307e6d5c6c4e11ffc"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#be772a122828e81602f21038162f6dff">ast_sched_wait</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Determines number of seconds until the next outstanding event to take place Determine the number of seconds until the next outstanding event should take place, and return the number of milliseconds until it needs to be run. This value is perfect for passing to the poll call.  <a href="#be772a122828e81602f21038162f6dff"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#c37432659ca9d317b5517fc2716a35a9">ast_sched_when</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, int <a class="el" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the number of seconds before an event takes place.  <a href="#c37432659ca9d317b5517fc2716a35a9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static struct <a class="el" href="structsched.html">sched</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#cc2bbfa690db7aa3dd7e3b13a3392147">sched_alloc</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#4326fa64fd840788d03093b9931bb1fb">sched_context_create</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">New schedule context.  <a href="#4326fa64fd840788d03093b9931bb1fb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#89e2eb9653fa462ad4ff62e05ad36050">sched_context_destroy</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">destroys a schedule context Destroys (free's) the given <a class="el" href="structsched__context.html">sched_context</a> structure  <a href="#89e2eb9653fa462ad4ff62e05ad36050"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#cf5848e6d5d1c9f12ef21fb0f324f43a">sched_release</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, struct <a class="el" href="structsched.html">sched</a> *tmp)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#09803f24cad88f67130506d3e58a2769">sched_settime</a> (struct timeval *<a class="el" href="time_8h.html#c9a1fdac6e082dd89e7173244f34d7b3">tv</a>, int when)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">given the last event *tv and the offset in milliseconds 'when', computes the next value,  <a href="#09803f24cad88f67130506d3e58a2769"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sched_8c.html#d516af5ac8853428f66cc60a632cbba2">schedule</a> (struct <a class="el" href="structsched__context.html">sched_context</a> *con, struct <a class="el" href="structsched.html">sched</a> *s)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Take a sched structure and put it in the queue, such that the soonest event is first in the list.  <a href="#d516af5ac8853428f66cc60a632cbba2"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Scheduler Routines (from cheops-NG). 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt; </dd></dl>

<p>
Definition in file <a class="el" href="sched_8c-source.html">sched.c</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="5ca9902d44b6807e17916b56a97dc3cf"></a><!-- doxytag: member="sched.c::DEBUG" ref="5ca9902d44b6807e17916b56a97dc3cf" args="(a)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define DEBUG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00036">36</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="d8304ea2ef7bcdee5012e64ab1356d96"></a><!-- doxytag: member="sched.c::ast_sched_add" ref="d8304ea2ef7bcdee5012e64ab1356d96" args="(struct sched_context *con, int when, ast_sched_cb callback, void *data)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_sched_add           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>when</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="sched_8h.html#9605936bee6e17b484c63739763f2dfd">ast_sched_cb</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>void *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Adds a scheduled event Schedule an event to take place at some point in the future. callback will be called with data as the argument, when milliseconds into the future (approximately) If callback returns 0, no further events will be re-scheduled. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>Scheduler context to add </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>when</em>&nbsp;</td><td>how many milliseconds to wait for event to occur </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>callback</em>&nbsp;</td><td>function to call when the amount of time expires </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>data to pass to the callback </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns a schedule item ID on success, -1 on failure </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00248">248</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>.
<p>
Referenced by <a class="el" href="chan__iax2_8c-source.html#l01905">__attempt_transmit()</a>, <a class="el" href="chan__iax2_8c-source.html#l08190">__iax2_poke_noanswer()</a>, <a class="el" href="chan__h323_8c-source.html#l00342">__oh323_update_info()</a>, <a class="el" href="chan__iax2_8c-source.html#l01037">__send_lagrq()</a>, <a class="el" href="chan__iax2_8c-source.html#l01003">__send_ping()</a>, <a class="el" href="file_8c-source.html#l00609">ast_readaudio_callback()</a>, <a class="el" href="file_8c-source.html#l00639">ast_readvideo_callback()</a>, <a class="el" href="rtp_8c-source.html#l01171">ast_rtp_read()</a>, <a class="el" href="chan__iax2_8c-source.html#l05990">auth_fail()</a>, <a class="el" href="pbx__dundi_8c-source.html#l04282">build_peer()</a>, <a class="el" href="pbx__dundi_8c-source.html#l04197">do_register()</a>, <a class="el" href="cdr_8c-source.html#l01229">do_reload()</a>, <a class="el" href="pbx__dundi_8c-source.html#l03049">dundi_discover()</a>, <a class="el" href="pbx__dundi_8c-source.html#l03139">dundi_query()</a>, <a class="el" href="pbx__dundi_8c-source.html#l02945">dundi_send()</a>, <a class="el" href="chan__iax2_8c-source.html#l01308">find_callno()</a>, <a class="el" href="pbx__dundi_8c-source.html#l01515">handle_command_response()</a>, <a class="el" href="chan__sip_8c-source.html#l13071">handle_response_peerpoke()</a>, <a class="el" href="chan__iax2_8c-source.html#l05519">iax2_ack_registry()</a>, <a class="el" href="chan__iax2_8c-source.html#l02914">iax2_call()</a>, <a class="el" href="chan__iax2_8c-source.html#l08012">iax2_do_register()</a>, <a class="el" href="chan__iax2_8c-source.html#l06038">iax2_dprequest()</a>, <a class="el" href="chan__iax2_8c-source.html#l08220">iax2_poke_peer()</a>, <a class="el" href="chan__iax2_8c-source.html#l08076">iax2_provision()</a>, <a class="el" href="chan__iax2_8c-source.html#l01246">make_trunk()</a>, <a class="el" href="chan__mgcp_8c-source.html#l00696">mgcp_postrequest()</a>, <a class="el" href="chan__iax2_8c-source.html#l08386">network_thread()</a>, <a class="el" href="chan__sip_8c-source.html#l08437">parse_register_contact()</a>, <a class="el" href="pbx__dundi_8c-source.html#l04258">populate_addr()</a>, <a class="el" href="pbx__dundi_8c-source.html#l03073">precache_trans()</a>, <a class="el" href="pbx__dundi_8c-source.html#l04233">qualify_peer()</a>, <a class="el" href="chan__iax2_8c-source.html#l02556">realtime_peer()</a>, <a class="el" href="chan__h323_8c-source.html#l01833">receive_digit()</a>, <a class="el" href="chan__iax2_8c-source.html#l05719">reg_source_db()</a>, <a class="el" href="chan__sip_8c-source.html#l03169">sip_call()</a>, <a class="el" href="chan__sip_8c-source.html#l18216">sip_poke_all_peers()</a>, <a class="el" href="chan__sip_8c-source.html#l16137">sip_poke_noanswer()</a>, <a class="el" href="chan__sip_8c-source.html#l16161">sip_poke_peer()</a>, <a class="el" href="chan__sip_8c-source.html#l02223">sip_scheddestroy()</a>, <a class="el" href="chan__sip_8c-source.html#l18235">sip_send_all_registers()</a>, <a class="el" href="cdr_8c-source.html#l01065">submit_scheduled_batch()</a>, <a class="el" href="cdr_8c-source.html#l01074">submit_unscheduled_batch()</a>, <a class="el" href="chan__sip_8c-source.html#l07883">transmit_register()</a>, <a class="el" href="chan__iax2_8c-source.html#l02316">update_jbsched()</a>, and <a class="el" href="chan__iax2_8c-source.html#l05757">update_registry()</a>.<div class="fragment"><pre class="fragment"><a name="l00249"></a>00249 {
<a name="l00250"></a>00250    <span class="keywordflow">return</span> <a class="code" href="sched_8c.html#5e691064a5722460631d25cabf3b7756">ast_sched_add_variable</a>(con, when, callback, data, 0);
<a name="l00251"></a>00251 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="5e691064a5722460631d25cabf3b7756"></a><!-- doxytag: member="sched.c::ast_sched_add_variable" ref="5e691064a5722460631d25cabf3b7756" args="(struct sched_context *con, int when, ast_sched_cb callback, void *data, int variable)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_sched_add_variable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>when</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="sched_8h.html#9605936bee6e17b484c63739763f2dfd">ast_sched_cb</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>void *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>variable</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Schedule callback(data) to happen when ms into the future. 
<p>
Adds a scheduled event with rescheduling support <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>Scheduler context to add </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>when</em>&nbsp;</td><td>how many milliseconds to wait for event to occur </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>callback</em>&nbsp;</td><td>function to call when the amount of time expires </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>data to pass to the callback </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>variable</em>&nbsp;</td><td>If true, the result value of callback function will be used for rescheduling Schedule an event to take place at some point in the future. Callback will be called with data as the argument, when milliseconds into the future (approximately) If callback returns 0, no further events will be re-scheduled </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns a schedule item ID on success, -1 on failure </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00215">215</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="sched_8c-source.html#l00296">ast_sched_dump()</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="sched_8c-source.html#l00065">sched_context::eventcnt</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="sched_8c-source.html#l00110">sched_alloc()</a>, <a class="el" href="sched_8c-source.html#l00128">sched_release()</a>, <a class="el" href="sched_8c-source.html#l00195">sched_settime()</a>, and <a class="el" href="sched_8c-source.html#l00173">schedule()</a>.
<p>
Referenced by <a class="el" href="chan__sip_8c-source.html#l02137">__sip_reliable_xmit()</a>, <a class="el" href="chan__misdn_8c-source.html#l00615">_misdn_tasks_add_variable()</a>, <a class="el" href="sched_8c-source.html#l00248">ast_sched_add()</a>, <a class="el" href="dnsmgr_8c-source.html#l00251">dnsmgr_start_refresh()</a>, and <a class="el" href="dnsmgr_8c-source.html#l00352">do_reload()</a>.<div class="fragment"><pre class="fragment"><a name="l00216"></a>00216 {
<a name="l00217"></a>00217    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *tmp;
<a name="l00218"></a>00218    <span class="keywordtype">int</span> res = -1;
<a name="l00219"></a>00219    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_sched_add()\n"</span>));
<a name="l00220"></a>00220    <span class="keywordflow">if</span> (!when) {
<a name="l00221"></a>00221       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Scheduled event in 0 ms?\n"</span>);
<a name="l00222"></a>00222       <span class="keywordflow">return</span> -1;
<a name="l00223"></a>00223    }
<a name="l00224"></a>00224    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00225"></a>00225    <span class="keywordflow">if</span> ((tmp = <a class="code" href="sched_8c.html#cc2bbfa690db7aa3dd7e3b13a3392147">sched_alloc</a>(con))) {
<a name="l00226"></a>00226       tmp-&gt;id = con-&gt;<a class="code" href="structsched__context.html#1e3408409b037d6c48cbedc34facba8b">eventcnt</a>++;
<a name="l00227"></a>00227       tmp-&gt;callback = callback;
<a name="l00228"></a>00228       tmp-&gt;data = data;
<a name="l00229"></a>00229       tmp-&gt;resched = when;
<a name="l00230"></a>00230       tmp-&gt;variable = variable;
<a name="l00231"></a>00231       tmp-&gt;when = ast_tv(0, 0);
<a name="l00232"></a>00232       <span class="keywordflow">if</span> (<a class="code" href="sched_8c.html#09803f24cad88f67130506d3e58a2769">sched_settime</a>(&amp;tmp-&gt;when, when)) {
<a name="l00233"></a>00233          <a class="code" href="sched_8c.html#cf5848e6d5d1c9f12ef21fb0f324f43a">sched_release</a>(con, tmp);
<a name="l00234"></a>00234       } <span class="keywordflow">else</span> {
<a name="l00235"></a>00235          <a class="code" href="sched_8c.html#d516af5ac8853428f66cc60a632cbba2">schedule</a>(con, tmp);
<a name="l00236"></a>00236          res = tmp-&gt;id;
<a name="l00237"></a>00237       }
<a name="l00238"></a>00238    }
<a name="l00239"></a>00239 <span class="preprocessor">#ifdef DUMP_SCHEDULER</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>   <span class="comment">/* Dump contents of the context while we have the lock so nothing gets screwed up by accident. */</span>
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00242"></a>00242       <a class="code" href="sched_8c.html#7f890ed471e466f5c4e339bae5f253f4">ast_sched_dump</a>(con);
<a name="l00243"></a>00243 <span class="preprocessor">#endif</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00245"></a>00245    <span class="keywordflow">return</span> res;
<a name="l00246"></a>00246 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="4a0b784f64b9caf71932a3344c9c7c49"></a><!-- doxytag: member="sched.c::ast_sched_del" ref="4a0b784f64b9caf71932a3344c9c7c49" args="(struct sched_context *con, int id)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_sched_del           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>id</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Deletes a scheduled event Remove this event from being run. A procedure should not remove its own event, but return 0 instead. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>scheduling context to delete item from </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>id</em>&nbsp;</td><td>ID of the scheduled item to delete </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns 0 on success, -1 on failure </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00259">259</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00516">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h-source.html#l00491">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h-source.html#l00554">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="sched_8c-source.html#l00296">ast_sched_dump()</a>, <a class="el" href="channel_8h-source.html#l01384">CRASH</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="aesopt_8h-source.html#l00399">s</a>, <a class="el" href="sched_8c-source.html#l00128">sched_release()</a>, and <a class="el" href="sched_8c-source.html#l00066">sched_context::schedcnt</a>.
<p>
Referenced by <a class="el" href="chan__h323_8c-source.html#l00455">__oh323_destroy()</a>, <a class="el" href="chan__h323_8c-source.html#l00342">__oh323_update_info()</a>, <a class="el" href="chan__sip_8c-source.html#l02251">__sip_ack()</a>, <a class="el" href="chan__sip_8c-source.html#l03286">__sip_destroy()</a>, <a class="el" href="chan__sip_8c-source.html#l02137">__sip_reliable_xmit()</a>, <a class="el" href="chan__sip_8c-source.html#l02312">__sip_semi_ack()</a>, <a class="el" href="pbx__dundi_8c-source.html#l01925">ack_trans()</a>, <a class="el" href="file_8c-source.html#l00701">ast_closestream()</a>, <a class="el" href="rtp_8c-source.html#l02520">ast_rtcp_write_rr()</a>, <a class="el" href="rtp_8c-source.html#l02406">ast_rtcp_write_sr()</a>, <a class="el" href="rtp_8c-source.html#l02176">ast_rtp_destroy()</a>, <a class="el" href="rtp_8c-source.html#l02107">ast_rtp_stop()</a>, <a class="el" href="chan__iax2_8c-source.html#l05990">auth_fail()</a>, <a class="el" href="chan__mgcp_8c-source.html#l03593">build_gateway()</a>, <a class="el" href="chan__iax2_8c-source.html#l08607">build_peer()</a>, <a class="el" href="chan__iax2_8c-source.html#l09068">delete_users()</a>, <a class="el" href="pbx__dundi_8c-source.html#l02826">destroy_packet()</a>, <a class="el" href="pbx__dundi_8c-source.html#l01913">destroy_packets()</a>, <a class="el" href="chan__iax2_8c-source.html#l09131">destroy_peer()</a>, <a class="el" href="pbx__dundi_8c-source.html#l02838">destroy_trans()</a>, <a class="el" href="dnsmgr_8c-source.html#l00251">dnsmgr_start_refresh()</a>, <a class="el" href="cdr_8c-source.html#l01229">do_reload()</a>, <a class="el" href="pbx__dundi_8c-source.html#l01515">handle_command_response()</a>, <a class="el" href="chan__sip_8c-source.html#l12569">handle_response_invite()</a>, <a class="el" href="chan__sip_8c-source.html#l13071">handle_response_peerpoke()</a>, <a class="el" href="chan__sip_8c-source.html#l12931">handle_response_register()</a>, <a class="el" href="chan__iax2_8c-source.html#l05519">iax2_ack_registry()</a>, <a class="el" href="chan__iax2_8c-source.html#l01762">iax2_destroy_helper()</a>, <a class="el" href="chan__iax2_8c-source.html#l08012">iax2_do_register()</a>, <a class="el" href="chan__iax2_8c-source.html#l06038">iax2_dprequest()</a>, <a class="el" href="chan__iax2_8c-source.html#l01389">iax2_frame_free()</a>, <a class="el" href="chan__iax2_8c-source.html#l08220">iax2_poke_peer()</a>, <a class="el" href="chan__iax2_8c-source.html#l08076">iax2_provision()</a>, <a class="el" href="chan__iax2_8c-source.html#l01246">make_trunk()</a>, <a class="el" href="chan__mgcp_8c-source.html#l03331">mgcpsock_read()</a>, <a class="el" href="chan__misdn_8c-source.html#l00638">misdn_tasks_remove()</a>, <a class="el" href="chan__sip_8c-source.html#l08437">parse_register_contact()</a>, <a class="el" href="pbx__dundi_8c-source.html#l04233">qualify_peer()</a>, <a class="el" href="chan__iax2_8c-source.html#l02556">realtime_peer()</a>, <a class="el" href="chan__h323_8c-source.html#l01833">receive_digit()</a>, <a class="el" href="chan__iax2_8c-source.html#l05719">reg_source_db()</a>, <a class="el" href="chan__sip_8c-source.html#l02241">sip_cancel_destroy()</a>, <a class="el" href="chan__sip_8c-source.html#l02679">sip_destroy_peer()</a>, <a class="el" href="chan__sip_8c-source.html#l18216">sip_poke_all_peers()</a>, <a class="el" href="chan__sip_8c-source.html#l16161">sip_poke_peer()</a>, <a class="el" href="chan__sip_8c-source.html#l03261">sip_registry_destroy()</a>, <a class="el" href="chan__sip_8c-source.html#l02223">sip_scheddestroy()</a>, <a class="el" href="chan__sip_8c-source.html#l18235">sip_send_all_registers()</a>, <a class="el" href="chan__iax2_8c-source.html#l06624">socket_process()</a>, <a class="el" href="cdr_8c-source.html#l01074">submit_unscheduled_batch()</a>, <a class="el" href="chan__sip_8c-source.html#l07883">transmit_register()</a>, <a class="el" href="chan__iax2_8c-source.html#l02316">update_jbsched()</a>, and <a class="el" href="chan__iax2_8c-source.html#l05757">update_registry()</a>.<div class="fragment"><pre class="fragment"><a name="l00260"></a>00260 {
<a name="l00261"></a>00261    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_sched_del()\n"</span>));
<a name="l00264"></a>00264    
<a name="l00265"></a>00265    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00266"></a>00266    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;con-&gt;schedq, s, list) {
<a name="l00267"></a>00267       <span class="keywordflow">if</span> (s-&gt;id == <span class="keywordtype">id</span>) {
<a name="l00268"></a>00268          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;con-&gt;schedq, list);
<a name="l00269"></a>00269          con-&gt;<a class="code" href="structsched__context.html#4c5a5e5eafcd99b2080d5a7a4bcb5ab9">schedcnt</a>--;
<a name="l00270"></a>00270          <a class="code" href="sched_8c.html#cf5848e6d5d1c9f12ef21fb0f324f43a">sched_release</a>(con, s);
<a name="l00271"></a>00271          <span class="keywordflow">break</span>;
<a name="l00272"></a>00272       }
<a name="l00273"></a>00273    }
<a name="l00274"></a>00274    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="preprocessor">#ifdef DUMP_SCHEDULER</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>   <span class="comment">/* Dump contents of the context while we have the lock so nothing gets screwed up by accident. */</span>
<a name="l00278"></a>00278    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00279"></a>00279       <a class="code" href="sched_8c.html#7f890ed471e466f5c4e339bae5f253f4">ast_sched_dump</a>(con);
<a name="l00280"></a>00280 <span class="preprocessor">#endif</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283    <span class="keywordflow">if</span> (!s) {
<a name="l00284"></a>00284       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00285"></a>00285          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Attempted to delete nonexistent schedule entry %d!\n"</span>, <span class="keywordtype">id</span>);
<a name="l00286"></a>00286 <span class="preprocessor">#ifdef DO_CRASH</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>      <a class="code" href="channel_8h.html#cef2f26f7da88da7db20faa12bd436c4">CRASH</a>;
<a name="l00288"></a>00288 <span class="preprocessor">#endif</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>      <span class="keywordflow">return</span> -1;
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291    
<a name="l00292"></a>00292    <span class="keywordflow">return</span> 0;
<a name="l00293"></a>00293 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="7f890ed471e466f5c4e339bae5f253f4"></a><!-- doxytag: member="sched.c::ast_sched_dump" ref="7f890ed471e466f5c4e339bae5f253f4" args="(const struct sched_context *con)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ast_sched_dump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>con</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Dumps the scheduler contents Debugging: Dump the contents of the scheduler to stderr. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>Context to dump </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00296">296</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00453">AST_LIST_TRAVERSE</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8c-source.html#l00792">ast_tvsub()</a>, <a class="el" href="sched_8c-source.html#l00065">sched_context::eventcnt</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, and <a class="el" href="sched_8c-source.html#l00066">sched_context::schedcnt</a>.
<p>
Referenced by <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>, and <a class="el" href="sched_8c-source.html#l00259">ast_sched_del()</a>.<div class="fragment"><pre class="fragment"><a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *q;
<a name="l00299"></a>00299    <span class="keyword">struct </span>timeval tv = ast_tvnow();
<a name="l00300"></a>00300 <span class="preprocessor">#ifdef SCHED_MAX_CACHE</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00302"></a>00302       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Asterisk Schedule Dump (%d in Q, %d Total, %d Cache)\n"</span>, con-&gt;<a class="code" href="structsched__context.html#4c5a5e5eafcd99b2080d5a7a4bcb5ab9">schedcnt</a>, con-&gt;<a class="code" href="structsched__context.html#1e3408409b037d6c48cbedc34facba8b">eventcnt</a> - 1, con-&gt;schedccnt);
<a name="l00303"></a>00303 <span class="preprocessor">#else</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00305"></a>00305       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Asterisk Schedule Dump (%d in Q, %d Total)\n"</span>, con-&gt;<a class="code" href="structsched__context.html#4c5a5e5eafcd99b2080d5a7a4bcb5ab9">schedcnt</a>, con-&gt;<a class="code" href="structsched__context.html#1e3408409b037d6c48cbedc34facba8b">eventcnt</a> - 1);
<a name="l00306"></a>00306 <span class="preprocessor">#endif</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>
<a name="l00308"></a>00308    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00309"></a>00309    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"=============================================================\n"</span>);
<a name="l00310"></a>00310    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"|ID    Callback          Data              Time  (sec:ms)   |\n"</span>);
<a name="l00311"></a>00311    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"+-----+-----------------+-----------------+-----------------+\n"</span>);
<a name="l00312"></a>00312       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;con-&gt;schedq, q, list) {
<a name="l00313"></a>00313          <span class="keyword">struct </span>timeval delta = <a class="code" href="utils_8c.html#fd14d2161a764b21024b6623154e5f9d">ast_tvsub</a>(q-&gt;when, tv);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"|%.4d | %-15p | %-15p | %.6ld : %.6ld |\n"</span>, 
<a name="l00316"></a>00316             q-&gt;id,
<a name="l00317"></a>00317             q-&gt;callback,
<a name="l00318"></a>00318             q-&gt;data,
<a name="l00319"></a>00319             delta.tv_sec,
<a name="l00320"></a>00320             (<span class="keywordtype">long</span> <span class="keywordtype">int</span>)delta.tv_usec);
<a name="l00321"></a>00321       }
<a name="l00322"></a>00322       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"=============================================================\n"</span>);
<a name="l00323"></a>00323    }
<a name="l00324"></a>00324 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="2ea97d35de659fe307e6d5c6c4e11ffc"></a><!-- doxytag: member="sched.c::ast_sched_runq" ref="2ea97d35de659fe307e6d5c6c4e11ffc" args="(struct sched_context *con)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_sched_runq           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>con</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Runs the queue. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>Scheduling context to run Run the queue, executing all callbacks which need to be performed at this time. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>context to act upon </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns the number of events processed. </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00329">329</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00413">AST_LIST_EMPTY</a>, <a class="el" href="linkedlists_8h-source.html#l00385">AST_LIST_FIRST</a>, <a class="el" href="linkedlists_8h-source.html#l00710">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="utils_8c-source.html#l00778">ast_tvadd()</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="sched_8c-source.html#l00128">sched_release()</a>, <a class="el" href="sched_8c-source.html#l00195">sched_settime()</a>, <a class="el" href="sched_8c-source.html#l00066">sched_context::schedcnt</a>, and <a class="el" href="sched_8c-source.html#l00173">schedule()</a>.
<p>
Referenced by <a class="el" href="app__talkdetect_8c-source.html#l00063">background_detect_exec()</a>, <a class="el" href="cdr_8c-source.html#l01143">do_cdr()</a>, <a class="el" href="chan__sip_8c-source.html#l16035">do_monitor()</a>, <a class="el" href="dnsmgr_8c-source.html#l00211">do_refresh()</a>, <a class="el" href="chan__misdn_8c-source.html#l00555">misdn_tasks_thread_func()</a>, <a class="el" href="pbx__dundi_8c-source.html#l02102">network_thread()</a>, <a class="el" href="chan__mgcp_8c-source.html#l04109">reload_config()</a>, <a class="el" href="chan__iax2_8c-source.html#l08357">sched_thread()</a>, <a class="el" href="app__speech__utils_8c-source.html#l00543">speech_background()</a>, <a class="el" href="app__followme_8c-source.html#l00470">wait_for_winner()</a>, and <a class="el" href="file_8c-source.html#l00983">waitstream_core()</a>.<div class="fragment"><pre class="fragment"><a name="l00330"></a>00330 {
<a name="l00331"></a>00331    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *current;
<a name="l00332"></a>00332    <span class="keyword">struct </span>timeval tv;
<a name="l00333"></a>00333    <span class="keywordtype">int</span> numevents;
<a name="l00334"></a>00334    <span class="keywordtype">int</span> res;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_sched_runq()\n"</span>));
<a name="l00337"></a>00337       
<a name="l00338"></a>00338    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    <span class="keywordflow">for</span> (numevents = 0; !<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;con-&gt;schedq); numevents++) {
<a name="l00341"></a>00341       <span class="comment">/* schedule all events which are going to expire within 1ms.</span>
<a name="l00342"></a>00342 <span class="comment">       * We only care about millisecond accuracy anyway, so this will</span>
<a name="l00343"></a>00343 <span class="comment">       * help us get more than one event at one time if they are very</span>
<a name="l00344"></a>00344 <span class="comment">       * close together.</span>
<a name="l00345"></a>00345 <span class="comment">       */</span>
<a name="l00346"></a>00346       tv = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(ast_tvnow(), ast_tv(0, 1000));
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (ast_tvcmp(<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;con-&gt;schedq)-&gt;when, tv) != -1)
<a name="l00348"></a>00348          <span class="keywordflow">break</span>;
<a name="l00349"></a>00349       
<a name="l00350"></a>00350       current = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;con-&gt;schedq, list);
<a name="l00351"></a>00351       con-&gt;<a class="code" href="structsched__context.html#4c5a5e5eafcd99b2080d5a7a4bcb5ab9">schedcnt</a>--;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353       <span class="comment">/*</span>
<a name="l00354"></a>00354 <span class="comment">       * At this point, the schedule queue is still intact.  We</span>
<a name="l00355"></a>00355 <span class="comment">       * have removed the first event and the rest is still there,</span>
<a name="l00356"></a>00356 <span class="comment">       * so it's permissible for the callback to add new events, but</span>
<a name="l00357"></a>00357 <span class="comment">       * trying to delete itself won't work because it isn't in</span>
<a name="l00358"></a>00358 <span class="comment">       * the schedule queue.  If that's what it wants to do, it </span>
<a name="l00359"></a>00359 <span class="comment">       * should return 0.</span>
<a name="l00360"></a>00360 <span class="comment">       */</span>
<a name="l00361"></a>00361          
<a name="l00362"></a>00362       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00363"></a>00363       res = current-&gt;callback(current-&gt;data);
<a name="l00364"></a>00364       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00365"></a>00365          
<a name="l00366"></a>00366       <span class="keywordflow">if</span> (res) {
<a name="l00367"></a>00367          <span class="comment">/*</span>
<a name="l00368"></a>00368 <span class="comment">          * If they return non-zero, we should schedule them to be</span>
<a name="l00369"></a>00369 <span class="comment">          * run again.</span>
<a name="l00370"></a>00370 <span class="comment">          */</span>
<a name="l00371"></a>00371          <span class="keywordflow">if</span> (<a class="code" href="sched_8c.html#09803f24cad88f67130506d3e58a2769">sched_settime</a>(&amp;current-&gt;when, current-&gt;variable? res : current-&gt;resched)) {
<a name="l00372"></a>00372             <a class="code" href="sched_8c.html#cf5848e6d5d1c9f12ef21fb0f324f43a">sched_release</a>(con, current);
<a name="l00373"></a>00373          } <span class="keywordflow">else</span>
<a name="l00374"></a>00374             <a class="code" href="sched_8c.html#d516af5ac8853428f66cc60a632cbba2">schedule</a>(con, current);
<a name="l00375"></a>00375       } <span class="keywordflow">else</span> {
<a name="l00376"></a>00376          <span class="comment">/* No longer needed, so release it */</span>
<a name="l00377"></a>00377          <a class="code" href="sched_8c.html#cf5848e6d5d1c9f12ef21fb0f324f43a">sched_release</a>(con, current);
<a name="l00378"></a>00378       }
<a name="l00379"></a>00379    }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00382"></a>00382    
<a name="l00383"></a>00383    <span class="keywordflow">return</span> numevents;
<a name="l00384"></a>00384 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="be772a122828e81602f21038162f6dff"></a><!-- doxytag: member="sched.c::ast_sched_wait" ref="be772a122828e81602f21038162f6dff" args="(struct sched_context *con)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_sched_wait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>con</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Determines number of seconds until the next outstanding event to take place Determine the number of seconds until the next outstanding event should take place, and return the number of milliseconds until it needs to be run. This value is perfect for passing to the poll call. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>context to act upon </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns "-1" if there is nothing there are no scheduled events (and thus the poll should not timeout) </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00148">148</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00413">AST_LIST_EMPTY</a>, <a class="el" href="linkedlists_8h-source.html#l00385">AST_LIST_FIRST</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, and <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>.
<p>
Referenced by <a class="el" href="app__talkdetect_8c-source.html#l00063">background_detect_exec()</a>, <a class="el" href="cdr_8c-source.html#l01143">do_cdr()</a>, <a class="el" href="chan__sip_8c-source.html#l16035">do_monitor()</a>, <a class="el" href="dnsmgr_8c-source.html#l00211">do_refresh()</a>, <a class="el" href="chan__misdn_8c-source.html#l00555">misdn_tasks_thread_func()</a>, <a class="el" href="pbx__dundi_8c-source.html#l02102">network_thread()</a>, <a class="el" href="chan__iax2_8c-source.html#l08357">sched_thread()</a>, <a class="el" href="app__speech__utils_8c-source.html#l00543">speech_background()</a>, <a class="el" href="app__followme_8c-source.html#l00470">wait_for_winner()</a>, and <a class="el" href="file_8c-source.html#l00983">waitstream_core()</a>.<div class="fragment"><pre class="fragment"><a name="l00149"></a>00149 {
<a name="l00150"></a>00150    <span class="keywordtype">int</span> ms;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_sched_wait()\n"</span>));
<a name="l00153"></a>00153 
<a name="l00154"></a>00154    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00155"></a>00155    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;con-&gt;schedq)) {
<a name="l00156"></a>00156       ms = -1;
<a name="l00157"></a>00157    } <span class="keywordflow">else</span> {
<a name="l00158"></a>00158       ms = ast_tvdiff_ms(<a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;con-&gt;schedq)-&gt;when, ast_tvnow());
<a name="l00159"></a>00159       <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l00160"></a>00160          ms = 0;
<a name="l00161"></a>00161    }
<a name="l00162"></a>00162    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164    <span class="keywordflow">return</span> ms;
<a name="l00165"></a>00165 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="c37432659ca9d317b5517fc2716a35a9"></a><!-- doxytag: member="sched.c::ast_sched_when" ref="c37432659ca9d317b5517fc2716a35a9" args="(struct sched_context *con, int id)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">long ast_sched_when           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>id</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Returns the number of seconds before an event takes place. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>con</em>&nbsp;</td><td>Context to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>id</em>&nbsp;</td><td>Id to dump </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00386">386</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00453">AST_LIST_TRAVERSE</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, and <a class="el" href="aesopt_8h-source.html#l00399">s</a>.
<p>
Referenced by <a class="el" href="chan__sip_8c-source.html#l10808">_sip_show_peer()</a>, <a class="el" href="cdr_8c-source.html#l01170">handle_cli_status()</a>, and <a class="el" href="chan__sip_8c-source.html#l08437">parse_register_contact()</a>.<div class="fragment"><pre class="fragment"><a name="l00387"></a>00387 {
<a name="l00388"></a>00388    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00389"></a>00389    <span class="keywordtype">long</span> secs = -1;
<a name="l00390"></a>00390    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_sched_when()\n"</span>));
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00393"></a>00393    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;con-&gt;schedq, s, list) {
<a name="l00394"></a>00394       <span class="keywordflow">if</span> (s-&gt;id == <span class="keywordtype">id</span>)
<a name="l00395"></a>00395          <span class="keywordflow">break</span>;
<a name="l00396"></a>00396    }
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (s) {
<a name="l00398"></a>00398       <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l00399"></a>00399       secs = s-&gt;when.tv_sec - now.tv_sec;
<a name="l00400"></a>00400    }
<a name="l00401"></a>00401    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00402"></a>00402    
<a name="l00403"></a>00403    <span class="keywordflow">return</span> secs;
<a name="l00404"></a>00404 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="cc2bbfa690db7aa3dd7e3b13a3392147"></a><!-- doxytag: member="sched.c::sched_alloc" ref="cc2bbfa690db7aa3dd7e3b13a3392147" args="(struct sched_context *con)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static struct <a class="el" href="structsched.html">sched</a>* sched_alloc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>con</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00110">110</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, and <a class="el" href="linkedlists_8h-source.html#l00710">AST_LIST_REMOVE_HEAD</a>.
<p>
Referenced by <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>.<div class="fragment"><pre class="fragment"><a name="l00111"></a>00111 {
<a name="l00112"></a>00112    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *tmp;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114    <span class="comment">/*</span>
<a name="l00115"></a>00115 <span class="comment">    * We keep a small cache of schedule entries</span>
<a name="l00116"></a>00116 <span class="comment">    * to minimize the number of necessary malloc()'s</span>
<a name="l00117"></a>00117 <span class="comment">    */</span>
<a name="l00118"></a>00118 <span class="preprocessor">#ifdef SCHED_MAX_CACHE</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((tmp = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;con-&gt;schedc, list)))
<a name="l00120"></a>00120       con-&gt;schedccnt--;
<a name="l00121"></a>00121    <span class="keywordflow">else</span>
<a name="l00122"></a>00122 <span class="preprocessor">#endif</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>      tmp = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp));
<a name="l00124"></a>00124 
<a name="l00125"></a>00125    <span class="keywordflow">return</span> tmp;
<a name="l00126"></a>00126 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="4326fa64fd840788d03093b9931bb1fb"></a><!-- doxytag: member="sched.c::sched_context_create" ref="4326fa64fd840788d03093b9931bb1fb" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a>* sched_context_create           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
New schedule context. 
<p>
<dl compact><dt><b>Note:</b></dt><dd>Create a scheduling context </dd></dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns a malloc'd <a class="el" href="structsched__context.html">sched_context</a> structure, NULL on failure </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00075">75</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, and <a class="el" href="lock_8h-source.html#l00508">ast_mutex_init()</a>.
<p>
Referenced by <a class="el" href="cdr_8c-source.html#l01341">ast_cdr_engine_init()</a>, <a class="el" href="channel_8c-source.html#l00632">ast_channel_alloc()</a>, <a class="el" href="dnsmgr_8c-source.html#l00336">dnsmgr_init()</a>, <a class="el" href="chan__gtalk_8c-source.html#l01823">load_module()</a>, and <a class="el" href="chan__misdn_8c-source.html#l00579">misdn_tasks_init()</a>.<div class="fragment"><pre class="fragment"><a name="l00076"></a>00076 {
<a name="l00077"></a>00077    <span class="keyword">struct </span><a class="code" href="structsched__context.html">sched_context</a> *tmp;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp))))
<a name="l00080"></a>00080       <span class="keywordflow">return</span> NULL;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082    <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;tmp-&gt;lock);
<a name="l00083"></a>00083    tmp-&gt;eventcnt = 1;
<a name="l00084"></a>00084    
<a name="l00085"></a>00085    <span class="keywordflow">return</span> tmp;
<a name="l00086"></a>00086 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="89e2eb9653fa462ad4ff62e05ad36050"></a><!-- doxytag: member="sched.c::sched_context_destroy" ref="89e2eb9653fa462ad4ff62e05ad36050" args="(struct sched_context *con)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void sched_context_destroy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>c</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
destroys a schedule context Destroys (free's) the given <a class="el" href="structsched__context.html">sched_context</a> structure 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>c</em>&nbsp;</td><td>Context to free </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns 0 on success, -1 on failure </dd></dl>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00088">88</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00710">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="lock_8h-source.html#l00525">ast_mutex_destroy()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="sched_8c-source.html#l00064">sched_context::lock</a>, and <a class="el" href="aesopt_8h-source.html#l00399">s</a>.
<p>
Referenced by <a class="el" href="chan__iax2_8c-source.html#l10340">__unload_module()</a>, <a class="el" href="channel_8c-source.html#l01069">ast_channel_free()</a>, <a class="el" href="channel_8c-source.html#l01598">ast_hangup()</a>, <a class="el" href="chan__h323_8c-source.html#l03189">load_module()</a>, <a class="el" href="chan__misdn_8c-source.html#l00598">misdn_tasks_destroy()</a>, and <a class="el" href="chan__mgcp_8c-source.html#l04344">unload_module()</a>.<div class="fragment"><pre class="fragment"><a name="l00089"></a>00089 {
<a name="l00090"></a>00090    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#ifdef SCHED_MAX_CACHE</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>   <span class="comment">/* Eliminate the cache */</span>
<a name="l00096"></a>00096    <span class="keywordflow">while</span> ((s = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;con-&gt;schedc, list)))
<a name="l00097"></a>00097       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(s);
<a name="l00098"></a>00098 <span class="preprocessor">#endif</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a>00100    <span class="comment">/* And the queue */</span>
<a name="l00101"></a>00101    <span class="keywordflow">while</span> ((s = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;con-&gt;schedq, list)))
<a name="l00102"></a>00102       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(s);
<a name="l00103"></a>00103    
<a name="l00104"></a>00104    <span class="comment">/* And the context */</span>
<a name="l00105"></a>00105    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00106"></a>00106    <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;con-&gt;<a class="code" href="structsched__context.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00107"></a>00107    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(con);
<a name="l00108"></a>00108 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="cf5848e6d5d1c9f12ef21fb0f324f43a"></a><!-- doxytag: member="sched.c::sched_release" ref="cf5848e6d5d1c9f12ef21fb0f324f43a" args="(struct sched_context *con, struct sched *tmp)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void sched_release           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>struct <a class="el" href="structsched.html">sched</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>tmp</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00128">128</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00650">AST_LIST_INSERT_HEAD</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, and <a class="el" href="sched_8h-source.html#l00036">SCHED_MAX_CACHE</a>.
<p>
Referenced by <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>, <a class="el" href="sched_8c-source.html#l00259">ast_sched_del()</a>, and <a class="el" href="sched_8c-source.html#l00329">ast_sched_runq()</a>.<div class="fragment"><pre class="fragment"><a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="comment">/*</span>
<a name="l00131"></a>00131 <span class="comment">    * Add to the cache, or just free() if we</span>
<a name="l00132"></a>00132 <span class="comment">    * already have too many cache entries</span>
<a name="l00133"></a>00133 <span class="comment">    */</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#ifdef SCHED_MAX_CACHE   </span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (con-&gt;schedccnt &lt; <a class="code" href="sched_8h.html#7e6e2bc52a7c9d6dad0ca12072db5cee">SCHED_MAX_CACHE</a>) {
<a name="l00137"></a>00137       <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;con-&gt;schedc, tmp, list);
<a name="l00138"></a>00138       con-&gt;schedccnt++;
<a name="l00139"></a>00139    } <span class="keywordflow">else</span>
<a name="l00140"></a>00140 <span class="preprocessor">#endif</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>      <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00142"></a>00142 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="09803f24cad88f67130506d3e58a2769"></a><!-- doxytag: member="sched.c::sched_settime" ref="09803f24cad88f67130506d3e58a2769" args="(struct timeval *tv, int when)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int sched_settime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct timeval *&nbsp;</td>
          <td class="mdname" nowrap> <em>tv</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>when</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
given the last event *tv and the offset in milliseconds 'when', computes the next value, 
<p>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00195">195</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8c-source.html#l00778">ast_tvadd()</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, and <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>.
<p>
Referenced by <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>, and <a class="el" href="sched_8c-source.html#l00329">ast_sched_runq()</a>.<div class="fragment"><pre class="fragment"><a name="l00196"></a>00196 {
<a name="l00197"></a>00197    <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l00198"></a>00198 
<a name="l00199"></a>00199    <span class="comment">/*ast_log(LOG_DEBUG, "TV -&gt; %lu,%lu\n", tv-&gt;tv_sec, tv-&gt;tv_usec);*/</span>
<a name="l00200"></a>00200    <span class="keywordflow">if</span> (ast_tvzero(*tv)) <span class="comment">/* not supplied, default to now */</span>
<a name="l00201"></a>00201       *<a class="code" href="time_8h.html#c9a1fdac6e082dd89e7173244f34d7b3">tv</a> = now;
<a name="l00202"></a>00202    *<a class="code" href="time_8h.html#c9a1fdac6e082dd89e7173244f34d7b3">tv</a> = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(*tv, ast_samp2tv(when, 1000));
<a name="l00203"></a>00203    <span class="keywordflow">if</span> (ast_tvcmp(*tv, now) &lt; 0) {
<a name="l00204"></a>00204       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00205"></a>00205          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Request to schedule in the past?!?!\n"</span>);
<a name="l00206"></a>00206       *<a class="code" href="time_8h.html#c9a1fdac6e082dd89e7173244f34d7b3">tv</a> = now;
<a name="l00207"></a>00207    }
<a name="l00208"></a>00208    <span class="keywordflow">return</span> 0;
<a name="l00209"></a>00209 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d516af5ac8853428f66cc60a632cbba2"></a><!-- doxytag: member="sched.c::schedule" ref="d516af5ac8853428f66cc60a632cbba2" args="(struct sched_context *con, struct sched *s)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void schedule           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structsched__context.html">sched_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>con</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>struct <a class="el" href="structsched.html">sched</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>s</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Take a sched structure and put it in the queue, such that the soonest event is first in the list. 
<p>

<p>
Definition at line <a class="el" href="sched_8c-source.html#l00173">173</a> of file <a class="el" href="sched_8c-source.html">sched.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00538">AST_LIST_INSERT_BEFORE_CURRENT</a>, <a class="el" href="linkedlists_8h-source.html#l00670">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h-source.html#l00491">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h-source.html#l00554">AST_LIST_TRAVERSE_SAFE_END</a>, and <a class="el" href="sched_8c-source.html#l00066">sched_context::schedcnt</a>.
<p>
Referenced by <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>, and <a class="el" href="sched_8c-source.html#l00329">ast_sched_runq()</a>.<div class="fragment"><pre class="fragment"><a name="l00174"></a>00174 {
<a name="l00175"></a>00175     
<a name="l00176"></a>00176    <span class="keyword">struct </span><a class="code" href="structsched.html">sched</a> *cur = NULL;
<a name="l00177"></a>00177    
<a name="l00178"></a>00178    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;con-&gt;schedq, cur, list) {
<a name="l00179"></a>00179       <span class="keywordflow">if</span> (ast_tvcmp(s-&gt;when, cur-&gt;when) == -1) {
<a name="l00180"></a>00180          <a class="code" href="linkedlists_8h.html#16868896f20911fb4e6c9c87da34a825">AST_LIST_INSERT_BEFORE_CURRENT</a>(&amp;con-&gt;schedq, s, list);
<a name="l00181"></a>00181          <span class="keywordflow">break</span>;
<a name="l00182"></a>00182       }
<a name="l00183"></a>00183    }
<a name="l00184"></a>00184    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l00185"></a>00185    <span class="keywordflow">if</span> (!cur)
<a name="l00186"></a>00186       <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;con-&gt;schedq, s, list);
<a name="l00187"></a>00187    
<a name="l00188"></a>00188    con-&gt;<a class="code" href="structsched__context.html#4c5a5e5eafcd99b2080d5a7a4bcb5ab9">schedcnt</a>++;
<a name="l00189"></a>00189 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:47 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
