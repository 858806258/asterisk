<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:43 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>indications.c</h1><a href="indications_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2002, Pauline Middelink</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00008"></a>00008 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00009"></a>00009 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00010"></a>00010 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00011"></a>00011 <span class="comment"> * channels for your use.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00014"></a>00014 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00015"></a>00015 <span class="comment"> * at the top of the source tree.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">/*! \file</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * \brief Tone Management</span>
<a name="l00021"></a>00021 <span class="comment"> * </span>
<a name="l00022"></a>00022 <span class="comment"> * \author Pauline Middelink &lt;middelink@polyware.nl&gt;</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * This set of function allow us to play a list of tones on a channel.</span>
<a name="l00025"></a>00025 <span class="comment"> * Each element has two frequencies, which are mixed together and a</span>
<a name="l00026"></a>00026 <span class="comment"> * duration. For silence both frequencies can be set to 0.</span>
<a name="l00027"></a>00027 <span class="comment"> * The playtones can be given as a comma separated string.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 #include &lt;stdio.h&gt;
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="indications_8h.html">asterisk/indications.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="frame_8h.html">asterisk/frame.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="indications_8c.html#70a3466b23fa7767aed30e1c462b3c47">00049</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#70a3466b23fa7767aed30e1c462b3c47">midi_tohz</a>[128] = {
<a name="l00050"></a>00050          8,8,9,9,10,10,11,12,12,13,14,
<a name="l00051"></a>00051          15,16,17,18,19,20,21,23,24,25,
<a name="l00052"></a>00052          27,29,30,32,34,36,38,41,43,46,
<a name="l00053"></a>00053          48,51,55,58,61,65,69,73,77,82,
<a name="l00054"></a>00054          87,92,97,103,110,116,123,130,138,146,
<a name="l00055"></a>00055          155,164,174,184,195,207,220,233,246,261,
<a name="l00056"></a>00056          277,293,311,329,349,369,391,415,440,466,
<a name="l00057"></a>00057          493,523,554,587,622,659,698,739,783,830,
<a name="l00058"></a>00058          880,932,987,1046,1108,1174,1244,1318,1396,1479,
<a name="l00059"></a>00059          1567,1661,1760,1864,1975,2093,2217,2349,2489,2637,
<a name="l00060"></a>00060          2793,2959,3135,3322,3520,3729,3951,4186,4434,4698,
<a name="l00061"></a>00061          4978,5274,5587,5919,6271,6644,7040,7458,7902,8372,
<a name="l00062"></a>00062          8869,9397,9956,10548,11175,11839,12543
<a name="l00063"></a>00063          };
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="structplaytones__item.html">00065</a> <span class="keyword">struct </span><a class="code" href="structplaytones__item.html">playtones_item</a> {
<a name="l00066"></a><a class="code" href="structplaytones__item.html#7874a31cb70449f5854eb3d86cb15dde">00066</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#7874a31cb70449f5854eb3d86cb15dde">fac1</a>;
<a name="l00067"></a><a class="code" href="structplaytones__item.html#1501a28b4e1c526e509b8e489a220d9a">00067</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#1501a28b4e1c526e509b8e489a220d9a">init_v2_1</a>;
<a name="l00068"></a><a class="code" href="structplaytones__item.html#4493b108e1cbf87755e3b2f8e30e3ada">00068</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#4493b108e1cbf87755e3b2f8e30e3ada">init_v3_1</a>;
<a name="l00069"></a><a class="code" href="structplaytones__item.html#151fb3908501dd115d22330471c438cb">00069</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#151fb3908501dd115d22330471c438cb">fac2</a>;
<a name="l00070"></a><a class="code" href="structplaytones__item.html#db5db9c5214bdbf14de36f8a017a302e">00070</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#db5db9c5214bdbf14de36f8a017a302e">init_v2_2</a>;
<a name="l00071"></a><a class="code" href="structplaytones__item.html#13822a5ada30b49216d9ac18d4d77dd0">00071</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#13822a5ada30b49216d9ac18d4d77dd0">init_v3_2</a>;
<a name="l00072"></a><a class="code" href="structplaytones__item.html#15e95cb1264e3dfced379f625e5773d3">00072</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#15e95cb1264e3dfced379f625e5773d3">modulate</a>;
<a name="l00073"></a><a class="code" href="structplaytones__item.html#b85ec314bf443b797ef8a66b3b03f8a4">00073</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__item.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a>;
<a name="l00074"></a>00074 };
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="structplaytones__def.html">00076</a> <span class="keyword">struct </span><a class="code" href="structplaytones__def.html">playtones_def</a> {
<a name="l00077"></a><a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">00077</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00078"></a><a class="code" href="structplaytones__def.html#79bf99457c052bb1c6b365376dfea346">00078</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__def.html#79bf99457c052bb1c6b365376dfea346">reppos</a>;
<a name="l00079"></a><a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">00079</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>;
<a name="l00080"></a><a class="code" href="structplaytones__def.html#22cc2ff8c9e908cd566945321bd8ec59">00080</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__def.html#22cc2ff8c9e908cd566945321bd8ec59">interruptible</a>;
<a name="l00081"></a><a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">00081</a>    <span class="keyword">struct </span><a class="code" href="structplaytones__item.html">playtones_item</a> *<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>;
<a name="l00082"></a>00082 };
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="structplaytones__state.html">00084</a> <span class="keyword">struct </span><a class="code" href="structplaytones__state.html">playtones_state</a> {
<a name="l00085"></a><a class="code" href="structplaytones__state.html#0acf8be1231e24946c3d10b649fb576f">00085</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00086"></a><a class="code" href="structplaytones__state.html#4f397565e46919bce9d36b3c6a9cafc0">00086</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a>;
<a name="l00087"></a><a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">00087</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a>;
<a name="l00088"></a><a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">00088</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a>;
<a name="l00089"></a><a class="code" href="structplaytones__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">00089</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a>;
<a name="l00090"></a><a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">00090</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">v2_2</a>;
<a name="l00091"></a><a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">00091</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a>;
<a name="l00092"></a><a class="code" href="structplaytones__state.html#79bf99457c052bb1c6b365376dfea346">00092</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#79bf99457c052bb1c6b365376dfea346">reppos</a>;
<a name="l00093"></a><a class="code" href="structplaytones__state.html#0067ce9bdb8c263ff8f1020e82fe54e7">00093</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>;
<a name="l00094"></a><a class="code" href="structplaytones__state.html#691d502cfd0e0626cd3b058e5682ad1c">00094</a>    <span class="keyword">struct </span><a class="code" href="structplaytones__item.html">playtones_item</a> *<a class="code" href="structplaytones__state.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>;
<a name="l00095"></a><a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">00095</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a>;
<a name="l00096"></a><a class="code" href="structplaytones__state.html#c8e20bdc58274cd3637b2fad8727bd7e">00096</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#c8e20bdc58274cd3637b2fad8727bd7e">oldnpos</a>;
<a name="l00097"></a><a class="code" href="structplaytones__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">00097</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a>;
<a name="l00098"></a><a class="code" href="structplaytones__state.html#b3001a6ee2c48154e670d0b11806bfac">00098</a>    <span class="keywordtype">int</span> <a class="code" href="structplaytones__state.html#b3001a6ee2c48154e670d0b11806bfac">origwfmt</a>;
<a name="l00099"></a><a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">00099</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f;
<a name="l00100"></a><a class="code" href="structplaytones__state.html#2415fcbd6a0c6ae3edd8e4012db4dd40">00100</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structplaytones__state.html#2415fcbd6a0c6ae3edd8e4012db4dd40">offset</a>[<a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>];
<a name="l00101"></a><a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">00101</a>    <span class="keywordtype">short</span> <a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>[4000];
<a name="l00102"></a>00102 };
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="indications_8c.html#bc3df387bbb0caeb738af7b5d5e61c10">00104</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="indications_8c.html#bc3df387bbb0caeb738af7b5d5e61c10">playtones_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *params)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106    <span class="keyword">struct </span><a class="code" href="structplaytones__state.html">playtones_state</a> *ps = params;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="keywordflow">if</span> (chan)
<a name="l00109"></a>00109       <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, ps-&gt;<a class="code" href="structplaytones__state.html#b3001a6ee2c48154e670d0b11806bfac">origwfmt</a>);
<a name="l00110"></a>00110    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="structplaytones__state.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>)
<a name="l00111"></a>00111       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ps-&gt;<a class="code" href="structplaytones__state.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ps);
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="indications_8c.html#dacc0dd30ebb0bdf5746e31a5abff3f9">00116</a> <span class="keyword">static</span> <span class="keywordtype">void</span> * <a class="code" href="indications_8c.html#dacc0dd30ebb0bdf5746e31a5abff3f9">playtones_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *params)
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118    <span class="keyword">struct </span><a class="code" href="structplaytones__def.html">playtones_def</a> *pd = params;
<a name="l00119"></a>00119    <span class="keyword">struct </span><a class="code" href="structplaytones__state.html">playtones_state</a> *ps = NULL;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121    <span class="keywordflow">if</span> (!(ps = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ps))))
<a name="l00122"></a>00122       <span class="keywordflow">return</span> NULL;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124    ps-&gt;origwfmt = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l00127"></a>00127       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set '%s' to signed linear format (write)\n"</span>, chan-&gt;name);
<a name="l00128"></a>00128       <a class="code" href="indications_8c.html#bc3df387bbb0caeb738af7b5d5e61c10">playtones_release</a>(NULL, ps);
<a name="l00129"></a>00129       ps = NULL;
<a name="l00130"></a>00130    } <span class="keywordflow">else</span> {
<a name="l00131"></a>00131       ps-&gt;vol = pd-&gt;<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00132"></a>00132       ps-&gt;reppos = pd-&gt;<a class="code" href="structplaytones__def.html#79bf99457c052bb1c6b365376dfea346">reppos</a>;
<a name="l00133"></a>00133       ps-&gt;nitems = pd-&gt;<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>;
<a name="l00134"></a>00134       ps-&gt;items = pd-&gt;<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>;
<a name="l00135"></a>00135       ps-&gt;oldnpos = -1;
<a name="l00136"></a>00136    }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="comment">/* Let interrupts interrupt :) */</span>
<a name="l00139"></a>00139    <span class="keywordflow">if</span> (pd-&gt;<a class="code" href="structplaytones__def.html#22cc2ff8c9e908cd566945321bd8ec59">interruptible</a>)
<a name="l00140"></a>00140       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730015fb5a488ff560040b677433b270fb5e">AST_FLAG_WRITE_INT</a>);
<a name="l00141"></a>00141    <span class="keywordflow">else</span>
<a name="l00142"></a>00142       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a730015fb5a488ff560040b677433b270fb5e">AST_FLAG_WRITE_INT</a>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    <span class="keywordflow">return</span> ps;
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="indications_8c.html#e66d747e8945376a31ab39d35072e9f4">00147</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#e66d747e8945376a31ab39d35072e9f4">playtones_generator</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *<a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>, <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, <span class="keywordtype">int</span> samples)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149    <span class="keyword">struct </span><a class="code" href="structplaytones__state.html">playtones_state</a> *ps = data;
<a name="l00150"></a>00150    <span class="keyword">struct </span><a class="code" href="structplaytones__item.html">playtones_item</a> *pi;
<a name="l00151"></a>00151    <span class="keywordtype">int</span> x;
<a name="l00152"></a>00152    <span class="comment">/* we need to prepare a frame with 16 * timelen samples as we're </span>
<a name="l00153"></a>00153 <span class="comment">    * generating SLIN audio</span>
<a name="l00154"></a>00154 <span class="comment">    */</span>
<a name="l00155"></a>00155    len = samples * 2;
<a name="l00156"></a>00156    <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(ps-&gt;<a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>) / 2 - 1) {
<a name="l00157"></a>00157       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't generate that much data!\n"</span>);
<a name="l00158"></a>00158       <span class="keywordflow">return</span> -1;
<a name="l00159"></a>00159    }
<a name="l00160"></a>00160    memset(&amp;ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>, 0, <span class="keyword">sizeof</span>(ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>));
<a name="l00161"></a>00161 
<a name="l00162"></a>00162    pi = &amp;ps-&gt;<a class="code" href="structplaytones__state.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a>];
<a name="l00163"></a>00163    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="structplaytones__state.html#c8e20bdc58274cd3637b2fad8727bd7e">oldnpos</a> != ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a>) {
<a name="l00164"></a>00164       <span class="comment">/* Load new parameters */</span>
<a name="l00165"></a>00165       ps-&gt;<a class="code" href="structplaytones__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a> = 0;
<a name="l00166"></a>00166       ps-&gt;<a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a> = pi-&gt;<a class="code" href="structplaytones__item.html#1501a28b4e1c526e509b8e489a220d9a">init_v2_1</a>;
<a name="l00167"></a>00167       ps-&gt;<a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> = pi-&gt;<a class="code" href="structplaytones__item.html#4493b108e1cbf87755e3b2f8e30e3ada">init_v3_1</a>;
<a name="l00168"></a>00168       ps-&gt;<a class="code" href="structplaytones__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a> = 0;
<a name="l00169"></a>00169       ps-&gt;<a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">v2_2</a> = pi-&gt;<a class="code" href="structplaytones__item.html#db5db9c5214bdbf14de36f8a017a302e">init_v2_2</a>;
<a name="l00170"></a>00170       ps-&gt;<a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a> = pi-&gt;<a class="code" href="structplaytones__item.html#13822a5ada30b49216d9ac18d4d77dd0">init_v3_2</a>;
<a name="l00171"></a>00171       ps-&gt;<a class="code" href="structplaytones__state.html#c8e20bdc58274cd3637b2fad8727bd7e">oldnpos</a> = ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a>;
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173    <span class="keywordflow">for</span> (x=0;x&lt;len/2;x++) {
<a name="l00174"></a>00174       ps-&gt;<a class="code" href="structplaytones__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a> = ps-&gt;<a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a>;
<a name="l00175"></a>00175       ps-&gt;<a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a> = ps-&gt;<a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a>;
<a name="l00176"></a>00176       ps-&gt;<a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> = (pi-&gt;<a class="code" href="structplaytones__item.html#7874a31cb70449f5854eb3d86cb15dde">fac1</a> * ps-&gt;<a class="code" href="structplaytones__state.html#c2222e1f89d77cabb87e1622253f8ab0">v2_1</a> &gt;&gt; 15) - ps-&gt;<a class="code" href="structplaytones__state.html#4f397565e46919bce9d36b3c6a9cafc0">v1_1</a>;
<a name="l00177"></a>00177       
<a name="l00178"></a>00178       ps-&gt;<a class="code" href="structplaytones__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a> = ps-&gt;<a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">v2_2</a>;
<a name="l00179"></a>00179       ps-&gt;<a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">v2_2</a> = ps-&gt;<a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a>;
<a name="l00180"></a>00180       ps-&gt;<a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a> = (pi-&gt;<a class="code" href="structplaytones__item.html#151fb3908501dd115d22330471c438cb">fac2</a> * ps-&gt;<a class="code" href="structplaytones__state.html#44c182d153f336e0e823a8293472af14">v2_2</a> &gt;&gt; 15) - ps-&gt;<a class="code" href="structplaytones__state.html#0fdcfe7bc01aadbcbb7ff8c0e1024336">v1_2</a>;
<a name="l00181"></a>00181       <span class="keywordflow">if</span> (pi-&gt;<a class="code" href="structplaytones__item.html#15e95cb1264e3dfced379f625e5773d3">modulate</a>) {
<a name="l00182"></a>00182          <span class="keywordtype">int</span> p;
<a name="l00183"></a>00183          p = ps-&gt;<a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a> - 32768;
<a name="l00184"></a>00184          <span class="keywordflow">if</span> (p &lt; 0) p = -p;
<a name="l00185"></a>00185          p = ((p * 9) / 10) + 1;
<a name="l00186"></a>00186          ps-&gt;<a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>[x] = (ps-&gt;<a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> * p) &gt;&gt; 15;
<a name="l00187"></a>00187       } <span class="keywordflow">else</span>
<a name="l00188"></a>00188          ps-&gt;<a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>[x] = ps-&gt;<a class="code" href="structplaytones__state.html#3fce96fee06d49ae6172f00121123837">v3_1</a> + ps-&gt;<a class="code" href="structplaytones__state.html#31905888f7d6f7dfd2b88beb2763646e">v3_2</a>; 
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    
<a name="l00191"></a>00191    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>;
<a name="l00192"></a>00192    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>;
<a name="l00193"></a>00193    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = len;
<a name="l00194"></a>00194    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> = samples;
<a name="l00195"></a>00195    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00196"></a>00196    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = ps-&gt;<a class="code" href="structplaytones__state.html#2f4b8456c4e369259547c6c0728dbad8">data</a>;
<a name="l00197"></a>00197    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>.tv_sec = 0;
<a name="l00198"></a>00198    ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>.tv_usec = 0;
<a name="l00199"></a>00199    <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(chan, &amp;ps-&gt;<a class="code" href="structplaytones__state.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201    ps-&gt;<a class="code" href="structplaytones__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a> += x;
<a name="l00202"></a>00202    <span class="keywordflow">if</span> (pi-&gt;<a class="code" href="structplaytones__item.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> &amp;&amp; ps-&gt;<a class="code" href="structplaytones__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a> &gt;= pi-&gt;<a class="code" href="structplaytones__item.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> * 8) { <span class="comment">/* item finished? */</span>
<a name="l00203"></a>00203       ps-&gt;<a class="code" href="structplaytones__state.html#5e0bdcbddccca4d66d74ba8c1cee1a68">pos</a> = 0;               <span class="comment">/* start new item */</span>
<a name="l00204"></a>00204       ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a>++;
<a name="l00205"></a>00205       <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a> &gt;= ps-&gt;<a class="code" href="structplaytones__state.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>) {       <span class="comment">/* last item? */</span>
<a name="l00206"></a>00206          <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="structplaytones__state.html#79bf99457c052bb1c6b365376dfea346">reppos</a> == -1)         <span class="comment">/* repeat set? */</span>
<a name="l00207"></a>00207             <span class="keywordflow">return</span> -1;
<a name="l00208"></a>00208          ps-&gt;<a class="code" href="structplaytones__state.html#cef7888fec54e4c910e34020ad9eb615">npos</a> = ps-&gt;<a class="code" href="structplaytones__state.html#79bf99457c052bb1c6b365376dfea346">reppos</a>;        <span class="comment">/* redo from top */</span>
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210    }
<a name="l00211"></a>00211    <span class="keywordflow">return</span> 0;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="indications_8c.html#257c81489b87d5332af03914ba6d4fcb">00214</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> playtones = {
<a name="l00215"></a>00215    <a class="code" href="structast__generator.html#ec716dadc257b3894e8a1a75177d4283">alloc</a>: <a class="code" href="indications_8c.html#dacc0dd30ebb0bdf5746e31a5abff3f9">playtones_alloc</a>,
<a name="l00216"></a>00216    <a class="code" href="structast__generator.html#62e15df14a257d6ac9725e39389d5b5a">release</a>: <a class="code" href="indications_8c.html#bc3df387bbb0caeb738af7b5d5e61c10">playtones_release</a>,
<a name="l00217"></a>00217    <a class="code" href="structast__generator.html#359c44da76fd570826dcd60f0f6da36c">generate</a>: <a class="code" href="indications_8c.html#e66d747e8945376a31ab39d35072e9f4">playtones_generator</a>,
<a name="l00218"></a>00218 };
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="indications_8h.html#059d5738553c5b0718df2824811720cf">00220</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#aa5c984fda65782cd8ea1dd4101a15c3">ast_playtones_start</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> vol, <span class="keyword">const</span> <span class="keywordtype">char</span> *playlst, <span class="keywordtype">int</span> interruptible)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, *data = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(playlst); <span class="comment">/* cute */</span>
<a name="l00223"></a>00223    <span class="keyword">struct </span><a class="code" href="structplaytones__def.html">playtones_def</a> d = { vol, -1, 0, 1, NULL};
<a name="l00224"></a>00224    <span class="keywordtype">char</span> *stringp;
<a name="l00225"></a>00225    <span class="keywordtype">char</span> *separator;
<a name="l00226"></a>00226    
<a name="l00227"></a>00227    <span class="keywordflow">if</span> (vol &lt; 1)
<a name="l00228"></a>00228       d.<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a> = 7219; <span class="comment">/* Default to -8db */</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230    d.<a class="code" href="structplaytones__def.html#22cc2ff8c9e908cd566945321bd8ec59">interruptible</a> = interruptible;
<a name="l00231"></a>00231    
<a name="l00232"></a>00232    stringp=data;
<a name="l00233"></a>00233    <span class="comment">/* the stringp/data is not null here */</span>
<a name="l00234"></a>00234    <span class="comment">/* check if the data is separated with '|' or with ',' by default */</span>
<a name="l00235"></a>00235    <span class="keywordflow">if</span> (strchr(stringp,<span class="charliteral">'|'</span>))
<a name="l00236"></a>00236       separator = <span class="stringliteral">"|"</span>;
<a name="l00237"></a>00237    <span class="keywordflow">else</span>
<a name="l00238"></a>00238       separator = <span class="stringliteral">","</span>;
<a name="l00239"></a>00239    s = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp,separator);
<a name="l00240"></a>00240    <span class="keywordflow">while</span> (s &amp;&amp; *s) {
<a name="l00241"></a>00241       <span class="keywordtype">int</span> freq1, freq2, time, modulate=0, midinote=0;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243       <span class="keywordflow">if</span> (s[0]==<span class="charliteral">'!'</span>)
<a name="l00244"></a>00244          s++;
<a name="l00245"></a>00245       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d.<a class="code" href="structplaytones__def.html#79bf99457c052bb1c6b365376dfea346">reppos</a> == -1)
<a name="l00246"></a>00246          d.<a class="code" href="structplaytones__def.html#79bf99457c052bb1c6b365376dfea346">reppos</a> = d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>;
<a name="l00247"></a>00247       <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d+%d/%d"</span>, &amp;freq1, &amp;freq2, &amp;time) == 3) {
<a name="l00248"></a>00248          <span class="comment">/* f1+f2/time format */</span>
<a name="l00249"></a>00249       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d+%d"</span>, &amp;freq1, &amp;freq2) == 2) {
<a name="l00250"></a>00250          <span class="comment">/* f1+f2 format */</span>
<a name="l00251"></a>00251          time = 0;
<a name="l00252"></a>00252       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d*%d/%d"</span>, &amp;freq1, &amp;freq2, &amp;time) == 3) {
<a name="l00253"></a>00253          <span class="comment">/* f1*f2/time format */</span>
<a name="l00254"></a>00254          modulate = 1;
<a name="l00255"></a>00255       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d*%d"</span>, &amp;freq1, &amp;freq2) == 2) {
<a name="l00256"></a>00256          <span class="comment">/* f1*f2 format */</span>
<a name="l00257"></a>00257          time = 0;
<a name="l00258"></a>00258          modulate = 1;
<a name="l00259"></a>00259       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d/%d"</span>, &amp;freq1, &amp;time) == 2) {
<a name="l00260"></a>00260          <span class="comment">/* f1/time format */</span>
<a name="l00261"></a>00261          freq2 = 0;
<a name="l00262"></a>00262       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"%d"</span>, &amp;freq1) == 1) {
<a name="l00263"></a>00263          <span class="comment">/* f1 format */</span>
<a name="l00264"></a>00264          freq2 = 0;
<a name="l00265"></a>00265          time = 0;
<a name="l00266"></a>00266       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d+M%d/%d"</span>, &amp;freq1, &amp;freq2, &amp;time) == 3) {
<a name="l00267"></a>00267          <span class="comment">/* Mf1+Mf2/time format */</span>
<a name="l00268"></a>00268          midinote = 1;
<a name="l00269"></a>00269       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d+M%d"</span>, &amp;freq1, &amp;freq2) == 2) {
<a name="l00270"></a>00270          <span class="comment">/* Mf1+Mf2 format */</span>
<a name="l00271"></a>00271          time = 0;
<a name="l00272"></a>00272          midinote = 1;
<a name="l00273"></a>00273       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d*M%d/%d"</span>, &amp;freq1, &amp;freq2, &amp;time) == 3) {
<a name="l00274"></a>00274          <span class="comment">/* Mf1*Mf2/time format */</span>
<a name="l00275"></a>00275          modulate = 1;
<a name="l00276"></a>00276          midinote = 1;
<a name="l00277"></a>00277       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d*M%d"</span>, &amp;freq1, &amp;freq2) == 2) {
<a name="l00278"></a>00278          <span class="comment">/* Mf1*Mf2 format */</span>
<a name="l00279"></a>00279          time = 0;
<a name="l00280"></a>00280          modulate = 1;
<a name="l00281"></a>00281          midinote = 1;
<a name="l00282"></a>00282       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d/%d"</span>, &amp;freq1, &amp;time) == 2) {
<a name="l00283"></a>00283          <span class="comment">/* Mf1/time format */</span>
<a name="l00284"></a>00284          freq2 = -1;
<a name="l00285"></a>00285          midinote = 1;
<a name="l00286"></a>00286       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(s, <span class="stringliteral">"M%d"</span>, &amp;freq1) == 1) {
<a name="l00287"></a>00287          <span class="comment">/* Mf1 format */</span>
<a name="l00288"></a>00288          freq2 = -1;
<a name="l00289"></a>00289          time = 0;
<a name="l00290"></a>00290          midinote = 1;
<a name="l00291"></a>00291       } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,<span class="stringliteral">"%s: tone component '%s' of '%s' is no good\n"</span>,chan-&gt;name,s,playlst);
<a name="l00293"></a>00293          <span class="keywordflow">return</span> -1;
<a name="l00294"></a>00294       }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296       <span class="keywordflow">if</span> (midinote) {
<a name="l00297"></a>00297          <span class="comment">/* midi notes must be between 0 and 127 */</span>
<a name="l00298"></a>00298          <span class="keywordflow">if</span> ((freq1 &gt;= 0) &amp;&amp; (freq1 &lt;= 127))
<a name="l00299"></a>00299             freq1 = <a class="code" href="indications_8c.html#70a3466b23fa7767aed30e1c462b3c47">midi_tohz</a>[freq1];
<a name="l00300"></a>00300          <span class="keywordflow">else</span>
<a name="l00301"></a>00301             freq1 = 0;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303          <span class="keywordflow">if</span> ((freq2 &gt;= 0) &amp;&amp; (freq2 &lt;= 127))
<a name="l00304"></a>00304             freq2 = <a class="code" href="indications_8c.html#70a3466b23fa7767aed30e1c462b3c47">midi_tohz</a>[freq2];
<a name="l00305"></a>00305          <span class="keywordflow">else</span>
<a name="l00306"></a>00306             freq2 = 0;
<a name="l00307"></a>00307       }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309       <span class="keywordflow">if</span> (!(d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a> = <a class="code" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>(d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>, (d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a> + 1) * <span class="keyword">sizeof</span>(*d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>)))) {
<a name="l00310"></a>00310          <span class="keywordflow">return</span> -1;
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#7874a31cb70449f5854eb3d86cb15dde">fac1</a> = 2.0 * <a class="code" href="chan__h323_8c.html#4d00d79b6733c9cc066584a02ed03410">cos</a>(2.0 * M_PI * (freq1 / 8000.0)) * 32768.0;
<a name="l00313"></a>00313       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#1501a28b4e1c526e509b8e489a220d9a">init_v2_1</a> = sin(-4.0 * M_PI * (freq1 / 8000.0)) * d.<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00314"></a>00314       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#4493b108e1cbf87755e3b2f8e30e3ada">init_v3_1</a> = sin(-2.0 * M_PI * (freq1 / 8000.0)) * d.<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#151fb3908501dd115d22330471c438cb">fac2</a> = 2.0 * <a class="code" href="chan__h323_8c.html#4d00d79b6733c9cc066584a02ed03410">cos</a>(2.0 * M_PI * (freq2 / 8000.0)) * 32768.0;
<a name="l00317"></a>00317       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#db5db9c5214bdbf14de36f8a017a302e">init_v2_2</a> = sin(-4.0 * M_PI * (freq2 / 8000.0)) * d.<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00318"></a>00318       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#13822a5ada30b49216d9ac18d4d77dd0">init_v3_2</a> = sin(-2.0 * M_PI * (freq2 / 8000.0)) * d.<a class="code" href="structplaytones__def.html#0acf8be1231e24946c3d10b649fb576f">vol</a>;
<a name="l00319"></a>00319       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#b85ec314bf443b797ef8a66b3b03f8a4">duration</a> = time;
<a name="l00320"></a>00320       d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>[d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>].<a class="code" href="structplaytones__item.html#15e95cb1264e3dfced379f625e5773d3">modulate</a> = modulate;
<a name="l00321"></a>00321       d.<a class="code" href="structplaytones__def.html#0067ce9bdb8c263ff8f1020e82fe54e7">nitems</a>++;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       s = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp,separator);
<a name="l00324"></a>00324    }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#51350b9fba7a6a2428e1b3a13a131d54">ast_activate_generator</a>(chan, &amp;playtones, &amp;d)) {
<a name="l00327"></a>00327       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(d.<a class="code" href="structplaytones__def.html#691d502cfd0e0626cd3b058e5682ad1c">items</a>);
<a name="l00328"></a>00328       <span class="keywordflow">return</span> -1;
<a name="l00329"></a>00329    }
<a name="l00330"></a>00330    <span class="keywordflow">return</span> 0;
<a name="l00331"></a>00331 }
<a name="l00332"></a>00332 
<a name="l00333"></a><a class="code" href="indications_8h.html#58be04c13701ac7140bfeec76ba55ce9">00333</a> <span class="keywordtype">void</span> <a class="code" href="indications_8c.html#58be04c13701ac7140bfeec76ba55ce9">ast_playtones_stop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335    <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">/*--------------------------------------------*/</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a36c903c152ec798053aabc912ee96b3">AST_RWLIST_HEAD_STATIC</a>(tone_zones, <a class="code" href="structind__tone__zone.html">ind_tone_zone</a>);
<a name="l00341"></a><a class="code" href="indications_8c.html#7267f735d7413818c9b294e46f01c3fa">00341</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *<a class="code" href="indications_8c.html#7267f735d7413818c9b294e46f01c3fa">current_tonezone</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a><a class="code" href="indications_8h.html#1038dea11ef39111d70c6d9a82df09ac">00343</a> <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *<a class="code" href="indications_8c.html#1038dea11ef39111d70c6d9a82df09ac">ast_walk_indications</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *cur)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345    <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *tz = NULL;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;tone_zones);
<a name="l00348"></a>00348    <span class="comment">/* If cur is not NULL, then we have to iterate through - otherwise just return the first entry */</span>
<a name="l00349"></a>00349    <span class="keywordflow">if</span> (cur) {
<a name="l00350"></a>00350       <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;tone_zones, tz, list) {
<a name="l00351"></a>00351          <span class="keywordflow">if</span> (tz == cur)
<a name="l00352"></a>00352             <span class="keywordflow">break</span>;
<a name="l00353"></a>00353       }
<a name="l00354"></a>00354       tz = <a class="code" href="linkedlists_8h.html#04a4aa761cd2212562b40eae9f1e2d17">AST_RWLIST_NEXT</a>(tz, list);
<a name="l00355"></a>00355    } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356       tz = <a class="code" href="linkedlists_8h.html#8600701a3803b234e586a326b513acf8">AST_RWLIST_FIRST</a>(&amp;tone_zones);
<a name="l00357"></a>00357    }
<a name="l00358"></a>00358    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360    <span class="keywordflow">return</span> tz;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">/* Set global indication country */</span>
<a name="l00364"></a><a class="code" href="indications_8h.html#75f64a8ec5c96a94c641c16fdfd2b8f9">00364</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#75f64a8ec5c96a94c641c16fdfd2b8f9">ast_set_indication_country</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__dundi_8c.html#e3b8e3d273f3406ca7e220679295a310">country</a>)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366    <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *zone = NULL;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    <span class="comment">/* If no country is specified or we are unable to find the zone, then return not found */</span>
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (!country || !(zone = <a class="code" href="indications_8c.html#49d42aaf101f1eb95805594a8eb241ff">ast_get_indication_zone</a>(country)))
<a name="l00370"></a>00370       <span class="keywordflow">return</span> 1;
<a name="l00371"></a>00371    
<a name="l00372"></a>00372    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00373"></a>00373       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Setting default indication country to '%s'\n"</span>, country);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <span class="comment">/* Protect the current tonezone using the tone_zones lock as well */</span>
<a name="l00376"></a>00376    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;tone_zones);
<a name="l00377"></a>00377    current_tonezone = zone;
<a name="l00378"></a>00378    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380    <span class="comment">/* Zone was found */</span>
<a name="l00381"></a>00381    <span class="keywordflow">return</span> 0;
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="comment">/* locate tone_zone, given the country. if country == NULL, use the default country */</span>
<a name="l00385"></a><a class="code" href="indications_8h.html#49d42aaf101f1eb95805594a8eb241ff">00385</a> <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *<a class="code" href="indications_8c.html#49d42aaf101f1eb95805594a8eb241ff">ast_get_indication_zone</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__dundi_8c.html#e3b8e3d273f3406ca7e220679295a310">country</a>)
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387    <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *tz = NULL;
<a name="l00388"></a>00388    <span class="keywordtype">int</span> alias_loop = 0;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;tone_zones);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <span class="keywordflow">if</span> (!country) {
<a name="l00393"></a>00393       <span class="keywordflow">if</span> (current_tonezone)
<a name="l00394"></a>00394          tz = current_tonezone;
<a name="l00395"></a>00395       <span class="keywordflow">else</span>
<a name="l00396"></a>00396          tz = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;tone_zones);
<a name="l00397"></a>00397    } <span class="keywordflow">else</span> {
<a name="l00398"></a>00398       <span class="keywordflow">do</span> {
<a name="l00399"></a>00399          <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;tone_zones, tz, list) {
<a name="l00400"></a>00400             <span class="keywordflow">if</span> (!strcasecmp(tz-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>, country))
<a name="l00401"></a>00401                <span class="keywordflow">break</span>;
<a name="l00402"></a>00402          }
<a name="l00403"></a>00403          <span class="keywordflow">if</span> (!tz)
<a name="l00404"></a>00404             <span class="keywordflow">break</span>;
<a name="l00405"></a>00405          <span class="comment">/* If this is an alias then we have to search yet again otherwise we have found the zonezone */</span>
<a name="l00406"></a>00406          <span class="keywordflow">if</span> (tz-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a> &amp;&amp; tz-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a>[0])
<a name="l00407"></a>00407             country = tz-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a>;
<a name="l00408"></a>00408          <span class="keywordflow">else</span>
<a name="l00409"></a>00409             <span class="keywordflow">break</span>;
<a name="l00410"></a>00410       } <span class="keywordflow">while</span> ((++alias_loop &lt; 20) &amp;&amp; tz);
<a name="l00411"></a>00411    }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="comment">/* If we reached the maximum loops to find the proper country via alias, print out a notice */</span>
<a name="l00416"></a>00416    <span class="keywordflow">if</span> (alias_loop == 20)
<a name="l00417"></a>00417       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Alias loop for '%s' is bonkers\n"</span>, country);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    <span class="keywordflow">return</span> tz;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="comment">/* locate a tone_zone_sound, given the tone_zone. if tone_zone == NULL, use the default tone_zone */</span>
<a name="l00423"></a><a class="code" href="indications_8h.html#f8dc11a7ba1a39a19fc805ef5d914c4d">00423</a> <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *<a class="code" href="indications_8c.html#f8dc11a7ba1a39a19fc805ef5d914c4d">ast_get_indication_tone</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *zone, <span class="keyword">const</span> <span class="keywordtype">char</span> *indication)
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425    <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *ts = NULL;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;tone_zones);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429    <span class="comment">/* If no zone is already specified we need to try to pick one */</span>
<a name="l00430"></a>00430    <span class="keywordflow">if</span> (!zone) {
<a name="l00431"></a>00431       <span class="keywordflow">if</span> (current_tonezone) {
<a name="l00432"></a>00432          zone = current_tonezone;
<a name="l00433"></a>00433       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(zone = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;tone_zones))) {
<a name="l00434"></a>00434          <span class="comment">/* No zone has been found ;( */</span>
<a name="l00435"></a>00435          <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00436"></a>00436          <span class="keywordflow">return</span> NULL;
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438    }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="comment">/* Look through list of tones in the zone searching for the right one */</span>
<a name="l00441"></a>00441    <span class="keywordflow">for</span> (ts = zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>; ts; ts = ts-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00442"></a>00442       <span class="keywordflow">if</span> (!strcasecmp(ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>, indication))
<a name="l00443"></a>00443          <span class="keywordflow">break</span>;
<a name="l00444"></a>00444    }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448    <span class="keywordflow">return</span> ts;
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/* helper function to delete a tone_zone in its entirety */</span>
<a name="l00452"></a><a class="code" href="indications_8c.html#fbea3cc070f5e3ff907a96f7267f7134">00452</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="indications_8c.html#fbea3cc070f5e3ff907a96f7267f7134">free_zone</a>(<span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a>* zone)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454    <span class="keywordflow">while</span> (zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>) {
<a name="l00455"></a>00455       <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *tmp = zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00456"></a>00456       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00457"></a>00457       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l00458"></a>00458       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>);
<a name="l00459"></a>00459       zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a> = tmp;
<a name="l00460"></a>00460    }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (zone-&gt;<a class="code" href="structind__tone__zone.html#293e1942aa21abafc9b7b5d6a927e900">ringcadence</a>)
<a name="l00463"></a>00463       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(zone-&gt;<a class="code" href="structind__tone__zone.html#293e1942aa21abafc9b7b5d6a927e900">ringcadence</a>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(zone);
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="comment">/*--------------------------------------------*/</span>
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="comment">/* add a new country, if country exists, it will be replaced. */</span>
<a name="l00471"></a><a class="code" href="indications_8h.html#463ce5d78c00bd5266a954498802ae58">00471</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#0577af7a1b04d7695eafcca2b4de6eca">ast_register_indication_country</a>(<span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *zone)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473    <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *tz = NULL;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;tone_zones);
<a name="l00476"></a>00476    <a class="code" href="linkedlists_8h.html#b564f1f262db6464e1644462c38d61e3">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;tone_zones, tz, list) {
<a name="l00477"></a>00477       <span class="comment">/* If this is not the same zone, then just continue to the next entry */</span>
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (strcasecmp(zone-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>, tz-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>))
<a name="l00479"></a>00479          <span class="keywordflow">continue</span>;
<a name="l00480"></a>00480       <span class="comment">/* If this zone we are going to remove is the current default then make the new zone the default */</span>
<a name="l00481"></a>00481       <span class="keywordflow">if</span> (tz == current_tonezone)
<a name="l00482"></a>00482          current_tonezone = zone;
<a name="l00483"></a>00483       <span class="comment">/* Remove from the linked list */</span>
<a name="l00484"></a>00484       <a class="code" href="linkedlists_8h.html#93783e4cad722e705630e975d2e8d7f9">AST_RWLIST_REMOVE_CURRENT</a>(&amp;tone_zones, list);
<a name="l00485"></a>00485       <span class="comment">/* Finally free the zone itself */</span>
<a name="l00486"></a>00486       <a class="code" href="indications_8c.html#fbea3cc070f5e3ff907a96f7267f7134">free_zone</a>(tz);
<a name="l00487"></a>00487       <span class="keywordflow">break</span>;
<a name="l00488"></a>00488    }
<a name="l00489"></a>00489    <a class="code" href="linkedlists_8h.html#e5be717f6b8c1586fa30a060b56403fe">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l00490"></a>00490 
<a name="l00491"></a>00491    <span class="comment">/* Add zone to the list */</span>
<a name="l00492"></a>00492    <a class="code" href="linkedlists_8h.html#64b41a3e9f2e6a867c09431dfae7ce21">AST_RWLIST_INSERT_TAIL</a>(&amp;tone_zones, zone, list);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494    <span class="comment">/* It's all over. */</span>
<a name="l00495"></a>00495    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00498"></a>00498       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Registered indication country '%s'\n"</span>, zone-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500    <span class="keywordflow">return</span> 0;
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/* remove an existing country and all its indications, country must exist.</span>
<a name="l00504"></a>00504 <span class="comment"> * Also, all countries which are an alias for the specified country are removed. */</span>
<a name="l00505"></a><a class="code" href="indications_8h.html#15f016cbe243aedcacb138cd72e7d81d">00505</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#15f016cbe243aedcacb138cd72e7d81d">ast_unregister_indication_country</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__dundi_8c.html#e3b8e3d273f3406ca7e220679295a310">country</a>)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507    <span class="keyword">struct </span><a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *tz = NULL;
<a name="l00508"></a>00508    <span class="keywordtype">int</span> res = -1;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;tone_zones);
<a name="l00511"></a>00511    <a class="code" href="linkedlists_8h.html#b564f1f262db6464e1644462c38d61e3">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;tone_zones, tz, list) {
<a name="l00512"></a>00512       <span class="keywordflow">if</span> (country &amp;&amp; (strcasecmp(country, tz-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>) &amp;&amp; strcasecmp(country, tz-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a>)))
<a name="l00513"></a>00513          <span class="keywordflow">continue</span>;
<a name="l00514"></a>00514       <span class="comment">/* If this tonezone is the current default then unset it */</span>
<a name="l00515"></a>00515       <span class="keywordflow">if</span> (tz == current_tonezone) {
<a name="l00516"></a>00516          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>,<span class="stringliteral">"Removed default indication country '%s'\n"</span>, tz-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>);
<a name="l00517"></a>00517          current_tonezone = NULL;
<a name="l00518"></a>00518       }
<a name="l00519"></a>00519       <span class="comment">/* Remove from the list */</span>
<a name="l00520"></a>00520       <a class="code" href="linkedlists_8h.html#93783e4cad722e705630e975d2e8d7f9">AST_RWLIST_REMOVE_CURRENT</a>(&amp;tone_zones, list);
<a name="l00521"></a>00521       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00522"></a>00522          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Unregistered indication country '%s'\n"</span>, tz-&gt;<a class="code" href="structind__tone__zone.html#2ea91a07055ca491d76398d9f65a1120">country</a>);
<a name="l00523"></a>00523       <a class="code" href="indications_8c.html#fbea3cc070f5e3ff907a96f7267f7134">free_zone</a>(tz);
<a name="l00524"></a>00524       res = 0;
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526    <a class="code" href="linkedlists_8h.html#e5be717f6b8c1586fa30a060b56403fe">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l00527"></a>00527    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">return</span> res;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="comment">/* add a new indication to a tone_zone. tone_zone must exist. if the indication already</span>
<a name="l00533"></a>00533 <span class="comment"> * exists, it will be replaced. */</span>
<a name="l00534"></a><a class="code" href="indications_8h.html#ee4ad1e9ade62a0fc52bf4b80e0a6e46">00534</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#ee4ad1e9ade62a0fc52bf4b80e0a6e46">ast_register_indication</a>(<span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *zone, <span class="keyword">const</span> <span class="keywordtype">char</span> *indication, <span class="keyword">const</span> <span class="keywordtype">char</span> *tonelist)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536    <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *ts, *ps;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="comment">/* is it an alias? stop */</span>
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (zone-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a>[0])
<a name="l00540"></a>00540       <span class="keywordflow">return</span> -1;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;tone_zones);
<a name="l00543"></a>00543    <span class="keywordflow">for</span> (ps=NULL,ts=zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>; ts; ps=ts,ts=ts-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00544"></a>00544       <span class="keywordflow">if</span> (strcasecmp(indication,ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>)==0) {
<a name="l00545"></a>00545          <span class="comment">/* indication already there, replace */</span>
<a name="l00546"></a>00546          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00547"></a>00547          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)ts-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l00548"></a>00548          <span class="keywordflow">break</span>;
<a name="l00549"></a>00549       }
<a name="l00550"></a>00550    }
<a name="l00551"></a>00551    <span class="keywordflow">if</span> (!ts) {
<a name="l00552"></a>00552       <span class="comment">/* not there, we have to add */</span>
<a name="l00553"></a>00553       <span class="keywordflow">if</span> (!(ts = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*ts)))) {
<a name="l00554"></a>00554          <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00555"></a>00555          <span class="keywordflow">return</span> -2;
<a name="l00556"></a>00556       }
<a name="l00557"></a>00557       ts-&gt;next = NULL;
<a name="l00558"></a>00558    }
<a name="l00559"></a>00559    <span class="keywordflow">if</span> (!(ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(indication)) || !(ts-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(tonelist))) {
<a name="l00560"></a>00560       <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00561"></a>00561       <span class="keywordflow">return</span> -2;
<a name="l00562"></a>00562    }
<a name="l00563"></a>00563    <span class="keywordflow">if</span> (ps)
<a name="l00564"></a>00564       ps-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = ts;
<a name="l00565"></a>00565    <span class="keywordflow">else</span>
<a name="l00566"></a>00566       zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a> = ts;
<a name="l00567"></a>00567    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00568"></a>00568    <span class="keywordflow">return</span> 0;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="comment">/* remove an existing country's indication. Both country and indication must exist */</span>
<a name="l00572"></a><a class="code" href="indications_8h.html#b0bba690979f27902ba7788b01151a20">00572</a> <span class="keywordtype">int</span> <a class="code" href="indications_8c.html#b0bba690979f27902ba7788b01151a20">ast_unregister_indication</a>(<span class="keyword">struct</span> <a class="code" href="structind__tone__zone.html">ind_tone_zone</a> *zone, <span class="keyword">const</span> <span class="keywordtype">char</span> *indication)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574    <span class="keyword">struct </span><a class="code" href="structind__tone__zone__sound.html">ind_tone_zone_sound</a> *ts,*ps = NULL, *tmp;
<a name="l00575"></a>00575    <span class="keywordtype">int</span> res = -1;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="comment">/* is it an alias? stop */</span>
<a name="l00578"></a>00578    <span class="keywordflow">if</span> (zone-&gt;<a class="code" href="structind__tone__zone.html#9d3703e2ecc56bede195399decb7ec8c">alias</a>[0])
<a name="l00579"></a>00579       <span class="keywordflow">return</span> -1;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;tone_zones);
<a name="l00582"></a>00582    ts = zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a>;
<a name="l00583"></a>00583    <span class="keywordflow">while</span> (ts) {
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (strcasecmp(indication,ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>)==0) {
<a name="l00585"></a>00585          <span class="comment">/* indication found */</span>
<a name="l00586"></a>00586          tmp = ts-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00587"></a>00587          <span class="keywordflow">if</span> (ps)
<a name="l00588"></a>00588             ps-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = tmp;
<a name="l00589"></a>00589          <span class="keywordflow">else</span>
<a name="l00590"></a>00590             zone-&gt;<a class="code" href="structind__tone__zone.html#02f675376a7d1985287de020a5e9de37">tones</a> = tmp;
<a name="l00591"></a>00591          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)ts-&gt;<a class="code" href="structind__tone__zone__sound.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00592"></a>00592          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span>*)ts-&gt;<a class="code" href="structind__tone__zone__sound.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l00593"></a>00593          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ts);
<a name="l00594"></a>00594          ts = tmp;
<a name="l00595"></a>00595          res = 0;
<a name="l00596"></a>00596       }
<a name="l00597"></a>00597       <span class="keywordflow">else</span> {
<a name="l00598"></a>00598          <span class="comment">/* next zone please */</span>
<a name="l00599"></a>00599          ps = ts;
<a name="l00600"></a>00600          ts = ts-&gt;<a class="code" href="structind__tone__zone__sound.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602    }
<a name="l00603"></a>00603    <span class="comment">/* indication not found, goodbye */</span>
<a name="l00604"></a>00604    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;tone_zones);
<a name="l00605"></a>00605    <span class="keywordflow">return</span> res;
<a name="l00606"></a>00606 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:44 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
