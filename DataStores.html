<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:56 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<h1><a class="anchor" name="DataStores">Channel Data Stores</a></h1><h2><a class="anchor" name="debug">
Debugging</a></h2>
<div class="fragment"><pre class="fragment">Asterisk Channel Data Stores
============================

* What is a data store?

A data store is a way of storing complex data (such as a structure) on a channel
so it can be retrieved at a later time by another application, or the same application.

If the data store is not freed by said application though, a callback to a destroy function
occurs which frees the memory used by the data in the data store so no memory loss occurs.

* A datastore info structure
static const struct example_datastore {
       .type = "example",
       .destroy = callback_destroy
};

This is a needed structure that contains information about a datastore, it's used by many API calls.

* How do you create a data store?

1. Use ast_channel_datastore_alloc function to return a pre-allocated structure
   Ex: datastore = ast_channel_datastore_alloc(&amp;example_datastore, "uid");
   This function takes two arguments: (datastore info structure, uid)
2. Attach data and destroy callback to pre-allocated structure.
   Ex: datastore-&gt;data = mysillydata;
       datastore-&gt;destroy = callback_destroy;
3. Add datastore to the channel
   Ex: ast_channel_datastore_add(chan, datastore);
   This function takes two arguments: (pointer to channel, pointer to data store)

Full Example:

void callback_destroy(void *data)
{
	free(data);
}

struct ast_datastore *datastore = NULL;
datastore = ast_channel_datastore_alloc(&amp;example_datastore, NULL);
datastore-&gt;data = mysillydata;
datastore-&gt;destroy = callback_destroy;
ast_channel_datastore_add(chan, datastore);

NOTE: Because you're passing a pointer to a function in your module, you'll want to include
this in your use count. When allocated increment, when destroyed decrement.

* How do you remove a data store?

1. Find the data store
   Ex: datastore = ast_channel_datastore_find(chan, &amp;example_datastore, NULL);
   This function takes three arguments: (pointer to channel, datastore info structure, uid)
2. Remove the data store from the channel
   Ex: ast_channel_datastore_remove(chan, datastore);
   This function takes two arguments: (pointer to channel, pointer to data store)
3. If we want to now, free the memory or do stuff to the data on the data store
   If we do then we will want to unset the data and callback
   Ex: datastore-&gt;data = NULL;
       datastore-&gt;destroy = NULL;
4. Free the data store
   Ex: ast_channel_datastore_free(datastore);
   This function takes one argument: (pointer to data store)

* How do you find a data store?

1. Find the data store
   Ex: datastore = ast_channel_datastore_find(chan, &amp;example_datastore, NULL);
   This function takes three arguments: (pointer to channel, datastore info structure, uid)
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:56 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
