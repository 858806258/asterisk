<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:44 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fchannels_2F.html">channels</a>&nbsp;&raquo&nbsp;<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fchannels_2Fmisdn_2F.html">misdn</a></div>
<h1>isdn_lib.c</h1><a href="isdn__lib_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Chan_Misdn -- Channel Driver for Asterisk</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Interface to mISDN</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2004, Christian Richter</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * Christian Richter &lt;crich@beronet.com&gt;</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00011"></a>00011 <span class="comment"> * the GNU General Public License</span>
<a name="l00012"></a>00012 <span class="comment"> */</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;mISDNuser/isdn_debug.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="isdn__lib__intern_8h.html">isdn_lib_intern.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="isdn__lib_8h.html">isdn_lib.h</a>"</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#48b41b5415736e8b85aab525a75d9934">misdn_join_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id);
<a name="l00022"></a>00022 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id);
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#96c1c5fb3d85510a79f59a8ef1c6c197">queue_cleanup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc) ;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack);
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>( <span class="keywordtype">void</span> );
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="isdn__lib_8h.html#1eadd9655c46c8026f5101a79b16e94b">00030</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#1eadd9655c46c8026f5101a79b16e94b">misdn_lib_port_is_pri</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00033"></a>00033    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00034"></a>00034       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l00035"></a>00035          <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>;
<a name="l00036"></a>00036       }
<a name="l00037"></a>00037    }
<a name="l00038"></a>00038    
<a name="l00039"></a>00039    <span class="keywordflow">return</span> -1;
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="isdn__lib_8h.html#7e12e6dda68d0a5e9fcd3c1cc112985c">00043</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#7e12e6dda68d0a5e9fcd3c1cc112985c">misdn_lib_port_block</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00046"></a>00046    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00047"></a>00047       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l00048"></a>00048          stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>=1;
<a name="l00049"></a>00049          <span class="keywordflow">return</span> 0;
<a name="l00050"></a>00050       }
<a name="l00051"></a>00051    }
<a name="l00052"></a>00052    <span class="keywordflow">return</span> -1;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="isdn__lib_8h.html#e10d5b674e6dc6ed4b9c74e8b899ee9f">00056</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#e10d5b674e6dc6ed4b9c74e8b899ee9f">misdn_lib_port_unblock</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00059"></a>00059    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00060"></a>00060       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l00061"></a>00061          stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>=0;
<a name="l00062"></a>00062          <span class="keywordflow">return</span> 0;
<a name="l00063"></a>00063       }
<a name="l00064"></a>00064    }
<a name="l00065"></a>00065    <span class="keywordflow">return</span> -1;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="isdn__lib_8h.html#26991854b85d9c5707163806df41a9f9">00069</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#26991854b85d9c5707163806df41a9f9">misdn_lib_is_port_blocked</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>)
<a name="l00070"></a>00070 {  
<a name="l00071"></a>00071    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00072"></a>00072    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00073"></a>00073       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l00074"></a>00074          <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>;
<a name="l00075"></a>00075       }
<a name="l00076"></a>00076    }
<a name="l00077"></a>00077    <span class="keywordflow">return</span> -1;
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="isdn__lib_8h.html#fcc1dd285e5f9c6e3ed1cfbc8c63e46d">00080</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#fcc1dd285e5f9c6e3ed1cfbc8c63e46d">misdn_lib_is_ptp</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00083"></a>00083    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00084"></a>00084       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) <span class="keywordflow">return</span> stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>;
<a name="l00085"></a>00085    }
<a name="l00086"></a>00086    <span class="keywordflow">return</span> -1;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="isdn__lib_8h.html#19df248286e27256e10d8fe5ac291ba9">00089</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#19df248286e27256e10d8fe5ac291ba9">misdn_lib_get_maxchans</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>) 
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00092"></a>00092    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00093"></a>00093       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l00094"></a>00094          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>) 
<a name="l00095"></a>00095             <span class="keywordflow">return</span> 30;
<a name="l00096"></a>00096          <span class="keywordflow">else</span>
<a name="l00097"></a>00097             <span class="keywordflow">return</span> 2;
<a name="l00098"></a>00098       }
<a name="l00099"></a>00099    }
<a name="l00100"></a>00100    <span class="keywordflow">return</span> -1;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="isdn__lib__intern_8h.html#c09088b742125e27f2bd18f9bddf80d7">00104</a> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="keywordflow">if</span> (!bc) <span class="keywordflow">return</span> NULL;
<a name="l00109"></a>00109    
<a name="l00110"></a>00110    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00111"></a>00111       <span class="keywordtype">int</span> i;
<a name="l00112"></a>00112       <span class="keywordflow">for</span> (i=0; i &lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l00113"></a>00113          <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a> == stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>) <span class="keywordflow">return</span> stack;
<a name="l00114"></a>00114       }
<a name="l00115"></a>00115    }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117    <span class="keywordflow">return</span> NULL;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="isdn__lib_8h.html#89af7b5a99c83d3c147fa0eb579e7acd">00121</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#89af7b5a99c83d3c147fa0eb579e7acd">get_show_stack_details</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>();
<a name="l00124"></a>00124    
<a name="l00125"></a>00125    <span class="keywordflow">for</span> ( ; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00126"></a>00126       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) <span class="keywordflow">break</span>;
<a name="l00127"></a>00127    }
<a name="l00128"></a>00128    
<a name="l00129"></a>00129    <span class="keywordflow">if</span> (stack) {
<a name="l00130"></a>00130       sprintf(buf, <span class="stringliteral">"* Port %d Type %s Prot. %s L2Link %s L1Link:%s Blocked:%d"</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>?<span class="stringliteral">"NT"</span>:<span class="stringliteral">"TE"</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>?<span class="stringliteral">"PTP"</span>:<span class="stringliteral">"PMP"</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>?<span class="stringliteral">"UP"</span>:<span class="stringliteral">"DOWN"</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>?<span class="stringliteral">"UP"</span>:<span class="stringliteral">"DOWN"</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    } <span class="keywordflow">else</span> {
<a name="l00133"></a>00133       buf[0]=0;
<a name="l00134"></a>00134    }
<a name="l00135"></a>00135    
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">00139</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a> =0 ;
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c">00141</a> <span class="keyword">enum</span> <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c">global_states</a> {
<a name="l00142"></a>00142    <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c81ba789ff69864a590440376092e49d0">MISDN_INITIALIZING</a>,
<a name="l00143"></a>00143    <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c9c9a2ea84f30847e9b04cb5b4e59c862">MISDN_INITIALIZED</a>
<a name="l00144"></a>00144 } ;
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">00146</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c">global_states</a>  <a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">global_state</a>=<a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c81ba789ff69864a590440376092e49d0">MISDN_INITIALIZING</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;mISDNuser/net_l2.h&gt;</span>
<a name="l00150"></a>00150 <span class="preprocessor">#include &lt;mISDNuser/tone.h&gt;</span>
<a name="l00151"></a>00151 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00152"></a>00152 <span class="preprocessor">#include &lt;semaphore.h&gt;</span>
<a name="l00153"></a>00153 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00154"></a>00154 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#include "<a class="code" href="isdn__lib_8h.html">isdn_lib.h</a>"</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="structmisdn__lib.html">00159</a> <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> {
<a name="l00160"></a><a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">00160</a>    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>;
<a name="l00161"></a><a class="code" href="structmisdn__lib.html#35f1681c333ec4aea199d2467d9e546f">00161</a>    <span class="keywordtype">int</span> <a class="code" href="structmisdn__lib.html#35f1681c333ec4aea199d2467d9e546f">midev_nt</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="structmisdn__lib.html#13beb04f99cfd9fd4b1d9d303e774eff">00163</a>    pthread_t <a class="code" href="structmisdn__lib.html#13beb04f99cfd9fd4b1d9d303e774eff">event_thread</a>;
<a name="l00164"></a><a class="code" href="structmisdn__lib.html#f29d3e9cc8b1fd09bb4b028d5674dbec">00164</a>    pthread_t <a class="code" href="structmisdn__lib.html#f29d3e9cc8b1fd09bb4b028d5674dbec">event_handler_thread</a>;
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">00166</a>    <span class="keywordtype">void</span> *<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="structmisdn__lib.html#5aefa7b509ecc33f833a24377d231fee">00168</a>    msg_queue_t <a class="code" href="structmisdn__lib.html#5aefa7b509ecc33f833a24377d231fee">upqueue</a>;
<a name="l00169"></a><a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">00169</a>    msg_queue_t <a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>; 
<a name="l00170"></a>00170   
<a name="l00171"></a><a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">00171</a>    sem_t <a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>;
<a name="l00172"></a>00172   
<a name="l00173"></a><a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">00173</a>    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l00174"></a>00174 } ;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="preprocessor">#ifndef ECHOCAN_ON</span>
<a name="l00177"></a><a class="code" href="isdn__lib_8c.html#7c05d74d624c742f0a4908f7c9e0c1bc">00177</a> <span class="preprocessor"></span><span class="preprocessor">#define ECHOCAN_ON 123</span>
<a name="l00178"></a><a class="code" href="isdn__lib_8c.html#b64ad37401d9aa6b038fbb697112c9b5">00178</a> <span class="preprocessor"></span><span class="preprocessor">#define ECHOCAN_OFF 124</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="isdn__lib_8c.html#734054c92afeb46e391d2dc86bda929b">00181</a> <span class="preprocessor">#define MISDN_DEBUG 0</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>
<a name="l00183"></a>00183 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#b59aa831170c9444063d6baee2319ea4">misdn_tx_jitter</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>, <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#23f22efac15e89ad61667a53f6751de9">find_bc_by_confid</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> confid);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#7351f32b22751fbee9b1319927173498">stack_holder_find_bychan</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#5417f55f8e4c1b3b83070dcc12ca7c05">manager_isdn_handler</a>(iframe_t *frm ,msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#77381a12dae61feb0646a27e8fcfc8d4">misdn_lib_port_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>);
<a name="l00196"></a>00196 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#449f547947eebce21c820699c0f5326c">misdn_lib_pid_restart</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structisdn__msg.html">isdn_msg</a> msgs_g[]; 
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="isdn__lib_8c.html#bc700cd62fd147fb175b9495b7f12fc6">00200</a> <span class="preprocessor">#define ISDN_PID_L3_B_USER 0x430000ff</span>
<a name="l00201"></a><a class="code" href="isdn__lib_8c.html#99c7e1d33b92cadae69c5ef2caa84348">00201</a> <span class="preprocessor"></span><span class="preprocessor">#define ISDN_PID_L4_B_USER 0x440000ff</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>
<a name="l00203"></a>00203 <span class="comment">/* #define MISDN_IBUF_SIZE 1024 */</span>
<a name="l00204"></a><a class="code" href="isdn__lib_8c.html#f68e0a4d0e594d226029b207d1ded06c">00204</a> <span class="preprocessor">#define MISDN_IBUF_SIZE 512</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>
<a name="l00206"></a>00206 <span class="comment">/*  Fine Tuning of Inband  Signalling time */</span>
<a name="l00207"></a><a class="code" href="isdn__lib_8c.html#547210f420f77fc03ea5b4c54da4ed50">00207</a> <span class="preprocessor">#define TONE_ALERT_CNT 41 </span><span class="comment">/*  1 Sec  */</span>
<a name="l00208"></a><a class="code" href="isdn__lib_8c.html#f55ba23c9ddcc19ea97b9d5a6ba20efd">00208</a> <span class="preprocessor">#define TONE_ALERT_SILENCE_CNT 200 </span><span class="comment">/*  4 Sec */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a><a class="code" href="isdn__lib_8c.html#2846538ba4fc4b01f8163e9f5d7b15ae">00210</a> <span class="preprocessor">#define TONE_BUSY_CNT 20 </span><span class="comment">/*  ? */</span>
<a name="l00211"></a><a class="code" href="isdn__lib_8c.html#ecbea7190ec85f14ff285f59b3c9d697">00211</a> <span class="preprocessor">#define TONE_BUSY_SILENCE_CNT 48 </span><span class="comment">/*  ? */</span>
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">00213</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">entity</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="isdn__lib_8c.html#5d2ccedfd78cb20a19bb45bbc3552ed5">00215</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *<a class="code" href="isdn__lib_8c.html#5d2ccedfd78cb20a19bb45bbc3552ed5">glob_mgr</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="isdn__lib_8c.html#1fd9ac86cfafe1f47de45cfadce08968">00217</a> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#1fd9ac86cfafe1f47de45cfadce08968">tone_425_flip</a>[TONE_425_SIZE];
<a name="l00218"></a><a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">00218</a> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">tone_silence_flip</a>[TONE_SILENCE_SIZE];
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#7c6cd22b15b81f73d23093a5a99a8c35">misdn_lib_isdn_event_catcher</a>(<span class="keywordtype">void</span> *arg);
<a name="l00221"></a>00221 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#aedaecc9b13dea611f886e4f0b32db0f">handle_event_nt</a>(<span class="keywordtype">void</span> *dat, <span class="keywordtype">void</span> *arg);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#efc87b4d843aa2a2f20e6c0131e06eb8">stack_holder_add</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder);
<a name="l00225"></a>00225 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#8f698ed84747c21748f7bfae5b539991">stack_holder_remove</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder);
<a name="l00226"></a>00226 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">stack_holder_find</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">/* from isdn_lib.h */</span>
<a name="l00229"></a>00229 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#d3798d3d9b9e2350bf2efaeb3cf95b0b">init_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> * stack,  <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> midev, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="keywordtype">int</span> bidx, <span class="keywordtype">char</span> *<a class="code" href="structmisdn__bchannel.html#5db2aec2974afc8f2e491f9968535d81">msn</a>, <span class="keywordtype">int</span> firsttime);
<a name="l00230"></a>00230 <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#0cbef4e66d833fe125967ad9bdf43dd3">stack_init</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>,  <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="keywordtype">int</span> <a class="code" href="misdn__config_8c.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>);
<a name="l00231"></a>00231 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#6fcacd2e3826156000b2c6082ee06050">stack_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a>* stack);
<a name="l00232"></a>00232    <span class="comment">/* user iface */</span>
<a name="l00233"></a>00233 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#cb8e372f8838eb8a4f90860340f94828">te_lib_init</a>( <span class="keywordtype">void</span> ) ; <span class="comment">/* returns midev */</span>
<a name="l00234"></a>00234 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a3d088c00ea6fe1029a86467bcd36dcb">te_lib_destroy</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>) ;
<a name="l00235"></a>00235 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#d3554db5772822adaa03902792e06f57">manager_find_bc_by_pid</a>(<span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l00236"></a>00236 <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#576050fafaacafe15cc8bd3e7b038b1a">manager_find_bc_holded</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* bc);
<a name="l00237"></a>00237 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">void</span> *c2, <span class="keywordtype">int</span> c2_len);
<a name="l00238"></a>00238 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#b1f3ab8ba10db916482da4b0a13327c2">manager_clean_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc );
<a name="l00239"></a>00239 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#52f62077a6efef2aadb75c039d113989">manager_bchannel_setup</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00240"></a>00240 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#53022fa98182b6bd06dc5ef053df0ab0">manager_bchannel_cleanup</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#5b5d71a1ffbc5be7d8fb8e8de687b1a2">ec_chunk</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rxchunk, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *txchunk, <span class="keywordtype">int</span> chunk_size);
<a name="l00243"></a>00243    <span class="comment">/* end */</span>
<a name="l00244"></a>00244 <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#b1c9ec37fdd22197c7595c5db28bc20e">bchdev_echocancel_activate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* dev);
<a name="l00245"></a>00245 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#81ec869911d5db2b550875ee5a936212">bchdev_echocancel_deactivate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* dev);
<a name="l00246"></a>00246 <span class="comment">/* end */</span>
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 
<a name="l00249"></a><a class="code" href="isdn__lib_8c.html#451be85e2adf0cefe2d062cd6e9a5f01">00249</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__misdn_8c.html#451be85e2adf0cefe2d062cd6e9a5f01">bearer2str</a>(<span class="keywordtype">int</span> cap) {
<a name="l00250"></a>00250    <span class="keyword">static</span> <span class="keywordtype">char</span> *bearers[]={
<a name="l00251"></a>00251       <span class="stringliteral">"Speech"</span>,
<a name="l00252"></a>00252       <span class="stringliteral">"Audio 3.1k"</span>,
<a name="l00253"></a>00253       <span class="stringliteral">"Unres Digital"</span>,
<a name="l00254"></a>00254       <span class="stringliteral">"Res Digital"</span>,
<a name="l00255"></a>00255       <span class="stringliteral">"Unknown Bearer"</span>
<a name="l00256"></a>00256    };
<a name="l00257"></a>00257    
<a name="l00258"></a>00258    <span class="keywordflow">switch</span> (cap) {
<a name="l00259"></a>00259    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516ef1f1c0d03b0b0d9c87afc2d4b36f1ed3f">INFO_CAPABILITY_SPEECH</a>:
<a name="l00260"></a>00260       <span class="keywordflow">return</span> bearers[0];
<a name="l00261"></a>00261       <span class="keywordflow">break</span>;
<a name="l00262"></a>00262    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516ef6773829526db8b4080c0dbfe726345b9">INFO_CAPABILITY_AUDIO_3_1K</a>:
<a name="l00263"></a>00263       <span class="keywordflow">return</span> bearers[1];
<a name="l00264"></a>00264       <span class="keywordflow">break</span>;
<a name="l00265"></a>00265    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516eff9310f4b00a5c24034d8f16caf5aa61c">INFO_CAPABILITY_DIGITAL_UNRESTRICTED</a>:
<a name="l00266"></a>00266       <span class="keywordflow">return</span> bearers[2];
<a name="l00267"></a>00267       <span class="keywordflow">break</span>;
<a name="l00268"></a>00268    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516ef93117c23b1a9d25a738f83ea25913ad8">INFO_CAPABILITY_DIGITAL_RESTRICTED</a>:
<a name="l00269"></a>00269       <span class="keywordflow">return</span> bearers[3];
<a name="l00270"></a>00270       <span class="keywordflow">break</span>;
<a name="l00271"></a>00271    <span class="keywordflow">default</span>:
<a name="l00272"></a>00272       <span class="keywordflow">return</span> bearers[4];
<a name="l00273"></a>00273       <span class="keywordflow">break</span>;
<a name="l00274"></a>00274    }
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="isdn__lib_8c.html#927b05547fcf704dbb4ab6175e9531dd">00278</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="isdn__lib_8c.html#927b05547fcf704dbb4ab6175e9531dd">flip_table</a>[256];
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="isdn__lib_8c.html#5005e9c2029af4b07d38c2b3f13aefba">00280</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#5005e9c2029af4b07d38c2b3f13aefba">init_flip_bits</a>(<span class="keywordtype">void</span>)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <span class="keywordtype">int</span> i,k;
<a name="l00283"></a>00283    
<a name="l00284"></a>00284    <span class="keywordflow">for</span> (i = 0 ; i &lt; 256 ; i++) {
<a name="l00285"></a>00285       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sample = 0 ;
<a name="l00286"></a>00286       <span class="keywordflow">for</span> (k = 0; k&lt;8; k++) {
<a name="l00287"></a>00287          <span class="keywordflow">if</span> ( i &amp; 1 &lt;&lt; k ) sample |= 0x80 &gt;&gt;  k;
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289       <a class="code" href="isdn__lib_8c.html#927b05547fcf704dbb4ab6175e9531dd">flip_table</a>[i] = sample;
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a><a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">00293</a> <span class="keyword">static</span> <span class="keywordtype">char</span> * <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a> ( <span class="keywordtype">char</span> * <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> , <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)
<a name="l00294"></a>00294 {
<a name="l00295"></a>00295    <span class="keywordtype">int</span> i;
<a name="l00296"></a>00296    <span class="keywordtype">char</span> * start = buf;
<a name="l00297"></a>00297    
<a name="l00298"></a>00298    <span class="keywordflow">for</span> (i = 0 ; i &lt; len; i++) {
<a name="l00299"></a>00299       buf[i] = <a class="code" href="isdn__lib_8c.html#927b05547fcf704dbb4ab6175e9531dd">flip_table</a>[(<span class="keywordtype">unsigned</span> char)buf[i]];
<a name="l00300"></a>00300    }
<a name="l00301"></a>00301    
<a name="l00302"></a>00302    <span class="keywordflow">return</span> start;
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a><a class="code" href="isdn__lib_8c.html#c9eb9ffb48964359f93ce54cb99e4cee">00308</a> <span class="keyword">static</span> msg_t *<a class="code" href="isdn__lib_8c.html#c9eb9ffb48964359f93ce54cb99e4cee">create_l2msg</a>(<span class="keywordtype">int</span> prim, <span class="keywordtype">int</span> dinfo, <span class="keywordtype">int</span> size) <span class="comment">/* NT only */</span>
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310    <span class="keywordtype">int</span> i = 0;
<a name="l00311"></a>00311    msg_t *dmsg;
<a name="l00312"></a>00312   
<a name="l00313"></a>00313    <span class="keywordflow">while</span>(i &lt; 10)
<a name="l00314"></a>00314    {
<a name="l00315"></a>00315       dmsg = prep_l3data_msg(prim, dinfo, size, 256, NULL);
<a name="l00316"></a>00316       <span class="keywordflow">if</span> (dmsg)
<a name="l00317"></a>00317          <span class="keywordflow">return</span>(dmsg);
<a name="l00318"></a>00318       
<a name="l00319"></a>00319       <span class="keywordflow">if</span> (!i)
<a name="l00320"></a>00320          printf(<span class="stringliteral">"cannot allocate memory, trying again...\n"</span>);
<a name="l00321"></a>00321       i++;
<a name="l00322"></a>00322       usleep(300000);
<a name="l00323"></a>00323    }
<a name="l00324"></a>00324    printf(<span class="stringliteral">"cannot allocate memory, system overloaded.\n"</span>);
<a name="l00325"></a>00325    exit(-1);
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00330"></a><a class="code" href="isdn__lib__intern_8h.html#1d4f5844685dfde2f9796ca485bdb524">00330</a> msg_t *<a class="code" href="isdn__lib_8c.html#2ffacfd0c06efa0ba96eb8b7af5a9e0c">create_l3msg</a>(<span class="keywordtype">int</span> prim, <span class="keywordtype">int</span> mt, <span class="keywordtype">int</span> dinfo, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> ntmode)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332    <span class="keywordtype">int</span> i = 0;
<a name="l00333"></a>00333    msg_t *dmsg;
<a name="l00334"></a>00334    Q931_info_t *qi;
<a name="l00335"></a>00335    iframe_t *frm;
<a name="l00336"></a>00336   
<a name="l00337"></a>00337    <span class="keywordflow">if</span> (!ntmode)
<a name="l00338"></a>00338       size = <span class="keyword">sizeof</span>(Q931_info_t)+2;
<a name="l00339"></a>00339   
<a name="l00340"></a>00340    <span class="keywordflow">while</span>(i &lt; 10) {
<a name="l00341"></a>00341       <span class="keywordflow">if</span> (ntmode) {
<a name="l00342"></a>00342          dmsg = prep_l3data_msg(prim, dinfo, size, 256, NULL);
<a name="l00343"></a>00343          <span class="keywordflow">if</span> (dmsg) {
<a name="l00344"></a>00344             <span class="keywordflow">return</span>(dmsg);
<a name="l00345"></a>00345          }
<a name="l00346"></a>00346       } <span class="keywordflow">else</span> {
<a name="l00347"></a>00347          dmsg = alloc_msg(size+256+mISDN_HEADER_LEN+DEFAULT_HEADROOM);
<a name="l00348"></a>00348          <span class="keywordflow">if</span> (dmsg)
<a name="l00349"></a>00349          {
<a name="l00350"></a>00350             memset(msg_put(dmsg,size+mISDN_HEADER_LEN), 0, size+mISDN_HEADER_LEN);
<a name="l00351"></a>00351             frm = (iframe_t *)dmsg-&gt;data;
<a name="l00352"></a>00352             frm-&gt;prim = prim;
<a name="l00353"></a>00353             frm-&gt;dinfo = dinfo;
<a name="l00354"></a>00354             qi = (Q931_info_t *)(dmsg-&gt;data + mISDN_HEADER_LEN);
<a name="l00355"></a>00355             qi-&gt;type = mt;
<a name="l00356"></a>00356             <span class="keywordflow">return</span>(dmsg);
<a name="l00357"></a>00357          }
<a name="l00358"></a>00358       }
<a name="l00359"></a>00359     
<a name="l00360"></a>00360       <span class="keywordflow">if</span> (!i) printf(<span class="stringliteral">"cannot allocate memory, trying again...\n"</span>);
<a name="l00361"></a>00361       i++;
<a name="l00362"></a>00362       usleep(300000);
<a name="l00363"></a>00363    }
<a name="l00364"></a>00364    printf(<span class="stringliteral">"cannot allocate memory, system overloaded.\n"</span>);
<a name="l00365"></a>00365    exit(-1);
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="isdn__lib_8c.html#2a33a89434457ffc1aa0211edf843e1a">00369</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#2a33a89434457ffc1aa0211edf843e1a">send_msg</a> (<span class="keywordtype">int</span> midev, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, msg_t *dmsg)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371    iframe_t *frm;
<a name="l00372"></a>00372    frm = (iframe_t *)dmsg-&gt;data;
<a name="l00373"></a>00373    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <span class="keywordflow">if</span> (!stack) {
<a name="l00376"></a>00376       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_msg: IEK!! no stack\n "</span>);
<a name="l00377"></a>00377       <span class="keywordflow">return</span> -1;
<a name="l00378"></a>00378    }
<a name="l00379"></a>00379    
<a name="l00380"></a>00380    frm-&gt;addr = (stack-&gt;upper_id | FLG_MSG_DOWN);
<a name="l00381"></a>00381    frm-&gt;dinfo = bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>;
<a name="l00382"></a>00382    frm-&gt;len = (dmsg-&gt;len) - mISDN_HEADER_LEN;
<a name="l00383"></a>00383             
<a name="l00384"></a>00384    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;port,<span class="stringliteral">"Sending msg, prim:%x addr:%x dinfo:%x\n"</span>,frm-&gt;prim,frm-&gt;addr,frm-&gt;dinfo);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    mISDN_write(midev, dmsg-&gt;data, dmsg-&gt;len, TIMEOUT_1SEC);
<a name="l00387"></a>00387    free_msg(dmsg);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <span class="keywordflow">return</span> 0;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 
<a name="l00393"></a><a class="code" href="isdn__lib_8c.html#4b7351e39fbf5517e6673e8d28239130">00393</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#4b7351e39fbf5517e6673e8d28239130">mypid</a>=1;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="isdn__lib_8h.html#a23f050c1c24dd0c5ef51074149350b4">00396</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(<span class="keywordtype">int</span> cap)<span class="comment"></span>
<a name="l00397"></a>00397 <span class="comment">/** Poor mans version **/</span>
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399    <span class="keywordflow">if</span> ( (cap != <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516eff9310f4b00a5c24034d8f16caf5aa61c">INFO_CAPABILITY_DIGITAL_UNRESTRICTED</a>) &amp;&amp;
<a name="l00400"></a>00400         (cap != <a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516ef93117c23b1a9d25a738f83ea25913ad8">INFO_CAPABILITY_DIGITAL_RESTRICTED</a>) ) <span class="keywordflow">return</span> 1;
<a name="l00401"></a>00401    <span class="keywordflow">return</span> 0;
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="isdn__lib_8h.html#a0bdc32d3fe03b2759e2f02e2c529bb9">00404</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a0bdc32d3fe03b2759e2f02e2c529bb9">misdn_inband_avail</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406 
<a name="l00407"></a>00407    <span class="comment">/*if ! early_bconnect we have never inband available*/</span>
<a name="l00408"></a>00408    <span class="keywordflow">if</span> ( ! bc-&gt;<a class="code" href="structmisdn__bchannel.html#1892748ca3f0d880d36c9adc0021ca29">early_bconnect</a> ) <span class="keywordflow">return</span> 0;
<a name="l00409"></a>00409    
<a name="l00410"></a>00410    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#fd8941ae54dfa065640246e1b8b9110d">progress_indicator</a>) {
<a name="l00411"></a>00411    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#68986ab776eb5d6b5a809a1c005a730015f1649c833efc824bd229c6c9caaa1c">INFO_PI_INBAND_AVAILABLE</a>:
<a name="l00412"></a>00412    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#68986ab776eb5d6b5a809a1c005a730087e0268ad5a6c48d1fbcd169317109d0">INFO_PI_CALL_NOT_E2E_ISDN</a>:
<a name="l00413"></a>00413    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#68986ab776eb5d6b5a809a1c005a73008c07fb2be1a1bf8f09df66cf12bc7db6">INFO_PI_CALLED_NOT_ISDN</a>:
<a name="l00414"></a>00414       <span class="keywordflow">return</span> 1;
<a name="l00415"></a>00415    <span class="keywordflow">default</span>:
<a name="l00416"></a>00416       <span class="keywordflow">return</span> 0;
<a name="l00417"></a>00417    }
<a name="l00418"></a>00418    <span class="keywordflow">return</span> 0;
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">00422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">dump_chan_list</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424    <span class="keywordtype">int</span> i;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426    <span class="keywordflow">for</span> (i=0; i &lt;= stack-&gt;b_num; i++) {
<a name="l00427"></a>00427       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(6, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Idx:%d stack-&gt;cchan:%d Chan:%d\n"</span>,i,stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[i], i+1);
<a name="l00428"></a>00428    }
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">00434</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#1feea25ecb958229287f885aebe7c49b">dec</a>)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436    <span class="keywordtype">int</span> i;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"find_free_chan: req_chan:%d\n"</span>,channel);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="keywordflow">if</span> (channel &lt; 0 || channel &gt; <a class="code" href="isdn__lib_8h.html#eb21feec143b2d5027f57c0e93410e7e">MAX_BCHANS</a>) {
<a name="l00441"></a>00441       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" !! out of bound call to find_free_chan_in_stack! (ch:%d)\n"</span>, channel);
<a name="l00442"></a>00442       <span class="keywordflow">return</span> 0;
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444    
<a name="l00445"></a>00445    channel--;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <span class="keywordtype">int</span> bnums=stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>?stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>:stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>-1;
<a name="l00448"></a>00448  
<a name="l00449"></a>00449    <span class="keywordflow">if</span> (dec) {
<a name="l00450"></a>00450       <span class="keywordflow">for</span> (i = bnums; i &gt;=0; i--) {
<a name="l00451"></a>00451          <span class="keywordflow">if</span> (i != 15 &amp;&amp; (channel &lt; 0 || i == channel)) { <span class="comment">/* skip E1 Dchannel ;) and work with chan preselection */</span>
<a name="l00452"></a>00452             <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[i]) {
<a name="l00453"></a>00453                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; found chan%s: %d\n"</span>, channel&gt;=0?<span class="stringliteral">" (preselected)"</span>:<span class="stringliteral">""</span>, i+1);
<a name="l00454"></a>00454                bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=i+1;
<a name="l00455"></a>00455                <span class="keywordflow">return</span> i+1;
<a name="l00456"></a>00456             }
<a name="l00457"></a>00457          }
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459    } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460       <span class="keywordflow">for</span> (i = 0; i &lt;= bnums; i++) {
<a name="l00461"></a>00461          <span class="keywordflow">if</span> (i != 15 &amp;&amp; (channel &lt; 0 || i == channel)) { <span class="comment">/* skip E1 Dchannel ;) and work with chan preselection */</span>
<a name="l00462"></a>00462             <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[i]) {
<a name="l00463"></a>00463                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; found chan%s: %d\n"</span>, channel&gt;=0?<span class="stringliteral">" (preselected)"</span>:<span class="stringliteral">""</span>, i+1);
<a name="l00464"></a>00464                bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=i+1;
<a name="l00465"></a>00465                <span class="keywordflow">return</span> i+1;
<a name="l00466"></a>00466             }
<a name="l00467"></a>00467          }
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (1, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" !! NO FREE CHAN IN STACK\n"</span>);
<a name="l00472"></a>00472    <a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">dump_chan_list</a>(stack);
<a name="l00473"></a>00473   
<a name="l00474"></a>00474    <span class="keywordflow">return</span> 0;
<a name="l00475"></a>00475 }
<a name="l00476"></a>00476 
<a name="l00477"></a><a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">00477</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479    <span class="keywordflow">if</span> (channel&lt;=0 || channel&gt;<a class="code" href="isdn__lib_8h.html#eb21feec143b2d5027f57c0e93410e7e">MAX_BCHANS</a>) {
<a name="l00480"></a>00480       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"empty_chan_in_stack: cannot empty channel %d\n"</span>,channel);
<a name="l00481"></a>00481       <span class="keywordflow">return</span> -1;
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    
<a name="l00484"></a>00484    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"empty_chan_in_stack: %d\n"</span>,channel); 
<a name="l00485"></a>00485    stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[channel-1] = 0;
<a name="l00486"></a>00486    <a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">dump_chan_list</a>(stack);
<a name="l00487"></a>00487    <span class="keywordflow">return</span> 0;
<a name="l00488"></a>00488 }
<a name="l00489"></a>00489 
<a name="l00490"></a><a class="code" href="isdn__lib_8h.html#03aed91359ce0e4749a32ebd8361d1e8">00490</a> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(<span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28">bchannel_state</a> <a class="code" href="structstate.html">state</a>) {
<a name="l00491"></a>00491    <span class="keywordtype">int</span> i;
<a name="l00492"></a>00492    
<a name="l00493"></a>00493    <span class="keyword">struct </span>bchan_state_s {
<a name="l00494"></a>00494       <span class="keywordtype">char</span> *n;
<a name="l00495"></a>00495       <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28">bchannel_state</a> <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00496"></a>00496    } states[] = {
<a name="l00497"></a>00497       {<span class="stringliteral">"BCHAN_CLEANED"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a> },
<a name="l00498"></a>00498       {<span class="stringliteral">"BCHAN_EMPTY"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2821861338413bc1d8db12d20c857a1fbd">BCHAN_EMPTY</a>},
<a name="l00499"></a>00499       {<span class="stringliteral">"BCHAN_SETUP"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a288d71a56de5a4cb0fe251019a647f4f4f">BCHAN_SETUP</a>},
<a name="l00500"></a>00500       {<span class="stringliteral">"BCHAN_SETUPED"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a288d61277fd5c69f7eb0b4c5d0ac6c4693">BCHAN_SETUPED</a>},
<a name="l00501"></a>00501       {<span class="stringliteral">"BCHAN_ACTIVE"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a280b76fc97b05ce2be4505f569eb3dce7b">BCHAN_ACTIVE</a>},
<a name="l00502"></a>00502       {<span class="stringliteral">"BCHAN_ACTIVATED"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>},
<a name="l00503"></a>00503       {<span class="stringliteral">"BCHAN_BRIDGE"</span>,  <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2822f36d903c157045b476828824160664">BCHAN_BRIDGE</a>},
<a name="l00504"></a>00504       {<span class="stringliteral">"BCHAN_BRIDGED"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>},
<a name="l00505"></a>00505       {<span class="stringliteral">"BCHAN_RELEASE"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2818f3da7fccfd350072ca0c6df45b221f">BCHAN_RELEASE</a>},
<a name="l00506"></a>00506       {<span class="stringliteral">"BCHAN_RELEASED"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2883fc7ec3e9ac5d2fcbc7d871ebde0b88">BCHAN_RELEASED</a>},
<a name="l00507"></a>00507       {<span class="stringliteral">"BCHAN_CLEAN"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a284d04c401688eca09a71624eb2e2562a7">BCHAN_CLEAN</a>},
<a name="l00508"></a>00508       {<span class="stringliteral">"BCHAN_CLEAN_REQUEST"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2896790b3b75a52c602d1d27f0c3e10adc">BCHAN_CLEAN_REQUEST</a>},
<a name="l00509"></a>00509       {<span class="stringliteral">"BCHAN_ERROR"</span>, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>}
<a name="l00510"></a>00510    };
<a name="l00511"></a>00511    
<a name="l00512"></a>00512    <span class="keywordflow">for</span> (i=0; i&lt; <span class="keyword">sizeof</span>(states)/<span class="keyword">sizeof</span>(<span class="keyword">struct</span> bchan_state_s); i++)
<a name="l00513"></a>00513       <span class="keywordflow">if</span> ( states[i].<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> == state)
<a name="l00514"></a>00514          <span class="keywordflow">return</span> states[i].n;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516    <span class="keywordflow">return</span> <span class="stringliteral">"UNKNOWN"</span>;
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="isdn__lib_8h.html#342648c4b1de37e939f96c6fddefce53">00519</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28">bchannel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"BC_STATE_CHANGE: l3id:%x from:%s to:%s\n"</span>,
<a name="l00522"></a>00522       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>,
<a name="l00523"></a>00523           <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>),
<a name="l00524"></a>00524           <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(state) );
<a name="l00525"></a>00525    
<a name="l00526"></a>00526    <span class="keywordflow">switch</span> (state) {
<a name="l00527"></a>00527       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>:
<a name="l00528"></a>00528          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#690dda5d93876b2ec4587ed6459686e1">next_bc_state</a> ==  <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>) {
<a name="l00529"></a>00529             <a class="code" href="isdn__lib_8c.html#48b41b5415736e8b85aab525a75d9934">misdn_join_conf</a>(bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>);
<a name="l00530"></a>00530             bc-&gt;next_bc_state = <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2821861338413bc1d8db12d20c857a1fbd">BCHAN_EMPTY</a>;
<a name="l00531"></a>00531             <span class="keywordflow">return</span>;
<a name="l00532"></a>00532          }
<a name="l00533"></a>00533       <span class="keywordflow">default</span>:
<a name="l00534"></a>00534          bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>=state;
<a name="l00535"></a>00535          <span class="keywordflow">break</span>;
<a name="l00536"></a>00536    }
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a><a class="code" href="isdn__lib_8c.html#961b646b4b3dc79e9f2783b77091c3f2">00539</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#961b646b4b3dc79e9f2783b77091c3f2">bc_next_state_change</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28">bchannel_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"BC_NEXT_STATE_CHANGE: from:%s to:%s\n"</span>,
<a name="l00542"></a>00542           <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#690dda5d93876b2ec4587ed6459686e1">next_bc_state</a>),
<a name="l00543"></a>00543           <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(state) );
<a name="l00544"></a>00544 
<a name="l00545"></a>00545    bc-&gt;<a class="code" href="structmisdn__bchannel.html#690dda5d93876b2ec4587ed6459686e1">next_bc_state</a>=state;
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 
<a name="l00549"></a><a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">00549</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1c054c3defdb331c735fdc24d297c48b">bframe_len</a>=0;
<a name="l00552"></a>00552    
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    bc-&gt;<a class="code" href="structmisdn__bchannel.html#98b23b2fb5bb3781d8bd041e8ff6e5e3">in_use</a>= 0;
<a name="l00555"></a>00555    bc-&gt;<a class="code" href="structmisdn__bchannel.html#0707ba092e91260b305c326e6a353593">cw</a>= 0;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1feea25ecb958229287f885aebe7c49b">dec</a>=0;
<a name="l00558"></a>00558    bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> = 0;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560    bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a22bbaaa1a52c1367ec11dbc1690eb2">sending_complete</a> = 0;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562    bc-&gt;<a class="code" href="structmisdn__bchannel.html#c572ebed383139f70833e2e3225ba437">restart_channel</a>=0;
<a name="l00563"></a>00563    
<a name="l00564"></a>00564    bc-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a> = 0;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    bc-&gt;<a class="code" href="structmisdn__bchannel.html#15b147caaa4c7241e542f54af698bcf3">need_more_infos</a> = 0;
<a name="l00567"></a>00567    
<a name="l00568"></a>00568    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1fbbf457c117eb090e03c894a2bef0e7">send_dtmf</a>=0;
<a name="l00569"></a>00569    bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>=0;
<a name="l00570"></a>00570    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1b253e98e64cbf710286e8febc477541">nojitter</a>=0;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572    bc-&gt;<a class="code" href="structmisdn__bchannel.html#afb4a89d22eb9fc935a60ca1e2659040">time_usec</a>=0;
<a name="l00573"></a>00573    
<a name="l00574"></a>00574    bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>=0;
<a name="l00575"></a>00575    bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>=0;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    bc-&gt;<a class="code" href="structmisdn__bchannel.html#f7bd616b6c841d2538735f76d1e02b57">crypt</a>=0;
<a name="l00578"></a>00578    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1d17f2f5dea4d9abb7a04192be9760bd">curptx</a>=0; bc-&gt;<a class="code" href="structmisdn__bchannel.html#91fbacf6ac021fec078e4632d2bf6982">curprx</a>=0;
<a name="l00579"></a>00579    
<a name="l00580"></a>00580    bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a>[0] = 0;
<a name="l00581"></a>00581    
<a name="l00582"></a>00582    bc-&gt;<a class="code" href="structmisdn__bchannel.html#bf9179cd881ae878dddfa78dd01baf7a">generate_tone</a>=0;
<a name="l00583"></a>00583    bc-&gt;<a class="code" href="structmisdn__bchannel.html#6f7799d0a20bc13102d505a6748d3c86">tone_cnt</a>=0;
<a name="l00584"></a>00584   
<a name="l00585"></a>00585    bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>=<a class="code" href="isdn__lib_8h.html#d9a8c1b4819eebd393d94439ab534d6323794c4f78d5a28496fa6d990a572952">NUMPLAN_UNKNOWN</a>;
<a name="l00586"></a>00586    bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>=<a class="code" href="isdn__lib_8h.html#d9a8c1b4819eebd393d94439ab534d6323794c4f78d5a28496fa6d990a572952">NUMPLAN_UNKNOWN</a>;
<a name="l00587"></a>00587    bc-&gt;<a class="code" href="structmisdn__bchannel.html#d606ba4cabf58ec7fcd9fb7a624f7c66">rnumplan</a>=<a class="code" href="isdn__lib_8h.html#d9a8c1b4819eebd393d94439ab534d6323794c4f78d5a28496fa6d990a572952">NUMPLAN_UNKNOWN</a>;
<a name="l00588"></a>00588    bc-&gt;<a class="code" href="structmisdn__bchannel.html#2070e7d51f19d857107dfb7eec18c488">cpnnumplan</a>=<a class="code" href="isdn__lib_8h.html#d9a8c1b4819eebd393d94439ab534d6323794c4f78d5a28496fa6d990a572952">NUMPLAN_UNKNOWN</a>;
<a name="l00589"></a>00589    
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    bc-&gt;<a class="code" href="structmisdn__bchannel.html#c76a5e84e4bdee527e274ea30c680d79">active</a> = 0;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1892748ca3f0d880d36c9adc0021ca29">early_bconnect</a> = 1;
<a name="l00594"></a>00594    
<a name="l00595"></a>00595 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span>   *bc-&gt;pipeline = 0;
<a name="l00597"></a>00597 <span class="preprocessor">#else</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>   bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2e8ad049ef7d1c9369a0ff3d65185ca">ec_enable</a> = 0;
<a name="l00599"></a>00599    bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a> = 128;
<a name="l00600"></a>00600 <span class="preprocessor">#endif</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>
<a name="l00602"></a>00602    bc-&gt;<a class="code" href="structmisdn__bchannel.html#628b7b3b4a83039a5515f64a87fff56c">AOCD_need_export</a> = 0;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604    bc-&gt;<a class="code" href="structmisdn__bchannel.html#025f253325b46929cd34f2a7c3c55e7c">orig</a>=0;
<a name="l00605"></a>00605   
<a name="l00606"></a>00606    bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>=16;
<a name="l00607"></a>00607    bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=16;
<a name="l00608"></a>00608    bc-&gt;<a class="code" href="structmisdn__bchannel.html#33f142212957eabbfdc6831f4d43fc7c">pres</a>=0 ; <span class="comment">/* screened */</span>
<a name="l00609"></a>00609    
<a name="l00610"></a>00610    bc-&gt;<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a>=<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0495f687faead1367521e53b5c0046e90">EVENT_NOTHING</a>;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    bc-&gt;<a class="code" href="structmisdn__bchannel.html#6c83a51b09aae22b2b42a57f4295b8a6">progress_coding</a>=0;
<a name="l00613"></a>00613    bc-&gt;<a class="code" href="structmisdn__bchannel.html#3d898af1c6ae65f8fcddde83ac7ab497">progress_location</a>=0;
<a name="l00614"></a>00614    bc-&gt;<a class="code" href="structmisdn__bchannel.html#fd8941ae54dfa065640246e1b8b9110d">progress_indicator</a>=0;
<a name="l00615"></a>00615    <span class="comment"></span>
<a name="l00616"></a>00616 <span class="comment">/** Set Default Bearer Caps **/</span>
<a name="l00617"></a>00617    bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>=<a class="code" href="isdn__lib_8h.html#dca29a1140aadadfd92b34a02fa516ef1f1c0d03b0b0d9c87afc2d4b36f1ed3f">INFO_CAPABILITY_SPEECH</a>;
<a name="l00618"></a>00618    bc-&gt;<a class="code" href="structmisdn__bchannel.html#829a56cc8ffa56209e3a10b80d0bbdf8">law</a>=<a class="code" href="isdn__lib_8h.html#02653d87b6fa8554fc0d1a3726fea2d069cc7169b623cbdd570193c4fd0f817d">INFO_CODEC_ALAW</a>;
<a name="l00619"></a>00619    bc-&gt;<a class="code" href="structmisdn__bchannel.html#15d61712450a686a7f365adf4fef581f">mode</a>=0;
<a name="l00620"></a>00620    bc-&gt;<a class="code" href="structmisdn__bchannel.html#67942503875c1ae74e4b5b80a0dade01">rate</a>=0x10;
<a name="l00621"></a>00621    bc-&gt;<a class="code" href="structmisdn__bchannel.html#24c9e15e52afc47c225b757e7bee1f9d">user1</a>=0;
<a name="l00622"></a>00622    bc-&gt;<a class="code" href="structmisdn__bchannel.html#b5e011f38afe977e4ec3d1a57e7b33ec">urate</a>=0;
<a name="l00623"></a>00623    
<a name="l00624"></a>00624    bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5b29c6da3bb151aeeabb8e246b40e53">hdlc</a>=0;
<a name="l00625"></a>00625    
<a name="l00626"></a>00626    
<a name="l00627"></a>00627    bc-&gt;<a class="code" href="structmisdn__bchannel.html#914e1d3d7427eae06342feb03dfa4d94">info_dad</a>[0] = 0;
<a name="l00628"></a>00628    bc-&gt;<a class="code" href="structmisdn__bchannel.html#8002122f3095d2de23855585971e3d85">display</a>[0] = 0;
<a name="l00629"></a>00629    bc-&gt;<a class="code" href="structmisdn__bchannel.html#795a3b64824e9fc0460e64cc6fcdec95">infos_pending</a>[0] = 0;
<a name="l00630"></a>00630    bc-&gt;<a class="code" href="structmisdn__bchannel.html#00a187a56514a72391c079e743703184">cad</a>[0] = 0;
<a name="l00631"></a>00631    bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>[0] = 0;
<a name="l00632"></a>00632    bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>[0] = 0;
<a name="l00633"></a>00633    bc-&gt;<a class="code" href="structmisdn__bchannel.html#05019236a972847373c26c73480a354f">rad</a>[0] = 0;
<a name="l00634"></a>00634    bc-&gt;<a class="code" href="structmisdn__bchannel.html#a95b952465f45872ba185e19cb59d7cd">orig_dad</a>[0] = 0;
<a name="l00635"></a>00635    bc-&gt;<a class="code" href="structmisdn__bchannel.html#c7a3050839bb76a47c76524d08685de6">uu</a>[0]=0;
<a name="l00636"></a>00636    bc-&gt;<a class="code" href="structmisdn__bchannel.html#cc9059269716ed9b731f3f3794c57e99">uulen</a>=0;
<a name="l00637"></a>00637    
<a name="l00638"></a>00638    bc-&gt;<a class="code" href="structmisdn__bchannel.html#1e2c56b310bde1e0e2fb8e15fa6c9791">fac_in</a>.Function = Fac_None;
<a name="l00639"></a>00639    bc-&gt;<a class="code" href="structmisdn__bchannel.html#ca50a1ec0b0862a7db839a72305d1c8d">fac_out</a>.Function = Fac_None;
<a name="l00640"></a>00640    
<a name="l00641"></a>00641    bc-&gt;<a class="code" href="structmisdn__bchannel.html#64ba0eb210867b51d65b8837a6c74617">te_choose_channel</a> = 0;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 
<a name="l00645"></a><a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">00645</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647    <span class="keywordtype">int</span> ret=0;
<a name="l00648"></a>00648    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buff[32];
<a name="l00649"></a>00649    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> * stack;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, bc?bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"$$$ CLEANUP CALLED pid:%d\n"</span>, bc?bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>:-1);
<a name="l00652"></a>00652    
<a name="l00653"></a>00653    <span class="keywordflow">if</span> (!bc  ) <span class="keywordflow">return</span> -1;
<a name="l00654"></a>00654    stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l00655"></a>00655    
<a name="l00656"></a>00656    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> -1;
<a name="l00657"></a>00657    
<a name="l00658"></a>00658    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a> ) {
<a name="l00659"></a>00659    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>:
<a name="l00660"></a>00660       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ Already cleaned up bc with stid :%x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>);
<a name="l00661"></a>00661       <span class="keywordflow">return</span> -1;
<a name="l00662"></a>00662       
<a name="l00663"></a>00663    <span class="keywordflow">default</span>:
<a name="l00664"></a>00664       <span class="keywordflow">break</span>;
<a name="l00665"></a>00665    }
<a name="l00666"></a>00666    
<a name="l00667"></a>00667    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ Cleaning up bc with stid :%x pid:%d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l00668"></a>00668    
<a name="l00669"></a>00669    <a class="code" href="isdn__lib_8c.html#206f7c8231feea70c091e1af0c907c7c">manager_ec_disable</a>(bc);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <a class="code" href="isdn__lib_8c.html#14a4f2683ae425c4e4d9d40fd37da78d">manager_bchannel_deactivate</a>(bc);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>|FLG_MSG_TARGET|FLG_MSG_DOWN, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l00674"></a>00674    
<a name="l00675"></a>00675    bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a> = 0;
<a name="l00676"></a>00676    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>);
<a name="l00677"></a>00677    
<a name="l00678"></a>00678    <span class="keywordflow">return</span> ret;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 
<a name="l00683"></a><a class="code" href="isdn__lib_8c.html#4ca6bc0fd37653def2f1ebeea7703bf2">00683</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#4ca6bc0fd37653def2f1ebeea7703bf2">clear_l3</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00684"></a>00684 {
<a name="l00685"></a>00685    <span class="keywordtype">int</span> i;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l00688"></a>00688       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">global_state</a> == <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c9c9a2ea84f30847e9b04cb5b4e59c862">MISDN_INITIALIZED</a>)  {
<a name="l00689"></a>00689          <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0adbb5302858f0ca23b9552f9a5402d26">EVENT_CLEANUP</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i], NULL); 
<a name="l00690"></a>00690          <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,i+1);
<a name="l00691"></a>00691          <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i]);
<a name="l00692"></a>00692          <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i]);
<a name="l00693"></a>00693       }
<a name="l00694"></a>00694       
<a name="l00695"></a>00695    } 
<a name="l00696"></a>00696 }
<a name="l00697"></a>00697 
<a name="l00698"></a><a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">00698</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> channel)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700 
<a name="l00701"></a>00701    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"set_chan_in_stack: %d\n"</span>,channel);
<a name="l00702"></a>00702    <a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">dump_chan_list</a>(stack);
<a name="l00703"></a>00703    <span class="keywordflow">if</span> (channel &gt;=1 &amp;&amp; channel &lt;= <a class="code" href="isdn__lib_8h.html#eb21feec143b2d5027f57c0e93410e7e">MAX_BCHANS</a>) {
<a name="l00704"></a>00704       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[channel-1])
<a name="l00705"></a>00705          stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[channel-1] = 1;
<a name="l00706"></a>00706       <span class="keywordflow">else</span> {
<a name="l00707"></a>00707          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"channel already in use:%d\n"</span>, channel );
<a name="l00708"></a>00708          <span class="keywordflow">return</span> -1;
<a name="l00709"></a>00709       }
<a name="l00710"></a>00710    } <span class="keywordflow">else</span> {
<a name="l00711"></a>00711       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"couldn't set channel %d in\n"</span>, channel );
<a name="l00712"></a>00712       <span class="keywordflow">return</span> -1;
<a name="l00713"></a>00713    }
<a name="l00714"></a>00714   
<a name="l00715"></a>00715    <span class="keywordflow">return</span> 0;
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718 <span class="preprocessor">#if 0</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> chan_in_stack_free(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack, <span class="keywordtype">int</span> channel)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[channel-1])
<a name="l00722"></a>00722       <span class="keywordflow">return</span> 0;
<a name="l00723"></a>00723   
<a name="l00724"></a>00724    <span class="keywordflow">return</span> 1;
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 <span class="preprocessor">#endif</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span>
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="isdn__lib_8c.html#43fd6e15ce20a095a634a4e0679b2847">00729</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#43fd6e15ce20a095a634a4e0679b2847">newteid</a>=0;
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="isdn__lib_8c.html#3a6c64c9c62f35d42cf85bf211fdfb6c">00731</a> <span class="preprocessor">#define MAXPROCS 0x100</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>
<a name="l00733"></a><a class="code" href="isdn__lib_8c.html#ac82279245a38de1dc36244d9bc86b95">00733</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ac82279245a38de1dc36244d9bc86b95">misdn_lib_get_l1_down</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735    <span class="comment">/* Pull Up L1 */</span> 
<a name="l00736"></a>00736    iframe_t act;
<a name="l00737"></a>00737    act.prim = PH_DEACTIVATE | REQUEST; 
<a name="l00738"></a>00738    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN)  ;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    
<a name="l00741"></a>00741    act.dinfo = 0;
<a name="l00742"></a>00742    act.len = 0;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="isdn__lib_8c.html#39f783ae77a77d141f283894e89a6037">00750</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#39f783ae77a77d141f283894e89a6037">misdn_lib_get_l2_down</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752    
<a name="l00753"></a>00753    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) ) {
<a name="l00754"></a>00754       msg_t *dmsg;
<a name="l00755"></a>00755       <span class="comment">/* L2 */</span>
<a name="l00756"></a>00756       dmsg = <a class="code" href="isdn__lib_8c.html#c9eb9ffb48964359f93ce54cb99e4cee">create_l2msg</a>(DL_RELEASE| REQUEST, 0, 0);
<a name="l00757"></a>00757       
<a name="l00758"></a>00758       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, dmsg))
<a name="l00759"></a>00759          free_msg(dmsg);
<a name="l00760"></a>00760       
<a name="l00761"></a>00761    } <span class="keywordflow">else</span> {
<a name="l00762"></a>00762       iframe_t act;
<a name="l00763"></a>00763       
<a name="l00764"></a>00764       act.prim = DL_RELEASE| REQUEST;
<a name="l00765"></a>00765       act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> |FLG_MSG_DOWN)  ;
<a name="l00766"></a>00766       
<a name="l00767"></a>00767       act.dinfo = 0;
<a name="l00768"></a>00768       act.len = 0;
<a name="l00769"></a>00769       <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00770"></a>00770    }
<a name="l00771"></a>00771    
<a name="l00772"></a>00772    <span class="keywordflow">return</span> 0;
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">00776</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778    <span class="comment">/* Pull Up L1 */</span> 
<a name="l00779"></a>00779    iframe_t act;
<a name="l00780"></a>00780    act.prim = PH_ACTIVATE | REQUEST; 
<a name="l00781"></a>00781    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN)  ;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    
<a name="l00784"></a>00784    act.dinfo = 0;
<a name="l00785"></a>00785    act.len = 0;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a><a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">00791</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793    
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) ) {
<a name="l00795"></a>00795       msg_t *dmsg;
<a name="l00796"></a>00796       <span class="comment">/* L2 */</span>
<a name="l00797"></a>00797       dmsg = <a class="code" href="isdn__lib_8c.html#c9eb9ffb48964359f93ce54cb99e4cee">create_l2msg</a>(DL_ESTABLISH | REQUEST, 0, 0);
<a name="l00798"></a>00798       
<a name="l00799"></a>00799       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, dmsg))
<a name="l00800"></a>00800          free_msg(dmsg);
<a name="l00801"></a>00801       
<a name="l00802"></a>00802    } <span class="keywordflow">else</span> {
<a name="l00803"></a>00803       iframe_t act;
<a name="l00804"></a>00804       
<a name="l00805"></a>00805       act.prim = DL_ESTABLISH | REQUEST;
<a name="l00806"></a>00806       act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> |FLG_MSG_DOWN)  ;
<a name="l00807"></a>00807       
<a name="l00808"></a>00808       act.dinfo = 0;
<a name="l00809"></a>00809       act.len = 0;
<a name="l00810"></a>00810       <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00811"></a>00811    }
<a name="l00812"></a>00812    
<a name="l00813"></a>00813    <span class="keywordflow">return</span> 0;
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="preprocessor">#if 0</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> misdn_lib_get_l2_te_ptp_up(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00818"></a>00818 {
<a name="l00819"></a>00819    iframe_t act;
<a name="l00820"></a>00820       
<a name="l00821"></a>00821    act.prim = DL_ESTABLISH | REQUEST;
<a name="l00822"></a>00822    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>  &amp; ~LAYER_ID_MASK) | 3 | FLG_MSG_DOWN;
<a name="l00823"></a>00823       
<a name="l00824"></a>00824    act.dinfo = 0;
<a name="l00825"></a>00825    act.len = 0;
<a name="l00826"></a>00826    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00827"></a>00827    <span class="keywordflow">return</span> 0;
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 <span class="preprocessor">#endif</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>
<a name="l00831"></a><a class="code" href="isdn__lib_8c.html#4a860c5934091035c3910e7d1f33e8f7">00831</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#4a860c5934091035c3910e7d1f33e8f7">misdn_lib_get_short_status</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833    iframe_t act;
<a name="l00834"></a>00834    
<a name="l00835"></a>00835    
<a name="l00836"></a>00836    act.prim = MGR_SHORTSTATUS | REQUEST; 
<a name="l00837"></a>00837    
<a name="l00838"></a>00838    act.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | MSG_BROADCAST)  ;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840    act.dinfo = SSTATUS_BROADCAST_BIT | SSTATUS_ALL;
<a name="l00841"></a>00841    
<a name="l00842"></a>00842    act.len = 0;
<a name="l00843"></a>00843    <span class="keywordflow">return</span> mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, &amp;act, mISDN_HEADER_LEN+act.len, TIMEOUT_1SEC);
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 
<a name="l00848"></a><a class="code" href="isdn__lib_8c.html#c1ee4cbe07ec953df3dbedd3f41c98bb">00848</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#c1ee4cbe07ec953df3dbedd3f41c98bb">create_process</a> (<span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>) {
<a name="l00849"></a>00849    iframe_t ncr;
<a name="l00850"></a>00850    <span class="keywordtype">int</span> l3_id;
<a name="l00851"></a>00851    <span class="keywordtype">int</span> i;
<a name="l00852"></a>00852    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l00853"></a>00853   
<a name="l00854"></a>00854    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l00855"></a>00855       <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(stack, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#523edd474a57ca623cab9c23c2e73fe5">channel_preselected</a> ? bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> : 0, 0))
<a name="l00856"></a>00856          <span class="keywordflow">return</span> -1;
<a name="l00857"></a>00857       <span class="comment">/*bc-&gt;channel=free_chan;*/</span>
<a name="l00858"></a>00858 
<a name="l00859"></a>00859       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(stack ,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>)&lt;0) <span class="keywordflow">return</span> -1;
<a name="l00860"></a>00860       
<a name="l00861"></a>00861       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt;  found channel: %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l00862"></a>00862     
<a name="l00863"></a>00863       <span class="keywordflow">for</span> (i=0; i &lt;= <a class="code" href="isdn__lib_8c.html#3a6c64c9c62f35d42cf85bf211fdfb6c">MAXPROCS</a>; i++)
<a name="l00864"></a>00864          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b0f6d00925afa4230624e7354414e53f">procids</a>[i]==0) <span class="keywordflow">break</span>;
<a name="l00865"></a>00865     
<a name="l00866"></a>00866       <span class="keywordflow">if</span> (i== <a class="code" href="isdn__lib_8c.html#3a6c64c9c62f35d42cf85bf211fdfb6c">MAXPROCS</a>) {
<a name="l00867"></a>00867          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Couldnt Create New ProcId.\n"</span>);
<a name="l00868"></a>00868          <span class="keywordflow">return</span> -1;
<a name="l00869"></a>00869       }
<a name="l00870"></a>00870       stack-&gt;<a class="code" href="structmisdn__stack.html#b0f6d00925afa4230624e7354414e53f">procids</a>[i]=1;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       l3_id = 0xff00 | i;
<a name="l00873"></a>00873     
<a name="l00874"></a>00874       ncr.prim = CC_NEW_CR | REQUEST; 
<a name="l00875"></a>00875 
<a name="l00876"></a>00876       ncr.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN)  ;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878       ncr.dinfo = l3_id;
<a name="l00879"></a>00879       ncr.len = 0;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> = l3_id;
<a name="l00882"></a>00882       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; new_l3id %x\n"</span>,l3_id);
<a name="l00883"></a>00883     
<a name="l00884"></a>00884    } <span class="keywordflow">else</span> { 
<a name="l00885"></a>00885       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> || bc-&gt;<a class="code" href="structmisdn__bchannel.html#64ba0eb210867b51d65b8837a6c74617">te_choose_channel</a>) {
<a name="l00886"></a>00886          <span class="comment">/* we know exactly which channels are in use */</span>
<a name="l00887"></a>00887          <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(stack, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#523edd474a57ca623cab9c23c2e73fe5">channel_preselected</a> ? bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> : 0, 0))
<a name="l00888"></a>00888             <span class="keywordflow">return</span> -1;
<a name="l00889"></a>00889          <span class="comment">/*bc-&gt;channel=free_chan;*/</span>
<a name="l00890"></a>00890          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt;  found channel: %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(stack ,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>)&lt;0) <span class="keywordflow">return</span> -1;
<a name="l00893"></a>00893       } <span class="keywordflow">else</span> {
<a name="l00894"></a>00894          <span class="comment">/* other phones could have made a call also on this port (ptmp) */</span>
<a name="l00895"></a>00895          bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=0xff;
<a name="l00896"></a>00896       }
<a name="l00897"></a>00897     
<a name="l00898"></a>00898     
<a name="l00899"></a>00899       <span class="comment">/* if we are in te-mode, we need to create a process first */</span>
<a name="l00900"></a>00900       <span class="keywordflow">if</span> (newteid++ &gt; 0xffff)
<a name="l00901"></a>00901          newteid = 0x0001;
<a name="l00902"></a>00902     
<a name="l00903"></a>00903       l3_id = (<a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">entity</a>&lt;&lt;16) | newteid;
<a name="l00904"></a>00904       <span class="comment">/* preparing message */</span>
<a name="l00905"></a>00905       ncr.prim = CC_NEW_CR | REQUEST; 
<a name="l00906"></a>00906 
<a name="l00907"></a>00907       ncr.addr = (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN)  ;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909       ncr.dinfo =l3_id;
<a name="l00910"></a>00910       ncr.len = 0;
<a name="l00911"></a>00911       <span class="comment">/* send message */</span>
<a name="l00912"></a>00912 
<a name="l00913"></a>00913       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> = l3_id;
<a name="l00914"></a>00914       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"--&gt; new_l3id %x\n"</span>,l3_id);
<a name="l00915"></a>00915     
<a name="l00916"></a>00916       mISDN_write(midev, &amp;ncr, mISDN_HEADER_LEN+ncr.len, TIMEOUT_1SEC);
<a name="l00917"></a>00917    }
<a name="l00918"></a>00918   
<a name="l00919"></a>00919    <span class="keywordflow">return</span> l3_id;
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="isdn__lib_8h.html#3c307bbe5f1d89b585363aed9c7854d1">00923</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#3c307bbe5f1d89b585363aed9c7854d1">misdn_lib_setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>)
<a name="l00924"></a>00924 {
<a name="l00925"></a>00925    <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l00926"></a>00926    <a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">00930</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buff[1025];
<a name="l00933"></a>00933   
<a name="l00934"></a>00934    mISDN_pid_t pid;
<a name="l00935"></a>00935    <span class="keywordtype">int</span> ret;
<a name="l00936"></a>00936    
<a name="l00937"></a>00937 
<a name="l00938"></a>00938    <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940    <span class="keywordflow">if</span> (!stack) {
<a name="l00941"></a>00941       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"setup_bc: NO STACK FOUND!!\n"</span>);
<a name="l00942"></a>00942       <span class="keywordflow">return</span> -1;
<a name="l00943"></a>00943    }
<a name="l00944"></a>00944    
<a name="l00945"></a>00945    <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>;
<a name="l00946"></a>00946    <span class="keywordtype">int</span> channel=bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>-1-(bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;16);
<a name="l00947"></a>00947    <span class="keywordtype">int</span> b_stid=stack-&gt;<a class="code" href="structmisdn__stack.html#a765eb0deaa75a049478f9e4912f2533">b_stids</a>[channel&gt;=0?channel:0];
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 
<a name="l00950"></a>00950    switch (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>) {
<a name="l00951"></a>00951       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>:
<a name="l00952"></a>00952          <span class="keywordflow">break</span>;
<a name="l00953"></a>00953       <span class="keywordflow">default</span>:
<a name="l00954"></a>00954          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ bc already upsetted stid :%x (state:%s)\n"</span>, b_stid, <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>) );
<a name="l00955"></a>00955          <span class="keywordflow">return</span> -1;
<a name="l00956"></a>00956    }
<a name="l00957"></a>00957    
<a name="l00958"></a>00958    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ Setting up bc with stid :%x\n"</span>, b_stid);
<a name="l00959"></a>00959    
<a name="l00960"></a>00960    <span class="keywordflow">if</span> (b_stid &lt;= 0) {
<a name="l00961"></a>00961       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" -- Stid &lt;=0 at the moment in channel:%d\n"</span>,channel);
<a name="l00962"></a>00962       
<a name="l00963"></a>00963       <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>);
<a name="l00964"></a>00964       <span class="keywordflow">return</span> 1;
<a name="l00965"></a>00965    }
<a name="l00966"></a>00966    
<a name="l00967"></a>00967    
<a name="l00968"></a>00968    bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a> = b_stid;
<a name="l00969"></a>00969    
<a name="l00970"></a>00970    {
<a name="l00971"></a>00971       layer_info_t li;
<a name="l00972"></a>00972       memset(&amp;li, 0, <span class="keyword">sizeof</span>(li));
<a name="l00973"></a>00973     
<a name="l00974"></a>00974       li.object_id = -1;
<a name="l00975"></a>00975       li.extentions = 0;
<a name="l00976"></a>00976       
<a name="l00977"></a>00977       li.st = bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>; <span class="comment">/*  given idx */</span>
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 
<a name="l00980"></a>00980 <span class="preprocessor">#define MISDN_DSP</span>
<a name="l00981"></a>00981 <span class="preprocessor"></span><span class="preprocessor">#ifndef MISDN_DSP</span>
<a name="l00982"></a>00982 <span class="preprocessor"></span>      bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>=1;
<a name="l00983"></a>00983 <span class="preprocessor">#endif</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5b29c6da3bb151aeeabb8e246b40e53">hdlc</a> || bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>) {
<a name="l00985"></a>00985          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"setup_bc: without dsp\n"</span>);
<a name="l00986"></a>00986          { 
<a name="l00987"></a>00987             <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l00988"></a>00988             strncpy(li.name, <span class="stringliteral">"B L3"</span>, l);
<a name="l00989"></a>00989             li.name[l-1] = 0;
<a name="l00990"></a>00990          }
<a name="l00991"></a>00991          li.pid.layermask = ISDN_LAYER((3));
<a name="l00992"></a>00992          li.pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#bc700cd62fd147fb175b9495b7f12fc6">ISDN_PID_L3_B_USER</a>;
<a name="l00993"></a>00993          
<a name="l00994"></a>00994          bc-&gt;<a class="code" href="structmisdn__bchannel.html#f56b53e412e87751f665cb9f9061e50b">layer</a>=3;
<a name="l00995"></a>00995       } <span class="keywordflow">else</span> {
<a name="l00996"></a>00996          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"setup_bc: with dsp\n"</span>);
<a name="l00997"></a>00997          { 
<a name="l00998"></a>00998             <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l00999"></a>00999             strncpy(li.name, <span class="stringliteral">"B L4"</span>, l);
<a name="l01000"></a>01000             li.name[l-1] = 0;
<a name="l01001"></a>01001          }
<a name="l01002"></a>01002          li.pid.layermask = ISDN_LAYER((4));
<a name="l01003"></a>01003          li.pid.protocol[4] = <a class="code" href="isdn__lib_8c.html#99c7e1d33b92cadae69c5ef2caa84348">ISDN_PID_L4_B_USER</a>
<a name="l01004"></a>01004 ;
<a name="l01005"></a>01005          bc-&gt;<a class="code" href="structmisdn__bchannel.html#f56b53e412e87751f665cb9f9061e50b">layer</a>=4;
<a name="l01006"></a>01006          
<a name="l01007"></a>01007       }  
<a name="l01008"></a>01008       
<a name="l01009"></a>01009       ret = mISDN_new_layer(midev, &amp;li);
<a name="l01010"></a>01010       <span class="keywordflow">if</span> (ret ) {
<a name="l01011"></a>01011          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"New Layer Err: %d %s\n"</span>,ret,strerror(errno));
<a name="l01012"></a>01012 
<a name="l01013"></a>01013          <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>);
<a name="l01014"></a>01014          <span class="keywordflow">return</span>(-EINVAL);
<a name="l01015"></a>01015       }
<a name="l01016"></a>01016       
<a name="l01017"></a>01017       bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a> = li.id;
<a name="l01018"></a>01018    }
<a name="l01019"></a>01019    
<a name="l01020"></a>01020    memset(&amp;pid, 0, <span class="keyword">sizeof</span>(pid));
<a name="l01021"></a>01021    
<a name="l01022"></a>01022    
<a name="l01023"></a>01023    
<a name="l01024"></a>01024    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; Channel is %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l01025"></a>01025    
<a name="l01026"></a>01026    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>) {
<a name="l01027"></a>01027       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; TRANSPARENT Mode (no DSP, no HDLC)\n"</span>);
<a name="l01028"></a>01028       pid.protocol[1] = ISDN_PID_L1_B_64TRANS;
<a name="l01029"></a>01029       pid.protocol[2] = ISDN_PID_L2_B_TRANS;
<a name="l01030"></a>01030       pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#bc700cd62fd147fb175b9495b7f12fc6">ISDN_PID_L3_B_USER</a>;
<a name="l01031"></a>01031       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3));
<a name="l01032"></a>01032       
<a name="l01033"></a>01033    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5b29c6da3bb151aeeabb8e246b40e53">hdlc</a> ) {
<a name="l01034"></a>01034       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; HDLC Mode\n"</span>);
<a name="l01035"></a>01035       pid.protocol[1] = ISDN_PID_L1_B_64HDLC ;
<a name="l01036"></a>01036       pid.protocol[2] = ISDN_PID_L2_B_TRANS  ;
<a name="l01037"></a>01037       pid.protocol[3] = <a class="code" href="isdn__lib_8c.html#bc700cd62fd147fb175b9495b7f12fc6">ISDN_PID_L3_B_USER</a>;
<a name="l01038"></a>01038       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3)) ;
<a name="l01039"></a>01039    } <span class="keywordflow">else</span> {
<a name="l01040"></a>01040       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; TRANSPARENT Mode\n"</span>);
<a name="l01041"></a>01041       pid.protocol[1] = ISDN_PID_L1_B_64TRANS;
<a name="l01042"></a>01042       pid.protocol[2] = ISDN_PID_L2_B_TRANS;
<a name="l01043"></a>01043       pid.protocol[3] = ISDN_PID_L3_B_DSP;
<a name="l01044"></a>01044       pid.protocol[4] = <a class="code" href="isdn__lib_8c.html#99c7e1d33b92cadae69c5ef2caa84348">ISDN_PID_L4_B_USER</a>;
<a name="l01045"></a>01045       pid.layermask = ISDN_LAYER((1)) | ISDN_LAYER((2)) | ISDN_LAYER((3)) | ISDN_LAYER((4));
<a name="l01046"></a>01046       
<a name="l01047"></a>01047    } 
<a name="l01048"></a>01048 
<a name="l01049"></a>01049    ret = mISDN_set_stack(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>, &amp;pid);
<a name="l01050"></a>01050 
<a name="l01051"></a>01051    <span class="keywordflow">if</span> (ret){
<a name="l01052"></a>01052       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"$$$ Set Stack Err: %d %s\n"</span>,ret,strerror(errno));
<a name="l01053"></a>01053       
<a name="l01054"></a>01054       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01055"></a>01055       
<a name="l01056"></a>01056       <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>);
<a name="l01057"></a>01057       <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0e1ee936e681cde534bb35e43a36e54e6">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01058"></a>01058       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01059"></a>01059    }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    ret = mISDN_get_setstack_ind(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <span class="keywordflow">if</span> (ret) {
<a name="l01064"></a>01064       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"$$$ Set StackIND Err: %d %s\n"</span>,ret,strerror(errno));
<a name="l01065"></a>01065       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01066"></a>01066       
<a name="l01067"></a>01067       <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>);
<a name="l01068"></a>01068       <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0e1ee936e681cde534bb35e43a36e54e6">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01069"></a>01069       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01070"></a>01070    }
<a name="l01071"></a>01071 
<a name="l01072"></a>01072    ret = mISDN_get_layerid(midev, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#f56b53e412e87751f665cb9f9061e50b">layer</a>) ;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> = ret&gt;0? ret : 0;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>) {
<a name="l01077"></a>01077       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"$$$ Get Layerid Err: %d %s\n"</span>,ret,strerror(errno));
<a name="l01078"></a>01078       mISDN_write_frame(midev, buff, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01079"></a>01079       
<a name="l01080"></a>01080       <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a281995888d10b0c49b9c6122be066754c7">BCHAN_ERROR</a>);
<a name="l01081"></a>01081       <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0e1ee936e681cde534bb35e43a36e54e6">EVENT_BCHAN_ERROR</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01082"></a>01082       <span class="keywordflow">return</span> (-EINVAL);
<a name="l01083"></a>01083    }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085    <a class="code" href="isdn__lib_8c.html#7269dc2ef1d0d8ac7858522cdda3c701">manager_bchannel_activate</a>(bc);
<a name="l01086"></a>01086    
<a name="l01087"></a>01087    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089    <span class="keywordflow">return</span> 0;
<a name="l01090"></a>01090 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 
<a name="l01093"></a>01093 <span class="comment"></span>
<a name="l01094"></a>01094 <span class="comment">/** IFACE **/</span>
<a name="l01095"></a><a class="code" href="isdn__lib_8c.html#d3798d3d9b9e2350bf2efaeb3cf95b0b">01095</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#d3798d3d9b9e2350bf2efaeb3cf95b0b">init_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack,  <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> midev, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="keywordtype">int</span> bidx,  <span class="keywordtype">char</span> *msn, <span class="keywordtype">int</span> firsttime)
<a name="l01096"></a>01096 {
<a name="l01097"></a>01097    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buff[1025];
<a name="l01098"></a>01098    iframe_t *frm = (iframe_t *)buff;
<a name="l01099"></a>01099    <span class="keywordtype">int</span> ret;
<a name="l01100"></a>01100   
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (!bc) <span class="keywordflow">return</span> -1;
<a name="l01102"></a>01102   
<a name="l01103"></a>01103    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"Init.BC %d.\n"</span>,bidx);
<a name="l01104"></a>01104    
<a name="l01105"></a>01105    memset(bc, 0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    bc-&gt;<a class="code" href="structmisdn__bchannel.html#80320d407369f6281809098222a117bd">send_lock</a>=<a class="code" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsend__lock.html">send_lock</a>));
<a name="l01108"></a>01108 
<a name="l01109"></a>01109    <a class="code" href="lock_8h.html#0ed3695ec827e8564009fb1c31e24d87">pthread_mutex_init</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#80320d407369f6281809098222a117bd">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#dce7c4174ce9323904a934a486c41288">lock</a>, NULL);
<a name="l01110"></a>01110    
<a name="l01111"></a>01111    <span class="keywordflow">if</span> (msn) {
<a name="l01112"></a>01112       <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5db2aec2974afc8f2e491f9968535d81">msn</a>);
<a name="l01113"></a>01113       strncpy(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5db2aec2974afc8f2e491f9968535d81">msn</a>,msn, l);
<a name="l01114"></a>01114       bc-&gt;<a class="code" href="structmisdn__bchannel.html#5db2aec2974afc8f2e491f9968535d81">msn</a>[l-1] = 0;
<a name="l01115"></a>01115    }
<a name="l01116"></a>01116    
<a name="l01117"></a>01117    
<a name="l01118"></a>01118    <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l01119"></a>01119    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc, <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>);
<a name="l01120"></a>01120    
<a name="l01121"></a>01121    bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l01122"></a>01122    bc-&gt;<a class="code" href="structmisdn__bchannel.html#25930e3036f13852cb0b29694bbab611">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>?1:0;
<a name="l01123"></a>01123    
<a name="l01124"></a>01124    {
<a name="l01125"></a>01125       ibuffer_t* ibuf= init_ibuffer(<a class="code" href="isdn__lib_8c.html#f68e0a4d0e594d226029b207d1ded06c">MISDN_IBUF_SIZE</a>);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127       <span class="keywordflow">if</span> (!ibuf) <span class="keywordflow">return</span> -1;
<a name="l01128"></a>01128       
<a name="l01129"></a>01129       clear_ibuffer( ibuf);
<a name="l01130"></a>01130       
<a name="l01131"></a>01131       ibuf-&gt;rsem=<a class="code" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc</a>(<span class="keyword">sizeof</span>(sem_t));
<a name="l01132"></a>01132       
<a name="l01133"></a>01133       bc-&gt;<a class="code" href="structmisdn__bchannel.html#17add620022df3bf225c0d43f4011ef2">astbuf</a>=ibuf;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135       <span class="keywordflow">if</span> (sem_init(ibuf-&gt;rsem,1,0)&lt;0)
<a name="l01136"></a>01136          sem_init(ibuf-&gt;rsem,0,0);
<a name="l01137"></a>01137       
<a name="l01138"></a>01138    }
<a name="l01139"></a>01139    
<a name="l01140"></a>01140    
<a name="l01141"></a>01141    
<a name="l01142"></a>01142    
<a name="l01143"></a>01143    {
<a name="l01144"></a>01144       stack_info_t *stinf;
<a name="l01145"></a>01145       ret = mISDN_get_stack_info(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, buff, <span class="keyword">sizeof</span>(buff));
<a name="l01146"></a>01146       <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l01147"></a>01147          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"%s: Cannot get stack info for this port. (ret=%d)\n"</span>, __FUNCTION__, ret);
<a name="l01148"></a>01148          <span class="keywordflow">return</span> -1;
<a name="l01149"></a>01149       }
<a name="l01150"></a>01150     
<a name="l01151"></a>01151       stinf = (stack_info_t *)&amp;frm-&gt;data.p;
<a name="l01152"></a>01152     
<a name="l01153"></a>01153       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">" --&gt; Child %x\n"</span>,stinf-&gt;child[bidx]);
<a name="l01154"></a>01154    }
<a name="l01155"></a>01155   
<a name="l01156"></a>01156    <span class="keywordflow">return</span> 0;
<a name="l01157"></a>01157 }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 
<a name="l01161"></a><a class="code" href="isdn__lib_8c.html#0cbef4e66d833fe125967ad9bdf43dd3">01161</a> <span class="keyword">struct </span><a class="code" href="structmisdn__stack.html">misdn_stack</a>* <a class="code" href="isdn__lib_8c.html#0cbef4e66d833fe125967ad9bdf43dd3">stack_init</a>( <span class="keywordtype">int</span> midev, <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="keywordtype">int</span> <a class="code" href="misdn__config_8c.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> )
<a name="l01162"></a>01162 {
<a name="l01163"></a>01163    <span class="keywordtype">int</span> ret;
<a name="l01164"></a>01164    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buff[1025];
<a name="l01165"></a>01165    iframe_t *frm = (iframe_t *)buff;
<a name="l01166"></a>01166    stack_info_t *stinf;
<a name="l01167"></a>01167    <span class="keywordtype">int</span> i; 
<a name="l01168"></a>01168    layer_info_t li;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a> *stack = <a class="code" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__stack.html">misdn_stack</a>));
<a name="l01171"></a>01171    <span class="keywordflow">if</span> (!stack ) <span class="keywordflow">return</span> NULL;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 
<a name="l01174"></a>01174    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"Init. Stack.\n"</span>);
<a name="l01175"></a>01175   
<a name="l01176"></a>01176    memset(stack,0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> misdn_stack));
<a name="l01177"></a>01177   
<a name="l01178"></a>01178    <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="isdn__lib_8h.html#eb21feec143b2d5027f57c0e93410e7e">MAX_BCHANS</a> + 1; i++ ) stack-&gt;<a class="code" href="structmisdn__stack.html#9c8072b7f04dcb9ce897c3cb7c08e2cc">channels</a>[i]=0;
<a name="l01179"></a>01179    
<a name="l01180"></a>01180    stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>=port;
<a name="l01181"></a>01181    stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>=midev;
<a name="l01182"></a>01182    stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>=ptp;
<a name="l01183"></a>01183   
<a name="l01184"></a>01184    stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>=NULL;
<a name="l01185"></a>01185    stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>=0;
<a name="l01186"></a>01186   
<a name="l01187"></a>01187    msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#18e8b7ec18aada3301aedec1abc1bdc6">downqueue</a>);
<a name="l01188"></a>01188    msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#5aefa7b509ecc33f833a24377d231fee">upqueue</a>);
<a name="l01189"></a>01189   
<a name="l01190"></a>01190    <span class="comment">/* query port's requirements */</span>
<a name="l01191"></a>01191    ret = mISDN_get_stack_info(midev, port, buff, <span class="keyword">sizeof</span>(buff));
<a name="l01192"></a>01192    <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l01193"></a>01193       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"%s: Cannot get stack info for this port. (ret=%d)\n"</span>, __FUNCTION__, ret);
<a name="l01194"></a>01194       <span class="keywordflow">return</span>(NULL);
<a name="l01195"></a>01195    }
<a name="l01196"></a>01196   
<a name="l01197"></a>01197    stinf = (stack_info_t *)&amp;frm-&gt;data.p;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199    stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a> = stinf-&gt;id;
<a name="l01200"></a>01200    stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a> = stinf-&gt;childcnt;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <span class="keywordflow">for</span> (i=0; i&lt;=stinf-&gt;childcnt; i++)
<a name="l01203"></a>01203       stack-&gt;<a class="code" href="structmisdn__stack.html#a765eb0deaa75a049478f9e4912f2533">b_stids</a>[i] = stinf-&gt;child[i];
<a name="l01204"></a>01204   
<a name="l01205"></a>01205    <span class="keywordflow">switch</span>(stinf-&gt;pid.protocol[0] &amp; ~ISDN_PID_FEATURE_MASK) {
<a name="l01206"></a>01206    <span class="keywordflow">case</span> ISDN_PID_L0_TE_S0:
<a name="l01207"></a>01207       stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>=0;
<a name="l01208"></a>01208       <span class="keywordflow">break</span>;
<a name="l01209"></a>01209    <span class="keywordflow">case</span> ISDN_PID_L0_NT_S0:
<a name="l01210"></a>01210       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"NT Stack\n"</span>);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212       stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>=1;
<a name="l01213"></a>01213       <span class="keywordflow">break</span>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 <span class="preprocessor">#ifndef MISDN_1_2</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>   <span class="keywordflow">case</span> ISDN_PID_L0_TE_U:
<a name="l01217"></a>01217       <span class="keywordflow">break</span>;
<a name="l01218"></a>01218    <span class="keywordflow">case</span> ISDN_PID_L0_NT_U:
<a name="l01219"></a>01219       <span class="keywordflow">break</span>;
<a name="l01220"></a>01220    <span class="keywordflow">case</span> ISDN_PID_L0_TE_UP2:
<a name="l01221"></a>01221       <span class="keywordflow">break</span>;
<a name="l01222"></a>01222    <span class="keywordflow">case</span> ISDN_PID_L0_NT_UP2:
<a name="l01223"></a>01223       <span class="keywordflow">break</span>;
<a name="l01224"></a>01224 <span class="preprocessor">#endif</span>
<a name="l01225"></a>01225 <span class="preprocessor"></span>   <span class="keywordflow">case</span> ISDN_PID_L0_TE_E1:
<a name="l01226"></a>01226       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"TE S2M Stack\n"</span>);
<a name="l01227"></a>01227       stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>=0;
<a name="l01228"></a>01228       stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>=1;
<a name="l01229"></a>01229       <span class="keywordflow">break</span>;
<a name="l01230"></a>01230    <span class="keywordflow">case</span> ISDN_PID_L0_NT_E1:
<a name="l01231"></a>01231       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"TE S2M Stack\n"</span>);
<a name="l01232"></a>01232       stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>=1;
<a name="l01233"></a>01233       stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>=1;
<a name="l01234"></a>01234       
<a name="l01235"></a>01235       <span class="keywordflow">break</span>;
<a name="l01236"></a>01236    <span class="keywordflow">default</span>:
<a name="l01237"></a>01237       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"this is a unknown port type 0x%08x\n"</span>, stinf-&gt;pid.protocol[0]);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239    }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l01242"></a>01242       <span class="keywordflow">if</span> (stinf-&gt;pid.protocol[2] &amp; ISDN_PID_L2_DF_PTP ) { 
<a name="l01243"></a>01243          stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> = 1;
<a name="l01244"></a>01244       } <span class="keywordflow">else</span> {
<a name="l01245"></a>01245          stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> = 0;
<a name="l01246"></a>01246       }
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248    
<a name="l01249"></a>01249    {
<a name="l01250"></a>01250       <span class="keywordtype">int</span> ret;
<a name="l01251"></a>01251       <span class="keywordtype">int</span> <a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>;
<a name="l01252"></a>01252 
<a name="l01253"></a>01253       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"Init. Stack.\n"</span>);
<a name="l01254"></a>01254       
<a name="l01255"></a>01255       memset(&amp;li, 0, <span class="keyword">sizeof</span>(li));
<a name="l01256"></a>01256       {
<a name="l01257"></a>01257          <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(li.name);
<a name="l01258"></a>01258          strncpy(li.name,nt?<span class="stringliteral">"net l2"</span>:<span class="stringliteral">"user l4"</span>, l);
<a name="l01259"></a>01259          li.name[l-1] = 0;
<a name="l01260"></a>01260       }
<a name="l01261"></a>01261       li.object_id = -1;
<a name="l01262"></a>01262       li.extentions = 0;
<a name="l01263"></a>01263       li.pid.protocol[nt?2:4] = nt?ISDN_PID_L2_LAPD_NET:ISDN_PID_L4_CAPI20;
<a name="l01264"></a>01264       li.pid.layermask = ISDN_LAYER((nt?2:4));
<a name="l01265"></a>01265       li.st = stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>;
<a name="l01266"></a>01266       
<a name="l01267"></a>01267       
<a name="l01268"></a>01268       ret = mISDN_new_layer(midev, &amp;li);
<a name="l01269"></a>01269       <span class="keywordflow">if</span> (ret) {
<a name="l01270"></a>01270          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"%s: Cannot add layer %d to this port.\n"</span>, __FUNCTION__, nt?2:4);
<a name="l01271"></a>01271          <span class="keywordflow">return</span>(NULL);
<a name="l01272"></a>01272       }
<a name="l01273"></a>01273       
<a name="l01274"></a>01274       
<a name="l01275"></a>01275       stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> = li.id;
<a name="l01276"></a>01276       ret = mISDN_register_layer(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>);
<a name="l01277"></a>01277       <span class="keywordflow">if</span> (ret)
<a name="l01278"></a>01278       {
<a name="l01279"></a>01279          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Cannot register layer %d of this port.\n"</span>, nt?2:4);
<a name="l01280"></a>01280          <span class="keywordflow">return</span>(NULL);
<a name="l01281"></a>01281       }
<a name="l01282"></a>01282       
<a name="l01283"></a>01283       stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a> = mISDN_get_layerid(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>, nt?1:3); 
<a name="l01284"></a>01284       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a> &lt; 0) {
<a name="l01285"></a>01285          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"%s: Cannot get layer(%d) id of this port.\n"</span>, __FUNCTION__, nt?1:3);
<a name="l01286"></a>01286          <span class="keywordflow">return</span>(NULL);
<a name="l01287"></a>01287       }
<a name="l01288"></a>01288       
<a name="l01289"></a>01289       stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> = mISDN_get_layerid(midev, stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>, nt?2:4);
<a name="l01290"></a>01290       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> &lt; 0) {
<a name="l01291"></a>01291          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"%s: Cannot get layer(%d) id of this port.\n"</span>, __FUNCTION__, 2);
<a name="l01292"></a>01292          <span class="keywordflow">return</span>(NULL);
<a name="l01293"></a>01293       }
<a name="l01294"></a>01294       
<a name="l01295"></a>01295       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, port, <span class="stringliteral">"NT Stacks upper_id %x\n"</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>);
<a name="l01296"></a>01296       
<a name="l01297"></a>01297       
<a name="l01298"></a>01298       <span class="comment">/* create nst (nt-mode only) */</span>
<a name="l01299"></a>01299       <span class="keywordflow">if</span> (nt) {
<a name="l01300"></a>01300          
<a name="l01301"></a>01301          memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, 0, <span class="keyword">sizeof</span>(net_stack_t));
<a name="l01302"></a>01302          memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>, 0, <span class="keyword">sizeof</span>(manager_t));
<a name="l01303"></a>01303     
<a name="l01304"></a>01304          stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>.nst = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>;
<a name="l01305"></a>01305          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>;
<a name="l01306"></a>01306     
<a name="l01307"></a>01307          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l3_manager = <a class="code" href="isdn__lib_8c.html#aedaecc9b13dea611f886e4f0b32db0f">handle_event_nt</a>;
<a name="l01308"></a>01308          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.device = midev;
<a name="l01309"></a>01309          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.cardnr = port;
<a name="l01310"></a>01310          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.d_stid = stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>;
<a name="l01311"></a>01311     
<a name="l01312"></a>01312          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature = FEATURE_NET_HOLD;
<a name="l01313"></a>01313          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>)
<a name="l01314"></a>01314             stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature |= FEATURE_NET_PTP;
<a name="l01315"></a>01315          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>)
<a name="l01316"></a>01316             stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature |= FEATURE_NET_CRLEN2 | FEATURE_NET_EXTCID;
<a name="l01317"></a>01317          
<a name="l01318"></a>01318          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l1_id = stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a>;
<a name="l01319"></a>01319          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l2_id = stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>;
<a name="l01320"></a>01320          
<a name="l01321"></a>01321          msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.down_queue);
<a name="l01322"></a>01322          
<a name="l01323"></a>01323          Isdnl2Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l01324"></a>01324          Isdnl3Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l01325"></a>01325          
<a name="l01326"></a>01326       } 
<a name="l01327"></a>01327       
<a name="l01328"></a>01328       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l01329"></a>01329          <span class="comment">/*assume L1 is up, we'll get DEACTIVATES soon, for non</span>
<a name="l01330"></a>01330 <span class="comment">          * up L1s*/</span>
<a name="l01331"></a>01331          stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=0;
<a name="l01332"></a>01332       }
<a name="l01333"></a>01333       stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=0;
<a name="l01334"></a>01334       stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=0;
<a name="l01335"></a>01335 <span class="preprocessor">#if 0 </span>
<a name="l01336"></a>01336 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l01337"></a>01337          <a class="code" href="isdn__lib_8c.html#4a860c5934091035c3910e7d1f33e8f7">misdn_lib_get_short_status</a>(stack);
<a name="l01338"></a>01338       } <span class="keywordflow">else</span> {
<a name="l01339"></a>01339          <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l01340"></a>01340          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>) <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l01341"></a>01341          <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack);
<a name="l01342"></a>01342       }
<a name="l01343"></a>01343 <span class="preprocessor">#endif</span>
<a name="l01344"></a>01344 <span class="preprocessor"></span>
<a name="l01345"></a>01345       <a class="code" href="isdn__lib_8c.html#4a860c5934091035c3910e7d1f33e8f7">misdn_lib_get_short_status</a>(stack);
<a name="l01346"></a>01346       <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l01347"></a>01347       <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack); 
<a name="l01348"></a>01348       
<a name="l01349"></a>01349    }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8,0,<span class="stringliteral">"stack_init: port:%d lowerId:%x  upperId:%x\n"</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>);
<a name="l01352"></a>01352    
<a name="l01353"></a>01353    <span class="keywordflow">return</span> stack;
<a name="l01354"></a>01354 }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="isdn__lib_8c.html#6fcacd2e3826156000b2c6082ee06050">01357</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#6fcacd2e3826156000b2c6082ee06050">stack_destroy</a>(<span class="keyword">struct</span> misdn_stack* stack)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359    <span class="keywordtype">char</span> buf[1024];
<a name="l01360"></a>01360    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span>;
<a name="l01361"></a>01361 
<a name="l01362"></a>01362    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l01363"></a>01363       cleanup_Isdnl2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l01364"></a>01364       cleanup_Isdnl3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l01365"></a>01365    }
<a name="l01366"></a>01366   
<a name="l01367"></a>01367    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a>) 
<a name="l01368"></a>01368       mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370    <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>) 
<a name="l01371"></a>01371       mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l01372"></a>01372 }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 
<a name="l01375"></a><a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">01375</a> <span class="keyword">static</span> <span class="keyword">struct </span>misdn_stack * <a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>(<span class="keywordtype">int</span>  addr)
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01378"></a>01378    
<a name="l01379"></a>01379    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01380"></a>01380         stack;
<a name="l01381"></a>01381         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01382"></a>01382       <span class="keywordflow">if</span> ( (stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>&amp;STACK_ID_MASK) == (addr&amp;STACK_ID_MASK)) <span class="keywordflow">return</span> stack;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384    }
<a name="l01385"></a>01385   
<a name="l01386"></a>01386    <span class="keywordflow">return</span> NULL;
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 
<a name="l01390"></a><a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">01390</a> <span class="keyword">static</span> <span class="keyword">struct </span>misdn_stack * <a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(<span class="keywordtype">int</span> port)
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01393"></a>01393   
<a name="l01394"></a>01394    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01395"></a>01395         stack;
<a name="l01396"></a>01396         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) 
<a name="l01397"></a>01397       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) <span class="keywordflow">return</span> stack;
<a name="l01398"></a>01398   
<a name="l01399"></a>01399    <span class="keywordflow">return</span> NULL;
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a><a class="code" href="isdn__lib_8c.html#1f14600ce56c46d748500b119238cda1">01402</a> <span class="keyword">static</span> <span class="keyword">struct </span>misdn_stack * <a class="code" href="isdn__lib_8c.html#1f14600ce56c46d748500b119238cda1">find_stack_by_mgr</a>(manager_t* mgr_nt)
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01405"></a>01405   
<a name="l01406"></a>01406    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01407"></a>01407         stack;
<a name="l01408"></a>01408         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) 
<a name="l01409"></a>01409       <span class="keywordflow">if</span> ( &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a> == mgr_nt) <span class="keywordflow">return</span> stack;
<a name="l01410"></a>01410   
<a name="l01411"></a>01411    <span class="keywordflow">return</span> NULL;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a><a class="code" href="isdn__lib_8c.html#d021ad460dff023747f53b468fd69e6d">01414</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#d021ad460dff023747f53b468fd69e6d">find_bc_by_masked_l3id</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mask)
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416    <span class="keywordtype">int</span> i;
<a name="l01417"></a>01417    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;b_num; i++) {
<a name="l01418"></a>01418       <span class="keywordflow">if</span> ( (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> &amp; mask)  ==  (l3id &amp; mask)) <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i] ;
<a name="l01419"></a>01419    }
<a name="l01420"></a>01420    <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">stack_holder_find</a>(stack,l3id);
<a name="l01421"></a>01421 }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 
<a name="l01424"></a><a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">01424</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426    <span class="keywordtype">int</span> i;
<a name="l01427"></a>01427    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;b_num; i++) {
<a name="l01428"></a>01428       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> == l3id) <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i] ;
<a name="l01429"></a>01429    }
<a name="l01430"></a>01430    <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">stack_holder_find</a>(stack,l3id);
<a name="l01431"></a>01431 }
<a name="l01432"></a>01432 
<a name="l01433"></a><a class="code" href="isdn__lib_8c.html#e3391504d1bf28bfce922ff217c5501e">01433</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#e3391504d1bf28bfce922ff217c5501e">find_bc_holded</a>(<span class="keyword">struct</span> misdn_stack *stack)
<a name="l01434"></a>01434 {
<a name="l01435"></a>01435    <span class="keywordtype">int</span> i;
<a name="l01436"></a>01436    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;b_num; i++) {
<a name="l01437"></a>01437       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#79a2f85be0af6b43c3ad40f2e0476425">holded</a> ) <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i] ;
<a name="l01438"></a>01438    }
<a name="l01439"></a>01439    <span class="keywordflow">return</span> NULL;
<a name="l01440"></a>01440 }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442 
<a name="l01443"></a><a class="code" href="isdn__lib_8c.html#6b5e254f2e3ec79fefb3f55e73a8e84d">01443</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#6b5e254f2e3ec79fefb3f55e73a8e84d">find_bc_by_addr</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>)
<a name="l01444"></a>01444 {
<a name="l01445"></a>01445    <span class="keyword">struct </span>misdn_stack* stack;
<a name="l01446"></a>01446    <span class="keywordtype">int</span> i;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01449"></a>01449         stack;
<a name="l01450"></a>01450         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01451"></a>01451       <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l01452"></a>01452          <span class="keywordflow">if</span> ( (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>&amp;STACK_ID_MASK)==(addr&amp;STACK_ID_MASK) ||  stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>== addr ) {
<a name="l01453"></a>01453             <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l01454"></a>01454          }
<a name="l01455"></a>01455       }
<a name="l01456"></a>01456    }
<a name="l01457"></a>01457    
<a name="l01458"></a>01458    <span class="keywordflow">return</span> NULL;
<a name="l01459"></a>01459 }
<a name="l01460"></a>01460 
<a name="l01461"></a><a class="code" href="isdn__lib_8c.html#23f22efac15e89ad61667a53f6751de9">01461</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#23f22efac15e89ad61667a53f6751de9">find_bc_by_confid</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> confid)
<a name="l01462"></a>01462 {
<a name="l01463"></a>01463    <span class="keyword">struct </span>misdn_stack* stack;
<a name="l01464"></a>01464    <span class="keywordtype">int</span> i;
<a name="l01465"></a>01465    
<a name="l01466"></a>01466    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01467"></a>01467         stack;
<a name="l01468"></a>01468         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01469"></a>01469       <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l01470"></a>01470          <span class="keywordflow">if</span> ( stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>==confid ) {
<a name="l01471"></a>01471             <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l01472"></a>01472          }
<a name="l01473"></a>01473       }
<a name="l01474"></a>01474    }
<a name="l01475"></a>01475    <span class="keywordflow">return</span> NULL;
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478 
<a name="l01479"></a><a class="code" href="isdn__lib_8c.html#0e208b5c73accc8d74541a10b9a7aa0d">01479</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#0e208b5c73accc8d74541a10b9a7aa0d">find_bc_by_channel</a>(<span class="keywordtype">int</span> port, <span class="keywordtype">int</span> channel)
<a name="l01480"></a>01480 {
<a name="l01481"></a>01481    <span class="keyword">struct </span>misdn_stack* stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(port);
<a name="l01482"></a>01482    <span class="keywordtype">int</span> i;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> NULL;   
<a name="l01485"></a>01485    
<a name="l01486"></a>01486    <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l01487"></a>01487       <span class="keywordflow">if</span> ( stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>== channel ) {
<a name="l01488"></a>01488          <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l01489"></a>01489       }
<a name="l01490"></a>01490    }
<a name="l01491"></a>01491       
<a name="l01492"></a>01492    <span class="keywordflow">return</span> NULL;
<a name="l01493"></a>01493 }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 
<a name="l01499"></a><a class="code" href="isdn__lib_8c.html#4e0da69bc45f6776eb978468ecb82d5b">01499</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#4e0da69bc45f6776eb978468ecb82d5b">handle_event</a> ( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0">event_e</a> <a class="code" href="manager_8h.html#4119639092e62c55ea8be348e4d9260d">event</a>, iframe_t *frm)
<a name="l01500"></a>01500 {
<a name="l01501"></a>01501    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l01502"></a>01502    
<a name="l01503"></a>01503    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l01504"></a>01504       
<a name="l01505"></a>01505       <span class="keywordflow">switch</span> (event) {
<a name="l01506"></a>01506 
<a name="l01507"></a>01507       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a090c8fa51958ce4b3abe635d30fa49fdd">EVENT_CONNECT_ACKNOWLEDGE</a>:
<a name="l01508"></a>01508 <span class="preprocessor">#if 0</span>
<a name="l01509"></a>01509 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( !<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l01510"></a>01510             <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l01511"></a>01511             <span class="keywordflow">if</span> (ret == -EINVAL){
<a name="l01512"></a>01512                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_event: setup_bc failed\n"</span>);
<a name="l01513"></a>01513             }
<a name="l01514"></a>01514          }
<a name="l01515"></a>01515 <span class="preprocessor">#endif   </span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>         <span class="keywordflow">break</span>;
<a name="l01517"></a>01517       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a00ce06d6849716e01ba968875c981bec6">EVENT_CONNECT</a>:
<a name="l01518"></a>01518 
<a name="l01519"></a>01519          <span class="keywordflow">if</span> ( *bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a> ) {
<a name="l01520"></a>01520             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"ENABLING BLOWFISH channel:%d oad%d:%s dad%d:%s\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>);
<a name="l01521"></a>01521             <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(bc,  BF_ENABLE_KEY, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a>, strlen(bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a>) );
<a name="l01522"></a>01522          }
<a name="l01523"></a>01523       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0730130c6b666776f7b45d7fc9487309f">EVENT_ALERTING</a>:
<a name="l01524"></a>01524       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a012515a4ed18d8b26df799d6d4a8c9dd2">EVENT_PROGRESS</a>:
<a name="l01525"></a>01525       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a059ec007c5fb3715eb7e491d7f93da013">EVENT_PROCEEDING</a>:
<a name="l01526"></a>01526       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0d3ffe5414469f96e074ef316e43ed11e">EVENT_SETUP_ACKNOWLEDGE</a>:
<a name="l01527"></a>01527 
<a name="l01528"></a>01528       <a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l01529"></a>01529 
<a name="l01530"></a>01530       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a>:
<a name="l01531"></a>01531       {
<a name="l01532"></a>01532          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> == 0xff) {
<a name="l01533"></a>01533             <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(stack, bc, 0, 0)) {
<a name="l01534"></a>01534                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Any Channel Requested, but we have no more!!\n"</span>);
<a name="l01535"></a>01535                bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=34;
<a name="l01536"></a>01536                <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>);
<a name="l01537"></a>01537                <span class="keywordflow">return</span> -1;
<a name="l01538"></a>01538             }
<a name="l01539"></a>01539          } 
<a name="l01540"></a>01540 
<a name="l01541"></a>01541          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> &gt;0 &amp;&amp; bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&lt;255) {
<a name="l01542"></a>01542             <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(stack ,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l01543"></a>01543             <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a> &amp;&amp; ret&lt;0){
<a name="l01544"></a>01544                <span class="comment">/* empty bchannel */</span>
<a name="l01545"></a>01545                bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=0;
<a name="l01546"></a>01546                bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=44;
<a name="l01547"></a>01547                <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>);
<a name="l01548"></a>01548                <span class="keywordflow">return</span> -1;
<a name="l01549"></a>01549             }
<a name="l01550"></a>01550          }
<a name="l01551"></a>01551       }
<a name="l01552"></a>01552       <span class="keywordflow">break</span>;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>:
<a name="l01555"></a>01555       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a08f2f8b0a920df11995fa50b5832adf95">EVENT_RELEASE</a>:
<a name="l01556"></a>01556          <span class="keywordflow">break</span>;
<a name="l01557"></a>01557       <span class="keywordflow">default</span>:
<a name="l01558"></a>01558          <span class="keywordflow">break</span>;
<a name="l01559"></a>01559       }
<a name="l01560"></a>01560    } <span class="keywordflow">else</span> {    <span class="comment">/** NT MODE **/</span>
<a name="l01561"></a>01561       
<a name="l01562"></a>01562    }
<a name="l01563"></a>01563    <span class="keywordflow">return</span> 0;
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01566"></a><a class="code" href="isdn__lib_8c.html#00d6f5656c4b42e852bada50879c8e5d">01566</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#00d6f5656c4b42e852bada50879c8e5d">handle_cr</a> ( <span class="keyword">struct</span> misdn_stack *stack, iframe_t *frm)
<a name="l01567"></a>01567 {
<a name="l01568"></a>01568    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> -1;
<a name="l01569"></a>01569   
<a name="l01570"></a>01570    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l01571"></a>01571    <span class="keywordflow">case</span> CC_NEW_CR|INDICATION:
<a name="l01572"></a>01572       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(7, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; lib: NEW_CR Ind with l3id:%x on this port.\n"</span>,frm-&gt;dinfo);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* bc=<a class="code" href="isdn__lib_8c.html#8f63d05f44b024ef51a4ba958379f952">misdn_lib_get_free_bc</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, 0, 1, 0);
<a name="l01575"></a>01575       <span class="keywordflow">if</span> (!bc) {
<a name="l01576"></a>01576          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; !! lib: No free channel!\n"</span>);
<a name="l01577"></a>01577          <span class="keywordflow">return</span> -1;
<a name="l01578"></a>01578       }
<a name="l01579"></a>01579   
<a name="l01580"></a>01580       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(7, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; new_process: New L3Id: %x\n"</span>,frm-&gt;dinfo);
<a name="l01581"></a>01581       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>=frm-&gt;dinfo;
<a name="l01582"></a>01582       <span class="keywordflow">return</span> 1;
<a name="l01583"></a>01583    <span class="keywordflow">case</span> CC_NEW_CR|CONFIRM:
<a name="l01584"></a>01584       <span class="keywordflow">return</span> 1;
<a name="l01585"></a>01585    <span class="keywordflow">case</span> CC_NEW_CR|REQUEST:
<a name="l01586"></a>01586       <span class="keywordflow">return</span> 1;
<a name="l01587"></a>01587    <span class="keywordflow">case</span> CC_RELEASE_CR|REQUEST:
<a name="l01588"></a>01588       <span class="keywordflow">return</span> 1;
<a name="l01589"></a>01589    <span class="keywordflow">case</span> CC_RELEASE_CR|CONFIRM:
<a name="l01590"></a>01590       <span class="keywordflow">break</span>;
<a name="l01591"></a>01591    <span class="keywordflow">case</span> CC_RELEASE_CR|INDICATION:
<a name="l01592"></a>01592       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; lib: RELEASE_CR Ind with l3id:%x\n"</span>,frm-&gt;dinfo);
<a name="l01593"></a>01593       {
<a name="l01594"></a>01594          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l01595"></a>01595          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l01596"></a>01596       
<a name="l01597"></a>01597          <span class="keywordflow">if</span> (!bc) {
<a name="l01598"></a>01598             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Didn't found BC so temporarly creating dummy BC (l3id:%x) on this port.\n"</span>, frm-&gt;dinfo);
<a name="l01599"></a>01599             memset (&amp;dummybc,0,<span class="keyword">sizeof</span>(dummybc));
<a name="l01600"></a>01600             dummybc.port=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l01601"></a>01601             dummybc.l3_id=frm-&gt;dinfo;
<a name="l01602"></a>01602             dummybc.nt=stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>;
<a name="l01603"></a>01603             bc=&amp;dummybc; 
<a name="l01604"></a>01604          }
<a name="l01605"></a>01605       
<a name="l01606"></a>01606          <span class="keywordflow">if</span> (bc) {
<a name="l01607"></a>01607             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; lib: CLEANING UP l3id: %x\n"</span>,frm-&gt;dinfo);
<a name="l01608"></a>01608             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l01609"></a>01609                <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l01610"></a>01610             
<a name="l01611"></a>01611             <span class="comment">/*bc-&gt;pid = 0;*/</span>
<a name="l01612"></a>01612             bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>=0;
<a name="l01613"></a>01613             bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5a8b44790d4813eec564aff11c8b4a5">need_release</a>=0;
<a name="l01614"></a>01614             bc-&gt;<a class="code" href="structmisdn__bchannel.html#3a50d8b05555100483c89a96ba1598ee">need_release_complete</a>=0;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616             <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0adbb5302858f0ca23b9552f9a5402d26">EVENT_CLEANUP</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01617"></a>01617 
<a name="l01618"></a>01618             <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l01619"></a>01619             <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l01620"></a>01620             <a class="code" href="isdn__lib_8c.html#328bc90d4ff67e00677d05f7d08867ea">dump_chan_list</a>(stack);
<a name="l01621"></a>01621 
<a name="l01622"></a>01622             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5a923a709935aea970aef19dde643058">stack_holder</a>) {
<a name="l01623"></a>01623                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"REMOVEING Holder\n"</span>);
<a name="l01624"></a>01624                <a class="code" href="isdn__lib_8c.html#8f698ed84747c21748f7bfae5b539991">stack_holder_remove</a>( stack, bc);
<a name="l01625"></a>01625                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(bc);
<a name="l01626"></a>01626             }
<a name="l01627"></a>01627          }
<a name="l01628"></a>01628          <span class="keywordflow">else</span> {
<a name="l01629"></a>01629             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) 
<a name="l01630"></a>01630                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BC with dinfo: %x  not found.. (prim was %x and addr %x)\n"</span>,frm-&gt;dinfo, frm-&gt;prim, frm-&gt;addr);
<a name="l01631"></a>01631          }
<a name="l01632"></a>01632       
<a name="l01633"></a>01633          <span class="keywordflow">return</span> 1;
<a name="l01634"></a>01634       }
<a name="l01635"></a>01635       <span class="keywordflow">break</span>;
<a name="l01636"></a>01636    }
<a name="l01637"></a>01637   
<a name="l01638"></a>01638    <span class="keywordflow">return</span> 0;
<a name="l01639"></a>01639 }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641 
<a name="l01642"></a>01642 <span class="comment">/*Emptys bc if it's reserved (no SETUP out yet)*/</span>
<a name="l01643"></a><a class="code" href="isdn__lib_8h.html#09d54f43ccc6068437e95043ac48c6db">01643</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#09d54f43ccc6068437e95043ac48c6db">misdn_lib_release</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l01644"></a>01644 {
<a name="l01645"></a>01645    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647    <span class="keywordflow">if</span> (!stack) {
<a name="l01648"></a>01648       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,0,<span class="stringliteral">"misdn_release: No Stack found\n"</span>);
<a name="l01649"></a>01649       <span class="keywordflow">return</span>;
<a name="l01650"></a>01650    }
<a name="l01651"></a>01651    
<a name="l01652"></a>01652    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0) {
<a name="l01653"></a>01653       <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l01654"></a>01654    }
<a name="l01655"></a>01655    <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l01656"></a>01656    <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l01657"></a>01657 }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 
<a name="l01662"></a><a class="code" href="isdn__lib_8h.html#0440aec671174546642679f9f7aa6edb">01662</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#0440aec671174546642679f9f7aa6edb">misdn_lib_get_port_up</a> (<span class="keywordtype">int</span> port) 
<a name="l01663"></a>01663 { <span class="comment">/* Pull Up L1 */</span> 
<a name="l01664"></a>01664    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01665"></a>01665    
<a name="l01666"></a>01666    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01667"></a>01667         stack;
<a name="l01668"></a>01668         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01669"></a>01669       
<a name="l01670"></a>01670       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l01671"></a>01671 
<a name="l01672"></a>01672          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>)
<a name="l01673"></a>01673             <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l01674"></a>01674          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>)
<a name="l01675"></a>01675             <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack);
<a name="l01676"></a>01676          
<a name="l01677"></a>01677          <span class="keywordflow">return</span> 0;
<a name="l01678"></a>01678       }
<a name="l01679"></a>01679    }
<a name="l01680"></a>01680    <span class="keywordflow">return</span> 0;
<a name="l01681"></a>01681 }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683 
<a name="l01684"></a><a class="code" href="isdn__lib_8h.html#a7a65ea58b45a5dfed2d954a15faaed6">01684</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#a7a65ea58b45a5dfed2d954a15faaed6">misdn_lib_get_port_down</a> (<span class="keywordtype">int</span> port) 
<a name="l01685"></a>01685 { <span class="comment">/* Pull Down L1 */</span> 
<a name="l01686"></a>01686    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01687"></a>01687    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01688"></a>01688         stack;
<a name="l01689"></a>01689         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01690"></a>01690       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l01691"></a>01691             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>)
<a name="l01692"></a>01692                <a class="code" href="isdn__lib_8c.html#39f783ae77a77d141f283894e89a6037">misdn_lib_get_l2_down</a>(stack);
<a name="l01693"></a>01693             <a class="code" href="isdn__lib_8c.html#ac82279245a38de1dc36244d9bc86b95">misdn_lib_get_l1_down</a>(stack);
<a name="l01694"></a>01694          <span class="keywordflow">return</span> 0;
<a name="l01695"></a>01695       }
<a name="l01696"></a>01696    }
<a name="l01697"></a>01697    <span class="keywordflow">return</span> 0;
<a name="l01698"></a>01698 }
<a name="l01699"></a>01699 
<a name="l01700"></a><a class="code" href="isdn__lib_8h.html#c6b7faf9de296eb2c4e3dc22417ec10e">01700</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#c10f78b4f50e3e8769053ba0f071cf94">misdn_lib_port_up</a>(<span class="keywordtype">int</span> port, <span class="keywordtype">int</span> check)
<a name="l01701"></a>01701 {
<a name="l01702"></a>01702    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704 
<a name="l01705"></a>01705    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l01706"></a>01706         stack;
<a name="l01707"></a>01707         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01708"></a>01708       
<a name="l01709"></a>01709       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l01710"></a>01710 
<a name="l01711"></a>01711          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>) {
<a name="l01712"></a>01712             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port, <span class="stringliteral">"Port Blocked:%d L2:%d L1:%d\n"</span>, stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>);
<a name="l01713"></a>01713             <span class="keywordflow">return</span> -1;
<a name="l01714"></a>01714          }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> ) {
<a name="l01717"></a>01717 
<a name="l01718"></a>01718             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>) {
<a name="l01719"></a>01719                <span class="keywordflow">return</span> 1;
<a name="l01720"></a>01720             } <span class="keywordflow">else</span> {
<a name="l01721"></a>01721                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,port, <span class="stringliteral">"Port Down L2:%d L1:%d\n"</span>,
<a name="l01722"></a>01722                   stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>);
<a name="l01723"></a>01723                <span class="keywordflow">return</span> 0;
<a name="l01724"></a>01724             }
<a name="l01725"></a>01725          } <span class="keywordflow">else</span> {
<a name="l01726"></a>01726             <span class="keywordflow">if</span> ( !check || stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a> )
<a name="l01727"></a>01727                <span class="keywordflow">return</span> 1;
<a name="l01728"></a>01728             <span class="keywordflow">else</span> {
<a name="l01729"></a>01729                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,port, <span class="stringliteral">"Port down PMP\n"</span>);
<a name="l01730"></a>01730                <span class="keywordflow">return</span> 0;
<a name="l01731"></a>01731             }
<a name="l01732"></a>01732          }
<a name="l01733"></a>01733       }
<a name="l01734"></a>01734    }
<a name="l01735"></a>01735   
<a name="l01736"></a>01736    <span class="keywordflow">return</span> -1;
<a name="l01737"></a>01737 }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739 
<a name="l01740"></a>01740 <span class="keywordtype">int</span>
<a name="l01741"></a><a class="code" href="isdn__lib_8c.html#aedaecc9b13dea611f886e4f0b32db0f">01741</a> <a class="code" href="isdn__lib_8c.html#aedaecc9b13dea611f886e4f0b32db0f">handle_event_nt</a>(<span class="keywordtype">void</span> *dat, <span class="keywordtype">void</span> *arg)
<a name="l01742"></a>01742 {
<a name="l01743"></a>01743    manager_t *<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a> = (manager_t *)dat;
<a name="l01744"></a>01744    msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a> = (msg_t *)arg;
<a name="l01745"></a>01745    mISDNuser_head_t *hh;
<a name="l01746"></a>01746    <span class="keywordtype">int</span> reject=0;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#1f14600ce56c46d748500b119238cda1">find_stack_by_mgr</a>(mgr);
<a name="l01749"></a>01749    <span class="keywordtype">int</span> port;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751    <span class="keywordflow">if</span> (!<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a> || !mgr)
<a name="l01752"></a>01752       <span class="keywordflow">return</span>(-EINVAL);
<a name="l01753"></a>01753 
<a name="l01754"></a>01754    hh=(mISDNuser_head_t*)<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l01755"></a>01755    port=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l01756"></a>01756    
<a name="l01757"></a>01757    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; lib: prim %x dinfo %x\n"</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l01758"></a>01758    {
<a name="l01759"></a>01759       <span class="keywordflow">switch</span>(hh-&gt;prim){
<a name="l01760"></a>01760       <span class="keywordflow">case</span> CC_RETRIEVE|INDICATION:
<a name="l01761"></a>01761       {
<a name="l01762"></a>01762          iframe_t frm; <span class="comment">/* fake te frm to add callref to global callreflist */</span>
<a name="l01763"></a>01763          frm.dinfo = hh-&gt;dinfo;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765          frm.addr=stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767          frm.prim = CC_NEW_CR|INDICATION;
<a name="l01768"></a>01768          
<a name="l01769"></a>01769          if (<a class="code" href="isdn__lib_8c.html#00d6f5656c4b42e852bada50879c8e5d">handle_cr</a>( stack, &amp;frm)&lt; 0) {
<a name="l01770"></a>01770             msg_t *dmsg;
<a name="l01771"></a>01771             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">"Patch from MEIDANIS:Sending RELEASE_COMPLETE %x (No free Chan for you..)\n"</span>, hh-&gt;dinfo);
<a name="l01772"></a>01772             dmsg = <a class="code" href="isdn__lib_8c.html#2ffacfd0c06efa0ba96eb8b7af5a9e0c">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01773"></a>01773             stack-&gt;nst.manager_l3(&amp;stack-&gt;nst, dmsg);
<a name="l01774"></a>01774             free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01775"></a>01775             <span class="keywordflow">return</span> 0;
<a name="l01776"></a>01776          }
<a name="l01777"></a>01777          
<a name="l01778"></a>01778          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01779"></a>01779          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *hold_bc=<a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">stack_holder_find</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>);
<a name="l01780"></a>01780          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">"bc_l3id:%x holded_bc_l3id:%x\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>, hold_bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>);
<a name="l01781"></a>01781 
<a name="l01782"></a>01782          <span class="keywordflow">if</span> (hold_bc) {
<a name="l01783"></a>01783             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;port, <span class="stringliteral">"REMOVEING Holder\n"</span>);
<a name="l01784"></a>01784 
<a name="l01785"></a>01785             <span class="comment">/*swap the backup to our new channel back*/</span>
<a name="l01786"></a>01786             <a class="code" href="isdn__lib_8c.html#8f698ed84747c21748f7bfae5b539991">stack_holder_remove</a>(stack, hold_bc);
<a name="l01787"></a>01787             memcpy(bc,hold_bc,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l01788"></a>01788             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(hold_bc);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790             bc-&gt;<a class="code" href="structmisdn__bchannel.html#79a2f85be0af6b43c3ad40f2e0476425">holded</a>=0;
<a name="l01791"></a>01791          }
<a name="l01792"></a>01792          
<a name="l01793"></a>01793       }
<a name="l01794"></a>01794          
<a name="l01795"></a>01795          <span class="keywordflow">break</span>;
<a name="l01796"></a>01796          
<a name="l01797"></a>01797       <span class="keywordflow">case</span> CC_SETUP|CONFIRM:
<a name="l01798"></a>01798       {
<a name="l01799"></a>01799          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01800"></a>01800          <span class="keywordtype">int</span> l3id = *((<span class="keywordtype">int</span> *)(((u_char *)<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)+ <a class="code" href="isdn__lib__intern_8h.html#42bafedf42f2f506b996e9f4215645ce">mISDNUSER_HEAD_SIZE</a>));
<a name="l01801"></a>01801          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; lib: Event_ind:SETUP CONFIRM [NT] : new L3ID  is %x\n"</span>,l3id );
<a name="l01802"></a>01802    
<a name="l01803"></a>01803          <span class="keywordflow">if</span> (!bc) { <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Bc Not found (after SETUP CONFIRM)\n"</span>); <span class="keywordflow">return</span> 0; }
<a name="l01804"></a>01804          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (2,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"I IND :CC_SETUP|CONFIRM: old l3id:%x new l3id:%x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>, l3id);
<a name="l01805"></a>01805          bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>=l3id;
<a name="l01806"></a>01806          <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a05ec9f5e772c7998db50415321231aaad">EVENT_NEW_L3ID</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01807"></a>01807       }
<a name="l01808"></a>01808       free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01809"></a>01809       <span class="keywordflow">return</span> 0;
<a name="l01810"></a>01810       
<a name="l01811"></a>01811       <span class="keywordflow">case</span> CC_SETUP|INDICATION:
<a name="l01812"></a>01812       {
<a name="l01813"></a>01813          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* bc=<a class="code" href="isdn__lib_8c.html#8f63d05f44b024ef51a4ba958379f952">misdn_lib_get_free_bc</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, 0, 1, 0);
<a name="l01814"></a>01814          <span class="keywordflow">if</span> (!bc) 
<a name="l01815"></a>01815          ERR_NO_CHANNEL:
<a name="l01816"></a>01816          {
<a name="l01817"></a>01817             msg_t *dmsg;
<a name="l01818"></a>01818             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Patch from MEIDANIS:Sending RELEASE_COMPLETE %x (No free Chan for you..)\n"</span>, hh-&gt;dinfo);
<a name="l01819"></a>01819             dmsg = <a class="code" href="isdn__lib_8c.html#2ffacfd0c06efa0ba96eb8b7af5a9e0c">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01820"></a>01820             stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, dmsg);
<a name="l01821"></a>01821             free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01822"></a>01822             <span class="keywordflow">return</span> 0;
<a name="l01823"></a>01823          }
<a name="l01824"></a>01824   
<a name="l01825"></a>01825          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; new_process: New L3Id: %x\n"</span>,hh-&gt;dinfo);
<a name="l01826"></a>01826          bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>=hh-&gt;dinfo;
<a name="l01827"></a>01827       }
<a name="l01828"></a>01828       <span class="keywordflow">break</span>;
<a name="l01829"></a>01829 
<a name="l01830"></a>01830       <span class="keywordflow">case</span> CC_CONNECT_ACKNOWLEDGE|INDICATION:
<a name="l01831"></a>01831 <span class="preprocessor">#if 0</span>
<a name="l01832"></a>01832 <span class="preprocessor"></span>      {
<a name="l01833"></a>01833          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01834"></a>01834          <span class="keywordflow">if</span> (bc) {
<a name="l01835"></a>01835             <span class="keywordflow">if</span> ( !<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l01836"></a>01836                <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l01837"></a>01837                <span class="keywordflow">if</span> (ret == -EINVAL){
<a name="l01838"></a>01838                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_event: setup_bc failed\n"</span>);
<a name="l01839"></a>01839                   
<a name="l01840"></a>01840                }
<a name="l01841"></a>01841             }
<a name="l01842"></a>01842          }
<a name="l01843"></a>01843       }
<a name="l01844"></a>01844 <span class="preprocessor">#endif</span>
<a name="l01845"></a>01845 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
<a name="l01846"></a>01846       
<a name="l01847"></a>01847       <span class="keywordflow">case</span> CC_ALERTING|INDICATION:
<a name="l01848"></a>01848       <span class="keywordflow">case</span> CC_PROCEEDING|INDICATION:
<a name="l01849"></a>01849       <span class="keywordflow">case</span> CC_SETUP_ACKNOWLEDGE|INDICATION:
<a name="l01850"></a>01850          <span class="keywordflow">if</span>(!stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>) <span class="keywordflow">break</span>;  
<a name="l01851"></a>01851       <span class="keywordflow">case</span> CC_CONNECT|INDICATION:
<a name="l01852"></a>01852       {
<a name="l01853"></a>01853 #<span class="keywordflow">if</span> 0
<a name="l01854"></a>01854          <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01855"></a>01855          
<a name="l01856"></a>01856          <span class="keywordflow">if</span> (!bc) {
<a name="l01857"></a>01857             msg_t *dmsg;
<a name="l01858"></a>01858             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"!!!! We didn't found our bc, dinfo:%x on this port.\n"</span>,hh-&gt;dinfo);
<a name="l01859"></a>01859             
<a name="l01860"></a>01860             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Releaseing call %x (No free Chan for you..)\n"</span>, hh-&gt;dinfo);
<a name="l01861"></a>01861             dmsg = <a class="code" href="isdn__lib_8c.html#2ffacfd0c06efa0ba96eb8b7af5a9e0c">create_l3msg</a>(CC_RELEASE_COMPLETE | REQUEST,MT_RELEASE_COMPLETE, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01862"></a>01862             stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, dmsg);
<a name="l01863"></a>01863             free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01864"></a>01864             <span class="keywordflow">return</span> 0;
<a name="l01865"></a>01865             
<a name="l01866"></a>01866          }
<a name="l01867"></a>01867          <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l01868"></a>01868          <span class="keywordflow">if</span> (ret == -EINVAL){
<a name="l01869"></a>01869             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"handle_event_nt: setup_bc failed\n"</span>);
<a name="l01870"></a>01870             <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>);
<a name="l01871"></a>01871          }
<a name="l01872"></a>01872 <span class="preprocessor">#endif</span>
<a name="l01873"></a>01873 <span class="preprocessor"></span>      }
<a name="l01874"></a>01874       <span class="keywordflow">break</span>;
<a name="l01875"></a>01875       <span class="keywordflow">case</span> CC_DISCONNECT|INDICATION:
<a name="l01876"></a>01876       {
<a name="l01877"></a>01877          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01878"></a>01878          <span class="keywordflow">if</span> (!bc) {
<a name="l01879"></a>01879             bc=<a class="code" href="isdn__lib_8c.html#d021ad460dff023747f53b468fd69e6d">find_bc_by_masked_l3id</a>(stack, hh-&gt;dinfo, 0xffff0000);
<a name="l01880"></a>01880             <span class="keywordflow">if</span> (bc) { 
<a name="l01881"></a>01881                <span class="keywordtype">int</span> myprocid=bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0x0000ffff;
<a name="l01882"></a>01882                hh-&gt;dinfo=(hh-&gt;dinfo&amp;0xffff0000)|myprocid;
<a name="l01883"></a>01883                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"Reject dinfo: %x cause:%d\n"</span>,hh-&gt;dinfo,bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>);
<a name="l01884"></a>01884                reject=1;      
<a name="l01885"></a>01885             }
<a name="l01886"></a>01886          }
<a name="l01887"></a>01887       }
<a name="l01888"></a>01888       <span class="keywordflow">break</span>;
<a name="l01889"></a>01889       
<a name="l01890"></a>01890       <span class="keywordflow">case</span> CC_FACILITY|INDICATION:
<a name="l01891"></a>01891       {
<a name="l01892"></a>01892          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01893"></a>01893          <span class="keywordflow">if</span> (!bc) {
<a name="l01894"></a>01894             bc=<a class="code" href="isdn__lib_8c.html#d021ad460dff023747f53b468fd69e6d">find_bc_by_masked_l3id</a>(stack, hh-&gt;dinfo, 0xffff0000);
<a name="l01895"></a>01895             <span class="keywordflow">if</span> (bc) { 
<a name="l01896"></a>01896                <span class="keywordtype">int</span> myprocid=bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0x0000ffff;
<a name="l01897"></a>01897                hh-&gt;dinfo=(hh-&gt;dinfo&amp;0xffff0000)|myprocid;
<a name="l01898"></a>01898                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"Repaired reject Bug, new dinfo: %x\n"</span>,hh-&gt;dinfo);
<a name="l01899"></a>01899             }
<a name="l01900"></a>01900          }
<a name="l01901"></a>01901       }
<a name="l01902"></a>01902       <span class="keywordflow">break</span>;
<a name="l01903"></a>01903       
<a name="l01904"></a>01904       <span class="keywordflow">case</span> CC_RELEASE_COMPLETE|INDICATION:
<a name="l01905"></a>01905          <span class="keywordflow">break</span>;
<a name="l01906"></a>01906 
<a name="l01907"></a>01907       <span class="keywordflow">case</span> CC_SUSPEND|INDICATION:
<a name="l01908"></a>01908       {
<a name="l01909"></a>01909          msg_t *dmsg;
<a name="l01910"></a>01910          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Got Suspend, sending Reject for now\n"</span>);
<a name="l01911"></a>01911          dmsg = <a class="code" href="isdn__lib_8c.html#2ffacfd0c06efa0ba96eb8b7af5a9e0c">create_l3msg</a>(CC_SUSPEND_REJECT | REQUEST,MT_SUSPEND_REJECT, hh-&gt;dinfo,<span class="keyword">sizeof</span>(RELEASE_COMPLETE_t), 1);
<a name="l01912"></a>01912          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, dmsg);
<a name="l01913"></a>01913          free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01914"></a>01914          <span class="keywordflow">return</span> 0;
<a name="l01915"></a>01915       }
<a name="l01916"></a>01916       <span class="keywordflow">break</span>;
<a name="l01917"></a>01917       <span class="keywordflow">case</span> CC_RESUME|INDICATION:
<a name="l01918"></a>01918          <span class="keywordflow">break</span>;
<a name="l01919"></a>01919 
<a name="l01920"></a>01920       <span class="keywordflow">case</span> CC_RELEASE|CONFIRM:
<a name="l01921"></a>01921          <span class="keywordflow">break</span>;
<a name="l01922"></a>01922          
<a name="l01923"></a>01923       <span class="keywordflow">case</span> CC_RELEASE|INDICATION:
<a name="l01924"></a>01924          <span class="keywordflow">break</span>;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926       <span class="keywordflow">case</span> CC_RELEASE_CR|INDICATION:
<a name="l01927"></a>01927       {
<a name="l01928"></a>01928          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01929"></a>01929          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l01930"></a>01930          iframe_t frm; <span class="comment">/* fake te frm to remove callref from global callreflist */</span>
<a name="l01931"></a>01931          frm.dinfo = hh-&gt;dinfo;
<a name="l01932"></a>01932 
<a name="l01933"></a>01933          frm.<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN;
<a name="l01934"></a>01934 
<a name="l01935"></a>01935          frm.prim = CC_RELEASE_CR|INDICATION;
<a name="l01936"></a>01936          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Faking Realease_cr for %x\n"</span>,frm.addr);<span class="comment"></span>
<a name="l01937"></a>01937 <span class="comment">         /** removing procid **/</span>
<a name="l01938"></a>01938          <span class="keywordflow">if</span> (!bc) {
<a name="l01939"></a>01939             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Didn't found BC so temporarly creating dummy BC (l3id:%x) on this port.\n"</span>, hh-&gt;dinfo);
<a name="l01940"></a>01940             memset (&amp;dummybc,0,<span class="keyword">sizeof</span>(dummybc));
<a name="l01941"></a>01941             dummybc.<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l01942"></a>01942             dummybc.<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>=hh-&gt;dinfo;
<a name="l01943"></a>01943             dummybc.<a class="code" href="structmisdn__bchannel.html#25930e3036f13852cb0b29694bbab611">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>;
<a name="l01944"></a>01944             bc=&amp;dummybc; 
<a name="l01945"></a>01945          }
<a name="l01946"></a>01946    
<a name="l01947"></a>01947          <span class="keywordflow">if</span> (bc) {
<a name="l01948"></a>01948             <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> &amp; 0xff00) == 0xff00) {
<a name="l01949"></a>01949                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Removing Process Id:%x on this port.\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0xff);
<a name="l01950"></a>01950                stack-&gt;<a class="code" href="structmisdn__stack.html#b0f6d00925afa4230624e7354414e53f">procids</a>[bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0xff] = 0 ;
<a name="l01951"></a>01951             }
<a name="l01952"></a>01952          }
<a name="l01953"></a>01953          <span class="keywordflow">else</span> <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Couldnt find BC so I couldnt remove the Process!!!! this is a bad port.\n"</span>);
<a name="l01954"></a>01954    
<a name="l01955"></a>01955          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#00d6f5656c4b42e852bada50879c8e5d">handle_cr</a>(stack, &amp;frm)&lt;0) {
<a name="l01956"></a>01956          }
<a name="l01957"></a>01957 
<a name="l01958"></a>01958          free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01959"></a>01959          <span class="keywordflow">return</span> 0 ;
<a name="l01960"></a>01960       }
<a name="l01961"></a>01961       <span class="keywordflow">break</span>;
<a name="l01962"></a>01962       
<a name="l01963"></a>01963       <span class="keywordflow">case</span> CC_NEW_CR|INDICATION:
<a name="l01964"></a>01964          <span class="comment">/*  Got New CR for bchan, for now I handle this one in */</span>
<a name="l01965"></a>01965          <span class="comment">/*  connect_ack, Need to be changed */</span>
<a name="l01966"></a>01966       {
<a name="l01967"></a>01967          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l01968"></a>01968          <span class="keywordtype">int</span> l3id = *((<span class="keywordtype">int</span> *)(((u_char *)<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)+ <a class="code" href="isdn__lib__intern_8h.html#42bafedf42f2f506b996e9f4215645ce">mISDNUSER_HEAD_SIZE</a>));
<a name="l01969"></a>01969          <span class="keywordflow">if</span> (!bc) { <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; In NEW_CR: didn't found bc ??\n"</span>); <span class="keywordflow">return</span> -1;};
<a name="l01970"></a>01970          <span class="keywordflow">if</span> (((l3id&amp;0xff00)!=0xff00) &amp;&amp; ((bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0xff00)==0xff00)) {
<a name="l01971"></a>01971             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Removing Process Id:%x on this port.\n"</span>, 0xff&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>);
<a name="l01972"></a>01972             stack-&gt;<a class="code" href="structmisdn__stack.html#b0f6d00925afa4230624e7354414e53f">procids</a>[bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>&amp;0xff] = 0 ;
<a name="l01973"></a>01973          }
<a name="l01974"></a>01974          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"lib: Event_ind:CC_NEW_CR : very new L3ID  is %x\n"</span>,l3id );
<a name="l01975"></a>01975    
<a name="l01976"></a>01976          bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> =l3id;
<a name="l01977"></a>01977          <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a05ec9f5e772c7998db50415321231aaad">EVENT_NEW_L3ID</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01978"></a>01978    
<a name="l01979"></a>01979          free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01980"></a>01980          <span class="keywordflow">return</span> 0;
<a name="l01981"></a>01981       }
<a name="l01982"></a>01982       
<a name="l01983"></a>01983       <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l01984"></a>01984       <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l01985"></a>01985       {
<a name="l01986"></a>01986          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"%% GOT L2 Activate Info.\n"</span>);
<a name="l01987"></a>01987          
<a name="l01988"></a>01988          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>) {
<a name="l01989"></a>01989             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"%% GOT L2 Activate Info. but we're activated already.. this l2 is faulty, blocking port\n"</span>);
<a name="l01990"></a>01990             <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a05b30790092043cd946ec3ae1aee2afee">EVENT_PORT_ALARM</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[0], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l01991"></a>01991          }
<a name="l01992"></a>01992          
<a name="l01993"></a>01993          stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a> = 1;
<a name="l01994"></a>01994          stack-&gt;<a class="code" href="structmisdn__stack.html#fea3ef778706ecea79c7888ae53f59b2">l2upcnt</a>=0;
<a name="l01995"></a>01995          
<a name="l01996"></a>01996          free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l01997"></a>01997          <span class="keywordflow">return</span> 0;
<a name="l01998"></a>01998       }
<a name="l01999"></a>01999       <span class="keywordflow">break</span>;
<a name="l02000"></a>02000 
<a name="l02001"></a>02001 
<a name="l02002"></a>02002       <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02003"></a>02003       <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02004"></a>02004       {
<a name="l02005"></a>02005          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>) {
<a name="l02006"></a>02006             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3 , stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"%% GOT L2 DeActivate Info.\n"</span>);
<a name="l02007"></a>02007 
<a name="l02008"></a>02008             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#fea3ef778706ecea79c7888ae53f59b2">l2upcnt</a>&gt;3) {
<a name="l02009"></a>02009                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0 , stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"!!! Could not Get the L2 up after 3 Attemps!!!\n"</span>);
<a name="l02010"></a>02010             }  <span class="keywordflow">else</span> {
<a name="l02011"></a>02011 <span class="preprocessor">#if 0</span>
<a name="l02012"></a>02012 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) <a class="code" href="isdn__lib_8c.html#10fa56086895bc30c7c9f197ee9c117e">misdn_lib_reinit_nt_stack</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>);
<a name="l02013"></a>02013 <span class="preprocessor">#endif</span>
<a name="l02014"></a>02014 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>) {
<a name="l02015"></a>02015                   <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack);
<a name="l02016"></a>02016                   stack-&gt;<a class="code" href="structmisdn__stack.html#fea3ef778706ecea79c7888ae53f59b2">l2upcnt</a>++;
<a name="l02017"></a>02017                }
<a name="l02018"></a>02018             }
<a name="l02019"></a>02019             
<a name="l02020"></a>02020          } <span class="keywordflow">else</span> 
<a name="l02021"></a>02021             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"%% GOT L2 DeActivate Info.\n"</span>);
<a name="l02022"></a>02022          
<a name="l02023"></a>02023          stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a> = 0;
<a name="l02024"></a>02024          free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l02025"></a>02025          <span class="keywordflow">return</span> 0;
<a name="l02026"></a>02026       }
<a name="l02027"></a>02027       <span class="keywordflow">break</span>;
<a name="l02028"></a>02028       }
<a name="l02029"></a>02029    }
<a name="l02030"></a>02030    
<a name="l02031"></a>02031    {
<a name="l02032"></a>02032       <span class="comment">/*  Parse Events and fire_up to App. */</span>
<a name="l02033"></a>02033       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l02034"></a>02034       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l02035"></a>02035       
<a name="l02036"></a>02036       <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0">event_e</a> <a class="code" href="manager_8h.html#4119639092e62c55ea8be348e4d9260d">event</a> = <a class="code" href="isdn__lib__intern_8h.html#9a4f7077635592f6e00223f6e95ff263">isdn_msg_get_event</a>(msgs_g, <a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>, 1);
<a name="l02037"></a>02037     
<a name="l02038"></a>02038       bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, hh-&gt;dinfo);
<a name="l02039"></a>02039     
<a name="l02040"></a>02040       <span class="keywordflow">if</span> (!bc) {
<a name="l02041"></a>02041       
<a name="l02042"></a>02042          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Didn't found BC so temporarly creating dummy BC (l3id:%x).\n"</span>, hh-&gt;dinfo);
<a name="l02043"></a>02043          memset (&amp;dummybc,0,<span class="keyword">sizeof</span>(dummybc));
<a name="l02044"></a>02044          dummybc.<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l02045"></a>02045          dummybc.<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>=hh-&gt;dinfo;
<a name="l02046"></a>02046          dummybc.<a class="code" href="structmisdn__bchannel.html#25930e3036f13852cb0b29694bbab611">nt</a>=stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>;
<a name="l02047"></a>02047          bc=&amp;dummybc; 
<a name="l02048"></a>02048       }
<a name="l02049"></a>02049       <span class="keywordflow">if</span> (bc ) {
<a name="l02050"></a>02050          <a class="code" href="isdn__lib__intern_8h.html#46f23b8b8004605130f76eb9324b4f68">isdn_msg_parse_event</a>(msgs_g,<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>,bc, 1);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052          <span class="keywordflow">switch</span> (event) {
<a name="l02053"></a>02053             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a>:
<a name="l02054"></a>02054                <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&lt;=0 || bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>==0xff) {
<a name="l02055"></a>02055                   bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=<a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(stack,bc, 0,0);
<a name="l02056"></a>02056                   <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&lt;=0)
<a name="l02057"></a>02057                      <span class="keywordflow">goto</span> ERR_NO_CHANNEL;
<a name="l02058"></a>02058                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>) 
<a name="l02059"></a>02059                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; PTMP but channel requested\n"</span>); 
<a name="l02060"></a>02060 
<a name="l02061"></a>02061                <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l02062"></a>02062                <span class="keywordflow">if</span> (event==<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a> &amp;&amp; ret&lt;0){
<a name="l02063"></a>02063                   <span class="comment">/* empty bchannel */</span>
<a name="l02064"></a>02064                   bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>=0;
<a name="l02065"></a>02065                   bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=44;
<a name="l02066"></a>02066 
<a name="l02067"></a>02067                   <span class="keywordflow">goto</span> ERR_NO_CHANNEL;
<a name="l02068"></a>02068                } 
<a name="l02069"></a>02069                <span class="keywordflow">break</span>;
<a name="l02070"></a>02070             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a08f2f8b0a920df11995fa50b5832adf95">EVENT_RELEASE</a>:
<a name="l02071"></a>02071             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>:
<a name="l02072"></a>02072                <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l02073"></a>02073                                  <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l02074"></a>02074                <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>; 
<a name="l02075"></a>02075                          <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l02076"></a>02076                bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>=tmpcause;
<a name="l02077"></a>02077                <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l02078"></a>02078                <span class="keywordflow">break</span>;
<a name="l02079"></a>02079 
<a name="l02080"></a>02080             <span class="keywordflow">default</span>:
<a name="l02081"></a>02081             <span class="keywordflow">break</span>;
<a name="l02082"></a>02082          }
<a name="l02083"></a>02083          
<a name="l02084"></a>02084          <span class="keywordflow">if</span>(!<a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g,event,1)) {
<a name="l02085"></a>02085             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Unknown Event Ind: prim %x dinfo %x\n"</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l02086"></a>02086          } <span class="keywordflow">else</span> {
<a name="l02087"></a>02087             <span class="keywordflow">if</span> (reject) {
<a name="l02088"></a>02088                <span class="keywordflow">switch</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>){
<a name="l02089"></a>02089                   <span class="keywordflow">case</span> 17:
<a name="l02090"></a>02090                      <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Siemens Busy reject..\n"</span>);
<a name="l02091"></a>02091 
<a name="l02092"></a>02092                      <span class="keywordflow">break</span>;
<a name="l02093"></a>02093                   <span class="keywordflow">default</span>:
<a name="l02094"></a>02094                      <span class="keywordflow">break</span>;
<a name="l02095"></a>02095                }
<a name="l02096"></a>02096             }
<a name="l02097"></a>02097             <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(event, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02098"></a>02098          }
<a name="l02099"></a>02099       
<a name="l02100"></a>02100       } <span class="keywordflow">else</span> {
<a name="l02101"></a>02101          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"No BC found with l3id: prim %x dinfo %x\n"</span>,hh-&gt;prim, hh-&gt;dinfo);
<a name="l02102"></a>02102       }
<a name="l02103"></a>02103 
<a name="l02104"></a>02104       free_msg(<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l02105"></a>02105    }
<a name="l02106"></a>02106 
<a name="l02107"></a>02107 
<a name="l02108"></a>02108    <span class="keywordflow">return</span> 0;
<a name="l02109"></a>02109 }
<a name="l02110"></a>02110 
<a name="l02111"></a>02111 
<a name="l02112"></a><a class="code" href="isdn__lib_8c.html#7e63ba92d5300eae12f270755bcb45db">02112</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#7e63ba92d5300eae12f270755bcb45db">handle_timers</a>(msg_t* <a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02113"></a>02113 {
<a name="l02114"></a>02114    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02115"></a>02115    <span class="keyword">struct</span> misdn_stack *stack; 
<a name="l02116"></a>02116   
<a name="l02117"></a>02117    <span class="comment">/* Timer Stuff */</span>
<a name="l02118"></a>02118    switch (frm-&gt;prim) {
<a name="l02119"></a>02119    <span class="keywordflow">case</span> MGR_INITTIMER | CONFIRM:
<a name="l02120"></a>02120    <span class="keywordflow">case</span> MGR_ADDTIMER | CONFIRM:
<a name="l02121"></a>02121    <span class="keywordflow">case</span> MGR_DELTIMER | CONFIRM:
<a name="l02122"></a>02122    <span class="keywordflow">case</span> MGR_REMOVETIMER | CONFIRM:
<a name="l02123"></a>02123       free_msg(msg);
<a name="l02124"></a>02124       <span class="keywordflow">return</span>(1);
<a name="l02125"></a>02125    }
<a name="l02126"></a>02126   
<a name="l02127"></a>02127   
<a name="l02128"></a>02128   
<a name="l02129"></a>02129    <span class="keywordflow">if</span> (frm-&gt;prim==(MGR_TIMER | INDICATION) ) {
<a name="l02130"></a>02130       <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l02131"></a>02131            stack;
<a name="l02132"></a>02132            stack = stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02133"></a>02133          itimer_t *it;
<a name="l02134"></a>02134       
<a name="l02135"></a>02135          <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) <span class="keywordflow">continue</span>;
<a name="l02136"></a>02136       
<a name="l02137"></a>02137          it = stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.tlist;
<a name="l02138"></a>02138          <span class="comment">/* find timer */</span>
<a name="l02139"></a>02139          <span class="keywordflow">for</span>(it=stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.tlist;
<a name="l02140"></a>02140              it;
<a name="l02141"></a>02141              it=it-&gt;next) {
<a name="l02142"></a>02142             <span class="keywordflow">if</span> (it-&gt;id == (<span class="keywordtype">int</span>)frm-&gt;addr)
<a name="l02143"></a>02143                <span class="keywordflow">break</span>;
<a name="l02144"></a>02144          }
<a name="l02145"></a>02145          <span class="keywordflow">if</span> (it) {
<a name="l02146"></a>02146             <span class="keywordtype">int</span> ret;
<a name="l02147"></a>02147             ret = mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, msg-&gt;data, frm-&gt;addr,
<a name="l02148"></a>02148                      MGR_TIMER | RESPONSE, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l02149"></a>02149             test_and_clear_bit(FLG_TIMER_RUNING, (<span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)&amp;it-&gt;Flags);
<a name="l02150"></a>02150             ret = it-&gt;function(it-&gt;data);
<a name="l02151"></a>02151             free_msg(msg);
<a name="l02152"></a>02152             <span class="keywordflow">return</span> 1;
<a name="l02153"></a>02153          }
<a name="l02154"></a>02154       }
<a name="l02155"></a>02155     
<a name="l02156"></a>02156       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, 0, <span class="stringliteral">"Timer Msg without Timer ??\n"</span>);
<a name="l02157"></a>02157       free_msg(msg);
<a name="l02158"></a>02158       <span class="keywordflow">return</span> 1;
<a name="l02159"></a>02159    }
<a name="l02160"></a>02160   
<a name="l02161"></a>02161    <span class="keywordflow">return</span> 0;
<a name="l02162"></a>02162 }
<a name="l02163"></a>02163 
<a name="l02164"></a>02164 
<a name="l02165"></a>02165 
<a name="l02166"></a><a class="code" href="isdn__lib_8h.html#3485542780d466476d99878ccb83af4e">02166</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#3485542780d466476d99878ccb83af4e">misdn_lib_tone_generator_start</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l02167"></a>02167 {
<a name="l02168"></a>02168    bc-&gt;<a class="code" href="structmisdn__bchannel.html#bf9179cd881ae878dddfa78dd01baf7a">generate_tone</a>=1;
<a name="l02169"></a>02169 }
<a name="l02170"></a>02170 
<a name="l02171"></a><a class="code" href="isdn__lib_8h.html#39b8550deb7abf7984f1be6ff55af6ca">02171</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#39b8550deb7abf7984f1be6ff55af6ca">misdn_lib_tone_generator_stop</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173    bc-&gt;<a class="code" href="structmisdn__bchannel.html#bf9179cd881ae878dddfa78dd01baf7a">generate_tone</a>=0;
<a name="l02174"></a>02174 }
<a name="l02175"></a>02175 
<a name="l02176"></a>02176 
<a name="l02177"></a><a class="code" href="isdn__lib_8c.html#dcd0604bc44fa23cd414cd0b8a1edd6e">02177</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#dcd0604bc44fa23cd414cd0b8a1edd6e">do_tone</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> len)
<a name="l02178"></a>02178 {
<a name="l02179"></a>02179    bc-&gt;<a class="code" href="structmisdn__bchannel.html#6f7799d0a20bc13102d505a6748d3c86">tone_cnt</a>=len;
<a name="l02180"></a>02180    
<a name="l02181"></a>02181    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#bf9179cd881ae878dddfa78dd01baf7a">generate_tone</a>) {
<a name="l02182"></a>02182       <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0036f17a6cf7e4803840a2f2f20b44b83">EVENT_TONE_GENERATE</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02183"></a>02183       
<a name="l02184"></a>02184       <span class="keywordflow">if</span> ( !bc-&gt;<a class="code" href="structmisdn__bchannel.html#1b253e98e64cbf710286e8febc477541">nojitter</a> ) {
<a name="l02185"></a>02185          <a class="code" href="isdn__lib_8c.html#b59aa831170c9444063d6baee2319ea4">misdn_tx_jitter</a>(bc,len);
<a name="l02186"></a>02186       }
<a name="l02187"></a>02187       
<a name="l02188"></a>02188       <span class="keywordflow">return</span> 1;
<a name="l02189"></a>02189    }
<a name="l02190"></a>02190    
<a name="l02191"></a>02191    <span class="keywordflow">return</span> 0;
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 
<a name="l02195"></a>02195 <span class="preprocessor">#ifdef MISDN_SAVE_DATA</span>
<a name="l02196"></a>02196 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> misdn_save_data(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">char</span> *p1, <span class="keywordtype">int</span> l1, <span class="keywordtype">char</span> *p2, <span class="keywordtype">int</span> l2) 
<a name="l02197"></a>02197 {
<a name="l02198"></a>02198    <span class="keywordtype">char</span> n1[32],n2[32];
<a name="l02199"></a>02199 
<a name="l02200"></a>02200    sprintf(n1,<span class="stringliteral">"/tmp/misdn-rx-%d.raw"</span>,<span class="keywordtype">id</span>);
<a name="l02201"></a>02201    sprintf(n2,<span class="stringliteral">"/tmp/misdn-tx-%d.raw"</span>,<span class="keywordtype">id</span>);
<a name="l02202"></a>02202 
<a name="l02203"></a>02203    FILE *rx=fopen(n1,<span class="stringliteral">"a+"</span>); 
<a name="l02204"></a>02204    FILE *tx=fopen(n2,<span class="stringliteral">"a+"</span>);
<a name="l02205"></a>02205 
<a name="l02206"></a>02206    <span class="keywordflow">if</span> (!rx || !tx) {
<a name="l02207"></a>02207       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"Couldn't open files: %s\n"</span>,strerror(errno));
<a name="l02208"></a>02208       return ;
<a name="l02209"></a>02209    }
<a name="l02210"></a>02210    
<a name="l02211"></a>02211    fwrite(p1,1,l1,rx);
<a name="l02212"></a>02212    fwrite(p2,1,l2,tx);
<a name="l02213"></a>02213    
<a name="l02214"></a>02214    fclose(rx);
<a name="l02215"></a>02215    fclose(tx);
<a name="l02216"></a>02216 
<a name="l02217"></a>02217 }
<a name="l02218"></a>02218 <span class="preprocessor">#endif</span>
<a name="l02219"></a>02219 <span class="preprocessor"></span>
<a name="l02220"></a><a class="code" href="isdn__lib_8c.html#b59aa831170c9444063d6baee2319ea4">02220</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#b59aa831170c9444063d6baee2319ea4">misdn_tx_jitter</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> len)
<a name="l02221"></a>02221 {
<a name="l02222"></a>02222    <span class="keywordtype">char</span> buf[4096 + mISDN_HEADER_LEN];
<a name="l02223"></a>02223    <span class="keywordtype">char</span> *data=&amp;buf[mISDN_HEADER_LEN];
<a name="l02224"></a>02224    iframe_t *txfrm= (iframe_t*)buf;
<a name="l02225"></a>02225    <span class="keywordtype">int</span> jlen, r;
<a name="l02226"></a>02226    
<a name="l02227"></a>02227    jlen=<a class="code" href="isdn__lib_8h.html#cd6359ea6dc1d15e696e389ca8c501bf">cb_jb_empty</a>(bc,data,len);
<a name="l02228"></a>02228    
<a name="l02229"></a>02229    <span class="keywordflow">if</span> (jlen) {
<a name="l02230"></a>02230 <span class="preprocessor">#ifdef MISDN_SAVE_DATA</span>
<a name="l02231"></a>02231 <span class="preprocessor"></span>      misdn_save_data((bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>*100+bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>), data, jlen, bc-&gt;<a class="code" href="structmisdn__bchannel.html#640bffb886177872841750e7f768c13e">bframe</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#1c054c3defdb331c735fdc24d297c48b">bframe_len</a>);
<a name="l02232"></a>02232 <span class="preprocessor">#endif</span>
<a name="l02233"></a>02233 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a>( data, jlen);
<a name="l02234"></a>02234       
<a name="l02235"></a>02235       <span class="keywordflow">if</span> (jlen &lt; len) {
<a name="l02236"></a>02236          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(7,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"Jitterbuffer Underrun.\n"</span>);
<a name="l02237"></a>02237       }
<a name="l02238"></a>02238       
<a name="l02239"></a>02239       txfrm-&gt;prim = DL_DATA|REQUEST;
<a name="l02240"></a>02240       
<a name="l02241"></a>02241       txfrm-&gt;dinfo = 0;
<a name="l02242"></a>02242       
<a name="l02243"></a>02243       txfrm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>|FLG_MSG_DOWN; <span class="comment">/*  | IF_DOWN; */</span>
<a name="l02244"></a>02244       
<a name="l02245"></a>02245       txfrm-&gt;len =jlen;
<a name="l02246"></a>02246       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(9, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Transmitting %d samples 2 misdn\n"</span>, txfrm-&gt;len);
<a name="l02247"></a>02247 
<a name="l02248"></a>02248       r=mISDN_write( glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, txfrm-&gt;len + mISDN_HEADER_LEN, 8000 );
<a name="l02249"></a>02249    } <span class="keywordflow">else</span> {
<a name="l02250"></a>02250 <span class="preprocessor">#define MISDN_GEN_SILENCE</span>
<a name="l02251"></a>02251 <span class="preprocessor"></span><span class="preprocessor">#ifdef MISDN_GEN_SILENCE</span>
<a name="l02252"></a>02252 <span class="preprocessor"></span>      <span class="keywordtype">int</span> cnt=len/TONE_SILENCE_SIZE;
<a name="l02253"></a>02253       <span class="keywordtype">int</span> rest=len%TONE_SILENCE_SIZE;
<a name="l02254"></a>02254       <span class="keywordtype">int</span> i;
<a name="l02255"></a>02255 
<a name="l02256"></a>02256       <span class="keywordflow">for</span> (i=0; i&lt;cnt; i++) {
<a name="l02257"></a>02257          memcpy(data, <a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">tone_silence_flip</a>, TONE_SILENCE_SIZE );
<a name="l02258"></a>02258          data +=TONE_SILENCE_SIZE;
<a name="l02259"></a>02259       }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261       <span class="keywordflow">if</span> (rest) {
<a name="l02262"></a>02262          memcpy(data, <a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">tone_silence_flip</a>, rest);
<a name="l02263"></a>02263       }
<a name="l02264"></a>02264 
<a name="l02265"></a>02265       txfrm-&gt;prim = DL_DATA|REQUEST;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267       txfrm-&gt;dinfo = 0;
<a name="l02268"></a>02268 
<a name="l02269"></a>02269       txfrm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>|FLG_MSG_DOWN; <span class="comment">/*  | IF_DOWN; */</span>
<a name="l02270"></a>02270 
<a name="l02271"></a>02271       txfrm-&gt;len =len;
<a name="l02272"></a>02272       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(9, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Transmitting %d samples 2 misdn\n"</span>, txfrm-&gt;len);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274       r=mISDN_write( glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, txfrm-&gt;len + mISDN_HEADER_LEN, 8000 );
<a name="l02275"></a>02275 <span class="preprocessor">#endif</span>
<a name="l02276"></a>02276 <span class="preprocessor"></span>
<a name="l02277"></a>02277    }
<a name="l02278"></a>02278 }
<a name="l02279"></a>02279 
<a name="l02280"></a><a class="code" href="isdn__lib_8c.html#0ac3358912eb6aa61a27bf5eda636a8a">02280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#0ac3358912eb6aa61a27bf5eda636a8a">handle_bchan</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02281"></a>02281 {
<a name="l02282"></a>02282    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02283"></a>02283 
<a name="l02284"></a>02284 
<a name="l02285"></a>02285    <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#6b5e254f2e3ec79fefb3f55e73a8e84d">find_bc_by_addr</a>(frm-&gt;addr);
<a name="l02286"></a>02286    
<a name="l02287"></a>02287    <span class="keywordflow">if</span> (!bc) {
<a name="l02288"></a>02288       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,0,<span class="stringliteral">"handle_bchan: BC not found for prim:%x with addr:%x dinfo:%x\n"</span>, frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo);
<a name="l02289"></a>02289       <span class="keywordflow">return</span> 0 ;
<a name="l02290"></a>02290    }
<a name="l02291"></a>02291    
<a name="l02292"></a>02292    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l02293"></a>02293    
<a name="l02294"></a>02294    <span class="keywordflow">if</span> (!stack) {
<a name="l02295"></a>02295       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"handle_bchan: STACK not found for prim:%x with addr:%x dinfo:%x\n"</span>, frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo);
<a name="l02296"></a>02296       <span class="keywordflow">return</span> 0;
<a name="l02297"></a>02297    }
<a name="l02298"></a>02298    
<a name="l02299"></a>02299    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l02300"></a>02300 
<a name="l02301"></a>02301    <span class="keywordflow">case</span> MGR_SETSTACK| CONFIRM:
<a name="l02302"></a>02302       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: MGR_SETSTACK|CONFIRM pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02303"></a>02303       <span class="keywordflow">break</span>;
<a name="l02304"></a>02304       
<a name="l02305"></a>02305    <span class="keywordflow">case</span> MGR_SETSTACK| INDICATION:
<a name="l02306"></a>02306       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: MGR_SETSTACK|IND pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02307"></a>02307    <span class="keywordflow">break</span>;
<a name="l02308"></a>02308 <span class="preprocessor">#if 0</span>
<a name="l02309"></a>02309 <span class="preprocessor"></span>   AGAIN:
<a name="l02310"></a>02310       bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> = mISDN_get_layerid(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#f56b53e412e87751f665cb9f9061e50b">layer</a>);
<a name="l02311"></a>02311       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>) {
<a name="l02312"></a>02312 
<a name="l02313"></a>02313          <span class="keywordflow">if</span> (errno == EAGAIN) {
<a name="l02314"></a>02314             usleep(1000);
<a name="l02315"></a>02315             <span class="keywordflow">goto</span> AGAIN;
<a name="l02316"></a>02316          }
<a name="l02317"></a>02317          
<a name="l02318"></a>02318          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"$$$ Get Layer (%d) Id Error: %s\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#f56b53e412e87751f665cb9f9061e50b">layer</a>,strerror(errno));
<a name="l02319"></a>02319          
<a name="l02320"></a>02320          <span class="comment">/* we kill the channel later, when we received some</span>
<a name="l02321"></a>02321 <span class="comment">            data. */</span>
<a name="l02322"></a>02322          bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>= frm-&gt;addr;
<a name="l02323"></a>02323       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> &lt; 0) {
<a name="l02324"></a>02324          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"$$$ bc-&gt;addr &lt;0 Error:%s\n"</span>,strerror(errno));
<a name="l02325"></a>02325          bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>=0;
<a name="l02326"></a>02326       }
<a name="l02327"></a>02327       
<a name="l02328"></a>02328       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; Got Adr %x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>);
<a name="l02329"></a>02329 
<a name="l02330"></a>02330       free_msg(msg);
<a name="l02331"></a>02331    
<a name="l02332"></a>02332       
<a name="l02333"></a>02333       <span class="keywordflow">switch</span>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>) {
<a name="l02334"></a>02334       <span class="keywordflow">case</span> BCHAN_SETUP:
<a name="l02335"></a>02335          <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a288d61277fd5c69f7eb0b4c5d0ac6c4693">BCHAN_SETUPED</a>);
<a name="l02336"></a>02336       <span class="keywordflow">break</span>;
<a name="l02337"></a>02337 
<a name="l02338"></a>02338       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2896790b3b75a52c602d1d27f0c3e10adc">BCHAN_CLEAN_REQUEST</a>:
<a name="l02339"></a>02339       <span class="keywordflow">default</span>:
<a name="l02340"></a>02340          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; STATE WASN'T SETUP (but %s) in SETSTACK|IND pid:%d\n"</span>,<a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;bc_state), bc-&gt;pid);
<a name="l02341"></a>02341          <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l02342"></a>02342       }
<a name="l02343"></a>02343       <span class="keywordflow">return</span> 1;
<a name="l02344"></a>02344 <span class="preprocessor">#endif</span>
<a name="l02345"></a>02345 <span class="preprocessor"></span>
<a name="l02346"></a>02346    <span class="keywordflow">case</span> MGR_DELLAYER| INDICATION:
<a name="l02347"></a>02347       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: MGR_DELLAYER|IND pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02348"></a>02348       <span class="keywordflow">break</span>;
<a name="l02349"></a>02349       
<a name="l02350"></a>02350    <span class="keywordflow">case</span> MGR_DELLAYER| CONFIRM:
<a name="l02351"></a>02351       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: MGR_DELLAYER|CNF pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02352"></a>02352       
<a name="l02353"></a>02353       bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>=0;
<a name="l02354"></a>02354       bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>=0;
<a name="l02355"></a>02355       
<a name="l02356"></a>02356       free_msg(msg);
<a name="l02357"></a>02357       <span class="keywordflow">return</span> 1;
<a name="l02358"></a>02358       
<a name="l02359"></a>02359    <span class="keywordflow">case</span> PH_ACTIVATE | INDICATION:
<a name="l02360"></a>02360    <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l02361"></a>02361       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: ACT Ind pid:%d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02362"></a>02362 
<a name="l02363"></a>02363       free_msg(msg);
<a name="l02364"></a>02364       <span class="keywordflow">return</span> 1;    
<a name="l02365"></a>02365 
<a name="l02366"></a>02366    <span class="keywordflow">case</span> PH_ACTIVATE | CONFIRM:
<a name="l02367"></a>02367    <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l02368"></a>02368       
<a name="l02369"></a>02369       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: bchan ACT Confirm pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02370"></a>02370       free_msg(msg);
<a name="l02371"></a>02371       
<a name="l02372"></a>02372       <span class="keywordflow">return</span> 1;    
<a name="l02373"></a>02373 
<a name="l02374"></a>02374    <span class="keywordflow">case</span> DL_ESTABLISH | REQUEST:
<a name="l02375"></a>02375       {
<a name="l02376"></a>02376          <span class="keywordtype">char</span> buf[128];
<a name="l02377"></a>02377          mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_TARGET | FLG_MSG_DOWN,  DL_ESTABLISH | CONFIRM, 0,0, NULL, TIMEOUT_1SEC);
<a name="l02378"></a>02378       }
<a name="l02379"></a>02379       free_msg(msg);
<a name="l02380"></a>02380       <span class="keywordflow">return</span> 1;
<a name="l02381"></a>02381 
<a name="l02382"></a>02382    <span class="keywordflow">case</span> DL_RELEASE|REQUEST:
<a name="l02383"></a>02383       {
<a name="l02384"></a>02384          <span class="keywordtype">char</span> buf[128];
<a name="l02385"></a>02385          mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_TARGET | FLG_MSG_DOWN,  DL_RELEASE| CONFIRM, 0,0, NULL, TIMEOUT_1SEC);
<a name="l02386"></a>02386       }
<a name="l02387"></a>02387       free_msg(msg);
<a name="l02388"></a>02388       <span class="keywordflow">return</span> 1;
<a name="l02389"></a>02389       
<a name="l02390"></a>02390    <span class="keywordflow">case</span> PH_DEACTIVATE | INDICATION:
<a name="l02391"></a>02391    <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02392"></a>02392       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: DeACT Ind pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02393"></a>02393       
<a name="l02394"></a>02394       free_msg(msg);
<a name="l02395"></a>02395       <span class="keywordflow">return</span> 1;
<a name="l02396"></a>02396     
<a name="l02397"></a>02397    <span class="keywordflow">case</span> PH_DEACTIVATE | CONFIRM:
<a name="l02398"></a>02398    <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02399"></a>02399       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BCHAN: DeACT Conf pid:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l02400"></a>02400       
<a name="l02401"></a>02401       free_msg(msg);
<a name="l02402"></a>02402       <span class="keywordflow">return</span> 1;
<a name="l02403"></a>02403     
<a name="l02404"></a>02404    <span class="keywordflow">case</span> PH_CONTROL|INDICATION:
<a name="l02405"></a>02405    {
<a name="l02406"></a>02406       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cont = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)&amp;frm-&gt;data.p);
<a name="l02407"></a>02407       
<a name="l02408"></a>02408       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"PH_CONTROL: channel:%d oad%d:%s dad%d:%s \n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>);
<a name="l02409"></a>02409 
<a name="l02410"></a>02410       <span class="keywordflow">if</span> ((cont&amp;~DTMF_TONE_MASK) == DTMF_TONE_VAL) {
<a name="l02411"></a>02411          <span class="keywordtype">int</span> dtmf = cont &amp; DTMF_TONE_MASK;
<a name="l02412"></a>02412          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; DTMF TONE: %c\n"</span>,dtmf);
<a name="l02413"></a>02413          bc-&gt;<a class="code" href="structmisdn__bchannel.html#8ba842e099c3576a2300f983ea717215">dtmf</a>=dtmf;
<a name="l02414"></a>02414          <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a055b9b217134f91fb69500d98ec72b0fc">EVENT_DTMF_TONE</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02415"></a>02415    
<a name="l02416"></a>02416          free_msg(msg);
<a name="l02417"></a>02417          <span class="keywordflow">return</span> 1;
<a name="l02418"></a>02418       }
<a name="l02419"></a>02419       <span class="keywordflow">if</span> (cont == BF_REJECT) {
<a name="l02420"></a>02420          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; BF REJECT\n"</span>);
<a name="l02421"></a>02421          free_msg(msg);
<a name="l02422"></a>02422          <span class="keywordflow">return</span> 1;
<a name="l02423"></a>02423       }
<a name="l02424"></a>02424       <span class="keywordflow">if</span> (cont == BF_ACCEPT) {
<a name="l02425"></a>02425          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; BF ACCEPT\n"</span>);
<a name="l02426"></a>02426          free_msg(msg);
<a name="l02427"></a>02427          <span class="keywordflow">return</span> 1;
<a name="l02428"></a>02428       }
<a name="l02429"></a>02429    }
<a name="l02430"></a>02430    <span class="keywordflow">break</span>;
<a name="l02431"></a>02431 
<a name="l02432"></a>02432    <span class="keywordflow">case</span> PH_DATA|REQUEST:
<a name="l02433"></a>02433    <span class="keywordflow">case</span> DL_DATA|REQUEST:
<a name="l02434"></a>02434       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"DL_DATA REQUEST \n"</span>);
<a name="l02435"></a>02435       <a class="code" href="isdn__lib_8c.html#dcd0604bc44fa23cd414cd0b8a1edd6e">do_tone</a>(bc, 64);
<a name="l02436"></a>02436       
<a name="l02437"></a>02437       free_msg(msg);
<a name="l02438"></a>02438       <span class="keywordflow">return</span> 1;
<a name="l02439"></a>02439    
<a name="l02440"></a>02440    
<a name="l02441"></a>02441    <span class="keywordflow">case</span> PH_DATA|INDICATION:
<a name="l02442"></a>02442    <span class="keywordflow">case</span> DL_DATA|INDICATION:
<a name="l02443"></a>02443    {
<a name="l02444"></a>02444       bc-&gt;<a class="code" href="structmisdn__bchannel.html#640bffb886177872841750e7f768c13e">bframe</a> = (<span class="keywordtype">void</span>*)&amp;frm-&gt;data.i;
<a name="l02445"></a>02445       bc-&gt;<a class="code" href="structmisdn__bchannel.html#1c054c3defdb331c735fdc24d297c48b">bframe_len</a> = frm-&gt;len;
<a name="l02446"></a>02446 <span class="comment"></span>
<a name="l02447"></a>02447 <span class="comment">      /** Anyway flip the bufbits **/</span>
<a name="l02448"></a>02448       if ( <a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>) ) 
<a name="l02449"></a>02449          <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#640bffb886177872841750e7f768c13e">bframe</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#1c054c3defdb331c735fdc24d297c48b">bframe_len</a>);
<a name="l02450"></a>02450    
<a name="l02451"></a>02451 
<a name="l02452"></a>02452       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#1c054c3defdb331c735fdc24d297c48b">bframe_len</a>) {
<a name="l02453"></a>02453          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"DL_DATA INDICATION bc-&gt;addr:%x frm-&gt;addr:%x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>, frm-&gt;addr);
<a name="l02454"></a>02454          free_msg(msg);
<a name="l02455"></a>02455          <span class="keywordflow">return</span> 1;
<a name="l02456"></a>02456       }
<a name="l02457"></a>02457 
<a name="l02458"></a>02458       <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>&amp;STACK_ID_MASK) != (frm-&gt;addr&amp;STACK_ID_MASK) ) {
<a name="l02459"></a>02459          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"DL_DATA INDICATION bc-&gt;addr:%x frm-&gt;addr:%x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>, frm-&gt;addr);
<a name="l02460"></a>02460          free_msg(msg);
<a name="l02461"></a>02461          <span class="keywordflow">return</span> 1;
<a name="l02462"></a>02462       }
<a name="l02463"></a>02463       
<a name="l02464"></a>02464 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02465"></a>02465 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"DL_DATA INDICATION Len %d\n"</span>, frm-&gt;len);
<a name="l02466"></a>02466 
<a name="l02467"></a>02467 <span class="preprocessor">#endif</span>
<a name="l02468"></a>02468 <span class="preprocessor"></span>      
<a name="l02469"></a>02469       <span class="keywordflow">if</span> ( (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a> == <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>) &amp;&amp; frm-&gt;len &gt; 0) {
<a name="l02470"></a>02470          <span class="keywordtype">int</span> t;
<a name="l02471"></a>02471 
<a name="l02472"></a>02472 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02473"></a>02473 <span class="preprocessor"></span>         <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"do_tone START\n"</span>);
<a name="l02474"></a>02474 <span class="preprocessor">#endif</span>
<a name="l02475"></a>02475 <span class="preprocessor"></span>         t=<a class="code" href="isdn__lib_8c.html#dcd0604bc44fa23cd414cd0b8a1edd6e">do_tone</a>(bc,frm-&gt;len);
<a name="l02476"></a>02476 
<a name="l02477"></a>02477 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02478"></a>02478 <span class="preprocessor"></span>         <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"do_tone STOP (%d)\n"</span>,t);
<a name="l02479"></a>02479 <span class="preprocessor">#endif</span>
<a name="l02480"></a>02480 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (  !t ) {
<a name="l02481"></a>02481             
<a name="l02482"></a>02482             <span class="keywordflow">if</span> ( <a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l02483"></a>02483                <span class="keywordflow">if</span> ( !bc-&gt;<a class="code" href="structmisdn__bchannel.html#1b253e98e64cbf710286e8febc477541">nojitter</a> ) {
<a name="l02484"></a>02484 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02485"></a>02485 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"tx_jitter START\n"</span>);
<a name="l02486"></a>02486 <span class="preprocessor">#endif</span>
<a name="l02487"></a>02487 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8c.html#b59aa831170c9444063d6baee2319ea4">misdn_tx_jitter</a>(bc,frm-&gt;len);
<a name="l02488"></a>02488 <span class="preprocessor">#ifdef MISDN_B_DEBUG</span>
<a name="l02489"></a>02489 <span class="preprocessor"></span>                  <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"tx_jitter STOP\n"</span>);
<a name="l02490"></a>02490 <span class="preprocessor">#endif</span>
<a name="l02491"></a>02491 <span class="preprocessor"></span>               }
<a name="l02492"></a>02492             }
<a name="l02493"></a>02493 
<a name="l02494"></a>02494 <span class="preprocessor">#ifdef MISDN_B_DEBUG </span>
<a name="l02495"></a>02495 <span class="preprocessor"></span>            <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"EVENT_B_DATA START\n"</span>);
<a name="l02496"></a>02496 <span class="preprocessor">#endif</span>
<a name="l02497"></a>02497 <span class="preprocessor"></span>            
<a name="l02498"></a>02498             <span class="keywordtype">int</span> i=<a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>( <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0300139063899079805b6f681e0a3c5ef">EVENT_BCHAN_DATA</a>, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02499"></a>02499 <span class="preprocessor">#ifdef MISDN_B_DEBUG </span>
<a name="l02500"></a>02500 <span class="preprocessor"></span>            <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"EVENT_B_DATA STOP\n"</span>);
<a name="l02501"></a>02501 <span class="preprocessor">#endif</span>
<a name="l02502"></a>02502 <span class="preprocessor"></span>            
<a name="l02503"></a>02503             <span class="keywordflow">if</span> (i&lt;0) {
<a name="l02504"></a>02504                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(10,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"cb_event returned &lt;0\n"</span>);
<a name="l02505"></a>02505                <span class="comment">/*clean_up_bc(bc);*/</span>
<a name="l02506"></a>02506             }
<a name="l02507"></a>02507          }
<a name="l02508"></a>02508       }
<a name="l02509"></a>02509       free_msg(msg);
<a name="l02510"></a>02510       <span class="keywordflow">return</span> 1;
<a name="l02511"></a>02511    }
<a name="l02512"></a>02512 
<a name="l02513"></a>02513 
<a name="l02514"></a>02514    <span class="keywordflow">case</span> PH_CONTROL | CONFIRM:
<a name="l02515"></a>02515       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"PH_CONTROL|CNF bc-&gt;addr:%x\n"</span>, frm-&gt;addr);
<a name="l02516"></a>02516       free_msg(msg);
<a name="l02517"></a>02517       <span class="keywordflow">return</span> 1;
<a name="l02518"></a>02518 
<a name="l02519"></a>02519    <span class="keywordflow">case</span> PH_DATA | CONFIRM:
<a name="l02520"></a>02520    <span class="keywordflow">case</span> DL_DATA|CONFIRM:
<a name="l02521"></a>02521 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02522"></a>02522 <span class="preprocessor"></span>
<a name="l02523"></a>02523       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Data confirmed\n"</span>);
<a name="l02524"></a>02524 
<a name="l02525"></a>02525 <span class="preprocessor">#endif</span>
<a name="l02526"></a>02526 <span class="preprocessor"></span>      free_msg(msg);
<a name="l02527"></a>02527       <span class="keywordflow">return</span> 1;
<a name="l02528"></a>02528    <span class="keywordflow">case</span> DL_DATA|RESPONSE:
<a name="l02529"></a>02529 <span class="preprocessor">#if MISDN_DEBUG</span>
<a name="l02530"></a>02530 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Data response\n"</span>);
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="preprocessor">#endif</span>
<a name="l02533"></a>02533 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
<a name="l02534"></a>02534    }
<a name="l02535"></a>02535   
<a name="l02536"></a>02536    <span class="keywordflow">return</span> 0;
<a name="l02537"></a>02537 }
<a name="l02538"></a>02538 
<a name="l02539"></a>02539 
<a name="l02540"></a>02540 
<a name="l02541"></a><a class="code" href="isdn__lib_8c.html#2eb3ec160e02e2061e965f938c5e69a0">02541</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#2eb3ec160e02e2061e965f938c5e69a0">handle_frm_nt</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02542"></a>02542 {
<a name="l02543"></a>02543    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l02544"></a>02544    <span class="keyword">struct</span> misdn_stack *stack;
<a name="l02545"></a>02545    <span class="keywordtype">int</span> err=0;
<a name="l02546"></a>02546 
<a name="l02547"></a>02547    stack=<a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>( frm-&gt;addr );
<a name="l02548"></a>02548 
<a name="l02549"></a>02549    
<a name="l02550"></a>02550   
<a name="l02551"></a>02551    <span class="keywordflow">if</span> (!stack || !stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l02552"></a>02552       <span class="keywordflow">return</span> 0;
<a name="l02553"></a>02553    }
<a name="l02554"></a>02554 
<a name="l02555"></a>02555    
<a name="l02556"></a>02556    <span class="keywordflow">if</span> ((err=stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l1_l2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>,msg))) {
<a name="l02557"></a>02557     
<a name="l02558"></a>02558       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a> &gt; 0 ) {
<a name="l02559"></a>02559          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a> &lt; 100) {
<a name="l02560"></a>02560             <a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a>++; 
<a name="l02561"></a>02561             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"NT Stack sends us error: %d \n"</span>, err);
<a name="l02562"></a>02562          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a> &lt; 105){
<a name="l02563"></a>02563             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"NT Stack sends us error: %d over 100 times, so I'll stop this message\n"</span>, err);
<a name="l02564"></a>02564             <a class="code" href="isdn__lib_8c.html#b5e1358eb969acb9ca3b3e716ba1d6ef">nt_err_cnt</a> = - 1; 
<a name="l02565"></a>02565          }
<a name="l02566"></a>02566       }
<a name="l02567"></a>02567       free_msg(msg);
<a name="l02568"></a>02568       <span class="keywordflow">return</span> 1;
<a name="l02569"></a>02569       
<a name="l02570"></a>02570    }
<a name="l02571"></a>02571    
<a name="l02572"></a>02572    <span class="keywordflow">return</span> 1;
<a name="l02573"></a>02573 }
<a name="l02574"></a>02574 
<a name="l02575"></a>02575 
<a name="l02576"></a><a class="code" href="isdn__lib_8c.html#eb6341f3b591db3dbf3a815b38d4be9c">02576</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#eb6341f3b591db3dbf3a815b38d4be9c">handle_frm</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02577"></a>02577 {
<a name="l02578"></a>02578    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02579"></a>02579    
<a name="l02580"></a>02580    <span class="keyword">struct</span> misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02581"></a>02581 
<a name="l02582"></a>02582    <span class="keywordflow">if</span> (!stack || stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l02583"></a>02583       <span class="keywordflow">return</span> 0;
<a name="l02584"></a>02584    }
<a name="l02585"></a>02585    
<a name="l02586"></a>02586    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">"handle_frm: frm-&gt;addr:%x frm-&gt;prim:%x\n"</span>,frm-&gt;addr,frm-&gt;prim);
<a name="l02587"></a>02587 
<a name="l02588"></a>02588    {
<a name="l02589"></a>02589       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc;
<a name="l02590"></a>02590       <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#00d6f5656c4b42e852bada50879c8e5d">handle_cr</a>(stack, frm);
<a name="l02591"></a>02591 
<a name="l02592"></a>02592       <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l02593"></a>02593          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">"handle_frm: handle_cr &lt;0 prim:%x addr:%x\n"</span>, frm-&gt;prim, frm-&gt;addr);
<a name="l02594"></a>02594 
<a name="l02595"></a>02595 
<a name="l02596"></a>02596       }
<a name="l02597"></a>02597 
<a name="l02598"></a>02598       <span class="keywordflow">if</span>(ret) {
<a name="l02599"></a>02599          free_msg(msg);
<a name="l02600"></a>02600          <span class="keywordflow">return</span> 1;
<a name="l02601"></a>02601       }
<a name="l02602"></a>02602     
<a name="l02603"></a>02603       bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l02604"></a>02604     
<a name="l02605"></a>02605 handle_frm_bc:
<a name="l02606"></a>02606       <span class="keywordflow">if</span> (bc ) {
<a name="l02607"></a>02607          <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0">event_e</a> event = <a class="code" href="isdn__lib__intern_8h.html#9a4f7077635592f6e00223f6e95ff263">isdn_msg_get_event</a>(msgs_g, msg, 0);
<a name="l02608"></a>02608          <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82ed">event_response_e</a> response=<a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82edc5ac5008f6608e71a8e5672539ffe7e8">RESPONSE_OK</a>;
<a name="l02609"></a>02609       
<a name="l02610"></a>02610          <a class="code" href="isdn__lib__intern_8h.html#46f23b8b8004605130f76eb9324b4f68">isdn_msg_parse_event</a>(msgs_g,msg,bc, 0);
<a name="l02611"></a>02611          <span class="comment"></span>
<a name="l02612"></a>02612 <span class="comment">         /** Preprocess some Events **/</span>
<a name="l02613"></a>02613          <span class="keywordtype">int</span> ret=<a class="code" href="isdn__lib_8c.html#4e0da69bc45f6776eb978468ecb82d5b">handle_event</a>(bc, event, frm);
<a name="l02614"></a>02614          <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l02615"></a>02615             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"couldn't handle event\n"</span>);
<a name="l02616"></a>02616             free_msg(msg);
<a name="l02617"></a>02617             <span class="keywordflow">return</span> 1;
<a name="l02618"></a>02618          }
<a name="l02619"></a>02619          <span class="comment">/*  shoot up event to App: */</span>
<a name="l02620"></a>02620          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"lib Got Prim: Addr %x prim %x dinfo %x\n"</span>,frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l02621"></a>02621       
<a name="l02622"></a>02622          <span class="keywordflow">if</span>(!<a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g,event,0)) 
<a name="l02623"></a>02623             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Unknown Event Ind: Addr:%x prim %x dinfo %x\n"</span>,frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l02624"></a>02624          <span class="keywordflow">else</span>
<a name="l02625"></a>02625             response=<a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(event, bc, glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02626"></a>02626 <span class="preprocessor">#if 1</span>
<a name="l02627"></a>02627 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a>) {
<a name="l02628"></a>02628             <span class="keywordflow">switch</span> (response) {
<a name="l02629"></a>02629             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82ed22609d9e903d73374cc8a09979386094">RESPONSE_IGNORE_SETUP_WITHOUT_CLOSE</a>:
<a name="l02630"></a>02630 
<a name="l02631"></a>02631                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"TOTALY IGNORING SETUP \n"</span>);               
<a name="l02632"></a>02632                
<a name="l02633"></a>02633                <span class="keywordflow">break</span>;
<a name="l02634"></a>02634             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82edd87366f4cb9dc8916280d90b60daa4b8">RESPONSE_IGNORE_SETUP</a>:
<a name="l02635"></a>02635                <span class="comment">/* I think we should send CC_RELEASE_CR, but am not sure*/</span>
<a name="l02636"></a>02636                bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=16;
<a name="l02637"></a>02637             
<a name="l02638"></a>02638             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82eda80ff5123c9dc29e94ccbef92a90ce62">RESPONSE_RELEASE_SETUP</a>:
<a name="l02639"></a>02639                <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(bc,<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>);
<a name="l02640"></a>02640                <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l02641"></a>02641                   <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l02642"></a>02642                <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l02643"></a>02643                <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>);
<a name="l02644"></a>02644 
<a name="l02645"></a>02645                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"GOT IGNORE SETUP\n"</span>);
<a name="l02646"></a>02646 
<a name="l02647"></a>02647                
<a name="l02648"></a>02648                <span class="keywordflow">break</span>;
<a name="l02649"></a>02649             <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#810475c954e6db3c79e30c63b45c82edc5ac5008f6608e71a8e5672539ffe7e8">RESPONSE_OK</a>:
<a name="l02650"></a>02650                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"GOT SETUP OK\n"</span>);
<a name="l02651"></a>02651 
<a name="l02652"></a>02652                
<a name="l02653"></a>02653                <span class="keywordflow">break</span>;
<a name="l02654"></a>02654             <span class="keywordflow">default</span>:
<a name="l02655"></a>02655                <span class="keywordflow">break</span>;
<a name="l02656"></a>02656             }
<a name="l02657"></a>02657          }
<a name="l02658"></a>02658 
<a name="l02659"></a>02659          <span class="keywordflow">if</span> (event == <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>) {
<a name="l02660"></a>02660             <span class="comment">/* release bchannel only after we've anounced the RELEASE_COMPLETE */</span>
<a name="l02661"></a>02661             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l02662"></a>02662                <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l02663"></a>02663             <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>; 
<a name="l02664"></a>02664             <span class="keywordtype">int</span> tmp_out_cause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>; 
<a name="l02665"></a>02665             <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l02666"></a>02666             bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>=tmpcause;
<a name="l02667"></a>02667             bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=tmp_out_cause;
<a name="l02668"></a>02668             <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l02669"></a>02669          }
<a name="l02670"></a>02670 
<a name="l02671"></a>02671          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Freeing Msg on prim:%x \n"</span>,frm-&gt;prim);
<a name="l02672"></a>02672 
<a name="l02673"></a>02673          
<a name="l02674"></a>02674          free_msg(msg);
<a name="l02675"></a>02675          <span class="keywordflow">return</span> 1;
<a name="l02676"></a>02676 <span class="preprocessor">#endif</span>
<a name="l02677"></a>02677 <span class="preprocessor"></span>      
<a name="l02678"></a>02678       } <span class="keywordflow">else</span> {
<a name="l02679"></a>02679          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; Didn't find BC so temporarly creating dummy BC (l3id:%x) on this port.\n"</span>, frm-&gt;dinfo);
<a name="l02680"></a>02680          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> dummybc;
<a name="l02681"></a>02681          memset (&amp;dummybc,0,<span class="keyword">sizeof</span>(dummybc));
<a name="l02682"></a>02682          dummybc.port=stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l02683"></a>02683          dummybc.l3_id=frm-&gt;dinfo;
<a name="l02684"></a>02684          bc=&amp;dummybc; 
<a name="l02685"></a>02685          <span class="keywordflow">goto</span> handle_frm_bc;
<a name="l02686"></a>02686       }
<a name="l02687"></a>02687    }
<a name="l02688"></a>02688 
<a name="l02689"></a>02689    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"TE_FRM_HANDLER: Returning 0 on prim:%x \n"</span>,frm-&gt;prim);
<a name="l02690"></a>02690    <span class="keywordflow">return</span> 0;
<a name="l02691"></a>02691 }
<a name="l02692"></a>02692 
<a name="l02693"></a>02693 
<a name="l02694"></a><a class="code" href="isdn__lib_8c.html#f2ea5bb779324e541c31c82bdd866e57">02694</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#f2ea5bb779324e541c31c82bdd866e57">handle_l1</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02695"></a>02695 {
<a name="l02696"></a>02696    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02697"></a>02697    <span class="keyword">struct</span> misdn_stack *stack = <a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02698"></a>02698    <span class="keywordtype">int</span> i ;
<a name="l02699"></a>02699    
<a name="l02700"></a>02700    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> 0 ;
<a name="l02701"></a>02701 
<a name="l02702"></a>02702    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l02703"></a>02703    <span class="keywordflow">case</span> PH_ACTIVATE | CONFIRM:
<a name="l02704"></a>02704    <span class="keywordflow">case</span> PH_ACTIVATE | INDICATION:
<a name="l02705"></a>02705       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"L1: PH L1Link Up!\n"</span>);
<a name="l02706"></a>02706       stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=1;
<a name="l02707"></a>02707       
<a name="l02708"></a>02708       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l02709"></a>02709          
<a name="l02710"></a>02710          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l1_l2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, msg))
<a name="l02711"></a>02711             free_msg(msg);
<a name="l02712"></a>02712 
<a name="l02713"></a>02713          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>)
<a name="l02714"></a>02714             <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack);
<a name="l02715"></a>02715       } <span class="keywordflow">else</span> {
<a name="l02716"></a>02716          free_msg(msg);
<a name="l02717"></a>02717       }
<a name="l02718"></a>02718       
<a name="l02719"></a>02719       <span class="keywordflow">for</span> (i=0;i&lt;=stack-&gt;b_num; i++) {
<a name="l02720"></a>02720          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a> != <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0495f687faead1367521e53b5c0046e90">EVENT_NOTHING</a>) {
<a name="l02721"></a>02721             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Fireing Queued Event %s because L1 got up\n"</span>, <a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g, stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a>, 0));
<a name="l02722"></a>02722             <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i],stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a>);
<a name="l02723"></a>02723             stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a>=<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0495f687faead1367521e53b5c0046e90">EVENT_NOTHING</a>;
<a name="l02724"></a>02724          }
<a name="l02725"></a>02725          
<a name="l02726"></a>02726       }
<a name="l02727"></a>02727       <span class="keywordflow">return</span> 1;
<a name="l02728"></a>02728 
<a name="l02729"></a>02729    <span class="keywordflow">case</span> PH_ACTIVATE | REQUEST:
<a name="l02730"></a>02730       free_msg(msg);
<a name="l02731"></a>02731       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"L1: PH_ACTIVATE|REQUEST \n"</span>);
<a name="l02732"></a>02732       <span class="keywordflow">return</span> 1;
<a name="l02733"></a>02733       
<a name="l02734"></a>02734    <span class="keywordflow">case</span> PH_DEACTIVATE | REQUEST:
<a name="l02735"></a>02735       free_msg(msg);
<a name="l02736"></a>02736       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"L1: PH_DEACTIVATE|REQUEST \n"</span>);
<a name="l02737"></a>02737       <span class="keywordflow">return</span> 1;
<a name="l02738"></a>02738       
<a name="l02739"></a>02739    <span class="keywordflow">case</span> PH_DEACTIVATE | CONFIRM:
<a name="l02740"></a>02740    <span class="keywordflow">case</span> PH_DEACTIVATE | INDICATION:
<a name="l02741"></a>02741       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"L1: PH L1Link Down! \n"</span>);
<a name="l02742"></a>02742       
<a name="l02743"></a>02743       <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;b_num; i++) {
<a name="l02744"></a>02744          <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">global_state</a> == <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c9c9a2ea84f30847e9b04cb5b4e59c862">MISDN_INITIALIZED</a>)  {
<a name="l02745"></a>02745             <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0adbb5302858f0ca23b9552f9a5402d26">EVENT_CLEANUP</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02746"></a>02746          }
<a name="l02747"></a>02747       }
<a name="l02748"></a>02748       
<a name="l02749"></a>02749       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l02750"></a>02750          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l1_l2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, msg))
<a name="l02751"></a>02751             free_msg(msg);
<a name="l02752"></a>02752       } <span class="keywordflow">else</span> {
<a name="l02753"></a>02753          free_msg(msg);
<a name="l02754"></a>02754       }
<a name="l02755"></a>02755       
<a name="l02756"></a>02756       stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=0;
<a name="l02757"></a>02757       stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=0;
<a name="l02758"></a>02758       <span class="keywordflow">return</span> 1;
<a name="l02759"></a>02759    }
<a name="l02760"></a>02760   
<a name="l02761"></a>02761    <span class="keywordflow">return</span> 0;
<a name="l02762"></a>02762 }
<a name="l02763"></a>02763 
<a name="l02764"></a><a class="code" href="isdn__lib_8c.html#69a99dbfc3b3a7005c232acc4a187b5e">02764</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#69a99dbfc3b3a7005c232acc4a187b5e">handle_l2</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02765"></a>02765 {
<a name="l02766"></a>02766    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02767"></a>02767 
<a name="l02768"></a>02768    <span class="keyword">struct</span> misdn_stack *stack = <a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02769"></a>02769    
<a name="l02770"></a>02770    <span class="keywordflow">if</span> (!stack) {
<a name="l02771"></a>02771       <span class="keywordflow">return</span> 0 ;
<a name="l02772"></a>02772    }
<a name="l02773"></a>02773    
<a name="l02774"></a>02774    <span class="keywordflow">switch</span>(frm-&gt;prim) {
<a name="l02775"></a>02775 
<a name="l02776"></a>02776    <span class="keywordflow">case</span> DL_ESTABLISH | REQUEST:
<a name="l02777"></a>02777       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"DL_ESTABLISH|REQUEST \n"</span>);
<a name="l02778"></a>02778       <span class="keywordflow">return</span> 1;
<a name="l02779"></a>02779    <span class="keywordflow">case</span> DL_RELEASE | REQUEST:
<a name="l02780"></a>02780       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"DL_RELEASE|REQUEST \n"</span>);
<a name="l02781"></a>02781       <span class="keywordflow">return</span> 1;
<a name="l02782"></a>02782       
<a name="l02783"></a>02783    <span class="keywordflow">case</span> DL_ESTABLISH | INDICATION:
<a name="l02784"></a>02784    <span class="keywordflow">case</span> DL_ESTABLISH | CONFIRM:
<a name="l02785"></a>02785    {
<a name="l02786"></a>02786       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"L2: L2Link Up! \n"</span>);
<a name="l02787"></a>02787       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>) {
<a name="l02788"></a>02788          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (-1, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"L2: L2Link Up! but it's already UP.. must be faulty, blocking port\n"</span>); 
<a name="l02789"></a>02789          <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a05b30790092043cd946ec3ae1aee2afee">EVENT_PORT_ALARM</a>, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[0], glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#388e8d19bf9740f95858eb22b4fa7d4f">user_data</a>);
<a name="l02790"></a>02790       }
<a name="l02791"></a>02791       stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=1;
<a name="l02792"></a>02792       free_msg(msg);
<a name="l02793"></a>02793       <span class="keywordflow">return</span> 1;
<a name="l02794"></a>02794    }
<a name="l02795"></a>02795    <span class="keywordflow">break</span>;
<a name="l02796"></a>02796     
<a name="l02797"></a>02797    <span class="keywordflow">case</span> DL_RELEASE | INDICATION:
<a name="l02798"></a>02798    <span class="keywordflow">case</span> DL_RELEASE | CONFIRM:
<a name="l02799"></a>02799    {
<a name="l02800"></a>02800       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"L2: L2Link Down! \n"</span>);
<a name="l02801"></a>02801       stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=0;
<a name="l02802"></a>02802       
<a name="l02803"></a>02803       free_msg(msg);
<a name="l02804"></a>02804       <span class="keywordflow">return</span> 1;
<a name="l02805"></a>02805    }
<a name="l02806"></a>02806    <span class="keywordflow">break</span>;
<a name="l02807"></a>02807    }
<a name="l02808"></a>02808    <span class="keywordflow">return</span> 0;
<a name="l02809"></a>02809 }
<a name="l02810"></a>02810 
<a name="l02811"></a><a class="code" href="isdn__lib_8c.html#dfd7e658f254d8c23302f8a892c7f0cd">02811</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#dfd7e658f254d8c23302f8a892c7f0cd">handle_mgmt</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l02812"></a>02812 {
<a name="l02813"></a>02813    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l02814"></a>02814 
<a name="l02815"></a>02815    if ( (frm-&gt;addr == 0) &amp;&amp; (frm-&gt;prim == (MGR_DELLAYER|CONFIRM)) ) {
<a name="l02816"></a>02816       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, 0, <span class="stringliteral">"MGMT: DELLAYER|CONFIRM Addr: 0 !\n"</span>) ;
<a name="l02817"></a>02817       free_msg(msg);
<a name="l02818"></a>02818       <span class="keywordflow">return</span> 1;
<a name="l02819"></a>02819    }
<a name="l02820"></a>02820    
<a name="l02821"></a>02821    <span class="keyword">struct </span>misdn_stack * stack=<a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>(frm-&gt;addr);
<a name="l02822"></a>02822    
<a name="l02823"></a>02823    <span class="keywordflow">if</span> (!stack) {
<a name="l02824"></a>02824       <span class="keywordflow">if</span> (frm-&gt;prim == (MGR_DELLAYER|CONFIRM)) {
<a name="l02825"></a>02825          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, 0, <span class="stringliteral">"MGMT: DELLAYER|CONFIRM Addr: %x !\n"</span>,
<a name="l02826"></a>02826                frm-&gt;addr) ;
<a name="l02827"></a>02827          free_msg(msg);
<a name="l02828"></a>02828          <span class="keywordflow">return</span> 1;
<a name="l02829"></a>02829       }
<a name="l02830"></a>02830       
<a name="l02831"></a>02831       <span class="keywordflow">return</span> 0;
<a name="l02832"></a>02832    }
<a name="l02833"></a>02833    
<a name="l02834"></a>02834    <span class="keywordflow">switch</span>(frm-&gt;prim) {
<a name="l02835"></a>02835    <span class="keywordflow">case</span> MGR_SHORTSTATUS | INDICATION:
<a name="l02836"></a>02836    <span class="keywordflow">case</span> MGR_SHORTSTATUS | CONFIRM:
<a name="l02837"></a>02837       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, 0, <span class="stringliteral">"MGMT: Short status dinfo %x\n"</span>,frm-&gt;dinfo);
<a name="l02838"></a>02838       
<a name="l02839"></a>02839       <span class="keywordflow">switch</span> (frm-&gt;dinfo) {
<a name="l02840"></a>02840       <span class="keywordflow">case</span> SSTATUS_L1_ACTIVATED:
<a name="l02841"></a>02841          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, 0, <span class="stringliteral">"MGMT: SSTATUS: L1_ACTIVATED \n"</span>);
<a name="l02842"></a>02842          stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=1;
<a name="l02843"></a>02843       
<a name="l02844"></a>02844          <span class="keywordflow">break</span>;
<a name="l02845"></a>02845       <span class="keywordflow">case</span> SSTATUS_L1_DEACTIVATED:
<a name="l02846"></a>02846          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, 0, <span class="stringliteral">"MGMT: SSTATUS: L1_DEACTIVATED \n"</span>);
<a name="l02847"></a>02847          stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>=0;
<a name="l02848"></a>02848 
<a name="l02849"></a>02849          <a class="code" href="isdn__lib_8c.html#4ca6bc0fd37653def2f1ebeea7703bf2">clear_l3</a>(stack);
<a name="l02850"></a>02850          <span class="keywordflow">break</span>;
<a name="l02851"></a>02851 
<a name="l02852"></a>02852       <span class="keywordflow">case</span> SSTATUS_L2_ESTABLISHED:
<a name="l02853"></a>02853          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"MGMT: SSTATUS: L2_ESTABLISH \n"</span>);
<a name="l02854"></a>02854          stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=1;
<a name="l02855"></a>02855          <span class="keywordflow">break</span>;
<a name="l02856"></a>02856          
<a name="l02857"></a>02857       <span class="keywordflow">case</span> SSTATUS_L2_RELEASED:
<a name="l02858"></a>02858          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"MGMT: SSTATUS: L2_RELEASED \n"</span>);
<a name="l02859"></a>02859          stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=0;
<a name="l02860"></a>02860          <span class="keywordflow">break</span>;
<a name="l02861"></a>02861       }
<a name="l02862"></a>02862       
<a name="l02863"></a>02863       free_msg(msg);
<a name="l02864"></a>02864       <span class="keywordflow">return</span> 1;
<a name="l02865"></a>02865       
<a name="l02866"></a>02866    <span class="keywordflow">case</span> MGR_SETSTACK | INDICATION:
<a name="l02867"></a>02867       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"MGMT: SETSTACK|IND dinfo %x\n"</span>,frm-&gt;dinfo);
<a name="l02868"></a>02868       free_msg(msg);
<a name="l02869"></a>02869       <span class="keywordflow">return</span> 1;
<a name="l02870"></a>02870    <span class="keywordflow">case</span> MGR_DELLAYER | CONFIRM:
<a name="l02871"></a>02871       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"MGMT: DELLAYER|CNF dinfo %x\n"</span>,frm-&gt;dinfo) ;
<a name="l02872"></a>02872       free_msg(msg);
<a name="l02873"></a>02873       <span class="keywordflow">return</span> 1;
<a name="l02874"></a>02874       
<a name="l02875"></a>02875    }
<a name="l02876"></a>02876    
<a name="l02877"></a>02877    <span class="comment">/*</span>
<a name="l02878"></a>02878 <span class="comment">   if ( (frm-&gt;prim &amp; 0x0f0000) ==  0x0f0000) {</span>
<a name="l02879"></a>02879 <span class="comment">   cb_log(5, 0, "$$$ MGMT FRAME: prim %x addr %x dinfo %x\n",frm-&gt;prim, frm-&gt;addr, frm-&gt;dinfo) ;</span>
<a name="l02880"></a>02880 <span class="comment">   free_msg(msg);</span>
<a name="l02881"></a>02881 <span class="comment">   return 1;</span>
<a name="l02882"></a>02882 <span class="comment">   } */</span>
<a name="l02883"></a>02883     
<a name="l02884"></a>02884    <span class="keywordflow">return</span> 0;
<a name="l02885"></a>02885 }
<a name="l02886"></a>02886 
<a name="l02887"></a>02887 
<a name="l02888"></a><a class="code" href="isdn__lib_8c.html#27833588b4150858c2b7151ca62c4958">02888</a> <span class="keyword">static</span> msg_t *<a class="code" href="isdn__lib_8c.html#27833588b4150858c2b7151ca62c4958">fetch_msg</a>(<span class="keywordtype">int</span> midev) 
<a name="l02889"></a>02889 {
<a name="l02890"></a>02890    msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>=alloc_msg(MAX_MSG_SIZE);
<a name="l02891"></a>02891    <span class="keywordtype">int</span> r;
<a name="l02892"></a>02892 
<a name="l02893"></a>02893    <span class="keywordflow">if</span> (!msg) {
<a name="l02894"></a>02894       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, 0, <span class="stringliteral">"fetch_msg: alloc msg failed !!"</span>);
<a name="l02895"></a>02895       <span class="keywordflow">return</span> NULL;
<a name="l02896"></a>02896    }
<a name="l02897"></a>02897 
<a name="l02898"></a>02898    AGAIN:
<a name="l02899"></a>02899       r=mISDN_read(midev,msg-&gt;data,MAX_MSG_SIZE, TIMEOUT_10SEC);
<a name="l02900"></a>02900       msg-&gt;len=r;
<a name="l02901"></a>02901     
<a name="l02902"></a>02902       <span class="keywordflow">if</span> (r==0) {
<a name="l02903"></a>02903          free_msg(msg); <span class="comment">/* danger, cauz usualy freeing in main_loop */</span>
<a name="l02904"></a>02904          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(6,0,<span class="stringliteral">"Got empty Msg..\n"</span>);
<a name="l02905"></a>02905          <span class="keywordflow">return</span> NULL;
<a name="l02906"></a>02906       }
<a name="l02907"></a>02907 
<a name="l02908"></a>02908       <span class="keywordflow">if</span> (r&lt;0) {
<a name="l02909"></a>02909          <span class="keywordflow">if</span> (errno == EAGAIN) {
<a name="l02910"></a>02910             <span class="comment">/*we wait for mISDN here*/</span>
<a name="l02911"></a>02911             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,0,<span class="stringliteral">"mISDN_read wants us to wait\n"</span>);
<a name="l02912"></a>02912             usleep(5000);
<a name="l02913"></a>02913             <span class="keywordflow">goto</span> AGAIN;
<a name="l02914"></a>02914          }
<a name="l02915"></a>02915          
<a name="l02916"></a>02916          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"mISDN_read returned :%d error:%s (%d)\n"</span>,r,strerror(errno),errno); 
<a name="l02917"></a>02917       }
<a name="l02918"></a>02918 
<a name="l02919"></a>02919 <span class="preprocessor">#if 0</span>
<a name="l02920"></a>02920 <span class="preprocessor"></span>               <span class="keywordflow">if</span>  (!(frm-&gt;prim == (DL_DATA|INDICATION) )|| (frm-&gt;prim == (PH_DATA|INDICATION)))
<a name="l02921"></a>02921                        <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"prim: %x dinfo:%x addr:%x msglen:%d frm-&gt;len:%d\n"</span>,frm-&gt;prim, frm-&gt;dinfo, frm-&gt;addr, msg-&gt;len,frm-&gt;len );
<a name="l02922"></a>02922 <span class="preprocessor">#endif</span>
<a name="l02923"></a>02923 <span class="preprocessor"></span>      <span class="keywordflow">return</span> msg;
<a name="l02924"></a>02924 }
<a name="l02925"></a>02925 
<a name="l02926"></a><a class="code" href="isdn__lib_8h.html#1fdd71c5d6c0e73f361e0890ea7abe4f">02926</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#1fdd71c5d6c0e73f361e0890ea7abe4f">misdn_lib_isdn_l1watcher</a>(<span class="keywordtype">int</span> port)
<a name="l02927"></a>02927 {
<a name="l02928"></a>02928    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l02929"></a>02929 
<a name="l02930"></a>02930    <span class="keywordflow">for</span> (stack = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>; stack &amp;&amp; (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> != port); stack = stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>)
<a name="l02931"></a>02931       ;
<a name="l02932"></a>02932 
<a name="l02933"></a>02933    <span class="keywordflow">if</span> (stack) {
<a name="l02934"></a>02934       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, port, <span class="stringliteral">"Checking L1 State\n"</span>);   
<a name="l02935"></a>02935       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>) {
<a name="l02936"></a>02936          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, port, <span class="stringliteral">"L1 State Down, trying to get it up again\n"</span>); 
<a name="l02937"></a>02937          <a class="code" href="isdn__lib_8c.html#4a860c5934091035c3910e7d1f33e8f7">misdn_lib_get_short_status</a>(stack);
<a name="l02938"></a>02938          <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack); 
<a name="l02939"></a>02939          <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack); 
<a name="l02940"></a>02940       }
<a name="l02941"></a>02941    }
<a name="l02942"></a>02942 }
<a name="l02943"></a>02943 
<a name="l02944"></a><a class="code" href="isdn__lib_8c.html#7c6cd22b15b81f73d23093a5a99a8c35">02944</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#7c6cd22b15b81f73d23093a5a99a8c35">misdn_lib_isdn_event_catcher</a>(<span class="keywordtype">void</span> *arg)
<a name="l02945"></a>02945 {
<a name="l02946"></a>02946    <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *mgr = arg;
<a name="l02947"></a>02947    <span class="keywordtype">int</span> zero_frm=0 , fff_frm=0 ;
<a name="l02948"></a>02948    <span class="keywordtype">int</span> midev= mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>;
<a name="l02949"></a>02949    <span class="keywordtype">int</span> port=0;
<a name="l02950"></a>02950    
<a name="l02951"></a>02951    <span class="keywordflow">while</span> (1) {
<a name="l02952"></a>02952       msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a> = <a class="code" href="isdn__lib_8c.html#27833588b4150858c2b7151ca62c4958">fetch_msg</a>(midev); 
<a name="l02953"></a>02953       iframe_t *frm;
<a name="l02954"></a>02954       
<a name="l02955"></a>02955       
<a name="l02956"></a>02956       <span class="keywordflow">if</span> (!msg) <span class="keywordflow">continue</span>;
<a name="l02957"></a>02957       
<a name="l02958"></a>02958       frm = (iframe_t*) msg-&gt;data;
<a name="l02959"></a>02959       <span class="comment"></span>
<a name="l02960"></a>02960 <span class="comment">      /** When we make a call from NT2Ast we get this frames **/</span>
<a name="l02961"></a>02961       if (frm-&gt;len == 0 &amp;&amp; frm-&gt;addr == 0 &amp;&amp; frm-&gt;dinfo == 0 &amp;&amp; frm-&gt;prim == 0 ) {
<a name="l02962"></a>02962          zero_frm++; 
<a name="l02963"></a>02963          free_msg(msg);
<a name="l02964"></a>02964          <span class="keywordflow">continue</span>;
<a name="l02965"></a>02965       } <span class="keywordflow">else</span> {
<a name="l02966"></a>02966          <span class="keywordflow">if</span> (zero_frm) {
<a name="l02967"></a>02967             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"*** Alert: %d zero_frms caught\n"</span>, zero_frm);
<a name="l02968"></a>02968             zero_frm = 0 ;
<a name="l02969"></a>02969          }
<a name="l02970"></a>02970       }
<a name="l02971"></a>02971       <span class="comment"></span>
<a name="l02972"></a>02972 <span class="comment">      /** I get this sometimes after setup_bc **/</span>
<a name="l02973"></a>02973       <span class="keywordflow">if</span> (frm-&gt;len == 0 &amp;&amp;  frm-&gt;dinfo == 0 &amp;&amp; frm-&gt;prim == 0xffffffff ) {
<a name="l02974"></a>02974          fff_frm++; 
<a name="l02975"></a>02975          free_msg(msg);
<a name="l02976"></a>02976          <span class="keywordflow">continue</span>;
<a name="l02977"></a>02977       } <span class="keywordflow">else</span> {
<a name="l02978"></a>02978          <span class="keywordflow">if</span> (fff_frm) {
<a name="l02979"></a>02979             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"*** Alert: %d fff_frms caught\n"</span>, fff_frm);
<a name="l02980"></a>02980             fff_frm = 0 ;
<a name="l02981"></a>02981          }
<a name="l02982"></a>02982       }
<a name="l02983"></a>02983       
<a name="l02984"></a>02984       <a class="code" href="isdn__lib_8c.html#5417f55f8e4c1b3b83070dcc12ca7c05">manager_isdn_handler</a>(frm, msg);
<a name="l02985"></a>02985    }
<a name="l02986"></a>02986 
<a name="l02987"></a>02987 }
<a name="l02988"></a>02988 
<a name="l02989"></a>02989 <span class="comment"></span>
<a name="l02990"></a>02990 <span class="comment">/** App Interface **/</span>
<a name="l02991"></a>02991 
<a name="l02992"></a><a class="code" href="isdn__lib_8c.html#cb8e372f8838eb8a4f90860340f94828">02992</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#cb8e372f8838eb8a4f90860340f94828">te_lib_init</a>() {
<a name="l02993"></a>02993    <span class="keywordtype">char</span> buff[1025];
<a name="l02994"></a>02994    iframe_t *frm=(iframe_t*)buff;
<a name="l02995"></a>02995    <span class="keywordtype">int</span> midev=mISDN_open();
<a name="l02996"></a>02996    <span class="keywordtype">int</span> ret;
<a name="l02997"></a>02997 
<a name="l02998"></a>02998    memset(buff,0,1025);
<a name="l02999"></a>02999   
<a name="l03000"></a>03000    <span class="keywordflow">if</span>  (midev&lt;=0) <span class="keywordflow">return</span> midev;
<a name="l03001"></a>03001   
<a name="l03002"></a>03002 <span class="comment">/* create entity for layer 3 TE-mode */</span>
<a name="l03003"></a>03003    mISDN_write_frame(midev, buff, 0, MGR_NEWENTITY | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l03004"></a>03004    ret = mISDN_read_frame(midev, frm, <span class="keyword">sizeof</span>(iframe_t), 0, MGR_NEWENTITY | CONFIRM, TIMEOUT_1SEC);
<a name="l03005"></a>03005   
<a name="l03006"></a>03006    <span class="keywordflow">if</span> (ret &lt; mISDN_HEADER_LEN) {
<a name="l03007"></a>03007    noentity:
<a name="l03008"></a>03008       fprintf(stderr, <span class="stringliteral">"cannot request MGR_NEWENTITY from mISDN: %s\n"</span>,strerror(errno));
<a name="l03009"></a>03009       exit(-1);
<a name="l03010"></a>03010    }
<a name="l03011"></a>03011   
<a name="l03012"></a>03012    <a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">entity</a> = frm-&gt;dinfo &amp; 0xffff ;
<a name="l03013"></a>03013   
<a name="l03014"></a>03014    <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">entity</a>)
<a name="l03015"></a>03015       <span class="keywordflow">goto</span> noentity;
<a name="l03016"></a>03016 
<a name="l03017"></a>03017    <span class="keywordflow">return</span> midev;
<a name="l03018"></a>03018   
<a name="l03019"></a>03019 }
<a name="l03020"></a>03020 
<a name="l03021"></a><a class="code" href="isdn__lib_8c.html#a3d088c00ea6fe1029a86467bcd36dcb">03021</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a3d088c00ea6fe1029a86467bcd36dcb">te_lib_destroy</a>(<span class="keywordtype">int</span> midev)
<a name="l03022"></a>03022 {
<a name="l03023"></a>03023    <span class="keywordtype">char</span> buf[1024];
<a name="l03024"></a>03024    mISDN_write_frame(midev, buf, 0, MGR_DELENTITY | REQUEST, <a class="code" href="isdn__lib_8c.html#f5e638cc78dd325906c1298a0c21fb6b">entity</a>, 0, NULL, TIMEOUT_1SEC);
<a name="l03025"></a>03025 
<a name="l03026"></a>03026    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"Entetity deleted\n"</span>);
<a name="l03027"></a>03027    mISDN_close(midev);
<a name="l03028"></a>03028    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"midev closed\n"</span>);
<a name="l03029"></a>03029 }
<a name="l03030"></a>03030 
<a name="l03031"></a>03031 
<a name="l03032"></a>03032 
<a name="l03033"></a><a class="code" href="isdn__lib_8h.html#715ec48d2a51aec8e5be3a0be10cba43">03033</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#715ec48d2a51aec8e5be3a0be10cba43">misdn_lib_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* holded_bc)
<a name="l03034"></a>03034 {
<a name="l03035"></a>03035    holded_bc-&gt;<a class="code" href="structmisdn__bchannel.html#79a2f85be0af6b43c3ad40f2e0476425">holded</a>=0;
<a name="l03036"></a>03036 }
<a name="l03037"></a>03037 
<a name="l03038"></a><a class="code" href="isdn__lib_8c.html#d3554db5772822adaa03902792e06f57">03038</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#d3554db5772822adaa03902792e06f57">manager_find_bc_by_pid</a>(<span class="keywordtype">int</span> pid)
<a name="l03039"></a>03039 {
<a name="l03040"></a>03040    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l03041"></a>03041    <span class="keywordtype">int</span> i;
<a name="l03042"></a>03042   
<a name="l03043"></a>03043    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l03044"></a>03044         stack;
<a name="l03045"></a>03045         stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l03046"></a>03046       <span class="keywordflow">for</span> (i=0; i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++)
<a name="l03047"></a>03047          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a> == pid) <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l03048"></a>03048    }
<a name="l03049"></a>03049   
<a name="l03050"></a>03050    <span class="keywordflow">return</span> NULL;
<a name="l03051"></a>03051 }
<a name="l03052"></a>03052 
<a name="l03053"></a><a class="code" href="isdn__lib_8c.html#576050fafaacafe15cc8bd3e7b038b1a">03053</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#576050fafaacafe15cc8bd3e7b038b1a">manager_find_bc_holded</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* bc)
<a name="l03054"></a>03054 {
<a name="l03055"></a>03055    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l03056"></a>03056    <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#e3391504d1bf28bfce922ff217c5501e">find_bc_holded</a>(stack);
<a name="l03057"></a>03057 }
<a name="l03058"></a>03058 
<a name="l03059"></a>03059 
<a name="l03060"></a>03060 
<a name="l03061"></a><a class="code" href="isdn__lib_8c.html#0081e1acbdc27649f3b2c384767af8b5">03061</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#0081e1acbdc27649f3b2c384767af8b5">prepare_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>*bc, <span class="keywordtype">int</span> channel)
<a name="l03062"></a>03062 {
<a name="l03063"></a>03063    bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> = channel;
<a name="l03064"></a>03064    bc-&gt;<a class="code" href="structmisdn__bchannel.html#523edd474a57ca623cab9c23c2e73fe5">channel_preselected</a> = channel?1:0;
<a name="l03065"></a>03065    bc-&gt;<a class="code" href="structmisdn__bchannel.html#98b23b2fb5bb3781d8bd041e8ff6e5e3">in_use</a> = 1;
<a name="l03066"></a>03066    bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>=1;
<a name="l03067"></a>03067    bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5a8b44790d4813eec564aff11c8b4a5">need_release</a>=1;
<a name="l03068"></a>03068    bc-&gt;<a class="code" href="structmisdn__bchannel.html#3a50d8b05555100483c89a96ba1598ee">need_release_complete</a>=1;
<a name="l03069"></a>03069    bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>=16;
<a name="l03070"></a>03070 
<a name="l03071"></a>03071    <span class="keywordflow">if</span> (++mypid&gt;5000) mypid=1;
<a name="l03072"></a>03072    bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>=mypid;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074 <span class="preprocessor">#if 0</span>
<a name="l03075"></a>03075 <span class="preprocessor"></span>   bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>=0;
<a name="l03076"></a>03076    bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>=0;
<a name="l03077"></a>03077    bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>=0;
<a name="l03078"></a>03078 <span class="preprocessor">#endif</span>
<a name="l03079"></a>03079 <span class="preprocessor"></span>}
<a name="l03080"></a>03080 
<a name="l03081"></a><a class="code" href="isdn__lib_8h.html#8f63d05f44b024ef51a4ba958379f952">03081</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>* <a class="code" href="isdn__lib_8c.html#8f63d05f44b024ef51a4ba958379f952">misdn_lib_get_free_bc</a>(<span class="keywordtype">int</span> port, <span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> inout, <span class="keywordtype">int</span> <a class="code" href="structmisdn__bchannel.html#1feea25ecb958229287f885aebe7c49b">dec</a>)
<a name="l03082"></a>03082 {
<a name="l03083"></a>03083    <span class="keyword">struct </span>misdn_stack *stack;
<a name="l03084"></a>03084    <span class="keywordtype">int</span> i;
<a name="l03085"></a>03085    
<a name="l03086"></a>03086    <span class="keywordflow">if</span> (channel &lt; 0 || channel &gt; <a class="code" href="isdn__lib_8h.html#eb21feec143b2d5027f57c0e93410e7e">MAX_BCHANS</a>) {
<a name="l03087"></a>03087       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Requested channel out of bounds (%d)\n"</span>,channel);
<a name="l03088"></a>03088       <span class="keywordflow">return</span> NULL;
<a name="l03089"></a>03089    }
<a name="l03090"></a>03090 
<a name="l03091"></a>03091    <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>; stack; stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l03092"></a>03092     
<a name="l03093"></a>03093       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a> == port) {
<a name="l03094"></a>03094          <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>) {
<a name="l03095"></a>03095             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Port is blocked\n"</span>);
<a name="l03096"></a>03096             <span class="keywordflow">return</span> NULL;
<a name="l03097"></a>03097          }
<a name="l03098"></a>03098       
<a name="l03099"></a>03099          <span class="keywordflow">if</span> (channel &gt; 0) {
<a name="l03100"></a>03100             <span class="keywordflow">if</span> (channel &lt;= stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>) {
<a name="l03101"></a>03101                <span class="keywordflow">for</span> (i = 0; i &lt; stack-&gt;b_num; i++) {
<a name="l03102"></a>03102                   <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#98b23b2fb5bb3781d8bd041e8ff6e5e3">in_use</a> &amp;&amp; stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> == channel) {
<a name="l03103"></a>03103                      <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Requested channel:%d on port:%d is already in use\n"</span>,channel, port);
<a name="l03104"></a>03104                      <span class="keywordflow">return</span> NULL;
<a name="l03105"></a>03105                   }
<a name="l03106"></a>03106                }
<a name="l03107"></a>03107             } <span class="keywordflow">else</span> {
<a name="l03108"></a>03108                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Requested channel:%d is out of bounds on port:%d\n"</span>,channel, port);
<a name="l03109"></a>03109                <span class="keywordflow">return</span> NULL;
<a name="l03110"></a>03110             }
<a name="l03111"></a>03111          }
<a name="l03112"></a>03112 
<a name="l03113"></a>03113          <span class="keywordtype">int</span> maxnum=inout&amp;&amp;!stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>&amp;&amp;!stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>?stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>+1:stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>;
<a name="l03114"></a>03114 
<a name="l03115"></a>03115          <span class="keywordflow">if</span> (dec) {
<a name="l03116"></a>03116             <span class="keywordflow">for</span> (i = maxnum-1; i&gt;=0; i--) {
<a name="l03117"></a>03117                <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#98b23b2fb5bb3781d8bd041e8ff6e5e3">in_use</a>) {
<a name="l03118"></a>03118                   <span class="comment">/* 3. channel on bri means CW*/</span>
<a name="l03119"></a>03119                   <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a> &amp;&amp; i==stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>)
<a name="l03120"></a>03120                      stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#0707ba092e91260b305c326e6a353593">cw</a>=1;
<a name="l03121"></a>03121                      
<a name="l03122"></a>03122                   <a class="code" href="isdn__lib_8c.html#0081e1acbdc27649f3b2c384767af8b5">prepare_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i], channel);
<a name="l03123"></a>03123                   stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#1feea25ecb958229287f885aebe7c49b">dec</a>=1;
<a name="l03124"></a>03124                   <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l03125"></a>03125                }
<a name="l03126"></a>03126             }
<a name="l03127"></a>03127          } <span class="keywordflow">else</span> {
<a name="l03128"></a>03128             <span class="keywordflow">for</span> (i = 0; i &lt;maxnum; i++) {
<a name="l03129"></a>03129                <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#98b23b2fb5bb3781d8bd041e8ff6e5e3">in_use</a>) {
<a name="l03130"></a>03130                   <span class="comment">/* 3. channel on bri means CW*/</span>
<a name="l03131"></a>03131                   <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a> &amp;&amp; i==stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>)
<a name="l03132"></a>03132                      stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#0707ba092e91260b305c326e6a353593">cw</a>=1;
<a name="l03133"></a>03133 
<a name="l03134"></a>03134                   <a class="code" href="isdn__lib_8c.html#0081e1acbdc27649f3b2c384767af8b5">prepare_bc</a>(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i], channel);
<a name="l03135"></a>03135                   <span class="keywordflow">return</span> &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i];
<a name="l03136"></a>03136                }
<a name="l03137"></a>03137             }
<a name="l03138"></a>03138          }
<a name="l03139"></a>03139 
<a name="l03140"></a>03140          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,port,<span class="stringliteral">"There is no free channel on port (%d)\n"</span>,port);
<a name="l03141"></a>03141          <span class="keywordflow">return</span> NULL;
<a name="l03142"></a>03142       }
<a name="l03143"></a>03143    }
<a name="l03144"></a>03144 
<a name="l03145"></a>03145    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,port,<span class="stringliteral">"Port is not configured (%d)\n"</span>,port);
<a name="l03146"></a>03146    <span class="keywordflow">return</span> NULL;
<a name="l03147"></a>03147 }
<a name="l03148"></a>03148 
<a name="l03149"></a>03149 
<a name="l03150"></a><a class="code" href="isdn__lib_8c.html#51a1a0203a6869f5d58a746f2f5d35ae">03150</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#51a1a0203a6869f5d58a746f2f5d35ae">fac2str</a> (<span class="keyword">enum</span> FacFunction <a class="code" href="manager_8h.html#7df4935f4a5a2865191ef74f64df8754">func</a>)
<a name="l03151"></a>03151 {
<a name="l03152"></a>03152    <span class="keyword">struct </span>arr_el { 
<a name="l03153"></a>03153       <span class="keyword">enum</span> FacFunction p; 
<a name="l03154"></a>03154       <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> ; 
<a name="l03155"></a>03155    } arr[] = {
<a name="l03156"></a>03156       { Fac_None, <span class="stringliteral">"Fac_None"</span> },
<a name="l03157"></a>03157       { Fac_CD, <span class="stringliteral">"Fac_CD"</span>},
<a name="l03158"></a>03158    };
<a name="l03159"></a>03159    
<a name="l03160"></a>03160    <span class="keywordtype">int</span> i;
<a name="l03161"></a>03161    
<a name="l03162"></a>03162    <span class="keywordflow">for</span> (i=0; i &lt; <span class="keyword">sizeof</span>(arr)/<span class="keyword">sizeof</span>( <span class="keyword">struct</span> arr_el) ; i ++)
<a name="l03163"></a>03163       <span class="keywordflow">if</span> ( arr[i].p==func) <span class="keywordflow">return</span> arr[i].s;
<a name="l03164"></a>03164    
<a name="l03165"></a>03165    <span class="keywordflow">return</span> <span class="stringliteral">"unknown"</span>;
<a name="l03166"></a>03166 }
<a name="l03167"></a>03167 
<a name="l03168"></a><a class="code" href="isdn__lib_8h.html#cd60f7c6014402a4c6ab477ebb9572ca">03168</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#cd60f7c6014402a4c6ab477ebb9572ca">misdn_lib_log_ies</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03169"></a>03169 {
<a name="l03170"></a>03170    <span class="keywordflow">if</span> (!bc) <span class="keywordflow">return</span>;
<a name="l03171"></a>03171 
<a name="l03172"></a>03172    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l03173"></a>03173 
<a name="l03174"></a>03174    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span>;
<a name="l03175"></a>03175 
<a name="l03176"></a>03176    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; channel:%d mode:%s cause:%d ocause:%d rad:%s cad:%s\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>?<span class="stringliteral">"NT"</span>:<span class="stringliteral">"TE"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#05019236a972847373c26c73480a354f">rad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#00a187a56514a72391c079e743703184">cad</a>);
<a name="l03177"></a>03177    
<a name="l03178"></a>03178    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(2, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,
<a name="l03179"></a>03179           <span class="stringliteral">" --&gt; info_dad:%s onumplan:%c dnumplan:%c rnumplan:%c cpnnumplan:%c\n"</span>,
<a name="l03180"></a>03180           bc-&gt;<a class="code" href="structmisdn__bchannel.html#914e1d3d7427eae06342feb03dfa4d94">info_dad</a>,
<a name="l03181"></a>03181           bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>&gt;=0?<span class="charliteral">'0'</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>:<span class="charliteral">' '</span>,
<a name="l03182"></a>03182           bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>&gt;=0?<span class="charliteral">'0'</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>:<span class="charliteral">' '</span>,
<a name="l03183"></a>03183           bc-&gt;<a class="code" href="structmisdn__bchannel.html#d606ba4cabf58ec7fcd9fb7a624f7c66">rnumplan</a>&gt;=0?<span class="charliteral">'0'</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#d606ba4cabf58ec7fcd9fb7a624f7c66">rnumplan</a>:<span class="charliteral">' '</span>,
<a name="l03184"></a>03184           bc-&gt;<a class="code" href="structmisdn__bchannel.html#2070e7d51f19d857107dfb7eec18c488">cpnnumplan</a>&gt;=0?<span class="charliteral">'0'</span>+bc-&gt;<a class="code" href="structmisdn__bchannel.html#2070e7d51f19d857107dfb7eec18c488">cpnnumplan</a>:<span class="charliteral">' '</span>
<a name="l03185"></a>03185       );
<a name="l03186"></a>03186    
<a name="l03187"></a>03187    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; caps:%s pi:%x keypad:%s sending_complete:%d\n"</span>, <a class="code" href="chan__misdn_8c.html#451be85e2adf0cefe2d062cd6e9a5f01">bearer2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>),bc-&gt;<a class="code" href="structmisdn__bchannel.html#fd8941ae54dfa065640246e1b8b9110d">progress_indicator</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#0a379463e59e2df8538b8866cce439e7">keypad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a22bbaaa1a52c1367ec11dbc1690eb2">sending_complete</a>);
<a name="l03188"></a>03188    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; screen:%d --&gt; pres:%d\n"</span>,
<a name="l03189"></a>03189          bc-&gt;<a class="code" href="structmisdn__bchannel.html#599eba19aa93a929cb8589f148b8a6c4">screen</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#33f142212957eabbfdc6831f4d43fc7c">pres</a>);
<a name="l03190"></a>03190    
<a name="l03191"></a>03191    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; addr:%x l3id:%x b_stid:%x layer_id:%x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#4b7b0d1f5f1d7c5a291e96a16c104677">b_stid</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#7a39a38c626c4d9ab080b8735ee52986">layer_id</a>);
<a name="l03192"></a>03192    
<a name="l03193"></a>03193    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; facility:%s out_facility:%s\n"</span>,<a class="code" href="isdn__lib_8c.html#51a1a0203a6869f5d58a746f2f5d35ae">fac2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#1e2c56b310bde1e0e2fb8e15fa6c9791">fac_in</a>.Function),<a class="code" href="isdn__lib_8c.html#51a1a0203a6869f5d58a746f2f5d35ae">fac2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#ca50a1ec0b0862a7db839a72305d1c8d">fac_out</a>.Function));
<a name="l03194"></a>03194 
<a name="l03195"></a>03195    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; urate:%d rate:%d mode:%d user1:%d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b5e011f38afe977e4ec3d1a57e7b33ec">urate</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#67942503875c1ae74e4b5b80a0dade01">rate</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#15d61712450a686a7f365adf4fef581f">mode</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#24c9e15e52afc47c225b757e7bee1f9d">user1</a>);
<a name="l03196"></a>03196    
<a name="l03197"></a>03197    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; bc:%x h:%d sh:%d\n"</span>, bc, bc-&gt;<a class="code" href="structmisdn__bchannel.html#79a2f85be0af6b43c3ad40f2e0476425">holded</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#5a923a709935aea970aef19dde643058">stack_holder</a>);
<a name="l03198"></a>03198 }
<a name="l03199"></a>03199 
<a name="l03200"></a>03200 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#04ac8dbecddde7248ebf386242390173">misdn_send_lock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l03201"></a>03201 <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#e2a0643eacd099219f0e91add35e197c">misdn_send_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc);
<a name="l03202"></a>03202 
<a name="l03203"></a><a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">03203</a> <span class="preprocessor">#define RETURN(a,b) {retval=a; goto b;}</span>
<a name="l03204"></a>03204 <span class="preprocessor"></span>
<a name="l03205"></a><a class="code" href="isdn__lib_8c.html#04ac8dbecddde7248ebf386242390173">03205</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#04ac8dbecddde7248ebf386242390173">misdn_send_lock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03206"></a>03206 {
<a name="l03207"></a>03207    <span class="comment">//cb_log(0,bc-&gt;port,"Locking bc-&gt;pid:%d\n", bc-&gt;pid);</span>
<a name="l03208"></a>03208    <a class="code" href="lock_8h.html#bfd7b8e018ae42daf1c03f52e64e036a">pthread_mutex_lock</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#80320d407369f6281809098222a117bd">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03209"></a>03209 }
<a name="l03210"></a>03210 
<a name="l03211"></a><a class="code" href="isdn__lib_8c.html#e2a0643eacd099219f0e91add35e197c">03211</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#e2a0643eacd099219f0e91add35e197c">misdn_send_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03212"></a>03212 {
<a name="l03213"></a>03213    <span class="comment">//cb_log(0,bc-&gt;port,"UnLocking bc-&gt;pid:%d\n", bc-&gt;pid);</span>
<a name="l03214"></a>03214    <a class="code" href="lock_8h.html#ed02ace186d080ebc5159344e5732300">pthread_mutex_unlock</a>(&amp;bc-&gt;<a class="code" href="structmisdn__bchannel.html#80320d407369f6281809098222a117bd">send_lock</a>-&gt;<a class="code" href="structsend__lock.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l03215"></a>03215 }
<a name="l03216"></a>03216 
<a name="l03217"></a><a class="code" href="isdn__lib_8h.html#13a457401268f7e259ae4b68a51070f5">03217</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#13a457401268f7e259ae4b68a51070f5">misdn_lib_send_event</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0">event_e</a> event )
<a name="l03218"></a>03218 {
<a name="l03219"></a>03219    msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>; 
<a name="l03220"></a>03220    <span class="keywordtype">int</span> retval=0;
<a name="l03221"></a>03221   
<a name="l03222"></a>03222    <span class="keywordflow">if</span> (!bc) <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT_POST_UNLOCK);
<a name="l03223"></a>03223    
<a name="l03224"></a>03224    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l03225"></a>03225    
<a name="l03226"></a>03226    <span class="keywordflow">if</span> (!stack) {
<a name="l03227"></a>03227       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"SENDEVENT: no Stack for event:%s oad:%s dad:%s \n"</span>, <a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g, event, 0), bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>);
<a name="l03228"></a>03228       <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT);
<a name="l03229"></a>03229    }
<a name="l03230"></a>03230    
<a name="l03231"></a>03231    <a class="code" href="isdn__lib_8c.html#04ac8dbecddde7248ebf386242390173">misdn_send_lock</a>(bc);
<a name="l03232"></a>03232 
<a name="l03233"></a>03233 
<a name="l03234"></a>03234    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(6,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"SENDEVENT: stack-&gt;nt:%d stack-&gt;uperid:%x\n"</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>, stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>);
<a name="l03235"></a>03235 
<a name="l03236"></a>03236    <span class="keywordflow">if</span> ( stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a> &amp;&amp; !stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>) {<span class="comment"></span>
<a name="l03237"></a>03237 <span class="comment">      /** Queue Event **/</span>
<a name="l03238"></a>03238       bc-&gt;<a class="code" href="structmisdn__bchannel.html#5b551764af20fd3e72660593588cc3b4">evq</a>=event;
<a name="l03239"></a>03239       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Queueing Event %s because L1 is down (btw. Activating L1)\n"</span>, <a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g, event, 0));
<a name="l03240"></a>03240       <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l03241"></a>03241       <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(0,OUT);
<a name="l03242"></a>03242    }
<a name="l03243"></a>03243    
<a name="l03244"></a>03244    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"I SEND:%s oad:%s dad:%s pid:%d\n"</span>, <a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g, event, 0), bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a>);
<a name="l03245"></a>03245    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; bc_state:%s\n"</span>,<a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>));
<a name="l03246"></a>03246    <a class="code" href="isdn__lib_8c.html#cd60f7c6014402a4c6ab477ebb9572ca">misdn_lib_log_ies</a>(bc);
<a name="l03247"></a>03247    
<a name="l03248"></a>03248    <span class="keywordflow">switch</span> (event) {
<a name="l03249"></a>03249    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a086b3863fb036111653b4f1e6025ad2b4">EVENT_SETUP</a>:
<a name="l03250"></a>03250       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#c1ee4cbe07ec953df3dbedd3f41c98bb">create_process</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, bc)&lt;0) {
<a name="l03251"></a>03251          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,  stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" No free channel at the moment @ send_event\n"</span>);
<a name="l03252"></a>03252 
<a name="l03253"></a>03253          <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-<a class="code" href="isdn__lib_8h.html#abab7d0b6a45a28d2ad96ca4590112909d44a55758f2bd0b272f2bf2ec976128">ENOCHAN</a>,OUT);
<a name="l03254"></a>03254       }
<a name="l03255"></a>03255 <span class="preprocessor">#if 0</span>
<a name="l03256"></a>03256 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l03257"></a>03257       ret=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l03258"></a>03258       <span class="keywordflow">if</span> (ret == -EINVAL) {
<a name="l03259"></a>03259          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_event: setup_bc failed\n"</span>);
<a name="l03260"></a>03260       }
<a name="l03261"></a>03261    }
<a name="l03262"></a>03262 <span class="preprocessor">#endif</span>
<a name="l03263"></a>03263 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a012515a4ed18d8b26df799d6d4a8c9dd2">EVENT_PROGRESS</a>:
<a name="l03266"></a>03266    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0730130c6b666776f7b45d7fc9487309f">EVENT_ALERTING</a>:
<a name="l03267"></a>03267    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a059ec007c5fb3715eb7e491d7f93da013">EVENT_PROCEEDING</a>:
<a name="l03268"></a>03268    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0d3ffe5414469f96e074ef316e43ed11e">EVENT_SETUP_ACKNOWLEDGE</a>:
<a name="l03269"></a>03269    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a00ce06d6849716e01ba968875c981bec6">EVENT_CONNECT</a>:
<a name="l03270"></a>03270    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a098f521d2ac010811212e356087d1114d">EVENT_RETRIEVE_ACKNOWLEDGE</a>:
<a name="l03271"></a>03271 
<a name="l03272"></a>03272       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l03273"></a>03273          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> &lt;=0 ) { <span class="comment">/*  else we have the channel already */</span>
<a name="l03274"></a>03274             <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#b6afc1e8a01251cc8f4b61f135e5aa64">find_free_chan_in_stack</a>(stack, bc, 0,0)) {
<a name="l03275"></a>03275                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" No free channel at the moment\n"</span>);
<a name="l03276"></a>03276                <span class="comment">/*FIXME: add disconnect*/</span>
<a name="l03277"></a>03277                <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-<a class="code" href="isdn__lib_8h.html#abab7d0b6a45a28d2ad96ca4590112909d44a55758f2bd0b272f2bf2ec976128">ENOCHAN</a>,OUT);
<a name="l03278"></a>03278             }
<a name="l03279"></a>03279             
<a name="l03280"></a>03280             <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#3f991d3919a212efedfb86f56e69cc12">set_chan_in_stack</a>(stack ,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>)&lt;0) {
<a name="l03281"></a>03281                <span class="comment">/*FIXME: add disconnect*/</span>
<a name="l03282"></a>03282                <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-<a class="code" href="isdn__lib_8h.html#abab7d0b6a45a28d2ad96ca4590112909d44a55758f2bd0b272f2bf2ec976128">ENOCHAN</a>,OUT);
<a name="l03283"></a>03283             }
<a name="l03284"></a>03284          }
<a name="l03285"></a>03285          <span class="comment">/* Its that i generate channels */</span>
<a name="l03286"></a>03286       }
<a name="l03287"></a>03287 
<a name="l03288"></a>03288       retval=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l03289"></a>03289       <span class="keywordflow">if</span> (retval == -EINVAL) {
<a name="l03290"></a>03290          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_event: setup_bc failed\n"</span>);
<a name="l03291"></a>03291       }
<a name="l03292"></a>03292 
<a name="l03293"></a>03293       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l03294"></a>03294          <span class="keywordflow">if</span> ((event==<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a00ce06d6849716e01ba968875c981bec6">EVENT_CONNECT</a>)||(event==<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a098f521d2ac010811212e356087d1114d">EVENT_RETRIEVE_ACKNOWLEDGE</a>)) {
<a name="l03295"></a>03295             <span class="keywordflow">if</span> ( *bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a> ) {
<a name="l03296"></a>03296                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,  <span class="stringliteral">" --&gt; ENABLING BLOWFISH channel:%d oad%d:%s dad%d:%s \n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b1377e13a55c3e84c0fc6df477869546">onumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#45181c8604891ce6605104a4f52fb380">oad</a>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#230305dc885803a9b235ef5196fa88c7">dnumplan</a>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#b7b8370ef4a3bf65d95e93695fafbf4f">dad</a>);
<a name="l03297"></a>03297                
<a name="l03298"></a>03298                <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(bc,  BF_ENABLE_KEY, bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a>, strlen(bc-&gt;<a class="code" href="structmisdn__bchannel.html#b772f688cb2a0ae2abc9763789efabf2">crypt_key</a>) );
<a name="l03299"></a>03299             }
<a name="l03300"></a>03300             
<a name="l03301"></a>03301             <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>) <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc,  DTMF_TONE_START, 0);
<a name="l03302"></a>03302             <a class="code" href="isdn__lib_8c.html#1a03f86fc5f61c756e7f189cdf873971">manager_ec_enable</a>(bc);
<a name="l03303"></a>03303             
<a name="l03304"></a>03304             <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a> != 0) {
<a name="l03305"></a>03305                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,  <span class="stringliteral">"--&gt; Changing txgain to %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>);
<a name="l03306"></a>03306                <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>);
<a name="l03307"></a>03307             }
<a name="l03308"></a>03308             
<a name="l03309"></a>03309             <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a> != 0 ) {
<a name="l03310"></a>03310                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,  <span class="stringliteral">"--&gt; Changing rxgain to %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>);
<a name="l03311"></a>03311                <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>);
<a name="l03312"></a>03312             }
<a name="l03313"></a>03313          }
<a name="l03314"></a>03314       }
<a name="l03315"></a>03315       <span class="keywordflow">break</span>;
<a name="l03316"></a>03316 
<a name="l03317"></a>03317    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a04bd0a86035845d750f163aea8cc823d5">EVENT_HOLD_ACKNOWLEDGE</a>:
<a name="l03318"></a>03318    {
<a name="l03319"></a>03319       <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holded_bc=<a class="code" href="astmm_8h.html#df74d22342f0da6246131193b1993a41">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a>));
<a name="l03320"></a>03320       <span class="keywordflow">if</span> (!holded_bc) {
<a name="l03321"></a>03321          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Could not allocate holded_bc!!!\n"</span>);
<a name="l03322"></a>03322          <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT);
<a name="l03323"></a>03323       }
<a name="l03324"></a>03324 
<a name="l03325"></a>03325       <span class="comment">/*backup the bc*/</span>
<a name="l03326"></a>03326       memcpy(holded_bc,bc,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> misdn_bchannel));
<a name="l03327"></a>03327       holded_bc-&gt;<a class="code" href="structmisdn__bchannel.html#79a2f85be0af6b43c3ad40f2e0476425">holded</a>=1;
<a name="l03328"></a>03328       <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(holded_bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28ca91e3f94c77e8e0915c6fa0538822f8">BCHAN_CLEANED</a>);
<a name="l03329"></a>03329 
<a name="l03330"></a>03330       <a class="code" href="isdn__lib_8c.html#efc87b4d843aa2a2f20e6c0131e06eb8">stack_holder_add</a>(stack,holded_bc);
<a name="l03331"></a>03331    
<a name="l03332"></a>03332       <span class="comment">/*kill the bridge and clean the bchannel*/</span>
<a name="l03333"></a>03333       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l03334"></a>03334          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a> == <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>) {
<a name="l03335"></a>03335             <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>(bc,bc-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>);
<a name="l03336"></a>03336             <span class="keyword">struct </span>misdn_bchannel *bc2=<a class="code" href="isdn__lib_8c.html#23f22efac15e89ad61667a53f6751de9">find_bc_by_confid</a>(bc-&gt;conf_id);
<a name="l03337"></a>03337             <span class="keywordflow">if</span> (!bc2) {
<a name="l03338"></a>03338                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;port,<span class="stringliteral">"We have no second bc in bridge???\n"</span>);
<a name="l03339"></a>03339             } <span class="keywordflow">else</span> {
<a name="l03340"></a>03340                <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>(bc2,bc-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>);
<a name="l03341"></a>03341             }
<a name="l03342"></a>03342          }
<a name="l03343"></a>03343 
<a name="l03344"></a>03344          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l03345"></a>03345             <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l03346"></a>03346          <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l03347"></a>03347          <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l03348"></a>03348       }
<a name="l03349"></a>03349       
<a name="l03350"></a>03350    }
<a name="l03351"></a>03351    <span class="keywordflow">break</span>;
<a name="l03352"></a>03352 
<a name="l03353"></a>03353    <span class="comment">/* finishing the channel eh ? */</span>
<a name="l03354"></a>03354    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a033911f5d1a7c5cdde06ee312a629513c">EVENT_DISCONNECT</a>:
<a name="l03355"></a>03355       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>) {
<a name="l03356"></a>03356          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; we have already send Disconnect\n"</span>);
<a name="l03357"></a>03357          <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT);
<a name="l03358"></a>03358       }
<a name="l03359"></a>03359       
<a name="l03360"></a>03360       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>=0;
<a name="l03361"></a>03361       <span class="keywordflow">break</span>;
<a name="l03362"></a>03362    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a08f2f8b0a920df11995fa50b5832adf95">EVENT_RELEASE</a>:
<a name="l03363"></a>03363       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5a8b44790d4813eec564aff11c8b4a5">need_release</a>) {
<a name="l03364"></a>03364          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; we have already send Release\n"</span>);
<a name="l03365"></a>03365          <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT);
<a name="l03366"></a>03366       }
<a name="l03367"></a>03367       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>=0;
<a name="l03368"></a>03368       bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5a8b44790d4813eec564aff11c8b4a5">need_release</a>=0;
<a name="l03369"></a>03369       <span class="keywordflow">break</span>;
<a name="l03370"></a>03370    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0717939385243ec1740816a35e3ad28a7">EVENT_RELEASE_COMPLETE</a>:
<a name="l03371"></a>03371       <span class="keywordflow">if</span> (!bc-&gt;<a class="code" href="structmisdn__bchannel.html#3a50d8b05555100483c89a96ba1598ee">need_release_complete</a>) {
<a name="l03372"></a>03372          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">" --&gt; we have already send Release_complete\n"</span>);
<a name="l03373"></a>03373          <a class="code" href="isdn__lib_8c.html#4e443a7361c879ce896fe25a88ae761f">RETURN</a>(-1,OUT);
<a name="l03374"></a>03374       }
<a name="l03375"></a>03375       bc-&gt;<a class="code" href="structmisdn__bchannel.html#e86ebee71d8a6952d25e8c39c1636f4f">need_disconnect</a>=0;
<a name="l03376"></a>03376       bc-&gt;<a class="code" href="structmisdn__bchannel.html#d5a8b44790d4813eec564aff11c8b4a5">need_release</a>=0;
<a name="l03377"></a>03377       bc-&gt;<a class="code" href="structmisdn__bchannel.html#3a50d8b05555100483c89a96ba1598ee">need_release_complete</a>=0;
<a name="l03378"></a>03378 
<a name="l03379"></a>03379       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>) {
<a name="l03380"></a>03380          <span class="comment">/*create clenaup in TE*/</span>
<a name="l03381"></a>03381          <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l03382"></a>03382             <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack,bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l03383"></a>03383          <span class="keywordtype">int</span> tmpcause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>; 
<a name="l03384"></a>03384          <span class="keywordtype">int</span> tmp_out_cause=bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>; 
<a name="l03385"></a>03385          <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l03386"></a>03386          bc-&gt;<a class="code" href="structmisdn__bchannel.html#560220fc3242a805f094edce47f35702">cause</a>=tmpcause;
<a name="l03387"></a>03387          bc-&gt;<a class="code" href="structmisdn__bchannel.html#d79d5a2fc88ee887f2879d5a8f4d0b58">out_cause</a>=tmp_out_cause;
<a name="l03388"></a>03388          <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l03389"></a>03389       }
<a name="l03390"></a>03390       <span class="keywordflow">break</span>;
<a name="l03391"></a>03391     
<a name="l03392"></a>03392    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a090c8fa51958ce4b3abe635d30fa49fdd">EVENT_CONNECT_ACKNOWLEDGE</a>:
<a name="l03393"></a>03393 
<a name="l03394"></a>03394       <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#25930e3036f13852cb0b29694bbab611">nt</a> || <a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l03395"></a>03395          <span class="keywordtype">int</span> retval=<a class="code" href="isdn__lib_8c.html#b102557166f3e71ee5a164651129aaa9">setup_bc</a>(bc);
<a name="l03396"></a>03396          <span class="keywordflow">if</span> (retval == -EINVAL){
<a name="l03397"></a>03397             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"send_event: setup_bc failed\n"</span>);
<a name="l03398"></a>03398             
<a name="l03399"></a>03399          }
<a name="l03400"></a>03400       }
<a name="l03401"></a>03401       
<a name="l03402"></a>03402       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l03403"></a>03403          <span class="keywordflow">if</span> (  !bc-&gt;<a class="code" href="structmisdn__bchannel.html#01bd5e9258cd13ba27a61b7954397e05">nodsp</a>) <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc,  DTMF_TONE_START, 0);
<a name="l03404"></a>03404          <a class="code" href="isdn__lib_8c.html#1a03f86fc5f61c756e7f189cdf873971">manager_ec_enable</a>(bc);
<a name="l03405"></a>03405 
<a name="l03406"></a>03406          <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a> != 0 ) {
<a name="l03407"></a>03407             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"--&gt; Changing txgain to %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>);
<a name="l03408"></a>03408             <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>);
<a name="l03409"></a>03409          }
<a name="l03410"></a>03410          <span class="keywordflow">if</span> ( bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a> != 0 ) {
<a name="l03411"></a>03411             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"--&gt; Changing rxgain to %d\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>);
<a name="l03412"></a>03412             <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>);
<a name="l03413"></a>03413          }
<a name="l03414"></a>03414       }
<a name="l03415"></a>03415       <span class="keywordflow">break</span>;
<a name="l03416"></a>03416     
<a name="l03417"></a>03417    <span class="keywordflow">default</span>:
<a name="l03418"></a>03418       <span class="keywordflow">break</span>;
<a name="l03419"></a>03419    }
<a name="l03420"></a>03420   
<a name="l03421"></a>03421    <span class="comment">/* Later we should think about sending bchannel data directly to misdn. */</span>
<a name="l03422"></a>03422    msg = <a class="code" href="isdn__lib__intern_8h.html#144a2ed77b1541b024c69ecb8ba1fab2">isdn_msg_build_event</a>(msgs_g, bc, event, stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>);
<a name="l03423"></a>03423    msg_queue_tail(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#18e8b7ec18aada3301aedec1abc1bdc6">downqueue</a>, msg);
<a name="l03424"></a>03424    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03425"></a>03425   
<a name="l03426"></a>03426 OUT:
<a name="l03427"></a>03427    <a class="code" href="isdn__lib_8c.html#e2a0643eacd099219f0e91add35e197c">misdn_send_unlock</a>(bc);
<a name="l03428"></a>03428 
<a name="l03429"></a>03429 OUT_POST_UNLOCK:
<a name="l03430"></a>03430    <span class="keywordflow">return</span> retval; 
<a name="l03431"></a>03431 }
<a name="l03432"></a>03432 
<a name="l03433"></a>03433 
<a name="l03434"></a><a class="code" href="isdn__lib_8c.html#f7320c8c5db54e2eebfe0dcab79ecf5f">03434</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#f7320c8c5db54e2eebfe0dcab79ecf5f">handle_err</a>(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l03435"></a>03435 {
<a name="l03436"></a>03436    iframe_t *frm = (iframe_t*) msg-&gt;data;
<a name="l03437"></a>03437 
<a name="l03438"></a>03438 
<a name="l03439"></a>03439    if (!frm-&gt;addr) {
<a name="l03440"></a>03440       <span class="keyword">static</span> <span class="keywordtype">int</span> cnt=0;
<a name="l03441"></a>03441       <span class="keywordflow">if</span> (!cnt)
<a name="l03442"></a>03442          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"mISDN Msg without Address pr:%x dinfo:%x\n"</span>,frm-&gt;prim,frm-&gt;dinfo);
<a name="l03443"></a>03443       cnt++;
<a name="l03444"></a>03444       <span class="keywordflow">if</span> (cnt&gt;100) {
<a name="l03445"></a>03445          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"mISDN Msg without Address pr:%x dinfo:%x (already more than 100 of them)\n"</span>,frm-&gt;prim,frm-&gt;dinfo);
<a name="l03446"></a>03446          cnt=0;
<a name="l03447"></a>03447       }
<a name="l03448"></a>03448       
<a name="l03449"></a>03449       free_msg(msg);
<a name="l03450"></a>03450       <span class="keywordflow">return</span> 1;
<a name="l03451"></a>03451       
<a name="l03452"></a>03452    }
<a name="l03453"></a>03453    
<a name="l03454"></a>03454    <span class="keywordflow">switch</span> (frm-&gt;prim) {
<a name="l03455"></a>03455       <span class="keywordflow">case</span> MGR_SETSTACK|INDICATION:
<a name="l03456"></a>03456          <span class="keywordflow">return</span> <a class="code" href="isdn__lib_8c.html#0ac3358912eb6aa61a27bf5eda636a8a">handle_bchan</a>(msg);
<a name="l03457"></a>03457       <span class="keywordflow">break</span>;
<a name="l03458"></a>03458 
<a name="l03459"></a>03459       <span class="keywordflow">case</span> MGR_SETSTACK|CONFIRM:
<a name="l03460"></a>03460       <span class="keywordflow">case</span> MGR_CLEARSTACK|CONFIRM:
<a name="l03461"></a>03461          free_msg(msg) ; 
<a name="l03462"></a>03462          <span class="keywordflow">return</span> 1;
<a name="l03463"></a>03463       <span class="keywordflow">break</span>;
<a name="l03464"></a>03464 
<a name="l03465"></a>03465       <span class="keywordflow">case</span> DL_DATA|CONFIRM:
<a name="l03466"></a>03466          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,0,<span class="stringliteral">"DL_DATA|CONFIRM\n"</span>);
<a name="l03467"></a>03467          free_msg(msg);
<a name="l03468"></a>03468          <span class="keywordflow">return</span> 1;
<a name="l03469"></a>03469 
<a name="l03470"></a>03470       <span class="keywordflow">case</span> PH_CONTROL|CONFIRM:
<a name="l03471"></a>03471          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,0,<span class="stringliteral">"PH_CONTROL|CONFIRM\n"</span>);
<a name="l03472"></a>03472          free_msg(msg);
<a name="l03473"></a>03473          <span class="keywordflow">return</span> 1;
<a name="l03474"></a>03474 
<a name="l03475"></a>03475       <span class="keywordflow">case</span> DL_DATA|INDICATION:
<a name="l03476"></a>03476       {
<a name="l03477"></a>03477          <span class="keywordtype">int</span> port=(frm-&gt;addr&amp;MASTER_ID_MASK) &gt;&gt; 8;
<a name="l03478"></a>03478          <span class="keywordtype">int</span> channel=(frm-&gt;addr&amp;CHILD_ID_MASK) &gt;&gt; 16;
<a name="l03479"></a>03479 
<a name="l03480"></a>03480          <span class="comment">/*we flush the read buffer here*/</span>
<a name="l03481"></a>03481          
<a name="l03482"></a>03482          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(9,0,<span class="stringliteral">"BCHAN DATA without BC: addr:%x port:%d channel:%d\n"</span>,frm-&gt;addr, port,channel);
<a name="l03483"></a>03483          
<a name="l03484"></a>03484          free_msg(msg) ; 
<a name="l03485"></a>03485          <span class="keywordflow">return</span> 1;
<a name="l03486"></a>03486          
<a name="l03487"></a>03487          
<a name="l03488"></a>03488          <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#0e208b5c73accc8d74541a10b9a7aa0d">find_bc_by_channel</a>( port , channel);
<a name="l03489"></a>03489 
<a name="l03490"></a>03490          <span class="keywordflow">if</span> (!bc) {
<a name="l03491"></a>03491             <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>( port );
<a name="l03492"></a>03492 
<a name="l03493"></a>03493             <span class="keywordflow">if</span> (!stack) {
<a name="l03494"></a>03494                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">" --&gt; stack not found\n"</span>);
<a name="l03495"></a>03495                free_msg(msg);
<a name="l03496"></a>03496                <span class="keywordflow">return</span> 1;
<a name="l03497"></a>03497             }
<a name="l03498"></a>03498             
<a name="l03499"></a>03499             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">" --&gt; bc not found by channel\n"</span>);
<a name="l03500"></a>03500             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>)
<a name="l03501"></a>03501                <a class="code" href="isdn__lib_8c.html#39f783ae77a77d141f283894e89a6037">misdn_lib_get_l2_down</a>(stack);
<a name="l03502"></a>03502 
<a name="l03503"></a>03503             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#ed4bf6f6a10f0dcb4367bf0c7a245351">l1link</a>)
<a name="l03504"></a>03504                <a class="code" href="isdn__lib_8c.html#ac82279245a38de1dc36244d9bc86b95">misdn_lib_get_l1_down</a>(stack);
<a name="l03505"></a>03505 
<a name="l03506"></a>03506             free_msg(msg);
<a name="l03507"></a>03507             <span class="keywordflow">return</span> 1;
<a name="l03508"></a>03508          }
<a name="l03509"></a>03509          
<a name="l03510"></a>03510          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,port,<span class="stringliteral">" --&gt; BC in state:%s\n"</span>, <a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>));
<a name="l03511"></a>03511       }
<a name="l03512"></a>03512    }
<a name="l03513"></a>03513 
<a name="l03514"></a>03514    <span class="keywordflow">return</span> 0;
<a name="l03515"></a>03515 }
<a name="l03516"></a>03516 
<a name="l03517"></a>03517 <span class="preprocessor">#if 0</span>
<a name="l03518"></a>03518 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> queue_l2l3(msg_t *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l03519"></a>03519 {
<a name="l03520"></a>03520    iframe_t *frm= (iframe_t*)msg-&gt;data;
<a name="l03521"></a>03521    <span class="keyword">struct</span> misdn_stack *stack;
<a name="l03522"></a>03522    stack=<a class="code" href="isdn__lib_8c.html#748db53520b780e20426bc9a1bb8ec98">find_stack_by_addr</a>( frm-&gt;addr );
<a name="l03523"></a>03523 
<a name="l03524"></a>03524    
<a name="l03525"></a>03525    <span class="keywordflow">if</span> (!stack) {
<a name="l03526"></a>03526       <span class="keywordflow">return</span> 0;
<a name="l03527"></a>03527    }
<a name="l03528"></a>03528 
<a name="l03529"></a>03529    msg_queue_tail(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#5aefa7b509ecc33f833a24377d231fee">upqueue</a>, msg);
<a name="l03530"></a>03530    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03531"></a>03531    <span class="keywordflow">return</span> 1;
<a name="l03532"></a>03532 }
<a name="l03533"></a>03533 <span class="preprocessor">#endif</span>
<a name="l03534"></a>03534 <span class="preprocessor"></span>
<a name="l03535"></a><a class="code" href="isdn__lib_8c.html#5417f55f8e4c1b3b83070dcc12ca7c05">03535</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#5417f55f8e4c1b3b83070dcc12ca7c05">manager_isdn_handler</a>(iframe_t *frm ,msg_t *msg)
<a name="l03536"></a>03536 {  
<a name="l03537"></a>03537 
<a name="l03538"></a>03538    <span class="keywordflow">if</span> (frm-&gt;dinfo==0xffffffff &amp;&amp; frm-&gt;prim==(PH_DATA|CONFIRM)) {
<a name="l03539"></a>03539       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"SERIOUS BUG, dinfo == 0xffffffff, prim == PH_DATA | CONFIRM !!!!\n"</span>);
<a name="l03540"></a>03540    }
<a name="l03541"></a>03541 
<a name="l03542"></a>03542    <span class="keywordflow">if</span> ( ((frm-&gt;addr | ISDN_PID_BCHANNEL_BIT )&gt;&gt; 28 ) == 0x5) {
<a name="l03543"></a>03543       <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#0ac3358912eb6aa61a27bf5eda636a8a">handle_bchan</a>(msg)) {
<a name="l03544"></a>03544          <span class="keywordflow">return</span> 0 ;
<a name="l03545"></a>03545       }
<a name="l03546"></a>03546    }  
<a name="l03547"></a>03547 
<a name="l03548"></a>03548 <span class="preprocessor">#ifdef RECV_FRM_SYSLOG_DEBUG</span>
<a name="l03549"></a>03549 <span class="preprocessor"></span>   syslog(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>,<span class="stringliteral">"mISDN recv: P(%02d): ADDR:%x PRIM:%x DINFO:%x\n"</span>,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, frm-&gt;addr, frm-&gt;prim, frm-&gt;dinfo);
<a name="l03550"></a>03550 <span class="preprocessor">#endif</span>
<a name="l03551"></a>03551 <span class="preprocessor"></span>
<a name="l03552"></a>03552    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#7e63ba92d5300eae12f270755bcb45db">handle_timers</a>(msg)) 
<a name="l03553"></a>03553       <span class="keywordflow">return</span> 0 ;
<a name="l03554"></a>03554 
<a name="l03555"></a>03555    
<a name="l03556"></a>03556    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#dfd7e658f254d8c23302f8a892c7f0cd">handle_mgmt</a>(msg)) 
<a name="l03557"></a>03557       <span class="keywordflow">return</span> 0 ; 
<a name="l03558"></a>03558    
<a name="l03559"></a>03559    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#69a99dbfc3b3a7005c232acc4a187b5e">handle_l2</a>(msg)) 
<a name="l03560"></a>03560       <span class="keywordflow">return</span> 0 ;
<a name="l03561"></a>03561 
<a name="l03562"></a>03562    <span class="comment">/* Its important to handle l1 AFTER l2  */</span>
<a name="l03563"></a>03563    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#f2ea5bb779324e541c31c82bdd866e57">handle_l1</a>(msg)) 
<a name="l03564"></a>03564       <span class="keywordflow">return</span> 0 ;
<a name="l03565"></a>03565    
<a name="l03566"></a>03566    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#2eb3ec160e02e2061e965f938c5e69a0">handle_frm_nt</a>(msg)) {
<a name="l03567"></a>03567       <span class="keywordflow">return</span> 0;
<a name="l03568"></a>03568    }
<a name="l03569"></a>03569 
<a name="l03570"></a>03570    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#eb6341f3b591db3dbf3a815b38d4be9c">handle_frm</a>(msg)) {
<a name="l03571"></a>03571       <span class="keywordflow">return</span> 0;
<a name="l03572"></a>03572    }
<a name="l03573"></a>03573 
<a name="l03574"></a>03574    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#f7320c8c5db54e2eebfe0dcab79ecf5f">handle_err</a>(msg)) {
<a name="l03575"></a>03575       <span class="keywordflow">return</span> 0 ;
<a name="l03576"></a>03576    }
<a name="l03577"></a>03577 
<a name="l03578"></a>03578    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, 0, <span class="stringliteral">"Unhandled Message: prim %x len %d from addr %x, dinfo %x on this port.\n"</span>,frm-&gt;prim, frm-&gt;len, frm-&gt;addr, frm-&gt;dinfo);      
<a name="l03579"></a>03579    free_msg(msg);
<a name="l03580"></a>03580    
<a name="l03581"></a>03581 
<a name="l03582"></a>03582    <span class="keywordflow">return</span> 0;
<a name="l03583"></a>03583 }
<a name="l03584"></a>03584 
<a name="l03585"></a>03585 
<a name="l03586"></a>03586 
<a name="l03587"></a>03587 
<a name="l03588"></a><a class="code" href="isdn__lib_8h.html#400e80b8266dadb7202d77dd73a39cc6">03588</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#400e80b8266dadb7202d77dd73a39cc6">misdn_lib_get_port_info</a>(<span class="keywordtype">int</span> port)
<a name="l03589"></a>03589 {
<a name="l03590"></a>03590    msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03591"></a>03591    iframe_t *frm;
<a name="l03592"></a>03592    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(port);
<a name="l03593"></a>03593    <span class="keywordflow">if</span> (!msg) {
<a name="l03594"></a>03594       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"misgn_lib_get_port: alloc_msg failed!\n"</span>);
<a name="l03595"></a>03595       <span class="keywordflow">return</span> -1;
<a name="l03596"></a>03596    }
<a name="l03597"></a>03597    frm=(iframe_t*)msg-&gt;data;
<a name="l03598"></a>03598    if (!stack ) {
<a name="l03599"></a>03599       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"There is no Stack for this port.\n"</span>);
<a name="l03600"></a>03600       <span class="keywordflow">return</span> -1;
<a name="l03601"></a>03601    }
<a name="l03602"></a>03602    <span class="comment">/* activate bchannel */</span>
<a name="l03603"></a>03603    frm-&gt;prim = CC_STATUS_ENQUIRY | REQUEST;
<a name="l03604"></a>03604 
<a name="l03605"></a>03605    frm-&gt;addr = stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>| FLG_MSG_DOWN;
<a name="l03606"></a>03606 
<a name="l03607"></a>03607    frm-&gt;dinfo = 0;
<a name="l03608"></a>03608    frm-&gt;len = 0;
<a name="l03609"></a>03609   
<a name="l03610"></a>03610    msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>, msg);
<a name="l03611"></a>03611    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03612"></a>03612 
<a name="l03613"></a>03613   
<a name="l03614"></a>03614    <span class="keywordflow">return</span> 0; 
<a name="l03615"></a>03615 }
<a name="l03616"></a>03616 
<a name="l03617"></a>03617 
<a name="l03618"></a><a class="code" href="isdn__lib_8c.html#96c1c5fb3d85510a79f59a8ef1c6c197">03618</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#96c1c5fb3d85510a79f59a8ef1c6c197">queue_cleanup_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc) 
<a name="l03619"></a>03619 {
<a name="l03620"></a>03620    msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03621"></a>03621    iframe_t *frm;
<a name="l03622"></a>03622    <span class="keywordflow">if</span> (!msg) {
<a name="l03623"></a>03623       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"misgn_lib_get_port: alloc_msg failed!\n"</span>);
<a name="l03624"></a>03624       <span class="keywordflow">return</span> -1;
<a name="l03625"></a>03625    }
<a name="l03626"></a>03626    frm=(iframe_t*)msg-&gt;data;
<a name="l03627"></a>03627 
<a name="l03628"></a>03628    <span class="comment">/* activate bchannel */</span>
<a name="l03629"></a>03629    frm-&gt;prim = MGR_CLEARSTACK| REQUEST;
<a name="l03630"></a>03630 
<a name="l03631"></a>03631    frm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>;
<a name="l03632"></a>03632 
<a name="l03633"></a>03633    frm-&gt;dinfo = bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>;
<a name="l03634"></a>03634    frm-&gt;len = 0;
<a name="l03635"></a>03635   
<a name="l03636"></a>03636    msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>, msg);
<a name="l03637"></a>03637    sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03638"></a>03638 
<a name="l03639"></a>03639    <span class="keywordflow">return</span> 0; 
<a name="l03640"></a>03640 
<a name="l03641"></a>03641 }
<a name="l03642"></a>03642 
<a name="l03643"></a><a class="code" href="isdn__lib_8c.html#449f547947eebce21c820699c0f5326c">03643</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#449f547947eebce21c820699c0f5326c">misdn_lib_pid_restart</a>(<span class="keywordtype">int</span> pid) 
<a name="l03644"></a>03644 {
<a name="l03645"></a>03645    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#d3554db5772822adaa03902792e06f57">manager_find_bc_by_pid</a>(pid);
<a name="l03646"></a>03646 
<a name="l03647"></a>03647    <span class="keywordflow">if</span> (bc) {
<a name="l03648"></a>03648       <a class="code" href="isdn__lib_8c.html#b1f3ab8ba10db916482da4b0a13327c2">manager_clean_bc</a>(bc);
<a name="l03649"></a>03649    }
<a name="l03650"></a>03650    <span class="keywordflow">return</span> 0;
<a name="l03651"></a>03651 }
<a name="l03652"></a>03652 
<a name="l03653"></a><a class="code" href="isdn__lib_8c.html#77381a12dae61feb0646a27e8fcfc8d4">03653</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#77381a12dae61feb0646a27e8fcfc8d4">misdn_lib_port_restart</a>(<span class="keywordtype">int</span> port)
<a name="l03654"></a>03654 {
<a name="l03655"></a>03655    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(port);
<a name="l03656"></a>03656  
<a name="l03657"></a>03657    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"Restarting this port.\n"</span>);
<a name="l03658"></a>03658    <span class="keywordflow">if</span> (stack) {
<a name="l03659"></a>03659       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"Stack:%p\n"</span>,stack);
<a name="l03660"></a>03660          
<a name="l03661"></a>03661       <a class="code" href="isdn__lib_8c.html#4ca6bc0fd37653def2f1ebeea7703bf2">clear_l3</a>(stack);
<a name="l03662"></a>03662       {
<a name="l03663"></a>03663          msg_t *msg=alloc_msg(MAX_MSG_SIZE);
<a name="l03664"></a>03664          iframe_t *frm;
<a name="l03665"></a>03665 
<a name="l03666"></a>03666          <span class="keywordflow">if</span> (!msg) {
<a name="l03667"></a>03667             <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"port_restart: alloc_msg failed\n"</span>);
<a name="l03668"></a>03668             <span class="keywordflow">return</span> -1;
<a name="l03669"></a>03669          }
<a name="l03670"></a>03670          
<a name="l03671"></a>03671          frm=(iframe_t*)msg-&gt;data;
<a name="l03672"></a>03672          <span class="comment">/* we must activate if we are deactivated */</span>
<a name="l03673"></a>03673          <span class="comment">/* activate bchannel */</span>
<a name="l03674"></a>03674          frm-&gt;prim = DL_RELEASE | REQUEST;
<a name="l03675"></a>03675          frm-&gt;addr = stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a> | FLG_MSG_DOWN;
<a name="l03676"></a>03676 
<a name="l03677"></a>03677          frm-&gt;dinfo = 0;
<a name="l03678"></a>03678          frm-&gt;len = 0;
<a name="l03679"></a>03679          msg_queue_tail(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>, msg);
<a name="l03680"></a>03680          sem_post(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03681"></a>03681       }
<a name="l03682"></a>03682 
<a name="l03683"></a>03683       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a>)
<a name="l03684"></a>03684          <a class="code" href="isdn__lib_8c.html#10fa56086895bc30c7c9f197ee9c117e">misdn_lib_reinit_nt_stack</a>(stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>);
<a name="l03685"></a>03685     
<a name="l03686"></a>03686    }
<a name="l03687"></a>03687 
<a name="l03688"></a>03688    <span class="keywordflow">return</span> 0;
<a name="l03689"></a>03689 }
<a name="l03690"></a>03690 
<a name="l03691"></a>03691 
<a name="l03692"></a>03692 
<a name="l03693"></a><a class="code" href="isdn__lib_8c.html#792a362e7ebeebe907a0e9a303a7b96f">03693</a> sem_t <a class="code" href="isdn__lib_8c.html#792a362e7ebeebe907a0e9a303a7b96f">handler_started</a>; 
<a name="l03694"></a>03694 
<a name="l03695"></a><a class="code" href="isdn__lib_8c.html#2d29cfc0ed630650367c7d3d95f57a3e">03695</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#2d29cfc0ed630650367c7d3d95f57a3e">manager_event_handler</a>(<span class="keywordtype">void</span> *arg)
<a name="l03696"></a>03696 {
<a name="l03697"></a>03697    sem_post(&amp;handler_started); 
<a name="l03698"></a>03698    <span class="keywordflow">while</span> (1) {
<a name="l03699"></a>03699       <span class="keyword">struct </span>misdn_stack *stack;
<a name="l03700"></a>03700       msg_t *msg;
<a name="l03701"></a>03701     <span class="comment"></span>
<a name="l03702"></a>03702 <span class="comment">      /** wait for events **/</span>
<a name="l03703"></a>03703       sem_wait(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>);
<a name="l03704"></a>03704     
<a name="l03705"></a>03705       <span class="keywordflow">for</span> (msg=msg_dequeue(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>);
<a name="l03706"></a>03706            msg;
<a name="l03707"></a>03707            msg=msg_dequeue(&amp;glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>)
<a name="l03708"></a>03708          )
<a name="l03709"></a>03709       {
<a name="l03710"></a>03710    
<a name="l03711"></a>03711          iframe_t *frm =  (iframe_t*) msg-&gt;data ;
<a name="l03712"></a>03712 
<a name="l03713"></a>03713          switch ( frm-&gt;prim) {
<a name="l03714"></a>03714 
<a name="l03715"></a>03715          <span class="keywordflow">case</span> MGR_CLEARSTACK | REQUEST:
<a name="l03716"></a>03716             <span class="comment">/*a queued bchannel cleanup*/</span>
<a name="l03717"></a>03717             {
<a name="l03718"></a>03718                <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(frm-&gt;dinfo);
<a name="l03719"></a>03719                <span class="keywordflow">if</span> (!stack) {
<a name="l03720"></a>03720                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,0,<span class="stringliteral">"no stack found with port [%d]!! so we cannot cleanup the bc\n"</span>,frm-&gt;dinfo);
<a name="l03721"></a>03721                   free_msg(msg);
<a name="l03722"></a>03722                   <span class="keywordflow">break</span>;
<a name="l03723"></a>03723                }
<a name="l03724"></a>03724                
<a name="l03725"></a>03725                <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc=<a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack,frm-&gt;addr);
<a name="l03726"></a>03726                <span class="keywordflow">if</span> (bc) {
<a name="l03727"></a>03727                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"CLEARSTACK queued, cleaning up\n"</span>);
<a name="l03728"></a>03728                   <a class="code" href="isdn__lib_8c.html#ea6ad14a36f45687eae6c4b055824a28">clean_up_bc</a>(bc);
<a name="l03729"></a>03729                } <span class="keywordflow">else</span> {
<a name="l03730"></a>03730                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"bc could not be cleaned correctly !! addr [%x]\n"</span>,frm-&gt;addr);
<a name="l03731"></a>03731                }
<a name="l03732"></a>03732             }
<a name="l03733"></a>03733             free_msg(msg); 
<a name="l03734"></a>03734             <span class="keywordflow">break</span>;
<a name="l03735"></a>03735          <span class="keywordflow">case</span> MGR_SETSTACK | REQUEST :
<a name="l03736"></a>03736             <span class="keywordflow">break</span>;
<a name="l03737"></a>03737          <span class="keywordflow">default</span>:
<a name="l03738"></a>03738             mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, frm, mISDN_HEADER_LEN+frm-&gt;len, TIMEOUT_1SEC);
<a name="l03739"></a>03739             free_msg(msg);
<a name="l03740"></a>03740          }
<a name="l03741"></a>03741       }
<a name="l03742"></a>03742 
<a name="l03743"></a>03743       <span class="keywordflow">for</span> (stack=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l03744"></a>03744            stack;
<a name="l03745"></a>03745            stack=stack-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> ) { 
<a name="l03746"></a>03746 
<a name="l03747"></a>03747          <span class="keywordflow">while</span> ( (msg=msg_dequeue(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#5aefa7b509ecc33f833a24377d231fee">upqueue</a>)) ) {<span class="comment"></span>
<a name="l03748"></a>03748 <span class="comment">            /** Handle L2/3 Signalling after bchans **/</span> 
<a name="l03749"></a>03749             <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#2eb3ec160e02e2061e965f938c5e69a0">handle_frm_nt</a>(msg)) {
<a name="l03750"></a>03750                <span class="comment">/* Maybe it's TE */</span>
<a name="l03751"></a>03751                <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#eb6341f3b591db3dbf3a815b38d4be9c">handle_frm</a>(msg)) {
<a name="l03752"></a>03752                   <span class="comment">/* wow none! */</span>
<a name="l03753"></a>03753                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"Wow we've got a strange issue while dequeueing a Frame\n"</span>);
<a name="l03754"></a>03754                }
<a name="l03755"></a>03755             }
<a name="l03756"></a>03756          }
<a name="l03757"></a>03757 
<a name="l03758"></a>03758          <span class="comment">/* Here we should check if we really want to </span>
<a name="l03759"></a>03759 <span class="comment">            send all the messages we've queued, lets </span>
<a name="l03760"></a>03760 <span class="comment">            assume we've queued a Disconnect, but </span>
<a name="l03761"></a>03761 <span class="comment">            received it already from the other side!*/</span>
<a name="l03762"></a>03762            
<a name="l03763"></a>03763          <span class="keywordflow">while</span> ( (msg=msg_dequeue(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#18e8b7ec18aada3301aedec1abc1bdc6">downqueue</a>)) ) {
<a name="l03764"></a>03764             <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#25930e3036f13852cb0b29694bbab611">nt</a> ) {
<a name="l03765"></a>03765                <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager_l3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, msg))
<a name="l03766"></a>03766                   <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Error@ Sending Message in NT-Stack.\n"</span>);
<a name="l03767"></a>03767      
<a name="l03768"></a>03768             } <span class="keywordflow">else</span> {
<a name="l03769"></a>03769                iframe_t *frm = (iframe_t *)msg-&gt;data;
<a name="l03770"></a>03770                <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc = <a class="code" href="isdn__lib_8c.html#71a5c91b3f674bb07b6573e9fafc01f1">find_bc_by_l3id</a>(stack, frm-&gt;dinfo);
<a name="l03771"></a>03771                <span class="keywordflow">if</span> (bc) <a class="code" href="isdn__lib_8c.html#2a33a89434457ffc1aa0211edf843e1a">send_msg</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, bc, msg);
<a name="l03772"></a>03772             }
<a name="l03773"></a>03773          }
<a name="l03774"></a>03774       }
<a name="l03775"></a>03775    }
<a name="l03776"></a>03776 }
<a name="l03777"></a>03777 
<a name="l03778"></a>03778 
<a name="l03779"></a><a class="code" href="isdn__lib_8h.html#144da951cdcfaf303b6550448ad3c1c9">03779</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#e3d23de1999c84783a1180e41829424d">misdn_lib_maxports_get</a>() { <span class="comment">/** BE AWARE WE HAVE NO CB_LOG HERE! **/</span>
<a name="l03780"></a>03780    
<a name="l03781"></a>03781    <span class="keywordtype">int</span> i = mISDN_open();
<a name="l03782"></a>03782    <span class="keywordtype">int</span> max=0;
<a name="l03783"></a>03783    
<a name="l03784"></a>03784    <span class="keywordflow">if</span> (i&lt;0)
<a name="l03785"></a>03785       <span class="keywordflow">return</span> -1;
<a name="l03786"></a>03786 
<a name="l03787"></a>03787    max = mISDN_get_stack_count(i);
<a name="l03788"></a>03788    
<a name="l03789"></a>03789    mISDN_close(i);
<a name="l03790"></a>03790    
<a name="l03791"></a>03791    <span class="keywordflow">return</span> max;
<a name="l03792"></a>03792 }
<a name="l03793"></a>03793 
<a name="l03794"></a>03794 
<a name="l03795"></a><a class="code" href="isdn__lib_8h.html#61f18f0acdd8f5194f188b6f94f7b02d">03795</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#61f18f0acdd8f5194f188b6f94f7b02d">misdn_lib_nt_debug_init</a>( <span class="keywordtype">int</span> flags, <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a> ) 
<a name="l03796"></a>03796 {
<a name="l03797"></a>03797    <span class="keywordtype">int</span> <span class="keyword">static</span> init=0;
<a name="l03798"></a>03798    <span class="keywordtype">char</span> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l03799"></a>03799    
<a name="l03800"></a>03800    <span class="keywordflow">if</span> (!flags) 
<a name="l03801"></a>03801       f=NULL;
<a name="l03802"></a>03802    <span class="keywordflow">else</span>
<a name="l03803"></a>03803       f=file;
<a name="l03804"></a>03804 
<a name="l03805"></a>03805    <span class="keywordflow">if</span> (!init) {
<a name="l03806"></a>03806       debug_init( flags , f, f, f);
<a name="l03807"></a>03807       init=1;
<a name="l03808"></a>03808    } <span class="keywordflow">else</span> {
<a name="l03809"></a>03809       debug_close();
<a name="l03810"></a>03810       debug_init( flags , f, f, f);
<a name="l03811"></a>03811    }
<a name="l03812"></a>03812 }
<a name="l03813"></a>03813 
<a name="l03814"></a>03814 
<a name="l03815"></a><a class="code" href="isdn__lib_8h.html#9ccf9116616b0845c392cb59b26209a7">03815</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#9ccf9116616b0845c392cb59b26209a7">misdn_lib_init</a>(<span class="keywordtype">char</span> *portlist, <span class="keyword">struct</span> <a class="code" href="structmisdn__lib__iface.html">misdn_lib_iface</a> *iface, <span class="keywordtype">void</span> *user_data)
<a name="l03816"></a>03816 {
<a name="l03817"></a>03817    <span class="keyword">struct </span><a class="code" href="structmisdn__lib.html">misdn_lib</a> *mgr=<a class="code" href="astmm_8h.html#b9d011ff8b105f2850962f2003da06d9">calloc</a>(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmisdn__lib.html">misdn_lib</a>));
<a name="l03818"></a>03818    <span class="keywordtype">char</span> *tok, *tokb;
<a name="l03819"></a>03819    <span class="keywordtype">char</span> plist[1024];
<a name="l03820"></a>03820    <span class="keywordtype">int</span> midev;
<a name="l03821"></a>03821    <span class="keywordtype">int</span> port_count=0;
<a name="l03822"></a>03822  
<a name="l03823"></a>03823    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#83db1523eb652126bd05292c904f7986">cb_log</a>;
<a name="l03824"></a>03824    <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#111db68222f812912c8197f5561df0bd">cb_event</a>;
<a name="l03825"></a>03825    <a class="code" href="isdn__lib_8h.html#cd6359ea6dc1d15e696e389ca8c501bf">cb_jb_empty</a> = iface-&gt;<a class="code" href="structmisdn__lib__iface.html#cd6359ea6dc1d15e696e389ca8c501bf">cb_jb_empty</a>;
<a name="l03826"></a>03826    
<a name="l03827"></a>03827    glob_mgr = mgr;
<a name="l03828"></a>03828   
<a name="l03829"></a>03829    msg_init();
<a name="l03830"></a>03830 
<a name="l03831"></a>03831    <a class="code" href="isdn__lib_8c.html#61f18f0acdd8f5194f188b6f94f7b02d">misdn_lib_nt_debug_init</a>(0,NULL);
<a name="l03832"></a>03832    
<a name="l03833"></a>03833    <span class="keywordflow">if</span> (!portlist || (*portlist == 0) ) <span class="keywordflow">return</span> 1;
<a name="l03834"></a>03834    
<a name="l03835"></a>03835    <a class="code" href="isdn__lib_8c.html#5005e9c2029af4b07d38c2b3f13aefba">init_flip_bits</a>();
<a name="l03836"></a>03836    
<a name="l03837"></a>03837    {
<a name="l03838"></a>03838       strncpy(plist,portlist, 1024);
<a name="l03839"></a>03839       plist[1023] = 0;
<a name="l03840"></a>03840    }
<a name="l03841"></a>03841   
<a name="l03842"></a>03842    memcpy(<a class="code" href="isdn__lib_8c.html#1fd9ac86cfafe1f47de45cfadce08968">tone_425_flip</a>,tone_425,TONE_425_SIZE);
<a name="l03843"></a>03843    <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a>(<a class="code" href="isdn__lib_8c.html#1fd9ac86cfafe1f47de45cfadce08968">tone_425_flip</a>,TONE_425_SIZE);
<a name="l03844"></a>03844 
<a name="l03845"></a>03845    memcpy(<a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">tone_silence_flip</a>,tone_SILENCE,TONE_SILENCE_SIZE);
<a name="l03846"></a>03846    <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a>(<a class="code" href="isdn__lib_8c.html#d50cf8b8f47af07360d501340ec95b16">tone_silence_flip</a>,TONE_SILENCE_SIZE);
<a name="l03847"></a>03847   
<a name="l03848"></a>03848    midev=<a class="code" href="isdn__lib_8c.html#cb8e372f8838eb8a4f90860340f94828">te_lib_init</a>();
<a name="l03849"></a>03849    mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>=midev;
<a name="l03850"></a>03850 
<a name="l03851"></a>03851    port_count=mISDN_get_stack_count(midev);
<a name="l03852"></a>03852   
<a name="l03853"></a>03853    msg_queue_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#2a06dc63f0815d79d28b635708d91042">activatequeue</a>);
<a name="l03854"></a>03854   
<a name="l03855"></a>03855    <span class="keywordflow">if</span> (sem_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>, 1, 0)&lt;0)
<a name="l03856"></a>03856       sem_init(&amp;mgr-&gt;<a class="code" href="structmisdn__lib.html#d9f12fef8d658546c3ddcad3780117a0">new_msg</a>, 0, 0);
<a name="l03857"></a>03857  
<a name="l03858"></a>03858    <span class="keywordflow">for</span> (tok=strtok_r(plist,<span class="stringliteral">" ,"</span>,&amp;tokb );
<a name="l03859"></a>03859         tok; 
<a name="l03860"></a>03860         tok=strtok_r(NULL,<span class="stringliteral">" ,"</span>,&amp;tokb)) {
<a name="l03861"></a>03861       <span class="keywordtype">int</span> port = atoi(tok);
<a name="l03862"></a>03862       <span class="keyword">struct </span>misdn_stack *stack;
<a name="l03863"></a>03863       <span class="keyword">static</span> <span class="keywordtype">int</span> first=1;
<a name="l03864"></a>03864       <span class="keywordtype">int</span> ptp=0;
<a name="l03865"></a>03865     
<a name="l03866"></a>03866       <span class="keywordflow">if</span> (strstr(tok, <span class="stringliteral">"ptp"</span>))
<a name="l03867"></a>03867          ptp=1;
<a name="l03868"></a>03868 
<a name="l03869"></a>03869       <span class="keywordflow">if</span> (port &gt; port_count) {
<a name="l03870"></a>03870          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"Couldn't Initialize this port since we have only %d ports\n"</span>, port_count);
<a name="l03871"></a>03871          exit(1);
<a name="l03872"></a>03872       }
<a name="l03873"></a>03873       stack=<a class="code" href="isdn__lib_8c.html#0cbef4e66d833fe125967ad9bdf43dd3">stack_init</a>(midev, port, ptp);
<a name="l03874"></a>03874     
<a name="l03875"></a>03875       <span class="keywordflow">if</span> (!stack) {
<a name="l03876"></a>03876          perror(<span class="stringliteral">"init_stack"</span>);
<a name="l03877"></a>03877          exit(1);
<a name="l03878"></a>03878       }
<a name="l03879"></a>03879     
<a name="l03880"></a>03880       {
<a name="l03881"></a>03881          <span class="keywordtype">int</span> i;
<a name="l03882"></a>03882          <span class="keywordflow">for</span>(i=0;i&lt;=stack-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l03883"></a>03883             <span class="keywordtype">int</span> r;
<a name="l03884"></a>03884             <span class="keywordflow">if</span> ((r=<a class="code" href="isdn__lib_8c.html#d3798d3d9b9e2350bf2efaeb3cf95b0b">init_bc</a>(stack, &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i], stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>,port,i, <span class="stringliteral">""</span>, 1))&lt;0) {
<a name="l03885"></a>03885                <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, port, <span class="stringliteral">"Got Err @ init_bc :%d\n"</span>,r);
<a name="l03886"></a>03886                exit(1);
<a name="l03887"></a>03887             }
<a name="l03888"></a>03888          }
<a name="l03889"></a>03889       }
<a name="l03890"></a>03890 
<a name="l03891"></a>03891       <span class="keywordflow">if</span> (stack &amp;&amp; first) {
<a name="l03892"></a>03892          mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>=stack;
<a name="l03893"></a>03893          first=0;
<a name="l03894"></a>03894          <span class="keywordflow">continue</span>;
<a name="l03895"></a>03895       }
<a name="l03896"></a>03896     
<a name="l03897"></a>03897       <span class="keywordflow">if</span> (stack) {
<a name="l03898"></a>03898          <span class="keyword">struct </span>misdn_stack * help;
<a name="l03899"></a>03899          <span class="keywordflow">for</span> ( help=mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>; help; help=help-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> ) 
<a name="l03900"></a>03900             <span class="keywordflow">if</span> (help-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> == NULL) <span class="keywordflow">break</span>;
<a name="l03901"></a>03901          help-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>=stack;
<a name="l03902"></a>03902       }
<a name="l03903"></a>03903     
<a name="l03904"></a>03904    }
<a name="l03905"></a>03905   
<a name="l03906"></a>03906    <span class="keywordflow">if</span> (sem_init(&amp;handler_started, 1, 0)&lt;0)
<a name="l03907"></a>03907       sem_init(&amp;handler_started, 0, 0);
<a name="l03908"></a>03908   
<a name="l03909"></a>03909    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, 0, <span class="stringliteral">"Starting Event Handler\n"</span>);
<a name="l03910"></a>03910    <a class="code" href="lock_8h.html#e9fe276d50f2a859d0d5048ebaa8abbc">pthread_create</a>( &amp;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>-&gt;event_handler_thread, NULL,(<span class="keywordtype">void</span>*)<a class="code" href="isdn__lib_8c.html#2d29cfc0ed630650367c7d3d95f57a3e">manager_event_handler</a>, <a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>);
<a name="l03911"></a>03911   
<a name="l03912"></a>03912    sem_wait(&amp;handler_started) ;
<a name="l03913"></a>03913    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, 0, <span class="stringliteral">"Starting Event Catcher\n"</span>);
<a name="l03914"></a>03914    <a class="code" href="lock_8h.html#e9fe276d50f2a859d0d5048ebaa8abbc">pthread_create</a>( &amp;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>-&gt;event_thread, NULL, (<span class="keywordtype">void</span>*)<a class="code" href="isdn__lib_8c.html#7c6cd22b15b81f73d23093a5a99a8c35">misdn_lib_isdn_event_catcher</a>, <a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>);
<a name="l03915"></a>03915   
<a name="l03916"></a>03916    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(8, 0, <span class="stringliteral">"Event Catcher started\n"</span>);
<a name="l03917"></a>03917 
<a name="l03918"></a>03918    <a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">global_state</a>= <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c9c9a2ea84f30847e9b04cb5b4e59c862">MISDN_INITIALIZED</a>; 
<a name="l03919"></a>03919   
<a name="l03920"></a>03920    <span class="keywordflow">return</span> (<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a> == NULL);
<a name="l03921"></a>03921 }
<a name="l03922"></a>03922 
<a name="l03923"></a><a class="code" href="isdn__lib_8h.html#cfb3f515bdd2ab0b4b18b4a8d657544e">03923</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a40f79b550b860d8fd2056f2d97b76df">misdn_lib_destroy</a>()
<a name="l03924"></a>03924 {
<a name="l03925"></a>03925    <span class="keyword">struct </span>misdn_stack *help;
<a name="l03926"></a>03926    <span class="keywordtype">int</span> i;
<a name="l03927"></a>03927   
<a name="l03928"></a>03928    <span class="keywordflow">for</span> ( help=glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>; help; help=help-&gt;<a class="code" href="structmisdn__stack.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> ) {
<a name="l03929"></a>03929       <span class="keywordflow">for</span>(i=0;i&lt;=help-&gt;<a class="code" href="structmisdn__stack.html#fc46f30e97487469b436d080c3320d84">b_num</a>; i++) {
<a name="l03930"></a>03930          <span class="keywordtype">char</span> buf[1024];
<a name="l03931"></a>03931          mISDN_write_frame(help-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, help-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>, MGR_DELLAYER | REQUEST, 0, 0, NULL, TIMEOUT_1SEC);
<a name="l03932"></a>03932          help-&gt;<a class="code" href="structmisdn__stack.html#93ea9bd99a54587d3dc3e94be44d9052">bc</a>[i].<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> = 0;
<a name="l03933"></a>03933       }
<a name="l03934"></a>03934       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a> (1, help-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Destroying this port.\n"</span>);
<a name="l03935"></a>03935       <a class="code" href="isdn__lib_8c.html#6fcacd2e3826156000b2c6082ee06050">stack_destroy</a>(help);
<a name="l03936"></a>03936    }
<a name="l03937"></a>03937    
<a name="l03938"></a>03938    <span class="keywordflow">if</span> (<a class="code" href="isdn__lib_8c.html#f33a39542be9bac756867f9e40dc5d6f">global_state</a> == <a class="code" href="isdn__lib_8c.html#575edf039d2885086e8b43918939314c9c9a2ea84f30847e9b04cb5b4e59c862">MISDN_INITIALIZED</a>) {
<a name="l03939"></a>03939       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"Killing Handler Thread\n"</span>);
<a name="l03940"></a>03940       <span class="keywordflow">if</span> ( pthread_cancel(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f29d3e9cc8b1fd09bb4b028d5674dbec">event_handler_thread</a>) == 0 ) {
<a name="l03941"></a>03941          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"Joining Handler Thread\n"</span>);
<a name="l03942"></a>03942          pthread_join(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f29d3e9cc8b1fd09bb4b028d5674dbec">event_handler_thread</a>, NULL);
<a name="l03943"></a>03943       }
<a name="l03944"></a>03944      
<a name="l03945"></a>03945       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"Killing Main Thread\n"</span>);
<a name="l03946"></a>03946       <span class="keywordflow">if</span> ( pthread_cancel(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#13beb04f99cfd9fd4b1d9d303e774eff">event_thread</a>) == 0 ) {
<a name="l03947"></a>03947          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, 0, <span class="stringliteral">"Joining Main Thread\n"</span>);
<a name="l03948"></a>03948          pthread_join(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#13beb04f99cfd9fd4b1d9d303e774eff">event_thread</a>, NULL);
<a name="l03949"></a>03949       }
<a name="l03950"></a>03950    }
<a name="l03951"></a>03951   
<a name="l03952"></a>03952    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, 0, <span class="stringliteral">"Closing mISDN device\n"</span>);
<a name="l03953"></a>03953    <a class="code" href="isdn__lib_8c.html#a3d088c00ea6fe1029a86467bcd36dcb">te_lib_destroy</a>(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>);
<a name="l03954"></a>03954 }
<a name="l03955"></a>03955 
<a name="l03956"></a><a class="code" href="isdn__lib_8h.html#df7bf2f74fe0b1990f5414e581948e45">03956</a> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#df7bf2f74fe0b1990f5414e581948e45">manager_isdn_get_info</a>(<span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0">event_e</a> event)
<a name="l03957"></a>03957 {
<a name="l03958"></a>03958    <span class="keywordflow">return</span> <a class="code" href="isdn__lib__intern_8h.html#2f64349453a1837ca2b081e2174cff4f">isdn_get_info</a>(msgs_g , event, 0);
<a name="l03959"></a>03959 }
<a name="l03960"></a>03960 
<a name="l03961"></a><a class="code" href="isdn__lib_8h.html#7269dc2ef1d0d8ac7858522cdda3c701">03961</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#7269dc2ef1d0d8ac7858522cdda3c701">manager_bchannel_activate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l03962"></a>03962 {
<a name="l03963"></a>03963    <span class="keywordtype">char</span> buf[128];
<a name="l03964"></a>03964 
<a name="l03965"></a>03965    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l03966"></a>03966 
<a name="l03967"></a>03967    <span class="keywordflow">if</span> (!stack) {
<a name="l03968"></a>03968       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"bchannel_activate: Stack not found !"</span>);
<a name="l03969"></a>03969       return ;
<a name="l03970"></a>03970    }
<a name="l03971"></a>03971    
<a name="l03972"></a>03972    <span class="comment">/* we must activate if we are deactivated */</span>
<a name="l03973"></a>03973    clear_ibuffer(bc-&gt;<a class="code" href="structmisdn__bchannel.html#17add620022df3bf225c0d43f4011ef2">astbuf</a>);
<a name="l03974"></a>03974    
<a name="l03975"></a>03975    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ Bchan Activated addr %x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>);
<a name="l03976"></a>03976    
<a name="l03977"></a>03977    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN,  DL_ESTABLISH | REQUEST, 0,0, NULL, TIMEOUT_1SEC);
<a name="l03978"></a>03978 
<a name="l03979"></a>03979    return ;
<a name="l03980"></a>03980 }
<a name="l03981"></a>03981 
<a name="l03982"></a>03982 
<a name="l03983"></a><a class="code" href="isdn__lib_8h.html#14a4f2683ae425c4e4d9d40fd37da78d">03983</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#14a4f2683ae425c4e4d9d40fd37da78d">manager_bchannel_deactivate</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc)
<a name="l03984"></a>03984 {
<a name="l03985"></a>03985 
<a name="l03986"></a>03986    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l03987"></a>03987 
<a name="l03988"></a>03988 
<a name="l03989"></a>03989    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>) {
<a name="l03990"></a>03990       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>:
<a name="l03991"></a>03991          <span class="keywordflow">break</span>;
<a name="l03992"></a>03992       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>:
<a name="l03993"></a>03993          <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>(bc,bc-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>);
<a name="l03994"></a>03994          <span class="keywordflow">break</span>;
<a name="l03995"></a>03995       <span class="keywordflow">default</span>:
<a name="l03996"></a>03996          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>( 4, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"bchan_deactivate: called but not activated\n"</span>);
<a name="l03997"></a>03997          return ;
<a name="l03998"></a>03998 
<a name="l03999"></a>03999    }
<a name="l04000"></a>04000    
<a name="l04001"></a>04001    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(5, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"$$$ Bchan deActivated addr %x\n"</span>, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>);
<a name="l04002"></a>04002    
<a name="l04003"></a>04003    bc-&gt;<a class="code" href="structmisdn__bchannel.html#bf9179cd881ae878dddfa78dd01baf7a">generate_tone</a>=0;
<a name="l04004"></a>04004    
<a name="l04005"></a>04005    iframe_t dact;
<a name="l04006"></a>04006    dact.prim = DL_RELEASE | REQUEST;
<a name="l04007"></a>04007    dact.addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN;
<a name="l04008"></a>04008    dact.dinfo = 0;
<a name="l04009"></a>04009    dact.len = 0;
<a name="l04010"></a>04010    <span class="keywordtype">char</span> buf[128]; 
<a name="l04011"></a>04011    mISDN_write_frame(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN, DL_RELEASE|REQUEST,0,0,NULL, TIMEOUT_1SEC);
<a name="l04012"></a>04012 
<a name="l04013"></a>04013    clear_ibuffer(bc-&gt;<a class="code" href="structmisdn__bchannel.html#17add620022df3bf225c0d43f4011ef2">astbuf</a>);
<a name="l04014"></a>04014    
<a name="l04015"></a>04015    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2818f3da7fccfd350072ca0c6df45b221f">BCHAN_RELEASE</a>);
<a name="l04016"></a>04016   
<a name="l04017"></a>04017    <span class="keywordflow">return</span>;
<a name="l04018"></a>04018 }
<a name="l04019"></a>04019 
<a name="l04020"></a>04020 
<a name="l04021"></a><a class="code" href="isdn__lib_8h.html#ab6714c35b67b2f0b33bc9249cd0be38">04021</a> <span class="keywordtype">int</span> <a class="code" href="isdn__lib_8c.html#ab6714c35b67b2f0b33bc9249cd0be38">misdn_lib_tx2misdn_frm</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> len)
<a name="l04022"></a>04022 {
<a name="l04023"></a>04023    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l04024"></a>04024 
<a name="l04025"></a>04025    <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>) {
<a name="l04026"></a>04026       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>:
<a name="l04027"></a>04027       <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>:
<a name="l04028"></a>04028          <span class="keywordflow">break</span>;
<a name="l04029"></a>04029       <span class="keywordflow">default</span>:
<a name="l04030"></a>04030          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"BC not yet activated (state:%s)\n"</span>,<a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#5106bc27bed60661fa4739cb8487ec1f">bc_state</a>));
<a name="l04031"></a>04031          <span class="keywordflow">return</span> -1;
<a name="l04032"></a>04032    }
<a name="l04033"></a>04033    
<a name="l04034"></a>04034    <span class="keywordtype">char</span> buf[4096 + mISDN_HEADER_LEN];
<a name="l04035"></a>04035    iframe_t *frm= (iframe_t*)buf;
<a name="l04036"></a>04036    <span class="keywordtype">int</span>  r;
<a name="l04037"></a>04037    
<a name="l04038"></a>04038    frm-&gt;prim = DL_DATA|REQUEST;
<a name="l04039"></a>04039    frm-&gt;dinfo = 0;
<a name="l04040"></a>04040    frm-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN ;
<a name="l04041"></a>04041    
<a name="l04042"></a>04042    frm-&gt;len = len;
<a name="l04043"></a>04043    memcpy(&amp;buf[mISDN_HEADER_LEN], data,len);
<a name="l04044"></a>04044       
<a name="l04045"></a>04045    <span class="keywordflow">if</span> ( <a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>) ) 
<a name="l04046"></a>04046       <a class="code" href="isdn__lib_8c.html#901133ba5e5aa33801054e4bb3d6ba62">flip_buf_bits</a>( &amp;buf[mISDN_HEADER_LEN], len);
<a name="l04047"></a>04047    <span class="keywordflow">else</span>
<a name="l04048"></a>04048       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(6, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Writing %d data bytes\n"</span>,len);
<a name="l04049"></a>04049    
<a name="l04050"></a>04050    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(9, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Writing %d bytes 2 mISDN\n"</span>,len);
<a name="l04051"></a>04051    r=mISDN_write(stack-&gt;<a class="code" href="structmisdn__stack.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, buf, frm-&gt;len + mISDN_HEADER_LEN, TIMEOUT_INFINIT);
<a name="l04052"></a>04052    <span class="keywordflow">return</span> 0;
<a name="l04053"></a>04053 }
<a name="l04054"></a>04054 
<a name="l04055"></a>04055 
<a name="l04056"></a>04056 
<a name="l04057"></a>04057 <span class="comment">/*</span>
<a name="l04058"></a>04058 <span class="comment"> * send control information to the channel (dsp-module)</span>
<a name="l04059"></a>04059 <span class="comment"> */</span>
<a name="l04060"></a><a class="code" href="isdn__lib_8h.html#1d5d357dc13230857a50aa50b0422387">04060</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">int</span> c2)
<a name="l04061"></a>04061 {
<a name="l04062"></a>04062    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[mISDN_HEADER_LEN+2*<span class="keyword">sizeof</span>(int)];
<a name="l04063"></a>04063    iframe_t *ctrl = (iframe_t *)buffer; <span class="comment">/* preload data */</span>
<a name="l04064"></a>04064    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *d = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)&amp;ctrl-&gt;data.p;
<a name="l04065"></a>04065    <span class="comment">/*struct misdn_stack *stack=get_stack_by_bc(bc);*/</span>
<a name="l04066"></a>04066    
<a name="l04067"></a>04067    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,<span class="stringliteral">"ph_control: c1:%x c2:%x\n"</span>,c1,c2);
<a name="l04068"></a>04068    
<a name="l04069"></a>04069    ctrl-&gt;prim = PH_CONTROL | REQUEST;
<a name="l04070"></a>04070    ctrl-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN;
<a name="l04071"></a>04071    ctrl-&gt;dinfo = 0;
<a name="l04072"></a>04072    ctrl-&gt;len = <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int)*2;
<a name="l04073"></a>04073    *d++ = c1;
<a name="l04074"></a>04074    *d++ = c2;
<a name="l04075"></a>04075    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, ctrl, mISDN_HEADER_LEN+ctrl-&gt;len, TIMEOUT_1SEC);
<a name="l04076"></a>04076 }
<a name="l04077"></a>04077 
<a name="l04078"></a>04078 <span class="comment">/*</span>
<a name="l04079"></a>04079 <span class="comment"> * allow live control of channel parameters</span>
<a name="l04080"></a>04080 <span class="comment"> */</span>
<a name="l04081"></a><a class="code" href="isdn__lib_8h.html#a20a72e72814c35c94909eed61a8b999">04081</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#a20a72e72814c35c94909eed61a8b999">isdn_lib_update_rxgain</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04082"></a>04082 {
<a name="l04083"></a>04083    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_RX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#eb0c02db2a6613380285582cce7496e4">rxgain</a>);
<a name="l04084"></a>04084 }
<a name="l04085"></a>04085 
<a name="l04086"></a><a class="code" href="isdn__lib_8h.html#e6700440775c9f16f9f3bf6ef8dadbb3">04086</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#e6700440775c9f16f9f3bf6ef8dadbb3">isdn_lib_update_txgain</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04087"></a>04087 {
<a name="l04088"></a>04088    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, VOL_CHANGE_TX, bc-&gt;<a class="code" href="structmisdn__bchannel.html#8b234950151fb2e20655a5369eac565c">txgain</a>);
<a name="l04089"></a>04089 }
<a name="l04090"></a>04090 
<a name="l04091"></a><a class="code" href="isdn__lib_8h.html#5952f793fd04e3cba901e0233d61cda7">04091</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#5952f793fd04e3cba901e0233d61cda7">isdn_lib_update_ec</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04092"></a>04092 {
<a name="l04093"></a>04093 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04094"></a>04094 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (*bc-&gt;pipeline)
<a name="l04095"></a>04095 <span class="preprocessor">#else</span>
<a name="l04096"></a>04096 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2e8ad049ef7d1c9369a0ff3d65185ca">ec_enable</a>)
<a name="l04097"></a>04097 <span class="preprocessor">#endif</span>
<a name="l04098"></a>04098 <span class="preprocessor"></span>      <a class="code" href="isdn__lib_8c.html#1a03f86fc5f61c756e7f189cdf873971">manager_ec_enable</a>(bc);
<a name="l04099"></a>04099    <span class="keywordflow">else</span>
<a name="l04100"></a>04100       <a class="code" href="isdn__lib_8c.html#206f7c8231feea70c091e1af0c907c7c">manager_ec_disable</a>(bc);
<a name="l04101"></a>04101 }
<a name="l04102"></a>04102 
<a name="l04103"></a><a class="code" href="isdn__lib_8h.html#ddda6ccb3316411e5b2764f7a235375e">04103</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#ddda6ccb3316411e5b2764f7a235375e">isdn_lib_stop_dtmf</a> (<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04104"></a>04104 {
<a name="l04105"></a>04105    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, DTMF_TONE_STOP, 0);
<a name="l04106"></a>04106 }
<a name="l04107"></a>04107 
<a name="l04108"></a>04108 <span class="comment">/*</span>
<a name="l04109"></a>04109 <span class="comment"> * send control information to the channel (dsp-module)</span>
<a name="l04110"></a>04110 <span class="comment"> */</span>
<a name="l04111"></a><a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">04111</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> c1, <span class="keywordtype">void</span> *c2, <span class="keywordtype">int</span> c2_len)
<a name="l04112"></a>04112 {
<a name="l04113"></a>04113    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[mISDN_HEADER_LEN+<span class="keyword">sizeof</span>(int)+c2_len];
<a name="l04114"></a>04114    iframe_t *ctrl = (iframe_t *)buffer;
<a name="l04115"></a>04115    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *d = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)&amp;ctrl-&gt;data.p;
<a name="l04116"></a>04116    <span class="comment">/*struct misdn_stack *stack=get_stack_by_bc(bc);*/</span>
<a name="l04117"></a>04117    
<a name="l04118"></a>04118    ctrl-&gt;prim = PH_CONTROL | REQUEST;
<a name="l04119"></a>04119    ctrl-&gt;addr = bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a> | FLG_MSG_DOWN;
<a name="l04120"></a>04120    ctrl-&gt;dinfo = 0;
<a name="l04121"></a>04121    ctrl-&gt;len = <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) + c2_len;
<a name="l04122"></a>04122    *d++ = c1;
<a name="l04123"></a>04123    memcpy(d, c2, c2_len);
<a name="l04124"></a>04124    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, ctrl, mISDN_HEADER_LEN+ctrl-&gt;len, TIMEOUT_1SEC);
<a name="l04125"></a>04125 }
<a name="l04126"></a>04126 
<a name="l04127"></a>04127 
<a name="l04128"></a>04128 
<a name="l04129"></a>04129 
<a name="l04130"></a><a class="code" href="isdn__lib_8c.html#b1f3ab8ba10db916482da4b0a13327c2">04130</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#b1f3ab8ba10db916482da4b0a13327c2">manager_clean_bc</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc )
<a name="l04131"></a>04131 {
<a name="l04132"></a>04132    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l04133"></a>04133    
<a name="l04134"></a>04134    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>&gt;0)
<a name="l04135"></a>04135       <a class="code" href="isdn__lib_8c.html#2fbb28e5a4bfdec158e13bef8aaabaa2">empty_chan_in_stack</a>(stack, bc-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a>);
<a name="l04136"></a>04136    <a class="code" href="isdn__lib_8c.html#d6af9846d0c757e8ad7e69e86aaa2450">empty_bc</a>(bc);
<a name="l04137"></a>04137   
<a name="l04138"></a>04138    <a class="code" href="isdn__lib_8h.html#111db68222f812912c8197f5561df0bd">cb_event</a>(<a class="code" href="isdn__lib_8h.html#22c396eb89baecb58d3a55e7f239a0a0adbb5302858f0ca23b9552f9a5402d26">EVENT_CLEANUP</a>, bc, NULL); 
<a name="l04139"></a>04139 }
<a name="l04140"></a>04140 
<a name="l04141"></a>04141 
<a name="l04142"></a><a class="code" href="isdn__lib_8c.html#efc87b4d843aa2a2f20e6c0131e06eb8">04142</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#efc87b4d843aa2a2f20e6c0131e06eb8">stack_holder_add</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder)
<a name="l04143"></a>04143 {
<a name="l04144"></a>04144    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *help;
<a name="l04145"></a>04145    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: add %x\n"</span>,holder-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>);
<a name="l04146"></a>04146    
<a name="l04147"></a>04147    holder-&gt;<a class="code" href="structmisdn__bchannel.html#5a923a709935aea970aef19dde643058">stack_holder</a>=1;
<a name="l04148"></a>04148 
<a name="l04149"></a>04149    <span class="keywordflow">if</span> (!stack ) return ;
<a name="l04150"></a>04150    
<a name="l04151"></a>04151    holder-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>=NULL;
<a name="l04152"></a>04152    
<a name="l04153"></a>04153    <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>) {
<a name="l04154"></a>04154       stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a> = holder;
<a name="l04155"></a>04155       <span class="keywordflow">return</span>;
<a name="l04156"></a>04156    }
<a name="l04157"></a>04157   
<a name="l04158"></a>04158    <span class="keywordflow">for</span> (help=stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>;
<a name="l04159"></a>04159         help;
<a name="l04160"></a>04160         help=help-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l04161"></a>04161       <span class="keywordflow">if</span> (!help-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l04162"></a>04162          help-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>=holder;
<a name="l04163"></a>04163          <span class="keywordflow">break</span>;
<a name="l04164"></a>04164       }
<a name="l04165"></a>04165    }
<a name="l04166"></a>04166   
<a name="l04167"></a>04167 }
<a name="l04168"></a>04168 
<a name="l04169"></a><a class="code" href="isdn__lib_8c.html#8f698ed84747c21748f7bfae5b539991">04169</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#8f698ed84747c21748f7bfae5b539991">stack_holder_remove</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *holder)
<a name="l04170"></a>04170 {
<a name="l04171"></a>04171    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *h1;
<a name="l04172"></a>04172 
<a name="l04173"></a>04173    <span class="keywordflow">if</span> (!holder-&gt;<a class="code" href="structmisdn__bchannel.html#5a923a709935aea970aef19dde643058">stack_holder</a>) <span class="keywordflow">return</span>;
<a name="l04174"></a>04174    
<a name="l04175"></a>04175    holder-&gt;<a class="code" href="structmisdn__bchannel.html#5a923a709935aea970aef19dde643058">stack_holder</a>=0;
<a name="l04176"></a>04176    
<a name="l04177"></a>04177    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: remove %x\n"</span>,holder-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a>);
<a name="l04178"></a>04178    <span class="keywordflow">if</span> (!stack || ! stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>) <span class="keywordflow">return</span>;
<a name="l04179"></a>04179   
<a name="l04180"></a>04180    <span class="keywordflow">if</span> (holder == stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>) {
<a name="l04181"></a>04181       stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a> = stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l04182"></a>04182       <span class="keywordflow">return</span>;
<a name="l04183"></a>04183    }
<a name="l04184"></a>04184    
<a name="l04185"></a>04185    <span class="keywordflow">for</span> (h1=stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>;
<a name="l04186"></a>04186         h1;
<a name="l04187"></a>04187         h1=h1-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l04188"></a>04188       <span class="keywordflow">if</span> (h1-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> == holder) {
<a name="l04189"></a>04189          h1-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>=h1-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l04190"></a>04190          return ;
<a name="l04191"></a>04191       }
<a name="l04192"></a>04192    }
<a name="l04193"></a>04193 }
<a name="l04194"></a>04194 
<a name="l04195"></a><a class="code" href="isdn__lib_8c.html#7351f32b22751fbee9b1319927173498">04195</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#7351f32b22751fbee9b1319927173498">stack_holder_find_bychan</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l04196"></a>04196 {
<a name="l04197"></a>04197    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *help;
<a name="l04198"></a>04198 
<a name="l04199"></a>04199    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"*HOLDER: find_bychan %c\n"</span>, chan);
<a name="l04200"></a>04200    
<a name="l04201"></a>04201    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> NULL;
<a name="l04202"></a>04202    
<a name="l04203"></a>04203    <span class="keywordflow">for</span> (help=stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>;
<a name="l04204"></a>04204         help;
<a name="l04205"></a>04205         help=help-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l04206"></a>04206       <span class="keywordflow">if</span> (help-&gt;<a class="code" href="structmisdn__bchannel.html#c485d2ed5cc4ce64fcccca710c7a0bb7">channel</a> == chan) {
<a name="l04207"></a>04207          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: found_bychan bc\n"</span>);
<a name="l04208"></a>04208          <span class="keywordflow">return</span> help;
<a name="l04209"></a>04209       }
<a name="l04210"></a>04210    }
<a name="l04211"></a>04211 
<a name="l04212"></a>04212    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: find_bychan nothing\n"</span>);
<a name="l04213"></a>04213    <span class="keywordflow">return</span> NULL;
<a name="l04214"></a>04214 
<a name="l04215"></a>04215 }
<a name="l04216"></a>04216 
<a name="l04217"></a><a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">04217</a> <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *<a class="code" href="isdn__lib_8c.html#38eaf7a699d0157e0d3e9a4ec4c861cd">stack_holder_find</a>(<span class="keyword">struct</span> misdn_stack *stack, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l3id)
<a name="l04218"></a>04218 {
<a name="l04219"></a>04219    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *help;
<a name="l04220"></a>04220 
<a name="l04221"></a>04221    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"*HOLDER: find %x\n"</span>,l3id);
<a name="l04222"></a>04222    
<a name="l04223"></a>04223    <span class="keywordflow">if</span> (!stack) <span class="keywordflow">return</span> NULL;
<a name="l04224"></a>04224    
<a name="l04225"></a>04225    <span class="keywordflow">for</span> (help=stack-&gt;<a class="code" href="structmisdn__stack.html#903921621e3b2408d232cf003aca5612">holding</a>;
<a name="l04226"></a>04226         help;
<a name="l04227"></a>04227         help=help-&gt;<a class="code" href="structmisdn__bchannel.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l04228"></a>04228       <span class="keywordflow">if</span> (help-&gt;<a class="code" href="structmisdn__bchannel.html#e8a86cd25871330f26a3b84a6b4c9b78">l3_id</a> == l3id) {
<a name="l04229"></a>04229          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: found bc\n"</span>);
<a name="l04230"></a>04230          <span class="keywordflow">return</span> help;
<a name="l04231"></a>04231       }
<a name="l04232"></a>04232    }
<a name="l04233"></a>04233 
<a name="l04234"></a>04234    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"*HOLDER: find nothing\n"</span>);
<a name="l04235"></a>04235    <span class="keywordflow">return</span> NULL;
<a name="l04236"></a>04236 }
<a name="l04237"></a>04237 
<a name="l04238"></a>04238 
<a name="l04239"></a>04239 
<a name="l04240"></a><a class="code" href="isdn__lib_8h.html#224ba8a301dabea71a52b7150163a904">04240</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#224ba8a301dabea71a52b7150163a904">misdn_lib_send_tone</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keyword">enum</span> <a class="code" href="isdn__lib_8h.html#d4b64f62bfe3b410f005363b2df188ac">tone_e</a> tone) 
<a name="l04241"></a>04241 {
<a name="l04242"></a>04242 
<a name="l04243"></a>04243    <span class="keywordflow">switch</span>(tone) {
<a name="l04244"></a>04244    <span class="keywordflow">case</span> TONE_DIAL:
<a name="l04245"></a>04245       <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_DIALTONE); 
<a name="l04246"></a>04246    <span class="keywordflow">break</span>;
<a name="l04247"></a>04247    
<a name="l04248"></a>04248    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#d4b64f62bfe3b410f005363b2df188acf359b8f101f0e02281b5edbb0a0f6b1e">TONE_ALERTING</a>:
<a name="l04249"></a>04249       <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_RINGING);  
<a name="l04250"></a>04250    <span class="keywordflow">break</span>;
<a name="l04251"></a>04251    
<a name="l04252"></a>04252    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#d4b64f62bfe3b410f005363b2df188ac5598db308f5d8f1800e84d3ae00bf2ba">TONE_HANGUP</a>:
<a name="l04253"></a>04253       <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, TONE_PATT_ON, TONE_GERMAN_HANGUP);   
<a name="l04254"></a>04254    <span class="keywordflow">break</span>;
<a name="l04255"></a>04255 
<a name="l04256"></a>04256    <span class="keywordflow">case</span> <a class="code" href="isdn__lib_8h.html#d4b64f62bfe3b410f005363b2df188acfd9443b5311a107fddcafe8e9bd3f2be">TONE_NONE</a>:
<a name="l04257"></a>04257    <span class="keywordflow">default</span>:
<a name="l04258"></a>04258       <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, TONE_PATT_OFF, TONE_GERMAN_HANGUP);  
<a name="l04259"></a>04259    }
<a name="l04260"></a>04260 
<a name="l04261"></a>04261    <span class="keywordtype">char</span> buf[mISDN_HEADER_LEN+128];
<a name="l04262"></a>04262    iframe_t *frm=(iframe_t*)buf;
<a name="l04263"></a>04263    memset(buf,0,mISDN_HEADER_LEN+128);
<a name="l04264"></a>04264 
<a name="l04265"></a>04265    frm-&gt;prim=DL_DATA|REQUEST;
<a name="l04266"></a>04266    frm-&gt;addr=bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>|FLG_MSG_DOWN;
<a name="l04267"></a>04267    frm-&gt;dinfo=0;
<a name="l04268"></a>04268    frm-&gt;len=128;
<a name="l04269"></a>04269    
<a name="l04270"></a>04270    mISDN_write(glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>, frm, mISDN_HEADER_LEN+frm-&gt;len, TIMEOUT_1SEC);
<a name="l04271"></a>04271 }
<a name="l04272"></a>04272 
<a name="l04273"></a>04273 
<a name="l04274"></a><a class="code" href="isdn__lib_8h.html#1a03f86fc5f61c756e7f189cdf873971">04274</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#1a03f86fc5f61c756e7f189cdf873971">manager_ec_enable</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04275"></a>04275 {
<a name="l04276"></a>04276    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l04277"></a>04277    
<a name="l04278"></a>04278    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">"ec_enable\n"</span>);
<a name="l04279"></a>04279 
<a name="l04280"></a>04280    <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l04281"></a>04281       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">" --&gt; no speech? cannot enable EC\n"</span>);
<a name="l04282"></a>04282    } <span class="keywordflow">else</span> {
<a name="l04283"></a>04283 
<a name="l04284"></a>04284 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04285"></a>04285 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (*bc-&gt;pipeline) {
<a name="l04286"></a>04286       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">"Sending Control PIPELINE_CFG %s\n"</span>,bc-&gt;pipeline);
<a name="l04287"></a>04287       <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(bc, PIPELINE_CFG, bc-&gt;pipeline, strlen(bc-&gt;pipeline) + 1);
<a name="l04288"></a>04288    }
<a name="l04289"></a>04289 <span class="preprocessor">#else</span>
<a name="l04290"></a>04290 <span class="preprocessor"></span>   <span class="keywordtype">int</span> ec_arr[2];
<a name="l04291"></a>04291 
<a name="l04292"></a>04292    <span class="keywordflow">if</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2e8ad049ef7d1c9369a0ff3d65185ca">ec_enable</a>) {
<a name="l04293"></a>04293       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">"Sending Control ECHOCAN_ON taps:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a>);
<a name="l04294"></a>04294    
<a name="l04295"></a>04295       <span class="keywordflow">switch</span> (bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a>) {
<a name="l04296"></a>04296       <span class="keywordflow">case</span> 4:
<a name="l04297"></a>04297       <span class="keywordflow">case</span> 8:
<a name="l04298"></a>04298       <span class="keywordflow">case</span> 16:
<a name="l04299"></a>04299       <span class="keywordflow">case</span> 32:
<a name="l04300"></a>04300       <span class="keywordflow">case</span> 64:
<a name="l04301"></a>04301       <span class="keywordflow">case</span> 128:
<a name="l04302"></a>04302       <span class="keywordflow">case</span> 256:
<a name="l04303"></a>04303       <span class="keywordflow">case</span> 512:
<a name="l04304"></a>04304       <span class="keywordflow">case</span> 1024:
<a name="l04305"></a>04305          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Taps is %d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a>);
<a name="l04306"></a>04306          <span class="keywordflow">break</span>;
<a name="l04307"></a>04307       <span class="keywordflow">default</span>:
<a name="l04308"></a>04308          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(0, stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Taps should be power of 2\n"</span>);
<a name="l04309"></a>04309          bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a>=128;
<a name="l04310"></a>04310       }
<a name="l04311"></a>04311    
<a name="l04312"></a>04312       ec_arr[0]=bc-&gt;<a class="code" href="structmisdn__bchannel.html#e2997395788cc2b5ae2d69992149583f">ec_deftaps</a>;
<a name="l04313"></a>04313       ec_arr[1]=0;
<a name="l04314"></a>04314       
<a name="l04315"></a>04315       <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(bc,  <a class="code" href="isdn__lib_8c.html#7c05d74d624c742f0a4908f7c9e0c1bc">ECHOCAN_ON</a>,  ec_arr, <span class="keyword">sizeof</span>(ec_arr));
<a name="l04316"></a>04316    }
<a name="l04317"></a>04317 <span class="preprocessor">#endif</span>
<a name="l04318"></a>04318 <span class="preprocessor"></span>   }
<a name="l04319"></a>04319 }
<a name="l04320"></a>04320 
<a name="l04321"></a>04321 
<a name="l04322"></a>04322 
<a name="l04323"></a><a class="code" href="isdn__lib_8h.html#206f7c8231feea70c091e1af0c907c7c">04323</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#206f7c8231feea70c091e1af0c907c7c">manager_ec_disable</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc)
<a name="l04324"></a>04324 {
<a name="l04325"></a>04325    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#c09088b742125e27f2bd18f9bddf80d7">get_stack_by_bc</a>(bc);
<a name="l04326"></a>04326    
<a name="l04327"></a>04327    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0,<span class="stringliteral">" --&gt; ec_disable\n"</span>);
<a name="l04328"></a>04328 
<a name="l04329"></a>04329    <span class="keywordflow">if</span> (!<a class="code" href="isdn__lib_8c.html#a23f050c1c24dd0c5ef51074149350b4">misdn_cap_is_speech</a>(bc-&gt;<a class="code" href="structmisdn__bchannel.html#9a06cb435cd72d31b714e9dbb5c3d168">capability</a>)) {
<a name="l04330"></a>04330       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(1, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">" --&gt; no speech? cannot disable EC\n"</span>);
<a name="l04331"></a>04331       <span class="keywordflow">return</span>;
<a name="l04332"></a>04332    }
<a name="l04333"></a>04333 
<a name="l04334"></a>04334 <span class="preprocessor">#ifdef MISDN_1_2</span>
<a name="l04335"></a>04335 <span class="preprocessor"></span>   <a class="code" href="isdn__lib_8c.html#5bba2f46fa86108cf7215db6b419964c">manager_ph_control_block</a>(bc, PIPELINE_CFG, <span class="stringliteral">""</span>, 0);
<a name="l04336"></a>04336 <span class="preprocessor">#else</span>
<a name="l04337"></a>04337 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( ! bc-&gt;<a class="code" href="structmisdn__bchannel.html#a2e8ad049ef7d1c9369a0ff3d65185ca">ec_enable</a>) {
<a name="l04338"></a>04338       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3, stack?stack-&gt;<a class="code" href="structmisdn__stack.html#901555fb06e346cb065ceb9808dcfc25">port</a>:0, <span class="stringliteral">"Sending Control ECHOCAN_OFF\n"</span>);
<a name="l04339"></a>04339       <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc,  <a class="code" href="isdn__lib_8c.html#b64ad37401d9aa6b038fbb697112c9b5">ECHOCAN_OFF</a>, 0);
<a name="l04340"></a>04340    }
<a name="l04341"></a>04341 <span class="preprocessor">#endif</span>
<a name="l04342"></a>04342 <span class="preprocessor"></span>}
<a name="l04343"></a>04343 
<a name="l04344"></a><a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">04344</a> <span class="keyword">struct </span>misdn_stack* <a class="code" href="isdn__lib_8c.html#6fdd429b02b69948496e4bb4a3b37d9d">get_misdn_stack</a>() {
<a name="l04345"></a>04345    <span class="keywordflow">return</span> glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#a787f45a1b6cd360914476274abd802b">stack_list</a>;
<a name="l04346"></a>04346 }
<a name="l04347"></a>04347 
<a name="l04348"></a>04348 
<a name="l04349"></a>04349 
<a name="l04350"></a><a class="code" href="isdn__lib_8c.html#48b41b5415736e8b85aab525a75d9934">04350</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#48b41b5415736e8b85aab525a75d9934">misdn_join_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id)
<a name="l04351"></a>04351 {
<a name="l04352"></a>04352    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>);
<a name="l04353"></a>04353    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, CMX_RECEIVE_OFF, 0);
<a name="l04354"></a>04354    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, CMX_CONF_JOIN, conf_id);
<a name="l04355"></a>04355 
<a name="l04356"></a>04356    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Joining bc:%x in conf:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>,conf_id);
<a name="l04357"></a>04357 
<a name="l04358"></a>04358    <span class="keywordtype">char</span> data[16];
<a name="l04359"></a>04359    <span class="keywordtype">int</span> len=15;
<a name="l04360"></a>04360 
<a name="l04361"></a>04361    memset(data,0,15);
<a name="l04362"></a>04362    
<a name="l04363"></a>04363    <a class="code" href="isdn__lib_8c.html#ab6714c35b67b2f0b33bc9249cd0be38">misdn_lib_tx2misdn_frm</a>(bc, data, len);
<a name="l04364"></a>04364 
<a name="l04365"></a>04365 }
<a name="l04366"></a>04366 
<a name="l04367"></a>04367 
<a name="l04368"></a><a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">04368</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> conf_id)
<a name="l04369"></a>04369 {
<a name="l04370"></a>04370    <a class="code" href="isdn__lib_8c.html#342648c4b1de37e939f96c6fddefce53">bc_state_change</a>(bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a2809bb5007538d49cccabd61e1d2cdea61">BCHAN_ACTIVATED</a>);
<a name="l04371"></a>04371    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, CMX_RECEIVE_ON, 0);
<a name="l04372"></a>04372    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, CMX_CONF_SPLIT, conf_id);
<a name="l04373"></a>04373 
<a name="l04374"></a>04374    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"Splitting bc:%x in conf:%d\n"</span>,bc-&gt;<a class="code" href="structmisdn__bchannel.html#3ef9a0d7fab5d2bcabf0978c0a35244e">addr</a>,conf_id);
<a name="l04375"></a>04375 }
<a name="l04376"></a>04376 
<a name="l04377"></a><a class="code" href="isdn__lib_8h.html#3f57a5b3a4cff3f1e893781ee12c5a68">04377</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#3f57a5b3a4cff3f1e893781ee12c5a68">misdn_lib_bridge</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc1, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc2) {
<a name="l04378"></a>04378    <span class="keywordtype">int</span> conf_id=bc1-&gt;<a class="code" href="structmisdn__bchannel.html#0db3209e1adc6d67be435a81baf9a66e">pid</a> +1;
<a name="l04379"></a>04379 
<a name="l04380"></a>04380    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, bc1-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">"I Send: BRIDGE from:%d to:%d\n"</span>,bc1-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>,bc2-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>);
<a name="l04381"></a>04381    
<a name="l04382"></a>04382    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc_list[]={
<a name="l04383"></a>04383       bc1,bc2,NULL
<a name="l04384"></a>04384    };
<a name="l04385"></a>04385    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> **bc;
<a name="l04386"></a>04386       
<a name="l04387"></a>04387    <span class="keywordflow">for</span> (bc=bc_list; *bc;  bc++) { 
<a name="l04388"></a>04388       (*bc)-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>=conf_id;
<a name="l04389"></a>04389       <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(4, (*bc)-&gt;port, <span class="stringliteral">" --&gt; bc_addr:%x\n"</span>,(*bc)-&gt;addr);
<a name="l04390"></a>04390    
<a name="l04391"></a>04391       <span class="keywordflow">switch</span>((*bc)-&gt;bc_state) {
<a name="l04392"></a>04392          <span class="keywordflow">case</span> BCHAN_ACTIVATED:
<a name="l04393"></a>04393             <a class="code" href="isdn__lib_8c.html#48b41b5415736e8b85aab525a75d9934">misdn_join_conf</a>(*bc,conf_id);
<a name="l04394"></a>04394             <span class="keywordflow">break</span>;
<a name="l04395"></a>04395          <span class="keywordflow">default</span>:
<a name="l04396"></a>04396             <a class="code" href="isdn__lib_8c.html#961b646b4b3dc79e9f2783b77091c3f2">bc_next_state_change</a>(*bc,<a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>);
<a name="l04397"></a>04397             <span class="keywordflow">break</span>;
<a name="l04398"></a>04398       }
<a name="l04399"></a>04399    }
<a name="l04400"></a>04400 }
<a name="l04401"></a>04401 
<a name="l04402"></a><a class="code" href="isdn__lib_8h.html#8e75283246eaa19d424b79c8afb5e682">04402</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#8e75283246eaa19d424b79c8afb5e682">misdn_lib_split_bridge</a>( <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> * bc1, <span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc2)
<a name="l04403"></a>04403 {
<a name="l04404"></a>04404 
<a name="l04405"></a>04405    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc_list[]={
<a name="l04406"></a>04406       bc1,bc2,NULL
<a name="l04407"></a>04407    };
<a name="l04408"></a>04408    <span class="keyword">struct </span><a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> **bc;
<a name="l04409"></a>04409       
<a name="l04410"></a>04410    <span class="keywordflow">for</span> (bc=bc_list; *bc;  bc++) { 
<a name="l04411"></a>04411       <span class="keywordflow">if</span> ( (*bc)-&gt;bc_state == <a class="code" href="isdn__lib_8h.html#c7924b177fa6972c81d4c7c599cd6a28e65a1df3348951584e804a005d3d78c3">BCHAN_BRIDGED</a>){
<a name="l04412"></a>04412          <a class="code" href="isdn__lib_8c.html#0ca5fe5d28efc5e10698b22b94e5f21c">misdn_split_conf</a>( *bc, (*bc)-&gt;<a class="code" href="structmisdn__bchannel.html#84727239c728029b592b4a83e64ad6ec">conf_id</a>);
<a name="l04413"></a>04413       } <span class="keywordflow">else</span> {
<a name="l04414"></a>04414          <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>( 2, (*bc)-&gt;port, <span class="stringliteral">"BC not bridged (state:%s) so not splitting it\n"</span>,<a class="code" href="isdn__lib_8c.html#03aed91359ce0e4749a32ebd8361d1e8">bc_state2str</a>((*bc)-&gt;bc_state));
<a name="l04415"></a>04415       }
<a name="l04416"></a>04416    }
<a name="l04417"></a>04417    
<a name="l04418"></a>04418 }
<a name="l04419"></a>04419 
<a name="l04420"></a>04420 
<a name="l04421"></a>04421 
<a name="l04422"></a><a class="code" href="isdn__lib_8h.html#762e8d9c869619df3ae9130648335de5">04422</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#762e8d9c869619df3ae9130648335de5">misdn_lib_echo</a>(<span class="keyword">struct</span> <a class="code" href="structmisdn__bchannel.html">misdn_bchannel</a> *bc, <span class="keywordtype">int</span> onoff)
<a name="l04423"></a>04423 {
<a name="l04424"></a>04424    <a class="code" href="isdn__lib_8h.html#83db1523eb652126bd05292c904f7986">cb_log</a>(3,bc-&gt;<a class="code" href="structmisdn__bchannel.html#901555fb06e346cb065ceb9808dcfc25">port</a>, <span class="stringliteral">" --&gt; ECHO %s\n"</span>, onoff?<span class="stringliteral">"ON"</span>:<span class="stringliteral">"OFF"</span>);
<a name="l04425"></a>04425    <a class="code" href="isdn__lib_8c.html#1d5d357dc13230857a50aa50b0422387">manager_ph_control</a>(bc, onoff?CMX_ECHO_ON:CMX_ECHO_OFF, 0);
<a name="l04426"></a>04426 }
<a name="l04427"></a>04427 
<a name="l04428"></a>04428 
<a name="l04429"></a>04429 
<a name="l04430"></a><a class="code" href="isdn__lib_8h.html#10fa56086895bc30c7c9f197ee9c117e">04430</a> <span class="keywordtype">void</span> <a class="code" href="isdn__lib_8c.html#10fa56086895bc30c7c9f197ee9c117e">misdn_lib_reinit_nt_stack</a>(<span class="keywordtype">int</span> port)
<a name="l04431"></a>04431 {
<a name="l04432"></a>04432    <span class="keyword">struct </span>misdn_stack *stack=<a class="code" href="isdn__lib_8c.html#8d87526826cde1a5393b91e38353ff9d">find_stack_by_port</a>(port);
<a name="l04433"></a>04433    
<a name="l04434"></a>04434    <span class="keywordflow">if</span> (stack) {
<a name="l04435"></a>04435       stack-&gt;<a class="code" href="structmisdn__stack.html#ba347684493ba6c1bf099370dfe0a001">l2link</a>=0;
<a name="l04436"></a>04436       stack-&gt;<a class="code" href="structmisdn__stack.html#61326117ed4a9ddf3f754e71e119e5b3">blocked</a>=0;
<a name="l04437"></a>04437    
<a name="l04438"></a>04438       cleanup_Isdnl3(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l04439"></a>04439       cleanup_Isdnl2(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l04440"></a>04440 
<a name="l04441"></a>04441 
<a name="l04442"></a>04442       memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>, 0, <span class="keyword">sizeof</span>(net_stack_t));
<a name="l04443"></a>04443       memset(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>, 0, <span class="keyword">sizeof</span>(manager_t));
<a name="l04444"></a>04444    
<a name="l04445"></a>04445       stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>.nst = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>;
<a name="l04446"></a>04446       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.manager = &amp;stack-&gt;<a class="code" href="structmisdn__stack.html#37bd0d3935b47be2ab57bcf91b57f499">mgr</a>;
<a name="l04447"></a>04447     
<a name="l04448"></a>04448       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l3_manager = <a class="code" href="isdn__lib_8c.html#aedaecc9b13dea611f886e4f0b32db0f">handle_event_nt</a>;
<a name="l04449"></a>04449       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.device = glob_mgr-&gt;<a class="code" href="structmisdn__lib.html#f12a4b5cb2e844c8d2096b6e6465a185">midev</a>;
<a name="l04450"></a>04450       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.cardnr = port;
<a name="l04451"></a>04451       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.d_stid = stack-&gt;<a class="code" href="structmisdn__stack.html#0181f5de0d662076d05026e81ed908b9">d_stid</a>;
<a name="l04452"></a>04452    
<a name="l04453"></a>04453       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature = FEATURE_NET_HOLD;
<a name="l04454"></a>04454       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>)
<a name="l04455"></a>04455          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature |= FEATURE_NET_PTP;
<a name="l04456"></a>04456       <span class="keywordflow">if</span> (stack-&gt;<a class="code" href="structmisdn__stack.html#e060bb629c10e1b143614cc1e9ccdc67">pri</a>)
<a name="l04457"></a>04457          stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.feature |= FEATURE_NET_CRLEN2 | FEATURE_NET_EXTCID;
<a name="l04458"></a>04458       
<a name="l04459"></a>04459       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l1_id = stack-&gt;<a class="code" href="structmisdn__stack.html#e317cc449e1ced7a0862266f4f0673d1">lower_id</a>;
<a name="l04460"></a>04460       stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.l2_id = stack-&gt;<a class="code" href="structmisdn__stack.html#df3a0f25a7ef31691dfb1b0a0eb4d843">upper_id</a>;
<a name="l04461"></a>04461       
<a name="l04462"></a>04462       msg_queue_init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>.down_queue);
<a name="l04463"></a>04463    
<a name="l04464"></a>04464       Isdnl2Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l04465"></a>04465       Isdnl3Init(&amp;stack-&gt;<a class="code" href="structmisdn__stack.html#b26c698cb35f2b5a9a6caceac7a83fdd">nst</a>);
<a name="l04466"></a>04466 
<a name="l04467"></a>04467       <span class="keywordflow">if</span> (!stack-&gt;<a class="code" href="structmisdn__stack.html#be19d835ae8962460c01703fd05ad9ad">ptp</a>)
<a name="l04468"></a>04468          <a class="code" href="isdn__lib_8c.html#6b0358c5413d8f59b5a1388856fbed4f">misdn_lib_get_l1_up</a>(stack);
<a name="l04469"></a>04469       <a class="code" href="isdn__lib_8c.html#de8325a32a10b25703bd7a2de6e7a3e6">misdn_lib_get_l2_up</a>(stack);
<a name="l04470"></a>04470    }
<a name="l04471"></a>04471 }
<a name="l04472"></a>04472 
<a name="l04473"></a>04473 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:44 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
