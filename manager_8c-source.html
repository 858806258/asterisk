<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:45 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>manager.c</h1><a href="manager_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief The Asterisk Management Interface - AMI</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \extref OpenSSL http://www.openssl.org - for AMI/SSL </span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * At the moment this file contains a number of functions, namely:</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * - data structures storing AMI state</span>
<a name="l00030"></a>00030 <span class="comment"> * - AMI-related API functions, used by internal asterisk components</span>
<a name="l00031"></a>00031 <span class="comment"> * - handlers for AMI-related CLI functions</span>
<a name="l00032"></a>00032 <span class="comment"> * - handlers for AMI functions (available through the AMI socket)</span>
<a name="l00033"></a>00033 <span class="comment"> * - the code for the main AMI listener thread and individual session threads</span>
<a name="l00034"></a>00034 <span class="comment"> * - the http handlers invoked for AMI-over-HTTP by the threads in main/http.c</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * \ref amiconf</span>
<a name="l00037"></a>00037 <span class="comment"> */</span>
<a name="l00038"></a>00038 <span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">/*! \addtogroup Group_AMI AMI functions</span>
<a name="l00040"></a>00040 <span class="comment">*/</span><span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">/*! @{</span>
<a name="l00042"></a>00042 <span class="comment"> Doxygen group */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 #include &lt;stdio.h&gt;
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="manager_8h.html">asterisk/manager.h</a>"</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include "<a class="code" href="callerid_8h.html">asterisk/callerid.h</a>"</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">asterisk/md5.h</a>"</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include "<a class="code" href="acl_8h.html">asterisk/acl.h</a>"</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include "<a class="code" href="http_8h.html">asterisk/http.h</a>"</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include "<a class="code" href="version_8h.html">asterisk/version.h</a>"</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include "<a class="code" href="threadstorage_8h.html">asterisk/threadstorage.h</a>"</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include "<a class="code" href="term_8h.html">asterisk/term.h</a>"</span>
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">/*!</span>
<a name="l00085"></a>00085 <span class="comment"> * Linked list of events.</span>
<a name="l00086"></a>00086 <span class="comment"> * Global events are appended to the list by append_event().</span>
<a name="l00087"></a>00087 <span class="comment"> * The usecount is the number of stored pointers to the element,</span>
<a name="l00088"></a>00088 <span class="comment"> * excluding the list pointers. So an element that is only in</span>
<a name="l00089"></a>00089 <span class="comment"> * the list has a usecount of 0, not 1.</span>
<a name="l00090"></a>00090 <span class="comment"> *</span>
<a name="l00091"></a>00091 <span class="comment"> * Clients have a pointer to the last event processed, and for each</span>
<a name="l00092"></a>00092 <span class="comment"> * of these clients we track the usecount of the elements.</span>
<a name="l00093"></a>00093 <span class="comment"> * If we have a pointer to an entry in the list, it is safe to navigate</span>
<a name="l00094"></a>00094 <span class="comment"> * it forward because elements will not be deleted, but only appended.</span>
<a name="l00095"></a>00095 <span class="comment"> * The worst that can happen is seeing the pointer still NULL.</span>
<a name="l00096"></a>00096 <span class="comment"> *</span>
<a name="l00097"></a>00097 <span class="comment"> * When the usecount of an element drops to 0, and the element is the</span>
<a name="l00098"></a>00098 <span class="comment"> * first in the list, we can remove it. Removal is done within the</span>
<a name="l00099"></a>00099 <span class="comment"> * main thread, which is woken up for the purpose.</span>
<a name="l00100"></a>00100 <span class="comment"> *</span>
<a name="l00101"></a>00101 <span class="comment"> * For simplicity of implementation, we make sure the list is never empty.</span>
<a name="l00102"></a>00102 <span class="comment"> */</span>
<a name="l00103"></a><a class="code" href="structeventqent.html">00103</a> <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> {
<a name="l00104"></a><a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">00104</a>    <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a>;     <span class="comment">/*!&lt; # of clients who still need the event */</span>
<a name="l00105"></a><a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">00105</a>    <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>;
<a name="l00106"></a><a class="code" href="structeventqent.html#e068c2de26d760f20cf10afc4b87ef0f">00106</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>; <span class="comment">/*!&lt; sequence number */</span>
<a name="l00107"></a>00107    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(<a class="code" href="structeventqent.html">eventqent</a>) eq_next;
<a name="l00108"></a>00108    <span class="keywordtype">char</span> eventdata[1];   <span class="comment">/*!&lt; really variable size, allocated by append_event() */</span>
<a name="l00109"></a>00109 };
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 static <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(all_events, <a class="code" href="structeventqent.html">eventqent</a>);
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="group__Group__AMI.html#ga3b408e54a36d8024f4861b84f8648fb">00113</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#ga3b408e54a36d8024f4861b84f8648fb">displayconnects</a> = 1;
<a name="l00114"></a><a class="code" href="group__Group__AMI.html#g96f294e808841cbd886011c9d0192687">00114</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g96f294e808841cbd886011c9d0192687">allowmultiplelogin</a>;
<a name="l00115"></a><a class="code" href="group__Group__AMI.html#g846e7158f3a1a166b993bbea7e34c1e0">00115</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g846e7158f3a1a166b993bbea7e34c1e0">timestampevents</a>;
<a name="l00116"></a><a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">00116</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">httptimeout</a> = 60;
<a name="l00117"></a><a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">00117</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a> = 0;
<a name="l00118"></a><a class="code" href="group__Group__AMI.html#ge48c16ca333fc1529958ca58131fd875">00118</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#ge48c16ca333fc1529958ca58131fd875">webmanager_enabled</a> = 0;
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="group__Group__AMI.html#g58780e565b16019054545fbf6ba26a24">00120</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g58780e565b16019054545fbf6ba26a24">block_sockets</a>;
<a name="l00121"></a><a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">00121</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">00123</a> static <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a>;  <span class="comment">/*!&lt; enable some debugging code in the manager */</span>
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">/*! \brief</span>
<a name="l00126"></a>00126 <span class="comment"> * Descriptor for a manager session, either on the AMI socket or over HTTP.</span>
<a name="l00127"></a>00127 <span class="comment"> *</span>
<a name="l00128"></a>00128 <span class="comment"> * \note</span>
<a name="l00129"></a>00129 <span class="comment"> * AMI session have managerid == 0; the entry is created upon a connect,</span>
<a name="l00130"></a>00130 <span class="comment"> * and destroyed with the socket.</span>
<a name="l00131"></a>00131 <span class="comment"> * HTTP sessions have managerid != 0, the value is used as a search key</span>
<a name="l00132"></a>00132 <span class="comment"> * to lookup sessions (using the mansession_id cookie).</span>
<a name="l00133"></a>00133 <span class="comment"> */</span>
<a name="l00134"></a><a class="code" href="group__Group__AMI.html#g7c3e6bc8d40097fbec8dfa709b99eee1">00134</a> static const <span class="keywordtype">char</span> *<a class="code" href="group__Group__AMI.html#g7c3e6bc8d40097fbec8dfa709b99eee1">command_blacklist</a>[] = {
<a name="l00135"></a>00135    <span class="stringliteral">"module load"</span>,
<a name="l00136"></a>00136    <span class="stringliteral">"module unload"</span>,
<a name="l00137"></a>00137 };
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="structmansession.html">00139</a> <span class="keyword">struct </span><a class="code" href="structmansession.html">mansession</a> {
<a name="l00140"></a><a class="code" href="structmansession.html#9aa067f492a8068f4fdce54439f64cd7">00140</a>    pthread_t ms_t;      <span class="comment">/*!&lt; Execution thread, basically useless */</span>
<a name="l00141"></a><a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">00141</a>    <a class="code" href="lock_8h.html#55c65f4d641fac96608dabb20791a062">ast_mutex_t</a> __lock;  <span class="comment">/*!&lt; Thread lock -- don't use in action callbacks, it's already taken care of  */</span>
<a name="l00142"></a>00142             <span class="comment">/* XXX need to document which fields it is protecting */</span>
<a name="l00143"></a><a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">00143</a>    <span class="keyword">struct </span>sockaddr_in sin; <span class="comment">/*!&lt; address we are connecting from */</span>
<a name="l00144"></a><a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">00144</a>    FILE *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;    <span class="comment">/*!&lt; fdopen() on the underlying fd */</span>
<a name="l00145"></a><a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">00145</a>    <span class="keywordtype">int</span> fd;        <span class="comment">/*!&lt; descriptor used for output. Either the socket (AMI) or a temporary file (HTTP) */</span>
<a name="l00146"></a><a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">00146</a>    <span class="keywordtype">int</span> <a class="code" href="pbx__gtkconsole_8c.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a>;     <span class="comment">/*!&lt; number of HTTP sessions using this entry */</span>
<a name="l00147"></a><a class="code" href="structmansession.html#550961e9c744e38a27b28e50d66f595d">00147</a>    <span class="keywordtype">int</span> needdestroy;  <span class="comment">/*!&lt; Whether an HTTP session should be destroyed */</span>
<a name="l00148"></a><a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">00148</a>    pthread_t waiting_thread;  <span class="comment">/*!&lt; Sleeping thread using this descriptor */</span>
<a name="l00149"></a><a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">00149</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> managerid;   <span class="comment">/*!&lt; Unique manager identifier, 0 for AMI sessions */</span>
<a name="l00150"></a><a class="code" href="structmansession.html#cc09d7a7585e6c67ce40707760dd8ba2">00150</a>    time_t sessiontimeout;  <span class="comment">/*!&lt; Session timeout if HTTP */</span>
<a name="l00151"></a><a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">00151</a>    <span class="keywordtype">char</span> <a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>[80];   <span class="comment">/*!&lt; Logged in username */</span>
<a name="l00152"></a><a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">00152</a>    <span class="keywordtype">char</span> challenge[10];  <span class="comment">/*!&lt; Authentication challenge */</span>
<a name="l00153"></a><a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">00153</a>    <span class="keywordtype">int</span> authenticated;   <span class="comment">/*!&lt; Authentication status */</span>
<a name="l00154"></a><a class="code" href="structmansession.html#e12b8f9551a73d6196648b62754aa9e1">00154</a>    <span class="keywordtype">int</span> readperm;     <span class="comment">/*!&lt; Authorization for reading */</span>
<a name="l00155"></a><a class="code" href="structmansession.html#1cc72854e73b9b510a12e993d6479e86">00155</a>    <span class="keywordtype">int</span> writeperm;    <span class="comment">/*!&lt; Authorization for writing */</span>
<a name="l00156"></a><a class="code" href="structmansession.html#62d43bda85ee13dbbf7f0a8a5248533a">00156</a>    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#9453e0669d18369bbc9281cfb2fed1f5">inbuf</a>[1025]; <span class="comment">/*!&lt; Buffer */</span>
<a name="l00157"></a>00157             <span class="comment">/* we use the extra byte to add a '\0' and simplify parsing */</span>
<a name="l00158"></a><a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">00158</a>    <span class="keywordtype">int</span> inlen;     <span class="comment">/*!&lt; number of buffered bytes */</span>
<a name="l00159"></a><a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">00159</a>    <span class="keywordtype">int</span> send_events;  <span class="comment">/*!&lt;  XXX what ? */</span>
<a name="l00160"></a><a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">00160</a>    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *last_ev; <span class="comment">/*!&lt; last event processed. */</span>
<a name="l00161"></a><a class="code" href="structmansession.html#8aa2aeb656bfe257d9d8c38188f42041">00161</a>    <span class="keywordtype">int</span> writetimeout; <span class="comment">/*!&lt; Timeout for ast_carefulwrite() */</span>
<a name="l00162"></a>00162    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(<a class="code" href="structmansession.html">mansession</a>) list;
<a name="l00163"></a>00163 };
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="group__Group__AMI.html#gf074edf91f83d1f06f7e1bb384bb050a">00165</a> #define <a class="code" href="group__Group__AMI.html#gf074edf91f83d1f06f7e1bb384bb050a">NEW_EVENT</a>(m) (<a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(m-&gt;last_ev, eq_next))
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 static <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(<a class="code" href="chan__skinny_8c.html#161bca2e917335e125291a00fd76a80f">sessions</a>, <a class="code" href="structmansession.html">mansession</a>);
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">/*! \brief user descriptor, as read from the config file.</span>
<a name="l00170"></a>00170 <span class="comment"> *</span>
<a name="l00171"></a>00171 <span class="comment"> * \note It is still missing some fields -- e.g. we can have multiple permit and deny</span>
<a name="l00172"></a>00172 <span class="comment"> * lines which are not supported here, and readperm/writeperm/writetimeout</span>
<a name="l00173"></a>00173 <span class="comment"> * are not stored.</span>
<a name="l00174"></a>00174 <span class="comment"> */</span>
<a name="l00175"></a><a class="code" href="structast__manager__user.html">00175</a> struct <a class="code" href="structast__manager__user.html">ast_manager_user</a> {
<a name="l00176"></a><a class="code" href="structast__manager__user.html#5aec535b6e1a39142c62cb283d7f9268">00176</a>    <span class="keywordtype">char</span> <a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>[80];
<a name="l00177"></a><a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">00177</a>    <span class="keywordtype">char</span> *<a class="code" href="chan__h323_8c.html#50419ad6ee05cd17df2fbd6abee06c8b">secret</a>;
<a name="l00178"></a><a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">00178</a>    <span class="keywordtype">char</span> *deny;
<a name="l00179"></a><a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">00179</a>    <span class="keywordtype">char</span> *permit;
<a name="l00180"></a><a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">00180</a>    <span class="keywordtype">char</span> *read;
<a name="l00181"></a><a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">00181</a>    <span class="keywordtype">char</span> *write;
<a name="l00182"></a><a class="code" href="structast__manager__user.html#a3b408e54a36d8024f4861b84f8648fb">00182</a>    <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#ga3b408e54a36d8024f4861b84f8648fb">displayconnects</a>; <span class="comment">/*!&lt; XXX unused */</span>
<a name="l00183"></a><a class="code" href="structast__manager__user.html#18ccf61d533b600bbf5a963359223fe4">00183</a>    <span class="keywordtype">int</span> keep;   <span class="comment">/*!&lt; mark entries created on a reload */</span>
<a name="l00184"></a>00184    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(ast_manager_user) list;
<a name="l00185"></a>00185 };
<a name="l00186"></a>00186 <span class="comment"></span>
<a name="l00187"></a>00187 <span class="comment">/*! \brief list of users found in the config file */</span>
<a name="l00188"></a>00188 static <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(users, ast_manager_user);
<a name="l00189"></a>00189 <span class="comment"></span>
<a name="l00190"></a>00190 <span class="comment">/*! \brief list of actions registered */</span>
<a name="l00191"></a><a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">00191</a> static struct <a class="code" href="structmanager__action.html">manager_action</a> *<a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>;
<a name="l00192"></a>00192 <a class="code" href="lock_8h.html#0a6f04cdf7f74e689a454716e55cb473">AST_RWLOCK_DEFINE_STATIC</a>(actionlock);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 static <a class="code" href="linkedlists_8h.html#a36c903c152ec798053aabc912ee96b3">AST_RWLIST_HEAD_STATIC</a>(manager_hooks, <a class="code" href="structmanager__custom__hook.html">manager_custom_hook</a>);
<a name="l00195"></a>00195 <span class="comment"></span>
<a name="l00196"></a>00196 <span class="comment">/*! \brief Add a custom hook to be called when an event is fired */</span>
<a name="l00197"></a><a class="code" href="group__Group__AMI.html#g6c0dd33a0e93b1a38be809f2e99980e4">00197</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g6c0dd33a0e93b1a38be809f2e99980e4">ast_manager_register_hook</a>(struct manager_custom_hook *hook)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;manager_hooks);
<a name="l00200"></a>00200    <a class="code" href="linkedlists_8h.html#64b41a3e9f2e6a867c09431dfae7ce21">AST_RWLIST_INSERT_TAIL</a>(&amp;manager_hooks, hook, list);
<a name="l00201"></a>00201    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;manager_hooks);
<a name="l00202"></a>00202    <span class="keywordflow">return</span>;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 <span class="comment"></span>
<a name="l00205"></a>00205 <span class="comment">/*! \brief Delete a custom hook to be called when an event is fired */</span>
<a name="l00206"></a><a class="code" href="group__Group__AMI.html#g146f09ab1ed1df560f0ffe8113b3a88d">00206</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g146f09ab1ed1df560f0ffe8113b3a88d">ast_manager_unregister_hook</a>(<span class="keyword">struct</span> <a class="code" href="structmanager__custom__hook.html">manager_custom_hook</a> *hook)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;manager_hooks);
<a name="l00209"></a>00209    <a class="code" href="linkedlists_8h.html#dd27d7fa9f70ab8e5e35161cafdd0459">AST_RWLIST_REMOVE</a>(&amp;manager_hooks, hook, list);
<a name="l00210"></a>00210    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;manager_hooks);
<a name="l00211"></a>00211    <span class="keywordflow">return</span>;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 <span class="comment"></span>
<a name="l00214"></a>00214 <span class="comment">/*! \brief</span>
<a name="l00215"></a>00215 <span class="comment"> * Event list management functions.</span>
<a name="l00216"></a>00216 <span class="comment"> * We assume that the event list always has at least one element,</span>
<a name="l00217"></a>00217 <span class="comment"> * and the delete code will not remove the last entry even if the</span>
<a name="l00218"></a>00218 <span class="comment"> * </span>
<a name="l00219"></a>00219 <span class="comment"> */</span>
<a name="l00220"></a>00220 <span class="preprocessor">#if 0</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="keyword">static</span> time_t __deb(time_t start, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223    time_t now = time(NULL);
<a name="l00224"></a>00224    <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"%4d th %p %s\n"</span>, (<span class="keywordtype">int</span>)(now % 3600), pthread_self(), msg);
<a name="l00225"></a>00225    <span class="keywordflow">if</span> (start != 0 &amp;&amp; now - start &gt; 5)
<a name="l00226"></a>00226       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"+++ WOW, %s took %d seconds\n"</span>, msg, (<span class="keywordtype">int</span>)(now - start));
<a name="l00227"></a>00227    <span class="keywordflow">return</span> now;
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="keyword">static</span> <span class="keywordtype">void</span> LOCK_EVENTS(<span class="keywordtype">void</span>)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232    time_t start = __deb(0, <span class="stringliteral">"about to lock events"</span>);
<a name="l00233"></a>00233    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;all_events);
<a name="l00234"></a>00234    __deb(start, <span class="stringliteral">"done lock events"</span>);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">void</span> UNLOCK_EVENTS(<span class="keywordtype">void</span>)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239    __deb(0, <span class="stringliteral">"about to unlock events"</span>);
<a name="l00240"></a>00240    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;all_events);
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="keyword">static</span> <span class="keywordtype">void</span> LOCK_SESS(<span class="keywordtype">void</span>)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245    time_t start = __deb(0, <span class="stringliteral">"about to lock sessions"</span>);
<a name="l00246"></a>00246    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l00247"></a>00247    __deb(start, <span class="stringliteral">"done lock sessions"</span>);
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="keyword">static</span> <span class="keywordtype">void</span> UNLOCK_SESS(<span class="keywordtype">void</span>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252    __deb(0, <span class="stringliteral">"about to unlock sessions"</span>);
<a name="l00253"></a>00253    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>
<a name="l00257"></a><a class="code" href="group__Group__AMI.html#gd45bb050dddb40e1768551d6be08c1ad">00257</a> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gd45bb050dddb40e1768551d6be08c1ad">check_manager_enabled</a>()
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259    <span class="keywordflow">return</span> <a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a>;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="group__Group__AMI.html#g6fcd08c8c073e9da6c6f96d6663d69d9">00262</a> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g6fcd08c8c073e9da6c6f96d6663d69d9">check_webmanager_enabled</a>()
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264    <span class="keywordflow">return</span> (<a class="code" href="group__Group__AMI.html#ge48c16ca333fc1529958ca58131fd875">webmanager_enabled</a> &amp;&amp; <a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a>);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 <span class="comment"></span>
<a name="l00267"></a>00267 <span class="comment">/*!</span>
<a name="l00268"></a>00268 <span class="comment"> * Grab a reference to the last event, update usecount as needed.</span>
<a name="l00269"></a>00269 <span class="comment"> * Can handle a NULL pointer.</span>
<a name="l00270"></a>00270 <span class="comment"> */</span>
<a name="l00271"></a><a class="code" href="group__Group__AMI.html#g3bc926ccadf91a299fff3f875979895f">00271</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *<a class="code" href="group__Group__AMI.html#g3bc926ccadf91a299fff3f875979895f">grab_last</a>(<span class="keywordtype">void</span>)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *ret;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;all_events);
<a name="l00276"></a>00276    ret = <a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;all_events);
<a name="l00277"></a>00277    <span class="comment">/* the list is never empty now, but may become so when</span>
<a name="l00278"></a>00278 <span class="comment">    * we optimize it in the future, so be prepared.</span>
<a name="l00279"></a>00279 <span class="comment">    */</span>
<a name="l00280"></a>00280    <span class="keywordflow">if</span> (ret)
<a name="l00281"></a>00281       ast_atomic_fetchadd_int(&amp;ret-&gt;<a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a>, 1);
<a name="l00282"></a>00282    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;all_events);
<a name="l00283"></a>00283    <span class="keywordflow">return</span> ret;
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 <span class="comment"></span>
<a name="l00286"></a>00286 <span class="comment">/*!</span>
<a name="l00287"></a>00287 <span class="comment"> * Purge unused events. Remove elements from the head</span>
<a name="l00288"></a>00288 <span class="comment"> * as long as their usecount is 0 and there is a next element.</span>
<a name="l00289"></a>00289 <span class="comment"> */</span>
<a name="l00290"></a><a class="code" href="group__Group__AMI.html#g50cd338ac6ba658c88ad6a7752b556e8">00290</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g50cd338ac6ba658c88ad6a7752b556e8">purge_events</a>(<span class="keywordtype">void</span>)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *ev;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;all_events);
<a name="l00295"></a>00295    <span class="keywordflow">while</span> ( (ev = <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;all_events)) &amp;&amp;
<a name="l00296"></a>00296        ev-&gt;<a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a> == 0 &amp;&amp; <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(ev, eq_next)) {
<a name="l00297"></a>00297       <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;all_events, eq_next);
<a name="l00298"></a>00298       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ev);
<a name="l00299"></a>00299    }
<a name="l00300"></a>00300    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;all_events);
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 <span class="comment"></span>
<a name="l00303"></a>00303 <span class="comment">/*!</span>
<a name="l00304"></a>00304 <span class="comment"> * helper functions to convert back and forth between</span>
<a name="l00305"></a>00305 <span class="comment"> * string and numeric representation of set of flags</span>
<a name="l00306"></a>00306 <span class="comment"> */</span>
<a name="l00307"></a><a class="code" href="structpermalias.html">00307</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpermalias.html">permalias</a> {
<a name="l00308"></a><a class="code" href="structpermalias.html#0fc3cfbc27e91ea60a787de13dae3e3c">00308</a>    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00309"></a><a class="code" href="structpermalias.html#d304ba20e96d87411588eeabac850e34">00309</a>    <span class="keywordtype">char</span> *label;
<a name="l00310"></a>00310 } <a class="code" href="group__Group__AMI.html#g94a45625d6a1e46563105bbad0c894f9">perms</a>[] = {
<a name="l00311"></a>00311    { <a class="code" href="manager_8h.html#440ebd9d80179402b9cd76c426adb8d2">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">"system"</span> },
<a name="l00312"></a>00312    { <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"call"</span> },
<a name="l00313"></a>00313    { <a class="code" href="manager_8h.html#af437953071f12ffe22b0c72f3226b36">EVENT_FLAG_LOG</a>, <span class="stringliteral">"log"</span> },
<a name="l00314"></a>00314    { <a class="code" href="manager_8h.html#f1cf405b1779736dc4e611883809b409">EVENT_FLAG_VERBOSE</a>, <span class="stringliteral">"verbose"</span> },
<a name="l00315"></a>00315    { <a class="code" href="manager_8h.html#055847dde76185d8491133f37610d68d">EVENT_FLAG_COMMAND</a>, <span class="stringliteral">"command"</span> },
<a name="l00316"></a>00316    { <a class="code" href="manager_8h.html#583e421890aa7e205abdcb39885d0b60">EVENT_FLAG_AGENT</a>, <span class="stringliteral">"agent"</span> },
<a name="l00317"></a>00317    { <a class="code" href="manager_8h.html#87a2ec651ddd1db88b41715162d7a242">EVENT_FLAG_USER</a>, <span class="stringliteral">"user"</span> },
<a name="l00318"></a>00318    { <a class="code" href="manager_8h.html#31c33938947056ad055258c5c585812c">EVENT_FLAG_CONFIG</a>, <span class="stringliteral">"config"</span> },
<a name="l00319"></a>00319    { <a class="code" href="manager_8h.html#d069fd0c9177a3b1a91cee305ddbeed3">EVENT_FLAG_DTMF</a>, <span class="stringliteral">"dtmf"</span> },
<a name="l00320"></a>00320    { -1, <span class="stringliteral">"all"</span> },
<a name="l00321"></a>00321    { 0, <span class="stringliteral">"none"</span> },
<a name="l00322"></a>00322 };
<a name="l00323"></a>00323 <span class="comment"></span>
<a name="l00324"></a>00324 <span class="comment">/*! \brief Convert authority code to a list of options */</span>
<a name="l00325"></a><a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">00325</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(<span class="keywordtype">int</span> authority, <span class="keyword">struct</span> <a class="code" href="structast__str.html">ast_str</a> **res)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327    <span class="keywordtype">int</span> i;
<a name="l00328"></a>00328    <span class="keywordtype">char</span> *sep = <span class="stringliteral">""</span>;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330    (*res)-&gt;used = 0;
<a name="l00331"></a>00331    <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keyword">sizeof</span>(<a class="code" href="group__Group__AMI.html#g94a45625d6a1e46563105bbad0c894f9">perms</a>) / <span class="keyword">sizeof</span>(perms[0])) - 1; i++) {
<a name="l00332"></a>00332       <span class="keywordflow">if</span> (authority &amp; perms[i].<a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>) {
<a name="l00333"></a>00333          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(res, 0, <span class="stringliteral">"%s%s"</span>, sep, perms[i].label);
<a name="l00334"></a>00334          sep = <span class="stringliteral">","</span>;
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336    }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338    <span class="keywordflow">if</span> ((*res)-&gt;used == 0)  <span class="comment">/* replace empty string with something sensible */</span>
<a name="l00339"></a>00339       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(res, 0, <span class="stringliteral">"&lt;none&gt;"</span>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341    <span class="keywordflow">return</span> (*res)-&gt;str;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 <span class="comment"></span>
<a name="l00344"></a>00344 <span class="comment">/*! Tells you if smallstr exists inside bigstr</span>
<a name="l00345"></a>00345 <span class="comment">   which is delim by delim and uses no buf or stringsep</span>
<a name="l00346"></a>00346 <span class="comment">   ast_instring("this|that|more","this",'|') == 1;</span>
<a name="l00347"></a>00347 <span class="comment"></span>
<a name="l00348"></a>00348 <span class="comment">   feel free to move this to app.c -anthm */</span>
<a name="l00349"></a><a class="code" href="group__Group__AMI.html#g5084ba51108af1062dd03070916e4990">00349</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g5084ba51108af1062dd03070916e4990">ast_instring</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *bigstr, <span class="keyword">const</span> <span class="keywordtype">char</span> *smallstr, <span class="keyword">const</span> <span class="keywordtype">char</span> delim)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a> = bigstr, *next;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <span class="keywordflow">do</span> {
<a name="l00354"></a>00354       <span class="keywordflow">if</span> ((next = strchr(val, delim))) {
<a name="l00355"></a>00355          <span class="keywordflow">if</span> (!strncmp(val, smallstr, (next - val)))
<a name="l00356"></a>00356             <span class="keywordflow">return</span> 1;
<a name="l00357"></a>00357          <span class="keywordflow">else</span>
<a name="l00358"></a>00358             <span class="keywordflow">continue</span>;
<a name="l00359"></a>00359       } <span class="keywordflow">else</span>
<a name="l00360"></a>00360          <span class="keywordflow">return</span> !strcmp(smallstr, val);
<a name="l00361"></a>00361    } <span class="keywordflow">while</span> (*(val = (next + 1)));
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    <span class="keywordflow">return</span> 0;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a><a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">00366</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *instr)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368    <span class="keywordtype">int</span> x = 0, ret = 0;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370    <span class="keywordflow">if</span> (!instr)
<a name="l00371"></a>00371       <span class="keywordflow">return</span> 0;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <span class="keywordflow">for</span> (x = 0; x &lt; (<span class="keyword">sizeof</span>(<a class="code" href="group__Group__AMI.html#g94a45625d6a1e46563105bbad0c894f9">perms</a>) / <span class="keyword">sizeof</span>(perms[0])); x++) {
<a name="l00374"></a>00374       <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g5084ba51108af1062dd03070916e4990">ast_instring</a>(instr, perms[x].label, <span class="charliteral">','</span>))
<a name="l00375"></a>00375          ret |= perms[x].num;
<a name="l00376"></a>00376    }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378    <span class="keywordflow">return</span> ret;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 <span class="comment"></span>
<a name="l00381"></a>00381 <span class="comment">/*!</span>
<a name="l00382"></a>00382 <span class="comment"> * A number returns itself, false returns 0, true returns all flags,</span>
<a name="l00383"></a>00383 <span class="comment"> * other strings return the flags that are set.</span>
<a name="l00384"></a>00384 <span class="comment"> */</span>
<a name="l00385"></a><a class="code" href="group__Group__AMI.html#g84442272098545210b360ac4f131f10f">00385</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g84442272098545210b360ac4f131f10f">strings_to_mask</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *string)
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387    <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(string))
<a name="l00390"></a>00390       <span class="keywordflow">return</span> -1;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <span class="keywordflow">for</span> (p = string; *p; p++)
<a name="l00393"></a>00393       <span class="keywordflow">if</span> (*p &lt; '0' || *p &gt; <span class="charliteral">'9'</span>)
<a name="l00394"></a>00394          <span class="keywordflow">break</span>;
<a name="l00395"></a>00395    <span class="keywordflow">if</span> (!p)  <span class="comment">/* all digits */</span>
<a name="l00396"></a>00396       <span class="keywordflow">return</span> atoi(string);
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#b293ff11e14865b872f7430896646c2e">ast_false</a>(string))
<a name="l00398"></a>00398       <span class="keywordflow">return</span> 0;
<a name="l00399"></a>00399    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(string)) { <span class="comment">/* all permissions */</span>
<a name="l00400"></a>00400       <span class="keywordtype">int</span> x, ret = 0;
<a name="l00401"></a>00401       <span class="keywordflow">for</span> (x=0; x&lt;<span class="keyword">sizeof</span>(<a class="code" href="group__Group__AMI.html#g94a45625d6a1e46563105bbad0c894f9">perms</a>) / <span class="keyword">sizeof</span>(perms[0]); x++)
<a name="l00402"></a>00402          ret |= perms[x].num;
<a name="l00403"></a>00403       <span class="keywordflow">return</span> ret;
<a name="l00404"></a>00404    }
<a name="l00405"></a>00405    <span class="keywordflow">return</span> <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(string);
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a><a class="code" href="group__Group__AMI.html#g4602d648ab671d826260eb839d90ab26">00408</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="group__Group__AMI.html#g4602d648ab671d826260eb839d90ab26">complete_show_mancmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#6438c669e0d0de98e6929c2cc0fac474">line</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *word, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur;
<a name="l00411"></a>00411    <span class="keywordtype">int</span> l = strlen(word), which = 0;
<a name="l00412"></a>00412    <span class="keywordtype">char</span> *ret = NULL;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;actionlock);
<a name="l00415"></a>00415    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>; cur; cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) { <span class="comment">/* Walk the list of actions */</span>
<a name="l00416"></a>00416       <span class="keywordflow">if</span> (!strncasecmp(word, cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, l) &amp;&amp; ++which &gt; state) {
<a name="l00417"></a>00417          ret = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>);
<a name="l00418"></a>00418          <span class="keywordflow">break</span>;   <span class="comment">/* make sure we exit even if ast_strdup() returns NULL */</span>
<a name="l00419"></a>00419       }
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423    <span class="keywordflow">return</span> ret;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="group__Group__AMI.html#g1889b1316d12271fa30e9f302c0da675">00426</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g1889b1316d12271fa30e9f302c0da675">check_manager_session_inuse</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428    <span class="keyword">struct </span>mansession *session = NULL;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l00431"></a>00431    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, session, list) {
<a name="l00432"></a>00432       <span class="keywordflow">if</span> (!strcasecmp(session-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, name)) 
<a name="l00433"></a>00433          <span class="keywordflow">break</span>;
<a name="l00434"></a>00434    }
<a name="l00435"></a>00435    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="keywordflow">return</span> session ? 1 : 0;
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment"></span>
<a name="l00441"></a>00441 <span class="comment">/*!</span>
<a name="l00442"></a>00442 <span class="comment"> * lookup an entry in the list of registered users.</span>
<a name="l00443"></a>00443 <span class="comment"> * must be called with the list lock held.</span>
<a name="l00444"></a>00444 <span class="comment"> */</span>
<a name="l00445"></a><a class="code" href="group__Group__AMI.html#gcf9022296a6e52672bd7bf89e570c7e0">00445</a> <span class="keyword">static</span> <span class="keyword">struct </span>ast_manager_user *<a class="code" href="group__Group__AMI.html#gcf9022296a6e52672bd7bf89e570c7e0">get_manager_by_name_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447    <span class="keyword">struct </span>ast_manager_user *user = NULL;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;users, user, list)
<a name="l00450"></a>00450       <span class="keywordflow">if</span> (!strcasecmp(user-&gt;<a class="code" href="structast__manager__user.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, name))
<a name="l00451"></a>00451          <span class="keywordflow">break</span>;
<a name="l00452"></a>00452    <span class="keywordflow">return</span> user;
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 <span class="comment"></span>
<a name="l00455"></a>00455 <span class="comment">/*! \note The actionlock is read-locked by the caller of this function */</span>
<a name="l00456"></a><a class="code" href="group__Group__AMI.html#ge553b01c2e0c4bf2d135796bb81c4826">00456</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#ge553b01c2e0c4bf2d135796bb81c4826">handle_showmancmd</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur;
<a name="l00459"></a>00459    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *authority = <a class="code" href="strings_8h.html#15892382538fcffb4bd4216c8956c428">ast_str_alloca</a>(80);
<a name="l00460"></a>00460    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (argc != 4)
<a name="l00463"></a>00463       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>; cur; cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) { <span class="comment">/* Walk the list of actions */</span>
<a name="l00466"></a>00466       <span class="keywordflow">for</span> (num = 3; num &lt; argc; num++) {
<a name="l00467"></a>00467          <span class="keywordflow">if</span> (!strcasecmp(cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, argv[num])) {
<a name="l00468"></a>00468             <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Action: %s\nSynopsis: %s\nPrivilege: %s\n%s\n"</span>,
<a name="l00469"></a>00469                cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, cur-&gt;<a class="code" href="structmanager__action.html#512fbb4e7b617c04031f58b631f2b05d">synopsis</a>,
<a name="l00470"></a>00470                <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(cur-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>, &amp;authority),
<a name="l00471"></a>00471                <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(cur-&gt;<a class="code" href="structmanager__action.html#67daf92c833c41c95db874e18fcb2786">description</a>, <span class="stringliteral">""</span>) );
<a name="l00472"></a>00472          }
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474    }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a><a class="code" href="group__Group__AMI.html#g92af1877a38de15bb9ee5483d0f277f7">00479</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g92af1877a38de15bb9ee5483d0f277f7">handle_mandebug</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00480"></a>00480 {
<a name="l00481"></a>00481    <span class="keywordflow">if</span> (argc == 2)
<a name="l00482"></a>00482       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"manager debug is %s\n"</span>, <a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a>? <span class="stringliteral">"on"</span> : <span class="stringliteral">"off"</span>);
<a name="l00483"></a>00483    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 3) {
<a name="l00484"></a>00484       <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">"on"</span>))
<a name="l00485"></a>00485          <a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a> = 1;
<a name="l00486"></a>00486       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">"off"</span>))
<a name="l00487"></a>00487          <a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a> = 0;
<a name="l00488"></a>00488       <span class="keywordflow">else</span>
<a name="l00489"></a>00489          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00490"></a>00490    }
<a name="l00491"></a>00491    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a><a class="code" href="group__Group__AMI.html#gdcf525aba75386762df1e64fa94431fd">00494</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gdcf525aba75386762df1e64fa94431fd">handle_showmanager</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496    <span class="keyword">struct </span>ast_manager_user *user = NULL;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (argc != 4)
<a name="l00499"></a>00499       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;users);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <span class="keywordflow">if</span> (!(user = <a class="code" href="group__Group__AMI.html#gcf9022296a6e52672bd7bf89e570c7e0">get_manager_by_name_locked</a>(argv[3]))) {
<a name="l00504"></a>00504       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"There is no manager called %s\n"</span>, argv[3]);
<a name="l00505"></a>00505       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;users);
<a name="l00506"></a>00506       <span class="keywordflow">return</span> -1;
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"\n"</span>);
<a name="l00510"></a>00510    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,
<a name="l00511"></a>00511       <span class="stringliteral">"       username: %s\n"</span>
<a name="l00512"></a>00512       <span class="stringliteral">"         secret: %s\n"</span>
<a name="l00513"></a>00513       <span class="stringliteral">"           deny: %s\n"</span>
<a name="l00514"></a>00514       <span class="stringliteral">"         permit: %s\n"</span>
<a name="l00515"></a>00515       <span class="stringliteral">"           read: %s\n"</span>
<a name="l00516"></a>00516       <span class="stringliteral">"          write: %s\n"</span>
<a name="l00517"></a>00517       <span class="stringliteral">"displayconnects: %s\n"</span>,
<a name="l00518"></a>00518       (user-&gt;<a class="code" href="structast__manager__user.html#5aec535b6e1a39142c62cb283d7f9268">username</a> ? user-&gt;<a class="code" href="structast__manager__user.html#5aec535b6e1a39142c62cb283d7f9268">username</a> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00519"></a>00519       (user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a> ? <span class="stringliteral">"&lt;Set&gt;"</span> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00520"></a>00520       (user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a> ? user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00521"></a>00521       (user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a> ? user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00522"></a>00522       (user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a> ? user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00523"></a>00523       (user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a> ? user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a> : <span class="stringliteral">"(N/A)"</span>),
<a name="l00524"></a>00524       (user-&gt;<a class="code" href="structast__manager__user.html#a3b408e54a36d8024f4861b84f8648fb">displayconnects</a> ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>));
<a name="l00525"></a>00525 
<a name="l00526"></a>00526    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;users);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="group__Group__AMI.html#g26d7d1506f2ef8110c9c01f335f07911">00532</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g26d7d1506f2ef8110c9c01f335f07911">handle_showmanagers</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534    <span class="keyword">struct </span>ast_manager_user *user = NULL;
<a name="l00535"></a>00535    <span class="keywordtype">int</span> count_amu = 0;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537    <span class="keywordflow">if</span> (argc != 3)
<a name="l00538"></a>00538       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;users);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542    <span class="comment">/* If there are no users, print out something along those lines */</span>
<a name="l00543"></a>00543    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;users)) {
<a name="l00544"></a>00544       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"There are no manager users.\n"</span>);
<a name="l00545"></a>00545       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;users);
<a name="l00546"></a>00546       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00547"></a>00547    }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\nusername\n--------\n"</span>);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;users, user, list) {
<a name="l00552"></a>00552       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s\n"</span>, user-&gt;<a class="code" href="structast__manager__user.html#5aec535b6e1a39142c62cb283d7f9268">username</a>);
<a name="l00553"></a>00553       count_amu++;
<a name="l00554"></a>00554    }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;users);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"-------------------\n"</span>);
<a name="l00559"></a>00559    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"%d manager users configured.\n"</span>, count_amu);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="comment"></span>
<a name="l00565"></a>00565 <span class="comment">/*! \brief  CLI command  manager list commands */</span>
<a name="l00566"></a><a class="code" href="group__Group__AMI.html#gb93d1c6d033baab667f87c2ec9ff671c">00566</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gb93d1c6d033baab667f87c2ec9ff671c">handle_showmancmds</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur;
<a name="l00569"></a>00569    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *authority = <a class="code" href="strings_8h.html#15892382538fcffb4bd4216c8956c428">ast_str_alloca</a>(80);
<a name="l00570"></a>00570    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = <span class="stringliteral">"  %-15.15s  %-15.15s  %-55.55s\n"</span>;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"Action"</span>, <span class="stringliteral">"Privilege"</span>, <span class="stringliteral">"Synopsis"</span>);
<a name="l00573"></a>00573    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"------"</span>, <span class="stringliteral">"---------"</span>, <span class="stringliteral">"--------"</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;actionlock);
<a name="l00576"></a>00576    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>; cur; cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) <span class="comment">/* Walk the list of actions */</span>
<a name="l00577"></a>00577       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(cur-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>, &amp;authority), cur-&gt;<a class="code" href="structmanager__action.html#512fbb4e7b617c04031f58b631f2b05d">synopsis</a>);
<a name="l00578"></a>00578    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 <span class="comment"></span>
<a name="l00583"></a>00583 <span class="comment">/*! \brief CLI command manager list connected */</span>
<a name="l00584"></a><a class="code" href="group__Group__AMI.html#gb88212ea47b4627cdab59b899f6fb328">00584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gb88212ea47b4627cdab59b899f6fb328">handle_showmanconn</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00587"></a>00587    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = <span class="stringliteral">"  %-15.15s  %-15.15s\n"</span>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"Username"</span>, <span class="stringliteral">"IP Address"</span>);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l00592"></a>00592    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, s, list)
<a name="l00593"></a>00593       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format,s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l00594"></a>00594    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 <span class="comment"></span>
<a name="l00599"></a>00599 <span class="comment">/*! \brief CLI command manager list eventq */</span>
<a name="l00600"></a>00600 <span class="comment">/* Should change to "manager show connected" */</span>
<a name="l00601"></a><a class="code" href="group__Group__AMI.html#g6a11926a741d1c7d51260d13fbc4c74c">00601</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g6a11926a741d1c7d51260d13fbc4c74c">handle_showmaneventq</a>(<span class="keywordtype">int</span> <a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;all_events);
<a name="l00606"></a>00606    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;all_events, s, eq_next) {
<a name="l00607"></a>00607       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Usecount: %d\n"</span>,s-&gt;<a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a>);
<a name="l00608"></a>00608       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Category: %d\n"</span>, s-&gt;<a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>);
<a name="l00609"></a>00609       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Event:\n%s"</span>, s-&gt;eventdata);
<a name="l00610"></a>00610    }
<a name="l00611"></a>00611    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;all_events);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="group__Group__AMI.html#g293b0679af0df6d889fa669b0c0cbdf2">00616</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g293b0679af0df6d889fa669b0c0cbdf2">showmancmd_help</a>[] =
<a name="l00617"></a>00617 <span class="stringliteral">"Usage: manager show command &lt;actionname&gt;\n"</span>
<a name="l00618"></a>00618 <span class="stringliteral">"  Shows the detailed description for a specific Asterisk manager interface command.\n"</span>;
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="group__Group__AMI.html#g9547e3c81ba49eaa71b260516bf756f2">00620</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g9547e3c81ba49eaa71b260516bf756f2">showmancmds_help</a>[] =
<a name="l00621"></a>00621 <span class="stringliteral">"Usage: manager show commands\n"</span>
<a name="l00622"></a>00622 <span class="stringliteral">"  Prints a listing of all the available Asterisk manager interface commands.\n"</span>;
<a name="l00623"></a>00623 
<a name="l00624"></a><a class="code" href="group__Group__AMI.html#g14d45ff06ab8d3edb8c57d75dd7cd939">00624</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g14d45ff06ab8d3edb8c57d75dd7cd939">showmanconn_help</a>[] =
<a name="l00625"></a>00625 <span class="stringliteral">"Usage: manager show connected\n"</span>
<a name="l00626"></a>00626 <span class="stringliteral">"  Prints a listing of the users that are currently connected to the\n"</span>
<a name="l00627"></a>00627 <span class="stringliteral">"Asterisk manager interface.\n"</span>;
<a name="l00628"></a>00628 
<a name="l00629"></a><a class="code" href="group__Group__AMI.html#gcafda953885f99fc273e3097cdc36867">00629</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gcafda953885f99fc273e3097cdc36867">showmaneventq_help</a>[] =
<a name="l00630"></a>00630 <span class="stringliteral">"Usage: manager show eventq\n"</span>
<a name="l00631"></a>00631 <span class="stringliteral">"  Prints a listing of all events pending in the Asterisk manger\n"</span>
<a name="l00632"></a>00632 <span class="stringliteral">"event queue.\n"</span>;
<a name="l00633"></a>00633 
<a name="l00634"></a><a class="code" href="group__Group__AMI.html#g6629e3faec13dd829b44497132cd264c">00634</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g6629e3faec13dd829b44497132cd264c">showmanagers_help</a>[] =
<a name="l00635"></a>00635 <span class="stringliteral">"Usage: manager show users\n"</span>
<a name="l00636"></a>00636 <span class="stringliteral">"       Prints a listing of all managers that are currently configured on that\n"</span>
<a name="l00637"></a>00637 <span class="stringliteral">" system.\n"</span>;
<a name="l00638"></a>00638 
<a name="l00639"></a><a class="code" href="group__Group__AMI.html#gea495796afbed327cab82112a7b06e91">00639</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gea495796afbed327cab82112a7b06e91">showmanager_help</a>[] =
<a name="l00640"></a>00640 <span class="stringliteral">" Usage: manager show user &lt;user&gt;\n"</span>
<a name="l00641"></a>00641 <span class="stringliteral">"        Display all information related to the manager user specified.\n"</span>;
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="group__Group__AMI.html#gc63528124b8cf02a55bec42906b204ca">00643</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_manager[] = {
<a name="l00644"></a>00644    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"command"</span>, NULL },
<a name="l00645"></a>00645    <a class="code" href="group__Group__AMI.html#ge553b01c2e0c4bf2d135796bb81c4826">handle_showmancmd</a>, <span class="stringliteral">"Show a manager interface command"</span>,
<a name="l00646"></a>00646    showmancmd_help, <a class="code" href="group__Group__AMI.html#g4602d648ab671d826260eb839d90ab26">complete_show_mancmd</a> },
<a name="l00647"></a>00647 
<a name="l00648"></a>00648    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"commands"</span>, NULL },
<a name="l00649"></a>00649    <a class="code" href="group__Group__AMI.html#gb93d1c6d033baab667f87c2ec9ff671c">handle_showmancmds</a>, <span class="stringliteral">"List manager interface commands"</span>,
<a name="l00650"></a>00650    showmancmds_help },
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"connected"</span>, NULL },
<a name="l00653"></a>00653    <a class="code" href="group__Group__AMI.html#gb88212ea47b4627cdab59b899f6fb328">handle_showmanconn</a>, <span class="stringliteral">"List connected manager interface users"</span>,
<a name="l00654"></a>00654    showmanconn_help },
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"eventq"</span>, NULL },
<a name="l00657"></a>00657    <a class="code" href="group__Group__AMI.html#g6a11926a741d1c7d51260d13fbc4c74c">handle_showmaneventq</a>, <span class="stringliteral">"List manager interface queued events"</span>,
<a name="l00658"></a>00658    showmaneventq_help },
<a name="l00659"></a>00659 
<a name="l00660"></a>00660    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"users"</span>, NULL },
<a name="l00661"></a>00661    <a class="code" href="group__Group__AMI.html#g26d7d1506f2ef8110c9c01f335f07911">handle_showmanagers</a>, <span class="stringliteral">"List configured manager users"</span>,
<a name="l00662"></a>00662    showmanagers_help, NULL, NULL },
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"user"</span>, NULL },
<a name="l00665"></a>00665    <a class="code" href="group__Group__AMI.html#gdcf525aba75386762df1e64fa94431fd">handle_showmanager</a>, <span class="stringliteral">"Display information on a specific manager user"</span>,
<a name="l00666"></a>00666    showmanager_help, NULL, NULL },
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    { { <span class="stringliteral">"manager"</span>, <span class="stringliteral">"debug"</span>, NULL },
<a name="l00669"></a>00669    <a class="code" href="group__Group__AMI.html#g92af1877a38de15bb9ee5483d0f277f7">handle_mandebug</a>, <span class="stringliteral">"Show, enable, disable debugging of the manager code"</span>,
<a name="l00670"></a>00670    <span class="stringliteral">"Usage: manager debug [on|off]\n Show, enable, disable debugging of the manager code.\n"</span>, NULL, NULL },
<a name="l00671"></a>00671 };
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 <span class="comment">/*</span>
<a name="l00674"></a>00674 <span class="comment"> * Decrement the usecount for the event; if it goes to zero,</span>
<a name="l00675"></a>00675 <span class="comment"> * (why check for e-&gt;next ?) wakeup the</span>
<a name="l00676"></a>00676 <span class="comment"> * main thread, which is in charge of freeing the record.</span>
<a name="l00677"></a>00677 <span class="comment"> * Returns the next record.</span>
<a name="l00678"></a>00678 <span class="comment"> */</span>
<a name="l00679"></a><a class="code" href="group__Group__AMI.html#gfb5ee4f215d8a2bd0f91355e21f53df5">00679</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *<a class="code" href="group__Group__AMI.html#gfb5ee4f215d8a2bd0f91355e21f53df5">unref_event</a>(<span class="keyword">struct</span> <a class="code" href="structeventqent.html">eventqent</a> *e)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681    ast_atomic_fetchadd_int(&amp;e-&gt;<a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a>, -1);
<a name="l00682"></a>00682    <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(e, eq_next);
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="group__Group__AMI.html#ga640283e96a4cdde5b36633464a1318a">00685</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#ga640283e96a4cdde5b36633464a1318a">ref_event</a>(<span class="keyword">struct</span> <a class="code" href="structeventqent.html">eventqent</a> *e)
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687    ast_atomic_fetchadd_int(&amp;e-&gt;<a class="code" href="structeventqent.html#2bc03f11219aa0e7a3ea1e303a9f0c9a">usecount</a>, 1);
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 <span class="comment">/*</span>
<a name="l00691"></a>00691 <span class="comment"> * destroy a session, leaving the usecount</span>
<a name="l00692"></a>00692 <span class="comment"> */</span>
<a name="l00693"></a><a class="code" href="group__Group__AMI.html#g1ea5536cdcef90f22613b5db2ee59b0d">00693</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g1ea5536cdcef90f22613b5db2ee59b0d">free_session</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *eqe = s-&gt;<a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">last_ev</a>;
<a name="l00696"></a>00696    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> != NULL)
<a name="l00697"></a>00697       fclose(s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l00698"></a>00698    <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l00699"></a>00699    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(s);
<a name="l00700"></a>00700    <a class="code" href="group__Group__AMI.html#gfb5ee4f215d8a2bd0f91355e21f53df5">unref_event</a>(eqe);
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a><a class="code" href="group__Group__AMI.html#g2748014a620509eb30d57cd01d0218ce">00703</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g2748014a620509eb30d57cd01d0218ce">destroy_session</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l00706"></a>00706    <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;sessions, s, list);
<a name="l00707"></a>00707    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709    ast_atomic_fetchadd_int(&amp;<a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>, -1);
<a name="l00710"></a>00710    <a class="code" href="group__Group__AMI.html#g1ea5536cdcef90f22613b5db2ee59b0d">free_session</a>(s);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a><a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">00713</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715    <span class="keywordtype">int</span> x, l = strlen(var);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717    <span class="keywordflow">for</span> (x = 0; x &lt; m-&gt;hdrcount; x++) {
<a name="l00718"></a>00718       <span class="keyword">const</span> <span class="keywordtype">char</span> *h = m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x];
<a name="l00719"></a>00719       <span class="keywordflow">if</span> (!strncasecmp(var, h, l) &amp;&amp; h[l] == <span class="charliteral">':'</span> &amp;&amp; h[l+1] == <span class="charliteral">' '</span>)
<a name="l00720"></a>00720          <span class="keywordflow">return</span> h + l + 2;
<a name="l00721"></a>00721    }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723    <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 
<a name="l00726"></a><a class="code" href="group__Group__AMI.html#gf6be899da040cd416bb8317db016c1ff">00726</a> <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="group__Group__AMI.html#gf6be899da040cd416bb8317db016c1ff">astman_get_variables</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728    <span class="keywordtype">int</span> varlen, x, y;
<a name="l00729"></a>00729    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *head = NULL, *cur;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731    <a class="code" href="app_8h.html#f2237dba0ffbe2f9ec8209c3f9fe82a7">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00732"></a>00732       <a class="code" href="app_8h.html#a6b5292002b488b8ce11fedacb317800">AST_APP_ARG</a>(vars)[32];
<a name="l00733"></a>00733    );
<a name="l00734"></a>00734 
<a name="l00735"></a>00735    varlen = strlen(<span class="stringliteral">"Variable: "</span>);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    <span class="keywordflow">for</span> (x = 0; x &lt; m-&gt;hdrcount; x++) {
<a name="l00738"></a>00738       <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#96d2a4ae057584ce23ca92b03303bd2f">parse</a>, *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, *<a class="code" href="structval.html">val</a>;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740       <span class="keywordflow">if</span> (strncasecmp(<span class="stringliteral">"Variable: "</span>, m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x], varlen))
<a name="l00741"></a>00741          <span class="keywordflow">continue</span>;
<a name="l00742"></a>00742       parse = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x] + varlen);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       <a class="code" href="app_8h.html#c086f828d1f39897759c5668a4d20127">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l00745"></a>00745       <span class="keywordflow">if</span> (!args.argc)
<a name="l00746"></a>00746          <span class="keywordflow">continue</span>;
<a name="l00747"></a>00747       <span class="keywordflow">for</span> (y = 0; y &lt; args.argc; y++) {
<a name="l00748"></a>00748          <span class="keywordflow">if</span> (!args.vars[y])
<a name="l00749"></a>00749             <span class="keywordflow">continue</span>;
<a name="l00750"></a>00750          var = val = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(args.vars[y]);
<a name="l00751"></a>00751          <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;val, <span class="stringliteral">"="</span>);
<a name="l00752"></a>00752          <span class="keywordflow">if</span> (!val || <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(var))
<a name="l00753"></a>00753             <span class="keywordflow">continue</span>;
<a name="l00754"></a>00754          cur = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(var, val);
<a name="l00755"></a>00755          cur-&gt;next = head;
<a name="l00756"></a>00756          head = cur;
<a name="l00757"></a>00757       }
<a name="l00758"></a>00758    }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="keywordflow">return</span> head;
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 <span class="comment"></span>
<a name="l00763"></a>00763 <span class="comment">/*!</span>
<a name="l00764"></a>00764 <span class="comment"> * helper function to send a string to the socket.</span>
<a name="l00765"></a>00765 <span class="comment"> * Return -1 on error (e.g. buffer full).</span>
<a name="l00766"></a>00766 <span class="comment"> */</span>
<a name="l00767"></a><a class="code" href="group__Group__AMI.html#g28148bd9372a54210c67afe221c2141a">00767</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g28148bd9372a54210c67afe221c2141a">send_string</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">char</span> *string)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769    <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = strlen(string);  <span class="comment">/* residual length */</span>
<a name="l00770"></a>00770    <span class="keywordtype">char</span> *src = string;
<a name="l00771"></a>00771    <span class="keyword">struct </span>timeval start = ast_tvnow();
<a name="l00772"></a>00772    <span class="keywordtype">int</span> n = 0;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <span class="keywordflow">for</span> (;;) {
<a name="l00775"></a>00775       <span class="keywordtype">int</span> elapsed;
<a name="l00776"></a>00776       <span class="keyword">struct </span><a class="code" href="structpollfd.html">pollfd</a> fd;
<a name="l00777"></a>00777       n = fwrite(src, 1, len, s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);   <span class="comment">/* try to write the string, non blocking */</span>
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (n == len <span class="comment">/* ok */</span> || n &lt; 0 <span class="comment">/* error */</span>)
<a name="l00779"></a>00779          <span class="keywordflow">break</span>;
<a name="l00780"></a>00780       len -= n;   <span class="comment">/* skip already written data */</span>
<a name="l00781"></a>00781       src += n;
<a name="l00782"></a>00782       fd.<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a> = s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>;
<a name="l00783"></a>00783       fd.<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a> = <a class="code" href="poll-compat_8h.html#f82197ce47846604f4f9727bf258b1e1">POLLOUT</a>;
<a name="l00784"></a>00784       n = -1;     <span class="comment">/* error marker */</span>
<a name="l00785"></a>00785       elapsed = ast_tvdiff_ms(ast_tvnow(), start);
<a name="l00786"></a>00786       <span class="keywordflow">if</span> (elapsed &gt; s-&gt;<a class="code" href="structmansession.html#8aa2aeb656bfe257d9d8c38188f42041">writetimeout</a>)
<a name="l00787"></a>00787          <span class="keywordflow">break</span>;
<a name="l00788"></a>00788       <span class="keywordflow">if</span> (<a class="code" href="poll_8c.html#490c34aebc91a7dfe2524a13104fd13e">poll</a>(&amp;fd, 1, s-&gt;<a class="code" href="structmansession.html#8aa2aeb656bfe257d9d8c38188f42041">writetimeout</a> - elapsed) &lt; 1)
<a name="l00789"></a>00789          <span class="keywordflow">break</span>;
<a name="l00790"></a>00790    }
<a name="l00791"></a>00791    fflush(s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l00792"></a>00792    <span class="keywordflow">return</span> n &lt; 0 ? -1 : 0;
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">/* XXX see if it can be moved inside the function */</span>
<a name="l00796"></a>00796 <a class="code" href="threadstorage_8h.html#c681a874ed42c74a7042e5f6a41aacfe">AST_THREADSTORAGE</a>(astman_append_buf);
<a name="l00797"></a><a class="code" href="group__Group__AMI.html#gf9f69200540a7ff01b9714a361ccf60b">00797</a> <span class="preprocessor">#define ASTMAN_APPEND_BUF_INITSIZE   256</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00799"></a>00799 <span class="comment">/*!</span>
<a name="l00800"></a>00800 <span class="comment"> * utility functions for creating AMI replies</span>
<a name="l00801"></a>00801 <span class="comment"> */</span>
<a name="l00802"></a><a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">00802</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, ...)
<a name="l00803"></a>00803 {
<a name="l00804"></a>00804    va_list ap;
<a name="l00805"></a>00805    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807    <span class="keywordflow">if</span> (!(buf = ast_str_thread_get(&amp;astman_append_buf, <a class="code" href="group__Group__AMI.html#gf9f69200540a7ff01b9714a361ccf60b">ASTMAN_APPEND_BUF_INITSIZE</a>)))
<a name="l00808"></a>00808       <span class="keywordflow">return</span>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810    va_start(ap, fmt);
<a name="l00811"></a>00811    <a class="code" href="strings_8h.html#e22d33692bbb95b75e1f68a3a7f0f3d6">ast_str_set_va</a>(&amp;buf, 0, fmt, ap);
<a name="l00812"></a>00812    va_end(ap);
<a name="l00813"></a>00813 
<a name="l00814"></a>00814    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> != NULL)
<a name="l00815"></a>00815       <a class="code" href="group__Group__AMI.html#g28148bd9372a54210c67afe221c2141a">send_string</a>(s, buf-&gt;<a class="code" href="structast__str.html#3929b4348d8e5ee862fd1e38834d0217">str</a>);
<a name="l00816"></a>00816    <span class="keywordflow">else</span>
<a name="l00817"></a>00817       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"fd == -1 in astman_append, should not happen\n"</span>);
<a name="l00818"></a>00818 }
<a name="l00819"></a>00819 <span class="comment"></span>
<a name="l00820"></a>00820 <span class="comment">/*! \note NOTE: XXX this comment is unclear and possibly wrong.</span>
<a name="l00821"></a>00821 <span class="comment">   Callers of astman_send_error(), astman_send_response() or astman_send_ack() must EITHER</span>
<a name="l00822"></a>00822 <span class="comment">   hold the session lock _or_ be running in an action callback (in which case s-&gt;busy will</span>
<a name="l00823"></a>00823 <span class="comment">   be non-zero). In either of these cases, there is no need to lock-protect the session's</span>
<a name="l00824"></a>00824 <span class="comment">   fd, since no other output will be sent (events will be queued), and no input will</span>
<a name="l00825"></a>00825 <span class="comment">   be read until either the current action finishes or get_input() obtains the session</span>
<a name="l00826"></a>00826 <span class="comment">   lock.</span>
<a name="l00827"></a>00827 <span class="comment"> */</span>
<a name="l00828"></a>00828 <span class="comment"></span>
<a name="l00829"></a>00829 <span class="comment">/*! \brief send a response with an optional message,</span>
<a name="l00830"></a>00830 <span class="comment"> * and terminate it with an empty line.</span>
<a name="l00831"></a>00831 <span class="comment"> * m is used only to grab the 'ActionID' field.</span>
<a name="l00832"></a>00832 <span class="comment"> *</span>
<a name="l00833"></a>00833 <span class="comment"> * Use the explicit constant MSG_MOREDATA to remove the empty line.</span>
<a name="l00834"></a>00834 <span class="comment"> * XXX MSG_MOREDATA should go to a header file.</span>
<a name="l00835"></a>00835 <span class="comment"> */</span>
<a name="l00836"></a><a class="code" href="group__Group__AMI.html#g707bedc997e8781f153bcc7a5d1a944a">00836</a> <span class="preprocessor">#define MSG_MOREDATA ((char *)astman_send_response)</span>
<a name="l00837"></a><a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">00837</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *resp, <span class="keywordtype">char</span> *msg, <span class="keywordtype">char</span> *listflag)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m,<span class="stringliteral">"ActionID"</span>);
<a name="l00840"></a>00840 
<a name="l00841"></a>00841    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Response: %s\r\n"</span>, resp);
<a name="l00842"></a>00842    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l00843"></a>00843       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l00844"></a>00844    <span class="keywordflow">if</span> (listflag)
<a name="l00845"></a>00845       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Eventlist: %s\r\n"</span>, listflag);   <span class="comment">/* Start, complete, cancelled */</span>
<a name="l00846"></a>00846    <span class="keywordflow">if</span> (msg == <a class="code" href="group__Group__AMI.html#g707bedc997e8781f153bcc7a5d1a944a">MSG_MOREDATA</a>)
<a name="l00847"></a>00847       <span class="keywordflow">return</span>;
<a name="l00848"></a>00848    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg)
<a name="l00849"></a>00849       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Message: %s\r\n\r\n"</span>, msg);
<a name="l00850"></a>00850    <span class="keywordflow">else</span>
<a name="l00851"></a>00851       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"\r\n"</span>);
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">00854</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *resp, <span class="keywordtype">char</span> *msg)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856    <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(s, m, resp, msg, NULL);
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 
<a name="l00859"></a><a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">00859</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *<a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a>)
<a name="l00860"></a>00860 {
<a name="l00861"></a>00861    <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(s, m, <span class="stringliteral">"Error"</span>, error, NULL);
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863 
<a name="l00864"></a><a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">00864</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *msg)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866    <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(s, m, <span class="stringliteral">"Success"</span>, msg, NULL);
<a name="l00867"></a>00867 }
<a name="l00868"></a>00868 
<a name="l00869"></a><a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">00869</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00870"></a>00870 {
<a name="l00871"></a>00871    <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(s, m, <span class="stringliteral">"Success"</span>, <a class="code" href="group__Group__AMI.html#g707bedc997e8781f153bcc7a5d1a944a">MSG_MOREDATA</a>, NULL);
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a><a class="code" href="group__Group__AMI.html#ga868a0aada874f97606fcc3119bad3da">00874</a> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#ga868a0aada874f97606fcc3119bad3da">astman_send_listack</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">char</span> *msg, <span class="keywordtype">char</span> *listflag)
<a name="l00875"></a>00875 {
<a name="l00876"></a>00876    <a class="code" href="group__Group__AMI.html#g653336d14301d38a863c7b20ccec8a1c">astman_send_response_full</a>(s, m, <span class="stringliteral">"Success"</span>, msg, listflag);
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 <span class="comment"></span>
<a name="l00880"></a>00880 <span class="comment">/*! \brief</span>
<a name="l00881"></a>00881 <span class="comment">   Rather than braindead on,off this now can also accept a specific int mask value</span>
<a name="l00882"></a>00882 <span class="comment">   or a ',' delim list of mask strings (the same as manager.conf) -anthm</span>
<a name="l00883"></a>00883 <span class="comment">*/</span>
<a name="l00884"></a><a class="code" href="group__Group__AMI.html#gca4968afc65b84cc5b3781d465536b32">00884</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gca4968afc65b84cc5b3781d465536b32">set_eventmask</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *eventmask)
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886    <span class="keywordtype">int</span> maskint = <a class="code" href="group__Group__AMI.html#g84442272098545210b360ac4f131f10f">strings_to_mask</a>(eventmask);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l00889"></a>00889    <span class="keywordflow">if</span> (maskint &gt;= 0)
<a name="l00890"></a>00890       s-&gt;<a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">send_events</a> = maskint;
<a name="l00891"></a>00891    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893    <span class="keywordflow">return</span> maskint;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/*</span>
<a name="l00897"></a>00897 <span class="comment"> * Here we start with action_ handlers for AMI actions,</span>
<a name="l00898"></a>00898 <span class="comment"> * and the internal functions used by them.</span>
<a name="l00899"></a>00899 <span class="comment"> * Generally, the handlers are called action_foo()</span>
<a name="l00900"></a>00900 <span class="comment"> */</span>
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 <span class="comment">/* helper function for action_login() */</span>
<a name="l00903"></a><a class="code" href="group__Group__AMI.html#g0c601c39a357acbe91e4070d54d89001">00903</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g0c601c39a357acbe91e4070d54d89001">authenticate</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00904"></a>00904 {
<a name="l00905"></a>00905    <span class="keyword">const</span> <span class="keywordtype">char</span> *user = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Username"</span>);
<a name="l00906"></a>00906    <span class="keywordtype">int</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a> = -1;
<a name="l00907"></a>00907    <span class="keyword">struct </span><a class="code" href="structast__ha.html">ast_ha</a> *ha = NULL;
<a name="l00908"></a>00908    <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#5f4dcc3b5aa765d61d8327deb882cf99">password</a> = NULL;
<a name="l00909"></a>00909    <span class="keywordtype">int</span> readperm = 0, writeperm = 0;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user)) <span class="comment">/* missing username */</span>
<a name="l00912"></a>00912       <span class="keywordflow">return</span> -1;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     {
<a name="l00915"></a>00915    <span class="comment">/*</span>
<a name="l00916"></a>00916 <span class="comment">    * XXX there should be no need to scan the config file again here,</span>
<a name="l00917"></a>00917 <span class="comment">    * suffices to call get_manager_by_name_locked() to fetch</span>
<a name="l00918"></a>00918 <span class="comment">    * the user's entry.</span>
<a name="l00919"></a>00919 <span class="comment">    */</span>
<a name="l00920"></a>00920    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<span class="stringliteral">"manager.conf"</span>);
<a name="l00921"></a>00921    <span class="keywordtype">char</span> *cat = NULL;
<a name="l00922"></a>00922    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924    <span class="keywordflow">if</span> (!cfg)
<a name="l00925"></a>00925       <span class="keywordflow">return</span> -1;
<a name="l00926"></a>00926    <span class="keywordflow">while</span> ( (cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, cat)) ) {
<a name="l00927"></a>00927       <span class="comment">/* "general" is not a valid user */</span>
<a name="l00928"></a>00928       <span class="keywordflow">if</span> (strcasecmp(cat, user) || !strcasecmp(cat, <span class="stringliteral">"general"</span>))
<a name="l00929"></a>00929          <span class="keywordflow">continue</span>;
<a name="l00930"></a>00930       <span class="comment">/* collect parameters for the user's entry */</span>
<a name="l00931"></a>00931       <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00932"></a>00932          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"secret"</span>))
<a name="l00933"></a>00933             password = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00934"></a>00934          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"read"</span>))
<a name="l00935"></a>00935             readperm = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00936"></a>00936          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"write"</span>))
<a name="l00937"></a>00937             writeperm = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00938"></a>00938          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"permit"</span>) ||
<a name="l00939"></a>00939                !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"deny"</span>)) {
<a name="l00940"></a>00940             ha = <a class="code" href="acl_8c.html#bd7ec664091783cbeef4274f5c30d7b4">ast_append_ha</a>(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, ha, NULL);
<a name="l00941"></a>00941          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"writetimeout"</span>)) {
<a name="l00942"></a>00942             <span class="keywordtype">int</span> <a class="code" href="structval.html">val</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00943"></a>00943    
<a name="l00944"></a>00944             <span class="keywordflow">if</span> (val &lt; 100)
<a name="l00945"></a>00945                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Invalid writetimeout value '%s' at line %d\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00946"></a>00946             <span class="keywordflow">else</span>
<a name="l00947"></a>00947                s-&gt;<a class="code" href="structmansession.html#8aa2aeb656bfe257d9d8c38188f42041">writetimeout</a> = val;
<a name="l00948"></a>00948          }
<a name="l00949"></a>00949       }
<a name="l00950"></a>00950       <span class="keywordflow">break</span>;
<a name="l00951"></a>00951    }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l00954"></a>00954    <span class="keywordflow">if</span> (!cat) {
<a name="l00955"></a>00955       <span class="comment">/* Didn't find the user in manager.conf, check users.conf */</span>
<a name="l00956"></a>00956       <span class="keywordtype">int</span> hasmanager = 0;
<a name="l00957"></a>00957       cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<span class="stringliteral">"users.conf"</span>);
<a name="l00958"></a>00958       <span class="keywordflow">if</span> (!cfg)
<a name="l00959"></a>00959          <span class="keywordflow">return</span> -1;
<a name="l00960"></a>00960       <span class="keywordflow">while</span> ( (cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, cat)) ) {
<a name="l00961"></a>00961          <span class="keywordflow">if</span> (!strcasecmp(cat, user) &amp;&amp; strcasecmp(cat, <span class="stringliteral">"general"</span>))
<a name="l00962"></a>00962             <span class="keywordflow">break</span>;
<a name="l00963"></a>00963       }
<a name="l00964"></a>00964       <span class="keywordflow">if</span> (!cat) {
<a name="l00965"></a>00965          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"%s tried to authenticate with nonexistent user '%s'\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), user);
<a name="l00966"></a>00966          <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l00967"></a>00967          <span class="keywordflow">return</span> -1;
<a name="l00968"></a>00968       }
<a name="l00969"></a>00969       <span class="comment">/* collect parameters for the user's entry from users.conf */</span>
<a name="l00970"></a>00970       <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00971"></a>00971          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"secret"</span>))
<a name="l00972"></a>00972             password = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00973"></a>00973          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"read"</span>))
<a name="l00974"></a>00974             readperm = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00975"></a>00975          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"write"</span>))
<a name="l00976"></a>00976             writeperm = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00977"></a>00977          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"permit"</span>) ||
<a name="l00978"></a>00978                !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"deny"</span>)) {
<a name="l00979"></a>00979             ha = <a class="code" href="acl_8c.html#bd7ec664091783cbeef4274f5c30d7b4">ast_append_ha</a>(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, ha, NULL);
<a name="l00980"></a>00980          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"writetimeout"</span>)) {
<a name="l00981"></a>00981             <span class="keywordtype">int</span> <a class="code" href="structval.html">val</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00982"></a>00982    
<a name="l00983"></a>00983             <span class="keywordflow">if</span> (val &lt; 100)
<a name="l00984"></a>00984                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Invalid writetimeout value '%s' at line %d\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00985"></a>00985             <span class="keywordflow">else</span>
<a name="l00986"></a>00986                s-&gt;<a class="code" href="structmansession.html#8aa2aeb656bfe257d9d8c38188f42041">writetimeout</a> = val;
<a name="l00987"></a>00987          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"hasmanager"</span>)) {
<a name="l00988"></a>00988             hasmanager = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00989"></a>00989          }
<a name="l00990"></a>00990       }
<a name="l00991"></a>00991       <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l00992"></a>00992       <span class="keywordflow">if</span> (!hasmanager) {
<a name="l00993"></a>00993          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"%s tried to authenticate with nonexistent user '%s'\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), user);
<a name="l00994"></a>00994          <span class="keywordflow">return</span> -1;
<a name="l00995"></a>00995       }
<a name="l00996"></a>00996    }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998    }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000    <span class="keywordflow">if</span> (ha) {
<a name="l01001"></a>01001       <span class="keywordtype">int</span> good = <a class="code" href="acl_8c.html#ad4795f3b2afa9e898bbd529d0735a32">ast_apply_ha</a>(ha, &amp;(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>));
<a name="l01002"></a>01002       <a class="code" href="acl_8c.html#395c900def2430bc4d7270a1b537c870">ast_free_ha</a>(ha);
<a name="l01003"></a>01003       <span class="keywordflow">if</span> (!good) {
<a name="l01004"></a>01004          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"%s failed to pass IP ACL as '%s'\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), user);
<a name="l01005"></a>01005          <span class="keywordflow">return</span> -1;
<a name="l01006"></a>01006       }
<a name="l01007"></a>01007    }
<a name="l01008"></a>01008    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"AuthType"</span>), <span class="stringliteral">"MD5"</span>)) {
<a name="l01009"></a>01009       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="func__channel_8c.html#87ef31d54f81072952c331d5c7339d8e">key</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Key"</span>);
<a name="l01010"></a>01010       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(key) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>) &amp;&amp;
<a name="l01011"></a>01011           !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(password)) {
<a name="l01012"></a>01012          <span class="keywordtype">int</span> x;
<a name="l01013"></a>01013          <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = 0;
<a name="l01014"></a>01014          <span class="keywordtype">char</span> md5key[256] = <span class="stringliteral">""</span>;
<a name="l01015"></a>01015          <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l01016"></a>01016          <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
<a name="l01017"></a>01017 
<a name="l01018"></a>01018          <a class="code" href="md5_8c.html#c5e42e491ef01932075bc2b458adb3d3">MD5Init</a>(&amp;md5);
<a name="l01019"></a>01019          <a class="code" href="md5_8c.html#1cf20b07870b08b3511ab4a4a8bbebf2">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>, strlen(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>));
<a name="l01020"></a>01020          <a class="code" href="md5_8c.html#1cf20b07870b08b3511ab4a4a8bbebf2">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) password, strlen(password));
<a name="l01021"></a>01021          <a class="code" href="md5_8c.html#200ba291fa2daa9d56ef744b5ff26549">MD5Final</a>(digest, &amp;md5);
<a name="l01022"></a>01022          <span class="keywordflow">for</span> (x=0; x&lt;16; x++)
<a name="l01023"></a>01023             len += sprintf(md5key + len, <span class="stringliteral">"%2.2x"</span>, digest[x]);
<a name="l01024"></a>01024          <span class="keywordflow">if</span> (!strcmp(md5key, key))
<a name="l01025"></a>01025             error = 0;
<a name="l01026"></a>01026       } <span class="keywordflow">else</span> {
<a name="l01027"></a>01027          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"MD5 authentication is not possible.  challenge: '%s'\n"</span>, 
<a name="l01028"></a>01028             <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>, <span class="stringliteral">""</span>));
<a name="l01029"></a>01029          <span class="keywordflow">return</span> -1;
<a name="l01030"></a>01030       }
<a name="l01031"></a>01031    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (password) {
<a name="l01032"></a>01032       <span class="keyword">const</span> <span class="keywordtype">char</span> *pass = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Secret"</span>);
<a name="l01033"></a>01033       <span class="keywordflow">if</span> (!strcmp(password, pass))
<a name="l01034"></a>01034          error = 0;
<a name="l01035"></a>01035    }
<a name="l01036"></a>01036    <span class="keywordflow">if</span> (error) {
<a name="l01037"></a>01037       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"%s failed to authenticate as '%s'\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), user);
<a name="l01038"></a>01038       <span class="keywordflow">return</span> -1;
<a name="l01039"></a>01039    }
<a name="l01040"></a>01040    ast_copy_string(s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, user, <span class="keyword">sizeof</span>(s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>));
<a name="l01041"></a>01041    s-&gt;<a class="code" href="structmansession.html#e12b8f9551a73d6196648b62754aa9e1">readperm</a> = readperm;
<a name="l01042"></a>01042    s-&gt;<a class="code" href="structmansession.html#1cc72854e73b9b510a12e993d6479e86">writeperm</a> = writeperm;
<a name="l01043"></a>01043    <a class="code" href="group__Group__AMI.html#gca4968afc65b84cc5b3781d465536b32">set_eventmask</a>(s, <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Events"</span>));
<a name="l01044"></a>01044    <span class="keywordflow">return</span> 0;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 <span class="comment"></span>
<a name="l01047"></a>01047 <span class="comment">/*! \brief Manager PING */</span>
<a name="l01048"></a><a class="code" href="group__Group__AMI.html#gd19fc2f4e2bf2f2b6e916f370a345957">01048</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gd19fc2f4e2bf2f2b6e916f370a345957">mandescr_ping</a>[] =
<a name="l01049"></a>01049 <span class="stringliteral">"Description: A 'Ping' action will ellicit a 'Pong' response.  Used to keep the\n"</span>
<a name="l01050"></a>01050 <span class="stringliteral">"  manager connection open.\n"</span>
<a name="l01051"></a>01051 <span class="stringliteral">"Variables: NONE\n"</span>;
<a name="l01052"></a>01052 
<a name="l01053"></a><a class="code" href="group__Group__AMI.html#gbd5ac0feea5a76122c4bb7950f72dba9">01053</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gbd5ac0feea5a76122c4bb7950f72dba9">action_ping</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055    <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(s, m, <span class="stringliteral">"Pong"</span>, NULL);
<a name="l01056"></a>01056    <span class="keywordflow">return</span> 0;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="group__Group__AMI.html#g47ba7bebfd930c7ba1797e460b0c261b">01059</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g47ba7bebfd930c7ba1797e460b0c261b">mandescr_getconfig</a>[] =
<a name="l01060"></a>01060 <span class="stringliteral">"Description: A 'GetConfig' action will dump the contents of a configuration\n"</span>
<a name="l01061"></a>01061 <span class="stringliteral">"file by category and contents.\n"</span>
<a name="l01062"></a>01062 <span class="stringliteral">"Variables:\n"</span>
<a name="l01063"></a>01063 <span class="stringliteral">"   Filename: Configuration filename (e.g. foo.conf)\n"</span>;
<a name="l01064"></a>01064 
<a name="l01065"></a><a class="code" href="group__Group__AMI.html#geeb75cf41619f536caffbbef71e3f730">01065</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#geeb75cf41619f536caffbbef71e3f730">action_getconfig</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01066"></a>01066 {
<a name="l01067"></a>01067    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01068"></a>01068    <span class="keyword">const</span> <span class="keywordtype">char</span> *fn = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Filename"</span>);
<a name="l01069"></a>01069    <span class="keywordtype">int</span> catcount = 0;
<a name="l01070"></a>01070    <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#5525da36abafe9a243105119cea54be5">lineno</a> = 0;
<a name="l01071"></a>01071    <span class="keywordtype">char</span> *<a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>=NULL;
<a name="l01072"></a>01072    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fn)) {
<a name="l01075"></a>01075       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Filename not specified"</span>);
<a name="l01076"></a>01076       <span class="keywordflow">return</span> 0;
<a name="l01077"></a>01077    }
<a name="l01078"></a>01078    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8c.html#2263d3aacd27024be95ac630a0a609dd">ast_config_load_with_comments</a>(fn))) {
<a name="l01079"></a>01079       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Config file not found"</span>);
<a name="l01080"></a>01080       <span class="keywordflow">return</span> 0;
<a name="l01081"></a>01081    }
<a name="l01082"></a>01082    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l01083"></a>01083    <span class="keywordflow">while</span> ((category = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, category))) {
<a name="l01084"></a>01084       lineno = 0;
<a name="l01085"></a>01085       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Category-%06d: %s\r\n"</span>, catcount, category);
<a name="l01086"></a>01086       <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, category); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>)
<a name="l01087"></a>01087          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Line-%06d-%06d: %s=%s\r\n"</span>, catcount, lineno++, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01088"></a>01088       catcount++;
<a name="l01089"></a>01089    }
<a name="l01090"></a>01090    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l01091"></a>01091    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"\r\n"</span>);
<a name="l01092"></a>01092 
<a name="l01093"></a>01093    <span class="keywordflow">return</span> 0;
<a name="l01094"></a>01094 }
<a name="l01095"></a>01095 <span class="comment"></span>
<a name="l01096"></a>01096 <span class="comment">/*! The amount of space in out must be at least ( 2 * strlen(in) + 1 ) */</span>
<a name="l01097"></a><a class="code" href="group__Group__AMI.html#ge5f94d60aa1b0c445a48748f89b2a78d">01097</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#ge5f94d60aa1b0c445a48748f89b2a78d">json_escape</a>(<span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">char</span> *in)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099    <span class="keywordflow">for</span> (; *in; in++) {
<a name="l01100"></a>01100       <span class="keywordflow">if</span> (*in == <span class="charliteral">'\\'</span> || *in == <span class="charliteral">'\"'</span>)
<a name="l01101"></a>01101          *out++ = <span class="charliteral">'\\'</span>;
<a name="l01102"></a>01102       *out++ = *in;
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104    *out = <span class="charliteral">'\0'</span>;
<a name="l01105"></a>01105 }
<a name="l01106"></a>01106 
<a name="l01107"></a><a class="code" href="group__Group__AMI.html#gd3137ad18fefbbb17e1e3848b7423d16">01107</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gd3137ad18fefbbb17e1e3848b7423d16">mandescr_getconfigjson</a>[] =
<a name="l01108"></a>01108 <span class="stringliteral">"Description: A 'GetConfigJSON' action will dump the contents of a configuration\n"</span>
<a name="l01109"></a>01109 <span class="stringliteral">"file by category and contents in JSON format.  This only makes sense to be used\n"</span>
<a name="l01110"></a>01110 <span class="stringliteral">"using rawman over the HTTP interface.\n"</span>
<a name="l01111"></a>01111 <span class="stringliteral">"Variables:\n"</span>
<a name="l01112"></a>01112 <span class="stringliteral">"   Filename: Configuration filename (e.g. foo.conf)\n"</span>;
<a name="l01113"></a>01113 
<a name="l01114"></a><a class="code" href="group__Group__AMI.html#g51d0d48508ddb1374a9b28d95b5702d6">01114</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g51d0d48508ddb1374a9b28d95b5702d6">action_getconfigjson</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01115"></a>01115 {
<a name="l01116"></a>01116    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01117"></a>01117    <span class="keyword">const</span> <span class="keywordtype">char</span> *fn = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Filename"</span>);
<a name="l01118"></a>01118    <span class="keywordtype">char</span> *<a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a> = NULL;
<a name="l01119"></a>01119    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l01120"></a>01120    <span class="keywordtype">int</span> comma1 = 0;
<a name="l01121"></a>01121    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> = NULL;
<a name="l01122"></a>01122    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buf_len = 0;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fn)) {
<a name="l01125"></a>01125       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Filename not specified"</span>);
<a name="l01126"></a>01126       <span class="keywordflow">return</span> 0;
<a name="l01127"></a>01127    }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8c.html#2263d3aacd27024be95ac630a0a609dd">ast_config_load_with_comments</a>(fn))) {
<a name="l01130"></a>01130       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Config file not found"</span>);
<a name="l01131"></a>01131       <span class="keywordflow">return</span> 0;
<a name="l01132"></a>01132    }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134    buf_len = 512;
<a name="l01135"></a>01135    buf = alloca(buf_len);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l01138"></a>01138    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"JSON: {"</span>);
<a name="l01139"></a>01139    <span class="keywordflow">while</span> ((category = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, category))) {
<a name="l01140"></a>01140       <span class="keywordtype">int</span> comma2 = 0;
<a name="l01141"></a>01141       <span class="keywordflow">if</span> (buf_len &lt; 2 * strlen(category) + 1) {
<a name="l01142"></a>01142          buf_len *= 2;
<a name="l01143"></a>01143          buf = alloca(buf_len);
<a name="l01144"></a>01144       }
<a name="l01145"></a>01145       <a class="code" href="group__Group__AMI.html#ge5f94d60aa1b0c445a48748f89b2a78d">json_escape</a>(buf, category);
<a name="l01146"></a>01146       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"%s\"%s\":["</span>, comma1 ? <span class="stringliteral">","</span> : <span class="stringliteral">""</span>, buf);
<a name="l01147"></a>01147       <span class="keywordflow">if</span> (!comma1)
<a name="l01148"></a>01148          comma1 = 1;
<a name="l01149"></a>01149       <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, category); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l01150"></a>01150          <span class="keywordflow">if</span> (comma2)
<a name="l01151"></a>01151             <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">","</span>);
<a name="l01152"></a>01152          <span class="keywordflow">if</span> (buf_len &lt; 2 * strlen(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>) + 1) {
<a name="l01153"></a>01153             buf_len *= 2;
<a name="l01154"></a>01154             buf = alloca(buf_len);
<a name="l01155"></a>01155          }
<a name="l01156"></a>01156          <a class="code" href="group__Group__AMI.html#ge5f94d60aa1b0c445a48748f89b2a78d">json_escape</a>(buf, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01157"></a>01157          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"\"%s"</span>, buf);
<a name="l01158"></a>01158          <span class="keywordflow">if</span> (buf_len &lt; 2 * strlen(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>) + 1) {
<a name="l01159"></a>01159             buf_len *= 2;
<a name="l01160"></a>01160             buf = alloca(buf_len);
<a name="l01161"></a>01161          }
<a name="l01162"></a>01162          <a class="code" href="group__Group__AMI.html#ge5f94d60aa1b0c445a48748f89b2a78d">json_escape</a>(buf, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01163"></a>01163          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"%s\""</span>, buf);
<a name="l01164"></a>01164          <span class="keywordflow">if</span> (!comma2)
<a name="l01165"></a>01165             comma2 = 1;
<a name="l01166"></a>01166       }
<a name="l01167"></a>01167       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"]"</span>);
<a name="l01168"></a>01168    }
<a name="l01169"></a>01169    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"}\r\n\r\n"</span>);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173    <span class="keywordflow">return</span> 0;
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="comment">/* helper function for action_updateconfig */</span>
<a name="l01177"></a><a class="code" href="group__Group__AMI.html#g745d3d4809316e9124d216a6e3ce93d3">01177</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g745d3d4809316e9124d216a6e3ce93d3">handle_updates</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg)
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179    <span class="keywordtype">int</span> x;
<a name="l01180"></a>01180    <span class="keywordtype">char</span> hdr[40];
<a name="l01181"></a>01181    <span class="keyword">const</span> <span class="keywordtype">char</span> *action, *cat, *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, *<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, *<a class="code" href="chan__iax2_8c.html#b5f545ec55667a61a75dd2047251b4ac">match</a>;
<a name="l01182"></a>01182    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *<a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>;
<a name="l01183"></a>01183    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l01184"></a>01184 
<a name="l01185"></a>01185    <span class="keywordflow">for</span> (x=0;x&lt;100000;x++) {
<a name="l01186"></a>01186       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__variable.html#a8cfde6331bd59eb2ac96f8911c4b666">object</a> = 0;
<a name="l01187"></a>01187 
<a name="l01188"></a>01188       snprintf(hdr, <span class="keyword">sizeof</span>(hdr), <span class="stringliteral">"Action-%06d"</span>, x);
<a name="l01189"></a>01189       action = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, hdr);
<a name="l01190"></a>01190       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(action))
<a name="l01191"></a>01191          <span class="keywordflow">break</span>;
<a name="l01192"></a>01192       snprintf(hdr, <span class="keyword">sizeof</span>(hdr), <span class="stringliteral">"Cat-%06d"</span>, x);
<a name="l01193"></a>01193       cat = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, hdr);
<a name="l01194"></a>01194       snprintf(hdr, <span class="keyword">sizeof</span>(hdr), <span class="stringliteral">"Var-%06d"</span>, x);
<a name="l01195"></a>01195       var = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, hdr);
<a name="l01196"></a>01196       snprintf(hdr, <span class="keyword">sizeof</span>(hdr), <span class="stringliteral">"Value-%06d"</span>, x);
<a name="l01197"></a>01197       value = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, hdr);
<a name="l01198"></a>01198       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(value) &amp;&amp; *value == <span class="charliteral">'&gt;'</span>) {
<a name="l01199"></a>01199          object = 1;
<a name="l01200"></a>01200          value++;
<a name="l01201"></a>01201       }
<a name="l01202"></a>01202       snprintf(hdr, <span class="keyword">sizeof</span>(hdr), <span class="stringliteral">"Match-%06d"</span>, x);
<a name="l01203"></a>01203       match = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, hdr);
<a name="l01204"></a>01204       <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"newcat"</span>)) {
<a name="l01205"></a>01205          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat)) {
<a name="l01206"></a>01206             category = <a class="code" href="config_8c.html#7c91d609091f9ffcb3b4a9f8aaa82e7b">ast_category_new</a>(cat);
<a name="l01207"></a>01207             <span class="keywordflow">if</span> (category) {
<a name="l01208"></a>01208                <a class="code" href="config_8c.html#9efd51e40d45378faf85951179110981">ast_category_append</a>(cfg, category);
<a name="l01209"></a>01209             }
<a name="l01210"></a>01210          }
<a name="l01211"></a>01211       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"renamecat"</span>)) {
<a name="l01212"></a>01212          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(value)) {
<a name="l01213"></a>01213             category = <a class="code" href="config_8c.html#a4d454598a4630cd3a810f7cecd25d41">ast_category_get</a>(cfg, cat);
<a name="l01214"></a>01214             <span class="keywordflow">if</span> (category)
<a name="l01215"></a>01215                <a class="code" href="config_8c.html#8629d76affd844c6b15a901eb2aa63d7">ast_category_rename</a>(category, value);
<a name="l01216"></a>01216          }
<a name="l01217"></a>01217       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"delcat"</span>)) {
<a name="l01218"></a>01218          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat))
<a name="l01219"></a>01219             <a class="code" href="config_8c.html#8a891ee1cd71daa7ed06107874f3846c">ast_category_delete</a>(cfg, cat);
<a name="l01220"></a>01220       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"update"</span>)) {
<a name="l01221"></a>01221          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(var) &amp;&amp; (category = <a class="code" href="config_8c.html#a4d454598a4630cd3a810f7cecd25d41">ast_category_get</a>(cfg, cat)))
<a name="l01222"></a>01222             <a class="code" href="config_8c.html#4fd56a903e50633096934f229d8a4340">ast_variable_update</a>(category, var, value, match, object);
<a name="l01223"></a>01223       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"delete"</span>)) {
<a name="l01224"></a>01224          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(var) &amp;&amp; (category = <a class="code" href="config_8c.html#a4d454598a4630cd3a810f7cecd25d41">ast_category_get</a>(cfg, cat)))
<a name="l01225"></a>01225             <a class="code" href="config_8c.html#edbf64adfaa4adcef27cd5c6efe51be4">ast_variable_delete</a>(category, var, match);
<a name="l01226"></a>01226       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(action, <span class="stringliteral">"append"</span>)) {
<a name="l01227"></a>01227          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(cat) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(var) &amp;&amp;
<a name="l01228"></a>01228             (category = <a class="code" href="config_8c.html#a4d454598a4630cd3a810f7cecd25d41">ast_category_get</a>(cfg, cat)) &amp;&amp;
<a name="l01229"></a>01229             (v = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(var, value))){
<a name="l01230"></a>01230             <span class="keywordflow">if</span> (object || (match &amp;&amp; !strcasecmp(match, <span class="stringliteral">"object"</span>)))
<a name="l01231"></a>01231                v-&gt;<a class="code" href="structast__variable.html#a8cfde6331bd59eb2ac96f8911c4b666">object</a> = 1;
<a name="l01232"></a>01232             <a class="code" href="config_8c.html#6b8deaf1a9df252e014d697e09cb68b9">ast_variable_append</a>(category, v);
<a name="l01233"></a>01233          }
<a name="l01234"></a>01234       }
<a name="l01235"></a>01235    }
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a><a class="code" href="group__Group__AMI.html#gb327aa5c1fa62b6a6ea1eff221976639">01238</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gb327aa5c1fa62b6a6ea1eff221976639">mandescr_updateconfig</a>[] =
<a name="l01239"></a>01239 <span class="stringliteral">"Description: A 'UpdateConfig' action will dump the contents of a configuration\n"</span>
<a name="l01240"></a>01240 <span class="stringliteral">"file by category and contents.\n"</span>
<a name="l01241"></a>01241 <span class="stringliteral">"Variables (X's represent 6 digit number beginning with 000000):\n"</span>
<a name="l01242"></a>01242 <span class="stringliteral">"   SrcFilename:   Configuration filename to read(e.g. foo.conf)\n"</span>
<a name="l01243"></a>01243 <span class="stringliteral">"   DstFilename:   Configuration filename to write(e.g. foo.conf)\n"</span>
<a name="l01244"></a>01244 <span class="stringliteral">"   Reload:        Whether or not a reload should take place (or name of specific module)\n"</span>
<a name="l01245"></a>01245 <span class="stringliteral">"   Action-XXXXXX: Action to Take (NewCat,RenameCat,DelCat,Update,Delete,Append)\n"</span>
<a name="l01246"></a>01246 <span class="stringliteral">"   Cat-XXXXXX:    Category to operate on\n"</span>
<a name="l01247"></a>01247 <span class="stringliteral">"   Var-XXXXXX:    Variable to work on\n"</span>
<a name="l01248"></a>01248 <span class="stringliteral">"   Value-XXXXXX:  Value to work on\n"</span>
<a name="l01249"></a>01249 <span class="stringliteral">"   Match-XXXXXX:  Extra match required to match line\n"</span>;
<a name="l01250"></a>01250 
<a name="l01251"></a><a class="code" href="group__Group__AMI.html#g2543b90f06c6700af2c68d854b6b4558">01251</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g2543b90f06c6700af2c68d854b6b4558">action_updateconfig</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01252"></a>01252 {
<a name="l01253"></a>01253    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01254"></a>01254    <span class="keyword">const</span> <span class="keywordtype">char</span> *sfn = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"SrcFilename"</span>);
<a name="l01255"></a>01255    <span class="keyword">const</span> <span class="keywordtype">char</span> *dfn = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"DstFilename"</span>);
<a name="l01256"></a>01256    <span class="keywordtype">int</span> res;
<a name="l01257"></a>01257    <span class="keyword">const</span> <span class="keywordtype">char</span> *rld = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Reload"</span>);
<a name="l01258"></a>01258 
<a name="l01259"></a>01259    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(sfn) || <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dfn)) {
<a name="l01260"></a>01260       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Filename not specified"</span>);
<a name="l01261"></a>01261       <span class="keywordflow">return</span> 0;
<a name="l01262"></a>01262    }
<a name="l01263"></a>01263    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8c.html#2263d3aacd27024be95ac630a0a609dd">ast_config_load_with_comments</a>(sfn))) {
<a name="l01264"></a>01264       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Config file not found"</span>);
<a name="l01265"></a>01265       <span class="keywordflow">return</span> 0;
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267    <a class="code" href="group__Group__AMI.html#g745d3d4809316e9124d216a6e3ce93d3">handle_updates</a>(s, m, cfg);
<a name="l01268"></a>01268    res = <a class="code" href="config_8c.html#509bc97b1300e42c8323c0d6122b9457">config_text_file_save</a>(dfn, cfg, <span class="stringliteral">"Manager"</span>);
<a name="l01269"></a>01269    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l01270"></a>01270    <span class="keywordflow">if</span> (res) {
<a name="l01271"></a>01271       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Save of config failed"</span>);
<a name="l01272"></a>01272       <span class="keywordflow">return</span> 0;
<a name="l01273"></a>01273    }
<a name="l01274"></a>01274    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, NULL);
<a name="l01275"></a>01275    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(rld)) {
<a name="l01276"></a>01276       <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(rld))
<a name="l01277"></a>01277          rld = NULL;
<a name="l01278"></a>01278       <a class="code" href="loader_8c.html#12479ce54a93d95bd3c845793c3c0f19">ast_module_reload</a>(rld);
<a name="l01279"></a>01279    }
<a name="l01280"></a>01280    <span class="keywordflow">return</span> 0;
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 <span class="comment"></span>
<a name="l01283"></a>01283 <span class="comment">/*! \brief Manager WAITEVENT */</span>
<a name="l01284"></a><a class="code" href="group__Group__AMI.html#g5ac7170aaf87a7b17bc4b85f93facd3a">01284</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g5ac7170aaf87a7b17bc4b85f93facd3a">mandescr_waitevent</a>[] =
<a name="l01285"></a>01285 <span class="stringliteral">"Description: A 'WaitEvent' action will ellicit a 'Success' response.  Whenever\n"</span>
<a name="l01286"></a>01286 <span class="stringliteral">"a manager event is queued.  Once WaitEvent has been called on an HTTP manager\n"</span>
<a name="l01287"></a>01287 <span class="stringliteral">"session, events will be generated and queued.\n"</span>
<a name="l01288"></a>01288 <span class="stringliteral">"Variables: \n"</span>
<a name="l01289"></a>01289 <span class="stringliteral">"   Timeout: Maximum time (in seconds) to wait for events, -1 means forever.\n"</span>;
<a name="l01290"></a>01290 
<a name="l01291"></a><a class="code" href="group__Group__AMI.html#g8c03c9dc4ab8279645aa28d8ec5d7290">01291</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g8c03c9dc4ab8279645aa28d8ec5d7290">action_waitevent</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293    <span class="keyword">const</span> <span class="keywordtype">char</span> *timeouts = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Timeout"</span>);
<a name="l01294"></a>01294    <span class="keywordtype">int</span> timeout = -1;
<a name="l01295"></a>01295    <span class="keywordtype">int</span> x;
<a name="l01296"></a>01296    <span class="keywordtype">int</span> needexit = 0;
<a name="l01297"></a>01297    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m,<span class="stringliteral">"ActionID"</span>);
<a name="l01298"></a>01298    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">""</span>;
<a name="l01299"></a>01299 
<a name="l01300"></a>01300    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l01301"></a>01301       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(timeouts)) {
<a name="l01304"></a>01304       sscanf(timeouts, <span class="stringliteral">"%i"</span>, &amp;timeout);
<a name="l01305"></a>01305       <span class="keywordflow">if</span> (timeout &lt; -1)
<a name="l01306"></a>01306          timeout = -1;
<a name="l01307"></a>01307       <span class="comment">/* XXX maybe put an upper bound, or prevent the use of 0 ? */</span>
<a name="l01308"></a>01308    }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01311"></a>01311    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> != <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>)
<a name="l01312"></a>01312       pthread_kill(s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a>, SIGURG);
<a name="l01313"></a>01313 
<a name="l01314"></a>01314    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a>) { <span class="comment">/* AMI-over-HTTP session */</span>
<a name="l01315"></a>01315       <span class="comment">/*</span>
<a name="l01316"></a>01316 <span class="comment">       * Make sure the timeout is within the expire time of the session,</span>
<a name="l01317"></a>01317 <span class="comment">       * as the client will likely abort the request if it does not see</span>
<a name="l01318"></a>01318 <span class="comment">       * data coming after some amount of time.</span>
<a name="l01319"></a>01319 <span class="comment">       */</span>
<a name="l01320"></a>01320       time_t now = time(NULL);
<a name="l01321"></a>01321       <span class="keywordtype">int</span> max = s-&gt;<a class="code" href="structmansession.html#cc09d7a7585e6c67ce40707760dd8ba2">sessiontimeout</a> - now - 10;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323       <span class="keywordflow">if</span> (max &lt; 0)   <span class="comment">/* We are already late. Strange but possible. */</span>
<a name="l01324"></a>01324          max = 0;
<a name="l01325"></a>01325       <span class="keywordflow">if</span> (timeout &lt; 0 || timeout &gt; max)
<a name="l01326"></a>01326          timeout = max;
<a name="l01327"></a>01327       <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">send_events</a>) <span class="comment">/* make sure we record events */</span>
<a name="l01328"></a>01328          s-&gt;<a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">send_events</a> = -1;
<a name="l01329"></a>01329    }
<a name="l01330"></a>01330    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332    <span class="comment">/* XXX should this go inside the lock ? */</span>
<a name="l01333"></a>01333    s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> = pthread_self(); <span class="comment">/* let new events wake up this thread */</span>
<a name="l01334"></a>01334    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01335"></a>01335       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Starting waiting for an event!\n"</span>);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337    <span class="keywordflow">for</span> (x=0; x &lt; timeout || timeout &lt; 0; x++) {
<a name="l01338"></a>01338       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01339"></a>01339       <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#gf074edf91f83d1f06f7e1bb384bb050a">NEW_EVENT</a>(s))
<a name="l01340"></a>01340          needexit = 1;
<a name="l01341"></a>01341       <span class="comment">/* We can have multiple HTTP session point to the same mansession entry.</span>
<a name="l01342"></a>01342 <span class="comment">       * The way we deal with it is not very nice: newcomers kick out the previous</span>
<a name="l01343"></a>01343 <span class="comment">       * HTTP session. XXX this needs to be improved.</span>
<a name="l01344"></a>01344 <span class="comment">       */</span>
<a name="l01345"></a>01345       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> != pthread_self())
<a name="l01346"></a>01346          needexit = 1;
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#550961e9c744e38a27b28e50d66f595d">needdestroy</a>)
<a name="l01348"></a>01348          needexit = 1;
<a name="l01349"></a>01349       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01350"></a>01350       <span class="keywordflow">if</span> (needexit)
<a name="l01351"></a>01351          <span class="keywordflow">break</span>;
<a name="l01352"></a>01352       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> == 0) {   <span class="comment">/* AMI session */</span>
<a name="l01353"></a>01353          <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#88e6eaa2c6fb4d77011df76d5d193728">ast_wait_for_input</a>(s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>, 1000))
<a name="l01354"></a>01354             <span class="keywordflow">break</span>;
<a name="l01355"></a>01355       } <span class="keywordflow">else</span> { <span class="comment">/* HTTP session */</span>
<a name="l01356"></a>01356          sleep(1);
<a name="l01357"></a>01357       }
<a name="l01358"></a>01358    }
<a name="l01359"></a>01359    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01360"></a>01360       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Finished waiting for an event!\n"</span>);
<a name="l01361"></a>01361    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01362"></a>01362    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> == pthread_self()) {
<a name="l01363"></a>01363       <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *eqe;
<a name="l01364"></a>01364       <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(s, m, <span class="stringliteral">"Success"</span>, <span class="stringliteral">"Waiting for Event completed."</span>);
<a name="l01365"></a>01365       <span class="keywordflow">while</span> ( (eqe = <a class="code" href="group__Group__AMI.html#gf074edf91f83d1f06f7e1bb384bb050a">NEW_EVENT</a>(s)) ) {
<a name="l01366"></a>01366          <a class="code" href="group__Group__AMI.html#ga640283e96a4cdde5b36633464a1318a">ref_event</a>(eqe);
<a name="l01367"></a>01367          <span class="keywordflow">if</span> (((s-&gt;<a class="code" href="structmansession.html#e12b8f9551a73d6196648b62754aa9e1">readperm</a> &amp; eqe-&gt;category) == eqe-&gt;category) &amp;&amp;
<a name="l01368"></a>01368              ((s-&gt;<a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">send_events</a> &amp; eqe-&gt;category) == eqe-&gt;category)) {
<a name="l01369"></a>01369             <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"%s"</span>, eqe-&gt;eventdata);
<a name="l01370"></a>01370          }
<a name="l01371"></a>01371          s-&gt;<a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">last_ev</a> = <a class="code" href="group__Group__AMI.html#gfb5ee4f215d8a2bd0f91355e21f53df5">unref_event</a>(s-&gt;<a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">last_ev</a>);
<a name="l01372"></a>01372       }
<a name="l01373"></a>01373       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,
<a name="l01374"></a>01374          <span class="stringliteral">"Event: WaitEventComplete\r\n"</span>
<a name="l01375"></a>01375          <span class="stringliteral">"%s"</span>
<a name="l01376"></a>01376          <span class="stringliteral">"\r\n"</span>, idText);
<a name="l01377"></a>01377       s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l01378"></a>01378    } <span class="keywordflow">else</span> {
<a name="l01379"></a>01379       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01380"></a>01380          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Abandoning event request!\n"</span>);
<a name="l01381"></a>01381    }
<a name="l01382"></a>01382    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01383"></a>01383    <span class="keywordflow">return</span> 0;
<a name="l01384"></a>01384 }
<a name="l01385"></a>01385 
<a name="l01386"></a><a class="code" href="group__Group__AMI.html#g8ff25cb8fe76a131a2401ce3e51ee07e">01386</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g8ff25cb8fe76a131a2401ce3e51ee07e">mandescr_listcommands</a>[] =
<a name="l01387"></a>01387 <span class="stringliteral">"Description: Returns the action name and synopsis for every\n"</span>
<a name="l01388"></a>01388 <span class="stringliteral">"  action that is available to the user\n"</span>
<a name="l01389"></a>01389 <span class="stringliteral">"Variables: NONE\n"</span>;
<a name="l01390"></a>01390 <span class="comment"></span>
<a name="l01391"></a>01391 <span class="comment">/*! \note The actionlock is read-locked by the caller of this function */</span>
<a name="l01392"></a><a class="code" href="group__Group__AMI.html#gc47a6ddacfc4e36cfb9ab30e2baf7de0">01392</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gc47a6ddacfc4e36cfb9ab30e2baf7de0">action_listcommands</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01393"></a>01393 {
<a name="l01394"></a>01394    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur;
<a name="l01395"></a>01395    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *temp = <a class="code" href="strings_8h.html#15892382538fcffb4bd4216c8956c428">ast_str_alloca</a>(BUFSIZ); <span class="comment">/* XXX very large ? */</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l01398"></a>01398    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>; cur; cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) { <span class="comment">/* Walk the list of actions */</span>
<a name="l01399"></a>01399       <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="structmansession.html#1cc72854e73b9b510a12e993d6479e86">writeperm</a> &amp; cur-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>) == cur-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>)
<a name="l01400"></a>01400          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"%s: %s (Priv: %s)\r\n"</span>,
<a name="l01401"></a>01401             cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, cur-&gt;<a class="code" href="structmanager__action.html#512fbb4e7b617c04031f58b631f2b05d">synopsis</a>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(cur-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>, &amp;temp));
<a name="l01402"></a>01402    }
<a name="l01403"></a>01403    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"\r\n"</span>);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405    <span class="keywordflow">return</span> 0;
<a name="l01406"></a>01406 }
<a name="l01407"></a>01407 
<a name="l01408"></a><a class="code" href="group__Group__AMI.html#gadfa58476f08d0f14e4209140d4ddf57">01408</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gadfa58476f08d0f14e4209140d4ddf57">mandescr_events</a>[] =
<a name="l01409"></a>01409 <span class="stringliteral">"Description: Enable/Disable sending of events to this manager\n"</span>
<a name="l01410"></a>01410 <span class="stringliteral">"  client.\n"</span>
<a name="l01411"></a>01411 <span class="stringliteral">"Variables:\n"</span>
<a name="l01412"></a>01412 <span class="stringliteral">"  EventMask: 'on' if all events should be sent,\n"</span>
<a name="l01413"></a>01413 <span class="stringliteral">"     'off' if no events should be sent,\n"</span>
<a name="l01414"></a>01414 <span class="stringliteral">"     'system,call,log' to select which flags events should have to be sent.\n"</span>;
<a name="l01415"></a>01415 
<a name="l01416"></a><a class="code" href="group__Group__AMI.html#g77d280f8038dfa2bb4b1ea13569c07df">01416</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g77d280f8038dfa2bb4b1ea13569c07df">action_events</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01417"></a>01417 {
<a name="l01418"></a>01418    <span class="keyword">const</span> <span class="keywordtype">char</span> *mask = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"EventMask"</span>);
<a name="l01419"></a>01419    <span class="keywordtype">int</span> res;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    res = <a class="code" href="group__Group__AMI.html#gca4968afc65b84cc5b3781d465536b32">set_eventmask</a>(s, mask);
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (res &gt; 0)
<a name="l01423"></a>01423       <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(s, m, <span class="stringliteral">"Events On"</span>, NULL);
<a name="l01424"></a>01424    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 0)
<a name="l01425"></a>01425       <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(s, m, <span class="stringliteral">"Events Off"</span>, NULL);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427    <span class="keywordflow">return</span> 0;
<a name="l01428"></a>01428 }
<a name="l01429"></a>01429 
<a name="l01430"></a><a class="code" href="group__Group__AMI.html#g4eb25b527bf76f2c94ee7f6a1727706c">01430</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g4eb25b527bf76f2c94ee7f6a1727706c">mandescr_logoff</a>[] =
<a name="l01431"></a>01431 <span class="stringliteral">"Description: Logoff this manager session\n"</span>
<a name="l01432"></a>01432 <span class="stringliteral">"Variables: NONE\n"</span>;
<a name="l01433"></a>01433 
<a name="l01434"></a><a class="code" href="group__Group__AMI.html#g655a6b9be76687e4d0887bffacd41b3d">01434</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g655a6b9be76687e4d0887bffacd41b3d">action_logoff</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01435"></a>01435 {
<a name="l01436"></a>01436    <a class="code" href="group__Group__AMI.html#g005978ca7456f4c36c0cd89907d68fdb">astman_send_response</a>(s, m, <span class="stringliteral">"Goodbye"</span>, <span class="stringliteral">"Thanks for all the fish."</span>);
<a name="l01437"></a>01437    <span class="keywordflow">return</span> -1;
<a name="l01438"></a>01438 }
<a name="l01439"></a>01439 
<a name="l01440"></a><a class="code" href="group__Group__AMI.html#gbd3f1f5c2f6fa1c0db6646c765751566">01440</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gbd3f1f5c2f6fa1c0db6646c765751566">action_login</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01441"></a>01441 {
<a name="l01442"></a>01442    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g0c601c39a357acbe91e4070d54d89001">authenticate</a>(s, m)) {
<a name="l01443"></a>01443       sleep(1);
<a name="l01444"></a>01444       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Authentication failed"</span>);
<a name="l01445"></a>01445       <span class="keywordflow">return</span> -1;
<a name="l01446"></a>01446    }
<a name="l01447"></a>01447    s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> = 1;
<a name="l01448"></a>01448    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) {
<a name="l01449"></a>01449       <span class="keywordflow">if</span> (displayconnects) {
<a name="l01450"></a>01450          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"%sManager '%s' logged on from %s\n"</span>, (s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> ? <span class="stringliteral">"HTTP "</span> : <span class="stringliteral">""</span>), s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l01451"></a>01451       }
<a name="l01452"></a>01452    }
<a name="l01453"></a>01453    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4671d62857becc386bbe4cfdc0d96fdc">LOG_EVENT</a>, <span class="stringliteral">"%sManager '%s' logged on from %s\n"</span>, (s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> ? <span class="stringliteral">"HTTP "</span> : <span class="stringliteral">""</span>), s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l01454"></a>01454    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Authentication accepted"</span>);
<a name="l01455"></a>01455    <span class="keywordflow">return</span> 0;
<a name="l01456"></a>01456 }
<a name="l01457"></a>01457 
<a name="l01458"></a><a class="code" href="group__Group__AMI.html#g9ba77c553c77f8cd95e812fc9a3cbf38">01458</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g9ba77c553c77f8cd95e812fc9a3cbf38">action_challenge</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01459"></a>01459 {
<a name="l01460"></a>01460    <span class="keyword">const</span> <span class="keywordtype">char</span> *authtype = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"AuthType"</span>);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462    <span class="keywordflow">if</span> (!strcasecmp(authtype, <span class="stringliteral">"MD5"</span>)) {
<a name="l01463"></a>01463       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>))
<a name="l01464"></a>01464          snprintf(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>, <span class="keyword">sizeof</span>(s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>), <span class="stringliteral">"%ld"</span>, <a class="code" href="utils_8c.html#53deb5f5670a96e205366cdb36097667">ast_random</a>());
<a name="l01465"></a>01465       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01466"></a>01466       <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l01467"></a>01467       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Challenge: %s\r\n\r\n"</span>, s-&gt;<a class="code" href="structmansession.html#35a1613258a052cc893255c98df3338a">challenge</a>);
<a name="l01468"></a>01468       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l01469"></a>01469    } <span class="keywordflow">else</span> {
<a name="l01470"></a>01470       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Must specify AuthType"</span>);
<a name="l01471"></a>01471    }
<a name="l01472"></a>01472    <span class="keywordflow">return</span> 0;
<a name="l01473"></a>01473 }
<a name="l01474"></a>01474 
<a name="l01475"></a><a class="code" href="group__Group__AMI.html#gcd3c210737ab7a7dea258825b16345a4">01475</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gcd3c210737ab7a7dea258825b16345a4">mandescr_hangup</a>[] =
<a name="l01476"></a>01476 <span class="stringliteral">"Description: Hangup a channel\n"</span>
<a name="l01477"></a>01477 <span class="stringliteral">"Variables: \n"</span>
<a name="l01478"></a>01478 <span class="stringliteral">"  Channel: The channel name to be hungup\n"</span>;
<a name="l01479"></a>01479 
<a name="l01480"></a><a class="code" href="group__Group__AMI.html#gcee30e0477fbe6f85ac98e124a25289d">01480</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gcee30e0477fbe6f85ac98e124a25289d">action_hangup</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01481"></a>01481 {
<a name="l01482"></a>01482    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l01483"></a>01483    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01484"></a>01484    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l01485"></a>01485       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l01486"></a>01486       <span class="keywordflow">return</span> 0;
<a name="l01487"></a>01487    }
<a name="l01488"></a>01488    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01489"></a>01489    <span class="keywordflow">if</span> (!c) {
<a name="l01490"></a>01490       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l01491"></a>01491       <span class="keywordflow">return</span> 0;
<a name="l01492"></a>01492    }
<a name="l01493"></a>01493    <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(c, <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1fe8eae384d045bee039ff9140421beb8">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01494"></a>01494    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01495"></a>01495    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Channel Hungup"</span>);
<a name="l01496"></a>01496    <span class="keywordflow">return</span> 0;
<a name="l01497"></a>01497 }
<a name="l01498"></a>01498 
<a name="l01499"></a><a class="code" href="group__Group__AMI.html#g011be8a601adfe631d2040fd2b3e347d">01499</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g011be8a601adfe631d2040fd2b3e347d">mandescr_setvar</a>[] =
<a name="l01500"></a>01500 <span class="stringliteral">"Description: Set a global or local channel variable.\n"</span>
<a name="l01501"></a>01501 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01502"></a>01502 <span class="stringliteral">"  Channel: Channel to set variable for\n"</span>
<a name="l01503"></a>01503 <span class="stringliteral">"  *Variable: Variable name\n"</span>
<a name="l01504"></a>01504 <span class="stringliteral">"  *Value: Value\n"</span>;
<a name="l01505"></a>01505 
<a name="l01506"></a><a class="code" href="group__Group__AMI.html#gff61c40432e7043889c37096ac0560c7">01506</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gff61c40432e7043889c37096ac0560c7">action_setvar</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01507"></a>01507 {
<a name="l01508"></a>01508         <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l01509"></a>01509    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01510"></a>01510    <span class="keyword">const</span> <span class="keywordtype">char</span> *varname = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Variable"</span>);
<a name="l01511"></a>01511    <span class="keyword">const</span> <span class="keywordtype">char</span> *varval = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Value"</span>);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(varname)) {
<a name="l01514"></a>01514       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No variable specified"</span>);
<a name="l01515"></a>01515       <span class="keywordflow">return</span> 0;
<a name="l01516"></a>01516    }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(varval)) {
<a name="l01519"></a>01519       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No value specified"</span>);
<a name="l01520"></a>01520       <span class="keywordflow">return</span> 0;
<a name="l01521"></a>01521    }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l01524"></a>01524       c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01525"></a>01525       <span class="keywordflow">if</span> (!c) {
<a name="l01526"></a>01526          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l01527"></a>01527          <span class="keywordflow">return</span> 0;
<a name="l01528"></a>01528       }
<a name="l01529"></a>01529    }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531    <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(c, varname, varval);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533    <span class="keywordflow">if</span> (c)
<a name="l01534"></a>01534       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01535"></a>01535 
<a name="l01536"></a>01536    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Variable Set"</span>);
<a name="l01537"></a>01537 
<a name="l01538"></a>01538    <span class="keywordflow">return</span> 0;
<a name="l01539"></a>01539 }
<a name="l01540"></a>01540 
<a name="l01541"></a><a class="code" href="group__Group__AMI.html#g7e44f6255d335a2c07e5a08424d9ab47">01541</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g7e44f6255d335a2c07e5a08424d9ab47">mandescr_getvar</a>[] =
<a name="l01542"></a>01542 <span class="stringliteral">"Description: Get the value of a global or local channel variable.\n"</span>
<a name="l01543"></a>01543 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01544"></a>01544 <span class="stringliteral">"  Channel: Channel to read variable from\n"</span>
<a name="l01545"></a>01545 <span class="stringliteral">"  *Variable: Variable name\n"</span>
<a name="l01546"></a>01546 <span class="stringliteral">"  ActionID: Optional Action id for message matching.\n"</span>;
<a name="l01547"></a>01547 
<a name="l01548"></a><a class="code" href="group__Group__AMI.html#gdb0963bfde8071d731420ac8def41f9e">01548</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gdb0963bfde8071d731420ac8def41f9e">action_getvar</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01549"></a>01549 {
<a name="l01550"></a>01550    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l01551"></a>01551    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01552"></a>01552    <span class="keyword">const</span> <span class="keywordtype">char</span> *varname = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Variable"</span>);
<a name="l01553"></a>01553    <span class="keywordtype">char</span> *varval;
<a name="l01554"></a>01554    <span class="keywordtype">char</span> workspace[1024] = <span class="stringliteral">""</span>;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(varname)) {
<a name="l01557"></a>01557       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No variable specified"</span>);
<a name="l01558"></a>01558       <span class="keywordflow">return</span> 0;
<a name="l01559"></a>01559    }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l01562"></a>01562       c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01563"></a>01563       <span class="keywordflow">if</span> (!c) {
<a name="l01564"></a>01564          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l01565"></a>01565          <span class="keywordflow">return</span> 0;
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567    }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569    <span class="keywordflow">if</span> (varname[strlen(varname) - 1] == <span class="charliteral">')'</span>) {
<a name="l01570"></a>01570       <a class="code" href="pbx_8c.html#fc067f1890b3fdeeacbc538e92a39fbd">ast_func_read</a>(c, (<span class="keywordtype">char</span> *) varname, workspace, <span class="keyword">sizeof</span>(workspace));
<a name="l01571"></a>01571       varval = workspace;
<a name="l01572"></a>01572    } <span class="keywordflow">else</span> {
<a name="l01573"></a>01573       <a class="code" href="pbx_8c.html#2753b759766c3d305e2551f63e403677">pbx_retrieve_variable</a>(c, varname, &amp;varval, workspace, <span class="keyword">sizeof</span>(workspace), NULL);
<a name="l01574"></a>01574    }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576    <span class="keywordflow">if</span> (c)
<a name="l01577"></a>01577       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01578"></a>01578    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l01579"></a>01579    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Variable: %s\r\nValue: %s\r\n\r\n"</span>, varname, varval);
<a name="l01580"></a>01580 
<a name="l01581"></a>01581    <span class="keywordflow">return</span> 0;
<a name="l01582"></a>01582 }
<a name="l01583"></a>01583 
<a name="l01584"></a>01584 <span class="comment"></span>
<a name="l01585"></a>01585 <span class="comment">/*! \brief Manager "status" command to show channels */</span>
<a name="l01586"></a>01586 <span class="comment">/* Needs documentation... */</span>
<a name="l01587"></a><a class="code" href="group__Group__AMI.html#g6a023aadcdeed0f3c8db7756f06a85fe">01587</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g6a023aadcdeed0f3c8db7756f06a85fe">action_status</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m,<span class="stringliteral">"Channel"</span>);
<a name="l01590"></a>01590    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l01591"></a>01591    <span class="keywordtype">char</span> bridge[256];
<a name="l01592"></a>01592    <span class="keyword">struct </span>timeval now = ast_tvnow();
<a name="l01593"></a>01593    <span class="keywordtype">long</span> elapsed_seconds = 0;
<a name="l01594"></a>01594    <span class="keywordtype">int</span> all = <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name); <span class="comment">/* set if we want all channels */</span>
<a name="l01595"></a>01595    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m,<span class="stringliteral">"ActionID"</span>);
<a name="l01596"></a>01596    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">""</span>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l01599"></a>01599       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l01600"></a>01600 
<a name="l01601"></a>01601    <span class="keywordflow">if</span> (all)
<a name="l01602"></a>01602       c = <a class="code" href="channel_8c.html#8ada12445e0d71c8bcd465f6838bf4e5">ast_channel_walk_locked</a>(NULL);
<a name="l01603"></a>01603    <span class="keywordflow">else</span> {
<a name="l01604"></a>01604       c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01605"></a>01605       <span class="keywordflow">if</span> (!c) {
<a name="l01606"></a>01606          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l01607"></a>01607          <span class="keywordflow">return</span> 0;
<a name="l01608"></a>01608       }
<a name="l01609"></a>01609    }
<a name="l01610"></a>01610    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Channel status will follow"</span>);
<a name="l01611"></a>01611    <span class="comment">/* if we look by name, we break after the first iteration */</span>
<a name="l01612"></a>01612    <span class="keywordflow">while</span> (c) {
<a name="l01613"></a>01613       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>)
<a name="l01614"></a>01614          snprintf(bridge, <span class="keyword">sizeof</span>(bridge), <span class="stringliteral">"Link: %s\r\n"</span>, c-&gt;<a class="code" href="structast__channel.html#d1256a036a9f1d1bb86a04aa3e2c35dd">_bridge</a>-&gt;name);
<a name="l01615"></a>01615       <span class="keywordflow">else</span>
<a name="l01616"></a>01616          bridge[0] = <span class="charliteral">'\0'</span>;
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a>) {
<a name="l01618"></a>01618          <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {
<a name="l01619"></a>01619             elapsed_seconds = now.tv_sec - c-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ea2b2676c28c0db26d39331a336c6b92">start</a>.tv_sec;
<a name="l01620"></a>01620          }
<a name="l01621"></a>01621          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,
<a name="l01622"></a>01622          <span class="stringliteral">"Event: Status\r\n"</span>
<a name="l01623"></a>01623          <span class="stringliteral">"Privilege: Call\r\n"</span>
<a name="l01624"></a>01624          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l01625"></a>01625          <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l01626"></a>01626          <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l01627"></a>01627          <span class="stringliteral">"Account: %s\r\n"</span>
<a name="l01628"></a>01628          <span class="stringliteral">"State: %s\r\n"</span>
<a name="l01629"></a>01629          <span class="stringliteral">"Context: %s\r\n"</span>
<a name="l01630"></a>01630          <span class="stringliteral">"Extension: %s\r\n"</span>
<a name="l01631"></a>01631          <span class="stringliteral">"Priority: %d\r\n"</span>
<a name="l01632"></a>01632          <span class="stringliteral">"Seconds: %ld\r\n"</span>
<a name="l01633"></a>01633          <span class="stringliteral">"%s"</span>
<a name="l01634"></a>01634          <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l01635"></a>01635          <span class="stringliteral">"%s"</span>
<a name="l01636"></a>01636          <span class="stringliteral">"\r\n"</span>,
<a name="l01637"></a>01637          c-&gt;name,
<a name="l01638"></a>01638          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01639"></a>01639          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01640"></a>01640          c-&gt;accountcode,
<a name="l01641"></a>01641          <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>), c-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>,
<a name="l01642"></a>01642          c-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, c-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>, (<span class="keywordtype">long</span>)elapsed_seconds, bridge, c-&gt;uniqueid, idText);
<a name="l01643"></a>01643       } <span class="keywordflow">else</span> {
<a name="l01644"></a>01644          <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,
<a name="l01645"></a>01645          <span class="stringliteral">"Event: Status\r\n"</span>
<a name="l01646"></a>01646          <span class="stringliteral">"Privilege: Call\r\n"</span>
<a name="l01647"></a>01647          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l01648"></a>01648          <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l01649"></a>01649          <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l01650"></a>01650          <span class="stringliteral">"Account: %s\r\n"</span>
<a name="l01651"></a>01651          <span class="stringliteral">"State: %s\r\n"</span>
<a name="l01652"></a>01652          <span class="stringliteral">"%s"</span>
<a name="l01653"></a>01653          <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l01654"></a>01654          <span class="stringliteral">"%s"</span>
<a name="l01655"></a>01655          <span class="stringliteral">"\r\n"</span>,
<a name="l01656"></a>01656          c-&gt;name,
<a name="l01657"></a>01657          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01658"></a>01658          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01659"></a>01659          c-&gt;accountcode,
<a name="l01660"></a>01660          <a class="code" href="channel_8c.html#1c242fd13329f5600ccd56263aba7272">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>), bridge, c-&gt;uniqueid, idText);
<a name="l01661"></a>01661       }
<a name="l01662"></a>01662       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01663"></a>01663       <span class="keywordflow">if</span> (!all)
<a name="l01664"></a>01664          <span class="keywordflow">break</span>;
<a name="l01665"></a>01665       c = <a class="code" href="channel_8c.html#8ada12445e0d71c8bcd465f6838bf4e5">ast_channel_walk_locked</a>(c);
<a name="l01666"></a>01666    }
<a name="l01667"></a>01667    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,
<a name="l01668"></a>01668    <span class="stringliteral">"Event: StatusComplete\r\n"</span>
<a name="l01669"></a>01669    <span class="stringliteral">"%s"</span>
<a name="l01670"></a>01670    <span class="stringliteral">"\r\n"</span>,idText);
<a name="l01671"></a>01671    <span class="keywordflow">return</span> 0;
<a name="l01672"></a>01672 }
<a name="l01673"></a>01673 
<a name="l01674"></a><a class="code" href="group__Group__AMI.html#g718ec14078a25254e40cb5ea875d4955">01674</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g718ec14078a25254e40cb5ea875d4955">mandescr_sendtext</a>[] =
<a name="l01675"></a>01675 <span class="stringliteral">"Description: Sends A Text Message while in a call.\n"</span>
<a name="l01676"></a>01676 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01677"></a>01677 <span class="stringliteral">"       *Channel: Channel to send message to\n"</span>
<a name="l01678"></a>01678 <span class="stringliteral">"       *Message: Message to send\n"</span>
<a name="l01679"></a>01679 <span class="stringliteral">"       ActionID: Optional Action id for message matching.\n"</span>;
<a name="l01680"></a>01680 
<a name="l01681"></a><a class="code" href="group__Group__AMI.html#g250e20c09ed384cd90623cfd01f8b551">01681</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g250e20c09ed384cd90623cfd01f8b551">action_sendtext</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01682"></a>01682 {
<a name="l01683"></a>01683    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l01684"></a>01684    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01685"></a>01685    <span class="keyword">const</span> <span class="keywordtype">char</span> *textmsg = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Message"</span>);
<a name="l01686"></a>01686    <span class="keywordtype">int</span> res = 0;
<a name="l01687"></a>01687 
<a name="l01688"></a>01688    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l01689"></a>01689       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l01690"></a>01690       <span class="keywordflow">return</span> 0;
<a name="l01691"></a>01691    }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(textmsg)) {
<a name="l01694"></a>01694       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No Message specified"</span>);
<a name="l01695"></a>01695       <span class="keywordflow">return</span> 0;
<a name="l01696"></a>01696    }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01699"></a>01699    <span class="keywordflow">if</span> (!c) {
<a name="l01700"></a>01700       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l01701"></a>01701       <span class="keywordflow">return</span> 0;
<a name="l01702"></a>01702    }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704    res = <a class="code" href="channel_8c.html#3274faaaeb7a5646df6beead26f9ce8f">ast_sendtext</a>(c, textmsg);
<a name="l01705"></a>01705    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;c-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l01706"></a>01706    
<a name="l01707"></a>01707    <span class="keywordflow">if</span> (res &gt; 0)
<a name="l01708"></a>01708       <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Success"</span>);
<a name="l01709"></a>01709    <span class="keywordflow">else</span>
<a name="l01710"></a>01710       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Failure"</span>);
<a name="l01711"></a>01711    
<a name="l01712"></a>01712    <span class="keywordflow">return</span> res;
<a name="l01713"></a>01713 }
<a name="l01714"></a>01714 
<a name="l01715"></a><a class="code" href="group__Group__AMI.html#gac91809519e0b430f42ce4cfdf5c5a2a">01715</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gac91809519e0b430f42ce4cfdf5c5a2a">mandescr_redirect</a>[] =
<a name="l01716"></a>01716 <span class="stringliteral">"Description: Redirect (transfer) a call.\n"</span>
<a name="l01717"></a>01717 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01718"></a>01718 <span class="stringliteral">"  *Channel: Channel to redirect\n"</span>
<a name="l01719"></a>01719 <span class="stringliteral">"  ExtraChannel: Second call leg to transfer (optional)\n"</span>
<a name="l01720"></a>01720 <span class="stringliteral">"  *Exten: Extension to transfer to\n"</span>
<a name="l01721"></a>01721 <span class="stringliteral">"  *Context: Context to transfer to\n"</span>
<a name="l01722"></a>01722 <span class="stringliteral">"  *Priority: Priority to transfer to\n"</span>
<a name="l01723"></a>01723 <span class="stringliteral">"  ActionID: Optional Action id for message matching.\n"</span>;
<a name="l01724"></a>01724 <span class="comment"></span>
<a name="l01725"></a>01725 <span class="comment">/*! \brief  action_redirect: The redirect manager command */</span>
<a name="l01726"></a><a class="code" href="group__Group__AMI.html#g0076609fb6806996b6584b7a37870927">01726</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g0076609fb6806996b6584b7a37870927">action_redirect</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01727"></a>01727 {
<a name="l01728"></a>01728    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01729"></a>01729    <span class="keyword">const</span> <span class="keywordtype">char</span> *name2 = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ExtraChannel"</span>);
<a name="l01730"></a>01730    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Exten"</span>);
<a name="l01731"></a>01731    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Context"</span>);
<a name="l01732"></a>01732    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Priority"</span>);
<a name="l01733"></a>01733    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, *chan2 = NULL;
<a name="l01734"></a>01734    <span class="keywordtype">int</span> pi = 0;
<a name="l01735"></a>01735    <span class="keywordtype">int</span> res;
<a name="l01736"></a>01736 
<a name="l01737"></a>01737    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l01738"></a>01738       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Channel not specified"</span>);
<a name="l01739"></a>01739       <span class="keywordflow">return</span> 0;
<a name="l01740"></a>01740    }
<a name="l01741"></a>01741    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(priority) &amp;&amp; (sscanf(priority, <span class="stringliteral">"%d"</span>, &amp;pi) != 1)) {
<a name="l01742"></a>01742       <span class="keywordflow">if</span> ((pi = <a class="code" href="pbx_8c.html#6f1b63f69b489517c49ccfecdbe1642e">ast_findlabel_extension</a>(NULL, context, exten, priority, NULL)) &lt; 1) {
<a name="l01743"></a>01743          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Invalid priority\n"</span>);
<a name="l01744"></a>01744          <span class="keywordflow">return</span> 0;
<a name="l01745"></a>01745       }
<a name="l01746"></a>01746    }
<a name="l01747"></a>01747    <span class="comment">/* XXX watch out, possible deadlock - we are trying to get two channels!!! */</span>
<a name="l01748"></a>01748    chan = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l01749"></a>01749    <span class="keywordflow">if</span> (!chan) {
<a name="l01750"></a>01750       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[BUFSIZ];
<a name="l01751"></a>01751       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"Channel does not exist: %s"</span>, name);
<a name="l01752"></a>01752       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, buf);
<a name="l01753"></a>01753       <span class="keywordflow">return</span> 0;
<a name="l01754"></a>01754    }
<a name="l01755"></a>01755    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan)) {
<a name="l01756"></a>01756       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Redirect failed, channel not up.\n"</span>);
<a name="l01757"></a>01757       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01758"></a>01758       <span class="keywordflow">return</span> 0;
<a name="l01759"></a>01759    }
<a name="l01760"></a>01760    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name2))
<a name="l01761"></a>01761       chan2 = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name2);
<a name="l01762"></a>01762    <span class="keywordflow">if</span> (chan2 &amp;&amp; <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan2)) {
<a name="l01763"></a>01763       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Redirect failed, extra channel not up.\n"</span>);
<a name="l01764"></a>01764       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01765"></a>01765       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan2);
<a name="l01766"></a>01766       <span class="keywordflow">return</span> 0;
<a name="l01767"></a>01767    }
<a name="l01768"></a>01768    res = <a class="code" href="pbx_8c.html#563b92a651459898f8ccfdc367746147">ast_async_goto</a>(chan, context, exten, pi);
<a name="l01769"></a>01769    <span class="keywordflow">if</span> (!res) {
<a name="l01770"></a>01770       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name2)) {
<a name="l01771"></a>01771          <span class="keywordflow">if</span> (chan2)
<a name="l01772"></a>01772             res = <a class="code" href="pbx_8c.html#563b92a651459898f8ccfdc367746147">ast_async_goto</a>(chan2, context, exten, pi);
<a name="l01773"></a>01773          <span class="keywordflow">else</span>
<a name="l01774"></a>01774             res = -1;
<a name="l01775"></a>01775          <span class="keywordflow">if</span> (!res)
<a name="l01776"></a>01776             <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Dual Redirect successful"</span>);
<a name="l01777"></a>01777          <span class="keywordflow">else</span>
<a name="l01778"></a>01778             <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Secondary redirect failed"</span>);
<a name="l01779"></a>01779       } <span class="keywordflow">else</span>
<a name="l01780"></a>01780          <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Redirect successful"</span>);
<a name="l01781"></a>01781    } <span class="keywordflow">else</span>
<a name="l01782"></a>01782       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Redirect failed"</span>);
<a name="l01783"></a>01783    <span class="keywordflow">if</span> (chan)
<a name="l01784"></a>01784       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01785"></a>01785    <span class="keywordflow">if</span> (chan2)
<a name="l01786"></a>01786       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan2);
<a name="l01787"></a>01787    <span class="keywordflow">return</span> 0;
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01790"></a><a class="code" href="group__Group__AMI.html#g7ef45bd71ec09dcb2c7e6b8d6e48e57f">01790</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g7ef45bd71ec09dcb2c7e6b8d6e48e57f">mandescr_command</a>[] =
<a name="l01791"></a>01791 <span class="stringliteral">"Description: Run a CLI command.\n"</span>
<a name="l01792"></a>01792 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01793"></a>01793 <span class="stringliteral">"  *Command: Asterisk CLI command to run\n"</span>
<a name="l01794"></a>01794 <span class="stringliteral">"  ActionID: Optional Action id for message matching.\n"</span>;
<a name="l01795"></a>01795 <span class="comment"></span>
<a name="l01796"></a>01796 <span class="comment">/*! \brief  Manager command "command" - execute CLI command */</span>
<a name="l01797"></a><a class="code" href="group__Group__AMI.html#g6c71a4a16dd2e3115f1235a25a8fdb70">01797</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g6c71a4a16dd2e3115f1235a25a8fdb70">action_command</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01798"></a>01798 {
<a name="l01799"></a>01799    <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Command"</span>);
<a name="l01800"></a>01800    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ActionID"</span>);
<a name="l01801"></a>01801    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, *final_buf;
<a name="l01802"></a>01802    <span class="keywordtype">char</span> <span class="keyword">template</span>[] = <span class="stringliteral">"/tmp/ast-ami-XXXXXX"</span>;  <span class="comment">/* template for temporary file */</span>
<a name="l01803"></a>01803    <span class="keywordtype">int</span> fd = mkstemp(<span class="keyword">template</span>), i = 0;
<a name="l01804"></a>01804    off_t l;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806    <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(<a class="code" href="group__Group__AMI.html#g7c3e6bc8d40097fbec8dfa709b99eee1">command_blacklist</a>) / <span class="keyword">sizeof</span>(command_blacklist[0]); i++) {
<a name="l01807"></a>01807       <span class="keywordflow">if</span> (!strncmp(cmd, command_blacklist[i], strlen(command_blacklist[i]))) {
<a name="l01808"></a>01808          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Command blacklisted"</span>);
<a name="l01809"></a>01809          <span class="keywordflow">return</span> 0;
<a name="l01810"></a>01810       }
<a name="l01811"></a>01811    }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Response: Follows\r\nPrivilege: Command\r\n"</span>);
<a name="l01814"></a>01814    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l01815"></a>01815       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l01816"></a>01816    <span class="comment">/* FIXME: Wedge a ActionID response in here, waiting for later changes */</span>
<a name="l01817"></a>01817    <a class="code" href="cli_8c.html#827723f4f6d9ba0111d178d8d931b892">ast_cli_command</a>(fd, cmd);  <span class="comment">/* XXX need to change this to use a FILE * */</span>
<a name="l01818"></a>01818    l = lseek(fd, 0, SEEK_END);   <span class="comment">/* how many chars available */</span>
<a name="l01819"></a>01819    buf = alloca(l + 1);
<a name="l01820"></a>01820    final_buf = alloca(l + 1);
<a name="l01821"></a>01821    lseek(fd, 0, SEEK_SET);
<a name="l01822"></a>01822    read(fd, buf, l);
<a name="l01823"></a>01823    buf[l] = <span class="charliteral">'\0'</span>;
<a name="l01824"></a>01824    close(fd);
<a name="l01825"></a>01825    unlink(<span class="keyword">template</span>);
<a name="l01826"></a>01826    <a class="code" href="term_8c.html#cb2ba128f046c586d89f3fc2359621a1">term_strip</a>(final_buf, buf, l);
<a name="l01827"></a>01827    final_buf[l] = <span class="charliteral">'\0'</span>;
<a name="l01828"></a>01828    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, final_buf);
<a name="l01829"></a>01829    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"--END COMMAND--\r\n\r\n"</span>);
<a name="l01830"></a>01830    <span class="keywordflow">return</span> 0;
<a name="l01831"></a>01831 }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 <span class="comment">/* helper function for originate */</span>
<a name="l01834"></a><a class="code" href="structfast__originate__helper.html">01834</a> <span class="keyword">struct </span><a class="code" href="structfast__originate__helper.html">fast_originate_helper</a> {
<a name="l01835"></a><a class="code" href="structfast__originate__helper.html#646099ae10c2b6f54bbbd25d705d326b">01835</a>    <span class="keywordtype">char</span> <a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01836"></a><a class="code" href="structfast__originate__helper.html#9a1c389bd0690d134877ca3ca177c8d2">01836</a>    <span class="keywordtype">char</span> <a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01837"></a><a class="code" href="structfast__originate__helper.html#90272dda245ae1fb3cf197e91a8689dc">01837</a>    <span class="keywordtype">int</span> timeout;
<a name="l01838"></a><a class="code" href="structfast__originate__helper.html#d87b6ee5a83ee70a6697ba886125ae9e">01838</a>    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>[<a class="code" href="pbx_8h.html#a973a2fecfe2da6df7aaf2d5be3ea548">AST_MAX_APP</a>];
<a name="l01839"></a><a class="code" href="structfast__originate__helper.html#c59a3713a42d7885b689012cb769c29f">01839</a>    <span class="keywordtype">char</span> appdata[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01840"></a><a class="code" href="structfast__originate__helper.html#70f178a59d8df82fe5e107da71415b9b">01840</a>    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01841"></a><a class="code" href="structfast__originate__helper.html#ca3c0eb6b6e898f3a32aed5de1320774">01841</a>    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01842"></a><a class="code" href="structfast__originate__helper.html#c1ae8ba118483c4c23841d72b5e7ebbb">01842</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>[<a class="code" href="channel_8h.html#4d1ee7076af5032452aaba4ead082588">AST_MAX_CONTEXT</a>];
<a name="l01843"></a><a class="code" href="structfast__originate__helper.html#5aedfeaeaac21e5e5f297360633ea9a3">01843</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01844"></a><a class="code" href="structfast__originate__helper.html#0b9b4614d6434ea0573c89d67e0170b7">01844</a>    <span class="keywordtype">char</span> idtext[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01845"></a><a class="code" href="structfast__originate__helper.html#a68ae5b7bc66091c1f471b9d6ebb5293">01845</a>    <span class="keywordtype">char</span> account[<a class="code" href="cdr_8h.html#d8d4da3f29223013ea5caf3addc18000">AST_MAX_ACCOUNT_CODE</a>];
<a name="l01846"></a><a class="code" href="structfast__originate__helper.html#b988295c268025b49dfb3df26171ddc3">01846</a>    <span class="keywordtype">int</span> <a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>;
<a name="l01847"></a><a class="code" href="structfast__originate__helper.html#b63119da730344b345cdc8f62a4711e9">01847</a>    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *vars;
<a name="l01848"></a>01848 };
<a name="l01849"></a>01849 
<a name="l01850"></a><a class="code" href="group__Group__AMI.html#g07edcd94b098b94138489a2a65ce84f8">01850</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="group__Group__AMI.html#g07edcd94b098b94138489a2a65ce84f8">fast_originate</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l01851"></a>01851 {
<a name="l01852"></a>01852    <span class="keyword">struct </span><a class="code" href="structfast__originate__helper.html">fast_originate_helper</a> *in = data;
<a name="l01853"></a>01853    <span class="keywordtype">int</span> res;
<a name="l01854"></a>01854    <span class="keywordtype">int</span> reason = 0;
<a name="l01855"></a>01855    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> = NULL;
<a name="l01856"></a>01856    <span class="keywordtype">char</span> requested_channel[<a class="code" href="channel_8h.html#57fb43d64b209037cdc198f3db578d39">AST_CHANNEL_NAME</a>];
<a name="l01857"></a>01857 
<a name="l01858"></a>01858    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#d87b6ee5a83ee70a6697ba886125ae9e">app</a>)) {
<a name="l01859"></a>01859       res = <a class="code" href="pbx_8c.html#8bd05d7cdf218eaecfb4a33dd0eb32d8">ast_pbx_outgoing_app</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#646099ae10c2b6f54bbbd25d705d326b">tech</a>, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#9a1c389bd0690d134877ca3ca177c8d2">data</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#90272dda245ae1fb3cf197e91a8689dc">timeout</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#d87b6ee5a83ee70a6697ba886125ae9e">app</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#c59a3713a42d7885b689012cb769c29f">appdata</a>, &amp;reason, 1,
<a name="l01860"></a>01860          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, NULL),
<a name="l01861"></a>01861          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, NULL),
<a name="l01862"></a>01862          in-&gt;<a class="code" href="structfast__originate__helper.html#b63119da730344b345cdc8f62a4711e9">vars</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#a68ae5b7bc66091c1f471b9d6ebb5293">account</a>, &amp;chan);
<a name="l01863"></a>01863    } <span class="keywordflow">else</span> {
<a name="l01864"></a>01864       res = <a class="code" href="pbx_8c.html#1b1911a618935b371e69b60c66cf6221">ast_pbx_outgoing_exten</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#646099ae10c2b6f54bbbd25d705d326b">tech</a>, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#9a1c389bd0690d134877ca3ca177c8d2">data</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#90272dda245ae1fb3cf197e91a8689dc">timeout</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#b988295c268025b49dfb3df26171ddc3">priority</a>, &amp;reason, 1,
<a name="l01865"></a>01865          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, NULL),
<a name="l01866"></a>01866          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, NULL),
<a name="l01867"></a>01867          in-&gt;<a class="code" href="structfast__originate__helper.html#b63119da730344b345cdc8f62a4711e9">vars</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#a68ae5b7bc66091c1f471b9d6ebb5293">account</a>, &amp;chan);
<a name="l01868"></a>01868    }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870    <span class="keywordflow">if</span> (!chan)
<a name="l01871"></a>01871       snprintf(requested_channel, <a class="code" href="channel_8h.html#57fb43d64b209037cdc198f3db578d39">AST_CHANNEL_NAME</a>, <span class="stringliteral">"%s/%s"</span>, in-&gt;<a class="code" href="structfast__originate__helper.html#646099ae10c2b6f54bbbd25d705d326b">tech</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#9a1c389bd0690d134877ca3ca177c8d2">data</a>);   
<a name="l01872"></a>01872    <span class="comment">/* Tell the manager what happened with the channel */</span>
<a name="l01873"></a>01873    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"OriginateResponse"</span>,
<a name="l01874"></a>01874       <span class="stringliteral">"%s"</span>
<a name="l01875"></a>01875       <span class="stringliteral">"Response: %s\r\n"</span>
<a name="l01876"></a>01876       <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l01877"></a>01877       <span class="stringliteral">"Context: %s\r\n"</span>
<a name="l01878"></a>01878       <span class="stringliteral">"Exten: %s\r\n"</span>
<a name="l01879"></a>01879       <span class="stringliteral">"Reason: %d\r\n"</span>
<a name="l01880"></a>01880       <span class="stringliteral">"Uniqueid: %s\r\n"</span>
<a name="l01881"></a>01881       <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l01882"></a>01882       <span class="stringliteral">"CallerIDName: %s\r\n"</span>,
<a name="l01883"></a>01883       in-&gt;<a class="code" href="structfast__originate__helper.html#0b9b4614d6434ea0573c89d67e0170b7">idtext</a>, res ? <span class="stringliteral">"Failure"</span> : <span class="stringliteral">"Success"</span>, chan ? chan-&gt;name : requested_channel, in-&gt;<a class="code" href="structfast__originate__helper.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, in-&gt;<a class="code" href="structfast__originate__helper.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, reason, 
<a name="l01884"></a>01884       chan ? chan-&gt;uniqueid : <span class="stringliteral">"&lt;null&gt;"</span>,
<a name="l01885"></a>01885       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01886"></a>01886       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(in-&gt;<a class="code" href="structfast__originate__helper.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>)
<a name="l01887"></a>01887       );
<a name="l01888"></a>01888 
<a name="l01889"></a>01889    <span class="comment">/* Locked by ast_pbx_outgoing_exten or ast_pbx_outgoing_app */</span>
<a name="l01890"></a>01890    <span class="keywordflow">if</span> (chan)
<a name="l01891"></a>01891       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan);
<a name="l01892"></a>01892    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(in);
<a name="l01893"></a>01893    <span class="keywordflow">return</span> NULL;
<a name="l01894"></a>01894 }
<a name="l01895"></a>01895 
<a name="l01896"></a><a class="code" href="group__Group__AMI.html#gb8d0d86508e429319171f702da06978f">01896</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gb8d0d86508e429319171f702da06978f">mandescr_originate</a>[] =
<a name="l01897"></a>01897 <span class="stringliteral">"Description: Generates an outgoing call to a Extension/Context/Priority or\n"</span>
<a name="l01898"></a>01898 <span class="stringliteral">"  Application/Data\n"</span>
<a name="l01899"></a>01899 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l01900"></a>01900 <span class="stringliteral">"  *Channel: Channel name to call\n"</span>
<a name="l01901"></a>01901 <span class="stringliteral">"  Exten: Extension to use (requires 'Context' and 'Priority')\n"</span>
<a name="l01902"></a>01902 <span class="stringliteral">"  Context: Context to use (requires 'Exten' and 'Priority')\n"</span>
<a name="l01903"></a>01903 <span class="stringliteral">"  Priority: Priority to use (requires 'Exten' and 'Context')\n"</span>
<a name="l01904"></a>01904 <span class="stringliteral">"  Application: Application to use\n"</span>
<a name="l01905"></a>01905 <span class="stringliteral">"  Data: Data to use (requires 'Application')\n"</span>
<a name="l01906"></a>01906 <span class="stringliteral">"  Timeout: How long to wait for call to be answered (in ms)\n"</span>
<a name="l01907"></a>01907 <span class="stringliteral">"  CallerID: Caller ID to be set on the outgoing channel\n"</span>
<a name="l01908"></a>01908 <span class="stringliteral">"  Variable: Channel variable to set, multiple Variable: headers are allowed\n"</span>
<a name="l01909"></a>01909 <span class="stringliteral">"  Account: Account code\n"</span>
<a name="l01910"></a>01910 <span class="stringliteral">"  Async: Set to 'true' for fast origination\n"</span>;
<a name="l01911"></a>01911 
<a name="l01912"></a><a class="code" href="group__Group__AMI.html#gd8bc04cda5ffb147cb7c5542d3f8c1ea">01912</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gd8bc04cda5ffb147cb7c5542d3f8c1ea">action_originate</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l01913"></a>01913 {
<a name="l01914"></a>01914    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l01915"></a>01915    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Exten"</span>);
<a name="l01916"></a>01916    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Context"</span>);
<a name="l01917"></a>01917    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Priority"</span>);
<a name="l01918"></a>01918    <span class="keyword">const</span> <span class="keywordtype">char</span> *timeout = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Timeout"</span>);
<a name="l01919"></a>01919    <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"CallerID"</span>);
<a name="l01920"></a>01920    <span class="keyword">const</span> <span class="keywordtype">char</span> *account = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Account"</span>);
<a name="l01921"></a>01921    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Application"</span>);
<a name="l01922"></a>01922    <span class="keyword">const</span> <span class="keywordtype">char</span> *appdata = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Data"</span>);
<a name="l01923"></a>01923    <span class="keyword">const</span> <span class="keywordtype">char</span> *async = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Async"</span>);
<a name="l01924"></a>01924    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ActionID"</span>);
<a name="l01925"></a>01925    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *vars = <a class="code" href="group__Group__AMI.html#gf6be899da040cd416bb8317db016c1ff">astman_get_variables</a>(m);
<a name="l01926"></a>01926    <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>, *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l01927"></a>01927    <span class="keywordtype">char</span> *l = NULL, *n = NULL;
<a name="l01928"></a>01928    <span class="keywordtype">int</span> pi = 0;
<a name="l01929"></a>01929    <span class="keywordtype">int</span> res;
<a name="l01930"></a>01930    <span class="keywordtype">int</span> to = 30000;
<a name="l01931"></a>01931    <span class="keywordtype">int</span> reason = 0;
<a name="l01932"></a>01932    <span class="keywordtype">char</span> tmp[256];
<a name="l01933"></a>01933    <span class="keywordtype">char</span> tmp2[256];
<a name="l01934"></a>01934 
<a name="l01935"></a>01935    pthread_t th;
<a name="l01936"></a>01936    <span class="keywordflow">if</span> (!name) {
<a name="l01937"></a>01937       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Channel not specified"</span>);
<a name="l01938"></a>01938       <span class="keywordflow">return</span> 0;
<a name="l01939"></a>01939    }
<a name="l01940"></a>01940    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(priority) &amp;&amp; (sscanf(priority, <span class="stringliteral">"%d"</span>, &amp;pi) != 1)) {
<a name="l01941"></a>01941       <span class="keywordflow">if</span> ((pi = <a class="code" href="pbx_8c.html#6f1b63f69b489517c49ccfecdbe1642e">ast_findlabel_extension</a>(NULL, context, exten, priority, NULL)) &lt; 1) {
<a name="l01942"></a>01942          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Invalid priority\n"</span>);
<a name="l01943"></a>01943          <span class="keywordflow">return</span> 0;
<a name="l01944"></a>01944       }
<a name="l01945"></a>01945    }
<a name="l01946"></a>01946    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(timeout) &amp;&amp; (sscanf(timeout, <span class="stringliteral">"%d"</span>, &amp;to) != 1)) {
<a name="l01947"></a>01947       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Invalid timeout\n"</span>);
<a name="l01948"></a>01948       <span class="keywordflow">return</span> 0;
<a name="l01949"></a>01949    }
<a name="l01950"></a>01950    ast_copy_string(tmp, name, <span class="keyword">sizeof</span>(tmp));
<a name="l01951"></a>01951    tech = tmp;
<a name="l01952"></a>01952    data = strchr(tmp, <span class="charliteral">'/'</span>);
<a name="l01953"></a>01953    <span class="keywordflow">if</span> (!data) {
<a name="l01954"></a>01954       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Invalid channel\n"</span>);
<a name="l01955"></a>01955       <span class="keywordflow">return</span> 0;
<a name="l01956"></a>01956    }
<a name="l01957"></a>01957    *data++ = <span class="charliteral">'\0'</span>;
<a name="l01958"></a>01958    ast_copy_string(tmp2, callerid, <span class="keyword">sizeof</span>(tmp2));
<a name="l01959"></a>01959    <a class="code" href="callerid_8c.html#914d0eb3b42ed9d3547306d24d2e67a0">ast_callerid_parse</a>(tmp2, &amp;n, &amp;l);
<a name="l01960"></a>01960    <span class="keywordflow">if</span> (n) {
<a name="l01961"></a>01961       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(n))
<a name="l01962"></a>01962          n = NULL;
<a name="l01963"></a>01963    }
<a name="l01964"></a>01964    <span class="keywordflow">if</span> (l) {
<a name="l01965"></a>01965       <a class="code" href="callerid_8c.html#472e6c01db8037ff1904969285f4e91c">ast_shrink_phone_number</a>(l);
<a name="l01966"></a>01966       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(l))
<a name="l01967"></a>01967          l = NULL;
<a name="l01968"></a>01968    }
<a name="l01969"></a>01969    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(async)) {
<a name="l01970"></a>01970       <span class="keyword">struct </span><a class="code" href="structfast__originate__helper.html">fast_originate_helper</a> *fast = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*fast));
<a name="l01971"></a>01971       <span class="keywordflow">if</span> (!fast) {
<a name="l01972"></a>01972          res = -1;
<a name="l01973"></a>01973       } <span class="keywordflow">else</span> {
<a name="l01974"></a>01974          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l01975"></a>01975             snprintf(fast-&gt;idtext, <span class="keyword">sizeof</span>(fast-&gt;idtext), <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l01976"></a>01976          ast_copy_string(fast-&gt;tech, tech, <span class="keyword">sizeof</span>(fast-&gt;tech));
<a name="l01977"></a>01977             ast_copy_string(fast-&gt;data, data, <span class="keyword">sizeof</span>(fast-&gt;data));
<a name="l01978"></a>01978          ast_copy_string(fast-&gt;app, app, <span class="keyword">sizeof</span>(fast-&gt;app));
<a name="l01979"></a>01979          ast_copy_string(fast-&gt;appdata, appdata, <span class="keyword">sizeof</span>(fast-&gt;appdata));
<a name="l01980"></a>01980          <span class="keywordflow">if</span> (l)
<a name="l01981"></a>01981             ast_copy_string(fast-&gt;cid_num, l, <span class="keyword">sizeof</span>(fast-&gt;cid_num));
<a name="l01982"></a>01982          <span class="keywordflow">if</span> (n)
<a name="l01983"></a>01983             ast_copy_string(fast-&gt;cid_name, n, <span class="keyword">sizeof</span>(fast-&gt;cid_name));
<a name="l01984"></a>01984          fast-&gt;vars = vars;
<a name="l01985"></a>01985          ast_copy_string(fast-&gt;context, context, <span class="keyword">sizeof</span>(fast-&gt;context));
<a name="l01986"></a>01986          ast_copy_string(fast-&gt;exten, exten, <span class="keyword">sizeof</span>(fast-&gt;exten));
<a name="l01987"></a>01987          ast_copy_string(fast-&gt;account, account, <span class="keyword">sizeof</span>(fast-&gt;account));
<a name="l01988"></a>01988          fast-&gt;timeout = to;
<a name="l01989"></a>01989          fast-&gt;priority = pi;
<a name="l01990"></a>01990          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#97e9ed35da1f19087b177cdffdf53c97">ast_pthread_create_detached</a>(&amp;th, NULL, <a class="code" href="group__Group__AMI.html#g07edcd94b098b94138489a2a65ce84f8">fast_originate</a>, fast)) {
<a name="l01991"></a>01991             res = -1;
<a name="l01992"></a>01992          } <span class="keywordflow">else</span> {
<a name="l01993"></a>01993             res = 0;
<a name="l01994"></a>01994          }
<a name="l01995"></a>01995       }
<a name="l01996"></a>01996    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(app)) {
<a name="l01997"></a>01997          res = <a class="code" href="pbx_8c.html#8bd05d7cdf218eaecfb4a33dd0eb32d8">ast_pbx_outgoing_app</a>(tech, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, data, to, app, appdata, &amp;reason, 1, l, n, vars, account, NULL);
<a name="l01998"></a>01998       } <span class="keywordflow">else</span> {
<a name="l01999"></a>01999       <span class="keywordflow">if</span> (exten &amp;&amp; context &amp;&amp; pi)
<a name="l02000"></a>02000             res = <a class="code" href="pbx_8c.html#1b1911a618935b371e69b60c66cf6221">ast_pbx_outgoing_exten</a>(tech, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, data, to, context, exten, pi, &amp;reason, 1, l, n, vars, account, NULL);
<a name="l02001"></a>02001       <span class="keywordflow">else</span> {
<a name="l02002"></a>02002          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Originate with 'Exten' requires 'Context' and 'Priority'"</span>);
<a name="l02003"></a>02003          <span class="keywordflow">return</span> 0;
<a name="l02004"></a>02004       }
<a name="l02005"></a>02005    }
<a name="l02006"></a>02006    <span class="keywordflow">if</span> (!res)
<a name="l02007"></a>02007       <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Originate successfully queued"</span>);
<a name="l02008"></a>02008    <span class="keywordflow">else</span>
<a name="l02009"></a>02009       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Originate failed"</span>);
<a name="l02010"></a>02010    <span class="keywordflow">return</span> 0;
<a name="l02011"></a>02011 }
<a name="l02012"></a>02012 <span class="comment"></span>
<a name="l02013"></a>02013 <span class="comment">/*! \brief Help text for manager command mailboxstatus</span>
<a name="l02014"></a>02014 <span class="comment"> */</span>
<a name="l02015"></a><a class="code" href="group__Group__AMI.html#gfbeefe3f5b56dfe8f2379f93f8699b13">02015</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gfbeefe3f5b56dfe8f2379f93f8699b13">mandescr_mailboxstatus</a>[] =
<a name="l02016"></a>02016 <span class="stringliteral">"Description: Checks a voicemail account for status.\n"</span>
<a name="l02017"></a>02017 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02018"></a>02018 <span class="stringliteral">"  *Mailbox: Full mailbox ID &lt;mailbox&gt;@&lt;vm-context&gt;\n"</span>
<a name="l02019"></a>02019 <span class="stringliteral">"  ActionID: Optional ActionID for message matching.\n"</span>
<a name="l02020"></a>02020 <span class="stringliteral">"Returns number of messages.\n"</span>
<a name="l02021"></a>02021 <span class="stringliteral">"  Message: Mailbox Status\n"</span>
<a name="l02022"></a>02022 <span class="stringliteral">"  Mailbox: &lt;mailboxid&gt;\n"</span>
<a name="l02023"></a>02023 <span class="stringliteral">"  Waiting: &lt;count&gt;\n"</span>
<a name="l02024"></a>02024 <span class="stringliteral">"\n"</span>;
<a name="l02025"></a>02025 
<a name="l02026"></a><a class="code" href="group__Group__AMI.html#g44d5b6b832d95db5bfb983d39e56ee21">02026</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g44d5b6b832d95db5bfb983d39e56ee21">action_mailboxstatus</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02027"></a>02027 {
<a name="l02028"></a>02028    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Mailbox"</span>);
<a name="l02029"></a>02029    <span class="keywordtype">int</span> ret;
<a name="l02030"></a>02030 
<a name="l02031"></a>02031    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(mailbox)) {
<a name="l02032"></a>02032       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Mailbox not specified"</span>);
<a name="l02033"></a>02033       <span class="keywordflow">return</span> 0;
<a name="l02034"></a>02034    }
<a name="l02035"></a>02035    ret = <a class="code" href="app_8c.html#0b70c376a3774cd6d951a7dbbd49e6ac">ast_app_has_voicemail</a>(mailbox, NULL);
<a name="l02036"></a>02036    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l02037"></a>02037    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Message: Mailbox Status\r\n"</span>
<a name="l02038"></a>02038           <span class="stringliteral">"Mailbox: %s\r\n"</span>
<a name="l02039"></a>02039           <span class="stringliteral">"Waiting: %d\r\n\r\n"</span>, mailbox, ret);
<a name="l02040"></a>02040    <span class="keywordflow">return</span> 0;
<a name="l02041"></a>02041 }
<a name="l02042"></a>02042 
<a name="l02043"></a><a class="code" href="group__Group__AMI.html#g4c3b52b7ac90a43027758d2aaf218202">02043</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g4c3b52b7ac90a43027758d2aaf218202">mandescr_mailboxcount</a>[] =
<a name="l02044"></a>02044 <span class="stringliteral">"Description: Checks a voicemail account for new messages.\n"</span>
<a name="l02045"></a>02045 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02046"></a>02046 <span class="stringliteral">"  *Mailbox: Full mailbox ID &lt;mailbox&gt;@&lt;vm-context&gt;\n"</span>
<a name="l02047"></a>02047 <span class="stringliteral">"  ActionID: Optional ActionID for message matching.\n"</span>
<a name="l02048"></a>02048 <span class="stringliteral">"Returns number of new and old messages.\n"</span>
<a name="l02049"></a>02049 <span class="stringliteral">"  Message: Mailbox Message Count\n"</span>
<a name="l02050"></a>02050 <span class="stringliteral">"  Mailbox: &lt;mailboxid&gt;\n"</span>
<a name="l02051"></a>02051 <span class="stringliteral">"  NewMessages: &lt;count&gt;\n"</span>
<a name="l02052"></a>02052 <span class="stringliteral">"  OldMessages: &lt;count&gt;\n"</span>
<a name="l02053"></a>02053 <span class="stringliteral">"\n"</span>;
<a name="l02054"></a><a class="code" href="group__Group__AMI.html#g86017430079df84ea69c923aa234bdcd">02054</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g86017430079df84ea69c923aa234bdcd">action_mailboxcount</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02055"></a>02055 {
<a name="l02056"></a>02056    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Mailbox"</span>);
<a name="l02057"></a>02057    <span class="keywordtype">int</span> newmsgs = 0, oldmsgs = 0;
<a name="l02058"></a>02058 
<a name="l02059"></a>02059    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(mailbox)) {
<a name="l02060"></a>02060       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Mailbox not specified"</span>);
<a name="l02061"></a>02061       <span class="keywordflow">return</span> 0;
<a name="l02062"></a>02062    }
<a name="l02063"></a>02063    <a class="code" href="app_8c.html#efbc8765f2d92250572a2a1bc05e05d2">ast_app_inboxcount</a>(mailbox, &amp;newmsgs, &amp;oldmsgs);
<a name="l02064"></a>02064    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l02065"></a>02065    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,   <span class="stringliteral">"Message: Mailbox Message Count\r\n"</span>
<a name="l02066"></a>02066             <span class="stringliteral">"Mailbox: %s\r\n"</span>
<a name="l02067"></a>02067             <span class="stringliteral">"NewMessages: %d\r\n"</span>
<a name="l02068"></a>02068             <span class="stringliteral">"OldMessages: %d\r\n"</span>
<a name="l02069"></a>02069             <span class="stringliteral">"\r\n"</span>,
<a name="l02070"></a>02070             mailbox, newmsgs, oldmsgs);
<a name="l02071"></a>02071    <span class="keywordflow">return</span> 0;
<a name="l02072"></a>02072 }
<a name="l02073"></a>02073 
<a name="l02074"></a><a class="code" href="group__Group__AMI.html#gc23a0e40c449c0ff093ebb890078ccd7">02074</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gc23a0e40c449c0ff093ebb890078ccd7">mandescr_extensionstate</a>[] =
<a name="l02075"></a>02075 <span class="stringliteral">"Description: Report the extension state for given extension.\n"</span>
<a name="l02076"></a>02076 <span class="stringliteral">"  If the extension has a hint, will use devicestate to check\n"</span>
<a name="l02077"></a>02077 <span class="stringliteral">"  the status of the device connected to the extension.\n"</span>
<a name="l02078"></a>02078 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02079"></a>02079 <span class="stringliteral">"  *Exten: Extension to check state on\n"</span>
<a name="l02080"></a>02080 <span class="stringliteral">"  *Context: Context for extension\n"</span>
<a name="l02081"></a>02081 <span class="stringliteral">"  ActionId: Optional ID for this transaction\n"</span>
<a name="l02082"></a>02082 <span class="stringliteral">"Will return an \"Extension Status\" message.\n"</span>
<a name="l02083"></a>02083 <span class="stringliteral">"The response will include the hint for the extension and the status.\n"</span>;
<a name="l02084"></a>02084 
<a name="l02085"></a><a class="code" href="group__Group__AMI.html#g58e43ceaccf852d6a41133bc5cfadc13">02085</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g58e43ceaccf852d6a41133bc5cfadc13">action_extensionstate</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02086"></a>02086 {
<a name="l02087"></a>02087    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Exten"</span>);
<a name="l02088"></a>02088    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Context"</span>);
<a name="l02089"></a>02089    <span class="keywordtype">char</span> hint[256] = <span class="stringliteral">""</span>;
<a name="l02090"></a>02090    <span class="keywordtype">int</span> status;
<a name="l02091"></a>02091    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(exten)) {
<a name="l02092"></a>02092       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Extension not specified"</span>);
<a name="l02093"></a>02093       <span class="keywordflow">return</span> 0;
<a name="l02094"></a>02094    }
<a name="l02095"></a>02095    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(context))
<a name="l02096"></a>02096       context = <span class="stringliteral">"default"</span>;
<a name="l02097"></a>02097    status = <a class="code" href="pbx_8c.html#16769dc669e528ae10a063594fb7f4ae">ast_extension_state</a>(NULL, context, exten);
<a name="l02098"></a>02098    <a class="code" href="pbx_8c.html#b654f3264742a57f212c38761672a6c0">ast_get_hint</a>(hint, <span class="keyword">sizeof</span>(hint) - 1, NULL, 0, NULL, context, exten);
<a name="l02099"></a>02099    <a class="code" href="group__Group__AMI.html#gbbca0d5619931eef0a531fe18c27416a">astman_start_ack</a>(s, m);
<a name="l02100"></a>02100    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,   <span class="stringliteral">"Message: Extension Status\r\n"</span>
<a name="l02101"></a>02101             <span class="stringliteral">"Exten: %s\r\n"</span>
<a name="l02102"></a>02102             <span class="stringliteral">"Context: %s\r\n"</span>
<a name="l02103"></a>02103             <span class="stringliteral">"Hint: %s\r\n"</span>
<a name="l02104"></a>02104             <span class="stringliteral">"Status: %d\r\n\r\n"</span>,
<a name="l02105"></a>02105             exten, context, hint, status);
<a name="l02106"></a>02106    <span class="keywordflow">return</span> 0;
<a name="l02107"></a>02107 }
<a name="l02108"></a>02108 
<a name="l02109"></a><a class="code" href="group__Group__AMI.html#gd5b2a1a9f5c7c824e21d0345f08ad0d4">02109</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#gd5b2a1a9f5c7c824e21d0345f08ad0d4">mandescr_timeout</a>[] =
<a name="l02110"></a>02110 <span class="stringliteral">"Description: Hangup a channel after a certain time.\n"</span>
<a name="l02111"></a>02111 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02112"></a>02112 <span class="stringliteral">"  *Channel: Channel name to hangup\n"</span>
<a name="l02113"></a>02113 <span class="stringliteral">"  *Timeout: Maximum duration of the call (sec)\n"</span>
<a name="l02114"></a>02114 <span class="stringliteral">"Acknowledges set time with 'Timeout Set' message\n"</span>;
<a name="l02115"></a>02115 
<a name="l02116"></a><a class="code" href="group__Group__AMI.html#ga8bc516739f567719fd6e75177f08f27">02116</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#ga8bc516739f567719fd6e75177f08f27">action_timeout</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02117"></a>02117 {
<a name="l02118"></a>02118    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l02119"></a>02119    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l02120"></a>02120    <span class="keywordtype">int</span> timeout = atoi(<a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Timeout"</span>));
<a name="l02121"></a>02121 
<a name="l02122"></a>02122    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l02123"></a>02123       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l02124"></a>02124       <span class="keywordflow">return</span> 0;
<a name="l02125"></a>02125    }
<a name="l02126"></a>02126    <span class="keywordflow">if</span> (!timeout) {
<a name="l02127"></a>02127       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No timeout specified"</span>);
<a name="l02128"></a>02128       <span class="keywordflow">return</span> 0;
<a name="l02129"></a>02129    }
<a name="l02130"></a>02130    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l02131"></a>02131    <span class="keywordflow">if</span> (!c) {
<a name="l02132"></a>02132       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l02133"></a>02133       <span class="keywordflow">return</span> 0;
<a name="l02134"></a>02134    }
<a name="l02135"></a>02135    <a class="code" href="channel_8c.html#a572798172ac3e5c4a518e6c247da125">ast_channel_setwhentohangup</a>(c, timeout);
<a name="l02136"></a>02136    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l02137"></a>02137    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Timeout Set"</span>);
<a name="l02138"></a>02138    <span class="keywordflow">return</span> 0;
<a name="l02139"></a>02139 }
<a name="l02140"></a>02140 <span class="comment"></span>
<a name="l02141"></a>02141 <span class="comment">/*!</span>
<a name="l02142"></a>02142 <span class="comment"> * Send any applicable events to the client listening on this socket.</span>
<a name="l02143"></a>02143 <span class="comment"> * Wait only for a finite time on each event, and drop all events whether</span>
<a name="l02144"></a>02144 <span class="comment"> * they are successfully sent or not.</span>
<a name="l02145"></a>02145 <span class="comment"> */</span>
<a name="l02146"></a><a class="code" href="group__Group__AMI.html#g83b7cdf115b0fd94f4417d71e9f3abe2">02146</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g83b7cdf115b0fd94f4417d71e9f3abe2">process_events</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l02147"></a>02147 {
<a name="l02148"></a>02148    <span class="keywordtype">int</span> ret = 0;
<a name="l02149"></a>02149 
<a name="l02150"></a>02150    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02151"></a>02151    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> != NULL) {
<a name="l02152"></a>02152       <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *eqe;
<a name="l02153"></a>02153 
<a name="l02154"></a>02154       <span class="keywordflow">while</span> ( (eqe = <a class="code" href="group__Group__AMI.html#gf074edf91f83d1f06f7e1bb384bb050a">NEW_EVENT</a>(s)) ) {
<a name="l02155"></a>02155          <a class="code" href="group__Group__AMI.html#ga640283e96a4cdde5b36633464a1318a">ref_event</a>(eqe);
<a name="l02156"></a>02156          <span class="keywordflow">if</span> (!ret &amp;&amp; s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> &amp;&amp;
<a name="l02157"></a>02157              (s-&gt;<a class="code" href="structmansession.html#e12b8f9551a73d6196648b62754aa9e1">readperm</a> &amp; eqe-&gt;category) == eqe-&gt;category &amp;&amp;
<a name="l02158"></a>02158              (s-&gt;<a class="code" href="structmansession.html#7f0871bb51563c57440b9ba3875cdaa1">send_events</a> &amp; eqe-&gt;category) == eqe-&gt;category) {
<a name="l02159"></a>02159             <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g28148bd9372a54210c67afe221c2141a">send_string</a>(s, eqe-&gt;eventdata) &lt; 0)
<a name="l02160"></a>02160                ret = -1;   <span class="comment">/* don't send more */</span>
<a name="l02161"></a>02161          }
<a name="l02162"></a>02162          s-&gt;<a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">last_ev</a> = <a class="code" href="group__Group__AMI.html#gfb5ee4f215d8a2bd0f91355e21f53df5">unref_event</a>(s-&gt;<a class="code" href="structmansession.html#272f831d79581a3d16783a36da17e10c">last_ev</a>);
<a name="l02163"></a>02163       }
<a name="l02164"></a>02164    }
<a name="l02165"></a>02165    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02166"></a>02166    <span class="keywordflow">return</span> ret;
<a name="l02167"></a>02167 }
<a name="l02168"></a>02168 
<a name="l02169"></a><a class="code" href="group__Group__AMI.html#g6c5c4b2a4fc6e25aac2fbc21cbbe12e4">02169</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g6c5c4b2a4fc6e25aac2fbc21cbbe12e4">mandescr_userevent</a>[] =
<a name="l02170"></a>02170 <span class="stringliteral">"Description: Send an event to manager sessions.\n"</span>
<a name="l02171"></a>02171 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02172"></a>02172 <span class="stringliteral">"       *UserEvent: EventStringToSend\n"</span>
<a name="l02173"></a>02173 <span class="stringliteral">"       Header1: Content1\n"</span>
<a name="l02174"></a>02174 <span class="stringliteral">"       HeaderN: ContentN\n"</span>;
<a name="l02175"></a>02175 
<a name="l02176"></a><a class="code" href="group__Group__AMI.html#g81297609484dc4a21d32483e91c8b11d">02176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g81297609484dc4a21d32483e91c8b11d">action_userevent</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02177"></a>02177 {
<a name="l02178"></a>02178    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#4119639092e62c55ea8be348e4d9260d">event</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"UserEvent"</span>);
<a name="l02179"></a>02179    <span class="keywordtype">char</span> body[2048] = <span class="stringliteral">""</span>;
<a name="l02180"></a>02180    <span class="keywordtype">int</span> x, bodylen = 0;
<a name="l02181"></a>02181    <span class="keywordflow">for</span> (x = 0; x &lt; m-&gt;hdrcount; x++) {
<a name="l02182"></a>02182       <span class="keywordflow">if</span> (strncasecmp(<span class="stringliteral">"UserEvent:"</span>, m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x], strlen(<span class="stringliteral">"UserEvent:"</span>))) {
<a name="l02183"></a>02183          ast_copy_string(body + bodylen, m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x], <span class="keyword">sizeof</span>(body) - bodylen - 3);
<a name="l02184"></a>02184          bodylen += strlen(m-&gt;<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[x]);
<a name="l02185"></a>02185          ast_copy_string(body + bodylen, <span class="stringliteral">"\r\n"</span>, 3);
<a name="l02186"></a>02186          bodylen += 2;
<a name="l02187"></a>02187       }
<a name="l02188"></a>02188    }
<a name="l02189"></a>02189 
<a name="l02190"></a>02190    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#87a2ec651ddd1db88b41715162d7a242">EVENT_FLAG_USER</a>, <span class="stringliteral">"UserEvent"</span>, <span class="stringliteral">"UserEvent: %s\r\n%s"</span>, event, body);
<a name="l02191"></a>02191    <span class="keywordflow">return</span> 0;
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a><a class="code" href="group__Group__AMI.html#ge402cc29f5a0d8a9001d5071152b1281">02194</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#ge402cc29f5a0d8a9001d5071152b1281">mandescr_coresettings</a>[] =
<a name="l02195"></a>02195 <span class="stringliteral">"Description: Query for Core PBX settings.\n"</span>
<a name="l02196"></a>02196 <span class="stringliteral">"Variables: (Names marked with * are optional)\n"</span>
<a name="l02197"></a>02197 <span class="stringliteral">"       *ActionID: ActionID of this transaction\n"</span>;
<a name="l02198"></a>02198 <span class="comment"></span>
<a name="l02199"></a>02199 <span class="comment">/*! \brief Show PBX core settings information */</span>
<a name="l02200"></a><a class="code" href="group__Group__AMI.html#g4572bba9501a379251e6d7712a077035">02200</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g4572bba9501a379251e6d7712a077035">action_coresettings</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02201"></a>02201 {
<a name="l02202"></a>02202    <span class="keyword">const</span> <span class="keywordtype">char</span> *actionid = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ActionID"</span>);
<a name="l02203"></a>02203    <span class="keywordtype">char</span> idText[150];
<a name="l02204"></a>02204 
<a name="l02205"></a>02205    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(actionid))
<a name="l02206"></a>02206       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">"ActionID: %s\r\n"</span>, actionid);
<a name="l02207"></a>02207 
<a name="l02208"></a>02208    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Response: Success\r\n"</span>
<a name="l02209"></a>02209          <span class="stringliteral">"%s"</span>
<a name="l02210"></a>02210          <span class="stringliteral">"AMIversion: %s\r\n"</span>
<a name="l02211"></a>02211          <span class="stringliteral">"AsteriskVersion: %s\r\n"</span>
<a name="l02212"></a>02212          <span class="stringliteral">"SystemName: %s\r\n"</span>
<a name="l02213"></a>02213          <span class="stringliteral">"CoreMaxCalls: %d\r\n"</span>
<a name="l02214"></a>02214          <span class="stringliteral">"CoreMaxLoadAvg: %f\r\n"</span>
<a name="l02215"></a>02215          <span class="stringliteral">"CoreRunUser: %s\r\n"</span>
<a name="l02216"></a>02216          <span class="stringliteral">"CoreRunGroup: %s\r\n"</span>
<a name="l02217"></a>02217          <span class="stringliteral">"CoreMaxFilehandles: %d\r\n"</span> 
<a name="l02218"></a>02218          <span class="stringliteral">"CoreRealTimeEnabled: %s\r\n"</span>
<a name="l02219"></a>02219          <span class="stringliteral">"CoreCDRenabled: %s\r\n"</span>
<a name="l02220"></a>02220          <span class="stringliteral">"CoreHTTPenabled: %s\r\n"</span>
<a name="l02221"></a>02221          ,
<a name="l02222"></a>02222          <a class="code" href="manager_8h.html#f3dd4f0a97fca03a8648f607708dafe5">AMI_VERSION</a>,
<a name="l02223"></a>02223          idText,
<a name="l02224"></a>02224          <a class="code" href="version_8h.html#57802148143ed0300bc59e5ab6369dc3">ASTERISK_VERSION</a>, 
<a name="l02225"></a>02225          <a class="code" href="asterisk_8c.html#0a0f8ba4c757a1da509a0cae1830025b">ast_config_AST_SYSTEM_NAME</a>,
<a name="l02226"></a>02226          <a class="code" href="group__main__options.html#g367972f6fd289cfd0361f9f8292dd597">option_maxcalls</a>,
<a name="l02227"></a>02227          <a class="code" href="group__main__options.html#g3d42ed99510dbaa405f4e83e95267503">option_maxload</a>,
<a name="l02228"></a>02228          <a class="code" href="asterisk_8c.html#64c0b497dfed5629380fe004fba12a35">ast_config_AST_RUN_USER</a>,
<a name="l02229"></a>02229          <a class="code" href="asterisk_8c.html#d09bbe8a64f8f712d59fb708101e5313">ast_config_AST_RUN_GROUP</a>,
<a name="l02230"></a>02230          <a class="code" href="group__main__options.html#g27e56faa3359cbaf3b1a83fce0a2bd9f">option_maxfiles</a>,
<a name="l02231"></a>02231          <a class="code" href="config_8c.html#4d3672929087d58a0883217b9ade0091">ast_realtime_enabled</a>() ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>,
<a name="l02232"></a>02232          <a class="code" href="cdr_8c.html#15b18b722702ed2b39395076d00158c2">check_cdr_enabled</a>() ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>,
<a name="l02233"></a>02233          <a class="code" href="group__Group__AMI.html#g6fcd08c8c073e9da6c6f96d6663d69d9">check_webmanager_enabled</a>() ? <span class="stringliteral">"Yes"</span> : <span class="stringliteral">"No"</span>
<a name="l02234"></a>02234          );
<a name="l02235"></a>02235    <span class="keywordflow">return</span> 0;
<a name="l02236"></a>02236 }
<a name="l02237"></a>02237 
<a name="l02238"></a><a class="code" href="group__Group__AMI.html#g54e903fbbc11dec18a6971c0b9f89df1">02238</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="group__Group__AMI.html#g54e903fbbc11dec18a6971c0b9f89df1">mandescr_corestatus</a>[] =
<a name="l02239"></a>02239 <span class="stringliteral">"Description: Query for Core PBX status.\n"</span>
<a name="l02240"></a>02240 <span class="stringliteral">"Variables: (Names marked with * are optional)\n"</span>
<a name="l02241"></a>02241 <span class="stringliteral">"       *ActionID: ActionID of this transaction\n"</span>;
<a name="l02242"></a>02242 <span class="comment"></span>
<a name="l02243"></a>02243 <span class="comment">/*! \brief Show PBX core status information */</span>
<a name="l02244"></a><a class="code" href="group__Group__AMI.html#g48f94483856e54f9d016fd4e00963a5c">02244</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g48f94483856e54f9d016fd4e00963a5c">action_corestatus</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02245"></a>02245 {
<a name="l02246"></a>02246    <span class="keyword">const</span> <span class="keywordtype">char</span> *actionid = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ActionID"</span>);
<a name="l02247"></a>02247    <span class="keywordtype">char</span> idText[150];
<a name="l02248"></a>02248    <span class="keywordtype">char</span> startuptime[150];
<a name="l02249"></a>02249    <span class="keywordtype">char</span> reloadtime[150];
<a name="l02250"></a>02250    <span class="keyword">struct </span>tm tm;
<a name="l02251"></a>02251 
<a name="l02252"></a>02252    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(actionid))
<a name="l02253"></a>02253       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">"ActionID: %s\r\n"</span>, actionid);
<a name="l02254"></a>02254 
<a name="l02255"></a>02255    localtime_r(&amp;<a class="code" href="asterisk_8c.html#023ce0372dc9226210dc61a0dbbee466">ast_startuptime</a>, &amp;tm);
<a name="l02256"></a>02256    strftime(startuptime, <span class="keyword">sizeof</span>(startuptime), <span class="stringliteral">"%H:%M:%S"</span>, &amp;tm);
<a name="l02257"></a>02257    localtime_r(&amp;<a class="code" href="asterisk_8c.html#e6ff0fa0781fd6b2cfaac6462595ff78">ast_lastreloadtime</a>, &amp;tm);
<a name="l02258"></a>02258    strftime(reloadtime, <span class="keyword">sizeof</span>(reloadtime), <span class="stringliteral">"%H:%M:%S"</span>, &amp;tm);
<a name="l02259"></a>02259 
<a name="l02260"></a>02260    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Response: Success\r\n"</span>
<a name="l02261"></a>02261          <span class="stringliteral">"%s"</span>
<a name="l02262"></a>02262          <span class="stringliteral">"CoreStartupTime: %s\r\n"</span>
<a name="l02263"></a>02263          <span class="stringliteral">"CoreReloadTime: %s\r\n"</span>
<a name="l02264"></a>02264          <span class="stringliteral">"CoreCurrentCalls: %d\r\n"</span>
<a name="l02265"></a>02265          <span class="stringliteral">""</span>,
<a name="l02266"></a>02266          idText,
<a name="l02267"></a>02267          startuptime,
<a name="l02268"></a>02268          reloadtime,
<a name="l02269"></a>02269          <a class="code" href="channel_8c.html#126867ace3f9eaaf4d1cf954f5907451">ast_active_channels</a>()
<a name="l02270"></a>02270          );
<a name="l02271"></a>02271    <span class="keywordflow">return</span> 0;
<a name="l02272"></a>02272 }
<a name="l02273"></a>02273 
<a name="l02274"></a>02274 
<a name="l02275"></a>02275 <span class="comment">/*</span>
<a name="l02276"></a>02276 <span class="comment"> * Done with the action handlers here, we start with the code in charge</span>
<a name="l02277"></a>02277 <span class="comment"> * of accepting connections and serving them.</span>
<a name="l02278"></a>02278 <span class="comment"> * accept_thread() forks a new thread for each connection, session_do(),</span>
<a name="l02279"></a>02279 <span class="comment"> * which in turn calls get_input() repeatedly until a full message has</span>
<a name="l02280"></a>02280 <span class="comment"> * been accumulated, and then invokes process_message() to pass it to</span>
<a name="l02281"></a>02281 <span class="comment"> * the appropriate handler.</span>
<a name="l02282"></a>02282 <span class="comment"> */</span>
<a name="l02283"></a>02283 
<a name="l02284"></a>02284 <span class="comment">/*</span>
<a name="l02285"></a>02285 <span class="comment"> * Process an AMI message, performing desired action.</span>
<a name="l02286"></a>02286 <span class="comment"> * Return 0 on success, -1 on error that require the session to be destroyed.</span>
<a name="l02287"></a>02287 <span class="comment"> */</span>
<a name="l02288"></a><a class="code" href="group__Group__AMI.html#g4b975e0463cced020259b711bb8481e2">02288</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g4b975e0463cced020259b711bb8481e2">process_message</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02289"></a>02289 {
<a name="l02290"></a>02290    <span class="keywordtype">char</span> action[80] = <span class="stringliteral">""</span>;
<a name="l02291"></a>02291    <span class="keywordtype">int</span> ret = 0;
<a name="l02292"></a>02292    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *tmp;
<a name="l02293"></a>02293    <span class="keyword">const</span> <span class="keywordtype">char</span> *user = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Username"</span>);
<a name="l02294"></a>02294 
<a name="l02295"></a>02295    ast_copy_string(action, <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Action"</span>), <span class="keyword">sizeof</span>(action));
<a name="l02296"></a>02296    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02297"></a>02297       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Manager received command '%s'\n"</span>, action);
<a name="l02298"></a>02298 
<a name="l02299"></a>02299    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(action)) {
<a name="l02300"></a>02300       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Missing action in request"</span>);
<a name="l02301"></a>02301       <span class="keywordflow">return</span> 0;
<a name="l02302"></a>02302    }
<a name="l02303"></a>02303 
<a name="l02304"></a>02304    <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> &amp;&amp; strcasecmp(action, <span class="stringliteral">"Login"</span>) &amp;&amp; strcasecmp(action, <span class="stringliteral">"Logoff"</span>) &amp;&amp; strcasecmp(action, <span class="stringliteral">"Challenge"</span>)) {
<a name="l02305"></a>02305       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02306"></a>02306       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Permission denied"</span>);
<a name="l02307"></a>02307       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02308"></a>02308       <span class="keywordflow">return</span> 0;
<a name="l02309"></a>02309    }
<a name="l02310"></a>02310 
<a name="l02311"></a>02311    <span class="keywordflow">if</span> (!<a class="code" href="group__Group__AMI.html#g96f294e808841cbd886011c9d0192687">allowmultiplelogin</a> &amp;&amp; !s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> &amp;&amp; user &amp;&amp;
<a name="l02312"></a>02312       (!strcasecmp(action, <span class="stringliteral">"Login"</span>) || !strcasecmp(action, <span class="stringliteral">"Challenge"</span>))) {
<a name="l02313"></a>02313       <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g1889b1316d12271fa30e9f302c0da675">check_manager_session_inuse</a>(user)) {
<a name="l02314"></a>02314          sleep(1);
<a name="l02315"></a>02315          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Login Already In Use"</span>);
<a name="l02316"></a>02316          <span class="keywordflow">return</span> -1;
<a name="l02317"></a>02317       }
<a name="l02318"></a>02318    }
<a name="l02319"></a>02319 
<a name="l02320"></a>02320    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;actionlock);  
<a name="l02321"></a>02321    <span class="keywordflow">for</span> (tmp = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a> ; tmp; tmp = tmp-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02322"></a>02322       <span class="keywordflow">if</span> (strcasecmp(action, tmp-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>))
<a name="l02323"></a>02323          <span class="keywordflow">continue</span>;
<a name="l02324"></a>02324       <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="structmansession.html#1cc72854e73b9b510a12e993d6479e86">writeperm</a> &amp; tmp-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>) == tmp-&gt;<a class="code" href="structmanager__action.html#873e9c0b50183b613336eea1020f4369">authority</a>)
<a name="l02325"></a>02325          ret = tmp-&gt;<a class="code" href="structmanager__action.html#b9de002f6fa5a7254b767f219f6a5d42">func</a>(s, m);
<a name="l02326"></a>02326       <span class="keywordflow">else</span>
<a name="l02327"></a>02327          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Permission denied"</span>);
<a name="l02328"></a>02328       <span class="keywordflow">break</span>;
<a name="l02329"></a>02329    }
<a name="l02330"></a>02330    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l02331"></a>02331    <span class="keywordflow">if</span> (!tmp) {
<a name="l02332"></a>02332       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02333"></a>02333       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Invalid/unknown command. Use Action: ListCommands to show available commands."</span>);
<a name="l02334"></a>02334       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02335"></a>02335    }
<a name="l02336"></a>02336    <span class="keywordflow">if</span> (ret)
<a name="l02337"></a>02337       <span class="keywordflow">return</span> ret;
<a name="l02338"></a>02338    <span class="comment">/* Once done with our message, deliver any pending events */</span>
<a name="l02339"></a>02339    <span class="keywordflow">return</span> <a class="code" href="group__Group__AMI.html#g83b7cdf115b0fd94f4417d71e9f3abe2">process_events</a>(s);
<a name="l02340"></a>02340 }
<a name="l02341"></a>02341 <span class="comment"></span>
<a name="l02342"></a>02342 <span class="comment">/*!</span>
<a name="l02343"></a>02343 <span class="comment"> * Read one full line (including crlf) from the manager socket.</span>
<a name="l02344"></a>02344 <span class="comment"> * \note \verbatim</span>
<a name="l02345"></a>02345 <span class="comment"> * \r\n is the only valid terminator for the line.</span>
<a name="l02346"></a>02346 <span class="comment"> * (Note that, later, '\0' will be considered as the end-of-line marker,</span>
<a name="l02347"></a>02347 <span class="comment"> * so everything between the '\0' and the '\r\n' will not be used).</span>
<a name="l02348"></a>02348 <span class="comment"> * Also note that we assume output to have at least "maxlen" space.</span>
<a name="l02349"></a>02349 <span class="comment"> * \endverbatim</span>
<a name="l02350"></a>02350 <span class="comment"> */</span>
<a name="l02351"></a><a class="code" href="group__Group__AMI.html#gf6b259125b17075ea07ee9939d7fdbf5">02351</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gf6b259125b17075ea07ee9939d7fdbf5">get_input</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">char</span> *output)
<a name="l02352"></a>02352 {
<a name="l02353"></a>02353    <span class="keywordtype">int</span> res, x;
<a name="l02354"></a>02354    <span class="keywordtype">int</span> maxlen = <span class="keyword">sizeof</span>(s-&gt;<a class="code" href="structmansession.html#62d43bda85ee13dbbf7f0a8a5248533a">inbuf</a>) - 1;
<a name="l02355"></a>02355    <span class="keywordtype">char</span> *src = s-&gt;<a class="code" href="structmansession.html#62d43bda85ee13dbbf7f0a8a5248533a">inbuf</a>;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357    <span class="comment">/*</span>
<a name="l02358"></a>02358 <span class="comment">    * Look for \r\n within the buffer. If found, copy to the output</span>
<a name="l02359"></a>02359 <span class="comment">    * buffer and return, trimming the \r\n (not used afterwards).</span>
<a name="l02360"></a>02360 <span class="comment">    */</span>
<a name="l02361"></a>02361    for (x = 0; x &lt; s-&gt;inlen; x++) {
<a name="l02362"></a>02362       <span class="keywordtype">int</span> cr;  <span class="comment">/* set if we have \r */</span>
<a name="l02363"></a>02363       <span class="keywordflow">if</span> (src[x] == <span class="charliteral">'\r'</span> &amp;&amp; x+1 &lt; s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a> &amp;&amp; src[x+1] == <span class="charliteral">'\n'</span>)
<a name="l02364"></a>02364          cr = 2;  <span class="comment">/* Found. Update length to include \r\n */</span>
<a name="l02365"></a>02365       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (src[x] == <span class="charliteral">'\n'</span>)
<a name="l02366"></a>02366          cr = 1;  <span class="comment">/* also accept \n only */</span>
<a name="l02367"></a>02367       <span class="keywordflow">else</span>
<a name="l02368"></a>02368          <span class="keywordflow">continue</span>;
<a name="l02369"></a>02369       memmove(output, src, x);   <span class="comment">/*... but trim \r\n */</span>
<a name="l02370"></a>02370       output[x] = <span class="charliteral">'\0'</span>;    <span class="comment">/* terminate the string */</span>
<a name="l02371"></a>02371       x += cr;       <span class="comment">/* number of bytes used */</span>
<a name="l02372"></a>02372       s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a> -= x;       <span class="comment">/* remaining size */</span>
<a name="l02373"></a>02373       memmove(src, src + x, s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a>); <span class="comment">/* remove used bytes */</span>
<a name="l02374"></a>02374       <span class="keywordflow">return</span> 1;
<a name="l02375"></a>02375    }
<a name="l02376"></a>02376    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a> &gt;= maxlen) {
<a name="l02377"></a>02377       <span class="comment">/* no crlf found, and buffer full - sorry, too long for us */</span>
<a name="l02378"></a>02378       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Dumping long line with no return from %s: %s\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr), src);
<a name="l02379"></a>02379       s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a> = 0;
<a name="l02380"></a>02380    }
<a name="l02381"></a>02381    res = 0;
<a name="l02382"></a>02382    <span class="keywordflow">while</span> (res == 0) {
<a name="l02383"></a>02383       <span class="comment">/* XXX do we really need this locking ? */</span>
<a name="l02384"></a>02384       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02385"></a>02385       s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> = pthread_self();
<a name="l02386"></a>02386       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02387"></a>02387 
<a name="l02388"></a>02388       res = <a class="code" href="utils_8c.html#88e6eaa2c6fb4d77011df76d5d193728">ast_wait_for_input</a>(s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>, -1);   <span class="comment">/* return 0 on timeout ? */</span>
<a name="l02389"></a>02389 
<a name="l02390"></a>02390       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02391"></a>02391       s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l02392"></a>02392       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02393"></a>02393    }
<a name="l02394"></a>02394    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02395"></a>02395       <span class="comment">/* If we get a signal from some other thread (typically because</span>
<a name="l02396"></a>02396 <span class="comment">       * there are new events queued), return 0 to notify the caller.</span>
<a name="l02397"></a>02397 <span class="comment">       */</span>
<a name="l02398"></a>02398       <span class="keywordflow">if</span> (errno == EINTR)
<a name="l02399"></a>02399          <span class="keywordflow">return</span> 0;
<a name="l02400"></a>02400       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"poll() returned error: %s\n"</span>, strerror(errno));
<a name="l02401"></a>02401       <span class="keywordflow">return</span> -1;
<a name="l02402"></a>02402    }
<a name="l02403"></a>02403    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02404"></a>02404    res = fread(src + s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a>, 1, maxlen - s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a>, s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l02405"></a>02405    <span class="keywordflow">if</span> (res &lt; 1)
<a name="l02406"></a>02406       res = -1;   <span class="comment">/* error return */</span>
<a name="l02407"></a>02407    <span class="keywordflow">else</span> {
<a name="l02408"></a>02408       s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a> += res;
<a name="l02409"></a>02409       src[s-&gt;<a class="code" href="structmansession.html#517cacbfd832b57c5d2993dbea96ea71">inlen</a>] = <span class="charliteral">'\0'</span>;
<a name="l02410"></a>02410       res = 0;
<a name="l02411"></a>02411    }
<a name="l02412"></a>02412    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02413"></a>02413    <span class="keywordflow">return</span> res;
<a name="l02414"></a>02414 }
<a name="l02415"></a>02415 
<a name="l02416"></a><a class="code" href="group__Group__AMI.html#g9af7cd1eddf73300ec737507cdaee283">02416</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g9af7cd1eddf73300ec737507cdaee283">do_message</a>(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418    <span class="keyword">struct </span><a class="code" href="structmessage.html">message</a> m = { 0 };
<a name="l02419"></a>02419    <span class="keywordtype">char</span> header_buf[<span class="keyword">sizeof</span>(s-&gt;<a class="code" href="structmansession.html#62d43bda85ee13dbbf7f0a8a5248533a">inbuf</a>)] = { <span class="charliteral">'\0'</span> };
<a name="l02420"></a>02420    <span class="keywordtype">int</span> res;
<a name="l02421"></a>02421 
<a name="l02422"></a>02422    <span class="keywordflow">for</span> (;;) {
<a name="l02423"></a>02423       <span class="comment">/* Check if any events are pending and do them if needed */</span>
<a name="l02424"></a>02424       <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g83b7cdf115b0fd94f4417d71e9f3abe2">process_events</a>(s))
<a name="l02425"></a>02425          <span class="keywordflow">return</span> -1;
<a name="l02426"></a>02426       res = <a class="code" href="group__Group__AMI.html#gf6b259125b17075ea07ee9939d7fdbf5">get_input</a>(s, header_buf);
<a name="l02427"></a>02427       <span class="keywordflow">if</span> (res == 0) {
<a name="l02428"></a>02428          <span class="keywordflow">continue</span>;
<a name="l02429"></a>02429       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l02430"></a>02430          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(header_buf))
<a name="l02431"></a>02431             <span class="keywordflow">return</span> <a class="code" href="group__Group__AMI.html#g4b975e0463cced020259b711bb8481e2">process_message</a>(s, &amp;m) ? -1 : 0;
<a name="l02432"></a>02432          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m.<a class="code" href="structmessage.html#76e7ad105b17b3d39436c0487d899200">hdrcount</a> &lt; (<a class="code" href="manager_8h.html#233ac9532f94e3f2b355891d25414118">AST_MAX_MANHEADERS</a> - 1))
<a name="l02433"></a>02433             m.<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[m.<a class="code" href="structmessage.html#76e7ad105b17b3d39436c0487d899200">hdrcount</a>++] = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(header_buf);
<a name="l02434"></a>02434       } <span class="keywordflow">else</span> {
<a name="l02435"></a>02435          <span class="keywordflow">return</span> res;
<a name="l02436"></a>02436       }
<a name="l02437"></a>02437    }
<a name="l02438"></a>02438 }
<a name="l02439"></a>02439 <span class="comment"></span>
<a name="l02440"></a>02440 <span class="comment">/*! \brief The body of the individual manager session.</span>
<a name="l02441"></a>02441 <span class="comment"> * Call get_input() to read one line at a time</span>
<a name="l02442"></a>02442 <span class="comment"> * (or be woken up on new events), collect the lines in a</span>
<a name="l02443"></a>02443 <span class="comment"> * message until found an empty line, and execute the request.</span>
<a name="l02444"></a>02444 <span class="comment"> * In any case, deliver events asynchronously through process_events()</span>
<a name="l02445"></a>02445 <span class="comment"> * (called from here if no line is available, or at the end of</span>
<a name="l02446"></a>02446 <span class="comment"> * process_message(). )</span>
<a name="l02447"></a>02447 <span class="comment"> */</span>
<a name="l02448"></a><a class="code" href="group__Group__AMI.html#g5014c646ffd1bd67b43210a9a22c136a">02448</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="group__Group__AMI.html#g5014c646ffd1bd67b43210a9a22c136a">session_do</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l02449"></a>02449 {
<a name="l02450"></a>02450    <span class="keyword">struct </span><a class="code" href="structserver__instance.html">server_instance</a> *ser = data;
<a name="l02451"></a>02451    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*s));
<a name="l02452"></a>02452    <span class="keywordtype">int</span> <a class="code" href="structast__channel.html#4e5868d676cb634aa75b125a0f741abf">flags</a>;
<a name="l02453"></a>02453    <span class="keywordtype">int</span> res;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455    <span class="keywordflow">if</span> (s == NULL)
<a name="l02456"></a>02456       <span class="keywordflow">goto</span> done;
<a name="l02457"></a>02457 
<a name="l02458"></a>02458    s-&gt;writetimeout = 100;
<a name="l02459"></a>02459    s-&gt;waiting_thread = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l02460"></a>02460 
<a name="l02461"></a>02461    flags = fcntl(ser-&gt;<a class="code" href="structserver__instance.html#36eba1e1e343279857ea7f69a597324e">fd</a>, F_GETFL);
<a name="l02462"></a>02462    <span class="keywordflow">if</span> (!<a class="code" href="group__Group__AMI.html#g58780e565b16019054545fbf6ba26a24">block_sockets</a>) <span class="comment">/* make sure socket is non-blocking */</span>
<a name="l02463"></a>02463       flags |= O_NONBLOCK;
<a name="l02464"></a>02464    <span class="keywordflow">else</span>
<a name="l02465"></a>02465       flags &amp;= ~O_NONBLOCK;
<a name="l02466"></a>02466    fcntl(ser-&gt;<a class="code" href="structserver__instance.html#36eba1e1e343279857ea7f69a597324e">fd</a>, F_SETFL, flags);
<a name="l02467"></a>02467 
<a name="l02468"></a>02468    <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;s-&gt;__lock);
<a name="l02469"></a>02469    s-&gt;send_events = -1;
<a name="l02470"></a>02470    <span class="comment">/* these fields duplicate those in the 'ser' structure */</span>
<a name="l02471"></a>02471    s-&gt;fd = ser-&gt;<a class="code" href="structserver__instance.html#36eba1e1e343279857ea7f69a597324e">fd</a>;
<a name="l02472"></a>02472    s-&gt;f = ser-&gt;<a class="code" href="structserver__instance.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>;
<a name="l02473"></a>02473    s-&gt;sin = ser-&gt;<a class="code" href="structserver__instance.html#560115e15fdc6b37096d514904104a57">requestor</a>;
<a name="l02474"></a>02474 
<a name="l02475"></a>02475    ast_atomic_fetchadd_int(&amp;<a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>, 1);
<a name="l02476"></a>02476    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02477"></a>02477    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;sessions, s, list);
<a name="l02478"></a>02478    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02479"></a>02479    <span class="comment">/* Hook to the tail of the event queue */</span>
<a name="l02480"></a>02480    s-&gt;last_ev = <a class="code" href="group__Group__AMI.html#g3bc926ccadf91a299fff3f875979895f">grab_last</a>();
<a name="l02481"></a>02481    s-&gt;f = ser-&gt;<a class="code" href="structserver__instance.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>;
<a name="l02482"></a>02482    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Asterisk Call Manager/%s\r\n"</span>, <a class="code" href="manager_8h.html#f3dd4f0a97fca03a8648f607708dafe5">AMI_VERSION</a>); <span class="comment">/* welcome prompt */</span>
<a name="l02483"></a>02483    <span class="keywordflow">for</span> (;;) {
<a name="l02484"></a>02484       <span class="keywordflow">if</span> ((res = <a class="code" href="group__Group__AMI.html#g9af7cd1eddf73300ec737507cdaee283">do_message</a>(s)) &lt; 0)
<a name="l02485"></a>02485          <span class="keywordflow">break</span>;
<a name="l02486"></a>02486    }
<a name="l02487"></a>02487    <span class="comment">/* session is over, explain why and terminate */</span>
<a name="l02488"></a>02488    <span class="keywordflow">if</span> (s-&gt;authenticated) {
<a name="l02489"></a>02489       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) {
<a name="l02490"></a>02490          <span class="keywordflow">if</span> (displayconnects)
<a name="l02491"></a>02491             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Manager '%s' logged off from %s\n"</span>, s-&gt;username, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;sin.sin_addr));
<a name="l02492"></a>02492       }
<a name="l02493"></a>02493       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4671d62857becc386bbe4cfdc0d96fdc">LOG_EVENT</a>, <span class="stringliteral">"Manager '%s' logged off from %s\n"</span>, s-&gt;username, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;sin.sin_addr));
<a name="l02494"></a>02494    } <span class="keywordflow">else</span> {
<a name="l02495"></a>02495       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) {
<a name="l02496"></a>02496          <span class="keywordflow">if</span> (displayconnects)
<a name="l02497"></a>02497             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Connect attempt from '%s' unable to authenticate\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;sin.sin_addr));
<a name="l02498"></a>02498       }
<a name="l02499"></a>02499       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4671d62857becc386bbe4cfdc0d96fdc">LOG_EVENT</a>, <span class="stringliteral">"Failed attempt from %s\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;sin.sin_addr));
<a name="l02500"></a>02500    }
<a name="l02501"></a>02501    <a class="code" href="group__Group__AMI.html#g2748014a620509eb30d57cd01d0218ce">destroy_session</a>(s);
<a name="l02502"></a>02502 
<a name="l02503"></a>02503 done:
<a name="l02504"></a>02504    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ser);
<a name="l02505"></a>02505    <span class="keywordflow">return</span> NULL;
<a name="l02506"></a>02506 }
<a name="l02507"></a>02507 <span class="comment"></span>
<a name="l02508"></a>02508 <span class="comment">/*! \brief remove at most n_max stale session from the list. */</span>
<a name="l02509"></a><a class="code" href="group__Group__AMI.html#g4051b884ed44c7d2b8b79ed1ffb0cd26">02509</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__Group__AMI.html#g4051b884ed44c7d2b8b79ed1ffb0cd26">purge_sessions</a>(<span class="keywordtype">int</span> n_max)
<a name="l02510"></a>02510 {
<a name="l02511"></a>02511    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l02512"></a>02512    time_t now = time(NULL);
<a name="l02513"></a>02513 
<a name="l02514"></a>02514    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02515"></a>02515    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;sessions, s, list) {
<a name="l02516"></a>02516       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#cc09d7a7585e6c67ce40707760dd8ba2">sessiontimeout</a> &amp;&amp; (now &gt; s-&gt;<a class="code" href="structmansession.html#cc09d7a7585e6c67ce40707760dd8ba2">sessiontimeout</a>) &amp;&amp; !s-&gt;<a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a>) {
<a name="l02517"></a>02517          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;sessions, list);
<a name="l02518"></a>02518          ast_atomic_fetchadd_int(&amp;<a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>, -1);
<a name="l02519"></a>02519          <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> &amp;&amp; (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) &amp;&amp; displayconnects) {
<a name="l02520"></a>02520             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"HTTP Manager '%s' timed out from %s\n"</span>,
<a name="l02521"></a>02521                s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l02522"></a>02522          }
<a name="l02523"></a>02523          <a class="code" href="group__Group__AMI.html#g1ea5536cdcef90f22613b5db2ee59b0d">free_session</a>(s);  <span class="comment">/* XXX outside ? */</span>
<a name="l02524"></a>02524          <span class="keywordflow">if</span> (--n_max &lt;= 0)
<a name="l02525"></a>02525             <span class="keywordflow">break</span>;
<a name="l02526"></a>02526       }
<a name="l02527"></a>02527    }
<a name="l02528"></a>02528    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l02529"></a>02529    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02530"></a>02530 }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="comment">/*</span>
<a name="l02533"></a>02533 <span class="comment"> * events are appended to a queue from where they</span>
<a name="l02534"></a>02534 <span class="comment"> * can be dispatched to clients.</span>
<a name="l02535"></a>02535 <span class="comment"> */</span>
<a name="l02536"></a><a class="code" href="group__Group__AMI.html#g38726448f966fa5ad7aaa3141ba16235">02536</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g38726448f966fa5ad7aaa3141ba16235">append_event</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>)
<a name="l02537"></a>02537 {
<a name="l02538"></a>02538    <span class="keyword">struct </span><a class="code" href="structeventqent.html">eventqent</a> *tmp = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*tmp) + strlen(str));
<a name="l02539"></a>02539    <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>;   <span class="comment">/* sequence number */</span>
<a name="l02540"></a>02540 
<a name="l02541"></a>02541    <span class="keywordflow">if</span> (!tmp)
<a name="l02542"></a>02542       <span class="keywordflow">return</span> -1;
<a name="l02543"></a>02543 
<a name="l02544"></a>02544    <span class="comment">/* need to init all fields, because ast_malloc() does not */</span>
<a name="l02545"></a>02545    tmp-&gt;usecount = 0;
<a name="l02546"></a>02546    tmp-&gt;category = category;
<a name="l02547"></a>02547    tmp-&gt;seq = ast_atomic_fetchadd_int(&amp;seq, 1);
<a name="l02548"></a>02548    <a class="code" href="linkedlists_8h.html#ab7d30c78fda9982ddc59f746adf8a69">AST_LIST_NEXT</a>(tmp, eq_next) = NULL;
<a name="l02549"></a>02549    strcpy(tmp-&gt;eventdata, str);
<a name="l02550"></a>02550 
<a name="l02551"></a>02551    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;all_events);
<a name="l02552"></a>02552    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;all_events, tmp, eq_next);
<a name="l02553"></a>02553    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;all_events);
<a name="l02554"></a>02554 
<a name="l02555"></a>02555    <span class="keywordflow">return</span> 0;
<a name="l02556"></a>02556 }
<a name="l02557"></a>02557 
<a name="l02558"></a>02558 <span class="comment">/* XXX see if can be moved inside the function */</span>
<a name="l02559"></a>02559 <a class="code" href="threadstorage_8h.html#c681a874ed42c74a7042e5f6a41aacfe">AST_THREADSTORAGE</a>(manager_event_buf);
<a name="l02560"></a><a class="code" href="group__Group__AMI.html#g9ee41aa642997459a48320201907d377">02560</a> <span class="preprocessor">#define MANAGER_EVENT_BUF_INITSIZE   256</span>
<a name="l02561"></a>02561 <span class="preprocessor"></span><span class="comment"></span>
<a name="l02562"></a>02562 <span class="comment">/*! \brief  manager_event: Send AMI event to client */</span>
<a name="l02563"></a><a class="code" href="group__Group__AMI.html#gfdfb08c15e19a1826e7fe3599e4563f6">02563</a> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gfdfb08c15e19a1826e7fe3599e4563f6">__manager_event</a>(<span class="keywordtype">int</span> <a class="code" href="structeventqent.html#c4ef352f74e502ef5e7bc98e6f4e493d">category</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#4119639092e62c55ea8be348e4d9260d">event</a>,
<a name="l02564"></a>02564    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="keywordtype">int</span> <a class="code" href="manager_8h.html#6438c669e0d0de98e6929c2cc0fac474">line</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7df4935f4a5a2865191ef74f64df8754">func</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, ...)
<a name="l02565"></a>02565 {
<a name="l02566"></a>02566    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l02567"></a>02567    <span class="keyword">struct </span><a class="code" href="structmanager__custom__hook.html">manager_custom_hook</a> *hook;
<a name="l02568"></a>02568    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *auth = <a class="code" href="strings_8h.html#15892382538fcffb4bd4216c8956c428">ast_str_alloca</a>(80);
<a name="l02569"></a>02569    <span class="keyword">const</span> <span class="keywordtype">char</span> *cat_str;
<a name="l02570"></a>02570    va_list ap;
<a name="l02571"></a>02571    <span class="keyword">struct </span>timeval now;
<a name="l02572"></a>02572    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>;
<a name="l02573"></a>02573 
<a name="l02574"></a>02574    <span class="comment">/* Abort if there aren't any manager sessions */</span>
<a name="l02575"></a>02575    <span class="keywordflow">if</span> (!<a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>)
<a name="l02576"></a>02576       <span class="keywordflow">return</span> 0;
<a name="l02577"></a>02577 
<a name="l02578"></a>02578    <span class="keywordflow">if</span> (!(buf = ast_str_thread_get(&amp;manager_event_buf, <a class="code" href="group__Group__AMI.html#g9ee41aa642997459a48320201907d377">MANAGER_EVENT_BUF_INITSIZE</a>)))
<a name="l02579"></a>02579       <span class="keywordflow">return</span> -1;
<a name="l02580"></a>02580 
<a name="l02581"></a>02581    cat_str = <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(category, &amp;auth);
<a name="l02582"></a>02582    ast_str_set(&amp;buf, 0,
<a name="l02583"></a>02583          <span class="stringliteral">"Event: %s\r\nPrivilege: %s\r\n"</span>,
<a name="l02584"></a>02584           event, cat_str);
<a name="l02585"></a>02585 
<a name="l02586"></a>02586    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g846e7158f3a1a166b993bbea7e34c1e0">timestampevents</a>) {
<a name="l02587"></a>02587       now = ast_tvnow();
<a name="l02588"></a>02588       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;buf, 0,
<a name="l02589"></a>02589             <span class="stringliteral">"Timestamp: %ld.%06lu\r\n"</span>,
<a name="l02590"></a>02590              now.tv_sec, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) now.tv_usec);
<a name="l02591"></a>02591    }
<a name="l02592"></a>02592    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a>) {
<a name="l02593"></a>02593       <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="structeventqent.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>;
<a name="l02594"></a>02594       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;buf, 0,
<a name="l02595"></a>02595             <span class="stringliteral">"SequenceNumber: %d\r\n"</span>,
<a name="l02596"></a>02596              ast_atomic_fetchadd_int(&amp;seq, 1));
<a name="l02597"></a>02597       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;buf, 0,
<a name="l02598"></a>02598             <span class="stringliteral">"File: %s\r\nLine: %d\r\nFunc: %s\r\n"</span>, file, line, func);
<a name="l02599"></a>02599    }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601    va_start(ap, fmt);
<a name="l02602"></a>02602    <a class="code" href="strings_8h.html#9e38c79af6621274e327950f48d02cae">ast_str_append_va</a>(&amp;buf, 0, fmt, ap);
<a name="l02603"></a>02603    va_end(ap);
<a name="l02604"></a>02604 
<a name="l02605"></a>02605    <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;buf, 0, <span class="stringliteral">"\r\n"</span>);
<a name="l02606"></a>02606 
<a name="l02607"></a>02607    <a class="code" href="group__Group__AMI.html#g38726448f966fa5ad7aaa3141ba16235">append_event</a>(buf-&gt;<a class="code" href="structast__str.html#3929b4348d8e5ee862fd1e38834d0217">str</a>, category);
<a name="l02608"></a>02608 
<a name="l02609"></a>02609    <span class="comment">/* Wake up any sleeping sessions */</span>
<a name="l02610"></a>02610    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02611"></a>02611    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, s, list) {
<a name="l02612"></a>02612       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02613"></a>02613       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> != <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>)
<a name="l02614"></a>02614          pthread_kill(s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a>, SIGURG);
<a name="l02615"></a>02615       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02616"></a>02616    }
<a name="l02617"></a>02617    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02618"></a>02618 
<a name="l02619"></a>02619    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;manager_hooks);
<a name="l02620"></a>02620    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#020b0bebdc89708ef3af28762efc67d6">AST_RWLIST_EMPTY</a>(&amp;manager_hooks)) {
<a name="l02621"></a>02621       <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;manager_hooks, hook, list) {
<a name="l02622"></a>02622          hook-&gt;<a class="code" href="structmanager__custom__hook.html#fde5d67bfb6dc4b598291cc2ce35ee4a">helper</a>(category, event, buf-&gt;<a class="code" href="structast__str.html#3929b4348d8e5ee862fd1e38834d0217">str</a>);
<a name="l02623"></a>02623       }
<a name="l02624"></a>02624    }
<a name="l02625"></a>02625    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;manager_hooks);
<a name="l02626"></a>02626 
<a name="l02627"></a>02627    <span class="keywordflow">return</span> 0;
<a name="l02628"></a>02628 }
<a name="l02629"></a>02629 
<a name="l02630"></a>02630 <span class="comment">/*</span>
<a name="l02631"></a>02631 <span class="comment"> * support functions to register/unregister AMI action handlers,</span>
<a name="l02632"></a>02632 <span class="comment"> */</span>
<a name="l02633"></a><a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">02633</a> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="keywordtype">char</span> *action)
<a name="l02634"></a>02634 {
<a name="l02635"></a>02635    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur, *prev;
<a name="l02636"></a>02636 
<a name="l02637"></a>02637    <a class="code" href="lock_8h.html#25d2e851f878ee9a64d36b67b67ede6e">ast_rwlock_wrlock</a>(&amp;actionlock);
<a name="l02638"></a>02638    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>, prev = NULL; cur; prev = cur, cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02639"></a>02639       <span class="keywordflow">if</span> (!strcasecmp(action, cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>)) {
<a name="l02640"></a>02640          <span class="keywordflow">if</span> (prev)
<a name="l02641"></a>02641             prev-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l02642"></a>02642          <span class="keywordflow">else</span>
<a name="l02643"></a>02643             <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a> = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l02644"></a>02644          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(cur);
<a name="l02645"></a>02645          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l02646"></a>02646             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Manager unregistered action %s\n"</span>, action);
<a name="l02647"></a>02647          <span class="keywordflow">break</span>;
<a name="l02648"></a>02648       }
<a name="l02649"></a>02649    }
<a name="l02650"></a>02650    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l02651"></a>02651    <span class="keywordflow">return</span> 0;
<a name="l02652"></a>02652 }
<a name="l02653"></a>02653 
<a name="l02654"></a><a class="code" href="group__Group__AMI.html#gff6bb88658011308f835d9278cf7f4b5">02654</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#gff6bb88658011308f835d9278cf7f4b5">manager_state_cb</a>(<span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l02655"></a>02655 {
<a name="l02656"></a>02656    <span class="comment">/* Notify managers of change */</span>
<a name="l02657"></a>02657    <span class="keywordtype">char</span> hint[BUFSIZ];
<a name="l02658"></a>02658    <a class="code" href="pbx_8c.html#b654f3264742a57f212c38761672a6c0">ast_get_hint</a>(hint, <span class="keyword">sizeof</span>(hint), NULL, 0, NULL, context, exten);
<a name="l02659"></a>02659 
<a name="l02660"></a>02660    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"ExtensionStatus"</span>, <span class="stringliteral">"Exten: %s\r\nContext: %s\r\nHint: %s\r\nStatus: %d\r\n"</span>, exten, context, hint, state);
<a name="l02661"></a>02661    <span class="keywordflow">return</span> 0;
<a name="l02662"></a>02662 }
<a name="l02663"></a>02663 
<a name="l02664"></a><a class="code" href="group__Group__AMI.html#g1c56b6ed4b387e1facec1c969283ad56">02664</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g1c56b6ed4b387e1facec1c969283ad56">ast_manager_register_struct</a>(<span class="keyword">struct</span> <a class="code" href="structmanager__action.html">manager_action</a> *act)
<a name="l02665"></a>02665 {
<a name="l02666"></a>02666    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur, *prev = NULL;
<a name="l02667"></a>02667    <span class="keywordtype">int</span> ret;
<a name="l02668"></a>02668 
<a name="l02669"></a>02669    <a class="code" href="lock_8h.html#25d2e851f878ee9a64d36b67b67ede6e">ast_rwlock_wrlock</a>(&amp;actionlock);
<a name="l02670"></a>02670    <span class="keywordflow">for</span> (cur = <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a>; cur; prev = cur, cur = cur-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02671"></a>02671       ret = strcasecmp(cur-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>, act-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>);
<a name="l02672"></a>02672       <span class="keywordflow">if</span> (ret == 0) {
<a name="l02673"></a>02673          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Manager: Action '%s' already registered\n"</span>, act-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>);
<a name="l02674"></a>02674          <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l02675"></a>02675          <span class="keywordflow">return</span> -1;
<a name="l02676"></a>02676       }
<a name="l02677"></a>02677       <span class="keywordflow">if</span> (ret &gt; 0)   <span class="comment">/* Insert these alphabetically */</span>
<a name="l02678"></a>02678          <span class="keywordflow">break</span>;
<a name="l02679"></a>02679    }
<a name="l02680"></a>02680    <span class="keywordflow">if</span> (prev)
<a name="l02681"></a>02681       prev-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = act;
<a name="l02682"></a>02682    <span class="keywordflow">else</span>
<a name="l02683"></a>02683       <a class="code" href="group__Group__AMI.html#gb9fdf2c32a9e1ffe8bea294eb2132fe6">first_action</a> = act;
<a name="l02684"></a>02684    act-&gt;<a class="code" href="structmanager__action.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = cur;
<a name="l02685"></a>02685 
<a name="l02686"></a>02686    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l02687"></a>02687       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Manager registered action %s\n"</span>, act-&gt;<a class="code" href="structmanager__action.html#418c5509e2171d55b0aee5c2ea4442b5">action</a>);
<a name="l02688"></a>02688    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;actionlock);
<a name="l02689"></a>02689    <span class="keywordflow">return</span> 0;
<a name="l02690"></a>02690 }
<a name="l02691"></a>02691 <span class="comment"></span>
<a name="l02692"></a>02692 <span class="comment">/*! \brief register a new command with manager, including online help. This is</span>
<a name="l02693"></a>02693 <span class="comment">   the preferred way to register a manager command */</span>
<a name="l02694"></a><a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">02694</a> <span class="keywordtype">int</span> <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *action, <span class="keywordtype">int</span> auth, <span class="keywordtype">int</span> (*<a class="code" href="manager_8h.html#7df4935f4a5a2865191ef74f64df8754">func</a>)(<span class="keyword">struct</span> mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#485d112e4e425dde393e2e7091451856">synopsis</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#67daf92c833c41c95db874e18fcb2786">description</a>)
<a name="l02695"></a>02695 {
<a name="l02696"></a>02696    <span class="keyword">struct </span><a class="code" href="structmanager__action.html">manager_action</a> *cur;
<a name="l02697"></a>02697 
<a name="l02698"></a>02698    cur = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*cur));
<a name="l02699"></a>02699    <span class="keywordflow">if</span> (!cur)
<a name="l02700"></a>02700       <span class="keywordflow">return</span> -1;
<a name="l02701"></a>02701 
<a name="l02702"></a>02702    cur-&gt;action = action;
<a name="l02703"></a>02703    cur-&gt;authority = auth;
<a name="l02704"></a>02704    cur-&gt;func = func;
<a name="l02705"></a>02705    cur-&gt;synopsis = synopsis;
<a name="l02706"></a>02706    cur-&gt;description = description;
<a name="l02707"></a>02707    cur-&gt;next = NULL;
<a name="l02708"></a>02708 
<a name="l02709"></a>02709    <a class="code" href="group__Group__AMI.html#g1c56b6ed4b387e1facec1c969283ad56">ast_manager_register_struct</a>(cur);
<a name="l02710"></a>02710 
<a name="l02711"></a>02711    <span class="keywordflow">return</span> 0;
<a name="l02712"></a>02712 }<span class="comment"></span>
<a name="l02713"></a>02713 <span class="comment">/*! @}</span>
<a name="l02714"></a>02714 <span class="comment"> END Doxygen group */</span>
<a name="l02715"></a>02715 
<a name="l02716"></a>02716 <span class="comment">/*</span>
<a name="l02717"></a>02717 <span class="comment"> * The following are support functions for AMI-over-http.</span>
<a name="l02718"></a>02718 <span class="comment"> * The common entry point is generic_http_callback(),</span>
<a name="l02719"></a>02719 <span class="comment"> * which extracts HTTP header and URI fields and reformats</span>
<a name="l02720"></a>02720 <span class="comment"> * them into AMI messages, locates a proper session</span>
<a name="l02721"></a>02721 <span class="comment"> * (using the mansession_id Cookie or GET variable),</span>
<a name="l02722"></a>02722 <span class="comment"> * and calls process_message() as for regular AMI clients.</span>
<a name="l02723"></a>02723 <span class="comment"> * When done, the output (which goes to a temporary file)</span>
<a name="l02724"></a>02724 <span class="comment"> * is read back into a buffer and reformatted as desired,</span>
<a name="l02725"></a>02725 <span class="comment"> * then fed back to the client over the original socket.</span>
<a name="l02726"></a>02726 <span class="comment"> */</span>
<a name="l02727"></a>02727 
<a name="l02728"></a><a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b7">02728</a> <span class="keyword">enum</span> <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b7">output_format</a> {
<a name="l02729"></a>02729    <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76e6d9740a556bec5c9d2165c11a08a72">FORMAT_RAW</a>,
<a name="l02730"></a>02730    <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>,
<a name="l02731"></a>02731    <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>,
<a name="l02732"></a>02732 };
<a name="l02733"></a>02733 
<a name="l02734"></a><a class="code" href="manager_8c.html#a89f2caaaac4606099b86e300edf06de">02734</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8c.html#a89f2caaaac4606099b86e300edf06de">contenttype</a>[] = {
<a name="l02735"></a>02735    [<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76e6d9740a556bec5c9d2165c11a08a72">FORMAT_RAW</a>] = <span class="stringliteral">"plain"</span>,
<a name="l02736"></a>02736    [<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>] = <span class="stringliteral">"html"</span>,
<a name="l02737"></a>02737    [<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>] =  <span class="stringliteral">"xml"</span>,
<a name="l02738"></a>02738 };
<a name="l02739"></a>02739 <span class="comment"></span>
<a name="l02740"></a>02740 <span class="comment">/*!</span>
<a name="l02741"></a>02741 <span class="comment"> * locate an http session in the list. The search key (ident) is</span>
<a name="l02742"></a>02742 <span class="comment"> * the value of the mansession_id cookie (0 is not valid and means</span>
<a name="l02743"></a>02743 <span class="comment"> * a session on the AMI socket).</span>
<a name="l02744"></a>02744 <span class="comment"> */</span>
<a name="l02745"></a><a class="code" href="manager_8c.html#eb5eef6f13f7164665f4b8c1ba7ab8a3">02745</a> <span class="keyword">static</span> <span class="keyword">struct </span>mansession *<a class="code" href="manager_8c.html#eb5eef6f13f7164665f4b8c1ba7ab8a3">find_session</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ident)
<a name="l02746"></a>02746 {
<a name="l02747"></a>02747    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l02748"></a>02748 
<a name="l02749"></a>02749    <span class="keywordflow">if</span> (ident == 0)
<a name="l02750"></a>02750       <span class="keywordflow">return</span> NULL;
<a name="l02751"></a>02751 
<a name="l02752"></a>02752    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02753"></a>02753    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, s, list) {
<a name="l02754"></a>02754       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02755"></a>02755       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> == ident &amp;&amp; !s-&gt;<a class="code" href="structmansession.html#550961e9c744e38a27b28e50d66f595d">needdestroy</a>) {
<a name="l02756"></a>02756          ast_atomic_fetchadd_int(&amp;s-&gt;<a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a>, 1);
<a name="l02757"></a>02757          <span class="keywordflow">break</span>;
<a name="l02758"></a>02758       }
<a name="l02759"></a>02759       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02760"></a>02760    }
<a name="l02761"></a>02761    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02762"></a>02762 
<a name="l02763"></a>02763    <span class="keywordflow">return</span> s;
<a name="l02764"></a>02764 }
<a name="l02765"></a>02765 
<a name="l02766"></a><a class="code" href="manager_8h.html#cd5d8fb2d13b6780ba64c65a02485168">02766</a> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#cd5d8fb2d13b6780ba64c65a02485168">astman_verify_session_readpermissions</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ident, <span class="keywordtype">int</span> perm)
<a name="l02767"></a>02767 {
<a name="l02768"></a>02768    <span class="keywordtype">int</span> <a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = 0;
<a name="l02769"></a>02769    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l02770"></a>02770 
<a name="l02771"></a>02771    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02772"></a>02772    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, s, list) {
<a name="l02773"></a>02773       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02774"></a>02774       <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> == ident) &amp;&amp; (s-&gt;<a class="code" href="structmansession.html#e12b8f9551a73d6196648b62754aa9e1">readperm</a> &amp; perm)) {
<a name="l02775"></a>02775          result = 1;
<a name="l02776"></a>02776          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02777"></a>02777          <span class="keywordflow">break</span>;
<a name="l02778"></a>02778       }
<a name="l02779"></a>02779       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02780"></a>02780    }
<a name="l02781"></a>02781    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02782"></a>02782    <span class="keywordflow">return</span> result;
<a name="l02783"></a>02783 }
<a name="l02784"></a>02784 
<a name="l02785"></a><a class="code" href="manager_8h.html#26f962a7a7a8f0cfadc06b37b77863bc">02785</a> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#26f962a7a7a8f0cfadc06b37b77863bc">astman_verify_session_writepermissions</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ident, <span class="keywordtype">int</span> perm)
<a name="l02786"></a>02786 {
<a name="l02787"></a>02787    <span class="keywordtype">int</span> <a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = 0;
<a name="l02788"></a>02788    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l02789"></a>02789 
<a name="l02790"></a>02790    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l02791"></a>02791    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;sessions, s, list) {
<a name="l02792"></a>02792       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02793"></a>02793       <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a> == ident) &amp;&amp; (s-&gt;<a class="code" href="structmansession.html#1cc72854e73b9b510a12e993d6479e86">writeperm</a> &amp; perm)) {
<a name="l02794"></a>02794          result = 1;
<a name="l02795"></a>02795          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02796"></a>02796          <span class="keywordflow">break</span>;
<a name="l02797"></a>02797       }
<a name="l02798"></a>02798       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l02799"></a>02799    }
<a name="l02800"></a>02800    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l02801"></a>02801    <span class="keywordflow">return</span> result;
<a name="l02802"></a>02802 }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804 <span class="comment">/*</span>
<a name="l02805"></a>02805 <span class="comment"> * convert to xml with various conversion:</span>
<a name="l02806"></a>02806 <span class="comment"> * mode &amp; 1 -&gt; lowercase;</span>
<a name="l02807"></a>02807 <span class="comment"> * mode &amp; 2 -&gt; replace non-alphanumeric chars with underscore</span>
<a name="l02808"></a>02808 <span class="comment"> */</span>
<a name="l02809"></a><a class="code" href="manager_8c.html#38980e0b6876fe8f2a22a1841fee0895">02809</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="manager_8c.html#38980e0b6876fe8f2a22a1841fee0895">xml_copy_escape</a>(<span class="keyword">struct</span> <a class="code" href="structast__str.html">ast_str</a> **out, <span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> mode)
<a name="l02810"></a>02810 {
<a name="l02811"></a>02811    <span class="comment">/* store in a local buffer to avoid calling ast_str_append too often */</span>
<a name="l02812"></a>02812    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[256];
<a name="l02813"></a>02813    <span class="keywordtype">char</span> *dst = buf;
<a name="l02814"></a>02814    <span class="keywordtype">int</span> <a class="code" href="strings_8h.html#ff2364a0be3d20e46cc69efb36afe9a5">space</a> = <span class="keyword">sizeof</span>(buf);
<a name="l02815"></a>02815    <span class="comment">/* repeat until done and nothing to flush */</span>
<a name="l02816"></a>02816    <span class="keywordflow">for</span> ( ; *src || dst != buf ; src++) {
<a name="l02817"></a>02817       <span class="keywordflow">if</span> (*src == <span class="charliteral">'\0'</span> || space &lt; 10) {   <span class="comment">/* flush */</span>
<a name="l02818"></a>02818          *dst++ = <span class="charliteral">'\0'</span>;
<a name="l02819"></a>02819          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, <span class="stringliteral">"%s"</span>, buf);
<a name="l02820"></a>02820          dst = buf;
<a name="l02821"></a>02821          space = <span class="keyword">sizeof</span>(buf);
<a name="l02822"></a>02822          <span class="keywordflow">if</span> (*src == <span class="charliteral">'\0'</span>)
<a name="l02823"></a>02823             <span class="keywordflow">break</span>;
<a name="l02824"></a>02824       }
<a name="l02825"></a>02825          
<a name="l02826"></a>02826       <span class="keywordflow">if</span> ( (mode &amp; 2) &amp;&amp; !isalnum(*src)) {
<a name="l02827"></a>02827          *dst++ = <span class="charliteral">'_'</span>;
<a name="l02828"></a>02828          space--;
<a name="l02829"></a>02829          <span class="keywordflow">continue</span>;
<a name="l02830"></a>02830       }
<a name="l02831"></a>02831       <span class="keywordflow">switch</span> (*src) {
<a name="l02832"></a>02832       <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>:
<a name="l02833"></a>02833          strcpy(dst, <span class="stringliteral">"&amp;lt;"</span>);
<a name="l02834"></a>02834          dst += 4;
<a name="l02835"></a>02835          space -= 4;
<a name="l02836"></a>02836          <span class="keywordflow">break</span>;
<a name="l02837"></a>02837       <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>:
<a name="l02838"></a>02838          strcpy(dst, <span class="stringliteral">"&amp;gt;"</span>);
<a name="l02839"></a>02839          dst += 4;
<a name="l02840"></a>02840          space -= 4;
<a name="l02841"></a>02841          <span class="keywordflow">break</span>;
<a name="l02842"></a>02842       <span class="keywordflow">case</span> <span class="charliteral">'\"'</span>:
<a name="l02843"></a>02843          strcpy(dst, <span class="stringliteral">"&amp;quot;"</span>);
<a name="l02844"></a>02844          dst += 6;
<a name="l02845"></a>02845          space -= 6;
<a name="l02846"></a>02846          <span class="keywordflow">break</span>;
<a name="l02847"></a>02847       <span class="keywordflow">case</span> <span class="charliteral">'\''</span>:
<a name="l02848"></a>02848          strcpy(dst, <span class="stringliteral">"&amp;apos;"</span>);
<a name="l02849"></a>02849          dst += 6;
<a name="l02850"></a>02850          space -= 6;
<a name="l02851"></a>02851          <span class="keywordflow">break</span>;
<a name="l02852"></a>02852       <span class="keywordflow">case</span> <span class="charliteral">'&amp;'</span>:
<a name="l02853"></a>02853          strcpy(dst, <span class="stringliteral">"&amp;amp;"</span>);
<a name="l02854"></a>02854          dst += 5;
<a name="l02855"></a>02855          space -= 5;
<a name="l02856"></a>02856          <span class="keywordflow">break</span>;
<a name="l02857"></a>02857 
<a name="l02858"></a>02858       <span class="keywordflow">default</span>:
<a name="l02859"></a>02859          *dst++ = mode ? tolower(*src) : *src;
<a name="l02860"></a>02860          space--;
<a name="l02861"></a>02861       }
<a name="l02862"></a>02862    }
<a name="l02863"></a>02863 }
<a name="l02864"></a>02864 <span class="comment"></span>
<a name="l02865"></a>02865 <span class="comment">/*! \brief Convert the input into XML or HTML.</span>
<a name="l02866"></a>02866 <span class="comment"> * The input is supposed to be a sequence of lines of the form</span>
<a name="l02867"></a>02867 <span class="comment"> * Name: value</span>
<a name="l02868"></a>02868 <span class="comment"> * optionally followed by a blob of unformatted text.</span>
<a name="l02869"></a>02869 <span class="comment"> * A blank line is a section separator. Basically, this is a</span>
<a name="l02870"></a>02870 <span class="comment"> * mixture of the format of Manager Interface and CLI commands.</span>
<a name="l02871"></a>02871 <span class="comment"> * The unformatted text is considered as a single value of a field</span>
<a name="l02872"></a>02872 <span class="comment"> * named 'Opaque-data'.</span>
<a name="l02873"></a>02873 <span class="comment"> *</span>
<a name="l02874"></a>02874 <span class="comment"> * At the moment the output format is the following (but it may</span>
<a name="l02875"></a>02875 <span class="comment"> * change depending on future requirements so don't count too</span>
<a name="l02876"></a>02876 <span class="comment"> * much on it when writing applications):</span>
<a name="l02877"></a>02877 <span class="comment"> *</span>
<a name="l02878"></a>02878 <span class="comment"> * General: the unformatted text is used as a value of</span>
<a name="l02879"></a>02879 <span class="comment"> * XML output:  to be completed</span>
<a name="l02880"></a>02880 <span class="comment"> *   Each section is within &lt;response type="object" id="xxx"&gt;</span>
<a name="l02881"></a>02881 <span class="comment"> *   where xxx is taken from ajaxdest variable or defaults to unknown</span>
<a name="l02882"></a>02882 <span class="comment"> *   Each row is reported as an attribute Name="value" of an XML</span>
<a name="l02883"></a>02883 <span class="comment"> *   entity named from the variable ajaxobjtype, default to "generic"</span>
<a name="l02884"></a>02884 <span class="comment"> *</span>
<a name="l02885"></a>02885 <span class="comment"> * HTML output:</span>
<a name="l02886"></a>02886 <span class="comment"> *   each Name-value pair is output as a single row of a two-column table.</span>
<a name="l02887"></a>02887 <span class="comment"> *   Sections (blank lines in the input) are separated by a &lt;HR&gt;</span>
<a name="l02888"></a>02888 <span class="comment"> *</span>
<a name="l02889"></a>02889 <span class="comment"> */</span>
<a name="l02890"></a><a class="code" href="manager_8c.html#645ff123f7ab62c33c2c22d620e044bb">02890</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="manager_8c.html#645ff123f7ab62c33c2c22d620e044bb">xml_translate</a>(<span class="keyword">struct</span> <a class="code" href="structast__str.html">ast_str</a> **out, <span class="keywordtype">char</span> *in, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *vars, <span class="keyword">enum</span> <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b7">output_format</a> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>)
<a name="l02891"></a>02891 {
<a name="l02892"></a>02892    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l02893"></a>02893    <span class="keywordtype">char</span> *dest = NULL;
<a name="l02894"></a>02894    <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, *<a class="code" href="structval.html">val</a>;
<a name="l02895"></a>02895    <span class="keywordtype">char</span> *objtype = NULL;
<a name="l02896"></a>02896    <span class="keywordtype">int</span> in_data = 0;  <span class="comment">/* parsing data */</span>
<a name="l02897"></a>02897    <span class="keywordtype">int</span> inobj = 0;
<a name="l02898"></a>02898    <span class="keywordtype">int</span> xml = (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>);
<a name="l02899"></a>02899 
<a name="l02900"></a>02900    <span class="keywordflow">for</span> (v = vars; v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02901"></a>02901       <span class="keywordflow">if</span> (!dest &amp;&amp; !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"ajaxdest"</span>))
<a name="l02902"></a>02902          dest = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l02903"></a>02903       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!objtype &amp;&amp; !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"ajaxobjtype"</span>))
<a name="l02904"></a>02904          objtype = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l02905"></a>02905    }
<a name="l02906"></a>02906    <span class="keywordflow">if</span> (!dest)
<a name="l02907"></a>02907       dest = <span class="stringliteral">"unknown"</span>;
<a name="l02908"></a>02908    <span class="keywordflow">if</span> (!objtype)
<a name="l02909"></a>02909       objtype = <span class="stringliteral">"generic"</span>;
<a name="l02910"></a>02910 <span class="preprocessor">#if 0</span>
<a name="l02911"></a>02911 <span class="preprocessor"></span>   <span class="comment">/* determine how large is the response.</span>
<a name="l02912"></a>02912 <span class="comment">    * This is a heuristic - counting colons (for headers),</span>
<a name="l02913"></a>02913 <span class="comment">    * newlines (for extra arguments), and escaped chars.</span>
<a name="l02914"></a>02914 <span class="comment">    * XXX needs to be checked carefully for overflows.</span>
<a name="l02915"></a>02915 <span class="comment">    * Even better, use some code that allows extensible strings.</span>
<a name="l02916"></a>02916 <span class="comment">    */</span>
<a name="l02917"></a>02917    <span class="keywordflow">for</span> (x = 0; in[x]; x++) {
<a name="l02918"></a>02918       <span class="keywordflow">if</span> (in[x] == <span class="charliteral">':'</span>)
<a name="l02919"></a>02919          colons++;
<a name="l02920"></a>02920       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in[x] == <span class="charliteral">'\n'</span>)
<a name="l02921"></a>02921          breaks++;
<a name="l02922"></a>02922       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"&amp;\"&lt;&gt;"</span>, in[x]))
<a name="l02923"></a>02923          escaped++;
<a name="l02924"></a>02924    }
<a name="l02925"></a>02925    <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = (size_t) (1 + strlen(in) + colons * 5 + breaks * (40 + strlen(dest) + strlen(objtype)) + escaped * 10); <span class="comment">/* foo="bar", "&lt;response type=\"object\" id=\"dest\"", "&amp;amp;" */</span>
<a name="l02926"></a>02926    out = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l02927"></a>02927    <span class="keywordflow">if</span> (!out)
<a name="l02928"></a>02928       <span class="keywordflow">return</span> NULL;
<a name="l02929"></a>02929    tmp = out;
<a name="l02930"></a>02930    *tmp = <span class="charliteral">'\0'</span>;
<a name="l02931"></a>02931 <span class="preprocessor">#endif</span>
<a name="l02932"></a>02932 <span class="preprocessor"></span>   <span class="comment">/* we want to stop when we find an empty line */</span>
<a name="l02933"></a>02933    <span class="keywordflow">while</span> (in &amp;&amp; *in) {
<a name="l02934"></a>02934       val = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;in, <span class="stringliteral">"\r\n"</span>); <span class="comment">/* mark start and end of line */</span>
<a name="l02935"></a>02935       <span class="keywordflow">if</span> (in &amp;&amp; *in == <span class="charliteral">'\n'</span>)     <span class="comment">/* remove trailing \n if any */</span>
<a name="l02936"></a>02936          in++;
<a name="l02937"></a>02937       ast_trim_blanks(val);
<a name="l02938"></a>02938       <span class="keywordflow">if</span> (0)
<a name="l02939"></a>02939          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"inobj %d in_data %d line &lt;%s&gt;\n"</span>, inobj, in_data, val);
<a name="l02940"></a>02940       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(val)) {
<a name="l02941"></a>02941          <span class="keywordflow">if</span> (in_data) { <span class="comment">/* close data */</span>
<a name="l02942"></a>02942             <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">"'"</span> : <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>);
<a name="l02943"></a>02943             in_data = 0;
<a name="l02944"></a>02944          }
<a name="l02945"></a>02945          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">" /&gt;&lt;/response&gt;\n"</span> :
<a name="l02946"></a>02946             <span class="stringliteral">"&lt;tr&gt;&lt;td colspan=\"2\"&gt;&lt;hr&gt;&lt;/td&gt;&lt;/tr&gt;\r\n"</span>);
<a name="l02947"></a>02947          inobj = 0;
<a name="l02948"></a>02948          <span class="keywordflow">continue</span>;
<a name="l02949"></a>02949       }
<a name="l02950"></a>02950       <span class="comment">/* we expect Name: value lines */</span>
<a name="l02951"></a>02951       <span class="keywordflow">if</span> (in_data) {
<a name="l02952"></a>02952          var = NULL;
<a name="l02953"></a>02953       } <span class="keywordflow">else</span> {
<a name="l02954"></a>02954          var = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;val, <span class="stringliteral">":"</span>);
<a name="l02955"></a>02955          <span class="keywordflow">if</span> (val) {  <span class="comment">/* found the field name */</span>
<a name="l02956"></a>02956             val = ast_skip_blanks(val);
<a name="l02957"></a>02957             ast_trim_blanks(var);
<a name="l02958"></a>02958          } <span class="keywordflow">else</span> {    <span class="comment">/* field name not found, move to opaque mode */</span>
<a name="l02959"></a>02959             val = var;
<a name="l02960"></a>02960             var = <span class="stringliteral">"Opaque-data"</span>;
<a name="l02961"></a>02961          }
<a name="l02962"></a>02962       }
<a name="l02963"></a>02963       <span class="keywordflow">if</span> (!inobj) {
<a name="l02964"></a>02964          <span class="keywordflow">if</span> (xml)
<a name="l02965"></a>02965             <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, <span class="stringliteral">"&lt;response type='object' id='%s'&gt;&lt;%s"</span>, dest, objtype);
<a name="l02966"></a>02966          <span class="keywordflow">else</span>
<a name="l02967"></a>02967             <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, <span class="stringliteral">"&lt;body&gt;\n"</span>);
<a name="l02968"></a>02968          inobj = 1;
<a name="l02969"></a>02969       }
<a name="l02970"></a>02970       <span class="keywordflow">if</span> (!in_data) {   <span class="comment">/* build appropriate line start */</span>
<a name="l02971"></a>02971          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">" "</span> : <span class="stringliteral">"&lt;tr&gt;&lt;td&gt;"</span>);
<a name="l02972"></a>02972          <a class="code" href="manager_8c.html#38980e0b6876fe8f2a22a1841fee0895">xml_copy_escape</a>(out, var, xml ? 1 | 2 : 0);
<a name="l02973"></a>02973          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">"='"</span> : <span class="stringliteral">"&lt;/td&gt;&lt;td&gt;"</span>);
<a name="l02974"></a>02974          <span class="keywordflow">if</span> (!strcmp(var, <span class="stringliteral">"Opaque-data"</span>))
<a name="l02975"></a>02975             in_data = 1;
<a name="l02976"></a>02976       }
<a name="l02977"></a>02977       <a class="code" href="manager_8c.html#38980e0b6876fe8f2a22a1841fee0895">xml_copy_escape</a>(out, val, 0); <span class="comment">/* data field */</span>
<a name="l02978"></a>02978       <span class="keywordflow">if</span> (!in_data)
<a name="l02979"></a>02979          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">"'"</span> : <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>);
<a name="l02980"></a>02980       <span class="keywordflow">else</span>
<a name="l02981"></a>02981          <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">"\n"</span> : <span class="stringliteral">"&lt;br&gt;\n"</span>);
<a name="l02982"></a>02982    }
<a name="l02983"></a>02983    <span class="keywordflow">if</span> (inobj)
<a name="l02984"></a>02984       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(out, 0, xml ? <span class="stringliteral">" /&gt;&lt;/response&gt;\n"</span> :
<a name="l02985"></a>02985          <span class="stringliteral">"&lt;tr&gt;&lt;td colspan=\"2\"&gt;&lt;hr&gt;&lt;/td&gt;&lt;/tr&gt;\r\n"</span>);
<a name="l02986"></a>02986 }
<a name="l02987"></a>02987 
<a name="l02988"></a><a class="code" href="manager_8c.html#d29cc4351fa8d1b4650f737d9bf6a630">02988</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="manager_8c.html#d29cc4351fa8d1b4650f737d9bf6a630">generic_http_callback</a>(<span class="keyword">enum</span> <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b7">output_format</a> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,
<a name="l02989"></a>02989                     <span class="keyword">struct</span> sockaddr_in *requestor, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri,
<a name="l02990"></a>02990                     <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *params, <span class="keywordtype">int</span> *status,
<a name="l02991"></a>02991                     <span class="keywordtype">char</span> **title, <span class="keywordtype">int</span> *contentlength)
<a name="l02992"></a>02992 {
<a name="l02993"></a>02993    <span class="keyword">struct </span>mansession *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = NULL;
<a name="l02994"></a>02994    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ident = 0; <span class="comment">/* invalid, so find_session will fail if not set through the cookie */</span>
<a name="l02995"></a>02995    <span class="keywordtype">int</span> blastaway = 0;
<a name="l02996"></a>02996    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l02997"></a>02997    <span class="keywordtype">char</span> <span class="keyword">template</span>[] = <span class="stringliteral">"/tmp/ast-http-XXXXXX"</span>; <span class="comment">/* template for temporary file */</span>
<a name="l02998"></a>02998    <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *out = NULL;
<a name="l02999"></a>02999    <span class="keyword">struct </span><a class="code" href="structmessage.html">message</a> m = { 0 };
<a name="l03000"></a>03000    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x;
<a name="l03001"></a>03001    size_t hdrlen;
<a name="l03002"></a>03002 
<a name="l03003"></a>03003    <span class="keywordflow">for</span> (v = params; v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l03004"></a>03004       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"mansession_id"</span>)) {
<a name="l03005"></a>03005          sscanf(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%lx"</span>, &amp;ident);
<a name="l03006"></a>03006          <span class="keywordflow">break</span>;
<a name="l03007"></a>03007       }
<a name="l03008"></a>03008    }
<a name="l03009"></a>03009 
<a name="l03010"></a>03010    <span class="keywordflow">if</span> (!(s = <a class="code" href="manager_8c.html#eb5eef6f13f7164665f4b8c1ba7ab8a3">find_session</a>(ident))) {
<a name="l03011"></a>03011       <span class="comment">/* Create new session.</span>
<a name="l03012"></a>03012 <span class="comment">       * While it is not in the list we don't need any locking</span>
<a name="l03013"></a>03013 <span class="comment">       */</span>
<a name="l03014"></a>03014       <span class="keywordflow">if</span> (!(s = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*s)))) {
<a name="l03015"></a>03015          *status = 500;
<a name="l03016"></a>03016          <span class="keywordflow">goto</span> generic_callback_out;
<a name="l03017"></a>03017       }
<a name="l03018"></a>03018       s-&gt;sin = *requestor;
<a name="l03019"></a>03019       s-&gt;fd = -1;
<a name="l03020"></a>03020       s-&gt;waiting_thread = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l03021"></a>03021       s-&gt;send_events = 0;
<a name="l03022"></a>03022       <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;s-&gt;__lock);
<a name="l03023"></a>03023       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;__lock);
<a name="l03024"></a>03024       s-&gt;inuse = 1;
<a name="l03025"></a>03025       s-&gt;managerid = rand() | 1; <span class="comment">/* make sure it is non-zero */</span>
<a name="l03026"></a>03026       s-&gt;last_ev = <a class="code" href="group__Group__AMI.html#g3bc926ccadf91a299fff3f875979895f">grab_last</a>();
<a name="l03027"></a>03027       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;sessions);
<a name="l03028"></a>03028       <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;sessions, s, list);
<a name="l03029"></a>03029       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;sessions);
<a name="l03030"></a>03030       ast_atomic_fetchadd_int(&amp;<a class="code" href="group__Group__AMI.html#g16d027da9851b664ff9336caf28769e8">num_sessions</a>, 1);
<a name="l03031"></a>03031    }
<a name="l03032"></a>03032 
<a name="l03033"></a>03033    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l03034"></a>03034 
<a name="l03035"></a>03035    <span class="keywordflow">if</span> (!(out = ast_str_create(1024))) {
<a name="l03036"></a>03036       *status = 500;
<a name="l03037"></a>03037       <span class="keywordflow">goto</span> generic_callback_out;
<a name="l03038"></a>03038    }
<a name="l03039"></a>03039 
<a name="l03040"></a>03040    s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a> = mkstemp(<span class="keyword">template</span>); <span class="comment">/* create a temporary file for command output */</span>
<a name="l03041"></a>03041    unlink(<span class="keyword">template</span>);
<a name="l03042"></a>03042    s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> = fdopen(s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"w+"</span>);
<a name="l03043"></a>03043 
<a name="l03044"></a>03044    <span class="keywordflow">for</span> (x = 0, v = params; v &amp;&amp; (x &lt; <a class="code" href="manager_8h.html#233ac9532f94e3f2b355891d25414118">AST_MAX_MANHEADERS</a>); x++, v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l03045"></a>03045       hdrlen = strlen(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>) + strlen(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>) + 3;
<a name="l03046"></a>03046       m.<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[m.<a class="code" href="structmessage.html#76e7ad105b17b3d39436c0487d899200">hdrcount</a>] = alloca(hdrlen);
<a name="l03047"></a>03047       snprintf((<span class="keywordtype">char</span> *) m.<a class="code" href="structmessage.html#0e403735bca63ec8eb4378badc1c98d0">headers</a>[m.<a class="code" href="structmessage.html#76e7ad105b17b3d39436c0487d899200">hdrcount</a>], hdrlen, <span class="stringliteral">"%s: %s"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03048"></a>03048       m.<a class="code" href="structmessage.html#76e7ad105b17b3d39436c0487d899200">hdrcount</a> = x + 1;
<a name="l03049"></a>03049    }
<a name="l03050"></a>03050 
<a name="l03051"></a>03051    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g4b975e0463cced020259b711bb8481e2">process_message</a>(s, &amp;m)) {
<a name="l03052"></a>03052       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a>) {
<a name="l03053"></a>03053          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) {
<a name="l03054"></a>03054             <span class="keywordflow">if</span> (displayconnects)
<a name="l03055"></a>03055                <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"HTTP Manager '%s' logged off from %s\n"</span>, s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03056"></a>03056          }
<a name="l03057"></a>03057          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4671d62857becc386bbe4cfdc0d96fdc">LOG_EVENT</a>, <span class="stringliteral">"HTTP Manager '%s' logged off from %s\n"</span>, s-&gt;<a class="code" href="structmansession.html#5aec535b6e1a39142c62cb283d7f9268">username</a>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03058"></a>03058       } <span class="keywordflow">else</span> {
<a name="l03059"></a>03059          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) {
<a name="l03060"></a>03060             <span class="keywordflow">if</span> (displayconnects)
<a name="l03061"></a>03061                <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"HTTP Connect attempt from '%s' unable to authenticate\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03062"></a>03062          }
<a name="l03063"></a>03063          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4671d62857becc386bbe4cfdc0d96fdc">LOG_EVENT</a>, <span class="stringliteral">"HTTP Failed attempt from %s\n"</span>, <a class="code" href="utils_8c.html#d5490a9b672272bd2f20ee1e5b72c11e">ast_inet_ntoa</a>(s-&gt;<a class="code" href="structmansession.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03064"></a>03064       }
<a name="l03065"></a>03065       s-&gt;<a class="code" href="structmansession.html#550961e9c744e38a27b28e50d66f595d">needdestroy</a> = 1;
<a name="l03066"></a>03066    }
<a name="l03067"></a>03067 
<a name="l03068"></a>03068    <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0,
<a name="l03069"></a>03069              <span class="stringliteral">"Content-type: text/%s\r\n"</span>
<a name="l03070"></a>03070              <span class="stringliteral">"Cache-Control: no-cache;\r\n"</span>
<a name="l03071"></a>03071              <span class="stringliteral">"Set-Cookie: mansession_id=\"%08lx\"; Version=\"1\"; Max-Age=%d\r\n"</span>
<a name="l03072"></a>03072              <span class="stringliteral">"\r\n"</span>,
<a name="l03073"></a>03073          contenttype[format],
<a name="l03074"></a>03074          s-&gt;<a class="code" href="structmansession.html#5eb0038a1d93de54c255dc46dcd40c66">managerid</a>, <a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">httptimeout</a>);
<a name="l03075"></a>03075 
<a name="l03076"></a>03076    <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>) {
<a name="l03077"></a>03077       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">"&lt;ajax-response&gt;\n"</span>);
<a name="l03078"></a>03078    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>) {
<a name="l03079"></a>03079 
<a name="l03080"></a>03080 <span class="preprocessor">#define ROW_FMT   "&lt;tr&gt;&lt;td colspan=\"2\" bgcolor=\"#f1f1ff\"&gt;%s&lt;/td&gt;&lt;/tr&gt;\r\n"</span>
<a name="l03081"></a>03081 <span class="preprocessor"></span><span class="preprocessor">#define TEST_STRING \</span>
<a name="l03082"></a>03082 <span class="preprocessor">   "&lt;form action=\"manager\"&gt;action: &lt;input name=\"action\"&gt; cmd &lt;input name=\"command\"&gt;&lt;br&gt; \</span>
<a name="l03083"></a>03083 <span class="preprocessor">   user &lt;input name=\"username\"&gt; pass &lt;input type=\"password\" name=\"secret\"&gt;&lt;br&gt; \</span>
<a name="l03084"></a>03084 <span class="preprocessor">   &lt;input type=\"submit\"&gt;&lt;/form&gt;"</span>
<a name="l03085"></a>03085 <span class="preprocessor"></span>
<a name="l03086"></a>03086       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">"&lt;title&gt;Asterisk&amp;trade; Manager Interface&lt;/title&gt;"</span>);
<a name="l03087"></a>03087       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">"&lt;body bgcolor=\"#ffffff\"&gt;&lt;table align=center bgcolor=\"#f1f1f1\" width=\"500\"&gt;\r\n"</span>);
<a name="l03088"></a>03088       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <a class="code" href="manager_8c.html#021d0ed88d27a243afcbb3be748af954">ROW_FMT</a>, <span class="stringliteral">"&lt;h1&gt;Manager Tester&lt;/h1&gt;"</span>);
<a name="l03089"></a>03089       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <a class="code" href="manager_8c.html#021d0ed88d27a243afcbb3be748af954">ROW_FMT</a>, <a class="code" href="manager_8c.html#8852eebb4d58b3f87ab1f0e4542d086b">TEST_STRING</a>);
<a name="l03090"></a>03090    }
<a name="l03091"></a>03091 
<a name="l03092"></a>03092    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> != NULL) {  <span class="comment">/* have temporary output */</span>
<a name="l03093"></a>03093       <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>;
<a name="l03094"></a>03094       size_t l = ftell(s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l03095"></a>03095       
<a name="l03096"></a>03096       <span class="keywordflow">if</span> (l) {
<a name="l03097"></a>03097          <span class="keywordflow">if</span> ((buf = mmap(NULL, l, PROT_READ | PROT_WRITE, MAP_SHARED, s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a>, 0))) {
<a name="l03098"></a>03098             <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a> || format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>)
<a name="l03099"></a>03099                <a class="code" href="manager_8c.html#645ff123f7ab62c33c2c22d620e044bb">xml_translate</a>(&amp;out, buf, params, format);
<a name="l03100"></a>03100             <span class="keywordflow">else</span>
<a name="l03101"></a>03101                <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, buf);
<a name="l03102"></a>03102             munmap(buf, l);
<a name="l03103"></a>03103          }
<a name="l03104"></a>03104       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a> || format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>) {
<a name="l03105"></a>03105          <a class="code" href="manager_8c.html#645ff123f7ab62c33c2c22d620e044bb">xml_translate</a>(&amp;out, <span class="stringliteral">""</span>, params, format);
<a name="l03106"></a>03106       }
<a name="l03107"></a>03107       fclose(s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l03108"></a>03108       s-&gt;<a class="code" href="structmansession.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> = NULL;
<a name="l03109"></a>03109       s-&gt;<a class="code" href="structmansession.html#36eba1e1e343279857ea7f69a597324e">fd</a> = -1;
<a name="l03110"></a>03110    }
<a name="l03111"></a>03111 
<a name="l03112"></a>03112    <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>) {
<a name="l03113"></a>03113       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">"&lt;/ajax-response&gt;\n"</span>);
<a name="l03114"></a>03114    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>)
<a name="l03115"></a>03115       <a class="code" href="strings_8h.html#0c00985509b077cfe0ccdd5829342ca4">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">"&lt;/table&gt;&lt;/body&gt;\r\n"</span>);
<a name="l03116"></a>03116 
<a name="l03117"></a>03117    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l03118"></a>03118    <span class="comment">/* Reset HTTP timeout.  If we're not authenticated, keep it extremely short */</span>
<a name="l03119"></a>03119    s-&gt;<a class="code" href="structmansession.html#cc09d7a7585e6c67ce40707760dd8ba2">sessiontimeout</a> = time(NULL) + ((s-&gt;<a class="code" href="structmansession.html#700633a1b0f65fa8456a18bd6053193c">authenticated</a> || <a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">httptimeout</a> &lt; 5) ? <a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">httptimeout</a> : 5);
<a name="l03120"></a>03120 
<a name="l03121"></a>03121    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#550961e9c744e38a27b28e50d66f595d">needdestroy</a>) {
<a name="l03122"></a>03122       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a> == 1) {
<a name="l03123"></a>03123          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03124"></a>03124             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Need destroy, doing it now!\n"</span>);
<a name="l03125"></a>03125          blastaway = 1;
<a name="l03126"></a>03126       } <span class="keywordflow">else</span> {
<a name="l03127"></a>03127          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03128"></a>03128             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Need destroy, but can't do it yet!\n"</span>);
<a name="l03129"></a>03129          <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a> != <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>)
<a name="l03130"></a>03130             pthread_kill(s-&gt;<a class="code" href="structmansession.html#6ab67d39209330f594dbe0828ca5ac80">waiting_thread</a>, SIGURG);
<a name="l03131"></a>03131          s-&gt;<a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a>--;
<a name="l03132"></a>03132       }
<a name="l03133"></a>03133    } <span class="keywordflow">else</span>
<a name="l03134"></a>03134       s-&gt;<a class="code" href="structmansession.html#9ac84af00bd68fa1e4441a101c6b6305">inuse</a>--;
<a name="l03135"></a>03135    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;s-&gt;<a class="code" href="structmansession.html#48281fd13118453275d6e66c62994356">__lock</a>);
<a name="l03136"></a>03136 
<a name="l03137"></a>03137    <span class="keywordflow">if</span> (blastaway)
<a name="l03138"></a>03138       <a class="code" href="group__Group__AMI.html#g2748014a620509eb30d57cd01d0218ce">destroy_session</a>(s);
<a name="l03139"></a>03139 generic_callback_out:
<a name="l03140"></a>03140    <span class="keywordflow">if</span> (*status != 200)
<a name="l03141"></a>03141       <span class="keywordflow">return</span> <a class="code" href="http_8c.html#d2f8473f573a2c0dd699a68d1ff970ef">ast_http_error</a>(500, <span class="stringliteral">"Server Error"</span>, NULL, <span class="stringliteral">"Internal Server Error (out of memory)\n"</span>);
<a name="l03142"></a>03142    <span class="keywordflow">return</span> out;
<a name="l03143"></a>03143 }
<a name="l03144"></a>03144 
<a name="l03145"></a><a class="code" href="manager_8c.html#9d3f921f1e6cf458c3a2f5cea1c24dc7">03145</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="manager_8c.html#9d3f921f1e6cf458c3a2f5cea1c24dc7">manager_http_callback</a>(<span class="keyword">struct</span> sockaddr_in *requestor, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *params, <span class="keywordtype">int</span> *status, <span class="keywordtype">char</span> **title, <span class="keywordtype">int</span> *contentlength)
<a name="l03146"></a>03146 {
<a name="l03147"></a>03147    <span class="keywordflow">return</span> <a class="code" href="manager_8c.html#d29cc4351fa8d1b4650f737d9bf6a630">generic_http_callback</a>(<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76c694e73146f86874cd23ec4940be5d7">FORMAT_HTML</a>, requestor, uri, params, status, title, contentlength);
<a name="l03148"></a>03148 }
<a name="l03149"></a>03149 
<a name="l03150"></a><a class="code" href="manager_8c.html#119c80dcebb27185d75f23a60e6c1046">03150</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="manager_8c.html#119c80dcebb27185d75f23a60e6c1046">mxml_http_callback</a>(<span class="keyword">struct</span> sockaddr_in *requestor, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *params, <span class="keywordtype">int</span> *status, <span class="keywordtype">char</span> **title, <span class="keywordtype">int</span> *contentlength)
<a name="l03151"></a>03151 {
<a name="l03152"></a>03152    <span class="keywordflow">return</span> <a class="code" href="manager_8c.html#d29cc4351fa8d1b4650f737d9bf6a630">generic_http_callback</a>(<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b79662bb8a01203e653f85d8e19d4ed3c3">FORMAT_XML</a>, requestor, uri, params, status, title, contentlength);
<a name="l03153"></a>03153 }
<a name="l03154"></a>03154 
<a name="l03155"></a><a class="code" href="manager_8c.html#e1be75554d9d46ab3593321aa97d81de">03155</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__str.html">ast_str</a> *<a class="code" href="manager_8c.html#e1be75554d9d46ab3593321aa97d81de">rawman_http_callback</a>(<span class="keyword">struct</span> sockaddr_in *requestor, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *params, <span class="keywordtype">int</span> *status, <span class="keywordtype">char</span> **title, <span class="keywordtype">int</span> *contentlength)
<a name="l03156"></a>03156 {
<a name="l03157"></a>03157    <span class="keywordflow">return</span> <a class="code" href="manager_8c.html#d29cc4351fa8d1b4650f737d9bf6a630">generic_http_callback</a>(<a class="code" href="manager_8c.html#50ca0e02bf37d3e8838a9ae27b99d9b76e6d9740a556bec5c9d2165c11a08a72">FORMAT_RAW</a>, requestor, uri, params, status, title, contentlength);
<a name="l03158"></a>03158 }
<a name="l03159"></a>03159 
<a name="l03160"></a><a class="code" href="manager_8c.html#8318a86553fb0a8bdb35f3f61b21eed8">03160</a> <span class="keyword">struct </span><a class="code" href="structast__http__uri.html">ast_http_uri</a> <a class="code" href="manager_8c.html#8318a86553fb0a8bdb35f3f61b21eed8">rawmanuri</a> = {
<a name="l03161"></a>03161    .<a class="code" href="structast__http__uri.html#67daf92c833c41c95db874e18fcb2786">description</a> = <span class="stringliteral">"Raw HTTP Manager Event Interface"</span>,
<a name="l03162"></a>03162    .uri = <span class="stringliteral">"rawman"</span>,
<a name="l03163"></a>03163    .has_subtree = 0,
<a name="l03164"></a>03164    .callback = <a class="code" href="manager_8c.html#e1be75554d9d46ab3593321aa97d81de">rawman_http_callback</a>,
<a name="l03165"></a>03165 };
<a name="l03166"></a>03166 
<a name="l03167"></a><a class="code" href="manager_8c.html#813ec6aec886e6bbb6ef9a1b455d78a8">03167</a> <span class="keyword">struct </span><a class="code" href="structast__http__uri.html">ast_http_uri</a> <a class="code" href="manager_8c.html#813ec6aec886e6bbb6ef9a1b455d78a8">manageruri</a> = {
<a name="l03168"></a>03168    .<a class="code" href="structast__http__uri.html#67daf92c833c41c95db874e18fcb2786">description</a> = <span class="stringliteral">"HTML Manager Event Interface"</span>,
<a name="l03169"></a>03169    .uri = <span class="stringliteral">"manager"</span>,
<a name="l03170"></a>03170    .has_subtree = 0,
<a name="l03171"></a>03171    .callback = <a class="code" href="manager_8c.html#9d3f921f1e6cf458c3a2f5cea1c24dc7">manager_http_callback</a>,
<a name="l03172"></a>03172 };
<a name="l03173"></a>03173 
<a name="l03174"></a><a class="code" href="manager_8c.html#7b55e3a11caef236115e71b9ea5a4304">03174</a> <span class="keyword">struct </span><a class="code" href="structast__http__uri.html">ast_http_uri</a> <a class="code" href="manager_8c.html#7b55e3a11caef236115e71b9ea5a4304">managerxmluri</a> = {
<a name="l03175"></a>03175    .<a class="code" href="structast__http__uri.html#67daf92c833c41c95db874e18fcb2786">description</a> = <span class="stringliteral">"XML Manager Event Interface"</span>,
<a name="l03176"></a>03176    .uri = <span class="stringliteral">"mxml"</span>,
<a name="l03177"></a>03177    .has_subtree = 0,
<a name="l03178"></a>03178    .callback = <a class="code" href="manager_8c.html#119c80dcebb27185d75f23a60e6c1046">mxml_http_callback</a>,
<a name="l03179"></a>03179 };
<a name="l03180"></a>03180 
<a name="l03181"></a><a class="code" href="manager_8c.html#a2b8ed9c305b8ea86116b603cca78a97">03181</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#a2b8ed9c305b8ea86116b603cca78a97">registered</a> = 0;
<a name="l03182"></a><a class="code" href="manager_8c.html#9327cfe8492c3330bf4d51ded3e8d1a8">03182</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#9327cfe8492c3330bf4d51ded3e8d1a8">webregged</a> = 0;
<a name="l03183"></a>03183 <span class="comment"></span>
<a name="l03184"></a>03184 <span class="comment">/*! \brief cleanup code called at each iteration of server_root,</span>
<a name="l03185"></a>03185 <span class="comment"> * guaranteed to happen every 5 seconds at most</span>
<a name="l03186"></a>03186 <span class="comment"> */</span>
<a name="l03187"></a><a class="code" href="manager_8c.html#96788aa2f4896a4c18fb160b2f4c19c6">03187</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="manager_8c.html#96788aa2f4896a4c18fb160b2f4c19c6">purge_old_stuff</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l03188"></a>03188 {
<a name="l03189"></a>03189    <a class="code" href="group__Group__AMI.html#g4051b884ed44c7d2b8b79ed1ffb0cd26">purge_sessions</a>(1);
<a name="l03190"></a>03190    <a class="code" href="group__Group__AMI.html#g50cd338ac6ba658c88ad6a7752b556e8">purge_events</a>();
<a name="l03191"></a>03191 }
<a name="l03192"></a>03192 
<a name="l03193"></a><a class="code" href="manager_8c.html#1d13b7f019c0c316c9b46d22c8dbd337">03193</a> <span class="keyword">struct </span><a class="code" href="structtls__config.html">tls_config</a> <a class="code" href="manager_8c.html#1d13b7f019c0c316c9b46d22c8dbd337">ami_tls_cfg</a>;
<a name="l03194"></a><a class="code" href="manager_8c.html#300cdb1a12b392413a97b68c6e659d08">03194</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structserver__args.html">server_args</a> <a class="code" href="manager_8c.html#300cdb1a12b392413a97b68c6e659d08">ami_desc</a> = {
<a name="l03195"></a>03195         .<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> = -1,
<a name="l03196"></a>03196         .master = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>,
<a name="l03197"></a>03197         .tls_cfg = NULL, 
<a name="l03198"></a>03198         .poll_timeout = 5000, <span class="comment">/* wake up every 5 seconds */</span>
<a name="l03199"></a>03199    .periodic_fn = <a class="code" href="manager_8c.html#96788aa2f4896a4c18fb160b2f4c19c6">purge_old_stuff</a>,
<a name="l03200"></a>03200         .name = <span class="stringliteral">"AMI server"</span>,
<a name="l03201"></a>03201         .accept_fn = <a class="code" href="http_8c.html#2d972322665fbe5a9b28da8d1fe0c307">server_root</a>,   <span class="comment">/* thread doing the accept() */</span>
<a name="l03202"></a>03202         .worker_fn = <a class="code" href="group__Group__AMI.html#g5014c646ffd1bd67b43210a9a22c136a">session_do</a>, <span class="comment">/* thread handling the session */</span>
<a name="l03203"></a>03203 };
<a name="l03204"></a>03204 
<a name="l03205"></a><a class="code" href="manager_8c.html#d60178c503bef15cc7591c2c82a11fe7">03205</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structserver__args.html">server_args</a> <a class="code" href="manager_8c.html#d60178c503bef15cc7591c2c82a11fe7">amis_desc</a> = {
<a name="l03206"></a>03206         .<a class="code" href="structserver__args.html#6adac1f76f5e9d4f8736009df4c7da00">accept_fd</a> = -1,
<a name="l03207"></a>03207         .master = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>,
<a name="l03208"></a>03208         .tls_cfg = &amp;ami_tls_cfg, 
<a name="l03209"></a>03209         .poll_timeout = -1,   <span class="comment">/* the other does the periodic cleanup */</span>
<a name="l03210"></a>03210         .name = <span class="stringliteral">"AMI TLS server"</span>,
<a name="l03211"></a>03211         .accept_fn = <a class="code" href="http_8c.html#2d972322665fbe5a9b28da8d1fe0c307">server_root</a>,   <span class="comment">/* thread doing the accept() */</span>
<a name="l03212"></a>03212         .worker_fn = <a class="code" href="group__Group__AMI.html#g5014c646ffd1bd67b43210a9a22c136a">session_do</a>, <span class="comment">/* thread handling the session */</span>
<a name="l03213"></a>03213 };
<a name="l03214"></a>03214 
<a name="l03215"></a><a class="code" href="manager_8h.html#31a28c522e71a1df85feb1926f943821">03215</a> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#31a28c522e71a1df85feb1926f943821">init_manager</a>(<span class="keywordtype">void</span>)
<a name="l03216"></a>03216 {
<a name="l03217"></a>03217    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l03218"></a>03218    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l03219"></a>03219    <span class="keywordtype">char</span> *cat = NULL;
<a name="l03220"></a>03220    <span class="keywordtype">int</span> newhttptimeout = 60;
<a name="l03221"></a>03221    <span class="keywordtype">int</span> have_sslbindaddr = 0;
<a name="l03222"></a>03222    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#d2ccda10db94c2b5d51beed10484c025">hp</a>;
<a name="l03223"></a>03223    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> <a class="code" href="chan__skinny_8c.html#2e2e7521861ea21a1ad28ba9e15d7975">ahp</a>;
<a name="l03224"></a>03224    <span class="keyword">struct </span>ast_manager_user *user = NULL;
<a name="l03225"></a>03225    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>;
<a name="l03226"></a>03226 
<a name="l03227"></a>03227    <span class="keywordflow">if</span> (!registered) {
<a name="l03228"></a>03228       <span class="comment">/* Register default actions */</span>
<a name="l03229"></a>03229       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Ping"</span>, 0, <a class="code" href="group__Group__AMI.html#gbd5ac0feea5a76122c4bb7950f72dba9">action_ping</a>, <span class="stringliteral">"Keepalive command"</span>, mandescr_ping);
<a name="l03230"></a>03230       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Events"</span>, 0, <a class="code" href="group__Group__AMI.html#g77d280f8038dfa2bb4b1ea13569c07df">action_events</a>, <span class="stringliteral">"Control Event Flow"</span>, mandescr_events);
<a name="l03231"></a>03231       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Logoff"</span>, 0, <a class="code" href="group__Group__AMI.html#g655a6b9be76687e4d0887bffacd41b3d">action_logoff</a>, <span class="stringliteral">"Logoff Manager"</span>, mandescr_logoff);
<a name="l03232"></a>03232       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Login"</span>, 0, <a class="code" href="group__Group__AMI.html#gbd3f1f5c2f6fa1c0db6646c765751566">action_login</a>, <span class="stringliteral">"Login Manager"</span>, NULL);
<a name="l03233"></a>03233       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Challenge"</span>, 0, <a class="code" href="group__Group__AMI.html#g9ba77c553c77f8cd95e812fc9a3cbf38">action_challenge</a>, <span class="stringliteral">"Generate Challenge for MD5 Auth"</span>, NULL);
<a name="l03234"></a>03234       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Hangup"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#gcee30e0477fbe6f85ac98e124a25289d">action_hangup</a>, <span class="stringliteral">"Hangup Channel"</span>, mandescr_hangup);
<a name="l03235"></a>03235       <a class="code" href="manager_8h.html#e4738d78136f7a3a390d7729872d206e">ast_manager_register</a>(<span class="stringliteral">"Status"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g6a023aadcdeed0f3c8db7756f06a85fe">action_status</a>, <span class="stringliteral">"Lists channel status"</span> );
<a name="l03236"></a>03236       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Setvar"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#gff61c40432e7043889c37096ac0560c7">action_setvar</a>, <span class="stringliteral">"Set Channel Variable"</span>, mandescr_setvar );
<a name="l03237"></a>03237       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Getvar"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#gdb0963bfde8071d731420ac8def41f9e">action_getvar</a>, <span class="stringliteral">"Gets a Channel Variable"</span>, mandescr_getvar );
<a name="l03238"></a>03238       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"GetConfig"</span>, <a class="code" href="manager_8h.html#31c33938947056ad055258c5c585812c">EVENT_FLAG_CONFIG</a>, <a class="code" href="group__Group__AMI.html#geeb75cf41619f536caffbbef71e3f730">action_getconfig</a>, <span class="stringliteral">"Retrieve configuration"</span>, mandescr_getconfig);
<a name="l03239"></a>03239       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"GetConfigJSON"</span>, <a class="code" href="manager_8h.html#31c33938947056ad055258c5c585812c">EVENT_FLAG_CONFIG</a>, <a class="code" href="group__Group__AMI.html#g51d0d48508ddb1374a9b28d95b5702d6">action_getconfigjson</a>, <span class="stringliteral">"Retrieve configuration (JSON format)"</span>, mandescr_getconfigjson);
<a name="l03240"></a>03240       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"UpdateConfig"</span>, <a class="code" href="manager_8h.html#31c33938947056ad055258c5c585812c">EVENT_FLAG_CONFIG</a>, <a class="code" href="group__Group__AMI.html#g2543b90f06c6700af2c68d854b6b4558">action_updateconfig</a>, <span class="stringliteral">"Update basic configuration"</span>, mandescr_updateconfig);
<a name="l03241"></a>03241       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Redirect"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g0076609fb6806996b6584b7a37870927">action_redirect</a>, <span class="stringliteral">"Redirect (transfer) a call"</span>, mandescr_redirect );
<a name="l03242"></a>03242       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Originate"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#gd8bc04cda5ffb147cb7c5542d3f8c1ea">action_originate</a>, <span class="stringliteral">"Originate Call"</span>, mandescr_originate);
<a name="l03243"></a>03243       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Command"</span>, <a class="code" href="manager_8h.html#055847dde76185d8491133f37610d68d">EVENT_FLAG_COMMAND</a>, <a class="code" href="group__Group__AMI.html#g6c71a4a16dd2e3115f1235a25a8fdb70">action_command</a>, <span class="stringliteral">"Execute Asterisk CLI Command"</span>, mandescr_command );
<a name="l03244"></a>03244       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"ExtensionState"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g58e43ceaccf852d6a41133bc5cfadc13">action_extensionstate</a>, <span class="stringliteral">"Check Extension Status"</span>, mandescr_extensionstate );
<a name="l03245"></a>03245       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"AbsoluteTimeout"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#ga8bc516739f567719fd6e75177f08f27">action_timeout</a>, <span class="stringliteral">"Set Absolute Timeout"</span>, mandescr_timeout );
<a name="l03246"></a>03246       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"MailboxStatus"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g44d5b6b832d95db5bfb983d39e56ee21">action_mailboxstatus</a>, <span class="stringliteral">"Check Mailbox"</span>, mandescr_mailboxstatus );
<a name="l03247"></a>03247       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"MailboxCount"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g86017430079df84ea69c923aa234bdcd">action_mailboxcount</a>, <span class="stringliteral">"Check Mailbox Message Count"</span>, mandescr_mailboxcount );
<a name="l03248"></a>03248       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"ListCommands"</span>, 0, <a class="code" href="group__Group__AMI.html#gc47a6ddacfc4e36cfb9ab30e2baf7de0">action_listcommands</a>, <span class="stringliteral">"List available manager commands"</span>, mandescr_listcommands);
<a name="l03249"></a>03249       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"SendText"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="group__Group__AMI.html#g250e20c09ed384cd90623cfd01f8b551">action_sendtext</a>, <span class="stringliteral">"Send text message to channel"</span>, mandescr_sendtext);
<a name="l03250"></a>03250       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"UserEvent"</span>, <a class="code" href="manager_8h.html#87a2ec651ddd1db88b41715162d7a242">EVENT_FLAG_USER</a>, <a class="code" href="group__Group__AMI.html#g81297609484dc4a21d32483e91c8b11d">action_userevent</a>, <span class="stringliteral">"Send an arbitrary event"</span>, mandescr_userevent);
<a name="l03251"></a>03251       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"WaitEvent"</span>, 0, <a class="code" href="group__Group__AMI.html#g8c03c9dc4ab8279645aa28d8ec5d7290">action_waitevent</a>, <span class="stringliteral">"Wait for an event to occur"</span>, mandescr_waitevent);
<a name="l03252"></a>03252       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"CoreSettings"</span>, <a class="code" href="manager_8h.html#440ebd9d80179402b9cd76c426adb8d2">EVENT_FLAG_SYSTEM</a>, <a class="code" href="group__Group__AMI.html#g4572bba9501a379251e6d7712a077035">action_coresettings</a>, <span class="stringliteral">"Show PBX core settings (version etc)"</span>, mandescr_coresettings);
<a name="l03253"></a>03253       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"CoreStatus"</span>, <a class="code" href="manager_8h.html#440ebd9d80179402b9cd76c426adb8d2">EVENT_FLAG_SYSTEM</a>, <a class="code" href="group__Group__AMI.html#g48f94483856e54f9d016fd4e00963a5c">action_corestatus</a>, <span class="stringliteral">"Show PBX core status variables"</span>, mandescr_corestatus);
<a name="l03254"></a>03254 
<a name="l03255"></a>03255       <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_manager, <span class="keyword">sizeof</span>(cli_manager) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l03256"></a>03256       <a class="code" href="pbx_8c.html#14f63100164300fc4b55b09d6c3474fd">ast_extension_state_add</a>(NULL, NULL, <a class="code" href="group__Group__AMI.html#gff6bb88658011308f835d9278cf7f4b5">manager_state_cb</a>, NULL);
<a name="l03257"></a>03257       registered = 1;
<a name="l03258"></a>03258       <span class="comment">/* Append placeholder event so master_eventq never runs dry */</span>
<a name="l03259"></a>03259       <a class="code" href="group__Group__AMI.html#g38726448f966fa5ad7aaa3141ba16235">append_event</a>(<span class="stringliteral">"Event: Placeholder\r\n\r\n"</span>, 0);
<a name="l03260"></a>03260    }
<a name="l03261"></a>03261    displayconnects = 1;
<a name="l03262"></a>03262    cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<span class="stringliteral">"manager.conf"</span>);
<a name="l03263"></a>03263    <span class="keywordflow">if</span> (!cfg) {
<a name="l03264"></a>03264       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to open management configuration manager.conf.  Call management disabled.\n"</span>);
<a name="l03265"></a>03265       <span class="keywordflow">return</span> 0;
<a name="l03266"></a>03266    }
<a name="l03267"></a>03267 
<a name="l03268"></a>03268    <span class="comment">/* default values */</span>
<a name="l03269"></a>03269    memset(&amp;ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));
<a name="l03270"></a>03270    memset(&amp;amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>, 0, <span class="keyword">sizeof</span>(amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>));
<a name="l03271"></a>03271    amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port = htons(5039);
<a name="l03272"></a>03272    ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port = htons(<a class="code" href="manager_8h.html#46c656f1ee5c96c2595d976973a96b7d">DEFAULT_MANAGER_PORT</a>);
<a name="l03273"></a>03273 
<a name="l03274"></a>03274    ami_tls_cfg.<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a> = 0;
<a name="l03275"></a>03275    <span class="keywordflow">if</span> (ami_tls_cfg.<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>)
<a name="l03276"></a>03276       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ami_tls_cfg.<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>);
<a name="l03277"></a>03277    ami_tls_cfg.<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(<a class="code" href="http_8h.html#681deafbde5165912b512a6dfc3a4cbc">AST_CERTFILE</a>);
<a name="l03278"></a>03278    <span class="keywordflow">if</span> (ami_tls_cfg.<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>)
<a name="l03279"></a>03279       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ami_tls_cfg.<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>);
<a name="l03280"></a>03280    ami_tls_cfg.<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(<span class="stringliteral">""</span>);
<a name="l03281"></a>03281 
<a name="l03282"></a>03282    <span class="keywordflow">for</span> (var = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"general"</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l03283"></a>03283       val = var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l03284"></a>03284       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"ssenable"</span>))
<a name="l03285"></a>03285          ami_tls_cfg.<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03286"></a>03286       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"ssbindport"</span>))
<a name="l03287"></a>03287          amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port = htons(atoi(val));
<a name="l03288"></a>03288       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"ssbindaddr"</span>)) {
<a name="l03289"></a>03289          <span class="keywordflow">if</span> ((hp = <a class="code" href="utils_8c.html#00f9ad2be8cda9c885557d03568816ec">ast_gethostbyname</a>(val, &amp;ahp))) {
<a name="l03290"></a>03290             memcpy(&amp;amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03291"></a>03291             have_sslbindaddr = 1;
<a name="l03292"></a>03292          } <span class="keywordflow">else</span> {
<a name="l03293"></a>03293             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Invalid bind address '%s'\n"</span>, val);
<a name="l03294"></a>03294          }
<a name="l03295"></a>03295       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"sslcert"</span>)) {
<a name="l03296"></a>03296          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ami_tls_cfg.<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a>);
<a name="l03297"></a>03297          ami_tls_cfg.<a class="code" href="structtls__config.html#b239093132d939820c54744c1ca8bb55">certfile</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(val);
<a name="l03298"></a>03298       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"sslcipher"</span>)) {
<a name="l03299"></a>03299          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ami_tls_cfg.<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a>);
<a name="l03300"></a>03300          ami_tls_cfg.<a class="code" href="structtls__config.html#08406a6e18bdf83010ddd1187251454d">cipher</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(val);
<a name="l03301"></a>03301       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"enabled"</span>)) {
<a name="l03302"></a>03302          <a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03303"></a>03303       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"block-sockets"</span>)) {
<a name="l03304"></a>03304          <a class="code" href="group__Group__AMI.html#g58780e565b16019054545fbf6ba26a24">block_sockets</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03305"></a>03305       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"webenabled"</span>)) {
<a name="l03306"></a>03306          <a class="code" href="group__Group__AMI.html#ge48c16ca333fc1529958ca58131fd875">webmanager_enabled</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03307"></a>03307       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"port"</span>)) {
<a name="l03308"></a>03308          ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_port = htons(atoi(val));
<a name="l03309"></a>03309       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"bindaddr"</span>)) {
<a name="l03310"></a>03310          <span class="keywordflow">if</span> (!inet_aton(val, &amp;ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr)) {
<a name="l03311"></a>03311             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Invalid address '%s' specified, using 0.0.0.0\n"</span>, val);
<a name="l03312"></a>03312             memset(&amp;ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr, 0, <span class="keyword">sizeof</span>(ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr));
<a name="l03313"></a>03313          }
<a name="l03314"></a>03314       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"allowmultiplelogin"</span>)) { 
<a name="l03315"></a>03315          <a class="code" href="group__Group__AMI.html#g96f294e808841cbd886011c9d0192687">allowmultiplelogin</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03316"></a>03316       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"displayconnects"</span>)) {
<a name="l03317"></a>03317          displayconnects = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03318"></a>03318       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"timestampevents"</span>)) {
<a name="l03319"></a>03319          <a class="code" href="group__Group__AMI.html#g846e7158f3a1a166b993bbea7e34c1e0">timestampevents</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03320"></a>03320       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"debug"</span>)) {
<a name="l03321"></a>03321          <a class="code" href="group__Group__AMI.html#g065d88d3234671acf0f5980f9228b827">manager_debug</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(val);
<a name="l03322"></a>03322       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"httptimeout"</span>)) {
<a name="l03323"></a>03323          newhttptimeout = atoi(val);
<a name="l03324"></a>03324       } <span class="keywordflow">else</span> {
<a name="l03325"></a>03325          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid keyword &lt;%s&gt; = &lt;%s&gt; in manager.conf [general]\n"</span>,
<a name="l03326"></a>03326             var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, val);
<a name="l03327"></a>03327       }  
<a name="l03328"></a>03328    }
<a name="l03329"></a>03329 
<a name="l03330"></a>03330    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a>)
<a name="l03331"></a>03331       ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_family = AF_INET;
<a name="l03332"></a>03332    <span class="keywordflow">if</span> (!have_sslbindaddr)
<a name="l03333"></a>03333       amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr = ami_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_addr;
<a name="l03334"></a>03334    <span class="keywordflow">if</span> (ami_tls_cfg.<a class="code" href="structtls__config.html#a10311459433adf322f2590a4987c423">enabled</a>)
<a name="l03335"></a>03335       amis_desc.<a class="code" href="structserver__args.html#7d27e4a7ca7533a3bef4fad10a0c19c7">sin</a>.sin_family = AF_INET;
<a name="l03336"></a>03336 
<a name="l03337"></a>03337    
<a name="l03338"></a>03338    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;users);
<a name="l03339"></a>03339 
<a name="l03340"></a>03340    <span class="keywordflow">while</span> ((cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, cat))) {
<a name="l03341"></a>03341 
<a name="l03342"></a>03342       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">"general"</span>))
<a name="l03343"></a>03343          <span class="keywordflow">continue</span>;
<a name="l03344"></a>03344 
<a name="l03345"></a>03345       <span class="comment">/* Look for an existing entry, if none found - create one and add it to the list */</span>
<a name="l03346"></a>03346       <span class="keywordflow">if</span> (!(user = <a class="code" href="group__Group__AMI.html#gcf9022296a6e52672bd7bf89e570c7e0">get_manager_by_name_locked</a>(cat))) {
<a name="l03347"></a>03347          <span class="keywordflow">if</span> (!(user = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*user))))
<a name="l03348"></a>03348             <span class="keywordflow">break</span>;
<a name="l03349"></a>03349          <span class="comment">/* Copy name over */</span>
<a name="l03350"></a>03350          ast_copy_string(user-&gt;username, cat, <span class="keyword">sizeof</span>(user-&gt;username));
<a name="l03351"></a>03351          <span class="comment">/* Insert into list */</span>
<a name="l03352"></a>03352          <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;users, user, list);
<a name="l03353"></a>03353       }
<a name="l03354"></a>03354 
<a name="l03355"></a>03355       <span class="comment">/* Make sure we keep this user and don't destroy it during cleanup */</span>
<a name="l03356"></a>03356       user-&gt;<a class="code" href="structast__manager__user.html#18ccf61d533b600bbf5a963359223fe4">keep</a> = 1;
<a name="l03357"></a>03357 
<a name="l03358"></a>03358       var = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, cat);
<a name="l03359"></a>03359       <span class="keywordflow">while</span> (var) {
<a name="l03360"></a>03360          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"secret"</span>)) {
<a name="l03361"></a>03361             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a>)
<a name="l03362"></a>03362                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a>);
<a name="l03363"></a>03363             user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03364"></a>03364          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"deny"</span>) ) {
<a name="l03365"></a>03365             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a>)
<a name="l03366"></a>03366                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a>);
<a name="l03367"></a>03367             user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03368"></a>03368          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"permit"</span>) ) {
<a name="l03369"></a>03369             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a>)
<a name="l03370"></a>03370                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a>);
<a name="l03371"></a>03371             user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03372"></a>03372          }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"read"</span>) ) {
<a name="l03373"></a>03373             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a>)
<a name="l03374"></a>03374                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a>);
<a name="l03375"></a>03375             user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03376"></a>03376          }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"write"</span>) ) {
<a name="l03377"></a>03377             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a>)
<a name="l03378"></a>03378                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a>);
<a name="l03379"></a>03379             user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03380"></a>03380          }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"displayconnects"</span>) )
<a name="l03381"></a>03381             user-&gt;<a class="code" href="structast__manager__user.html#a3b408e54a36d8024f4861b84f8648fb">displayconnects</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l03382"></a>03382          <span class="keywordflow">else</span> {
<a name="l03383"></a>03383             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l03384"></a>03384                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"%s is an unknown option.\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l03385"></a>03385          }
<a name="l03386"></a>03386          var = var-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l03387"></a>03387       }
<a name="l03388"></a>03388    }
<a name="l03389"></a>03389 
<a name="l03390"></a>03390    <span class="comment">/* Perform cleanup - essentially prune out old users that no longer exist */</span>
<a name="l03391"></a>03391    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;users, user, list) {
<a name="l03392"></a>03392       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#18ccf61d533b600bbf5a963359223fe4">keep</a>) { <span class="comment">/* valid record. clear flag for the next round */</span>
<a name="l03393"></a>03393          user-&gt;<a class="code" href="structast__manager__user.html#18ccf61d533b600bbf5a963359223fe4">keep</a> = 0;
<a name="l03394"></a>03394          <span class="keywordflow">continue</span>;
<a name="l03395"></a>03395       }
<a name="l03396"></a>03396       <span class="comment">/* We do not need to keep this user so take them out of the list */</span>
<a name="l03397"></a>03397       <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;users, list);
<a name="l03398"></a>03398       <span class="comment">/* Free their memory now */</span>
<a name="l03399"></a>03399       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a>)
<a name="l03400"></a>03400          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#5ebe2294ecd0e0f08eab7690d2a6ee69">secret</a>);
<a name="l03401"></a>03401       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a>)
<a name="l03402"></a>03402          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#05afb6ce69b9cef1bd6ece7e4745f96c">deny</a>);
<a name="l03403"></a>03403       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a>)
<a name="l03404"></a>03404          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#0931be4cc434934e64b1894aa2dba1ae">permit</a>);
<a name="l03405"></a>03405       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a>)
<a name="l03406"></a>03406          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#ecae13117d6f0584c25a9da6c8f8415e">read</a>);
<a name="l03407"></a>03407       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a>)
<a name="l03408"></a>03408          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user-&gt;<a class="code" href="structast__manager__user.html#efb2a684e4afb7d55e6147fbe5a332ee">write</a>);
<a name="l03409"></a>03409       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(user);
<a name="l03410"></a>03410    }
<a name="l03411"></a>03411    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l03412"></a>03412 
<a name="l03413"></a>03413    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;users);
<a name="l03414"></a>03414 
<a name="l03415"></a>03415    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l03416"></a>03416 
<a name="l03417"></a>03417    <span class="keywordflow">if</span> (<a class="code" href="group__Group__AMI.html#ge48c16ca333fc1529958ca58131fd875">webmanager_enabled</a> &amp;&amp; <a class="code" href="group__Group__AMI.html#g7fa4f9f44eb840da897cd6df25e71ea4">manager_enabled</a>) {
<a name="l03418"></a>03418       <span class="keywordflow">if</span> (!webregged) {
<a name="l03419"></a>03419          <a class="code" href="http_8c.html#6842958ab454952c76e8111211b76e5a">ast_http_uri_link</a>(&amp;rawmanuri);
<a name="l03420"></a>03420          <a class="code" href="http_8c.html#6842958ab454952c76e8111211b76e5a">ast_http_uri_link</a>(&amp;manageruri);
<a name="l03421"></a>03421          <a class="code" href="http_8c.html#6842958ab454952c76e8111211b76e5a">ast_http_uri_link</a>(&amp;managerxmluri);
<a name="l03422"></a>03422          webregged = 1;
<a name="l03423"></a>03423       }
<a name="l03424"></a>03424    } <span class="keywordflow">else</span> {
<a name="l03425"></a>03425       <span class="keywordflow">if</span> (webregged) {
<a name="l03426"></a>03426          <a class="code" href="http_8c.html#8ea490df30f4610a42a214261b1f1e99">ast_http_uri_unlink</a>(&amp;rawmanuri);
<a name="l03427"></a>03427          <a class="code" href="http_8c.html#8ea490df30f4610a42a214261b1f1e99">ast_http_uri_unlink</a>(&amp;manageruri);
<a name="l03428"></a>03428          <a class="code" href="http_8c.html#8ea490df30f4610a42a214261b1f1e99">ast_http_uri_unlink</a>(&amp;managerxmluri);
<a name="l03429"></a>03429          webregged = 0;
<a name="l03430"></a>03430       }
<a name="l03431"></a>03431    }
<a name="l03432"></a>03432 
<a name="l03433"></a>03433    <span class="keywordflow">if</span> (newhttptimeout &gt; 0)
<a name="l03434"></a>03434       <a class="code" href="group__Group__AMI.html#gff966934ba065051f34a94a400e43b17">httptimeout</a> = newhttptimeout;
<a name="l03435"></a>03435 
<a name="l03436"></a>03436    <a class="code" href="http_8c.html#78825d347437f6b39162f2bb595118fb">server_start</a>(&amp;ami_desc);
<a name="l03437"></a>03437    <span class="keywordflow">if</span> (<a class="code" href="http_8c.html#099674f856134f6c71303eceb54558dd">ssl_setup</a>(amis_desc.<a class="code" href="structserver__args.html#4043ce151e607087eae7215e08cc837d">tls_cfg</a>))
<a name="l03438"></a>03438       <a class="code" href="http_8c.html#78825d347437f6b39162f2bb595118fb">server_start</a>(&amp;amis_desc);
<a name="l03439"></a>03439    <span class="keywordflow">return</span> 0;
<a name="l03440"></a>03440 }
<a name="l03441"></a>03441 
<a name="l03442"></a><a class="code" href="manager_8h.html#5261ebdd008364aa84e6d7254982898e">03442</a> <span class="keywordtype">int</span> <a class="code" href="manager_8c.html#5261ebdd008364aa84e6d7254982898e">reload_manager</a>(<span class="keywordtype">void</span>)
<a name="l03443"></a>03443 {
<a name="l03444"></a>03444    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#440ebd9d80179402b9cd76c426adb8d2">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">"Reload"</span>, <span class="stringliteral">"Message: Reload Requested\r\n"</span>);
<a name="l03445"></a>03445    <span class="keywordflow">return</span> <a class="code" href="manager_8c.html#31a28c522e71a1df85feb1926f943821">init_manager</a>();
<a name="l03446"></a>03446 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:45 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
