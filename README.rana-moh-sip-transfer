Edvina AB
Olle E. Johansson

Project initiated: 2013-05-30
Update: 2013-07-04









Rana-moh-SIP-transfer: Getting music on hold back
=================================================
This branch focuses on two different but related issues with call transfers:

1. Attended transfer when one call leg is on hold
2. Attended transfer when one call leg is one-legged, i.e. on queue or ivr

In both of these scenarious, music-on-hold will disappear in Asterisk after transfer
is complete. The code in this branch is tested and will solve both issues.


SIP transfer with one call leg on hold
======================================
When the caller puts the callee on hold and the callee transfers the call while hearing music-on-hold,
the music disappears and the new callee gets a silent call. Originally we thought it was a SIP transfer
problem, but it turned out to be a core PBX issue.

Problem:

A calls B.
B puts A on hold.
A gets music on hold.
A transfers B to C.
C answers call.
C doesn't get music on hold - just silence.

The moh status is not following the transfer.

---
BLIND Transfer

chan1 ->transferer to asterisk
chan2 ->asterisk to transferee
target -> new channel

Todo: Copy MOH status from chan1 to target.
Or after target is set up, check hold status on chan2 and take action on that
-------
Attended transfer

- Chan1 -> transferer to asterisk
- Chan2 -> asterisk to transferee
- target.chan1 Target channel
- target.chan2 channel bridged to target
- What's the name of the channel between transferer and asterisk bridged to target???
We're bridging chan2 to target.chan1

Implementation notes
====================

- Add hold state to channel structure
- Add musiconhold class set by channel initiator
- make all channels set this class
- After bridge set up, check hold state on bridged channel
- If it's locally on hold, send AST_CONTROL_HOLD to the channel with the musicclass from the bridged channel

(After brainstorm with Matt Jordan 2013-05-28)

Transfer to a queue
===================

When doing attended transfer to a queue we have

A calls or answers B
A puts B on hold, B gets music
A calls the queue - no bridge, music provided by app_queue
A transfers B to queue

B now doesn't get any music

As this is not a hold case we need to find a way to restart MOH on a channel
with the previous settings.

Transfer to a queue: Solution:
==============================

Implement a new function in the Asterisk MOH interface to query
the musicclass. This is ONLY returned if MOH is active.

Chan_sip reads this before masquerading channels and resets
MOH after masquerade, since the transfer code resets all generators.

This only applies to attended transfers where one leg of the call
is not bridged. Like transfer to queue, IVR, or simply parking.


