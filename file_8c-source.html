<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:41 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>file.c</h1><a href="file_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Generic File Format Support.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;sys/types.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="frame_8h.html">asterisk/frame.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="sched_8h.html">asterisk/sched.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="translate_8h.html">asterisk/translate.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/*</span>
<a name="l00057"></a>00057 <span class="comment"> * The following variable controls the layout of localized sound files.</span>
<a name="l00058"></a>00058 <span class="comment"> * If 0, use the historical layout with prefix just before the filename</span>
<a name="l00059"></a>00059 <span class="comment"> * (i.e. digits/en/1.gsm , digits/it/1.gsm or default to digits/1.gsm),</span>
<a name="l00060"></a>00060 <span class="comment"> * if 1 put the prefix at the beginning of the filename</span>
<a name="l00061"></a>00061 <span class="comment"> * (i.e. en/digits/1.gsm, it/digits/1.gsm or default to digits/1.gsm).</span>
<a name="l00062"></a>00062 <span class="comment"> * The latter permits a language to be entirely in one directory.</span>
<a name="l00063"></a>00063 <span class="comment"> */</span>
<a name="l00064"></a><a class="code" href="options_8h.html#69237e3ec73293b018817789b8bc9446">00064</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#69237e3ec73293b018817789b8bc9446">ast_language_is_prefix</a> = 1;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a36c903c152ec798053aabc912ee96b3">AST_RWLIST_HEAD_STATIC</a>(formats, <a class="code" href="structast__format.html">ast_format</a>);
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="file_8h.html#b6a20976ddfd8c7397485265fe9819de">00068</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#b6a20976ddfd8c7397485265fe9819de">__ast_format_register</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>, <span class="keyword">struct</span> <a class="code" href="structast__module.html">ast_module</a> *mod)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *tmp;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;formats);
<a name="l00073"></a>00073    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;formats, tmp, list) {
<a name="l00074"></a>00074       <span class="keywordflow">if</span> (!strcasecmp(f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>, tmp-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>)) {
<a name="l00075"></a>00075          <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00076"></a>00076          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Tried to register '%s' format, already registered\n"</span>, f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>);
<a name="l00077"></a>00077          <span class="keywordflow">return</span> -1;
<a name="l00078"></a>00078       }
<a name="l00079"></a>00079    }
<a name="l00080"></a>00080    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp)))) {
<a name="l00081"></a>00081       <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00082"></a>00082       <span class="keywordflow">return</span> -1;
<a name="l00083"></a>00083    }
<a name="l00084"></a>00084    *tmp = *f;
<a name="l00085"></a>00085    tmp-&gt;<a class="code" href="structast__format.html#22884db148f0ffb0d830ba431102b0b5">module</a> = mod;
<a name="l00086"></a>00086    <span class="keywordflow">if</span> (tmp-&gt;buf_size) {
<a name="l00087"></a>00087       <span class="comment">/*</span>
<a name="l00088"></a>00088 <span class="comment">       * Align buf_size properly, rounding up to the machine-specific</span>
<a name="l00089"></a>00089 <span class="comment">       * alignment for pointers.</span>
<a name="l00090"></a>00090 <span class="comment">       */</span>
<a name="l00091"></a>00091       <span class="keyword">struct </span>_test_align { <span class="keywordtype">void</span> *a, *b; } p;
<a name="l00092"></a>00092       <span class="keywordtype">int</span> align = (<span class="keywordtype">char</span> *)&amp;p.b - (<span class="keywordtype">char</span> *)&amp;p.a;
<a name="l00093"></a>00093       tmp-&gt;buf_size = ((f-&gt;<a class="code" href="structast__format.html#278a7af3130e71a3c38651b19a88592f">buf_size</a> + align - 1)/align)*align;
<a name="l00094"></a>00094    }
<a name="l00095"></a>00095    
<a name="l00096"></a>00096    memset(&amp;tmp-&gt;list, 0, <span class="keyword">sizeof</span>(tmp-&gt;list));
<a name="l00097"></a>00097 
<a name="l00098"></a>00098    <a class="code" href="linkedlists_8h.html#b4592c522c6b3831f739508553316599">AST_RWLIST_INSERT_HEAD</a>(&amp;formats, tmp, list);
<a name="l00099"></a>00099    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00100"></a>00100    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l00101"></a>00101       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>( <a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Registered file format %s, extension(s) %s\n"</span>, f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>, f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="keywordflow">return</span> 0;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="file_8h.html#153a6a52d4750b28e5b3a3f1a7a93b7f">00106</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#153a6a52d4750b28e5b3a3f1a7a93b7f">ast_format_unregister</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *tmp;
<a name="l00109"></a>00109    <span class="keywordtype">int</span> res = -1;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111    <a class="code" href="linkedlists_8h.html#a8a78c1cb0b68179bb2e44d27216a5af">AST_RWLIST_WRLOCK</a>(&amp;formats);
<a name="l00112"></a>00112    <a class="code" href="linkedlists_8h.html#b564f1f262db6464e1644462c38d61e3">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;formats, tmp, list) {
<a name="l00113"></a>00113       <span class="keywordflow">if</span> (!strcasecmp(name, tmp-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>)) {
<a name="l00114"></a>00114          <a class="code" href="linkedlists_8h.html#93783e4cad722e705630e975d2e8d7f9">AST_RWLIST_REMOVE_CURRENT</a>(&amp;formats, list);
<a name="l00115"></a>00115          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00116"></a>00116          res = 0;
<a name="l00117"></a>00117       }
<a name="l00118"></a>00118    }
<a name="l00119"></a>00119    <a class="code" href="linkedlists_8h.html#e5be717f6b8c1586fa30a060b56403fe">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l00120"></a>00120    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122    <span class="keywordflow">if</span> (!res) {
<a name="l00123"></a>00123       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l00124"></a>00124          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>( <a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Unregistered format %s\n"</span>, name);
<a name="l00125"></a>00125    } <span class="keywordflow">else</span>
<a name="l00126"></a>00126       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Tried to unregister format %s, already unregistered\n"</span>, name);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128    <span class="keywordflow">return</span> res;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="file_8h.html#fa668f420defbe69e951881e41c47041">00131</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *tmp)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133    <span class="comment">/* Stop a running stream if there is one */</span>
<a name="l00134"></a>00134    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>) {
<a name="l00135"></a>00135       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(tmp-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>);
<a name="l00136"></a>00136       tmp-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a> = NULL;
<a name="l00137"></a>00137       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#dafa2f4e9ac82af6909c0d9f14ab8b04">oldwriteformat</a> &amp;&amp; <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(tmp, tmp-&gt;<a class="code" href="structast__channel.html#dafa2f4e9ac82af6909c0d9f14ab8b04">oldwriteformat</a>))
<a name="l00138"></a>00138          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to restore format back to %d\n"</span>, tmp-&gt;<a class="code" href="structast__channel.html#dafa2f4e9ac82af6909c0d9f14ab8b04">oldwriteformat</a>);
<a name="l00139"></a>00139    }
<a name="l00140"></a>00140    <span class="comment">/* Stop the video stream too */</span>
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a> != NULL) {
<a name="l00142"></a>00142       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(tmp-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>);
<a name="l00143"></a>00143       tmp-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a> = NULL;
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145    <span class="keywordflow">return</span> 0;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="file_8h.html#89845762896f1b8df8786e386b3a7493">00148</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150    <span class="keywordtype">int</span> res = -1;
<a name="l00151"></a>00151    <span class="keywordtype">int</span> alt = 0;
<a name="l00152"></a>00152    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92f3104666df07b461099e43be37983393">AST_FRAME_VIDEO</a>) {
<a name="l00153"></a>00153       <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> &lt; <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a>) {
<a name="l00154"></a>00154          <span class="comment">/* This is the audio portion.  Call the video one... */</span>
<a name="l00155"></a>00155          <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a> &amp;&amp; fs-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>) {
<a name="l00156"></a>00156             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> = <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> &amp; ~0x1);
<a name="l00157"></a>00157             fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a> = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(fs-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>, type, NULL, fs-&gt;<a class="code" href="structast__filestream.html#4e5868d676cb634aa75b125a0f741abf">flags</a>, 0, fs-&gt;<a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a>);
<a name="l00158"></a>00158             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00159"></a>00159                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Opened video output file\n"</span>);
<a name="l00160"></a>00160          }
<a name="l00161"></a>00161          <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>)
<a name="l00162"></a>00162             <span class="keywordflow">return</span> <a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>, f);
<a name="l00163"></a>00163          <span class="comment">/* else ignore */</span>
<a name="l00164"></a>00164          <span class="keywordflow">return</span> 0;            
<a name="l00165"></a>00165       } <span class="keywordflow">else</span> {
<a name="l00166"></a>00166          <span class="comment">/* Might / might not have mark set */</span>
<a name="l00167"></a>00167          alt = 1;
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) {
<a name="l00170"></a>00170       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Tried to write non-voice frame\n"</span>);
<a name="l00171"></a>00171       <span class="keywordflow">return</span> -1;
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173    <span class="keywordflow">if</span> (((fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> | alt) &amp; f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) == f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l00174"></a>00174       res =  fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#9c7728d73131f696c66f90b5a06492c9">write</a>(fs, f);
<a name="l00175"></a>00175       <span class="keywordflow">if</span> (res &lt; 0) 
<a name="l00176"></a>00176          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Natural write failed\n"</span>);
<a name="l00177"></a>00177       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0)
<a name="l00178"></a>00178          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Huh??\n"</span>);
<a name="l00179"></a>00179    } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180       <span class="comment">/* XXX If they try to send us a type of frame that isn't the normal frame, and isn't</span>
<a name="l00181"></a>00181 <span class="comment">             the one we've setup a translator for, we do the "wrong thing" XXX */</span>
<a name="l00182"></a>00182       <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != fs-&gt;<a class="code" href="structast__filestream.html#36ba0a38d9ec42f9efd0400425b83214">lastwriteformat</a>) {
<a name="l00183"></a>00183          <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>);
<a name="l00184"></a>00184          fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a> = NULL;
<a name="l00185"></a>00185       }
<a name="l00186"></a>00186       <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>) 
<a name="l00187"></a>00187          fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a> = <a class="code" href="translate_8c.html#46306313154b293cae4c398153ef6f75">ast_translator_build_path</a>(fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l00188"></a>00188       <span class="keywordflow">if</span> (!fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>)
<a name="l00189"></a>00189          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to translate to format %s, source format %s\n"</span>,
<a name="l00190"></a>00190             fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>));
<a name="l00191"></a>00191       <span class="keywordflow">else</span> {
<a name="l00192"></a>00192          <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *trf;
<a name="l00193"></a>00193          fs-&gt;<a class="code" href="structast__filestream.html#36ba0a38d9ec42f9efd0400425b83214">lastwriteformat</a> = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00194"></a>00194          <span class="comment">/* Get the translated frame but don't consume the original in case they're using it on another stream */</span>
<a name="l00195"></a>00195          trf = <a class="code" href="translate_8c.html#4c9e58469c9d65c1da8ecbe9cf52e749">ast_translate</a>(fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>, f, 0);
<a name="l00196"></a>00196          <span class="keywordflow">if</span> (trf) {
<a name="l00197"></a>00197             res = fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#9c7728d73131f696c66f90b5a06492c9">write</a>(fs, trf);
<a name="l00198"></a>00198             <span class="keywordflow">if</span> (res) 
<a name="l00199"></a>00199                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Translated frame write failed\n"</span>);
<a name="l00200"></a>00200          } <span class="keywordflow">else</span>
<a name="l00201"></a>00201             res = 0;
<a name="l00202"></a>00202       }
<a name="l00203"></a>00203    }
<a name="l00204"></a>00204    <span class="keywordflow">return</span> res;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="file_8c.html#231def655f9282cd0b10171d366f3d38">00207</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#231def655f9282cd0b10171d366f3d38">copy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *infile, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfile)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209    <span class="keywordtype">int</span> ifd, ofd, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00210"></a>00210    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[4096];   <span class="comment">/* XXX make it lerger. */</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212    <span class="keywordflow">if</span> ((ifd = open(infile, O_RDONLY)) &lt; 0) {
<a name="l00213"></a>00213       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open %s in read-only mode\n"</span>, infile);
<a name="l00214"></a>00214       <span class="keywordflow">return</span> -1;
<a name="l00215"></a>00215    }
<a name="l00216"></a>00216    <span class="keywordflow">if</span> ((ofd = open(outfile, O_WRONLY | O_TRUNC | O_CREAT, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>)) &lt; 0) {
<a name="l00217"></a>00217       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open %s in write-only mode\n"</span>, outfile);
<a name="l00218"></a>00218       close(ifd);
<a name="l00219"></a>00219       <span class="keywordflow">return</span> -1;
<a name="l00220"></a>00220    }
<a name="l00221"></a>00221    <span class="keywordflow">while</span> ( (len = read(ifd, buf, <span class="keyword">sizeof</span>(buf)) ) ) {
<a name="l00222"></a>00222       <span class="keywordtype">int</span> res;
<a name="l00223"></a>00223       <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00224"></a>00224          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Read failed on %s: %s\n"</span>, infile, strerror(errno));
<a name="l00225"></a>00225          <span class="keywordflow">break</span>;
<a name="l00226"></a>00226       }
<a name="l00227"></a>00227       <span class="comment">/* XXX handle partial writes */</span>
<a name="l00228"></a>00228       res = write(ofd, buf, len);
<a name="l00229"></a>00229       <span class="keywordflow">if</span> (res != len) {
<a name="l00230"></a>00230          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Write failed on %s (%d of %d): %s\n"</span>, outfile, res, len, strerror(errno));
<a name="l00231"></a>00231          len = -1; <span class="comment">/* error marker */</span>
<a name="l00232"></a>00232          <span class="keywordflow">break</span>;
<a name="l00233"></a>00233       }
<a name="l00234"></a>00234    }
<a name="l00235"></a>00235    close(ifd);
<a name="l00236"></a>00236    close(ofd);
<a name="l00237"></a>00237    <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00238"></a>00238       unlink(outfile);
<a name="l00239"></a>00239       <span class="keywordflow">return</span> -1; <span class="comment">/* error */</span>
<a name="l00240"></a>00240    }
<a name="l00241"></a>00241    <span class="keywordflow">return</span> 0;   <span class="comment">/* success */</span>
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 <span class="comment"></span>
<a name="l00244"></a>00244 <span class="comment">/*!</span>
<a name="l00245"></a>00245 <span class="comment"> * \brief construct a filename. Absolute pathnames are preserved,</span>
<a name="l00246"></a>00246 <span class="comment"> * relative names are prefixed by the sounds/ directory.</span>
<a name="l00247"></a>00247 <span class="comment"> * The wav49 suffix is replaced by 'WAV'.</span>
<a name="l00248"></a>00248 <span class="comment"> * Returns a malloc'ed string to be freed by the caller.</span>
<a name="l00249"></a>00249 <span class="comment"> */</span>
<a name="l00250"></a><a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">00250</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">build_filename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#abf77184f55403d75b9d51d79162a7ca">ext</a>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252    <span class="keywordtype">char</span> *fn = NULL;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keywordflow">if</span> (!strcmp(ext, <span class="stringliteral">"wav49"</span>))
<a name="l00255"></a>00255       ext = <span class="stringliteral">"WAV"</span>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="keywordflow">if</span> (filename[0] == <span class="charliteral">'/'</span>)
<a name="l00258"></a>00258       <a class="code" href="astmm_8h.html#df5b01e34f5d4ad06f84f9dc18d05188">asprintf</a>(&amp;fn, <span class="stringliteral">"%s.%s"</span>, filename, ext);
<a name="l00259"></a>00259    <span class="keywordflow">else</span>
<a name="l00260"></a>00260       <a class="code" href="astmm_8h.html#df5b01e34f5d4ad06f84f9dc18d05188">asprintf</a>(&amp;fn, <span class="stringliteral">"%s/sounds/%s.%s"</span>,
<a name="l00261"></a>00261          <a class="code" href="asterisk_8c.html#941063989b9bef2acc03ffa668b930a9">ast_config_AST_DATA_DIR</a>, filename, ext);
<a name="l00262"></a>00262    <span class="keywordflow">return</span> fn;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="comment">/* compare type against the list 'exts' */</span>
<a name="l00266"></a>00266 <span class="comment">/* XXX need a better algorithm */</span>
<a name="l00267"></a><a class="code" href="file_8c.html#46aa3799ad5f3db1475d2aa5ae38ce66">00267</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#46aa3799ad5f3db1475d2aa5ae38ce66">exts_compare</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *exts, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269    <span class="keywordtype">char</span> tmp[256];
<a name="l00270"></a>00270    <span class="keywordtype">char</span> *stringp = tmp, *<a class="code" href="http_8c.html#abf77184f55403d75b9d51d79162a7ca">ext</a>;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272    ast_copy_string(tmp, exts, <span class="keyword">sizeof</span>(tmp));
<a name="l00273"></a>00273    <span class="keywordflow">while</span> ((ext = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">"|"</span>))) {
<a name="l00274"></a>00274       <span class="keywordflow">if</span> (!strcmp(ext, type))
<a name="l00275"></a>00275          <span class="keywordflow">return</span> 1;
<a name="l00276"></a>00276    }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    <span class="keywordflow">return</span> 0;
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a><a class="code" href="file_8c.html#8b2a601d4c35ad931eb1d5031961d8d7">00281</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#8b2a601d4c35ad931eb1d5031961d8d7">get_filestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, FILE *bfile)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <span class="keywordtype">int</span> l = <span class="keyword">sizeof</span>(*s) + fmt-&gt;<a class="code" href="structast__format.html#278a7af3130e71a3c38651b19a88592f">buf_size</a> + fmt-&gt;<a class="code" href="structast__format.html#28712dbb41522563998e67e445955d18">desc_size</a>;  <span class="comment">/* total allocation size */</span>
<a name="l00286"></a>00286    <span class="keywordflow">if</span> ( (s = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, l)) == NULL)
<a name="l00287"></a>00287       <span class="keywordflow">return</span> NULL;
<a name="l00288"></a>00288    s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a> = fmt;
<a name="l00289"></a>00289    s-&gt;<a class="code" href="structast__filestream.html#8fa14cdd754f91cc6554c9e71929cce7">f</a> = bfile;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (fmt-&gt;<a class="code" href="structast__format.html#28712dbb41522563998e67e445955d18">desc_size</a>)
<a name="l00292"></a>00292       s-&gt;<a class="code" href="structast__filestream.html#2c17c6393771ee3048ae34d6b380c5ec">private</a> = ((<span class="keywordtype">char</span> *)(s+1)) + fmt-&gt;<a class="code" href="structast__format.html#278a7af3130e71a3c38651b19a88592f">buf_size</a>;
<a name="l00293"></a>00293    if (fmt-&gt;<a class="code" href="structast__format.html#278a7af3130e71a3c38651b19a88592f">buf_size</a>)
<a name="l00294"></a>00294       s-&gt;<a class="code" href="structast__filestream.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> = (<span class="keywordtype">char</span> *)(s+1);
<a name="l00295"></a>00295    s-&gt;<a class="code" href="structast__filestream.html#82a9e4d26595c87ab6e442391d8c5bba">fr</a>.<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> = fmt-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>;
<a name="l00296"></a>00296    <span class="keywordflow">return</span> s;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="comment">/*</span>
<a name="l00300"></a>00300 <span class="comment"> * Default implementations of open and rewrite.</span>
<a name="l00301"></a>00301 <span class="comment"> * Only use them if you don't have expensive stuff to do.</span>
<a name="l00302"></a>00302 <span class="comment"> */</span>
<a name="l00303"></a><a class="code" href="file_8c.html#e337379286417fec04819f061520d831">00303</a> <span class="keyword">enum</span> <a class="code" href="file_8c.html#e337379286417fec04819f061520d831">wrap_fn</a> { <a class="code" href="file_8c.html#e337379286417fec04819f061520d8316ba126e3d603f5686d38209e2d482118">WRAP_OPEN</a>, <a class="code" href="file_8c.html#e337379286417fec04819f061520d8313bb91e03108f24ef6ac18615144b2be9">WRAP_REWRITE</a> };
<a name="l00304"></a>00304 
<a name="l00305"></a><a class="code" href="file_8c.html#783cc8c6f72286cee63f8590e4f1e88b">00305</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#783cc8c6f72286cee63f8590e4f1e88b">fn_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *comment, <span class="keyword">enum</span> <a class="code" href="file_8c.html#e337379286417fec04819f061520d831">wrap_fn</a> <a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a>)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>;
<a name="l00308"></a>00308    <span class="keywordtype">int</span> ret = -1;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="keywordflow">if</span> (mode == <a class="code" href="file_8c.html#e337379286417fec04819f061520d8316ba126e3d603f5686d38209e2d482118">WRAP_OPEN</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#e7aaa27d4e47c1ff41f292ee6a248ccd">open</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#e7aaa27d4e47c1ff41f292ee6a248ccd">open</a>(s))
<a name="l00311"></a>00311                 <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open format %s\n"</span>, f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>);
<a name="l00312"></a>00312    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="file_8c.html#e337379286417fec04819f061520d8313bb91e03108f24ef6ac18615144b2be9">WRAP_REWRITE</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#673937cce5afa9a5637d6501f942c990">rewrite</a> &amp;&amp; f-&gt;<a class="code" href="structast__format.html#673937cce5afa9a5637d6501f942c990">rewrite</a>(s, comment))
<a name="l00313"></a>00313                 <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"Unable to rewrite format %s\n"</span>, f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>);
<a name="l00314"></a>00314    <span class="keywordflow">else</span> {
<a name="l00315"></a>00315       <span class="comment">/* preliminary checks succeed. update usecount */</span>
<a name="l00316"></a>00316       <a class="code" href="loader_8c.html#7dec48488624afa5d0a80ad2726071db">ast_module_ref</a>(f-&gt;<a class="code" href="structast__format.html#22884db148f0ffb0d830ba431102b0b5">module</a>);
<a name="l00317"></a>00317       ret = 0;
<a name="l00318"></a>00318    }
<a name="l00319"></a>00319         <span class="keywordflow">return</span> ret;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="file_8c.html#5e0e182ed798d78b5951ffb839569c80">00322</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#5e0e182ed798d78b5951ffb839569c80">rewrite_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *comment)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#783cc8c6f72286cee63f8590e4f1e88b">fn_wrapper</a>(s, comment, <a class="code" href="file_8c.html#e337379286417fec04819f061520d8313bb91e03108f24ef6ac18615144b2be9">WRAP_REWRITE</a>);
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326                 
<a name="l00327"></a><a class="code" href="file_8c.html#9349c61165431c507acc86e1f40d8382">00327</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#9349c61165431c507acc86e1f40d8382">open_wrapper</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#783cc8c6f72286cee63f8590e4f1e88b">fn_wrapper</a>(s, NULL, <a class="code" href="file_8c.html#e337379286417fec04819f061520d8316ba126e3d603f5686d38209e2d482118">WRAP_OPEN</a>);
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e">00332</a> <span class="keyword">enum</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e">file_action</a> {
<a name="l00333"></a>00333    <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee68ac516cf44fcd23dcf366682ae5fcc">ACTION_EXISTS</a> = 1, <span class="comment">/* return matching format if file exists, 0 otherwise */</span>
<a name="l00334"></a>00334    <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e8234d4d7a93eb89c19a8ee395a301fa3">ACTION_DELETE</a>, <span class="comment">/* delete file, return 0 on success, -1 on error */</span>
<a name="l00335"></a>00335    <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e6e34a74c158c47d152d471615f885447">ACTION_RENAME</a>, <span class="comment">/* rename file. return 0 on success, -1 on error */</span>
<a name="l00336"></a>00336    <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee7fa34859ffb18159e586e7e88ec0b03">ACTION_OPEN</a>,
<a name="l00337"></a>00337    <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ef75888a4f5d73bd7c461038d57e3aee7">ACTION_COPY</a> <span class="comment">/* copy file. return 0 on success, -1 on error */</span>
<a name="l00338"></a>00338 };
<a name="l00339"></a>00339 <span class="comment"></span>
<a name="l00340"></a>00340 <span class="comment">/*!</span>
<a name="l00341"></a>00341 <span class="comment"> * \brief perform various actions on a file. Second argument</span>
<a name="l00342"></a>00342 <span class="comment"> * arg2 depends on the command:</span>
<a name="l00343"></a>00343 <span class="comment"> * unused for EXISTS and DELETE</span>
<a name="l00344"></a>00344 <span class="comment"> * destination file name (const char *) for COPY and RENAME</span>
<a name="l00345"></a>00345 <span class="comment"> *    struct ast_channel * for OPEN</span>
<a name="l00346"></a>00346 <span class="comment"> * if fmt is NULL, OPEN will return the first matching entry,</span>
<a name="l00347"></a>00347 <span class="comment"> * whereas other functions will run on all matching entries.</span>
<a name="l00348"></a>00348 <span class="comment"> */</span>
<a name="l00349"></a><a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">00349</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">void</span> *arg2, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, <span class="keyword">const</span> <span class="keyword">enum</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e">file_action</a> action)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00352"></a>00352    <span class="keywordtype">int</span> res = (action == <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee68ac516cf44fcd23dcf366682ae5fcc">ACTION_EXISTS</a>) ? 0 : -1;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;formats);
<a name="l00355"></a>00355    <span class="comment">/* Check for a specific format */</span>
<a name="l00356"></a>00356    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;formats, f, list) {
<a name="l00357"></a>00357       <span class="keywordtype">char</span> *stringp, *<a class="code" href="http_8c.html#abf77184f55403d75b9d51d79162a7ca">ext</a> = NULL;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359       <span class="keywordflow">if</span> (fmt &amp;&amp; !<a class="code" href="file_8c.html#46aa3799ad5f3db1475d2aa5ae38ce66">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>, fmt))
<a name="l00360"></a>00360          <span class="keywordflow">continue</span>;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362       <span class="comment">/* Look for a file matching the supported extensions.</span>
<a name="l00363"></a>00363 <span class="comment">       * The file must exist, and for OPEN, must match</span>
<a name="l00364"></a>00364 <span class="comment">       * one of the formats supported by the channel.</span>
<a name="l00365"></a>00365 <span class="comment">       */</span>
<a name="l00366"></a>00366       stringp = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>);  <span class="comment">/* this is in the stack so does not need to be freed */</span>
<a name="l00367"></a>00367       <span class="keywordflow">while</span> ( (ext = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">"|"</span>)) ) {
<a name="l00368"></a>00368          <span class="keyword">struct </span>stat st;
<a name="l00369"></a>00369          <span class="keywordtype">char</span> *fn = <a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">build_filename</a>(filename, ext);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371          <span class="keywordflow">if</span> (fn == NULL)
<a name="l00372"></a>00372             <span class="keywordflow">continue</span>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374          <span class="keywordflow">if</span> ( stat(fn, &amp;st) ) { <span class="comment">/* file not existent */</span>
<a name="l00375"></a>00375             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00376"></a>00376             <span class="keywordflow">continue</span>;
<a name="l00377"></a>00377          }
<a name="l00378"></a>00378          <span class="comment">/* for 'OPEN' we need to be sure that the format matches</span>
<a name="l00379"></a>00379 <span class="comment">          * what the channel can process</span>
<a name="l00380"></a>00380 <span class="comment">          */</span>
<a name="l00381"></a>00381          <span class="keywordflow">if</span> (action == <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee7fa34859ffb18159e586e7e88ec0b03">ACTION_OPEN</a>) {
<a name="l00382"></a>00382             <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> = (<span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *)arg2;
<a name="l00383"></a>00383             FILE *bfile;
<a name="l00384"></a>00384             <span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386             <span class="keywordflow">if</span> ( !(chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> &amp; f-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>) &amp;&amp;
<a name="l00387"></a>00387                  !(f-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> &gt;= <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a> &amp;&amp; fmt)) {
<a name="l00388"></a>00388                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00389"></a>00389                <span class="keywordflow">continue</span>;   <span class="comment">/* not a supported format */</span>
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391             <span class="keywordflow">if</span> ( (bfile = fopen(fn, <span class="stringliteral">"r"</span>)) == NULL) {
<a name="l00392"></a>00392                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00393"></a>00393                <span class="keywordflow">continue</span>;   <span class="comment">/* cannot open file */</span>
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395             <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = <a class="code" href="file_8c.html#8b2a601d4c35ad931eb1d5031961d8d7">get_filestream</a>(f, bfile);
<a name="l00396"></a>00396             <span class="keywordflow">if</span> (!<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>) {
<a name="l00397"></a>00397                fclose(bfile);
<a name="l00398"></a>00398                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);   <span class="comment">/* cannot allocate descriptor */</span>
<a name="l00399"></a>00399                <span class="keywordflow">continue</span>;
<a name="l00400"></a>00400             }
<a name="l00401"></a>00401             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#9349c61165431c507acc86e1f40d8382">open_wrapper</a>(<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)) {
<a name="l00402"></a>00402                fclose(bfile);
<a name="l00403"></a>00403                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00404"></a>00404                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>);
<a name="l00405"></a>00405                <span class="keywordflow">continue</span>;   <span class="comment">/* cannot run open on file */</span>
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407             <span class="comment">/* ok this is good for OPEN */</span>
<a name="l00408"></a>00408             res = 1; <span class="comment">/* found */</span>
<a name="l00409"></a>00409             <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>-&gt;lasttimeout = -1;
<a name="l00410"></a>00410             <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>-&gt;fmt = f;
<a name="l00411"></a>00411             <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>-&gt;trans = NULL;
<a name="l00412"></a>00412             <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>-&gt;filename = NULL;
<a name="l00413"></a>00413             <span class="keywordflow">if</span> (<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>-&gt;fmt-&gt;format &lt; <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a>) {
<a name="l00414"></a>00414                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>)
<a name="l00415"></a>00415                   <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>);
<a name="l00416"></a>00416                chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a> = <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00417"></a>00417             } <span class="keywordflow">else</span> {
<a name="l00418"></a>00418                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>)
<a name="l00419"></a>00419                   <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>);
<a name="l00420"></a>00420                chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a> = <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00421"></a>00421             }
<a name="l00422"></a>00422             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00423"></a>00423             <span class="keywordflow">break</span>;
<a name="l00424"></a>00424          }
<a name="l00425"></a>00425          <span class="keywordflow">switch</span> (action) {
<a name="l00426"></a>00426          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee7fa34859ffb18159e586e7e88ec0b03">ACTION_OPEN</a>:
<a name="l00427"></a>00427             <span class="keywordflow">break</span>;   <span class="comment">/* will never get here */</span>
<a name="l00428"></a>00428 
<a name="l00429"></a>00429          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee68ac516cf44fcd23dcf366682ae5fcc">ACTION_EXISTS</a>:  <span class="comment">/* return the matching format */</span>
<a name="l00430"></a>00430             res |= f-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00431"></a>00431             <span class="keywordflow">break</span>;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e8234d4d7a93eb89c19a8ee395a301fa3">ACTION_DELETE</a>:
<a name="l00434"></a>00434             <span class="keywordflow">if</span> ( (res = unlink(fn)) )
<a name="l00435"></a>00435                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unlink(%s) failed: %s\n"</span>, fn, strerror(errno));
<a name="l00436"></a>00436             <span class="keywordflow">break</span>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e6e34a74c158c47d152d471615f885447">ACTION_RENAME</a>:
<a name="l00439"></a>00439          <span class="keywordflow">case</span> <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ef75888a4f5d73bd7c461038d57e3aee7">ACTION_COPY</a>: {
<a name="l00440"></a>00440             <span class="keywordtype">char</span> *nfn = <a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">build_filename</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)arg2, ext);
<a name="l00441"></a>00441             <span class="keywordflow">if</span> (!nfn)
<a name="l00442"></a>00442                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"Out of memory\n"</span>);
<a name="l00443"></a>00443             <span class="keywordflow">else</span> {
<a name="l00444"></a>00444                res = action == <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ef75888a4f5d73bd7c461038d57e3aee7">ACTION_COPY</a> ? <a class="code" href="file_8c.html#231def655f9282cd0b10171d366f3d38">copy</a>(fn, nfn) : rename(fn, nfn);
<a name="l00445"></a>00445                <span class="keywordflow">if</span> (res)
<a name="l00446"></a>00446                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"%s(%s,%s) failed: %s\n"</span>,
<a name="l00447"></a>00447                      action == <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ef75888a4f5d73bd7c461038d57e3aee7">ACTION_COPY</a> ? <span class="stringliteral">"copy"</span> : <span class="stringliteral">"rename"</span>,
<a name="l00448"></a>00448                       fn, nfn, strerror(errno));
<a name="l00449"></a>00449                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(nfn);
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451              }
<a name="l00452"></a>00452             <span class="keywordflow">break</span>;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454          <span class="keywordflow">default</span>:
<a name="l00455"></a>00455             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"Unknown helper %d\n"</span>, action);
<a name="l00456"></a>00456          }
<a name="l00457"></a>00457          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00461"></a>00461    <span class="keywordflow">return</span> res;
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 <span class="comment"></span>
<a name="l00464"></a>00464 <span class="comment">/*!</span>
<a name="l00465"></a>00465 <span class="comment"> * \brief helper routine to locate a file with a given format</span>
<a name="l00466"></a>00466 <span class="comment"> * and language preference.</span>
<a name="l00467"></a>00467 <span class="comment"> * Try preflang, preflang with stripped '_' suffix, or NULL.</span>
<a name="l00468"></a>00468 <span class="comment"> * In the standard asterisk, language goes just before the last component.</span>
<a name="l00469"></a>00469 <span class="comment"> * In an alternative configuration, the language should be a prefix</span>
<a name="l00470"></a>00470 <span class="comment"> * to the actual filename.</span>
<a name="l00471"></a>00471 <span class="comment"> *</span>
<a name="l00472"></a>00472 <span class="comment"> * The last parameter(s) point to a buffer of sufficient size,</span>
<a name="l00473"></a>00473 <span class="comment"> * which on success is filled with the matching filename.</span>
<a name="l00474"></a>00474 <span class="comment"> */</span>
<a name="l00475"></a><a class="code" href="file_8c.html#f4b88c55b7c7df1e88b865fae06bd48b">00475</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#f4b88c55b7c7df1e88b865fae06bd48b">fileexists_core</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang,
<a name="l00476"></a>00476       <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, <span class="keywordtype">int</span> buflen)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478    <span class="keywordtype">int</span> res = -1;
<a name="l00479"></a>00479    <span class="keywordtype">int</span> langlen;   <span class="comment">/* length of language string */</span>
<a name="l00480"></a>00480    <span class="keyword">const</span> <span class="keywordtype">char</span> *c = strrchr(filename, <span class="charliteral">'/'</span>);
<a name="l00481"></a>00481    <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = c ? c - filename + 1 : 0; <span class="comment">/* points right after the last '/' */</span>
<a name="l00482"></a>00482 
<a name="l00483"></a>00483    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00484"></a>00484       preflang = <span class="stringliteral">""</span>;
<a name="l00485"></a>00485    langlen = strlen(preflang);
<a name="l00486"></a>00486    
<a name="l00487"></a>00487    <span class="keywordflow">if</span> (buflen &lt; langlen + strlen(filename) + 2) {
<a name="l00488"></a>00488       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"buffer too small\n"</span>);
<a name="l00489"></a>00489       buf[0] = <span class="charliteral">'\0'</span>; <span class="comment">/* set to empty */</span>
<a name="l00490"></a>00490       buf = alloca(langlen + strlen(filename) + 2);   <span class="comment">/* room for everything */</span>
<a name="l00491"></a>00491    }
<a name="l00492"></a>00492    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00493"></a>00493       <span class="keywordflow">return</span> 0;
<a name="l00494"></a>00494    buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00495"></a>00495    <span class="keywordflow">for</span> (;;) {
<a name="l00496"></a>00496       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#69237e3ec73293b018817789b8bc9446">ast_language_is_prefix</a>) { <span class="comment">/* new layout */</span>
<a name="l00497"></a>00497          <span class="keywordflow">if</span> (langlen) {
<a name="l00498"></a>00498             strcpy(buf, preflang);
<a name="l00499"></a>00499             buf[langlen] = <span class="charliteral">'/'</span>;
<a name="l00500"></a>00500             strcpy(buf + langlen + 1, filename);
<a name="l00501"></a>00501          } <span class="keywordflow">else</span>
<a name="l00502"></a>00502             strcpy(buf, filename);  <span class="comment">/* first copy the full string */</span>
<a name="l00503"></a>00503       } <span class="keywordflow">else</span> { <span class="comment">/* old layout */</span>
<a name="l00504"></a>00504          strcpy(buf, filename);  <span class="comment">/* first copy the full string */</span>
<a name="l00505"></a>00505          <span class="keywordflow">if</span> (langlen) {
<a name="l00506"></a>00506             <span class="comment">/* insert the language and suffix if needed */</span>
<a name="l00507"></a>00507             strcpy(buf + offset, preflang);
<a name="l00508"></a>00508             sprintf(buf + offset + langlen, <span class="stringliteral">"/%s"</span>, filename + offset);
<a name="l00509"></a>00509          }
<a name="l00510"></a>00510       }
<a name="l00511"></a>00511       res = <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(buf, NULL, fmt, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee68ac516cf44fcd23dcf366682ae5fcc">ACTION_EXISTS</a>);
<a name="l00512"></a>00512       <span class="keywordflow">if</span> (res &gt; 0)      <span class="comment">/* found format */</span>
<a name="l00513"></a>00513          <span class="keywordflow">break</span>;
<a name="l00514"></a>00514       <span class="keywordflow">if</span> (langlen == 0) <span class="comment">/* no more formats */</span>
<a name="l00515"></a>00515          <span class="keywordflow">break</span>;
<a name="l00516"></a>00516       <span class="keywordflow">if</span> (preflang[langlen] == <span class="charliteral">'_'</span>) <span class="comment">/* we are on the local suffix */</span>
<a name="l00517"></a>00517          langlen = 0;   <span class="comment">/* try again with no language */</span>
<a name="l00518"></a>00518       <span class="keywordflow">else</span>
<a name="l00519"></a>00519          langlen = (c = strchr(preflang, <span class="charliteral">'_'</span>)) ? c - preflang : 0;
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    <span class="keywordflow">return</span> res;
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="file_8h.html#0bcbc0f6cab0bf6be159f0d5844e1b4b">00524</a> <span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#0bcbc0f6cab0bf6be159f0d5844e1b4b">ast_openstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#b3c8b25cffdb8cddd9ece4671da30b03">ast_openstream_full</a>(chan, filename, preflang, 0);
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="file_8h.html#b3c8b25cffdb8cddd9ece4671da30b03">00529</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#b3c8b25cffdb8cddd9ece4671da30b03">ast_openstream_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang, <span class="keywordtype">int</span> asis)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531    <span class="comment">/* </span>
<a name="l00532"></a>00532 <span class="comment">    * Use fileexists_core() to find a file in a compatible</span>
<a name="l00533"></a>00533 <span class="comment">    * language and format, set up a suitable translator,</span>
<a name="l00534"></a>00534 <span class="comment">    * and open the stream.</span>
<a name="l00535"></a>00535 <span class="comment">    */</span>
<a name="l00536"></a>00536    <span class="keywordtype">int</span> fmts, res, buflen;
<a name="l00537"></a>00537    <span class="keywordtype">char</span> *buf;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (!asis) {
<a name="l00540"></a>00540       <span class="comment">/* do this first, otherwise we detect the wrong writeformat */</span>
<a name="l00541"></a>00541       <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(chan);
<a name="l00542"></a>00542       <span class="keywordflow">if</span> (chan-&gt;generator)
<a name="l00543"></a>00543          <a class="code" href="channel_8c.html#e4e0e5c1767576b38fb1a893dfd8cb2b">ast_deactivate_generator</a>(chan);
<a name="l00544"></a>00544    }
<a name="l00545"></a>00545    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00546"></a>00546       preflang = <span class="stringliteral">""</span>;
<a name="l00547"></a>00547    buflen = strlen(preflang) + strlen(filename) + 2;
<a name="l00548"></a>00548    buf = alloca(buflen);
<a name="l00549"></a>00549    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00550"></a>00550       <span class="keywordflow">return</span> NULL;
<a name="l00551"></a>00551    fmts = <a class="code" href="file_8c.html#f4b88c55b7c7df1e88b865fae06bd48b">fileexists_core</a>(filename, NULL, preflang, buf, buflen);
<a name="l00552"></a>00552    <span class="keywordflow">if</span> (fmts &gt; 0)
<a name="l00553"></a>00553       fmts &amp;= <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>;
<a name="l00554"></a>00554    <span class="keywordflow">if</span> (fmts &lt; 1) {
<a name="l00555"></a>00555       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s does not exist in any format\n"</span>, filename);
<a name="l00556"></a>00556       <span class="keywordflow">return</span> NULL;
<a name="l00557"></a>00557    }
<a name="l00558"></a>00558    chan-&gt;<a class="code" href="structast__channel.html#dafa2f4e9ac82af6909c0d9f14ab8b04">oldwriteformat</a> = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l00559"></a>00559    <span class="comment">/* Set the channel to a format we can work with */</span>
<a name="l00560"></a>00560    res = <a class="code" href="channel_8c.html#ebcd70a10759c189c265a97b5a9f78c3">ast_set_write_format</a>(chan, fmts);
<a name="l00561"></a>00561    res = <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(buf, chan, NULL, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee7fa34859ffb18159e586e7e88ec0b03">ACTION_OPEN</a>);
<a name="l00562"></a>00562    <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l00563"></a>00563       <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>;
<a name="l00564"></a>00564    <span class="keywordflow">return</span> NULL;
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a><a class="code" href="file_8h.html#226c58342b830e85eb5c359c6ab5a65f">00567</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#226c58342b830e85eb5c359c6ab5a65f">ast_openvstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569    <span class="comment">/* As above, but for video. But here we don't have translators</span>
<a name="l00570"></a>00570 <span class="comment">    * so we must enforce a format.</span>
<a name="l00571"></a>00571 <span class="comment">    */</span>
<a name="l00572"></a>00572    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00573"></a>00573    <span class="keywordtype">char</span> *buf;
<a name="l00574"></a>00574    <span class="keywordtype">int</span> buflen;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00577"></a>00577       preflang = <span class="stringliteral">""</span>;
<a name="l00578"></a>00578    buflen = strlen(preflang) + strlen(filename) + 2;
<a name="l00579"></a>00579    buf = alloca(buflen);
<a name="l00580"></a>00580    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00581"></a>00581       <span class="keywordflow">return</span> NULL;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583    <span class="keywordflow">for</span> (format = <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a> &lt;&lt; 1; format &lt;= <a class="code" href="frame_8h.html#c3eeac0a86246d4b2b2c9ea6881d56b4">AST_FORMAT_MAX_VIDEO</a>; format = format &lt;&lt; 1) {
<a name="l00584"></a>00584       <span class="keywordtype">int</span> fd;
<a name="l00585"></a>00585       <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587       <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a> &amp; format))
<a name="l00588"></a>00588          <span class="keywordflow">continue</span>;
<a name="l00589"></a>00589       fmt = <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(format);
<a name="l00590"></a>00590       <span class="keywordflow">if</span> ( <a class="code" href="file_8c.html#f4b88c55b7c7df1e88b865fae06bd48b">fileexists_core</a>(filename, fmt, preflang, buf, buflen) &lt; 1)   <span class="comment">/* no valid format */</span>
<a name="l00591"></a>00591          <span class="keywordflow">continue</span>;
<a name="l00592"></a>00592       fd = <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(buf, chan, fmt, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ee7fa34859ffb18159e586e7e88ec0b03">ACTION_OPEN</a>);
<a name="l00593"></a>00593       <span class="keywordflow">if</span> (fd &gt;= 0)
<a name="l00594"></a>00594          <span class="keywordflow">return</span> chan-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a>;
<a name="l00595"></a>00595       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s has video but couldn't be opened\n"</span>, filename);
<a name="l00596"></a>00596    }
<a name="l00597"></a>00597    <span class="keywordflow">return</span> NULL;
<a name="l00598"></a>00598 }
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="file_8h.html#adedd7e446f209ba9d3f1ce00ea08697">00600</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="file_8c.html#adedd7e446f209ba9d3f1ce00ea08697">ast_readframe</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l00603"></a>00603    <span class="keywordtype">int</span> whennext = 0; 
<a name="l00604"></a>00604    <span class="keywordflow">if</span> (s &amp;&amp; s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>)
<a name="l00605"></a>00605       f = s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#93ecff7ef453f32514e255a0ff2554da">read</a>(s, &amp;whennext);
<a name="l00606"></a>00606    <span class="keywordflow">return</span> f;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00609"></a><a class="code" href="file_8c.html#f5a98694d07d96552824ea26af9c6dbf">00609</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#f5a98694d07d96552824ea26af9c6dbf">ast_readaudio_callback</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = data;
<a name="l00612"></a>00612    <span class="keywordtype">int</span> whennext = 0;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614    <span class="keywordflow">while</span> (!whennext) {
<a name="l00615"></a>00615       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *fr = s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#93ecff7ef453f32514e255a0ff2554da">read</a>(s, &amp;whennext);
<a name="l00616"></a>00616       <span class="keywordflow">if</span> (!fr <span class="comment">/* stream complete */</span> || <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, fr) <span class="comment">/* error writing */</span>) {
<a name="l00617"></a>00617          <span class="keywordflow">if</span> (fr)
<a name="l00618"></a>00618             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to write frame\n"</span>);
<a name="l00619"></a>00619          s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#087aaf86312ca1817642c650010e8439">streamid</a> = -1;
<a name="l00620"></a>00620 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span>         <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, 0, NULL, NULL);
<a name="l00622"></a>00622 <span class="preprocessor">#endif         </span>
<a name="l00623"></a>00623 <span class="preprocessor"></span>         <span class="keywordflow">return</span> 0;
<a name="l00624"></a>00624       }
<a name="l00625"></a>00625    }
<a name="l00626"></a>00626    <span class="keywordflow">if</span> (whennext != s-&gt;<a class="code" href="structast__filestream.html#72237796f66f299f9b946e07c3c2cb13">lasttimeout</a>) {
<a name="l00627"></a>00627 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4cd06d1a010b6a371149b4a0adb2f884">timingfd</a> &gt; -1)
<a name="l00629"></a>00629          <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, whennext, <a class="code" href="file_8c.html#f5a98694d07d96552824ea26af9c6dbf">ast_readaudio_callback</a>, s);
<a name="l00630"></a>00630       <span class="keywordflow">else</span>
<a name="l00631"></a>00631 <span class="preprocessor">#endif      </span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>         s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#087aaf86312ca1817642c650010e8439">streamid</a> = <a class="code" href="sched_8c.html#d8304ea2ef7bcdee5012e64ab1356d96">ast_sched_add</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>, whennext/8, <a class="code" href="file_8c.html#f5a98694d07d96552824ea26af9c6dbf">ast_readaudio_callback</a>, s);
<a name="l00633"></a>00633       s-&gt;<a class="code" href="structast__filestream.html#72237796f66f299f9b946e07c3c2cb13">lasttimeout</a> = whennext;
<a name="l00634"></a>00634       <span class="keywordflow">return</span> 0;
<a name="l00635"></a>00635    }
<a name="l00636"></a>00636    <span class="keywordflow">return</span> 1;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a><a class="code" href="file_8c.html#d362f43c8af328f5120e3a4cb7d75ac2">00639</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#d362f43c8af328f5120e3a4cb7d75ac2">ast_readvideo_callback</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l00640"></a>00640 {
<a name="l00641"></a>00641    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = data;
<a name="l00642"></a>00642    <span class="keywordtype">int</span> whennext = 0;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644    <span class="keywordflow">while</span> (!whennext) {
<a name="l00645"></a>00645       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *fr = s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#93ecff7ef453f32514e255a0ff2554da">read</a>(s, &amp;whennext);
<a name="l00646"></a>00646       <span class="keywordflow">if</span> (!fr || <a class="code" href="channel_8c.html#57a74c4c7b7e25ad61a4f461e3c73158">ast_write</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, fr)) { <span class="comment">/* no stream or error, as above */</span>
<a name="l00647"></a>00647          <span class="keywordflow">if</span> (fr)
<a name="l00648"></a>00648             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to write frame\n"</span>);
<a name="l00649"></a>00649          s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#790c2cf72cbd5f4fd647896a75a06570">vstreamid</a> = -1;
<a name="l00650"></a>00650          <span class="keywordflow">return</span> 0;
<a name="l00651"></a>00651       }
<a name="l00652"></a>00652    }
<a name="l00653"></a>00653    <span class="keywordflow">if</span> (whennext != s-&gt;<a class="code" href="structast__filestream.html#72237796f66f299f9b946e07c3c2cb13">lasttimeout</a>) {
<a name="l00654"></a>00654       s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#790c2cf72cbd5f4fd647896a75a06570">vstreamid</a> = <a class="code" href="sched_8c.html#d8304ea2ef7bcdee5012e64ab1356d96">ast_sched_add</a>(s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>, whennext/8, <a class="code" href="file_8c.html#d362f43c8af328f5120e3a4cb7d75ac2">ast_readvideo_callback</a>, s);
<a name="l00655"></a>00655       s-&gt;<a class="code" href="structast__filestream.html#72237796f66f299f9b946e07c3c2cb13">lasttimeout</a> = whennext;
<a name="l00656"></a>00656       <span class="keywordflow">return</span> 0;
<a name="l00657"></a>00657    }
<a name="l00658"></a>00658    <span class="keywordflow">return</span> 1;
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a><a class="code" href="file_8h.html#47ae0cfaee0f98a97bf732081a55fcdc">00661</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663    s-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = chan;
<a name="l00664"></a>00664    <span class="keywordflow">return</span> 0;
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a><a class="code" href="file_8h.html#96615b28d77eef740ce76e209aad7424">00667</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> &lt; <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a>)
<a name="l00670"></a>00670       <a class="code" href="file_8c.html#f5a98694d07d96552824ea26af9c6dbf">ast_readaudio_callback</a>(s);
<a name="l00671"></a>00671    <span class="keywordflow">else</span>
<a name="l00672"></a>00672       <a class="code" href="file_8c.html#d362f43c8af328f5120e3a4cb7d75ac2">ast_readvideo_callback</a>(s);
<a name="l00673"></a>00673    <span class="keywordflow">return</span> 0;
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a><a class="code" href="file_8h.html#02e10962dcfcb69e23bfaf15dce32393">00676</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs, off_t sample_offset, <span class="keywordtype">int</span> whence)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ecca7b8374382e647398ed939b6ab8d">seek</a>(fs, sample_offset, whence);
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a><a class="code" href="file_8h.html#ce29e5d0bdd4ecde2928bc9055507bc0">00681</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#ce29e5d0bdd4ecde2928bc9055507bc0">ast_truncstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#ca25eb0535d82c17027552e98e6b429e">trunc</a>(fs);
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="file_8h.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">00686</a> off_t <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs)
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688    <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#a5c5c564c0fac936920dc29ed50f8bac">tell</a>(fs);
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00691"></a><a class="code" href="file_8h.html#a89ae22b0f4ddc671b516808ebfc0679">00691</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#a89ae22b0f4ddc671b516808ebfc0679">ast_stream_fastforward</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs, off_t ms)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, ms * <a class="code" href="asterisk_8h.html#35d9207ec8638d71f1e25e0299f1f48d">DEFAULT_SAMPLES_PER_MS</a>, SEEK_CUR);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="file_8h.html#3a2eb1ab87bc99265738281b25fc6999">00696</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#3a2eb1ab87bc99265738281b25fc6999">ast_stream_rewind</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *fs, off_t ms)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, -ms * <a class="code" href="asterisk_8h.html#35d9207ec8638d71f1e25e0299f1f48d">DEFAULT_SAMPLES_PER_MS</a>, SEEK_CUR);
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a><a class="code" href="file_8h.html#8d18ac7b6bb79201e6321c4b5cfadde2">00701</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(<span class="keyword">struct</span> <a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>)
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703    <span class="keywordtype">char</span> *cmd = NULL;
<a name="l00704"></a>00704    size_t size = 0;
<a name="l00705"></a>00705    <span class="comment">/* Stop a running stream if there is one */</span>
<a name="l00706"></a>00706    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>) {
<a name="l00707"></a>00707       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> &lt; <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a>) {
<a name="l00708"></a>00708          f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a> = NULL;
<a name="l00709"></a>00709          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#087aaf86312ca1817642c650010e8439">streamid</a> &gt; -1)
<a name="l00710"></a>00710             <a class="code" href="sched_8c.html#4a0b784f64b9caf71932a3344c9c7c49">ast_sched_del</a>(f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#087aaf86312ca1817642c650010e8439">streamid</a>);
<a name="l00711"></a>00711          f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#087aaf86312ca1817642c650010e8439">streamid</a> = -1;
<a name="l00712"></a>00712 <span class="preprocessor">#ifdef HAVE_ZAPTEL</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>         <a class="code" href="channel_8c.html#031ef8a01f979ba2f40451d97a515e80">ast_settimeout</a>(f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, 0, NULL, NULL);
<a name="l00714"></a>00714 <span class="preprocessor">#endif         </span>
<a name="l00715"></a>00715 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> {
<a name="l00716"></a>00716          f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#a4853768f8d245b7d0d327cb620b8f52">vstream</a> = NULL;
<a name="l00717"></a>00717          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#790c2cf72cbd5f4fd647896a75a06570">vstreamid</a> &gt; -1)
<a name="l00718"></a>00718             <a class="code" href="sched_8c.html#4a0b784f64b9caf71932a3344c9c7c49">ast_sched_del</a>(f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>, f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#790c2cf72cbd5f4fd647896a75a06570">vstreamid</a>);
<a name="l00719"></a>00719          f-&gt;<a class="code" href="structast__filestream.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#790c2cf72cbd5f4fd647896a75a06570">vstreamid</a> = -1;
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721    }
<a name="l00722"></a>00722    <span class="comment">/* destroy the translator on exit */</span>
<a name="l00723"></a>00723    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>)
<a name="l00724"></a>00724       <a class="code" href="translate_8c.html#8f7ccc974f6f91b750a59c4353700191">ast_translator_free_path</a>(f-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a>);
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a> &amp;&amp; f-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>) {
<a name="l00727"></a>00727          size = strlen(f-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>) + strlen(f-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a>) + 15;
<a name="l00728"></a>00728          cmd = alloca(size);
<a name="l00729"></a>00729          memset(cmd,0,size);
<a name="l00730"></a>00730          snprintf(cmd,size,<span class="stringliteral">"/bin/mv -f %s %s"</span>,f-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>,f-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a>);
<a name="l00731"></a>00731          <a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(cmd);
<a name="l00732"></a>00732    }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>)
<a name="l00735"></a>00735       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(f-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a>);
<a name="l00736"></a>00736    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a>)
<a name="l00737"></a>00737       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(f-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a>);
<a name="l00738"></a>00738    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#474d8ca4cf587f836fe15026852f7ed5">close</a>)
<a name="l00739"></a>00739       f-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#474d8ca4cf587f836fe15026852f7ed5">close</a>(f);
<a name="l00740"></a>00740    fclose(f-&gt;<a class="code" href="structast__filestream.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>);
<a name="l00741"></a>00741    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>)
<a name="l00742"></a>00742       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(f-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>);
<a name="l00743"></a>00743    <a class="code" href="loader_8c.html#593d1afacbd4c5bd89aac5a810e50f6e">ast_module_unref</a>(f-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#22884db148f0ffb0d830ba431102b0b5">module</a>);
<a name="l00744"></a>00744    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(f);
<a name="l00745"></a>00745    <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="comment">/*</span>
<a name="l00750"></a>00750 <span class="comment"> * Look the various language-specific places where a file could exist.</span>
<a name="l00751"></a>00751 <span class="comment"> */</span>
<a name="l00752"></a><a class="code" href="file_8h.html#5a3ec0398dc377f7850e62edc9e093df">00752</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754    <span class="keywordtype">char</span> *buf;
<a name="l00755"></a>00755    <span class="keywordtype">int</span> buflen;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <span class="keywordflow">if</span> (preflang == NULL)
<a name="l00758"></a>00758       preflang = <span class="stringliteral">""</span>;
<a name="l00759"></a>00759    buflen = strlen(preflang) + strlen(filename) + 2;  <span class="comment">/* room for everything */</span>
<a name="l00760"></a>00760    buf = alloca(buflen);
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (buf == NULL)
<a name="l00762"></a>00762       <span class="keywordflow">return</span> 0;
<a name="l00763"></a>00763    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#f4b88c55b7c7df1e88b865fae06bd48b">fileexists_core</a>(filename, fmt, preflang, buf, buflen);
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a><a class="code" href="file_8h.html#5a0cbe1f8c9ff2126997209a785679d5">00766</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(filename, NULL, fmt, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e8234d4d7a93eb89c19a8ee395a301fa3">ACTION_DELETE</a>);
<a name="l00769"></a>00769 }
<a name="l00770"></a>00770 
<a name="l00771"></a><a class="code" href="file_8h.html#f207ae9d1c93732bef5546c288efb3ff">00771</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#6550c411c28c65446c5ad2a8307b50eb">ast_filerename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename2, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt)
<a name="l00772"></a>00772 {
<a name="l00773"></a>00773    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(filename, filename2, fmt, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086e6e34a74c158c47d152d471615f885447">ACTION_RENAME</a>);
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="file_8h.html#12ac68f6ca092814c52a43b112dee2a9">00776</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#002e77f5a6dfbe096d6cca62c3493ec1">ast_filecopy</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename2, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#a079af1212fcb54690cd26c4e127e578">ast_filehelper</a>(filename, filename2, fmt, <a class="code" href="file_8c.html#c37d135e7f5cdb7c1b3c07bf28bb086ef75888a4f5d73bd7c461038d57e3aee7">ACTION_COPY</a>);
<a name="l00779"></a>00779 }
<a name="l00780"></a>00780 
<a name="l00781"></a><a class="code" href="file_8h.html#89903498f31ba12bb2f3cdbf1634bc3c">00781</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *preflang)
<a name="l00782"></a>00782 {
<a name="l00783"></a>00783    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs;
<a name="l00784"></a>00784    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>=NULL;
<a name="l00785"></a>00785    <span class="keywordtype">char</span> fmt[256];
<a name="l00786"></a>00786 
<a name="l00787"></a>00787    fs = <a class="code" href="file_8c.html#0bcbc0f6cab0bf6be159f0d5844e1b4b">ast_openstream</a>(chan, filename, preflang);
<a name="l00788"></a>00788    <span class="keywordflow">if</span> (fs)
<a name="l00789"></a>00789       vfs = <a class="code" href="file_8c.html#226c58342b830e85eb5c359c6ab5a65f">ast_openvstream</a>(chan, filename, preflang);
<a name="l00790"></a>00790    <span class="keywordflow">if</span> (vfs) {
<a name="l00791"></a>00791       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00792"></a>00792          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Ooh, found a video stream, too, format %s\n"</span>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(vfs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>));
<a name="l00793"></a>00793    }
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (fs){
<a name="l00795"></a>00795       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, fs))
<a name="l00796"></a>00796          <span class="keywordflow">return</span> -1;
<a name="l00797"></a>00797       <span class="keywordflow">if</span> (vfs &amp;&amp; <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, vfs))
<a name="l00798"></a>00798          <span class="keywordflow">return</span> -1;
<a name="l00799"></a>00799       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(fs))
<a name="l00800"></a>00800          <span class="keywordflow">return</span> -1;
<a name="l00801"></a>00801       <span class="keywordflow">if</span> (vfs &amp;&amp; <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(vfs))
<a name="l00802"></a>00802          <span class="keywordflow">return</span> -1;
<a name="l00803"></a>00803       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00804"></a>00804          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"&lt;%s&gt; Playing '%s.%s' (language '%s')\n"</span>, chan-&gt;name, filename, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(chan-&gt;writeformat), preflang ? preflang : <span class="stringliteral">"default"</span>);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806       <span class="keywordflow">return</span> 0;
<a name="l00807"></a>00807    }
<a name="l00808"></a>00808    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open %s (format %s): %s\n"</span>, filename, <a class="code" href="frame_8c.html#98f2e5f4c4b2d13cb63057889cc0b743">ast_getformatname_multiple</a>(fmt, <span class="keyword">sizeof</span>(fmt), chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>), strerror(errno));
<a name="l00809"></a>00809    <span class="keywordflow">return</span> -1;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00812"></a><a class="code" href="file_8h.html#e87a1a55e2031e34919c906b497a554c">00812</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#e87a1a55e2031e34919c906b497a554c">ast_readfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *comment, <span class="keywordtype">int</span> <a class="code" href="structast__filestream.html#4e5868d676cb634aa75b125a0f741abf">flags</a>, <span class="keywordtype">int</span> check, mode_t <a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a>)
<a name="l00813"></a>00813 {
<a name="l00814"></a>00814    FILE *bfile;
<a name="l00815"></a>00815    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00816"></a>00816    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs = NULL;
<a name="l00817"></a>00817    <span class="keywordtype">char</span> *fn;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;formats);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;formats, f, list) {
<a name="l00822"></a>00822       fs = NULL;
<a name="l00823"></a>00823       <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#46aa3799ad5f3db1475d2aa5ae38ce66">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>, type))
<a name="l00824"></a>00824          <span class="keywordflow">continue</span>;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       fn = <a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">build_filename</a>(filename, type);
<a name="l00827"></a>00827       errno = 0;
<a name="l00828"></a>00828       bfile = fopen(fn, <span class="stringliteral">"r"</span>);
<a name="l00829"></a>00829       <span class="keywordflow">if</span> (!bfile || (fs = <a class="code" href="file_8c.html#8b2a601d4c35ad931eb1d5031961d8d7">get_filestream</a>(f, bfile)) == NULL ||
<a name="l00830"></a>00830           <a class="code" href="file_8c.html#9349c61165431c507acc86e1f40d8382">open_wrapper</a>(fs) ) {
<a name="l00831"></a>00831          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open %s\n"</span>, fn);
<a name="l00832"></a>00832          <span class="keywordflow">if</span> (fs)
<a name="l00833"></a>00833             <a class="code" href="utils_8h.html#801d8022c2922d0d4f73ba9e72c93865">ast_free</a>(fs);
<a name="l00834"></a>00834          <span class="keywordflow">if</span> (bfile)
<a name="l00835"></a>00835             fclose(bfile);
<a name="l00836"></a>00836          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00837"></a>00837          <span class="keywordflow">continue</span>;
<a name="l00838"></a>00838       }
<a name="l00839"></a>00839       <span class="comment">/* found it */</span>
<a name="l00840"></a>00840       fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a> = NULL;
<a name="l00841"></a>00841       fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a> = f;
<a name="l00842"></a>00842       fs-&gt;<a class="code" href="structast__filestream.html#4e5868d676cb634aa75b125a0f741abf">flags</a> = flags;
<a name="l00843"></a>00843       fs-&gt;<a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a> = mode;
<a name="l00844"></a>00844       fs-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(filename);
<a name="l00845"></a>00845       fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a> = NULL;
<a name="l00846"></a>00846       <span class="keywordflow">break</span>;
<a name="l00847"></a>00847    }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00850"></a>00850    <span class="keywordflow">if</span> (!fs) 
<a name="l00851"></a>00851       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No such format '%s'\n"</span>, type);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853    <span class="keywordflow">return</span> fs;
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a><a class="code" href="file_8h.html#863a5fc977919f88d566c68efc408f7a">00856</a> <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *comment, <span class="keywordtype">int</span> <a class="code" href="structast__filestream.html#4e5868d676cb634aa75b125a0f741abf">flags</a>, <span class="keywordtype">int</span> check, mode_t <a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a>)
<a name="l00857"></a>00857 {
<a name="l00858"></a>00858    <span class="keywordtype">int</span> fd, myflags = 0;
<a name="l00859"></a>00859    <span class="comment">/* compiler claims this variable can be used before initialization... */</span>
<a name="l00860"></a>00860    FILE *bfile = NULL;
<a name="l00861"></a>00861    <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00862"></a>00862    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs = NULL;
<a name="l00863"></a>00863    <span class="keywordtype">char</span> *buf = NULL;
<a name="l00864"></a>00864    size_t size = 0;
<a name="l00865"></a>00865    <span class="keywordtype">int</span> format_found = 0;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;formats);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    <span class="comment">/* set the O_TRUNC flag if and only if there is no O_APPEND specified */</span>
<a name="l00870"></a>00870    <span class="comment">/* We really can't use O_APPEND as it will break WAV header updates */</span>
<a name="l00871"></a>00871    <span class="keywordflow">if</span> (flags &amp; O_APPEND) { 
<a name="l00872"></a>00872       flags &amp;= ~O_APPEND;
<a name="l00873"></a>00873    } <span class="keywordflow">else</span> {
<a name="l00874"></a>00874       myflags = O_TRUNC;
<a name="l00875"></a>00875    }
<a name="l00876"></a>00876    
<a name="l00877"></a>00877    myflags |= O_WRONLY | O_CREAT;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879    <span class="comment">/* XXX need to fix this - we should just do the fopen,</span>
<a name="l00880"></a>00880 <span class="comment">    * not open followed by fdopen()</span>
<a name="l00881"></a>00881 <span class="comment">    */</span>
<a name="l00882"></a>00882    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;formats, f, list) {
<a name="l00883"></a>00883       <span class="keywordtype">char</span> *fn, *orig_fn = NULL;
<a name="l00884"></a>00884       <span class="keywordflow">if</span> (fs)
<a name="l00885"></a>00885          <span class="keywordflow">break</span>;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887       <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#46aa3799ad5f3db1475d2aa5ae38ce66">exts_compare</a>(f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>, type))
<a name="l00888"></a>00888          <span class="keywordflow">continue</span>;
<a name="l00889"></a>00889       <span class="keywordflow">else</span>
<a name="l00890"></a>00890          format_found = 1;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892       fn = <a class="code" href="file_8c.html#93f2088ee46454d79eb83cf4c12d4439">build_filename</a>(filename, type);
<a name="l00893"></a>00893       fd = open(fn, flags | myflags, mode);
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l00895"></a>00895          <span class="comment">/* fdopen() the resulting file stream */</span>
<a name="l00896"></a>00896          bfile = fdopen(fd, ((flags | myflags) &amp; O_RDWR) ? <span class="stringliteral">"w+"</span> : <span class="stringliteral">"w"</span>);
<a name="l00897"></a>00897          <span class="keywordflow">if</span> (!bfile) {
<a name="l00898"></a>00898             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, fdopen failed: %s!\n"</span>, strerror(errno));
<a name="l00899"></a>00899             close(fd);
<a name="l00900"></a>00900             fd = -1;
<a name="l00901"></a>00901          }
<a name="l00902"></a>00902       }
<a name="l00903"></a>00903       
<a name="l00904"></a>00904       <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#1bfe8932f2a0e6ade384658f854f3a4a">ast_opt_cache_record_files</a> &amp;&amp; (fd &gt; -1)) {
<a name="l00905"></a>00905          <span class="keywordtype">char</span> *c;
<a name="l00906"></a>00906 
<a name="l00907"></a>00907          fclose(bfile); <span class="comment">/* this also closes fd */</span>
<a name="l00908"></a>00908          <span class="comment">/*</span>
<a name="l00909"></a>00909 <span class="comment">           We touch orig_fn just as a place-holder so other things (like vmail) see the file is there.</span>
<a name="l00910"></a>00910 <span class="comment">           What we are really doing is writing to record_cache_dir until we are done then we will mv the file into place.</span>
<a name="l00911"></a>00911 <span class="comment">         */</span>
<a name="l00912"></a>00912          orig_fn = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(fn);
<a name="l00913"></a>00913          <span class="keywordflow">for</span> (c = fn; *c; c++)
<a name="l00914"></a>00914             <span class="keywordflow">if</span> (*c == <span class="charliteral">'/'</span>)
<a name="l00915"></a>00915                *c = <span class="charliteral">'_'</span>;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917          size = strlen(fn) + strlen(<a class="code" href="asterisk_8c.html#6f132d1e4d85b029047386a70c024396">record_cache_dir</a>) + 2;
<a name="l00918"></a>00918          buf = alloca(size);
<a name="l00919"></a>00919          strcpy(buf, <a class="code" href="asterisk_8c.html#6f132d1e4d85b029047386a70c024396">record_cache_dir</a>);
<a name="l00920"></a>00920          strcat(buf, <span class="stringliteral">"/"</span>);
<a name="l00921"></a>00921          strcat(buf, fn);
<a name="l00922"></a>00922          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00923"></a>00923          fn = buf;
<a name="l00924"></a>00924          fd = open(fn, flags | myflags, mode);
<a name="l00925"></a>00925          <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l00926"></a>00926             <span class="comment">/* fdopen() the resulting file stream */</span>
<a name="l00927"></a>00927             bfile = fdopen(fd, ((flags | myflags) &amp; O_RDWR) ? <span class="stringliteral">"w+"</span> : <span class="stringliteral">"w"</span>);
<a name="l00928"></a>00928             <span class="keywordflow">if</span> (!bfile) {
<a name="l00929"></a>00929                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, fdopen failed: %s!\n"</span>, strerror(errno));
<a name="l00930"></a>00930                close(fd);
<a name="l00931"></a>00931                fd = -1;
<a name="l00932"></a>00932             }
<a name="l00933"></a>00933          }
<a name="l00934"></a>00934       }
<a name="l00935"></a>00935       <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l00936"></a>00936          errno = 0;
<a name="l00937"></a>00937          fs = <a class="code" href="file_8c.html#8b2a601d4c35ad931eb1d5031961d8d7">get_filestream</a>(f, bfile);
<a name="l00938"></a>00938          <span class="keywordflow">if</span> (!fs || <a class="code" href="file_8c.html#5e0e182ed798d78b5951ffb839569c80">rewrite_wrapper</a>(fs, comment)) {
<a name="l00939"></a>00939             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to rewrite %s\n"</span>, fn);
<a name="l00940"></a>00940             close(fd);
<a name="l00941"></a>00941             <span class="keywordflow">if</span> (orig_fn) {
<a name="l00942"></a>00942                unlink(fn);
<a name="l00943"></a>00943                unlink(orig_fn);
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945             <span class="keywordflow">if</span> (fs)
<a name="l00946"></a>00946                <a class="code" href="utils_8h.html#801d8022c2922d0d4f73ba9e72c93865">ast_free</a>(fs);
<a name="l00947"></a>00947          }
<a name="l00948"></a>00948          fs-&gt;<a class="code" href="structast__filestream.html#4738019ef434f24099319565cd5185e5">trans</a> = NULL;
<a name="l00949"></a>00949          fs-&gt;<a class="code" href="structast__filestream.html#7631454338ff70b1a6b1262f5f36beac">fmt</a> = f;
<a name="l00950"></a>00950          fs-&gt;<a class="code" href="structast__filestream.html#4e5868d676cb634aa75b125a0f741abf">flags</a> = flags;
<a name="l00951"></a>00951          fs-&gt;<a class="code" href="structast__filestream.html#15d61712450a686a7f365adf4fef581f">mode</a> = mode;
<a name="l00952"></a>00952          <span class="keywordflow">if</span> (orig_fn) {
<a name="l00953"></a>00953             fs-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(orig_fn);
<a name="l00954"></a>00954             fs-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(fn);
<a name="l00955"></a>00955          } <span class="keywordflow">else</span> {
<a name="l00956"></a>00956             fs-&gt;<a class="code" href="structast__filestream.html#6964b5d4fdb02bab8cefc323bda1b18c">realfilename</a> = NULL;
<a name="l00957"></a>00957             fs-&gt;<a class="code" href="structast__filestream.html#435ed7e9f07f740abf511a62c00eef6e">filename</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(filename);
<a name="l00958"></a>00958          }
<a name="l00959"></a>00959          fs-&gt;<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a> = NULL;
<a name="l00960"></a>00960          <span class="comment">/* If truncated, we'll be at the beginning; if not truncated, then append */</span>
<a name="l00961"></a>00961          f-&gt;<a class="code" href="structast__format.html#1ecca7b8374382e647398ed939b6ab8d">seek</a>(fs, 0, SEEK_END);
<a name="l00962"></a>00962       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l00963"></a>00963          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open file %s: %s\n"</span>, fn, strerror(errno));
<a name="l00964"></a>00964          <span class="keywordflow">if</span> (orig_fn)
<a name="l00965"></a>00965             unlink(orig_fn);
<a name="l00966"></a>00966       }
<a name="l00967"></a>00967       <span class="comment">/* if buf != NULL then fn is already free and pointing to it */</span>
<a name="l00968"></a>00968       <span class="keywordflow">if</span> (!buf)
<a name="l00969"></a>00969          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fn);
<a name="l00970"></a>00970    }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974    <span class="keywordflow">if</span> (!format_found)
<a name="l00975"></a>00975       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No such format '%s'\n"</span>, type);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977    <span class="keywordflow">return</span> fs;
<a name="l00978"></a>00978 }
<a name="l00979"></a>00979 <span class="comment"></span>
<a name="l00980"></a>00980 <span class="comment">/*!</span>
<a name="l00981"></a>00981 <span class="comment"> * \brief the core of all waitstream() functions</span>
<a name="l00982"></a>00982 <span class="comment"> */</span>
<a name="l00983"></a><a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">00983</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">waitstream_core</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon,
<a name="l00984"></a>00984    <span class="keyword">const</span> <span class="keywordtype">char</span> *forward, <span class="keyword">const</span> <span class="keywordtype">char</span> *rewind, <span class="keywordtype">int</span> skip_ms,
<a name="l00985"></a>00985    <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> cmdfd,  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987    <span class="keywordflow">if</span> (!breakon)
<a name="l00988"></a>00988       breakon = <span class="stringliteral">""</span>;
<a name="l00989"></a>00989    <span class="keywordflow">if</span> (!forward)
<a name="l00990"></a>00990       forward = <span class="stringliteral">""</span>;
<a name="l00991"></a>00991    <span class="keywordflow">if</span> (!rewind)
<a name="l00992"></a>00992       rewind = <span class="stringliteral">""</span>;
<a name="l00993"></a>00993    
<a name="l00994"></a>00994    <span class="keywordflow">while</span> (c-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>) {
<a name="l00995"></a>00995       <span class="keywordtype">int</span> res;
<a name="l00996"></a>00996       <span class="keywordtype">int</span> ms = <a class="code" href="sched_8c.html#be772a122828e81602f21038162f6dff">ast_sched_wait</a>(c-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>);
<a name="l00997"></a>00997       <span class="keywordflow">if</span> (ms &lt; 0 &amp;&amp; !c-&gt;timingfunc) {
<a name="l00998"></a>00998          <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(c);
<a name="l00999"></a>00999          <span class="keywordflow">break</span>;
<a name="l01000"></a>01000       }
<a name="l01001"></a>01001       <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l01002"></a>01002          ms = 1000;
<a name="l01003"></a>01003       <span class="keywordflow">if</span> (cmdfd &lt; 0) {
<a name="l01004"></a>01004          res = <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(c, ms);
<a name="l01005"></a>01005          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01006"></a>01006             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Select failed (%s)\n"</span>, strerror(errno));
<a name="l01007"></a>01007             <span class="keywordflow">return</span> res;
<a name="l01008"></a>01008          }
<a name="l01009"></a>01009       } <span class="keywordflow">else</span> {
<a name="l01010"></a>01010          <span class="keywordtype">int</span> outfd;
<a name="l01011"></a>01011          <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *rchan = <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(&amp;c, 1, &amp;cmdfd, (cmdfd &gt; -1) ? 1 : 0, NULL, &amp;outfd, &amp;ms);
<a name="l01012"></a>01012          <span class="keywordflow">if</span> (!rchan &amp;&amp; (outfd &lt; 0) &amp;&amp; (ms)) {
<a name="l01013"></a>01013             <span class="comment">/* Continue */</span>
<a name="l01014"></a>01014             <span class="keywordflow">if</span> (errno == EINTR)
<a name="l01015"></a>01015                <span class="keywordflow">continue</span>;
<a name="l01016"></a>01016             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Wait failed (%s)\n"</span>, strerror(errno));
<a name="l01017"></a>01017             <span class="keywordflow">return</span> -1;
<a name="l01018"></a>01018          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) { <span class="comment">/* this requires cmdfd set */</span>
<a name="l01019"></a>01019             <span class="comment">/* The FD we were watching has something waiting */</span>
<a name="l01020"></a>01020             <span class="keywordflow">return</span> 1;
<a name="l01021"></a>01021          }
<a name="l01022"></a>01022          <span class="comment">/* if rchan is set, it is 'c' */</span>
<a name="l01023"></a>01023          res = rchan ? 1 : 0; <span class="comment">/* map into 'res' values */</span>
<a name="l01024"></a>01024       }
<a name="l01025"></a>01025       <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l01026"></a>01026          <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *fr = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(c);
<a name="l01027"></a>01027          <span class="keywordflow">if</span> (!fr)
<a name="l01028"></a>01028             <span class="keywordflow">return</span> -1;
<a name="l01029"></a>01029          <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>) {
<a name="l01030"></a>01030          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>:
<a name="l01031"></a>01031             <span class="keywordflow">if</span> (context) {
<a name="l01032"></a>01032                <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>[2] = { fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, <span class="charliteral">'\0'</span> };
<a name="l01033"></a>01033                <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(c, context, exten, 1, c-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)) {
<a name="l01034"></a>01034                   res = fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l01035"></a>01035                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(fr);
<a name="l01036"></a>01036                   <span class="keywordflow">return</span> res;
<a name="l01037"></a>01037                }
<a name="l01038"></a>01038             } <span class="keywordflow">else</span> {
<a name="l01039"></a>01039                res = fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l01040"></a>01040                <span class="keywordflow">if</span> (strchr(forward,res)) {
<a name="l01041"></a>01041                   <a class="code" href="file_8c.html#a89ae22b0f4ddc671b516808ebfc0679">ast_stream_fastforward</a>(c-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>, skip_ms);
<a name="l01042"></a>01042                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(rewind,res)) {
<a name="l01043"></a>01043                   <a class="code" href="file_8c.html#3a2eb1ab87bc99265738281b25fc6999">ast_stream_rewind</a>(c-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>, skip_ms);
<a name="l01044"></a>01044                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(breakon, res)) {
<a name="l01045"></a>01045                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(fr);
<a name="l01046"></a>01046                   <span class="keywordflow">return</span> res;
<a name="l01047"></a>01047                }              
<a name="l01048"></a>01048             }
<a name="l01049"></a>01049             <span class="keywordflow">break</span>;
<a name="l01050"></a>01050          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>:
<a name="l01051"></a>01051             <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l01052"></a>01052             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>:
<a name="l01053"></a>01053             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l01054"></a>01054             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l01055"></a>01055                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(fr);
<a name="l01056"></a>01056                <span class="keywordflow">return</span> -1;
<a name="l01057"></a>01057             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l01058"></a>01058             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l01059"></a>01059             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>:
<a name="l01060"></a>01060             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>:
<a name="l01061"></a>01061             <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>:
<a name="l01062"></a>01062                <span class="comment">/* Unimportant */</span>
<a name="l01063"></a>01063                <span class="keywordflow">break</span>;
<a name="l01064"></a>01064             <span class="keywordflow">default</span>:
<a name="l01065"></a>01065                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unexpected control subclass '%d'\n"</span>, fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l01066"></a>01066             }
<a name="l01067"></a>01067             <span class="keywordflow">break</span>;
<a name="l01068"></a>01068          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>:
<a name="l01069"></a>01069             <span class="comment">/* Write audio if appropriate */</span>
<a name="l01070"></a>01070             <span class="keywordflow">if</span> (audiofd &gt; -1)
<a name="l01071"></a>01071                write(audiofd, fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l01072"></a>01072          <span class="keywordflow">default</span>:
<a name="l01073"></a>01073             <span class="comment">/* Ignore all others */</span>
<a name="l01074"></a>01074             <span class="keywordflow">break</span>;
<a name="l01075"></a>01075          }
<a name="l01076"></a>01076          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(fr);
<a name="l01077"></a>01077       }
<a name="l01078"></a>01078       <a class="code" href="sched_8c.html#2ea97d35de659fe307e6d5c6c4e11ffc">ast_sched_runq</a>(c-&gt;<a class="code" href="structast__channel.html#47721f99ae60cbec027428e52ad7ca39">sched</a>);
<a name="l01079"></a>01079    }
<a name="l01080"></a>01080    <span class="keywordflow">return</span> (c-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> ? -1 : 0);
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a><a class="code" href="file_8h.html#0db2bacb7cd7648486a6eb2b679d64db">01083</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#0db2bacb7cd7648486a6eb2b679d64db">ast_waitstream_fr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon, <span class="keyword">const</span> <span class="keywordtype">char</span> *forward, <span class="keyword">const</span> <span class="keywordtype">char</span> *rewind, <span class="keywordtype">int</span> ms)
<a name="l01084"></a>01084 {
<a name="l01085"></a>01085    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">waitstream_core</a>(c, breakon, forward, rewind, ms,
<a name="l01086"></a>01086       -1 <span class="comment">/* no audiofd */</span>, -1 <span class="comment">/* no cmdfd */</span>, NULL <span class="comment">/* no context */</span>);
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a><a class="code" href="file_8h.html#634a25400a6a724d278b9129b9b5181b">01089</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon)
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">waitstream_core</a>(c, breakon, NULL, NULL, 0, -1, -1, NULL);
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a><a class="code" href="file_8h.html#48738f94ec3e73352f212b993090910b">01094</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#7be3107f4ff5bc2975b1f52fa552cb6a">ast_waitstream_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *breakon, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> cmdfd)
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">waitstream_core</a>(c, breakon, NULL, NULL, 0,
<a name="l01097"></a>01097       audiofd, cmdfd, NULL <span class="comment">/* no context */</span>);
<a name="l01098"></a>01098 }
<a name="l01099"></a>01099 
<a name="l01100"></a><a class="code" href="file_8h.html#24c25c9a9f196587f0ad5f466c059d22">01100</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#24c25c9a9f196587f0ad5f466c059d22">ast_waitstream_exten</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l01101"></a>01101 {
<a name="l01102"></a>01102    <span class="comment">/* Waitstream, with return in the case of a valid 1 digit extension */</span>
<a name="l01103"></a>01103    <span class="comment">/* in the current or specified context being pressed */</span>
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <span class="keywordflow">if</span> (!context)
<a name="l01106"></a>01106       context = c-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l01107"></a>01107    <span class="keywordflow">return</span> <a class="code" href="file_8c.html#b3bff587a0c584b73ef7131678e97f3e">waitstream_core</a>(c, NULL, NULL, NULL, 0,
<a name="l01108"></a>01108       -1, -1, context);
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment">/*</span>
<a name="l01112"></a>01112 <span class="comment"> * if the file name is non-empty, try to play it.</span>
<a name="l01113"></a>01113 <span class="comment"> * Return 0 if success, -1 if error, digit if interrupted by a digit.</span>
<a name="l01114"></a>01114 <span class="comment"> * If digits == "" then we can simply check for non-zero.</span>
<a name="l01115"></a>01115 <span class="comment"> */</span>
<a name="l01116"></a><a class="code" href="file_8h.html#65052c94377323821185d04e2600dda2">01116</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118         <span class="keywordtype">int</span> res = 0;
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(file)) {
<a name="l01120"></a>01120                 res = <a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(chan, file, chan-&gt;language);
<a name="l01121"></a>01121                 <span class="keywordflow">if</span> (!res)
<a name="l01122"></a>01122                         res = <a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(chan, digits);
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124         <span class="keywordflow">return</span> res;
<a name="l01125"></a>01125 } 
<a name="l01126"></a>01126 
<a name="l01127"></a><a class="code" href="file_8c.html#420f7ae46f94a2702a19f6457d9f7a0c">01127</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#420f7ae46f94a2702a19f6457d9f7a0c">show_file_formats</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01128"></a>01128 {
<a name="l01129"></a>01129 <span class="preprocessor">#define FORMAT "%-10s %-10s %-20s\n"</span>
<a name="l01130"></a>01130 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT2 "%-10s %-10s %-20s\n"</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structast__format.html">ast_format</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01132"></a>01132    <span class="keywordtype">int</span> count_fmt = 0;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134    <span class="keywordflow">if</span> (argc != 4)
<a name="l01135"></a>01135       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01136"></a>01136    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <a class="code" href="asterisk_8c.html#47c8929b6152d540597c758853ff95a2">FORMAT</a>, <span class="stringliteral">"Format"</span>, <span class="stringliteral">"Name"</span>, <span class="stringliteral">"Extensions"</span>);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    <a class="code" href="linkedlists_8h.html#23c0c844e5abcb474854867b408e3be8">AST_RWLIST_RDLOCK</a>(&amp;formats);
<a name="l01139"></a>01139    <a class="code" href="linkedlists_8h.html#36b8c64a6c62cb77baa726f81dcaa7f5">AST_RWLIST_TRAVERSE</a>(&amp;formats, f, list) {
<a name="l01140"></a>01140       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <a class="code" href="file_8c.html#9f9a76227ff528a1b555461941353903">FORMAT2</a>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__format.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>), f-&gt;<a class="code" href="structast__format.html#23d5c5772e05e09c87f6323a95732f89">name</a>, f-&gt;<a class="code" href="structast__format.html#6d9c71cd7b5d178eff3ceaba74c32897">exts</a>);
<a name="l01141"></a>01141       count_fmt++;
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143    <a class="code" href="linkedlists_8h.html#470215c8af4ffcdb09701e5d092a9205">AST_RWLIST_UNLOCK</a>(&amp;formats);
<a name="l01144"></a>01144    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%d file formats registered.\n"</span>, count_fmt);
<a name="l01145"></a>01145    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01146"></a>01146 <span class="preprocessor">#undef FORMAT</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>}
<a name="l01149"></a>01149 
<a name="l01150"></a><a class="code" href="file_8c.html#2c8dd47395f95f21aa47cd0dde65c3e6">01150</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="file_8c.html#2c8dd47395f95f21aa47cd0dde65c3e6">show_file_formats_usage</a>[] = 
<a name="l01151"></a>01151 <span class="stringliteral">"Usage: core show file formats\n"</span>
<a name="l01152"></a>01152 <span class="stringliteral">"       Displays currently registered file formats (if any)\n"</span>;
<a name="l01153"></a>01153 
<a name="l01154"></a><a class="code" href="file_8c.html#188b0beae77a44ae432b57872262344c">01154</a> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_file[] = {
<a name="l01155"></a>01155    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"file"</span>, <span class="stringliteral">"formats"</span> },
<a name="l01156"></a>01156    <a class="code" href="file_8c.html#420f7ae46f94a2702a19f6457d9f7a0c">show_file_formats</a>, <span class="stringliteral">"Displays file formats"</span>,
<a name="l01157"></a>01157    show_file_formats_usage },
<a name="l01158"></a>01158 };
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="file_8h.html#c9bd705c9a99609486cdfdd5208f0a44">01160</a> <span class="keywordtype">int</span> <a class="code" href="file_8c.html#c9bd705c9a99609486cdfdd5208f0a44">ast_file_init</a>(<span class="keywordtype">void</span>)
<a name="l01161"></a>01161 {
<a name="l01162"></a>01162    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_file, <span class="keyword">sizeof</span>(cli_file) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l01163"></a>01163    <span class="keywordflow">return</span> 0;
<a name="l01164"></a>01164 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:41 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
