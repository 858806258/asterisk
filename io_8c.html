<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:33 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>io.c File Reference</h1>I/O Managment (Derived from Cheops-NG). <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="asterisk_8h-source.html">asterisk.h</a>&quot;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;termios.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;sys/ioctl.h&gt;</code><br>
<code>#include &quot;<a class="el" href="io_8h-source.html">asterisk/io.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="logger_8h-source.html">asterisk/logger.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="utils_8h-source.html">asterisk/utils.h</a>&quot;</code><br>

<p>
<a href="io_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structio__context.html">io_context</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Global IO variables are now in a struct in order to be made threadsafe.  <a href="structio__context.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structio__rec.html">io_rec</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Kept for each file descriptor.  <a href="structio__rec.html#_details">More...</a><br></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a>&nbsp;&nbsp;&nbsp;512</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#1198f9501b491238bd84448a26104709">ast_get_termcols</a> (int fd)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#33574cdad99b0229dcb40525d6eea099">ast_hide_password</a> (int fd)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#bcc2162f968028c194455edd0c81a634">ast_io_add</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc, int fd, <a class="el" href="io_8h.html#01c73433efded83cc683aa3750752944">ast_io_cb</a> callback, short <a class="el" href="app__adsiprog_8c.html#ebe1e144a9578658fd9fdb079685b55d">events</a>, void *data)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add a new I/O entry for this file descriptor with the given event mask, to call callback with data as an argument.  <a href="#bcc2162f968028c194455edd0c81a634"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#923ce944d727e77b8ecd8c997c107f87">ast_io_change</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc, int *<a class="el" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>, int fd, <a class="el" href="io_8h.html#01c73433efded83cc683aa3750752944">ast_io_cb</a> callback, short <a class="el" href="app__adsiprog_8c.html#ebe1e144a9578658fd9fdb079685b55d">events</a>, void *data)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#b04e1ef02ac4b9c48b448706388357c6">ast_io_dump</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#43bd3faf9111cfebe0bd72a86f395693">ast_io_remove</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc, int *_id)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#94283ec0d3789e5c7dacc2165852a558">ast_io_wait</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc, int howlong)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Make the poll call, and call the callbacks for anything that needs to be handled.  <a href="#94283ec0d3789e5c7dacc2165852a558"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#dc6ceac64e1d01d35e2047ea14db636a">ast_restore_tty</a> (int fd, int oldstate)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structio__context.html">io_context</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#b4866f7713f64d3072b61b0cd28a5691">io_context_create</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create an I/O context.  <a href="#b4866f7713f64d3072b61b0cd28a5691"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#7fd8c331e4c20a143a221fcb9ff57aeb">io_context_destroy</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#a6179f6c0a1cddf5b00ef463b9824575">io_grow</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Grow the size of our arrays.  <a href="#a6179f6c0a1cddf5b00ef463b9824575"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="io_8c.html#bdbcfabdcd0be940bf1c6e60a72c5528">io_shrink</a> (struct <a class="el" href="structio__context.html">io_context</a> *ioc)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
I/O Managment (Derived from Cheops-NG). 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt; </dd></dl>

<p>
Definition in file <a class="el" href="io_8c-source.html">io.c</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="5ca9902d44b6807e17916b56a97dc3cf"></a><!-- doxytag: member="io.c::DEBUG" ref="5ca9902d44b6807e17916b56a97dc3cf" args="(a)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define DEBUG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00044">44</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
Referenced by <a class="el" href="io_8c-source.html#l00158">ast_io_add()</a>, <a class="el" href="io_8c-source.html#l00274">ast_io_wait()</a>, <a class="el" href="sched_8c-source.html#l00215">ast_sched_add_variable()</a>, <a class="el" href="sched_8c-source.html#l00259">ast_sched_del()</a>, <a class="el" href="sched_8c-source.html#l00329">ast_sched_runq()</a>, <a class="el" href="sched_8c-source.html#l00148">ast_sched_wait()</a>, <a class="el" href="sched_8c-source.html#l00386">ast_sched_when()</a>, and <a class="el" href="io_8c-source.html#l00118">io_grow()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="b962fab07d2047fa27ba970b6811fe02"></a><!-- doxytag: member="io.c::GROW_SHRINK_SIZE" ref="b962fab07d2047fa27ba970b6811fe02" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define GROW_SHRINK_SIZE&nbsp;&nbsp;&nbsp;512          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00063">63</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
Referenced by <a class="el" href="io_8c-source.html#l00077">io_context_create()</a>, and <a class="el" href="io_8c-source.html#l00118">io_grow()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="1198f9501b491238bd84448a26104709"></a><!-- doxytag: member="io.c::ast_get_termcols" ref="1198f9501b491238bd84448a26104709" args="(int fd)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_get_termcols           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00368">368</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
Referenced by <a class="el" href="asterisk_8c-source.html#l02006">ast_cli_display_match_list()</a>.<div class="fragment"><pre class="fragment"><a name="l00369"></a>00369 {
<a name="l00370"></a>00370    <span class="keyword">struct </span>winsize win;
<a name="l00371"></a>00371    <span class="keywordtype">int</span> cols = 0;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (!isatty(fd))
<a name="l00374"></a>00374       <span class="keywordflow">return</span> -1;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    <span class="keywordflow">if</span> ( ioctl(fd, TIOCGWINSZ, &amp;win) != -1 ) {
<a name="l00377"></a>00377       <span class="keywordflow">if</span> ( !cols &amp;&amp; win.ws_col &gt; 0 )
<a name="l00378"></a>00378          cols = (int) win.ws_col;
<a name="l00379"></a>00379    } <span class="keywordflow">else</span> {
<a name="l00380"></a>00380       <span class="comment">/* assume 80 characters if the ioctl fails for some reason */</span>
<a name="l00381"></a>00381       cols = 80;
<a name="l00382"></a>00382    }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <span class="keywordflow">return</span> cols;
<a name="l00385"></a>00385 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="33574cdad99b0229dcb40525d6eea099"></a><!-- doxytag: member="io.c::ast_hide_password" ref="33574cdad99b0229dcb40525d6eea099" args="(int fd)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_hide_password           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Set fd into non-echoing mode (if fd is a tty) 
<p>
Definition at line <a class="el" href="io_8c-source.html#l00332">332</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="ast__expr2f_8c-source.html#l01553">ECHO</a>.
<p>
Referenced by <a class="el" href="res__crypto_8c-source.html#l00115">pw_cb()</a>.<div class="fragment"><pre class="fragment"><a name="l00333"></a>00333 {
<a name="l00334"></a>00334    <span class="keyword">struct </span>termios tios;
<a name="l00335"></a>00335    <span class="keywordtype">int</span> res;
<a name="l00336"></a>00336    <span class="keywordtype">int</span> old;
<a name="l00337"></a>00337    <span class="keywordflow">if</span> (!isatty(fd))
<a name="l00338"></a>00338       <span class="keywordflow">return</span> -1;
<a name="l00339"></a>00339    res = tcgetattr(fd, &amp;tios);
<a name="l00340"></a>00340    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00341"></a>00341       <span class="keywordflow">return</span> -1;
<a name="l00342"></a>00342    old = tios.c_lflag &amp; (<a class="code" href="ast__expr2f_8c.html#d61484f1331c7f66061e43b859556409">ECHO</a> | ECHONL);
<a name="l00343"></a>00343    tios.c_lflag &amp;= ~<a class="code" href="ast__expr2f_8c.html#d61484f1331c7f66061e43b859556409">ECHO</a>;
<a name="l00344"></a>00344    tios.c_lflag |= ECHONL;
<a name="l00345"></a>00345    res = tcsetattr(fd, TCSAFLUSH, &amp;tios);
<a name="l00346"></a>00346    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00347"></a>00347       <span class="keywordflow">return</span> -1;
<a name="l00348"></a>00348    <span class="keywordflow">return</span> old;
<a name="l00349"></a>00349 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="bcc2162f968028c194455edd0c81a634"></a><!-- doxytag: member="io.c::ast_io_add" ref="bcc2162f968028c194455edd0c81a634" args="(struct io_context *ioc, int fd, ast_io_cb callback, short events, void *data)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int* ast_io_add           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ioc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="io_8h.html#01c73433efded83cc683aa3750752944">ast_io_cb</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>short&nbsp;</td>
          <td class="mdname" nowrap> <em>events</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>void *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Add a new I/O entry for this file descriptor with the given event mask, to call callback with data as an argument. 
<p>
<dl compact><dt><b>Returns:</b></dt><dd>Returns NULL on failure. </dd></dl>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00158">158</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h-source.html#l00359">ast_malloc</a>, <a class="el" href="io_8c-source.html#l00051">io_rec::callback</a>, <a class="el" href="io_8c-source.html#l00052">io_rec::data</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="poll-compat_8h-source.html#l00092">pollfd::events</a>, <a class="el" href="poll-compat_8h-source.html#l00091">pollfd::fd</a>, <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="io_8c-source.html#l00053">io_rec::id</a>, <a class="el" href="io_8c-source.html#l00118">io_grow()</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="io_8c-source.html#l00071">io_context::maxfdcnt</a>, and <a class="el" href="poll-compat_8h-source.html#l00093">pollfd::revents</a>.
<p>
Referenced by <a class="el" href="netsock_8c-source.html#l00122">ast_netsock_bindaddr()</a>, <a class="el" href="rtp_8c-source.html#l01966">ast_rtp_new_with_bindaddr()</a>, <a class="el" href="udptl_8c-source.html#l00792">ast_udptl_new_with_bindaddr()</a>, <a class="el" href="chan__mgcp_8c-source.html#l03422">do_monitor()</a>, <a class="el" href="chan__iax2_8c-source.html#l08386">network_thread()</a>, and <a class="el" href="rtp_8c-source.html#l03161">p2p_callback_disable()</a>.<div class="fragment"><pre class="fragment"><a name="l00159"></a>00159 {
<a name="l00160"></a>00160    <span class="keywordtype">int</span> *ret;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_io_add()\n"</span>));
<a name="l00163"></a>00163 
<a name="l00164"></a>00164    <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a> &gt;= ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a>) {
<a name="l00165"></a>00165       <span class="comment">/* </span>
<a name="l00166"></a>00166 <span class="comment">       * We don't have enough space for this entry.  We need to</span>
<a name="l00167"></a>00167 <span class="comment">       * reallocate maxfdcnt poll fd's and io_rec's, or back out now.</span>
<a name="l00168"></a>00168 <span class="comment">       */</span>
<a name="l00169"></a>00169       <span class="keywordflow">if</span> (<a class="code" href="io_8c.html#a6179f6c0a1cddf5b00ef463b9824575">io_grow</a>(ioc))
<a name="l00170"></a>00170          <span class="keywordflow">return</span> NULL;
<a name="l00171"></a>00171    }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173    <span class="comment">/*</span>
<a name="l00174"></a>00174 <span class="comment">    * At this point, we've got sufficiently large arrays going</span>
<a name="l00175"></a>00175 <span class="comment">    * and we can make an entry for it in the pollfd and io_r</span>
<a name="l00176"></a>00176 <span class="comment">    * structures.</span>
<a name="l00177"></a>00177 <span class="comment">    */</span>
<a name="l00178"></a>00178    ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a> = fd;
<a name="l00179"></a>00179    ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a> = <a class="code" href="chan__zap_8c.html#ebe1e144a9578658fd9fdb079685b55d">events</a>;
<a name="l00180"></a>00180    ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structpollfd.html#7c6f5b9f008b99872b2aff44748410c8">revents</a> = 0;
<a name="l00181"></a>00181    ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structio__rec.html#924a8ceeac17f54d3be3f8cdf1c04eb2">callback</a> = callback;
<a name="l00182"></a>00182    ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structio__rec.html#8d777f385d3dfec8815d20f7496026dc">data</a> = data;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184    <span class="keywordflow">if</span> (!(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].id = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].id)))) {
<a name="l00185"></a>00185       <span class="comment">/* Bonk if we couldn't allocate an int */</span>
<a name="l00186"></a>00186       <span class="keywordflow">return</span> NULL;
<a name="l00187"></a>00187    }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189    *(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>) = ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>;
<a name="l00190"></a>00190    ret = ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>].id;
<a name="l00191"></a>00191    ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>++;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193    <span class="keywordflow">return</span> ret;
<a name="l00194"></a>00194 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="923ce944d727e77b8ecd8c997c107f87"></a><!-- doxytag: member="io.c::ast_io_change" ref="923ce944d727e77b8ecd8c997c107f87" args="(struct io_context *ioc, int *id, int fd, ast_io_cb callback, short events, void *data)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int* ast_io_change           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ioc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>id</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="io_8h.html#01c73433efded83cc683aa3750752944">ast_io_cb</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>callback</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>short&nbsp;</td>
          <td class="mdname" nowrap> <em>events</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>void *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ioc</em>&nbsp;</td><td>which context to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>id</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fd</em>&nbsp;</td><td>the fd you wish it to contain now </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>callback</em>&nbsp;</td><td>new callback function </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>events</em>&nbsp;</td><td>event mask to wait for </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>data to pass to the callback function Change an i/o handler, updating fd if &gt; -1, callback if non-null, and revents if &gt;-1, and data if non-null. Returns a pointero to the ID of the IO event, or NULL on failure. </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00196">196</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="io_8c-source.html#l00051">io_rec::callback</a>, <a class="el" href="io_8c-source.html#l00052">io_rec::data</a>, <a class="el" href="poll-compat_8h-source.html#l00092">pollfd::events</a>, <a class="el" href="poll-compat_8h-source.html#l00091">pollfd::fd</a>, <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, and <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>.
<p>
Referenced by <a class="el" href="chan__sip_8c-source.html#l16035">do_monitor()</a>.<div class="fragment"><pre class="fragment"><a name="l00197"></a>00197 {
<a name="l00198"></a>00198    <span class="comment">/* If this id exceeds our file descriptor count it doesn't exist here */</span>
<a name="l00199"></a>00199    <span class="keywordflow">if</span> (*<span class="keywordtype">id</span> &gt; ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>)
<a name="l00200"></a>00200       <span class="keywordflow">return</span> NULL;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    <span class="keywordflow">if</span> (fd &gt; -1)
<a name="l00203"></a>00203       ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[*<a class="code" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>].<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a> = fd;
<a name="l00204"></a>00204    <span class="keywordflow">if</span> (callback)
<a name="l00205"></a>00205       ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[*<a class="code" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>].<a class="code" href="structio__rec.html#924a8ceeac17f54d3be3f8cdf1c04eb2">callback</a> = callback;
<a name="l00206"></a>00206    <span class="keywordflow">if</span> (<a class="code" href="chan__zap_8c.html#ebe1e144a9578658fd9fdb079685b55d">events</a>)
<a name="l00207"></a>00207       ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[*<a class="code" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>].<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a> = <a class="code" href="chan__zap_8c.html#ebe1e144a9578658fd9fdb079685b55d">events</a>;
<a name="l00208"></a>00208    <span class="keywordflow">if</span> (data)
<a name="l00209"></a>00209       ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[*<a class="code" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>].<a class="code" href="structio__rec.html#8d777f385d3dfec8815d20f7496026dc">data</a> = data;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211    <span class="keywordflow">return</span> <a class="code" href="app__queue_8c.html#b80bb7740288fda1f201890375a60c8f">id</a>;
<a name="l00212"></a>00212 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b04e1ef02ac4b9c48b448706388357c6"></a><!-- doxytag: member="io.c::ast_io_dump" ref="b04e1ef02ac4b9c48b448706388357c6" args="(struct io_context *ioc)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ast_io_dump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ioc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Dumps the IO array 
<p>
Definition at line <a class="el" href="io_8c-source.html#l00307">307</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="io_8c-source.html#l00051">io_rec::callback</a>, <a class="el" href="io_8c-source.html#l00052">io_rec::data</a>, <a class="el" href="poll-compat_8h-source.html#l00092">pollfd::events</a>, <a class="el" href="poll-compat_8h-source.html#l00091">pollfd::fd</a>, <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="io_8c-source.html#l00053">io_rec::id</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, and <a class="el" href="io_8c-source.html#l00071">io_context::maxfdcnt</a>.<div class="fragment"><pre class="fragment"><a name="l00308"></a>00308 {
<a name="l00309"></a>00309    <span class="comment">/*</span>
<a name="l00310"></a>00310 <span class="comment">    * Print some debugging information via</span>
<a name="l00311"></a>00311 <span class="comment">    * the logger interface</span>
<a name="l00312"></a>00312 <span class="comment">    */</span>
<a name="l00313"></a>00313    <span class="keywordtype">int</span> x;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Asterisk IO Dump: %d entries, %d max entries\n"</span>, ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>, ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a>);
<a name="l00316"></a>00316    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"================================================\n"</span>);
<a name="l00317"></a>00317    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"| ID    FD     Callback    Data        Events  |\n"</span>);
<a name="l00318"></a>00318    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"+------+------+-----------+-----------+--------+\n"</span>);
<a name="l00319"></a>00319    <span class="keywordflow">for</span> (x = 0; x &lt; ioc-&gt;fdcnt; x++) {
<a name="l00320"></a>00320       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"| %.4d | %.4d | %p | %p | %.6x |\n"</span>, 
<a name="l00321"></a>00321             *ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>,
<a name="l00322"></a>00322             ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a>,
<a name="l00323"></a>00323             ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#924a8ceeac17f54d3be3f8cdf1c04eb2">callback</a>,
<a name="l00324"></a>00324             ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#8d777f385d3dfec8815d20f7496026dc">data</a>,
<a name="l00325"></a>00325             ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a>);
<a name="l00326"></a>00326    }
<a name="l00327"></a>00327    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"================================================\n"</span>);
<a name="l00328"></a>00328 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="43bd3faf9111cfebe0bd72a86f395693"></a><!-- doxytag: member="io.c::ast_io_remove" ref="43bd3faf9111cfebe0bd72a86f395693" args="(struct io_context *ioc, int *_id)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_io_remove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ioc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int *&nbsp;</td>
          <td class="mdname" nowrap> <em>id</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ioc</em>&nbsp;</td><td>which <a class="el" href="structio__context.html">io_context</a> to remove it from </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>id</em>&nbsp;</td><td>which ID to remove Remove an I/O id from consideration Returns 0 on success or -1 on failure. </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00241">241</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="io_8c-source.html#l00072">io_context::current_ioc</a>, <a class="el" href="poll-compat_8h-source.html#l00092">pollfd::events</a>, <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="io_8c-source.html#l00053">io_rec::id</a>, <a class="el" href="io_8c-source.html#l00214">io_shrink()</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="io_8c-source.html#l00073">io_context::needshrink</a>, and <a class="el" href="poll-compat_8h-source.html#l00093">pollfd::revents</a>.
<p>
Referenced by <a class="el" href="io_8c-source.html#l00274">ast_io_wait()</a>, <a class="el" href="netsock_8c-source.html#l00079">ast_netsock_destroy()</a>, <a class="el" href="rtp_8c-source.html#l02176">ast_rtp_destroy()</a>, <a class="el" href="udptl_8c-source.html#l00905">ast_udptl_destroy()</a>, and <a class="el" href="rtp_8c-source.html#l03161">p2p_callback_disable()</a>.<div class="fragment"><pre class="fragment"><a name="l00242"></a>00242 {
<a name="l00243"></a>00243    <span class="keywordtype">int</span> x;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245    <span class="keywordflow">if</span> (!_id) {
<a name="l00246"></a>00246       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Asked to remove NULL?\n"</span>);
<a name="l00247"></a>00247       <span class="keywordflow">return</span> -1;
<a name="l00248"></a>00248    }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250    <span class="keywordflow">for</span> (x = 0; x &lt; ioc-&gt;fdcnt; x++) {
<a name="l00251"></a>00251       <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a> == _id) {
<a name="l00252"></a>00252          <span class="comment">/* Free the int immediately and set to NULL so we know it's unused now */</span>
<a name="l00253"></a>00253          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>);
<a name="l00254"></a>00254          ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a> = NULL;
<a name="l00255"></a>00255          ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a> = 0;
<a name="l00256"></a>00256          ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#7c6f5b9f008b99872b2aff44748410c8">revents</a> = 0;
<a name="l00257"></a>00257          ioc-&gt;<a class="code" href="structio__context.html#fc76dd7bedc2c65a178bdeafca05db37">needshrink</a> = 1;
<a name="l00258"></a>00258          <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#582fe94fd5e04b07cb9ed1bacad55257">current_ioc</a> == -1)
<a name="l00259"></a>00259             <a class="code" href="io_8c.html#bdbcfabdcd0be940bf1c6e60a72c5528">io_shrink</a>(ioc);
<a name="l00260"></a>00260          <span class="keywordflow">return</span> 0;
<a name="l00261"></a>00261       }
<a name="l00262"></a>00262    }
<a name="l00263"></a>00263    
<a name="l00264"></a>00264    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to remove unknown id %p\n"</span>, _id);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266    <span class="keywordflow">return</span> -1;
<a name="l00267"></a>00267 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="94283ec0d3789e5c7dacc2165852a558"></a><!-- doxytag: member="io.c::ast_io_wait" ref="94283ec0d3789e5c7dacc2165852a558" args="(struct io_context *ioc, int howlong)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_io_wait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ioc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>howlong</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Make the poll call, and call the callbacks for anything that needs to be handled. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ioc</em>&nbsp;</td><td>which context to act upon </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>howlong</em>&nbsp;</td><td>how many milliseconds to wait Wait for I/O to happen, returning after howlong milliseconds, and after processing any necessary I/O. Returns the number of I/O events which took place. </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00274">274</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="io_8c-source.html#l00241">ast_io_remove()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="io_8c-source.html#l00051">io_rec::callback</a>, <a class="el" href="io_8c-source.html#l00072">io_context::current_ioc</a>, <a class="el" href="io_8c-source.html#l00052">io_rec::data</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="poll-compat_8h-source.html#l00091">pollfd::fd</a>, <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="io_8c-source.html#l00053">io_rec::id</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="poll_8c-source.html#l00264">poll()</a>, and <a class="el" href="poll-compat_8h-source.html#l00093">pollfd::revents</a>.
<p>
Referenced by <a class="el" href="chan__sip_8c-source.html#l16035">do_monitor()</a>, <a class="el" href="chan__iax2_8c-source.html#l08386">network_thread()</a>, and <a class="el" href="chan__mgcp_8c-source.html#l04109">reload_config()</a>.<div class="fragment"><pre class="fragment"><a name="l00275"></a>00275 {
<a name="l00276"></a>00276    <span class="keywordtype">int</span> res, x, origcnt;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_io_wait()\n"</span>));
<a name="l00279"></a>00279 
<a name="l00280"></a>00280    <span class="keywordflow">if</span> ((res = <a class="code" href="poll_8c.html#490c34aebc91a7dfe2524a13104fd13e">poll</a>(ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>, ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>, howlong)) &lt;= 0)
<a name="l00281"></a>00281       <span class="keywordflow">return</span> res;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283    <span class="comment">/* At least one event tripped */</span>
<a name="l00284"></a>00284    origcnt = ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>;
<a name="l00285"></a>00285    <span class="keywordflow">for</span> (x = 0; x &lt; origcnt; x++) {
<a name="l00286"></a>00286       <span class="comment">/* Yes, it is possible for an entry to be deleted and still have an</span>
<a name="l00287"></a>00287 <span class="comment">         event waiting if it occurs after the original calling id */</span>
<a name="l00288"></a>00288       <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#7c6f5b9f008b99872b2aff44748410c8">revents</a> &amp;&amp; ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>) {
<a name="l00289"></a>00289          <span class="comment">/* There's an event waiting */</span>
<a name="l00290"></a>00290          ioc-&gt;<a class="code" href="structio__context.html#582fe94fd5e04b07cb9ed1bacad55257">current_ioc</a> = *ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>;
<a name="l00291"></a>00291          <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#924a8ceeac17f54d3be3f8cdf1c04eb2">callback</a>) {
<a name="l00292"></a>00292             <span class="keywordflow">if</span> (!ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#924a8ceeac17f54d3be3f8cdf1c04eb2">callback</a>(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>, ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a>, ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[x].<a class="code" href="structpollfd.html#7c6f5b9f008b99872b2aff44748410c8">revents</a>, ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#8d777f385d3dfec8815d20f7496026dc">data</a>)) {
<a name="l00293"></a>00293                <span class="comment">/* Time to delete them since they returned a 0 */</span>
<a name="l00294"></a>00294                <a class="code" href="io_8c.html#43bd3faf9111cfebe0bd72a86f395693">ast_io_remove</a>(ioc, ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[x].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>);
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296          }
<a name="l00297"></a>00297          ioc-&gt;<a class="code" href="structio__context.html#582fe94fd5e04b07cb9ed1bacad55257">current_ioc</a> = -1;
<a name="l00298"></a>00298       }
<a name="l00299"></a>00299    }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301    <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#fc76dd7bedc2c65a178bdeafca05db37">needshrink</a>)
<a name="l00302"></a>00302       <a class="code" href="io_8c.html#bdbcfabdcd0be940bf1c6e60a72c5528">io_shrink</a>(ioc);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304    <span class="keywordflow">return</span> res;
<a name="l00305"></a>00305 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="dc6ceac64e1d01d35e2047ea14db636a"></a><!-- doxytag: member="io.c::ast_restore_tty" ref="dc6ceac64e1d01d35e2047ea14db636a" args="(int fd, int oldstate)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_restore_tty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>oldstatus</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Restores TTY mode 
<p>
Definition at line <a class="el" href="io_8c-source.html#l00351">351</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="ast__expr2f_8c-source.html#l01553">ECHO</a>.
<p>
Referenced by <a class="el" href="res__crypto_8c-source.html#l00115">pw_cb()</a>.<div class="fragment"><pre class="fragment"><a name="l00352"></a>00352 {
<a name="l00353"></a>00353    <span class="keywordtype">int</span> res;
<a name="l00354"></a>00354    <span class="keyword">struct </span>termios tios;
<a name="l00355"></a>00355    <span class="keywordflow">if</span> (oldstate &lt; 0)
<a name="l00356"></a>00356       <span class="keywordflow">return</span> 0;
<a name="l00357"></a>00357    res = tcgetattr(fd, &amp;tios);
<a name="l00358"></a>00358    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00359"></a>00359       <span class="keywordflow">return</span> -1;
<a name="l00360"></a>00360    tios.c_lflag &amp;= ~(<a class="code" href="ast__expr2f_8c.html#d61484f1331c7f66061e43b859556409">ECHO</a> | ECHONL);
<a name="l00361"></a>00361    tios.c_lflag |= oldstate;
<a name="l00362"></a>00362    res = tcsetattr(fd, TCSAFLUSH, &amp;tios);
<a name="l00363"></a>00363    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00364"></a>00364       <span class="keywordflow">return</span> -1;
<a name="l00365"></a>00365    <span class="keywordflow">return</span> 0;
<a name="l00366"></a>00366 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b4866f7713f64d3072b61b0cd28a5691"></a><!-- doxytag: member="io.c::io_context_create" ref="b4866f7713f64d3072b61b0cd28a5691" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a>* io_context_create           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Create an I/O context. 
<p>
Create a context for I/O operations Basically mallocs an IO structure and sets up some default values. Returns an allocated <a class="el" href="structio__context.html">io_context</a> structure 
<p>
Definition at line <a class="el" href="io_8c-source.html#l00077">77</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="utils_8h-source.html#l00359">ast_malloc</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="io_8c-source.html#l00063">GROW_SHRINK_SIZE</a>, and <a class="el" href="io_8c-source.html#l00073">io_context::needshrink</a>.
<p>
Referenced by <a class="el" href="chan__gtalk_8c-source.html#l01823">load_module()</a>.<div class="fragment"><pre class="fragment"><a name="l00078"></a>00078 {
<a name="l00079"></a>00079    <span class="keyword">struct </span><a class="code" href="structio__context.html">io_context</a> *tmp = NULL;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*tmp))))
<a name="l00082"></a>00082       <span class="keywordflow">return</span> NULL;
<a name="l00083"></a>00083    
<a name="l00084"></a>00084    tmp-&gt;needshrink = 0;
<a name="l00085"></a>00085    tmp-&gt;fdcnt = 0;
<a name="l00086"></a>00086    tmp-&gt;maxfdcnt = <a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a>/2;
<a name="l00087"></a>00087    tmp-&gt;current_ioc = -1;
<a name="l00088"></a>00088    
<a name="l00089"></a>00089    <span class="keywordflow">if</span> (!(tmp-&gt;fds = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, (<a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a> / 2) * <span class="keyword">sizeof</span>(*tmp-&gt;fds)))) {
<a name="l00090"></a>00090       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00091"></a>00091       tmp = NULL;
<a name="l00092"></a>00092    } <span class="keywordflow">else</span> {
<a name="l00093"></a>00093       <span class="keywordflow">if</span> (!(tmp-&gt;ior = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, (<a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a> / 2) * <span class="keyword">sizeof</span>(*tmp-&gt;ior)))) {
<a name="l00094"></a>00094          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp-&gt;fds);
<a name="l00095"></a>00095          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tmp);
<a name="l00096"></a>00096          tmp = NULL;
<a name="l00097"></a>00097       }
<a name="l00098"></a>00098    }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100    <span class="keywordflow">return</span> tmp;
<a name="l00101"></a>00101 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="7fd8c331e4c20a143a221fcb9ff57aeb"></a><!-- doxytag: member="io.c::io_context_destroy" ref="7fd8c331e4c20a143a221fcb9ff57aeb" args="(struct io_context *ioc)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void io_context_destroy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ioc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Destroys a context 
<p>
Definition at line <a class="el" href="io_8c-source.html#l00103">103</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, and <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>.
<p>
Referenced by <a class="el" href="chan__h323_8c-source.html#l03189">load_module()</a>.<div class="fragment"><pre class="fragment"><a name="l00104"></a>00104 {
<a name="l00105"></a>00105    <span class="comment">/* Free associated memory with an I/O context */</span>
<a name="l00106"></a>00106    <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>)
<a name="l00107"></a>00107       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>);
<a name="l00108"></a>00108    <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>)
<a name="l00109"></a>00109       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(ioc);
<a name="l00112"></a>00112 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6179f6c0a1cddf5b00ef463b9824575"></a><!-- doxytag: member="io.c::io_grow" ref="a6179f6c0a1cddf5b00ef463b9824575" args="(struct io_context *ioc)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int io_grow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ioc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Grow the size of our arrays. 
<p>
<dl compact><dt><b>Returns:</b></dt><dd>0 on success or -1 on failure </dd></dl>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00118">118</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>, <a class="el" href="io_8c-source.html#l00044">DEBUG</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="io_8c-source.html#l00063">GROW_SHRINK_SIZE</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, and <a class="el" href="io_8c-source.html#l00071">io_context::maxfdcnt</a>.
<p>
Referenced by <a class="el" href="io_8c-source.html#l00158">ast_io_add()</a>.<div class="fragment"><pre class="fragment"><a name="l00119"></a>00119 {
<a name="l00120"></a>00120    <span class="keywordtype">void</span> *tmp;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122    <a class="code" href="io_8c.html#5ca9902d44b6807e17916b56a97dc3cf">DEBUG</a>(<a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"io_grow()\n"</span>));
<a name="l00123"></a>00123 
<a name="l00124"></a>00124    ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a> += <a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126    <span class="keywordflow">if</span> ((tmp = <a class="code" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>, (ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a> + 1) * <span class="keyword">sizeof</span>(*ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>)))) {
<a name="l00127"></a>00127       ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a> = tmp;
<a name="l00128"></a>00128       <span class="keywordflow">if</span> ((tmp = <a class="code" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>(ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>, (ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a> + 1) * <span class="keyword">sizeof</span>(*ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>)))) {
<a name="l00129"></a>00129          ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a> = tmp;
<a name="l00130"></a>00130       } <span class="keywordflow">else</span> {
<a name="l00131"></a>00131          <span class="comment">/*</span>
<a name="l00132"></a>00132 <span class="comment">          * Failed to allocate enough memory for the pollfd.  Not</span>
<a name="l00133"></a>00133 <span class="comment">          * really any need to shrink back the iorec's as we'll</span>
<a name="l00134"></a>00134 <span class="comment">          * probably want to grow them again soon when more memory</span>
<a name="l00135"></a>00135 <span class="comment">          * is available, and then they'll already be the right size</span>
<a name="l00136"></a>00136 <span class="comment">          */</span>
<a name="l00137"></a>00137          ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a> -= <a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a>;
<a name="l00138"></a>00138          <span class="keywordflow">return</span> -1;
<a name="l00139"></a>00139       }
<a name="l00140"></a>00140    } <span class="keywordflow">else</span> {
<a name="l00141"></a>00141       <span class="comment">/*</span>
<a name="l00142"></a>00142 <span class="comment">       * Memory allocation failure.  We return to the old size, and </span>
<a name="l00143"></a>00143 <span class="comment">       * return a failure</span>
<a name="l00144"></a>00144 <span class="comment">       */</span>
<a name="l00145"></a>00145       ioc-&gt;<a class="code" href="structio__context.html#c272f52f057ae3046673b126531aebc4">maxfdcnt</a> -= <a class="code" href="io_8c.html#b962fab07d2047fa27ba970b6811fe02">GROW_SHRINK_SIZE</a>;
<a name="l00146"></a>00146       <span class="keywordflow">return</span> -1;
<a name="l00147"></a>00147    }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="keywordflow">return</span> 0;
<a name="l00150"></a>00150 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="bdbcfabdcd0be940bf1c6e60a72c5528"></a><!-- doxytag: member="io.c::io_shrink" ref="bdbcfabdcd0be940bf1c6e60a72c5528" args="(struct io_context *ioc)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int io_shrink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structio__context.html">io_context</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ioc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="io_8c-source.html#l00214">214</a> of file <a class="el" href="io_8c-source.html">io.c</a>.
<p>
References <a class="el" href="io_8c-source.html#l00070">io_context::fdcnt</a>, <a class="el" href="io_8c-source.html#l00068">io_context::fds</a>, <a class="el" href="io_8c-source.html#l00053">io_rec::id</a>, <a class="el" href="io_8c-source.html#l00069">io_context::ior</a>, and <a class="el" href="io_8c-source.html#l00073">io_context::needshrink</a>.
<p>
Referenced by <a class="el" href="io_8c-source.html#l00241">ast_io_remove()</a>.<div class="fragment"><pre class="fragment"><a name="l00215"></a>00215 {
<a name="l00216"></a>00216    <span class="keywordtype">int</span> getfrom, putto = 0;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218    <span class="comment">/* </span>
<a name="l00219"></a>00219 <span class="comment">    * Bring the fields from the very last entry to cover over</span>
<a name="l00220"></a>00220 <span class="comment">    * the entry we are removing, then decrease the size of the </span>
<a name="l00221"></a>00221 <span class="comment">    * arrays by one.</span>
<a name="l00222"></a>00222 <span class="comment">    */</span>
<a name="l00223"></a>00223    <span class="keywordflow">for</span> (getfrom = 0; getfrom &lt; ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a>; getfrom++) {
<a name="l00224"></a>00224       <span class="keywordflow">if</span> (ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[getfrom].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>) {
<a name="l00225"></a>00225          <span class="comment">/* In use, save it */</span>
<a name="l00226"></a>00226          <span class="keywordflow">if</span> (getfrom != putto) {
<a name="l00227"></a>00227             ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[putto] = ioc-&gt;<a class="code" href="structio__context.html#838ece1033bf7c7468e873e79ba2a3ec">fds</a>[getfrom];
<a name="l00228"></a>00228             ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[putto] = ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[getfrom];
<a name="l00229"></a>00229             *(ioc-&gt;<a class="code" href="structio__context.html#a0481da2a13483f6977d411b34cddf57">ior</a>[putto].<a class="code" href="structio__rec.html#b80bb7740288fda1f201890375a60c8f">id</a>) = putto;
<a name="l00230"></a>00230          }
<a name="l00231"></a>00231          putto++;
<a name="l00232"></a>00232       }
<a name="l00233"></a>00233    }
<a name="l00234"></a>00234    ioc-&gt;<a class="code" href="structio__context.html#d0754e72572542bf8ee443816300c350">fdcnt</a> = putto;
<a name="l00235"></a>00235    ioc-&gt;<a class="code" href="structio__context.html#fc76dd7bedc2c65a178bdeafca05db37">needshrink</a> = 0;
<a name="l00236"></a>00236    <span class="comment">/* FIXME: We should free some memory if we have lots of unused</span>
<a name="l00237"></a>00237 <span class="comment">      io structs */</span>
<a name="l00238"></a>00238    <span class="keywordflow">return</span> 0;
<a name="l00239"></a>00239 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:33 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
