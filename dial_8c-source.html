<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:40 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>dial.c</h1><a href="dial_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2007, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Joshua Colp &lt;jcolp@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Dialing API</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Joshua Colp &lt;jcolp@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;stdio.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="dial_8h.html">asterisk/dial.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="musiconhold_8h.html">asterisk/musiconhold.h</a>"</span>
<a name="l00047"></a>00047 <span class="comment"></span>
<a name="l00048"></a>00048 <span class="comment">/*! \brief Main dialing structure. Contains global options, channels being dialed, and more! */</span>
<a name="l00049"></a><a class="code" href="structast__dial.html">00049</a> <span class="keyword">struct </span><a class="code" href="structast__dial.html">ast_dial</a> {
<a name="l00050"></a><a class="code" href="structast__dial.html#0fc3cfbc27e91ea60a787de13dae3e3c">00050</a>    <span class="keywordtype">int</span> <a class="code" href="structast__dial.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;                                           <span class="comment">/*!&lt; Current number to give to next dialed channel */</span>
<a name="l00051"></a><a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">00051</a>    <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="structstate.html">state</a>;                        <span class="comment">/*!&lt; Status of dial */</span>
<a name="l00052"></a><a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">00052</a>    <span class="keywordtype">void</span> *<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66c4d02dd952923d19b25d7afe3066ca69">AST_DIAL_OPTION_MAX</a>];                <span class="comment">/*!&lt; Global options */</span>
<a name="l00053"></a><a class="code" href="structast__dial.html#3fbed2c17580e1e851e4ca6d8fb64b5f">00053</a>    <a class="code" href="dial_8h.html#0307ee9bebc49c8e17653906d21fd775">ast_dial_state_callback</a> <a class="code" href="structast__dial.html#3fbed2c17580e1e851e4ca6d8fb64b5f">state_callback</a>;            <span class="comment">/*!&lt; Status callback */</span>
<a name="l00054"></a>00054    <a class="code" href="linkedlists_8h.html#0bcd5ca819474a5c8a780be977fef933">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__dial__channel.html">ast_dial_channel</a>) channels; <span class="comment">/*!&lt; Channels being dialed */</span>
<a name="l00055"></a>00055    pthread_t <a class="code" href="app__meetme_8c.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a>;                                  <span class="comment">/*!&lt; Thread (if running in async) */</span>
<a name="l00056"></a>00056 };
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">/*! \brief Dialing channel structure. Contains per-channel dialing options, asterisk channel, and more! */</span>
<a name="l00059"></a><a class="code" href="structast__dial__channel.html">00059</a> struct <a class="code" href="structast__dial__channel.html">ast_dial_channel</a> {
<a name="l00060"></a><a class="code" href="structast__dial__channel.html#0fc3cfbc27e91ea60a787de13dae3e3c">00060</a>    <span class="keywordtype">int</span> <a class="code" href="structast__dial.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;                               <span class="comment">/*!&lt; Unique number for dialed channel */</span>
<a name="l00061"></a><a class="code" href="structast__dial__channel.html#d9f9133fb120cd6096870bc2b496805b">00061</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *tech;                      <span class="comment">/*!&lt; Technology being dialed */</span>
<a name="l00062"></a><a class="code" href="structast__dial__channel.html#913f9c49dcb544e2087cee284f4a00b7">00062</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *device;                    <span class="comment">/*!&lt; Device being dialed */</span>
<a name="l00063"></a><a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">00063</a>    <span class="keywordtype">void</span> *<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66c4d02dd952923d19b25d7afe3066ca69">AST_DIAL_OPTION_MAX</a>];    <span class="comment">/*!&lt; Channel specific options */</span>
<a name="l00064"></a><a class="code" href="structast__dial__channel.html#560220fc3242a805f094edce47f35702">00064</a>    <span class="keywordtype">int</span> cause;                             <span class="comment">/*!&lt; Cause code in case of failure */</span>
<a name="l00065"></a><a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">00065</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *owner;             <span class="comment">/*!&lt; Asterisk channel */</span>
<a name="l00066"></a>00066    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(ast_dial_channel) list; <span class="comment">/*!&lt; Linked list information */</span>
<a name="l00067"></a>00067 };
<a name="l00068"></a>00068 <span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">/*! \brief Typedef for dial option enable */</span>
<a name="l00070"></a><a class="code" href="dial_8c.html#02a7d91c741fbcf78a5739ba72b918dc">00070</a> typedef <span class="keywordtype">void</span> *(*<a class="code" href="dial_8c.html#02a7d91c741fbcf78a5739ba72b918dc">ast_dial_option_cb_enable</a>)(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">/*! \brief Typedef for dial option disable */</span>
<a name="l00073"></a><a class="code" href="dial_8c.html#a899fc8addc14797630e4ba0692f36e9">00073</a> typedef <span class="keywordtype">int</span> (*<a class="code" href="dial_8c.html#a899fc8addc14797630e4ba0692f36e9">ast_dial_option_cb_disable</a>)(<span class="keywordtype">void</span> *data);
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment">/*! \brief Structure for 'ANSWER_EXEC' option */</span>
<a name="l00076"></a><a class="code" href="structanswer__exec__struct.html">00076</a> struct <a class="code" href="structanswer__exec__struct.html">answer_exec_struct</a> {
<a name="l00077"></a><a class="code" href="structanswer__exec__struct.html#d87b6ee5a83ee70a6697ba886125ae9e">00077</a>    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>[<a class="code" href="pbx_8h.html#a973a2fecfe2da6df7aaf2d5be3ea548">AST_MAX_APP</a>]; <span class="comment">/*!&lt; Application name */</span>
<a name="l00078"></a><a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">00078</a>    <span class="keywordtype">char</span> *args;            <span class="comment">/*!&lt; Application arguments */</span>
<a name="l00079"></a>00079 };
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">/*! \brief Enable function for 'ANSWER_EXEC' option */</span>
<a name="l00082"></a><a class="code" href="dial_8c.html#f75f27d0d1dc67470e82a1f479d13ae5">00082</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="dial_8c.html#f75f27d0d1dc67470e82a1f479d13ae5">answer_exec_enable</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084    <span class="keyword">struct </span><a class="code" href="structanswer__exec__struct.html">answer_exec_struct</a> *answer_exec = NULL;
<a name="l00085"></a>00085    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a> = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>((<span class="keywordtype">char</span>*)data), *<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a> = NULL;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087    <span class="comment">/* Not giving any data to this option is bad, mmmk? */</span>
<a name="l00088"></a>00088    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(app))
<a name="l00089"></a>00089       <span class="keywordflow">return</span> NULL;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091    <span class="comment">/* Create new data structure */</span>
<a name="l00092"></a>00092    <span class="keywordflow">if</span> (!(answer_exec = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*answer_exec))))
<a name="l00093"></a>00093       <span class="keywordflow">return</span> NULL;
<a name="l00094"></a>00094    
<a name="l00095"></a>00095    <span class="comment">/* Parse out application and arguments */</span>
<a name="l00096"></a>00096    <span class="keywordflow">if</span> ((<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a> = strchr(app, <span class="charliteral">'|'</span>))) {
<a name="l00097"></a>00097       *<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>++ = <span class="charliteral">'\0'</span>;
<a name="l00098"></a>00098       answer_exec-&gt;args = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>);
<a name="l00099"></a>00099    }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101    <span class="comment">/* Copy application name */</span>
<a name="l00102"></a>00102    ast_copy_string(answer_exec-&gt;app, app, <span class="keyword">sizeof</span>(answer_exec-&gt;app));
<a name="l00103"></a>00103 
<a name="l00104"></a>00104    <span class="keywordflow">return</span> answer_exec;
<a name="l00105"></a>00105 }
<a name="l00106"></a>00106 <span class="comment"></span>
<a name="l00107"></a>00107 <span class="comment">/*! \brief Disable function for 'ANSWER_EXEC' option */</span>
<a name="l00108"></a><a class="code" href="dial_8c.html#d777ee2a713a386582f88a2965015cd5">00108</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#d777ee2a713a386582f88a2965015cd5">answer_exec_disable</a>(<span class="keywordtype">void</span> *data)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110    <span class="keyword">struct </span><a class="code" href="structanswer__exec__struct.html">answer_exec_struct</a> *answer_exec = data;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112    <span class="comment">/* Make sure we have a value */</span>
<a name="l00113"></a>00113    <span class="keywordflow">if</span> (!answer_exec)
<a name="l00114"></a>00114       <span class="keywordflow">return</span> -1;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116    <span class="comment">/* If arguments are present, free them too */</span>
<a name="l00117"></a>00117    <span class="keywordflow">if</span> (answer_exec-&gt;<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>)
<a name="l00118"></a>00118       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(answer_exec-&gt;<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120    <span class="comment">/* This is simple - just free the structure */</span>
<a name="l00121"></a>00121    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(answer_exec);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123    <span class="keywordflow">return</span> 0;
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="dial_8c.html#be55aa37950ea3e1a44752f1c2243d6d">00126</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="dial_8c.html#be55aa37950ea3e1a44752f1c2243d6d">music_enable</a>(<span class="keywordtype">void</span> *data)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128    <span class="keywordflow">return</span> <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(data);
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="dial_8c.html#b08dec959925a3554b656da74eed606c">00131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#b08dec959925a3554b656da74eed606c">music_disable</a>(<span class="keywordtype">void</span> *data)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133    <span class="keywordflow">if</span> (!data)
<a name="l00134"></a>00134       <span class="keywordflow">return</span> -1;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(data);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="keywordflow">return</span> 0;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 <span class="comment"></span>
<a name="l00141"></a>00141 <span class="comment">/*! \brief Application execution function for 'ANSWER_EXEC' option */</span>
<a name="l00142"></a><a class="code" href="dial_8c.html#656acbe8219762953bef8bfc44f20dc6">00142</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#656acbe8219762953bef8bfc44f20dc6">answer_exec_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>, <span class="keywordtype">char</span> *<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144    <span class="keyword">struct </span><a class="code" href="structast__app.html">ast_app</a> *<a class="code" href="structast__app.html">ast_app</a> = <a class="code" href="pbx_8c.html#d407cf204ec8fc50e5a578c8c17e0cb5">pbx_findapp</a>(app);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146    <span class="comment">/* If the application was not found, return immediately */</span>
<a name="l00147"></a>00147    <span class="keywordflow">if</span> (!ast_app)
<a name="l00148"></a>00148       <span class="keywordflow">return</span>;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150    <span class="comment">/* All is well... execute the application */</span>
<a name="l00151"></a>00151    <a class="code" href="pbx_8c.html#5970fbcb6a776848d11bf1c8ddb1c948">pbx_exec</a>(chan, ast_app, args);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153    <span class="keywordflow">return</span>;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 <span class="comment"></span>
<a name="l00156"></a>00156 <span class="comment">/*! \brief Options structure - maps options to respective handlers (enable/disable). This list MUST be perfectly kept in order, or else madness will happen. */</span>
<a name="l00157"></a><a class="code" href="structast__option__types.html">00157</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__option__types.html">ast_option_types</a> {
<a name="l00158"></a><a class="code" href="structast__option__types.html#ef3e30e070f70244fd6578d88a6b77ac">00158</a>    <span class="keyword">enum</span> <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66">ast_dial_option</a> option;
<a name="l00159"></a><a class="code" href="structast__option__types.html#208f156d4a803025c284bb595a7576b4">00159</a>    <a class="code" href="dial_8c.html#02a7d91c741fbcf78a5739ba72b918dc">ast_dial_option_cb_enable</a> enable;
<a name="l00160"></a><a class="code" href="structast__option__types.html#0aaa87422396fdd678498793b6d5250e">00160</a>    <a class="code" href="dial_8c.html#a899fc8addc14797630e4ba0692f36e9">ast_dial_option_cb_disable</a> disable;
<a name="l00161"></a>00161 } <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[] = {
<a name="l00162"></a>00162    { <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66cadf057cc1c16d5cf67f19421ae3b658">AST_DIAL_OPTION_RINGING</a>, NULL, NULL },                                  <span class="comment">/*!&lt; Always indicate ringing to caller */</span>
<a name="l00163"></a>00163    { <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd668402b8efa6ddfda761eb78de0469ecf1">AST_DIAL_OPTION_ANSWER_EXEC</a>, <a class="code" href="dial_8c.html#f75f27d0d1dc67470e82a1f479d13ae5">answer_exec_enable</a>, <a class="code" href="dial_8c.html#d777ee2a713a386582f88a2965015cd5">answer_exec_disable</a> }, <span class="comment">/*!&lt; Execute application upon answer in async mode */</span>
<a name="l00164"></a>00164    { <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>, <a class="code" href="dial_8c.html#be55aa37950ea3e1a44752f1c2243d6d">music_enable</a>, <a class="code" href="dial_8c.html#b08dec959925a3554b656da74eed606c">music_disable</a> },                   <span class="comment">/*!&lt; Play music to the caller instead of ringing */</span>
<a name="l00165"></a>00165    { <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66c4d02dd952923d19b25d7afe3066ca69">AST_DIAL_OPTION_MAX</a>, NULL, NULL },                                      <span class="comment">/*!&lt; Terminator of list */</span>
<a name="l00166"></a>00166 };
<a name="l00167"></a>00167 <span class="comment"></span>
<a name="l00168"></a>00168 <span class="comment">/*! \brief free the buffer if allocated, and set the pointer to the second arg */</span>
<a name="l00169"></a><a class="code" href="dial_8c.html#e7dcf10b45564b73d3381b31c68d0026">00169</a> <span class="preprocessor">#define S_REPLACE(s, new_val)           \</span>
<a name="l00170"></a>00170 <span class="preprocessor">        do {                            \</span>
<a name="l00171"></a>00171 <span class="preprocessor">                if (s)                  \</span>
<a name="l00172"></a>00172 <span class="preprocessor">                        free(s);        \</span>
<a name="l00173"></a>00173 <span class="preprocessor">                s = (new_val);          \</span>
<a name="l00174"></a>00174 <span class="preprocessor">        } while (0)</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00176"></a>00176 <span class="comment">/*! \brief Maximum number of channels we can watch at a time */</span>
<a name="l00177"></a><a class="code" href="dial_8c.html#91e22cf128e1f0b62755cd9f9b4fc002">00177</a> <span class="preprocessor">#define AST_MAX_WATCHERS 256</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00179"></a>00179 <span class="comment">/*! \brief Macro for finding the option structure to use on a dialed channel */</span>
<a name="l00180"></a><a class="code" href="dial_8c.html#e2f49953fcd52f97fb03fe3c8de5a8bb">00180</a> <span class="preprocessor">#define FIND_RELATIVE_OPTION(dial, dial_channel, ast_dial_option) (dial_channel-&gt;options[ast_dial_option] ? dial_channel-&gt;options[ast_dial_option] : dial-&gt;options[ast_dial_option])</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00182"></a>00182 <span class="comment">/*! \brief Macro that determines whether a channel is the caller or not */</span>
<a name="l00183"></a><a class="code" href="dial_8c.html#caede21b92a611da5442c9a65c2c3dbb">00183</a> <span class="preprocessor">#define IS_CALLER(chan, owner) (chan == owner ? 1 : 0)</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00185"></a>00185 <span class="comment">/*! \brief New dialing structure</span>
<a name="l00186"></a>00186 <span class="comment"> * \note Create a dialing structure</span>
<a name="l00187"></a>00187 <span class="comment"> * \return Returns a calloc'd ast_dial structure, NULL on failure</span>
<a name="l00188"></a>00188 <span class="comment"> */</span>
<a name="l00189"></a><a class="code" href="dial_8h.html#553d140e6f5be9d4db9cb835f244fb9b">00189</a> <span class="keyword">struct </span><a class="code" href="structast__dial.html">ast_dial</a> *<a class="code" href="dial_8c.html#553d140e6f5be9d4db9cb835f244fb9b">ast_dial_create</a>(<span class="keywordtype">void</span>)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191    <span class="keyword">struct </span><a class="code" href="structast__dial.html">ast_dial</a> *dial = NULL;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193    <span class="comment">/* Allocate new memory for structure */</span>
<a name="l00194"></a>00194    <span class="keywordflow">if</span> (!(dial = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*dial))))
<a name="l00195"></a>00195       <span class="keywordflow">return</span> NULL;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    <span class="comment">/* Initialize list of channels */</span>
<a name="l00198"></a>00198    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;dial-&gt;channels);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200    <span class="comment">/* Initialize thread to NULL */</span>
<a name="l00201"></a>00201    dial-&gt;thread = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203    <span class="keywordflow">return</span> dial;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 <span class="comment"></span>
<a name="l00206"></a>00206 <span class="comment">/*! \brief Append a channel</span>
<a name="l00207"></a>00207 <span class="comment"> * \note Appends a channel to a dialing structure</span>
<a name="l00208"></a>00208 <span class="comment"> * \return Returns channel reference number on success, -1 on failure</span>
<a name="l00209"></a>00209 <span class="comment"> */</span>
<a name="l00210"></a><a class="code" href="dial_8h.html#11db38942cc3cbcb60e653b3b441c451">00210</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#11db38942cc3cbcb60e653b3b441c451">ast_dial_append</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">const</span> <span class="keywordtype">char</span> *tech, <span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="comment">/* Make sure we have required arguments */</span>
<a name="l00215"></a>00215    <span class="keywordflow">if</span> (!dial || !tech || !device)
<a name="l00216"></a>00216       <span class="keywordflow">return</span> -1;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218    <span class="comment">/* Allocate new memory for dialed channel structure */</span>
<a name="l00219"></a>00219    <span class="keywordflow">if</span> (!(channel = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*channel))))
<a name="l00220"></a>00220       <span class="keywordflow">return</span> -1;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222    <span class="comment">/* Record technology and device for when we actually dial */</span>
<a name="l00223"></a>00223    channel-&gt;tech = tech;
<a name="l00224"></a>00224    channel-&gt;device = device;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226    <span class="comment">/* Grab reference number from dial structure */</span>
<a name="l00227"></a>00227    channel-&gt;num = ast_atomic_fetchadd_int(&amp;dial-&gt;<a class="code" href="structast__dial.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>, +1);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229    <span class="comment">/* Insert into channels list */</span>
<a name="l00230"></a>00230    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;dial-&gt;channels, channel, list);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232    <span class="keywordflow">return</span> channel-&gt;num;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="comment">/*! \brief Helper function that does the beginning dialing */</span>
<a name="l00236"></a><a class="code" href="dial_8c.html#f2ab02923c90e37c82eb511de3b19ad6">00236</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#f2ab02923c90e37c82eb511de3b19ad6">begin_dial</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00239"></a>00239    <span class="keywordtype">int</span> success = 0, res = 0;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="comment">/* Iterate through channel list, requesting and calling each one */</span>
<a name="l00242"></a>00242    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00243"></a>00243       <span class="keywordtype">char</span> numsubst[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="comment">/* Copy device string over */</span>
<a name="l00246"></a>00246       ast_copy_string(numsubst, channel-&gt;<a class="code" href="structast__dial__channel.html#913f9c49dcb544e2087cee284f4a00b7">device</a>, <span class="keyword">sizeof</span>(numsubst));
<a name="l00247"></a>00247 
<a name="l00248"></a>00248       <span class="comment">/* Request that the channel be created */</span>
<a name="l00249"></a>00249       <span class="keywordflow">if</span> (!(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = <a class="code" href="channel_8c.html#e6f72d6b14d12c48f2e224412f10fb99">ast_request</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>, 
<a name="l00250"></a>00250          chan ? chan-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a> : <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>, numsubst, &amp;channel-&gt;<a class="code" href="structast__dial__channel.html#560220fc3242a805f094edce47f35702">cause</a>))) {
<a name="l00251"></a>00251          <span class="keywordflow">continue</span>;
<a name="l00252"></a>00252       }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254       channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#63469c3c4f19f07c737127a117296de4">appl</a> = <span class="stringliteral">"AppDial2"</span>;
<a name="l00255"></a>00255                 channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a> = <span class="stringliteral">"(Outgoing Line)"</span>;
<a name="l00256"></a>00256                 channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> = 0;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="comment">/* Inherit everything from he who spawned this Dial */</span>
<a name="l00259"></a>00259       <span class="keywordflow">if</span> (chan) {
<a name="l00260"></a>00260          <a class="code" href="channel_8c.html#8fb30ace7afdc2899f9b9cdafbf49ff7">ast_channel_inherit_variables</a>(chan, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262          <span class="comment">/* Copy over callerid information */</span>
<a name="l00263"></a>00263          <a class="code" href="dial_8c.html#e7dcf10b45564b73d3381b31c68d0026">S_REPLACE</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(chan-&gt;cid.cid_num));
<a name="l00264"></a>00264          <a class="code" href="dial_8c.html#e7dcf10b45564b73d3381b31c68d0026">S_REPLACE</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(chan-&gt;cid.cid_name));
<a name="l00265"></a>00265          <a class="code" href="dial_8c.html#e7dcf10b45564b73d3381b31c68d0026">S_REPLACE</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#b38bd57df01e654d73ee2c204e0208d2">cid_ani</a>, <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(chan-&gt;cid.cid_ani));
<a name="l00266"></a>00266          <a class="code" href="dial_8c.html#e7dcf10b45564b73d3381b31c68d0026">S_REPLACE</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#5601a9e1c149cb51bde32dcc877b10b0">cid_rdnis</a>, <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(chan-&gt;cid.cid_rdnis));
<a name="l00267"></a>00267    
<a name="l00268"></a>00268          <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, <a class="code" href="chan__alsa_8c.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, chan-&gt;language);
<a name="l00269"></a>00269          <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, <a class="code" href="chan__iax2_8c.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>, chan-&gt;accountcode);
<a name="l00270"></a>00270          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#1e3482c5d7a7511ec9ca63dea24f9f91">cdrflags</a> = chan-&gt;cdrflags;
<a name="l00271"></a>00271          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;musicclass))
<a name="l00272"></a>00272             <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, <a class="code" href="chan__mgcp_8c.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, chan-&gt;musicclass);
<a name="l00273"></a>00273    
<a name="l00274"></a>00274          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#872e42fb90e7d76ff7350f6741f567ff">cid_pres</a> = chan-&gt;cid.cid_pres;
<a name="l00275"></a>00275          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#ed6d65567170b0bab67f0616396d247f">cid_ton</a> = chan-&gt;cid.cid_ton;
<a name="l00276"></a>00276          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#9010703800c4f5d446cfc1ad720bba2d">cid_tns</a> = chan-&gt;cid.cid_tns;
<a name="l00277"></a>00277          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#89c64e070078b5f6dcd6e241d2eb986e">adsicpe</a> = chan-&gt;adsicpe;
<a name="l00278"></a>00278          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;<a class="code" href="structast__channel.html#bb1450d4bf4e46cabcc3460f5208e2cb">transfercapability</a> = chan-&gt;transfercapability;
<a name="l00279"></a>00279       }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281       <span class="comment">/* Actually call the device */</span>
<a name="l00282"></a>00282       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8c.html#37e2b9b65c43c783c6b43552cd20b438">ast_call</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>, numsubst, 0))) {
<a name="l00283"></a>00283          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00284"></a>00284          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00285"></a>00285       } <span class="keywordflow">else</span> {
<a name="l00286"></a>00286          success++;
<a name="l00287"></a>00287          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00288"></a>00288             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Called %s\n"</span>, numsubst);
<a name="l00289"></a>00289       }
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292    <span class="comment">/* If number of failures matches the number of channels, then this truly failed */</span>
<a name="l00293"></a>00293    <span class="keywordflow">return</span> success;
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 <span class="comment"></span>
<a name="l00296"></a>00296 <span class="comment">/*! \brief Helper function that finds the dialed channel based on owner */</span>
<a name="l00297"></a><a class="code" href="dial_8c.html#25a136f79d4e597dc3151093cf1456d4">00297</a> <span class="keyword">static</span> <span class="keyword">struct </span>ast_dial_channel *<a class="code" href="dial_8c.html#25a136f79d4e597dc3151093cf1456d4">find_relative_dial_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *owner)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00302"></a>00302       <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> == owner)
<a name="l00303"></a>00303          <span class="keywordflow">break</span>;
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306    <span class="keywordflow">return</span> channel;
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a><a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">00309</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="structstate.html">state</a>)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311    dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> = state;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <span class="keywordflow">if</span> (dial-&gt;<a class="code" href="structast__dial.html#3fbed2c17580e1e851e4ca6d8fb64b5f">state_callback</a>)
<a name="l00314"></a>00314       dial-&gt;<a class="code" href="structast__dial.html#3fbed2c17580e1e851e4ca6d8fb64b5f">state_callback</a>(dial);
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 <span class="comment"></span>
<a name="l00317"></a>00317 <span class="comment">/*! \brief Helper function that handles control frames WITH owner */</span>
<a name="l00318"></a><a class="code" href="dial_8c.html#921631e90d92c0fe6ad95366beb944b2">00318</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#921631e90d92c0fe6ad95366beb944b2">handle_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> ast_dial_channel *channel, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>) {
<a name="l00321"></a>00321       <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l00322"></a>00322       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l00323"></a>00323          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00324"></a>00324             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>( <a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s answered %s\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name, chan-&gt;name);
<a name="l00325"></a>00325          <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;dial-&gt;channels, channel, list);
<a name="l00326"></a>00326          <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;dial-&gt;channels, channel, list);
<a name="l00327"></a>00327          <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f869907909afa9611e0a5adaba7557acf963fecc">AST_DIAL_RESULT_ANSWERED</a>);
<a name="l00328"></a>00328          <span class="keywordflow">break</span>;
<a name="l00329"></a>00329       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l00330"></a>00330          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00331"></a>00331             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is busy\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00332"></a>00332          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00333"></a>00333          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00334"></a>00334          <span class="keywordflow">break</span>;
<a name="l00335"></a>00335       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l00336"></a>00336          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00337"></a>00337             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is circuit-busy\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00338"></a>00338          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00339"></a>00339          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00340"></a>00340          <span class="keywordflow">break</span>;
<a name="l00341"></a>00341       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l00342"></a>00342          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00343"></a>00343             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is ringing\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00344"></a>00344          <span class="keywordflow">if</span> (!dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>])
<a name="l00345"></a>00345             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>);
<a name="l00346"></a>00346          <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990791695399003cd087abfdf684ab2dd9094">AST_DIAL_RESULT_RINGING</a>);
<a name="l00347"></a>00347          <span class="keywordflow">break</span>;
<a name="l00348"></a>00348       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389ba3a8e0de0c6348205ffdc9e446af14f">AST_CONTROL_PROGRESS</a>:
<a name="l00349"></a>00349          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00350"></a>00350             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a> (<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is making progress, passing it to %s\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name, chan-&gt;name);
<a name="l00351"></a>00351          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389ba3a8e0de0c6348205ffdc9e446af14f">AST_CONTROL_PROGRESS</a>);
<a name="l00352"></a>00352          <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990792ebd82fa436b83071d87a00b2e42039f">AST_DIAL_RESULT_PROGRESS</a>);
<a name="l00353"></a>00353          <span class="keywordflow">break</span>;
<a name="l00354"></a>00354       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>:
<a name="l00355"></a>00355          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00356"></a>00356             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a> (<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s requested a video update, passing it to %s\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name, chan-&gt;name);
<a name="l00357"></a>00357          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>);
<a name="l00358"></a>00358          <span class="keywordflow">break</span>;
<a name="l00359"></a>00359       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e3f77da12f7cbd7a9abfd7c8ce7bfb2b">AST_CONTROL_PROCEEDING</a>:
<a name="l00360"></a>00360          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00361"></a>00361             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a> (<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is proceeding, passing it to %s\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name, chan-&gt;name);
<a name="l00362"></a>00362          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e3f77da12f7cbd7a9abfd7c8ce7bfb2b">AST_CONTROL_PROCEEDING</a>);
<a name="l00363"></a>00363          <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079f9b5c0bb0fd3bc6adcd37b61ba970a0b">AST_DIAL_RESULT_PROCEEDING</a>);
<a name="l00364"></a>00364          <span class="keywordflow">break</span>;
<a name="l00365"></a>00365       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>:
<a name="l00366"></a>00366          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00367"></a>00367             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Call on %s placed on hold\n"</span>, chan-&gt;name);
<a name="l00368"></a>00368          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>);
<a name="l00369"></a>00369          <span class="keywordflow">break</span>;
<a name="l00370"></a>00370       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>:
<a name="l00371"></a>00371          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00372"></a>00372             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Call on %s left from hold\n"</span>, chan-&gt;name);
<a name="l00373"></a>00373          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l00374"></a>00374          <span class="keywordflow">break</span>;
<a name="l00375"></a>00375       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dca4e33b1ad1492acbc6c1b05fd892dd">AST_CONTROL_OFFHOOK</a>:
<a name="l00376"></a>00376       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3899da5863316de5e07e562d773bb39e94a">AST_CONTROL_FLASH</a>:
<a name="l00377"></a>00377          <span class="keywordflow">break</span>;
<a name="l00378"></a>00378       <span class="keywordflow">case</span> -1:
<a name="l00379"></a>00379          <span class="comment">/* Prod the channel */</span>
<a name="l00380"></a>00380          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, -1);
<a name="l00381"></a>00381          <span class="keywordflow">break</span>;
<a name="l00382"></a>00382       <span class="keywordflow">default</span>:
<a name="l00383"></a>00383          <span class="keywordflow">break</span>;
<a name="l00384"></a>00384       }
<a name="l00385"></a>00385    }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387    <span class="keywordflow">return</span>;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 <span class="comment"></span>
<a name="l00390"></a>00390 <span class="comment">/*! \brief Helper function that handles control frames WITHOUT owner */</span>
<a name="l00391"></a><a class="code" href="dial_8c.html#32b14b7ec5780572dbc192b81883d868">00391</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#32b14b7ec5780572dbc192b81883d868">handle_frame_ownerless</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> ast_dial_channel *channel, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393    <span class="comment">/* If we have no owner we can only update the state of the dial structure, so only look at control frames */</span>
<a name="l00394"></a>00394    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>)
<a name="l00395"></a>00395       <span class="keywordflow">return</span>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l00398"></a>00398    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l00399"></a>00399       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00400"></a>00400          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>( <a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s answered\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00401"></a>00401       <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;dial-&gt;channels, channel, list);
<a name="l00402"></a>00402       <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;dial-&gt;channels, channel, list);
<a name="l00403"></a>00403       <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f869907909afa9611e0a5adaba7557acf963fecc">AST_DIAL_RESULT_ANSWERED</a>);
<a name="l00404"></a>00404       <span class="keywordflow">break</span>;
<a name="l00405"></a>00405    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l00406"></a>00406       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00407"></a>00407          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is busy\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00408"></a>00408       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00409"></a>00409       channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00410"></a>00410       <span class="keywordflow">break</span>;
<a name="l00411"></a>00411    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l00412"></a>00412       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00413"></a>00413          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is circuit-busy\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00414"></a>00414       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00415"></a>00415       channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00416"></a>00416       <span class="keywordflow">break</span>;
<a name="l00417"></a>00417    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l00418"></a>00418       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00419"></a>00419          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is ringing\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00420"></a>00420       <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990791695399003cd087abfdf684ab2dd9094">AST_DIAL_RESULT_RINGING</a>);
<a name="l00421"></a>00421       <span class="keywordflow">break</span>;
<a name="l00422"></a>00422    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389ba3a8e0de0c6348205ffdc9e446af14f">AST_CONTROL_PROGRESS</a>:
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00424"></a>00424          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a> (<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is making progress\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00425"></a>00425       <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990792ebd82fa436b83071d87a00b2e42039f">AST_DIAL_RESULT_PROGRESS</a>);
<a name="l00426"></a>00426       <span class="keywordflow">break</span>;
<a name="l00427"></a>00427    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e3f77da12f7cbd7a9abfd7c8ce7bfb2b">AST_CONTROL_PROCEEDING</a>:
<a name="l00428"></a>00428       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00429"></a>00429          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a> (<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is proceeding\n"</span>, channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>-&gt;name);
<a name="l00430"></a>00430       <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079f9b5c0bb0fd3bc6adcd37b61ba970a0b">AST_DIAL_RESULT_PROCEEDING</a>);
<a name="l00431"></a>00431       <span class="keywordflow">break</span>;
<a name="l00432"></a>00432    <span class="keywordflow">default</span>:
<a name="l00433"></a>00433       <span class="keywordflow">break</span>;
<a name="l00434"></a>00434    }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436    <span class="keywordflow">return</span>;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 <span class="comment"></span>
<a name="l00439"></a>00439 <span class="comment">/*! \brief Helper function that basically keeps tabs on dialing attempts */</span>
<a name="l00440"></a><a class="code" href="dial_8c.html#556311f9538504e4870d8a6d2cba8391">00440</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="dial_8c.html#556311f9538504e4870d8a6d2cba8391">monitor_dial</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442    <span class="keywordtype">int</span> timeout = -1, count = 0;
<a name="l00443"></a>00443    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *cs[<a class="code" href="dial_8c.html#91e22cf128e1f0b62755cd9f9b4fc002">AST_MAX_WATCHERS</a>], *who = NULL;
<a name="l00444"></a>00444    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00445"></a>00445    <span class="keyword">struct </span><a class="code" href="structanswer__exec__struct.html">answer_exec_struct</a> *answer_exec = NULL;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990790071a35eae7e46caecdc7a837ef34731">AST_DIAL_RESULT_TRYING</a>);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="comment">/* If the "always indicate ringing" option is set, change state to ringing and indicate to the owner if present */</span>
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66cadf057cc1c16d5cf67f19421ae3b658">AST_DIAL_OPTION_RINGING</a>]) {
<a name="l00451"></a>00451       <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990791695399003cd087abfdf684ab2dd9094">AST_DIAL_RESULT_RINGING</a>);
<a name="l00452"></a>00452       <span class="keywordflow">if</span> (chan)
<a name="l00453"></a>00453          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>);
<a name="l00454"></a>00454    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan &amp;&amp; dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>] &amp;&amp; 
<a name="l00455"></a>00455       !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>])) {
<a name="l00456"></a>00456       <span class="keywordtype">char</span> *original_moh = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(chan-&gt;musicclass);
<a name="l00457"></a>00457       <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, -1);
<a name="l00458"></a>00458       <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(chan, <a class="code" href="chan__mgcp_8c.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>]);
<a name="l00459"></a>00459       <a class="code" href="channel_8c.html#8b713a18df0470dcb9ad2b97c33b6e6a">ast_moh_start</a>(chan, dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>], NULL);
<a name="l00460"></a>00460       <a class="code" href="stringfields_8h.html#af456e04e9e17dd8a300d1d3cd75b65a">ast_string_field_set</a>(chan, <a class="code" href="chan__mgcp_8c.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, original_moh);
<a name="l00461"></a>00461    }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463    <span class="comment">/* Go into an infinite loop while we are trying */</span>
<a name="l00464"></a>00464    <span class="keywordflow">while</span> ((dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> != <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079f71debccc9c74979599a24b464bb20f9">AST_DIAL_RESULT_UNANSWERED</a>) &amp;&amp; (dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> != <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f869907909afa9611e0a5adaba7557acf963fecc">AST_DIAL_RESULT_ANSWERED</a>) &amp;&amp; (dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> != <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990794fb22e3b10222a458eb3064310d30aef">AST_DIAL_RESULT_HANGUP</a>) &amp;&amp; (dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> != <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079b974f2df35f8cae6b93cf105fff1963d">AST_DIAL_RESULT_TIMEOUT</a>)) {
<a name="l00465"></a>00465       <span class="keywordtype">int</span> pos = 0;
<a name="l00466"></a>00466       <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *fr = NULL;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468       <span class="comment">/* Set up channel structure array */</span>
<a name="l00469"></a>00469       pos = count = 0;
<a name="l00470"></a>00470       <span class="keywordflow">if</span> (chan)
<a name="l00471"></a>00471          cs[pos++] = chan;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473       <span class="comment">/* Add channels we are attempting to dial */</span>
<a name="l00474"></a>00474       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00475"></a>00475          <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>) {
<a name="l00476"></a>00476             cs[pos++] = channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>;
<a name="l00477"></a>00477             count++;
<a name="l00478"></a>00478          }
<a name="l00479"></a>00479       }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <span class="comment">/* If we have no outbound channels in progress, switch state to unanswered and stop */</span>
<a name="l00482"></a>00482       <span class="keywordflow">if</span> (!count) {
<a name="l00483"></a>00483          <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079f71debccc9c74979599a24b464bb20f9">AST_DIAL_RESULT_UNANSWERED</a>);
<a name="l00484"></a>00484          <span class="keywordflow">break</span>;
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487       <span class="comment">/* Just to be safe... */</span>
<a name="l00488"></a>00488       <span class="keywordflow">if</span> (dial-&gt;thread == <a class="code" href="lock_8h.html#8dcec06d78545e75eee3aa4723faeb1e">AST_PTHREADT_STOP</a>)
<a name="l00489"></a>00489          <span class="keywordflow">break</span>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491       <span class="comment">/* Wait for frames from channels */</span>
<a name="l00492"></a>00492       who = <a class="code" href="channel_8c.html#96a31a1429603c4049e5ef10d7ce2470">ast_waitfor_n</a>(cs, pos, &amp;timeout);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494       <span class="comment">/* Check to see if our thread is being cancelled */</span>
<a name="l00495"></a>00495       <span class="keywordflow">if</span> (dial-&gt;thread == <a class="code" href="lock_8h.html#8dcec06d78545e75eee3aa4723faeb1e">AST_PTHREADT_STOP</a>)
<a name="l00496"></a>00496          <span class="keywordflow">break</span>;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498       <span class="comment">/* If we are not being cancelled and we have no channel, then timeout was tripped */</span>
<a name="l00499"></a>00499       <span class="keywordflow">if</span> (!who)
<a name="l00500"></a>00500          <span class="keywordflow">continue</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502       <span class="comment">/* Find relative dial channel */</span>
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (!chan || !<a class="code" href="dial_8c.html#caede21b92a611da5442c9a65c2c3dbb">IS_CALLER</a>(chan, who))
<a name="l00504"></a>00504          channel = <a class="code" href="dial_8c.html#25a136f79d4e597dc3151093cf1456d4">find_relative_dial_channel</a>(dial, who);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506       <span class="comment">/* Attempt to read in a frame */</span>
<a name="l00507"></a>00507       <span class="keywordflow">if</span> (!(fr = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(who))) {
<a name="l00508"></a>00508          <span class="comment">/* If this is the caller then we switch state to hangup and stop */</span>
<a name="l00509"></a>00509          <span class="keywordflow">if</span> (chan &amp;&amp; <a class="code" href="dial_8c.html#caede21b92a611da5442c9a65c2c3dbb">IS_CALLER</a>(chan, who)) {
<a name="l00510"></a>00510             <a class="code" href="dial_8c.html#e24f3189dc54ac54b478be55d159b019">set_state</a>(dial, <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990794fb22e3b10222a458eb3064310d30aef">AST_DIAL_RESULT_HANGUP</a>);
<a name="l00511"></a>00511             <span class="keywordflow">break</span>;
<a name="l00512"></a>00512          }
<a name="l00513"></a>00513          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(who);
<a name="l00514"></a>00514          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00515"></a>00515          <span class="keywordflow">continue</span>;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518       <span class="comment">/* Process the frame */</span>
<a name="l00519"></a>00519       <span class="keywordflow">if</span> (chan)
<a name="l00520"></a>00520          <a class="code" href="dial_8c.html#921631e90d92c0fe6ad95366beb944b2">handle_frame</a>(dial, channel, fr, chan);
<a name="l00521"></a>00521       <span class="keywordflow">else</span>
<a name="l00522"></a>00522          <a class="code" href="dial_8c.html#32b14b7ec5780572dbc192b81883d868">handle_frame_ownerless</a>(dial, channel, fr);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524       <span class="comment">/* Free the received frame and start all over */</span>
<a name="l00525"></a>00525       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(fr);
<a name="l00526"></a>00526    }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    <span class="comment">/* Do post-processing from loop */</span>
<a name="l00529"></a>00529    <span class="keywordflow">if</span> (dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> == <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f869907909afa9611e0a5adaba7557acf963fecc">AST_DIAL_RESULT_ANSWERED</a>) {
<a name="l00530"></a>00530       <span class="comment">/* Hangup everything except that which answered */</span>
<a name="l00531"></a>00531       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00532"></a>00532          <span class="keywordflow">if</span> (!channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> || channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> == who)
<a name="l00533"></a>00533             <span class="keywordflow">continue</span>;
<a name="l00534"></a>00534          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00535"></a>00535          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00536"></a>00536       }
<a name="l00537"></a>00537       <span class="comment">/* If ANSWER_EXEC is enabled as an option, execute application on answered channel */</span>
<a name="l00538"></a>00538       <span class="keywordflow">if</span> ((channel = <a class="code" href="dial_8c.html#25a136f79d4e597dc3151093cf1456d4">find_relative_dial_channel</a>(dial, who)) &amp;&amp; (answer_exec = <a class="code" href="dial_8c.html#e2f49953fcd52f97fb03fe3c8de5a8bb">FIND_RELATIVE_OPTION</a>(dial, channel, <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd668402b8efa6ddfda761eb78de0469ecf1">AST_DIAL_OPTION_ANSWER_EXEC</a>)))
<a name="l00539"></a>00539          <a class="code" href="dial_8c.html#656acbe8219762953bef8bfc44f20dc6">answer_exec_run</a>(who, answer_exec-&gt;<a class="code" href="structanswer__exec__struct.html#d87b6ee5a83ee70a6697ba886125ae9e">app</a>, answer_exec-&gt;<a class="code" href="structanswer__exec__struct.html#a956af09162870af6ce4ebe0f12ccaf8">args</a>);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541       <span class="keywordflow">if</span> (chan &amp;&amp; dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>] &amp;&amp; 
<a name="l00542"></a>00542          !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[<a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd661a2b7f2bea6bdb2bd52a0715a2073047">AST_DIAL_OPTION_MUSIC</a>])) {
<a name="l00543"></a>00543          <a class="code" href="channel_8c.html#db35d3bab46e0655f359b751cdca0ce3">ast_moh_stop</a>(chan);
<a name="l00544"></a>00544       }
<a name="l00545"></a>00545    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> == <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990794fb22e3b10222a458eb3064310d30aef">AST_DIAL_RESULT_HANGUP</a>) {
<a name="l00546"></a>00546       <span class="comment">/* Hangup everything */</span>
<a name="l00547"></a>00547       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00548"></a>00548          <span class="keywordflow">if</span> (!channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>)
<a name="l00549"></a>00549             <span class="keywordflow">continue</span>;
<a name="l00550"></a>00550          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00551"></a>00551          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00552"></a>00552       }
<a name="l00553"></a>00553    }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555    <span class="keywordflow">return</span> dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a>;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 <span class="comment"></span>
<a name="l00558"></a>00558 <span class="comment">/*! \brief Dial async thread function */</span>
<a name="l00559"></a><a class="code" href="dial_8c.html#05670d554fa08cca302741f9f53c782e">00559</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="dial_8c.html#05670d554fa08cca302741f9f53c782e">async_dial</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561    <span class="keyword">struct </span><a class="code" href="structast__dial.html">ast_dial</a> *dial = data;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563    <span class="comment">/* This is really really simple... we basically pass monitor_dial a NULL owner and it changes it's behavior */</span>
<a name="l00564"></a>00564    <a class="code" href="dial_8c.html#556311f9538504e4870d8a6d2cba8391">monitor_dial</a>(dial, NULL);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    <span class="keywordflow">return</span> NULL;
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 <span class="comment"></span>
<a name="l00569"></a>00569 <span class="comment">/*! \brief Execute dialing synchronously or asynchronously</span>
<a name="l00570"></a>00570 <span class="comment"> * \note Dials channels in a dial structure.</span>
<a name="l00571"></a>00571 <span class="comment"> * \return Returns dial result code. (TRYING/INVALID/FAILED/ANSWERED/TIMEOUT/UNANSWERED).</span>
<a name="l00572"></a>00572 <span class="comment"> */</span>
<a name="l00573"></a><a class="code" href="dial_8h.html#660a727c43f38213f33dac76315d7b34">00573</a> <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="dial_8c.html#660a727c43f38213f33dac76315d7b34">ast_dial_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> async)
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575    <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> res = <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990790071a35eae7e46caecdc7a837ef34731">AST_DIAL_RESULT_TRYING</a>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="comment">/* Ensure required arguments are passed */</span>
<a name="l00578"></a>00578    <span class="keywordflow">if</span> (!dial || (!chan &amp;&amp; !async)) {
<a name="l00579"></a>00579       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"invalid #1\n"</span>);
<a name="l00580"></a>00580       <span class="keywordflow">return</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079db56ebc9c15f3a5cbf5cfa51e196e5f5">AST_DIAL_RESULT_INVALID</a>;
<a name="l00581"></a>00581    }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583    <span class="comment">/* If there are no channels to dial we can't very well try to dial them */</span>
<a name="l00584"></a>00584    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;dial-&gt;channels)) {
<a name="l00585"></a>00585       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"invalid #2\n"</span>);
<a name="l00586"></a>00586       <span class="keywordflow">return</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079db56ebc9c15f3a5cbf5cfa51e196e5f5">AST_DIAL_RESULT_INVALID</a>;
<a name="l00587"></a>00587    }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    <span class="comment">/* Dial each requested channel */</span>
<a name="l00590"></a>00590    <span class="keywordflow">if</span> (!<a class="code" href="dial_8c.html#f2ab02923c90e37c82eb511de3b19ad6">begin_dial</a>(dial, chan))
<a name="l00591"></a>00591       <span class="keywordflow">return</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990798ea17e6ce38771ebeb50a4094c5ac61e">AST_DIAL_RESULT_FAILED</a>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593    <span class="comment">/* If we are running async spawn a thread and send it away... otherwise block here */</span>
<a name="l00594"></a>00594    <span class="keywordflow">if</span> (async) {
<a name="l00595"></a>00595       dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> = <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990790071a35eae7e46caecdc7a837ef34731">AST_DIAL_RESULT_TRYING</a>;
<a name="l00596"></a>00596       <span class="comment">/* Try to create a thread */</span>
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#89a8ad746b25627dd12304511d68a24c">ast_pthread_create</a>(&amp;dial-&gt;thread, NULL, <a class="code" href="dial_8c.html#05670d554fa08cca302741f9f53c782e">async_dial</a>, dial)) {
<a name="l00598"></a>00598          <span class="comment">/* Failed to create the thread - hangup all dialed channels and return failed */</span>
<a name="l00599"></a>00599          <a class="code" href="dial_8c.html#f2ea40a02edcc496341ba7ab60b04b1e">ast_dial_hangup</a>(dial);
<a name="l00600"></a>00600          res = <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990798ea17e6ce38771ebeb50a4094c5ac61e">AST_DIAL_RESULT_FAILED</a>;
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602    } <span class="keywordflow">else</span> {
<a name="l00603"></a>00603       res = <a class="code" href="dial_8c.html#556311f9538504e4870d8a6d2cba8391">monitor_dial</a>(dial, chan);
<a name="l00604"></a>00604    }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606    <span class="keywordflow">return</span> res;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 <span class="comment"></span>
<a name="l00609"></a>00609 <span class="comment">/*! \brief Return channel that answered</span>
<a name="l00610"></a>00610 <span class="comment"> * \note Returns the Asterisk channel that answered</span>
<a name="l00611"></a>00611 <span class="comment"> * \param dial Dialing structure</span>
<a name="l00612"></a>00612 <span class="comment"> */</span>
<a name="l00613"></a><a class="code" href="dial_8h.html#d97ab6f3825744d7c2a9497980f07d7e">00613</a> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="dial_8c.html#d97ab6f3825744d7c2a9497980f07d7e">ast_dial_answered</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615    <span class="keywordflow">if</span> (!dial)
<a name="l00616"></a>00616       <span class="keywordflow">return</span> NULL;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618    <span class="keywordflow">return</span> ((dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a> == <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f869907909afa9611e0a5adaba7557acf963fecc">AST_DIAL_RESULT_ANSWERED</a>) ? <a class="code" href="linkedlists_8h.html#e4deb7f32ef480cbc3b2e9b7e4ceff6c">AST_LIST_FIRST</a>(&amp;dial-&gt;channels)-&gt;owner : NULL);
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 <span class="comment"></span>
<a name="l00621"></a>00621 <span class="comment">/*! \brief Return state of dial</span>
<a name="l00622"></a>00622 <span class="comment"> * \note Returns the state of the dial attempt</span>
<a name="l00623"></a>00623 <span class="comment"> * \param dial Dialing structure</span>
<a name="l00624"></a>00624 <span class="comment"> */</span>
<a name="l00625"></a><a class="code" href="dial_8h.html#3151fae1bb626f9f7c4c1b966f5768ca">00625</a> <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="dial_8c.html#3151fae1bb626f9f7c4c1b966f5768ca">ast_dial_state</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial)
<a name="l00626"></a>00626 {
<a name="l00627"></a>00627    <span class="keywordflow">return</span> dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a>;
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 <span class="comment"></span>
<a name="l00630"></a>00630 <span class="comment">/*! \brief Cancel async thread</span>
<a name="l00631"></a>00631 <span class="comment"> * \note Cancel a running async thread</span>
<a name="l00632"></a>00632 <span class="comment"> * \param dial Dialing structure</span>
<a name="l00633"></a>00633 <span class="comment"> */</span>
<a name="l00634"></a><a class="code" href="dial_8h.html#0d20f8f978725d6d89c9ae62e2d8e9ac">00634</a> <span class="keyword">enum</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f8699079">ast_dial_result</a> <a class="code" href="dial_8c.html#0d20f8f978725d6d89c9ae62e2d8e9ac">ast_dial_join</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial)
<a name="l00635"></a>00635 {
<a name="l00636"></a>00636    pthread_t thread;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="comment">/* If the dial structure is not running in async, return failed */</span>
<a name="l00639"></a>00639    <span class="keywordflow">if</span> (dial-&gt;thread == <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>)
<a name="l00640"></a>00640       <span class="keywordflow">return</span> <a class="code" href="dial_8h.html#de002eeb96977d990b965b62f86990798ea17e6ce38771ebeb50a4094c5ac61e">AST_DIAL_RESULT_FAILED</a>;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642    <span class="comment">/* Record thread */</span>
<a name="l00643"></a>00643    thread = dial-&gt;thread;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645    <span class="comment">/* Stop the thread */</span>
<a name="l00646"></a>00646    dial-&gt;thread = <a class="code" href="lock_8h.html#8dcec06d78545e75eee3aa4723faeb1e">AST_PTHREADT_STOP</a>;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648    <span class="comment">/* Now we signal it with SIGURG so it will break out of it's waitfor */</span>
<a name="l00649"></a>00649    pthread_kill(thread, SIGURG);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651    <span class="comment">/* Finally wait for the thread to exit */</span>
<a name="l00652"></a>00652    pthread_join(thread, NULL);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    <span class="comment">/* Yay thread is all gone */</span>
<a name="l00655"></a>00655    dial-&gt;thread = <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657    <span class="keywordflow">return</span> dial-&gt;<a class="code" href="structast__dial.html#9ed39e2ea931586b6a985a6942ef573e">state</a>;
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 <span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">/*! \brief Hangup channels</span>
<a name="l00661"></a>00661 <span class="comment"> * \note Hangup all active channels</span>
<a name="l00662"></a>00662 <span class="comment"> * \param dial Dialing structure</span>
<a name="l00663"></a>00663 <span class="comment"> */</span>
<a name="l00664"></a><a class="code" href="dial_8h.html#f2ea40a02edcc496341ba7ab60b04b1e">00664</a> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#f2ea40a02edcc496341ba7ab60b04b1e">ast_dial_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial)
<a name="l00665"></a>00665 {
<a name="l00666"></a>00666    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    <span class="keywordflow">if</span> (!dial)
<a name="l00669"></a>00669       <span class="keywordflow">return</span>;
<a name="l00670"></a>00670    
<a name="l00671"></a>00671    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00672"></a>00672       <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>) {
<a name="l00673"></a>00673          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00674"></a>00674          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00675"></a>00675       }
<a name="l00676"></a>00676    }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    <span class="keywordflow">return</span>;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 <span class="comment"></span>
<a name="l00681"></a>00681 <span class="comment">/*! \brief Destroys a dialing structure</span>
<a name="l00682"></a>00682 <span class="comment"> * \note Destroys (free's) the given ast_dial structure</span>
<a name="l00683"></a>00683 <span class="comment"> * \param dial Dialing structure to free</span>
<a name="l00684"></a>00684 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00685"></a>00685 <span class="comment"> */</span>
<a name="l00686"></a><a class="code" href="dial_8h.html#544c4d0e90c3090349570084daca0abc">00686</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#544c4d0e90c3090349570084daca0abc">ast_dial_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial)
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688    <span class="keywordtype">int</span> i = 0;
<a name="l00689"></a>00689    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691    <span class="keywordflow">if</span> (!dial)
<a name="l00692"></a>00692       <span class="keywordflow">return</span> -1;
<a name="l00693"></a>00693    
<a name="l00694"></a>00694    <span class="comment">/* Hangup and deallocate all the dialed channels */</span>
<a name="l00695"></a>00695    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00696"></a>00696       <span class="comment">/* Disable any enabled options */</span>
<a name="l00697"></a>00697       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66c4d02dd952923d19b25d7afe3066ca69">AST_DIAL_OPTION_MAX</a>; i++) {
<a name="l00698"></a>00698          <span class="keywordflow">if</span> (!channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i])
<a name="l00699"></a>00699             <span class="keywordflow">continue</span>;
<a name="l00700"></a>00700          <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[i].disable)
<a name="l00701"></a>00701             <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[i].<a class="code" href="structast__option__types.html#0aaa87422396fdd678498793b6d5250e">disable</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i]);
<a name="l00702"></a>00702          channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i] = NULL;
<a name="l00703"></a>00703       }
<a name="l00704"></a>00704       <span class="comment">/* Hang up channel if need be */</span>
<a name="l00705"></a>00705       <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>) {
<a name="l00706"></a>00706          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a>);
<a name="l00707"></a>00707          channel-&gt;<a class="code" href="structast__dial__channel.html#72122ce96bfec66e2396d2e25225d70a">owner</a> = NULL;
<a name="l00708"></a>00708       }
<a name="l00709"></a>00709       <span class="comment">/* Free structure */</span>
<a name="l00710"></a>00710       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(channel);
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712        
<a name="l00713"></a>00713    <span class="comment">/* Disable any enabled options globally */</span>
<a name="l00714"></a>00714    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66c4d02dd952923d19b25d7afe3066ca69">AST_DIAL_OPTION_MAX</a>; i++) {
<a name="l00715"></a>00715       <span class="keywordflow">if</span> (!dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i])
<a name="l00716"></a>00716          <span class="keywordflow">continue</span>;
<a name="l00717"></a>00717       <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[i].disable)
<a name="l00718"></a>00718          <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[i].<a class="code" href="structast__option__types.html#0aaa87422396fdd678498793b6d5250e">disable</a>(dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i]);
<a name="l00719"></a>00719       dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[i] = NULL;
<a name="l00720"></a>00720    }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722    <span class="comment">/* Free structure */</span>
<a name="l00723"></a>00723    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(dial);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725    <span class="keywordflow">return</span> 0;
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 <span class="comment"></span>
<a name="l00728"></a>00728 <span class="comment">/*! \brief Enables an option globally</span>
<a name="l00729"></a>00729 <span class="comment"> * \param dial Dial structure to enable option on</span>
<a name="l00730"></a>00730 <span class="comment"> * \param option Option to enable</span>
<a name="l00731"></a>00731 <span class="comment"> * \param data Data to pass to this option (not always needed)</span>
<a name="l00732"></a>00732 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00733"></a>00733 <span class="comment"> */</span>
<a name="l00734"></a><a class="code" href="dial_8h.html#df978efff960f9bc1bd80cecab7fa3aa">00734</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#df978efff960f9bc1bd80cecab7fa3aa">ast_dial_option_global_enable</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">enum</span> <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66">ast_dial_option</a> option, <span class="keywordtype">void</span> *data)
<a name="l00735"></a>00735 {
<a name="l00736"></a>00736    <span class="comment">/* If the option is already enabled, return failure */</span>
<a name="l00737"></a>00737    <span class="keywordflow">if</span> (dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option])
<a name="l00738"></a>00738       <span class="keywordflow">return</span> -1;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    <span class="comment">/* Execute enable callback if it exists, if not simply make sure the value is set */</span>
<a name="l00741"></a>00741    <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].enable)
<a name="l00742"></a>00742       dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option] = <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].<a class="code" href="structast__option__types.html#208f156d4a803025c284bb595a7576b4">enable</a>(data);
<a name="l00743"></a>00743    <span class="keywordflow">else</span>
<a name="l00744"></a>00744       dial-&gt;<a class="code" href="structast__dial.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option] = (<span class="keywordtype">void</span>*)1;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746    <span class="keywordflow">return</span> 0;
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 <span class="comment"></span>
<a name="l00749"></a>00749 <span class="comment">/*! \brief Enables an option per channel</span>
<a name="l00750"></a>00750 <span class="comment"> * \param dial Dial structure</span>
<a name="l00751"></a>00751 <span class="comment"> * \param num Channel number to enable option on</span>
<a name="l00752"></a>00752 <span class="comment"> * \param option Option to enable</span>
<a name="l00753"></a>00753 <span class="comment"> * \param data Data to pass to this option (not always needed)</span>
<a name="l00754"></a>00754 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00755"></a>00755 <span class="comment"> */</span>
<a name="l00756"></a><a class="code" href="dial_8h.html#b3fa56db6a7d88170f4c7ab34fdbddc5">00756</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#b3fa56db6a7d88170f4c7ab34fdbddc5">ast_dial_option_enable</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keywordtype">int</span> num, <span class="keyword">enum</span> <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66">ast_dial_option</a> option, <span class="keywordtype">void</span> *data)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="comment">/* Ensure we have required arguments */</span>
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (!dial || <a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;dial-&gt;channels))
<a name="l00762"></a>00762       <span class="keywordflow">return</span> -1;
<a name="l00763"></a>00763    
<a name="l00764"></a>00764    <span class="comment">/* Look for channel, we can sort of cheat and predict things - the last channel in the list will probably be what they want */</span>
<a name="l00765"></a>00765    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;dial-&gt;channels)-&gt;num != num) {
<a name="l00766"></a>00766       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00767"></a>00767          <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a> == num)
<a name="l00768"></a>00768             <span class="keywordflow">break</span>;
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770    } <span class="keywordflow">else</span> {
<a name="l00771"></a>00771       channel = <a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;dial-&gt;channels);
<a name="l00772"></a>00772    }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <span class="comment">/* If none found, return failure */</span>
<a name="l00775"></a>00775    <span class="keywordflow">if</span> (!channel)
<a name="l00776"></a>00776       <span class="keywordflow">return</span> -1;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778    <span class="comment">/* If the option is already enabled, return failure */</span>
<a name="l00779"></a>00779    <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option])
<a name="l00780"></a>00780       <span class="keywordflow">return</span> -1;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782         <span class="comment">/* Execute enable callback if it exists, if not simply make sure the value is set */</span>
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].enable)
<a name="l00784"></a>00784       channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option] = <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].<a class="code" href="structast__option__types.html#208f156d4a803025c284bb595a7576b4">enable</a>(data);
<a name="l00785"></a>00785    <span class="keywordflow">else</span>
<a name="l00786"></a>00786       channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option] = (<span class="keywordtype">void</span>*)1;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788    <span class="keywordflow">return</span> 0;
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 <span class="comment"></span>
<a name="l00791"></a>00791 <span class="comment">/*! \brief Disables an option globally</span>
<a name="l00792"></a>00792 <span class="comment"> * \param dial Dial structure to disable option on</span>
<a name="l00793"></a>00793 <span class="comment"> * \param option Option to disable</span>
<a name="l00794"></a>00794 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00795"></a>00795 <span class="comment"> */</span>
<a name="l00796"></a><a class="code" href="dial_8h.html#14fe8a571e9fb1bb0c8c7d96081cbc67">00796</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#14fe8a571e9fb1bb0c8c7d96081cbc67">ast_dial_option_global_disable</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keyword">enum</span> <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66">ast_dial_option</a> option)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798         <span class="comment">/* If the option is not enabled, return failure */</span>
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (!dial-&gt;options[option])
<a name="l00800"></a>00800                 <span class="keywordflow">return</span> -1;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802    <span class="comment">/* Execute callback of option to disable if it exists */</span>
<a name="l00803"></a>00803    <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].disable)
<a name="l00804"></a>00804       <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].<a class="code" href="structast__option__types.html#0aaa87422396fdd678498793b6d5250e">disable</a>(dial-&gt;options[option]);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806    <span class="comment">/* Finally disable option on the structure */</span>
<a name="l00807"></a>00807    dial-&gt;options[option] = NULL;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         <span class="keywordflow">return</span> 0;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 <span class="comment"></span>
<a name="l00812"></a>00812 <span class="comment">/*! \brief Disables an option per channel</span>
<a name="l00813"></a>00813 <span class="comment"> * \param dial Dial structure</span>
<a name="l00814"></a>00814 <span class="comment"> * \param num Channel number to disable option on</span>
<a name="l00815"></a>00815 <span class="comment"> * \param option Option to disable</span>
<a name="l00816"></a>00816 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00817"></a>00817 <span class="comment"> */</span>
<a name="l00818"></a><a class="code" href="dial_8h.html#42fd4acd3eeb80ecd69668cd20aac89a">00818</a> <span class="keywordtype">int</span> <a class="code" href="dial_8c.html#42fd4acd3eeb80ecd69668cd20aac89a">ast_dial_option_disable</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <span class="keywordtype">int</span> num, <span class="keyword">enum</span> <a class="code" href="dial_8h.html#9a3d976a8e04abab71723abcb9d1bd66">ast_dial_option</a> option)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820    <span class="keyword">struct </span>ast_dial_channel *channel = NULL;
<a name="l00821"></a>00821 
<a name="l00822"></a>00822    <span class="comment">/* Ensure we have required arguments */</span>
<a name="l00823"></a>00823    <span class="keywordflow">if</span> (!dial || <a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;dial-&gt;channels))
<a name="l00824"></a>00824       <span class="keywordflow">return</span> -1;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826    <span class="comment">/* Look for channel, we can sort of cheat and predict things - the last channel in the list will probably be what they want */</span>
<a name="l00827"></a>00827    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;dial-&gt;channels)-&gt;num != num) {
<a name="l00828"></a>00828       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;dial-&gt;channels, channel, list) {
<a name="l00829"></a>00829          <span class="keywordflow">if</span> (channel-&gt;<a class="code" href="structast__dial__channel.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a> == num)
<a name="l00830"></a>00830             <span class="keywordflow">break</span>;
<a name="l00831"></a>00831       }
<a name="l00832"></a>00832    } <span class="keywordflow">else</span> {
<a name="l00833"></a>00833       channel = <a class="code" href="linkedlists_8h.html#59bb7a6b664d9bb9678434fc0e6eefb7">AST_LIST_LAST</a>(&amp;dial-&gt;channels);
<a name="l00834"></a>00834    }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    <span class="comment">/* If none found, return failure */</span>
<a name="l00837"></a>00837    <span class="keywordflow">if</span> (!channel)
<a name="l00838"></a>00838       <span class="keywordflow">return</span> -1;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840    <span class="comment">/* If the option is not enabled, return failure */</span>
<a name="l00841"></a>00841    <span class="keywordflow">if</span> (!channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option])
<a name="l00842"></a>00842       <span class="keywordflow">return</span> -1;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    <span class="comment">/* Execute callback of option to disable it if it exists */</span>
<a name="l00845"></a>00845    <span class="keywordflow">if</span> (<a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].disable)
<a name="l00846"></a>00846       <a class="code" href="dial_8c.html#9efeac49a2220d81f75f22eb2ef33251">option_types</a>[option].<a class="code" href="structast__option__types.html#0aaa87422396fdd678498793b6d5250e">disable</a>(channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option]);
<a name="l00847"></a>00847 
<a name="l00848"></a>00848    <span class="comment">/* Finally disable the option on the structure */</span>
<a name="l00849"></a>00849    channel-&gt;<a class="code" href="structast__dial__channel.html#78f7d76bc6c9f8fa8f16ff21578d966c">options</a>[option] = NULL;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851    <span class="keywordflow">return</span> 0;
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="dial_8h.html#9063dd7ab53ef7b75c74d004e2e80aa4">00854</a> <span class="keywordtype">void</span> <a class="code" href="dial_8c.html#9063dd7ab53ef7b75c74d004e2e80aa4">ast_dial_set_state_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html">ast_dial</a> *dial, <a class="code" href="dial_8h.html#0307ee9bebc49c8e17653906d21fd775">ast_dial_state_callback</a> callback)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856    dial-&gt;<a class="code" href="structast__dial.html#3fbed2c17580e1e851e4ca6d8fb64b5f">state_callback</a> = callback;
<a name="l00857"></a>00857 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:41 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
