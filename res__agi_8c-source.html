<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:48 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_agi.c</h1><a href="res__agi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief AGI - the Asterisk Gateway Interface</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;sys/types.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="astdb_8h.html">asterisk/astdb.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="callerid_8h.html">asterisk/callerid.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="image_8h.html">asterisk/image.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="say_8h.html">asterisk/say.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="dsp_8h.html">asterisk/dsp.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="musiconhold_8h.html">asterisk/musiconhold.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="strings_8h.html">asterisk/strings.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="agi_8h.html">asterisk/agi.h</a>"</span>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="res__agi_8c.html#89467a4d712211f900a9a31bcc5a5f63">00068</a> <span class="preprocessor">#define MAX_ARGS 128</span>
<a name="l00069"></a><a class="code" href="res__agi_8c.html#9569e6c05b17196be7c63c6bf9170a62">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_COMMANDS 128</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="comment">/* Recycle some stuff from the CLI interface */</span>
<a name="l00072"></a><a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">00072</a> <span class="preprocessor">#define fdprintf agi_debug_cli</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="res__agi_8c.html#d2a57dc1d883fd21fb9951699df71cc7">00074</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a> = <span class="stringliteral">"AGI"</span>;
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="res__agi_8c.html#b6939ae065bca9f51c6eec6dfdd2ee6d">00076</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#b6939ae065bca9f51c6eec6dfdd2ee6d">eapp</a> = <span class="stringliteral">"EAGI"</span>;
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="res__agi_8c.html#4a42acd9389666cc5255b8753f04e52c">00078</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#4a42acd9389666cc5255b8753f04e52c">deadapp</a> = <span class="stringliteral">"DeadAGI"</span>;
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="res__agi_8c.html#512fbb4e7b617c04031f58b631f2b05d">00080</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#485d112e4e425dde393e2e7091451856">synopsis</a> = <span class="stringliteral">"Executes an AGI compliant application"</span>;
<a name="l00081"></a><a class="code" href="res__agi_8c.html#ee6ed88e1831498c1b026dd08bc4a8b5">00081</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#ee6ed88e1831498c1b026dd08bc4a8b5">esynopsis</a> = <span class="stringliteral">"Executes an EAGI compliant application"</span>;
<a name="l00082"></a><a class="code" href="res__agi_8c.html#9fc385d9bba851f2111d7ea2b493599a">00082</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__agi_8c.html#9fc385d9bba851f2111d7ea2b493599a">deadsynopsis</a> = <span class="stringliteral">"Executes AGI on a hungup channel"</span>;
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="res__agi_8c.html#109a898ddfbe5f3573de9ef7ed6c5295">00084</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a> =
<a name="l00085"></a>00085 <span class="stringliteral">"  [E|Dead]AGI(command|args): Executes an Asterisk Gateway Interface compliant\n"</span>
<a name="l00086"></a>00086 <span class="stringliteral">"program on a channel. AGI allows Asterisk to launch external programs\n"</span>
<a name="l00087"></a>00087 <span class="stringliteral">"written in any language to control a telephony channel, play audio,\n"</span>
<a name="l00088"></a>00088 <span class="stringliteral">"read DTMF digits, etc. by communicating with the AGI protocol on stdin\n"</span>
<a name="l00089"></a>00089 <span class="stringliteral">"and stdout.\n"</span>
<a name="l00090"></a>00090 <span class="stringliteral">"  This channel will stop dialplan execution on hangup inside of this\n"</span>
<a name="l00091"></a>00091 <span class="stringliteral">"application, except when using DeadAGI.  Otherwise, dialplan execution\n"</span>
<a name="l00092"></a>00092 <span class="stringliteral">"will continue normally.\n"</span>
<a name="l00093"></a>00093 <span class="stringliteral">"  A locally executed AGI script will receive SIGHUP on hangup from the channel\n"</span>
<a name="l00094"></a>00094 <span class="stringliteral">"except when using DeadAGI. This can be disabled by setting the AGISIGHUP channel\n"</span>
<a name="l00095"></a>00095 <span class="stringliteral">"variable to \"no\" before executing the AGI application.\n"</span>
<a name="l00096"></a>00096 <span class="stringliteral">"  Using 'EAGI' provides enhanced AGI, with incoming audio available out of band\n"</span>
<a name="l00097"></a>00097 <span class="stringliteral">"on file descriptor 3\n\n"</span>
<a name="l00098"></a>00098 <span class="stringliteral">"  Use the CLI command 'agi show' to list available agi commands\n"</span>
<a name="l00099"></a>00099 <span class="stringliteral">"  This application sets the following channel variable upon completion:\n"</span>
<a name="l00100"></a>00100 <span class="stringliteral">"     AGISTATUS      The status of the attempt to the run the AGI script\n"</span>
<a name="l00101"></a>00101 <span class="stringliteral">"                    text string, one of SUCCESS | FAILED | HANGUP\n"</span>;
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">00103</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">agidebug</a> = 0;
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="res__agi_8c.html#963c453b799889fd4cd96a077cd49243">00105</a> <span class="preprocessor">#define TONE_BLOCK_SIZE 200</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a>00107 <span class="comment">/* Max time to connect to an AGI remote host */</span>
<a name="l00108"></a><a class="code" href="res__agi_8c.html#44edd33dda32dd6479c0610f2de0fd7f">00108</a> <span class="preprocessor">#define MAX_AGI_CONNECT 2000</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a><a class="code" href="res__agi_8c.html#97f5525d749dd0300467d215a32fa8cb">00110</a> <span class="preprocessor">#define AGI_PORT 4573</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">00112</a> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> {
<a name="l00113"></a>00113    <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>,
<a name="l00114"></a>00114    <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>,
<a name="l00115"></a>00115    <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635ce08c955da0991c983be1ef35d678bf8e">AGI_RESULT_HANGUP</a>
<a name="l00116"></a>00116 };
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="res__agi_8c.html#c05394095a2697531cdcf73df49436a0">00118</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#c05394095a2697531cdcf73df49436a0">agi_debug_cli</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>, ...)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120    <span class="keywordtype">char</span> *<a class="code" href="structast__variable.html#3d111ff6c918c5cbdf2b3e843726ec71">stuff</a>;
<a name="l00121"></a>00121    <span class="keywordtype">int</span> res = 0;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123    va_list ap;
<a name="l00124"></a>00124    va_start(ap, fmt);
<a name="l00125"></a>00125    res = <a class="code" href="astmm_8h.html#493abdb6dfcaa835bf40a3aa25691136">vasprintf</a>(&amp;stuff, fmt, ap);
<a name="l00126"></a>00126    va_end(ap);
<a name="l00127"></a>00127    <span class="keywordflow">if</span> (res == -1) {
<a name="l00128"></a>00128       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Out of memory\n"</span>);
<a name="l00129"></a>00129    } <span class="keywordflow">else</span> {
<a name="l00130"></a>00130       <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">agidebug</a>)
<a name="l00131"></a>00131          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"AGI Tx &gt;&gt; %s\n"</span>, stuff);
<a name="l00132"></a>00132       <a class="code" href="utils_8c.html#ee4f9efa51266968c039e00834d32aaa">ast_carefulwrite</a>(fd, stuff, strlen(stuff), 100);
<a name="l00133"></a>00133       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(stuff);
<a name="l00134"></a>00134    }
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="comment">/* launch_netscript: The fastagi handler.</span>
<a name="l00138"></a>00138 <span class="comment">   FastAGI defaults to port 4573 */</span>
<a name="l00139"></a><a class="code" href="res__agi_8c.html#96b0305619db2f2067b053caf00818ec">00139</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> <a class="code" href="res__agi_8c.html#96b0305619db2f2067b053caf00818ec">launch_netscript</a>(<span class="keywordtype">char</span> *agiurl, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> *fds, <span class="keywordtype">int</span> *efd, <span class="keywordtype">int</span> *opid)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141    <span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00142"></a>00142    <span class="keywordtype">int</span> flags;
<a name="l00143"></a>00143    <span class="keyword">struct </span><a class="code" href="structpollfd.html">pollfd</a> pfds[1];
<a name="l00144"></a>00144    <span class="keywordtype">char</span> *host;
<a name="l00145"></a>00145    <span class="keywordtype">char</span> *c; <span class="keywordtype">int</span> port = <a class="code" href="res__agi_8c.html#97f5525d749dd0300467d215a32fa8cb">AGI_PORT</a>;
<a name="l00146"></a>00146    <span class="keywordtype">char</span> *script=<span class="stringliteral">""</span>;
<a name="l00147"></a>00147    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00148"></a>00148    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#d2ccda10db94c2b5d51beed10484c025">hp</a>;
<a name="l00149"></a>00149    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l00150"></a>00150    <span class="keywordtype">int</span> res;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152    <span class="comment">/* agiusl is "agi://host.domain[:port][/script/name]" */</span>
<a name="l00153"></a>00153    host = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(agiurl + 6);  <span class="comment">/* Remove agi:// */</span>
<a name="l00154"></a>00154    <span class="comment">/* Strip off any script name */</span>
<a name="l00155"></a>00155    <span class="keywordflow">if</span> ((c = strchr(host, <span class="charliteral">'/'</span>))) {
<a name="l00156"></a>00156       *c = <span class="charliteral">'\0'</span>;
<a name="l00157"></a>00157       c++;
<a name="l00158"></a>00158       script = c;
<a name="l00159"></a>00159    }
<a name="l00160"></a>00160    <span class="keywordflow">if</span> ((c = strchr(host, <span class="charliteral">':'</span>))) {
<a name="l00161"></a>00161       *c = <span class="charliteral">'\0'</span>;
<a name="l00162"></a>00162       c++;
<a name="l00163"></a>00163       port = atoi(c);
<a name="l00164"></a>00164    }
<a name="l00165"></a>00165    <span class="keywordflow">if</span> (efd) {
<a name="l00166"></a>00166       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"AGI URI's don't support Enhanced AGI yet\n"</span>);
<a name="l00167"></a>00167       <span class="keywordflow">return</span> -1;
<a name="l00168"></a>00168    }
<a name="l00169"></a>00169    hp = <a class="code" href="utils_8c.html#00f9ad2be8cda9c885557d03568816ec">ast_gethostbyname</a>(host, &amp;ahp);
<a name="l00170"></a>00170    <span class="keywordflow">if</span> (!hp) {
<a name="l00171"></a>00171       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to locate host '%s'\n"</span>, host);
<a name="l00172"></a>00172       <span class="keywordflow">return</span> -1;
<a name="l00173"></a>00173    }
<a name="l00174"></a>00174    s = socket(AF_INET, SOCK_STREAM, 0);
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (s &lt; 0) {
<a name="l00176"></a>00176       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create socket: %s\n"</span>, strerror(errno));
<a name="l00177"></a>00177       <span class="keywordflow">return</span> -1;
<a name="l00178"></a>00178    }
<a name="l00179"></a>00179    flags = fcntl(s, F_GETFL);
<a name="l00180"></a>00180    <span class="keywordflow">if</span> (flags &lt; 0) {
<a name="l00181"></a>00181       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Fcntl(F_GETFL) failed: %s\n"</span>, strerror(errno));
<a name="l00182"></a>00182       close(s);
<a name="l00183"></a>00183       <span class="keywordflow">return</span> -1;
<a name="l00184"></a>00184    }
<a name="l00185"></a>00185    <span class="keywordflow">if</span> (fcntl(s, F_SETFL, flags | O_NONBLOCK) &lt; 0) {
<a name="l00186"></a>00186       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Fnctl(F_SETFL) failed: %s\n"</span>, strerror(errno));
<a name="l00187"></a>00187       close(s);
<a name="l00188"></a>00188       <span class="keywordflow">return</span> -1;
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    memset(&amp;sin, 0, <span class="keyword">sizeof</span>(sin));
<a name="l00191"></a>00191    sin.sin_family = AF_INET;
<a name="l00192"></a>00192    sin.sin_port = htons(port);
<a name="l00193"></a>00193    memcpy(&amp;sin.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(sin.sin_addr));
<a name="l00194"></a>00194    <span class="keywordflow">if</span> (connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;sin, <span class="keyword">sizeof</span>(sin)) &amp;&amp; (errno != EINPROGRESS)) {
<a name="l00195"></a>00195       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Connect failed with unexpected error: %s\n"</span>, strerror(errno));
<a name="l00196"></a>00196       close(s);
<a name="l00197"></a>00197       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00198"></a>00198    }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200    pfds[0].<a class="code" href="structpollfd.html#36eba1e1e343279857ea7f69a597324e">fd</a> = s;
<a name="l00201"></a>00201    pfds[0].<a class="code" href="structpollfd.html#16908b0605f2645dfcb4c3a8d248cef3">events</a> = <a class="code" href="poll-compat_8h.html#f82197ce47846604f4f9727bf258b1e1">POLLOUT</a>;
<a name="l00202"></a>00202    <span class="keywordflow">while</span> ((res = <a class="code" href="poll_8c.html#490c34aebc91a7dfe2524a13104fd13e">poll</a>(pfds, 1, <a class="code" href="res__agi_8c.html#44edd33dda32dd6479c0610f2de0fd7f">MAX_AGI_CONNECT</a>)) != 1) {
<a name="l00203"></a>00203       <span class="keywordflow">if</span> (errno != EINTR) {
<a name="l00204"></a>00204          <span class="keywordflow">if</span> (!res) {
<a name="l00205"></a>00205             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"FastAGI connection to '%s' timed out after MAX_AGI_CONNECT (%d) milliseconds.\n"</span>,
<a name="l00206"></a>00206                agiurl, <a class="code" href="res__agi_8c.html#44edd33dda32dd6479c0610f2de0fd7f">MAX_AGI_CONNECT</a>);
<a name="l00207"></a>00207          } <span class="keywordflow">else</span>
<a name="l00208"></a>00208             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Connect to '%s' failed: %s\n"</span>, agiurl, strerror(errno));
<a name="l00209"></a>00209          close(s);
<a name="l00210"></a>00210          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00211"></a>00211       }
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213    <span class="comment">/* XXX in theory should check for partial writes... */</span>
<a name="l00214"></a>00214    <span class="keywordflow">while</span> (write(s, <span class="stringliteral">"agi_network: yes\n"</span>, strlen(<span class="stringliteral">"agi_network: yes\n"</span>)) &lt; 0) {
<a name="l00215"></a>00215       <span class="keywordflow">if</span> (errno != EINTR) {
<a name="l00216"></a>00216          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Connect to '%s' failed: %s\n"</span>, agiurl, strerror(errno));
<a name="l00217"></a>00217          close(s);
<a name="l00218"></a>00218          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220    }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222    <span class="comment">/* If we have a script parameter, relay it to the fastagi server */</span>
<a name="l00223"></a>00223    <span class="comment">/* Script parameters take the form of: AGI(agi://my.example.com/?extension=${EXTEN}) */</span>
<a name="l00224"></a>00224    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(script))
<a name="l00225"></a>00225       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(s, <span class="stringliteral">"agi_network_script: %s\n"</span>, script);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 3)
<a name="l00228"></a>00228       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Wow, connected!\n"</span>);
<a name="l00229"></a>00229    fds[0] = s;
<a name="l00230"></a>00230    fds[1] = s;
<a name="l00231"></a>00231    *opid = -1;
<a name="l00232"></a>00232    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a><a class="code" href="res__agi_8c.html#f65cb877b13ff2c55e746a208baba72b">00235</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> <a class="code" href="res__agi_8c.html#f65cb877b13ff2c55e746a208baba72b">launch_script</a>(<span class="keywordtype">char</span> *script, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> *fds, <span class="keywordtype">int</span> *efd, <span class="keywordtype">int</span> *opid)
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237    <span class="keywordtype">char</span> tmp[256];
<a name="l00238"></a>00238    <span class="keywordtype">int</span> pid;
<a name="l00239"></a>00239    <span class="keywordtype">int</span> toast[2];
<a name="l00240"></a>00240    <span class="keywordtype">int</span> fromast[2];
<a name="l00241"></a>00241    <span class="keywordtype">int</span> audio[2];
<a name="l00242"></a>00242    <span class="keywordtype">int</span> x;
<a name="l00243"></a>00243    <span class="keywordtype">int</span> res;
<a name="l00244"></a>00244    sigset_t signal_set, old_set;
<a name="l00245"></a>00245    
<a name="l00246"></a>00246    <span class="keywordflow">if</span> (!strncasecmp(script, <span class="stringliteral">"agi://"</span>, 6))
<a name="l00247"></a>00247       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#96b0305619db2f2067b053caf00818ec">launch_netscript</a>(script, argv, fds, efd, opid);
<a name="l00248"></a>00248    
<a name="l00249"></a>00249    <span class="keywordflow">if</span> (script[0] != <span class="charliteral">'/'</span>) {
<a name="l00250"></a>00250       snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s/%s"</span>, <a class="code" href="asterisk_8c.html#0fc8e656809ce6507ffed32649956381">ast_config_AST_AGI_DIR</a>, script);
<a name="l00251"></a>00251       script = tmp;
<a name="l00252"></a>00252    }
<a name="l00253"></a>00253    <span class="keywordflow">if</span> (pipe(toast)) {
<a name="l00254"></a>00254       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create toast pipe: %s\n"</span>,strerror(errno));
<a name="l00255"></a>00255       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00256"></a>00256    }
<a name="l00257"></a>00257    <span class="keywordflow">if</span> (pipe(fromast)) {
<a name="l00258"></a>00258       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unable to create fromast pipe: %s\n"</span>, strerror(errno));
<a name="l00259"></a>00259       close(toast[0]);
<a name="l00260"></a>00260       close(toast[1]);
<a name="l00261"></a>00261       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00262"></a>00262    }
<a name="l00263"></a>00263    <span class="keywordflow">if</span> (efd) {
<a name="l00264"></a>00264       <span class="keywordflow">if</span> (pipe(audio)) {
<a name="l00265"></a>00265          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unable to create audio pipe: %s\n"</span>, strerror(errno));
<a name="l00266"></a>00266          close(fromast[0]);
<a name="l00267"></a>00267          close(fromast[1]);
<a name="l00268"></a>00268          close(toast[0]);
<a name="l00269"></a>00269          close(toast[1]);
<a name="l00270"></a>00270          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00271"></a>00271       }
<a name="l00272"></a>00272       res = fcntl(audio[1], F_GETFL);
<a name="l00273"></a>00273       <span class="keywordflow">if</span> (res &gt; -1) 
<a name="l00274"></a>00274          res = fcntl(audio[1], F_SETFL, res | O_NONBLOCK);
<a name="l00275"></a>00275       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00276"></a>00276          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unable to set audio pipe parameters: %s\n"</span>, strerror(errno));
<a name="l00277"></a>00277          close(fromast[0]);
<a name="l00278"></a>00278          close(fromast[1]);
<a name="l00279"></a>00279          close(toast[0]);
<a name="l00280"></a>00280          close(toast[1]);
<a name="l00281"></a>00281          close(audio[0]);
<a name="l00282"></a>00282          close(audio[1]);
<a name="l00283"></a>00283          <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00284"></a>00284       }
<a name="l00285"></a>00285    }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287    <span class="comment">/* Block SIGHUP during the fork - prevents a race */</span>
<a name="l00288"></a>00288    sigfillset(&amp;signal_set);
<a name="l00289"></a>00289    pthread_sigmask(SIG_BLOCK, &amp;signal_set, &amp;old_set);
<a name="l00290"></a>00290    pid = fork();
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (pid &lt; 0) {
<a name="l00292"></a>00292       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to fork(): %s\n"</span>, strerror(errno));
<a name="l00293"></a>00293       pthread_sigmask(SIG_SETMASK, &amp;old_set, NULL);
<a name="l00294"></a>00294       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296    <span class="keywordflow">if</span> (!pid) {
<a name="l00297"></a>00297       <span class="comment">/* Pass paths to AGI via environmental variables */</span>
<a name="l00298"></a>00298       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_CONFIG_DIR"</span>, <a class="code" href="asterisk_8c.html#0a741f5d37bb00616aba45b9437c13a7">ast_config_AST_CONFIG_DIR</a>, 1);
<a name="l00299"></a>00299       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_CONFIG_FILE"</span>, <a class="code" href="asterisk_8c.html#518e579b8448d2834f4d7bcb3c0374b9">ast_config_AST_CONFIG_FILE</a>, 1);
<a name="l00300"></a>00300       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_MODULE_DIR"</span>, <a class="code" href="asterisk_8c.html#0c9ed5029117c0cc03a5acb9e5ff967f">ast_config_AST_MODULE_DIR</a>, 1);
<a name="l00301"></a>00301       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_SPOOL_DIR"</span>, <a class="code" href="asterisk_8c.html#a79197213f86764d67b79bf8542e8156">ast_config_AST_SPOOL_DIR</a>, 1);
<a name="l00302"></a>00302       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_MONITOR_DIR"</span>, <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, 1);
<a name="l00303"></a>00303       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_VAR_DIR"</span>, <a class="code" href="asterisk_8c.html#017a6bc35b6f5a54d1a20dd5ca71aba3">ast_config_AST_VAR_DIR</a>, 1);
<a name="l00304"></a>00304       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_DATA_DIR"</span>, <a class="code" href="asterisk_8c.html#941063989b9bef2acc03ffa668b930a9">ast_config_AST_DATA_DIR</a>, 1);
<a name="l00305"></a>00305       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_LOG_DIR"</span>, <a class="code" href="asterisk_8c.html#af6a08df4c5a91b22da1d9bb4fc3e2a3">ast_config_AST_LOG_DIR</a>, 1);
<a name="l00306"></a>00306       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_AGI_DIR"</span>, <a class="code" href="asterisk_8c.html#0fc8e656809ce6507ffed32649956381">ast_config_AST_AGI_DIR</a>, 1);
<a name="l00307"></a>00307       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_KEY_DIR"</span>, <a class="code" href="asterisk_8c.html#5978b4013e123589a1077c519919f7af">ast_config_AST_KEY_DIR</a>, 1);
<a name="l00308"></a>00308       <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(<span class="stringliteral">"AST_RUN_DIR"</span>, <a class="code" href="asterisk_8c.html#8c5e4b7db03e053ea703f7166c2bd056">ast_config_AST_RUN_DIR</a>, 1);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="comment">/* Don't run AGI scripts with realtime priority -- it causes audio stutter */</span>
<a name="l00311"></a>00311       <a class="code" href="asterisk_8c.html#493d9dec6c0ca06f6b702513f8a72e96">ast_set_priority</a>(0);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313       <span class="comment">/* Redirect stdin and out, provide enhanced audio channel if desired */</span>
<a name="l00314"></a>00314       dup2(fromast[0], STDIN_FILENO);
<a name="l00315"></a>00315       dup2(toast[1], STDOUT_FILENO);
<a name="l00316"></a>00316       <span class="keywordflow">if</span> (efd) {
<a name="l00317"></a>00317          dup2(audio[0], STDERR_FILENO + 1);
<a name="l00318"></a>00318       } <span class="keywordflow">else</span> {
<a name="l00319"></a>00319          close(STDERR_FILENO + 1);
<a name="l00320"></a>00320       }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322       <span class="comment">/* Before we unblock our signals, return our trapped signals back to the defaults */</span>
<a name="l00323"></a>00323       signal(SIGHUP, SIG_DFL);
<a name="l00324"></a>00324       signal(SIGCHLD, SIG_DFL);
<a name="l00325"></a>00325       signal(SIGINT, SIG_DFL);
<a name="l00326"></a>00326       signal(SIGURG, SIG_DFL);
<a name="l00327"></a>00327       signal(SIGTERM, SIG_DFL);
<a name="l00328"></a>00328       signal(SIGPIPE, SIG_DFL);
<a name="l00329"></a>00329       signal(SIGXFSZ, SIG_DFL);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331       <span class="comment">/* unblock important signal handlers */</span>
<a name="l00332"></a>00332       <span class="keywordflow">if</span> (pthread_sigmask(SIG_UNBLOCK, &amp;signal_set, NULL)) {
<a name="l00333"></a>00333          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unable to unblock signals for AGI script: %s\n"</span>, strerror(errno));
<a name="l00334"></a>00334          _exit(1);
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337       <span class="comment">/* Close everything but stdin/out/error */</span>
<a name="l00338"></a>00338       <span class="keywordflow">for</span> (x=STDERR_FILENO + 2;x&lt;1024;x++) 
<a name="l00339"></a>00339          close(x);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       <span class="comment">/* Execute script */</span>
<a name="l00342"></a>00342       <span class="comment">/* XXX argv should be deprecated in favor of passing agi_argX paramaters */</span>
<a name="l00343"></a>00343       execv(script, argv);
<a name="l00344"></a>00344       <span class="comment">/* Can't use ast_log since FD's are closed */</span>
<a name="l00345"></a>00345       fprintf(stdout, <span class="stringliteral">"verbose \"Failed to execute '%s': %s\" 2\n"</span>, script, strerror(errno));
<a name="l00346"></a>00346       fflush(stdout);
<a name="l00347"></a>00347       _exit(1);
<a name="l00348"></a>00348    }
<a name="l00349"></a>00349    pthread_sigmask(SIG_SETMASK, &amp;old_set, NULL);
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l00351"></a>00351       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Launched AGI Script %s\n"</span>, script);
<a name="l00352"></a>00352    fds[0] = toast[0];
<a name="l00353"></a>00353    fds[1] = fromast[1];
<a name="l00354"></a>00354    <span class="keywordflow">if</span> (efd) {
<a name="l00355"></a>00355       *efd = audio[1];
<a name="l00356"></a>00356    }
<a name="l00357"></a>00357    <span class="comment">/* close what we're not using in the parent */</span>
<a name="l00358"></a>00358    close(toast[1]);
<a name="l00359"></a>00359    close(fromast[0]);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361    <span class="keywordflow">if</span> (efd)
<a name="l00362"></a>00362       close(audio[0]);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364    *opid = pid;
<a name="l00365"></a>00365    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="res__agi_8c.html#f311427971734204f497772df9a4b4c1">00368</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#f311427971734204f497772df9a4b4c1">setup_env</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">char</span> *request, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> enhanced, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370    <span class="keywordtype">int</span> count;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="comment">/* Print initial environment, with agi_request always being the first</span>
<a name="l00373"></a>00373 <span class="comment">      thing */</span>
<a name="l00374"></a>00374    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_request: %s\n"</span>, request);
<a name="l00375"></a>00375    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_channel: %s\n"</span>, chan-&gt;name);
<a name="l00376"></a>00376    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_language: %s\n"</span>, chan-&gt;language);
<a name="l00377"></a>00377    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_type: %s\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#d9f9133fb120cd6096870bc2b496805b">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00378"></a>00378    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_uniqueid: %s\n"</span>, chan-&gt;uniqueid);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380    <span class="comment">/* ANI/DNIS */</span>
<a name="l00381"></a>00381    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_callerid: %s\n"</span>, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"unknown"</span>));
<a name="l00382"></a>00382    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_calleridname: %s\n"</span>, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"unknown"</span>));
<a name="l00383"></a>00383    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_callingpres: %d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#872e42fb90e7d76ff7350f6741f567ff">cid_pres</a>);
<a name="l00384"></a>00384    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_callingani2: %d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#644bbeb978ab62db10db9fd8cdaef142">cid_ani2</a>);
<a name="l00385"></a>00385    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_callington: %d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#ed6d65567170b0bab67f0616396d247f">cid_ton</a>);
<a name="l00386"></a>00386    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_callingtns: %d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#9010703800c4f5d446cfc1ad720bba2d">cid_tns</a>);
<a name="l00387"></a>00387    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_dnid: %s\n"</span>, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#24ebe3d1b8eb2a6c8e3511a7a1461b75">cid_dnid</a>, <span class="stringliteral">"unknown"</span>));
<a name="l00388"></a>00388    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_rdnis: %s\n"</span>, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#5601a9e1c149cb51bde32dcc877b10b0">cid_rdnis</a>, <span class="stringliteral">"unknown"</span>));
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    <span class="comment">/* Context information */</span>
<a name="l00391"></a>00391    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_context: %s\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>);
<a name="l00392"></a>00392    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_extension: %s\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>);
<a name="l00393"></a>00393    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_priority: %d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>);
<a name="l00394"></a>00394    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_enhanced: %s\n"</span>, enhanced ? <span class="stringliteral">"1.0"</span> : <span class="stringliteral">"0.0"</span>);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="comment">/* User information */</span>
<a name="l00397"></a>00397    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_accountcode: %s\n"</span>, chan-&gt;accountcode ? chan-&gt;accountcode : <span class="stringliteral">""</span>);
<a name="l00398"></a>00398     
<a name="l00399"></a>00399    <span class="comment">/* Send any parameters to the fastagi server that have been passed via the agi application */</span>
<a name="l00400"></a>00400    <span class="comment">/* Agi application paramaters take the form of: AGI(/path/to/example/script|${EXTEN}) */</span>
<a name="l00401"></a>00401    <span class="keywordflow">for</span>(count = 1; count &lt; argc; count++)
<a name="l00402"></a>00402       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"agi_arg_%d: %s\n"</span>, count, argv[count]);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="comment">/* End with empty return */</span>
<a name="l00405"></a>00405    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(fd, <span class="stringliteral">"\n"</span>);
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a><a class="code" href="res__agi_8c.html#bc2b7a25cf3bcaa42b1363105c57d6f7">00408</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#bc2b7a25cf3bcaa42b1363105c57d6f7">handle_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keywordtype">int</span> res;
<a name="l00411"></a>00411    res = 0;
<a name="l00412"></a>00412    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) {
<a name="l00413"></a>00413       <span class="comment">/* Answer the chan */</span>
<a name="l00414"></a>00414       res = <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan);
<a name="l00415"></a>00415    }
<a name="l00416"></a>00416    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00417"></a>00417    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a><a class="code" href="res__agi_8c.html#a8f58b66977ab3a1b90857dbd95be7d3">00420</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a8f58b66977ab3a1b90857dbd95be7d3">handle_waitfordigit</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422    <span class="keywordtype">int</span> res;
<a name="l00423"></a>00423    <span class="keywordtype">int</span> to;
<a name="l00424"></a>00424    <span class="keywordflow">if</span> (argc != 4)
<a name="l00425"></a>00425       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00426"></a>00426    <span class="keywordflow">if</span> (sscanf(argv[3], <span class="stringliteral">"%d"</span>, &amp;to) != 1)
<a name="l00427"></a>00427       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00428"></a>00428    res = <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(chan, to, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00429"></a>00429    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00430"></a>00430    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a><a class="code" href="res__agi_8c.html#2e21a47bde6e1f60c9fa240f8a1fada2">00433</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2e21a47bde6e1f60c9fa240f8a1fada2">handle_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435    <span class="keywordtype">int</span> res;
<a name="l00436"></a>00436    <span class="keywordflow">if</span> (argc != 3)
<a name="l00437"></a>00437       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00438"></a>00438    <span class="comment">/* At the moment, the parser (perhaps broken) returns with</span>
<a name="l00439"></a>00439 <span class="comment">      the last argument PLUS the newline at the end of the input</span>
<a name="l00440"></a>00440 <span class="comment">      buffer. This probably needs to be fixed, but I wont do that</span>
<a name="l00441"></a>00441 <span class="comment">      because other stuff may break as a result. The right way</span>
<a name="l00442"></a>00442 <span class="comment">      would probably be to strip off the trailing newline before</span>
<a name="l00443"></a>00443 <span class="comment">      parsing, then here, add a newline at the end of the string</span>
<a name="l00444"></a>00444 <span class="comment">      before sending it to ast_sendtext --DUDE */</span>
<a name="l00445"></a>00445    res = <a class="code" href="channel_8c.html#3274faaaeb7a5646df6beead26f9ce8f">ast_sendtext</a>(chan, argv[2]);
<a name="l00446"></a>00446    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00447"></a>00447    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="res__agi_8c.html#8742911cf7c3a9e7a5ab1edd68a41e3e">00450</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#8742911cf7c3a9e7a5ab1edd68a41e3e">handle_recvchar</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452    <span class="keywordtype">int</span> res;
<a name="l00453"></a>00453    <span class="keywordflow">if</span> (argc != 3)
<a name="l00454"></a>00454       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00455"></a>00455    res = <a class="code" href="channel_8c.html#36dd07166fc2565f54fc5e7350b2fbe7">ast_recvchar</a>(chan,atoi(argv[2]));
<a name="l00456"></a>00456    <span class="keywordflow">if</span> (res == 0) {
<a name="l00457"></a>00457       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (timeout)\n"</span>, res);
<a name="l00458"></a>00458       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460    <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00461"></a>00461       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00462"></a>00462       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00463"></a>00463    }
<a name="l00464"></a>00464    <span class="keywordflow">else</span> {
<a name="l00465"></a>00465       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (hangup)\n"</span>, res);
<a name="l00466"></a>00466       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00467"></a>00467    }
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="res__agi_8c.html#9d24ec4282973b3631a1c11c766fee5d">00470</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#9d24ec4282973b3631a1c11c766fee5d">handle_recvtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>;
<a name="l00473"></a>00473    
<a name="l00474"></a>00474    <span class="keywordflow">if</span> (argc != 3)
<a name="l00475"></a>00475       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00476"></a>00476    buf = <a class="code" href="channel_8c.html#985b0a0ce0ab536a6d9a1f88f55ace1a">ast_recvtext</a>(chan,atoi(argv[2]));
<a name="l00477"></a>00477    <span class="keywordflow">if</span> (buf) {
<a name="l00478"></a>00478       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1 (%s)\n"</span>, buf);
<a name="l00479"></a>00479       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(buf);
<a name="l00480"></a>00480    } <span class="keywordflow">else</span> { 
<a name="l00481"></a>00481       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=-1\n"</span>);
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a><a class="code" href="res__agi_8c.html#2a9076635913f8aab2dac377c3618c7e">00486</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2a9076635913f8aab2dac377c3618c7e">handle_tddmode</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488    <span class="keywordtype">int</span> res,x;
<a name="l00489"></a>00489    <span class="keywordflow">if</span> (argc != 3)
<a name="l00490"></a>00490       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00491"></a>00491    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">"on"</span>,2)) 
<a name="l00492"></a>00492       x = 1; 
<a name="l00493"></a>00493    <span class="keywordflow">else</span> 
<a name="l00494"></a>00494       x = 0;
<a name="l00495"></a>00495    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">"mate"</span>,4)) 
<a name="l00496"></a>00496       x = 2;
<a name="l00497"></a>00497    <span class="keywordflow">if</span> (!strncasecmp(argv[2],<span class="stringliteral">"tdd"</span>,3))
<a name="l00498"></a>00498       x = 1;
<a name="l00499"></a>00499    res = <a class="code" href="channel_8c.html#fd050188748d1697051e8176fb5fee36">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a96563f3c16f6dce5bc0b35335a419fc">AST_OPTION_TDD</a>, &amp;x, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 0);
<a name="l00500"></a>00500    <span class="keywordflow">if</span> (res != <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>)
<a name="l00501"></a>00501       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l00502"></a>00502    <span class="keywordflow">else</span>
<a name="l00503"></a>00503       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l00504"></a>00504    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="res__agi_8c.html#5712452818e483e2c1a90a0318abcc24">00507</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#5712452818e483e2c1a90a0318abcc24">handle_sendimage</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509    <span class="keywordtype">int</span> res;
<a name="l00510"></a>00510    <span class="keywordflow">if</span> (argc != 3)
<a name="l00511"></a>00511       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00512"></a>00512    res = <a class="code" href="image_8c.html#4b36ed7e82228f21e1d58a72b5ca93ba">ast_send_image</a>(chan, argv[2]);
<a name="l00513"></a>00513    <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(chan))
<a name="l00514"></a>00514       res = 0;
<a name="l00515"></a>00515    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00516"></a>00516    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="res__agi_8c.html#419ad0794400314f52b9ae921cbfa20b">00519</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#419ad0794400314f52b9ae921cbfa20b">handle_controlstreamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <span class="keywordtype">int</span> res = 0;
<a name="l00522"></a>00522    <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#3f7add6cce1d245fe6b506f6581625ce">skipms</a> = 3000;
<a name="l00523"></a>00523    <span class="keywordtype">char</span> *fwd = NULL;
<a name="l00524"></a>00524    <span class="keywordtype">char</span> *rev = NULL;
<a name="l00525"></a>00525    <span class="keywordtype">char</span> *pause = NULL;
<a name="l00526"></a>00526    <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#ef399b2d446bb37b7c32ad2cc1b6045b">stop</a> = NULL;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    <span class="keywordflow">if</span> (argc &lt; 5 || argc &gt; 9)
<a name="l00529"></a>00529       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[4]))
<a name="l00532"></a>00532       stop = argv[4];
<a name="l00533"></a>00533    <span class="keywordflow">else</span>
<a name="l00534"></a>00534       stop = NULL;
<a name="l00535"></a>00535    
<a name="l00536"></a>00536    <span class="keywordflow">if</span> ((argc &gt; 5) &amp;&amp; (sscanf(argv[5], <span class="stringliteral">"%d"</span>, &amp;skipms) != 1))
<a name="l00537"></a>00537       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (argc &gt; 6 &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[6]))
<a name="l00540"></a>00540       fwd = argv[6];
<a name="l00541"></a>00541    <span class="keywordflow">else</span>
<a name="l00542"></a>00542       fwd = <span class="stringliteral">"#"</span>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544    <span class="keywordflow">if</span> (argc &gt; 7 &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[7]))
<a name="l00545"></a>00545       rev = argv[7];
<a name="l00546"></a>00546    <span class="keywordflow">else</span>
<a name="l00547"></a>00547       rev = <span class="stringliteral">"*"</span>;
<a name="l00548"></a>00548    
<a name="l00549"></a>00549    <span class="keywordflow">if</span> (argc &gt; 8 &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[8]))
<a name="l00550"></a>00550       pause = argv[8];
<a name="l00551"></a>00551    <span class="keywordflow">else</span>
<a name="l00552"></a>00552       pause = NULL;
<a name="l00553"></a>00553    
<a name="l00554"></a>00554    res = <a class="code" href="app_8c.html#053374faaff447fdba145c237e91f95d">ast_control_streamfile</a>(chan, argv[3], fwd, rev, stop, pause, NULL, skipms);
<a name="l00555"></a>00555    
<a name="l00556"></a>00556    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="res__agi_8c.html#cc1de4a44a54813f1d218afbe8895ba4">00561</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#cc1de4a44a54813f1d218afbe8895ba4">handle_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563    <span class="keywordtype">int</span> res;
<a name="l00564"></a>00564    <span class="keywordtype">int</span> vres;   
<a name="l00565"></a>00565    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs;
<a name="l00566"></a>00566    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>;
<a name="l00567"></a>00567    <span class="keywordtype">long</span> sample_offset = 0;
<a name="l00568"></a>00568    <span class="keywordtype">long</span> max_length;
<a name="l00569"></a>00569    <span class="keywordtype">char</span> *edigits = <span class="stringliteral">""</span>;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571    <span class="keywordflow">if</span> (argc &lt; 4 || argc &gt; 5)
<a name="l00572"></a>00572       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (argv[3]) 
<a name="l00575"></a>00575       edigits = argv[3];
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="keywordflow">if</span> ((argc &gt; 4) &amp;&amp; (sscanf(argv[4], <span class="stringliteral">"%ld"</span>, &amp;sample_offset) != 1))
<a name="l00578"></a>00578       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00579"></a>00579    
<a name="l00580"></a>00580    fs = <a class="code" href="file_8c.html#0bcbc0f6cab0bf6be159f0d5844e1b4b">ast_openstream</a>(chan, argv[2], chan-&gt;language);   
<a name="l00581"></a>00581    
<a name="l00582"></a>00582    <span class="keywordflow">if</span> (!fs) {
<a name="l00583"></a>00583       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, 0, sample_offset);
<a name="l00584"></a>00584       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00585"></a>00585    }  
<a name="l00586"></a>00586    vfs = <a class="code" href="file_8c.html#226c58342b830e85eb5c359c6ab5a65f">ast_openvstream</a>(chan, argv[2], chan-&gt;language);
<a name="l00587"></a>00587    <span class="keywordflow">if</span> (vfs &amp;&amp; <a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00588"></a>00588       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Ooh, found a video stream, too\n"</span>);
<a name="l00589"></a>00589       
<a name="l00590"></a>00590    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00591"></a>00591       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Playing '%s' (escape_digits=%s) (sample_offset %ld)\n"</span>, argv[2], edigits, sample_offset);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593    <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, 0, SEEK_END);
<a name="l00594"></a>00594    max_length = <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs);
<a name="l00595"></a>00595    <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l00596"></a>00596    res = <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, fs);
<a name="l00597"></a>00597    <span class="keywordflow">if</span> (vfs)
<a name="l00598"></a>00598       vres = <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, vfs);
<a name="l00599"></a>00599    res = <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(fs);
<a name="l00600"></a>00600    <span class="keywordflow">if</span> (vfs)
<a name="l00601"></a>00601       vres = <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(vfs);
<a name="l00602"></a>00602    
<a name="l00603"></a>00603    <span class="keywordflow">if</span> (res) {
<a name="l00604"></a>00604       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, res, sample_offset);
<a name="l00605"></a>00605       <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00606"></a>00606    }
<a name="l00607"></a>00607    res = <a class="code" href="file_8c.html#7be3107f4ff5bc2975b1f52fa552cb6a">ast_waitstream_full</a>(chan, argv[3], agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00608"></a>00608    <span class="comment">/* this is to check for if ast_waitstream closed the stream, we probably are at</span>
<a name="l00609"></a>00609 <span class="comment">    * the end of the stream, return that amount, else check for the amount */</span>
<a name="l00610"></a>00610    sample_offset = (chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>) ? <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs) : max_length;
<a name="l00611"></a>00611    <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(chan);
<a name="l00612"></a>00612    <span class="keywordflow">if</span> (res == 1) {
<a name="l00613"></a>00613       <span class="comment">/* Stop this command, don't print a result line, as there is a new command */</span>
<a name="l00614"></a>00614       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00615"></a>00615    }
<a name="l00616"></a>00616    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, res, sample_offset);
<a name="l00617"></a>00617    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="comment">/* get option - really similar to the handle_streamfile, but with a timeout */</span>
<a name="l00621"></a><a class="code" href="res__agi_8c.html#27ff6c8a89a9b9d9301e6094da06be5e">00621</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#27ff6c8a89a9b9d9301e6094da06be5e">handle_getoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623    <span class="keywordtype">int</span> res;
<a name="l00624"></a>00624    <span class="keywordtype">int</span> vres;   
<a name="l00625"></a>00625    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs;
<a name="l00626"></a>00626    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *<a class="code" href="structast__filestream.html#ab2eb9f5e144510f91fcdbae6fdd4465">vfs</a>;
<a name="l00627"></a>00627    <span class="keywordtype">long</span> sample_offset = 0;
<a name="l00628"></a>00628    <span class="keywordtype">long</span> max_length;
<a name="l00629"></a>00629    <span class="keywordtype">int</span> timeout = 0;
<a name="l00630"></a>00630    <span class="keywordtype">char</span> *edigits = <span class="stringliteral">""</span>;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632    <span class="keywordflow">if</span> ( argc &lt; 4 || argc &gt; 5 )
<a name="l00633"></a>00633       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635    <span class="keywordflow">if</span> ( argv[3] ) 
<a name="l00636"></a>00636       edigits = argv[3];
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="keywordflow">if</span> ( argc == 5 )
<a name="l00639"></a>00639       timeout = atoi(argv[4]);
<a name="l00640"></a>00640    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a>-&gt;<a class="code" href="structast__pbx.html#5559d18605837885d883b6aa738283f4">dtimeout</a>) {
<a name="l00641"></a>00641       <span class="comment">/* by default dtimeout is set to 5sec */</span>
<a name="l00642"></a>00642       timeout = chan-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a>-&gt;<a class="code" href="structast__pbx.html#5559d18605837885d883b6aa738283f4">dtimeout</a> * 1000; <span class="comment">/* in msec */</span>
<a name="l00643"></a>00643    }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645    fs = <a class="code" href="file_8c.html#0bcbc0f6cab0bf6be159f0d5844e1b4b">ast_openstream</a>(chan, argv[2], chan-&gt;language);
<a name="l00646"></a>00646    <span class="keywordflow">if</span> (!fs) {
<a name="l00647"></a>00647       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, 0, sample_offset);
<a name="l00648"></a>00648       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to open %s\n"</span>, argv[2]);
<a name="l00649"></a>00649       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00650"></a>00650    }
<a name="l00651"></a>00651    vfs = <a class="code" href="file_8c.html#226c58342b830e85eb5c359c6ab5a65f">ast_openvstream</a>(chan, argv[2], chan-&gt;language);
<a name="l00652"></a>00652    <span class="keywordflow">if</span> (vfs &amp;&amp; <a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00653"></a>00653       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Ooh, found a video stream, too\n"</span>);
<a name="l00654"></a>00654    
<a name="l00655"></a>00655    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00656"></a>00656       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Playing '%s' (escape_digits=%s) (timeout %d)\n"</span>, argv[2], edigits, timeout);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658    <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, 0, SEEK_END);
<a name="l00659"></a>00659    max_length = <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs);
<a name="l00660"></a>00660    <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l00661"></a>00661    res = <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, fs);
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (vfs)
<a name="l00663"></a>00663       vres = <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan, vfs);
<a name="l00664"></a>00664    res = <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(fs);
<a name="l00665"></a>00665    <span class="keywordflow">if</span> (vfs)
<a name="l00666"></a>00666       vres = <a class="code" href="file_8c.html#96615b28d77eef740ce76e209aad7424">ast_playstream</a>(vfs);
<a name="l00667"></a>00667    <span class="keywordflow">if</span> (res) {
<a name="l00668"></a>00668       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, res, sample_offset);
<a name="l00669"></a>00669       <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l00670"></a>00670          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00671"></a>00671       <span class="keywordflow">else</span>
<a name="l00672"></a>00672          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00673"></a>00673    }
<a name="l00674"></a>00674    res = <a class="code" href="file_8c.html#7be3107f4ff5bc2975b1f52fa552cb6a">ast_waitstream_full</a>(chan, argv[3], agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00675"></a>00675    <span class="comment">/* this is to check for if ast_waitstream closed the stream, we probably are at</span>
<a name="l00676"></a>00676 <span class="comment">    * the end of the stream, return that amount, else check for the amount */</span>
<a name="l00677"></a>00677    sample_offset = (chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a>)?<a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs):max_length;
<a name="l00678"></a>00678    <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(chan);
<a name="l00679"></a>00679    <span class="keywordflow">if</span> (res == 1) {
<a name="l00680"></a>00680       <span class="comment">/* Stop this command, don't print a result line, as there is a new command */</span>
<a name="l00681"></a>00681       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00682"></a>00682    }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684    <span class="comment">/* If the user didnt press a key, wait for digitTimeout*/</span>
<a name="l00685"></a>00685    <span class="keywordflow">if</span> (res == 0 ) {
<a name="l00686"></a>00686       res = <a class="code" href="channel_8c.html#6db20c648edfddb833ffa4d313257275">ast_waitfordigit_full</a>(chan, timeout, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00687"></a>00687       <span class="comment">/* Make sure the new result is in the escape digits of the GET OPTION */</span>
<a name="l00688"></a>00688       <span class="keywordflow">if</span> ( !strchr(edigits,res) )
<a name="l00689"></a>00689          res=0;
<a name="l00690"></a>00690    }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692         <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d endpos=%ld\n"</span>, res, sample_offset);
<a name="l00693"></a>00693    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="comment">/*--- handle_saynumber: Say number in various language syntaxes ---*/</span>
<a name="l00700"></a>00700 <span class="comment">/* While waiting, we're sending a NULL.  */</span>
<a name="l00701"></a><a class="code" href="res__agi_8c.html#0214c88314778e13476a773217054195">00701</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#0214c88314778e13476a773217054195">handle_saynumber</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703    <span class="keywordtype">int</span> res;
<a name="l00704"></a>00704    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (argc &lt; 4 || argc &gt; 5)
<a name="l00706"></a>00706       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;num) != 1)
<a name="l00708"></a>00708       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00709"></a>00709    res = <a class="code" href="say_8h.html#c282d0a1ae2cb14bace6bcd9fcd3a29a">ast_say_number_full</a>(chan, num, argv[3], chan-&gt;language, argc &gt; 4 ? argv[4] : NULL, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00710"></a>00710    <span class="keywordflow">if</span> (res == 1)
<a name="l00711"></a>00711       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00712"></a>00712    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00713"></a>00713    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a><a class="code" href="res__agi_8c.html#9f62c0d7b3a64c5a00af91bdf4fb618c">00716</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#9f62c0d7b3a64c5a00af91bdf4fb618c">handle_saydigits</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718    <span class="keywordtype">int</span> res;
<a name="l00719"></a>00719    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721    <span class="keywordflow">if</span> (argc != 4)
<a name="l00722"></a>00722       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00723"></a>00723    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;num) != 1)
<a name="l00724"></a>00724       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    res = <a class="code" href="say_8h.html#83e81d19c0309c5b3ea4cc721b243878">ast_say_digit_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00727"></a>00727    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l00728"></a>00728       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00729"></a>00729    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00730"></a>00730    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a><a class="code" href="res__agi_8c.html#1ca39ec03dfc8fe7cf5b3c14ee8f6ac9">00733</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#1ca39ec03dfc8fe7cf5b3c14ee8f6ac9">handle_sayalpha</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735    <span class="keywordtype">int</span> res;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    <span class="keywordflow">if</span> (argc != 4)
<a name="l00738"></a>00738       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    res = <a class="code" href="say_8h.html#1e2d922534f1b45df77ae617e55ec8b4">ast_say_character_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00741"></a>00741    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l00742"></a>00742       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00743"></a>00743    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00744"></a>00744    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a><a class="code" href="res__agi_8c.html#65c8361f5e927a4bffc4fda2fbc6ca6a">00747</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#65c8361f5e927a4bffc4fda2fbc6ca6a">handle_saydate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749    <span class="keywordtype">int</span> res;
<a name="l00750"></a>00750    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00751"></a>00751    <span class="keywordflow">if</span> (argc != 4)
<a name="l00752"></a>00752       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00753"></a>00753    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;num) != 1)
<a name="l00754"></a>00754       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00755"></a>00755    res = <a class="code" href="say_8h.html#2937b21d4159a133ad5309f8d0cee63a">ast_say_date</a>(chan, num, argv[3], chan-&gt;language);
<a name="l00756"></a>00756    <span class="keywordflow">if</span> (res == 1)
<a name="l00757"></a>00757       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00758"></a>00758    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00759"></a>00759    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="res__agi_8c.html#07ef45783df80aed83fc5dd0f04350b9">00762</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#07ef45783df80aed83fc5dd0f04350b9">handle_saytime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764    <span class="keywordtype">int</span> res;
<a name="l00765"></a>00765    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#0fc3cfbc27e91ea60a787de13dae3e3c">num</a>;
<a name="l00766"></a>00766    <span class="keywordflow">if</span> (argc != 4)
<a name="l00767"></a>00767       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00768"></a>00768    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;num) != 1)
<a name="l00769"></a>00769       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00770"></a>00770    res = <a class="code" href="say_8h.html#4f57f70903b2acd8ccea5abe8022ea68">ast_say_time</a>(chan, num, argv[3], chan-&gt;language);
<a name="l00771"></a>00771    <span class="keywordflow">if</span> (res == 1)
<a name="l00772"></a>00772       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00773"></a>00773    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00774"></a>00774    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00777"></a><a class="code" href="res__agi_8c.html#784bb215b82e98d8ec2be943bbae44d2">00777</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#784bb215b82e98d8ec2be943bbae44d2">handle_saydatetime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779    <span class="keywordtype">int</span> res=0;
<a name="l00780"></a>00780    time_t unixtime;
<a name="l00781"></a>00781    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, *zone=NULL;
<a name="l00782"></a>00782    
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (argc &lt; 4)
<a name="l00784"></a>00784       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786    <span class="keywordflow">if</span> (argc &gt; 4) {
<a name="l00787"></a>00787       format = argv[4];
<a name="l00788"></a>00788    } <span class="keywordflow">else</span> {
<a name="l00789"></a>00789       <span class="comment">/* XXX this doesn't belong here, but in the 'say' module */</span>
<a name="l00790"></a>00790       <span class="keywordflow">if</span> (!strcasecmp(chan-&gt;language, <span class="stringliteral">"de"</span>)) {
<a name="l00791"></a>00791          format = <span class="stringliteral">"A dBY HMS"</span>;
<a name="l00792"></a>00792       } <span class="keywordflow">else</span> {
<a name="l00793"></a>00793          format = <span class="stringliteral">"ABdY 'digits/at' IMp"</span>; 
<a name="l00794"></a>00794       }
<a name="l00795"></a>00795    }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    <span class="keywordflow">if</span> (argc &gt; 5 &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[5]))
<a name="l00798"></a>00798       zone = argv[5];
<a name="l00799"></a>00799 
<a name="l00800"></a>00800    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#e434765e496e1d032b93936545df57c6">ast_get_time_t</a>(argv[2], &amp;unixtime, 0, NULL))
<a name="l00801"></a>00801       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803    res = <a class="code" href="say_8h.html#75e37f609719abec220f6fde9dd26f45">ast_say_date_with_format</a>(chan, unixtime, argv[3], chan-&gt;language, format, zone);
<a name="l00804"></a>00804    <span class="keywordflow">if</span> (res == 1)
<a name="l00805"></a>00805       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00808"></a>00808    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a><a class="code" href="res__agi_8c.html#6eb408169ba980d5e7b7c541674e35a3">00811</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#6eb408169ba980d5e7b7c541674e35a3">handle_sayphonetic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813    <span class="keywordtype">int</span> res;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815    <span class="keywordflow">if</span> (argc != 4)
<a name="l00816"></a>00816       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818    res = <a class="code" href="say_8h.html#6aa62c71e9dc7aab8f6150ebc7a5f72e">ast_say_phonetic_str_full</a>(chan, argv[2], argv[3], chan-&gt;language, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00819"></a>00819    <span class="keywordflow">if</span> (res == 1) <span class="comment">/* New command */</span>
<a name="l00820"></a>00820       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00821"></a>00821    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l00822"></a>00822    <span class="keywordflow">return</span> (res &gt;= 0) ? <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a> : <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a><a class="code" href="res__agi_8c.html#d422d9d9963d1e0253d2321938b3d20b">00825</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#d422d9d9963d1e0253d2321938b3d20b">handle_getdata</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827    <span class="keywordtype">int</span> res;
<a name="l00828"></a>00828    <span class="keywordtype">char</span> data[1024];
<a name="l00829"></a>00829    <span class="keywordtype">int</span> max;
<a name="l00830"></a>00830    <span class="keywordtype">int</span> timeout;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832    <span class="keywordflow">if</span> (argc &lt; 3)
<a name="l00833"></a>00833       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00834"></a>00834    <span class="keywordflow">if</span> (argc &gt;= 4)
<a name="l00835"></a>00835       timeout = atoi(argv[3]); 
<a name="l00836"></a>00836    <span class="keywordflow">else</span>
<a name="l00837"></a>00837       timeout = 0;
<a name="l00838"></a>00838    <span class="keywordflow">if</span> (argc &gt;= 5) 
<a name="l00839"></a>00839       max = atoi(argv[4]); 
<a name="l00840"></a>00840    <span class="keywordflow">else</span>
<a name="l00841"></a>00841       max = 1024;
<a name="l00842"></a>00842    res = <a class="code" href="app_8c.html#b36282b616946ec71ce782fc5ad46fad">ast_app_getdata_full</a>(chan, argv[2], data, max, timeout, agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l00843"></a>00843    <span class="keywordflow">if</span> (res == 2)        <span class="comment">/* New command */</span>
<a name="l00844"></a>00844       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00845"></a>00845    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1)
<a name="l00846"></a>00846       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%s (timeout)\n"</span>, data);
<a name="l00847"></a>00847    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 0 )
<a name="l00848"></a>00848       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=-1\n"</span>);
<a name="l00849"></a>00849    <span class="keywordflow">else</span>
<a name="l00850"></a>00850       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%s\n"</span>, data);
<a name="l00851"></a>00851    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="res__agi_8c.html#6224d740431aae48e658420734c90768">00854</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#6224d740431aae48e658420734c90768">handle_setcontext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856 
<a name="l00857"></a>00857    <span class="keywordflow">if</span> (argc != 3)
<a name="l00858"></a>00858       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00859"></a>00859    ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, argv[2], <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>));
<a name="l00860"></a>00860    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l00861"></a>00861    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863    
<a name="l00864"></a><a class="code" href="res__agi_8c.html#a3911dab7741715253611d0dd36ff871">00864</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a3911dab7741715253611d0dd36ff871">handle_setextension</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866    <span class="keywordflow">if</span> (argc != 3)
<a name="l00867"></a>00867       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00868"></a>00868    ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, argv[2], <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>));
<a name="l00869"></a>00869    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l00870"></a>00870    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 
<a name="l00873"></a><a class="code" href="res__agi_8c.html#8d44f893b0f3d7778ba0e428c4b04adf">00873</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#8d44f893b0f3d7778ba0e428c4b04adf">handle_setpriority</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00874"></a>00874 {
<a name="l00875"></a>00875    <span class="keywordtype">int</span> pri;
<a name="l00876"></a>00876    <span class="keywordflow">if</span> (argc != 3)
<a name="l00877"></a>00877       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;   
<a name="l00878"></a>00878 
<a name="l00879"></a>00879    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;pri) != 1) {
<a name="l00880"></a>00880       <span class="keywordflow">if</span> ((pri = <a class="code" href="pbx_8c.html#6f1b63f69b489517c49ccfecdbe1642e">ast_findlabel_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, argv[2], chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)) &lt; 1)
<a name="l00881"></a>00881          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00882"></a>00882    }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884    <a class="code" href="pbx_8c.html#1e0079c7f2934dd7ebe801fefe4057da">ast_explicit_goto</a>(chan, NULL, NULL, pri);
<a name="l00885"></a>00885    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l00886"></a>00886    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888       
<a name="l00889"></a><a class="code" href="res__agi_8c.html#9342d35e8dd1034d9524e3a66ffbddde">00889</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#9342d35e8dd1034d9524e3a66ffbddde">handle_recordfile</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00890"></a>00890 {
<a name="l00891"></a>00891    <span class="keyword">struct </span><a class="code" href="structast__filestream.html">ast_filestream</a> *fs;
<a name="l00892"></a>00892    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00893"></a>00893    <span class="keyword">struct </span>timeval start;
<a name="l00894"></a>00894    <span class="keywordtype">long</span> sample_offset = 0;
<a name="l00895"></a>00895    <span class="keywordtype">int</span> res = 0;
<a name="l00896"></a>00896    <span class="keywordtype">int</span> ms;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         <span class="keyword">struct </span><a class="code" href="structast__dsp.html">ast_dsp</a> *sildet=NULL;         <span class="comment">/* silence detector dsp */</span>
<a name="l00899"></a>00899         <span class="keywordtype">int</span> <a class="code" href="structast__dsp.html#49af541c5e4edca2fb90987a3c7cd2ab">totalsilence</a> = 0;
<a name="l00900"></a>00900         <span class="keywordtype">int</span> dspsilence = 0;
<a name="l00901"></a>00901         <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#7a985be8d5c8e77c165d051bec3ba198">silence</a> = 0;                <span class="comment">/* amount of silence to allow */</span>
<a name="l00902"></a>00902         <span class="keywordtype">int</span> gotsilence = 0;             <span class="comment">/* did we timeout for silence? */</span>
<a name="l00903"></a>00903         <span class="keywordtype">char</span> *silencestr=NULL;
<a name="l00904"></a>00904         <span class="keywordtype">int</span> rfmt=0;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    <span class="comment">/* XXX EAGI FIXME XXX */</span>
<a name="l00908"></a>00908 
<a name="l00909"></a>00909    <span class="keywordflow">if</span> (argc &lt; 6)
<a name="l00910"></a>00910       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00911"></a>00911    <span class="keywordflow">if</span> (sscanf(argv[5], <span class="stringliteral">"%d"</span>, &amp;ms) != 1)
<a name="l00912"></a>00912       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914    <span class="keywordflow">if</span> (argc &gt; 6)
<a name="l00915"></a>00915       silencestr = strchr(argv[6],<span class="charliteral">'s'</span>);
<a name="l00916"></a>00916    <span class="keywordflow">if</span> ((argc &gt; 7) &amp;&amp; (!silencestr))
<a name="l00917"></a>00917       silencestr = strchr(argv[7],<span class="charliteral">'s'</span>);
<a name="l00918"></a>00918    <span class="keywordflow">if</span> ((argc &gt; 8) &amp;&amp; (!silencestr))
<a name="l00919"></a>00919       silencestr = strchr(argv[8],<span class="charliteral">'s'</span>);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921    <span class="keywordflow">if</span> (silencestr) {
<a name="l00922"></a>00922       <span class="keywordflow">if</span> (strlen(silencestr) &gt; 2) {
<a name="l00923"></a>00923          <span class="keywordflow">if</span> ((silencestr[0] == <span class="charliteral">'s'</span>) &amp;&amp; (silencestr[1] == <span class="charliteral">'='</span>)) {
<a name="l00924"></a>00924             silencestr++;
<a name="l00925"></a>00925             silencestr++;
<a name="l00926"></a>00926             <span class="keywordflow">if</span> (silencestr)
<a name="l00927"></a>00927                         silence = atoi(silencestr);
<a name="l00928"></a>00928                <span class="keywordflow">if</span> (silence &gt; 0)
<a name="l00929"></a>00929                         silence *= 1000;
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932    }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (silence &gt; 0) {
<a name="l00935"></a>00935          rfmt = chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l00936"></a>00936                 res = <a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>);
<a name="l00937"></a>00937                 <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00938"></a>00938                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set to linear mode, giving up\n"</span>);
<a name="l00939"></a>00939                         <span class="keywordflow">return</span> -1;
<a name="l00940"></a>00940                 }
<a name="l00941"></a>00941                   sildet = <a class="code" href="dsp_8c.html#95aa7dc3101fae9b433b4f29feaa1bab">ast_dsp_new</a>();
<a name="l00942"></a>00942                 <span class="keywordflow">if</span> (!sildet) {
<a name="l00943"></a>00943                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create silence detector :(\n"</span>);
<a name="l00944"></a>00944                         <span class="keywordflow">return</span> -1;
<a name="l00945"></a>00945                 }
<a name="l00946"></a>00946                   <a class="code" href="dsp_8c.html#06a1df6a74baf7fbd9f2db229408315f">ast_dsp_set_threshold</a>(sildet, 256);
<a name="l00947"></a>00947          }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949    <span class="comment">/* backward compatibility, if no offset given, arg[6] would have been</span>
<a name="l00950"></a>00950 <span class="comment">    * caught below and taken to be a beep, else if it is a digit then it is a</span>
<a name="l00951"></a>00951 <span class="comment">    * offset */</span>
<a name="l00952"></a>00952    <span class="keywordflow">if</span> ((argc &gt;6) &amp;&amp; (sscanf(argv[6], <span class="stringliteral">"%ld"</span>, &amp;sample_offset) != 1) &amp;&amp; (!strchr(argv[6], <span class="charliteral">'='</span>)))
<a name="l00953"></a>00953       res = <a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(chan, <span class="stringliteral">"beep"</span>, chan-&gt;language);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955    <span class="keywordflow">if</span> ((argc &gt; 7) &amp;&amp; (!strchr(argv[7], <span class="charliteral">'='</span>)))
<a name="l00956"></a>00956       res = <a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(chan, <span class="stringliteral">"beep"</span>, chan-&gt;language);
<a name="l00957"></a>00957 
<a name="l00958"></a>00958    <span class="keywordflow">if</span> (!res)
<a name="l00959"></a>00959       res = <a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(chan, argv[4]);
<a name="l00960"></a>00960    <span class="keywordflow">if</span> (res) {
<a name="l00961"></a>00961       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (randomerror) endpos=%ld\n"</span>, res, sample_offset);
<a name="l00962"></a>00962    } <span class="keywordflow">else</span> {
<a name="l00963"></a>00963       fs = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(argv[2], argv[3], NULL, O_CREAT | O_WRONLY | (sample_offset ? O_APPEND : 0), 0, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>);
<a name="l00964"></a>00964       <span class="keywordflow">if</span> (!fs) {
<a name="l00965"></a>00965          res = -1;
<a name="l00966"></a>00966          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (writefile)\n"</span>, res);
<a name="l00967"></a>00967          <span class="keywordflow">if</span> (sildet)
<a name="l00968"></a>00968             <a class="code" href="dsp_8c.html#4bcf981973b4db5614c153e1773da6a4">ast_dsp_free</a>(sildet);
<a name="l00969"></a>00969          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00970"></a>00970       }
<a name="l00971"></a>00971       
<a name="l00972"></a>00972       <span class="comment">/* Request a video update */</span>
<a name="l00973"></a>00973       <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897e8f2fe3be94657a962aa673f0c449e5">AST_CONTROL_VIDUPDATE</a>);
<a name="l00974"></a>00974    
<a name="l00975"></a>00975       chan-&gt;<a class="code" href="structast__channel.html#f7b44cfafd5c52223d5498196c8a2e7b">stream</a> = fs;
<a name="l00976"></a>00976       <a class="code" href="file_8c.html#47ae0cfaee0f98a97bf732081a55fcdc">ast_applystream</a>(chan,fs);
<a name="l00977"></a>00977       <span class="comment">/* really should have checks */</span>
<a name="l00978"></a>00978       <a class="code" href="file_8c.html#02e10962dcfcb69e23bfaf15dce32393">ast_seekstream</a>(fs, sample_offset, SEEK_SET);
<a name="l00979"></a>00979       <a class="code" href="file_8c.html#ce29e5d0bdd4ecde2928bc9055507bc0">ast_truncstream</a>(fs);
<a name="l00980"></a>00980       
<a name="l00981"></a>00981       start = ast_tvnow();
<a name="l00982"></a>00982       <span class="keywordflow">while</span> ((ms &lt; 0) || ast_tvdiff_ms(ast_tvnow(), start) &lt; ms) {
<a name="l00983"></a>00983          res = <a class="code" href="channel_8c.html#e02dcdf40023f275d4561a930e7a7fc9">ast_waitfor</a>(chan, -1);
<a name="l00984"></a>00984          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00985"></a>00985             <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(fs);
<a name="l00986"></a>00986             <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (waitfor) endpos=%ld\n"</span>, res,sample_offset);
<a name="l00987"></a>00987             <span class="keywordflow">if</span> (sildet)
<a name="l00988"></a>00988                <a class="code" href="dsp_8c.html#4bcf981973b4db5614c153e1773da6a4">ast_dsp_free</a>(sildet);
<a name="l00989"></a>00989             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00990"></a>00990          }
<a name="l00991"></a>00991          f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l00992"></a>00992          <span class="keywordflow">if</span> (!f) {
<a name="l00993"></a>00993             <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (hangup) endpos=%ld\n"</span>, 0, sample_offset);
<a name="l00994"></a>00994             <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(fs);
<a name="l00995"></a>00995             <span class="keywordflow">if</span> (sildet)
<a name="l00996"></a>00996                <a class="code" href="dsp_8c.html#4bcf981973b4db5614c153e1773da6a4">ast_dsp_free</a>(sildet);
<a name="l00997"></a>00997             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00998"></a>00998          }
<a name="l00999"></a>00999          <span class="keywordflow">switch</span>(f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>) {
<a name="l01000"></a>01000          <span class="keywordflow">case</span> AST_FRAME_DTMF:
<a name="l01001"></a>01001             <span class="keywordflow">if</span> (strchr(argv[4], f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>)) {
<a name="l01002"></a>01002                <span class="comment">/* This is an interrupting chracter, so rewind to chop off any small</span>
<a name="l01003"></a>01003 <span class="comment">                  amount of DTMF that may have been recorded</span>
<a name="l01004"></a>01004 <span class="comment">               */</span>
<a name="l01005"></a>01005                <a class="code" href="file_8c.html#3a2eb1ab87bc99265738281b25fc6999">ast_stream_rewind</a>(fs, 200);
<a name="l01006"></a>01006                <a class="code" href="file_8c.html#ce29e5d0bdd4ecde2928bc9055507bc0">ast_truncstream</a>(fs);
<a name="l01007"></a>01007                sample_offset = <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs);
<a name="l01008"></a>01008                <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (dtmf) endpos=%ld\n"</span>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>, sample_offset);
<a name="l01009"></a>01009                <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(fs);
<a name="l01010"></a>01010                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01011"></a>01011                <span class="keywordflow">if</span> (sildet)
<a name="l01012"></a>01012                   <a class="code" href="dsp_8c.html#4bcf981973b4db5614c153e1773da6a4">ast_dsp_free</a>(sildet);
<a name="l01013"></a>01013                <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01014"></a>01014             }
<a name="l01015"></a>01015             <span class="keywordflow">break</span>;
<a name="l01016"></a>01016          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>:
<a name="l01017"></a>01017             <a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(fs, f);
<a name="l01018"></a>01018             <span class="comment">/* this is a safe place to check progress since we know that fs</span>
<a name="l01019"></a>01019 <span class="comment">             * is valid after a write, and it will then have our current</span>
<a name="l01020"></a>01020 <span class="comment">             * location */</span>
<a name="l01021"></a>01021             sample_offset = <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs);
<a name="l01022"></a>01022                                 <span class="keywordflow">if</span> (silence &gt; 0) {
<a name="l01023"></a>01023                                  dspsilence = 0;
<a name="l01024"></a>01024                                         <a class="code" href="dsp_8c.html#b40de8950fc5d32c476c4462a5e5d5c6">ast_dsp_silence</a>(sildet, f, &amp;dspsilence);
<a name="l01025"></a>01025                                         <span class="keywordflow">if</span> (dspsilence) {
<a name="l01026"></a>01026                                              totalsilence = dspsilence;
<a name="l01027"></a>01027                                         } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028                                                 totalsilence = 0;
<a name="l01029"></a>01029                                         }
<a name="l01030"></a>01030                                         <span class="keywordflow">if</span> (totalsilence &gt; silence) {
<a name="l01031"></a>01031                                              <span class="comment">/* Ended happily with silence */</span>
<a name="l01032"></a>01032                                                 gotsilence = 1;
<a name="l01033"></a>01033                                                 <span class="keywordflow">break</span>;
<a name="l01034"></a>01034                                         }
<a name="l01035"></a>01035                               }
<a name="l01036"></a>01036             <span class="keywordflow">break</span>;
<a name="l01037"></a>01037          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92f3104666df07b461099e43be37983393">AST_FRAME_VIDEO</a>:
<a name="l01038"></a>01038             <a class="code" href="file_8c.html#89845762896f1b8df8786e386b3a7493">ast_writestream</a>(fs, f);
<a name="l01039"></a>01039          <span class="keywordflow">default</span>:
<a name="l01040"></a>01040             <span class="comment">/* Ignore all other frames */</span>
<a name="l01041"></a>01041             <span class="keywordflow">break</span>;
<a name="l01042"></a>01042          }
<a name="l01043"></a>01043          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01044"></a>01044          <span class="keywordflow">if</span> (gotsilence)
<a name="l01045"></a>01045             <span class="keywordflow">break</span>;
<a name="l01046"></a>01046          }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048                <span class="keywordflow">if</span> (gotsilence) {
<a name="l01049"></a>01049                         <a class="code" href="file_8c.html#3a2eb1ab87bc99265738281b25fc6999">ast_stream_rewind</a>(fs, silence-1000);
<a name="l01050"></a>01050                   <a class="code" href="file_8c.html#ce29e5d0bdd4ecde2928bc9055507bc0">ast_truncstream</a>(fs);
<a name="l01051"></a>01051          sample_offset = <a class="code" href="file_8c.html#f71d7aa8f7ce1c8a5e60fe235ad4ea01">ast_tellstream</a>(fs);
<a name="l01052"></a>01052       }     
<a name="l01053"></a>01053       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d (timeout) endpos=%ld\n"</span>, res, sample_offset);
<a name="l01054"></a>01054       <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(fs);
<a name="l01055"></a>01055    }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (<a class="code" href="chan__alsa_8c.html#7a985be8d5c8e77c165d051bec3ba198">silence</a> &gt; 0) {
<a name="l01058"></a>01058                 res = <a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, rfmt);
<a name="l01059"></a>01059                 <span class="keywordflow">if</span> (res)
<a name="l01060"></a>01060                         <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to restore read format on '%s'\n"</span>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l01061"></a>01061                 <a class="code" href="dsp_8c.html#4bcf981973b4db5614c153e1773da6a4">ast_dsp_free</a>(sildet);
<a name="l01062"></a>01062         }
<a name="l01063"></a>01063    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01066"></a><a class="code" href="res__agi_8c.html#a478e5a58f8a036278d9b707f902352e">01066</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a478e5a58f8a036278d9b707f902352e">handle_autohangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068    <span class="keywordtype">int</span> timeout;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070    <span class="keywordflow">if</span> (argc != 3)
<a name="l01071"></a>01071       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01072"></a>01072    <span class="keywordflow">if</span> (sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;timeout) != 1)
<a name="l01073"></a>01073       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01074"></a>01074    <span class="keywordflow">if</span> (timeout &lt; 0)
<a name="l01075"></a>01075       timeout = 0;
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (timeout)
<a name="l01077"></a>01077       chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> = time(NULL) + timeout;
<a name="l01078"></a>01078    <span class="keywordflow">else</span>
<a name="l01079"></a>01079       chan-&gt;<a class="code" href="structast__channel.html#1272db9c0584f07eb3c6bae4e21fc7c8">whentohangup</a> = 0;
<a name="l01080"></a>01080    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01081"></a>01081    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a><a class="code" href="res__agi_8c.html#e773232abfe9d3c84aef94491654c392">01084</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#e773232abfe9d3c84aef94491654c392">handle_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01085"></a>01085 {
<a name="l01086"></a>01086    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l01087"></a>01087    <span class="keywordflow">if</span> (argc == 1) {
<a name="l01088"></a>01088       <span class="comment">/* no argument: hangup the current channel */</span>
<a name="l01089"></a>01089       <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(chan,<a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1fe8eae384d045bee039ff9140421beb8">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01090"></a>01090       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l01091"></a>01091       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01092"></a>01092    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2) {
<a name="l01093"></a>01093       <span class="comment">/* one argument: look for info on the specified channel */</span>
<a name="l01094"></a>01094       c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(argv[1]);
<a name="l01095"></a>01095       <span class="keywordflow">if</span> (c) {
<a name="l01096"></a>01096          <span class="comment">/* we have a matching channel */</span>
<a name="l01097"></a>01097          <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(c,<a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1fe8eae384d045bee039ff9140421beb8">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01098"></a>01098          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l01099"></a>01099          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01100"></a>01100          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01101"></a>01101       }
<a name="l01102"></a>01102       <span class="comment">/* if we get this far no channel name matched the argument given */</span>
<a name="l01103"></a>01103       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=-1\n"</span>);
<a name="l01104"></a>01104       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01105"></a>01105    } <span class="keywordflow">else</span> {
<a name="l01106"></a>01106       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01107"></a>01107    }
<a name="l01108"></a>01108 }
<a name="l01109"></a>01109 
<a name="l01110"></a><a class="code" href="res__agi_8c.html#978503dfa71afeb5d8aaa6a9d5004ca8">01110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#978503dfa71afeb5d8aaa6a9d5004ca8">handle_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01111"></a>01111 {
<a name="l01112"></a>01112    <span class="keywordtype">int</span> res;
<a name="l01113"></a>01113    <span class="keyword">struct </span><a class="code" href="structast__app.html">ast_app</a> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115    <span class="keywordflow">if</span> (argc &lt; 2)
<a name="l01116"></a>01116       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l01119"></a>01119       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"AGI Script Executing Application: (%s) Options: (%s)\n"</span>, argv[1], argv[2]);
<a name="l01120"></a>01120 
<a name="l01121"></a>01121    app = <a class="code" href="pbx_8c.html#d407cf204ec8fc50e5a578c8c17e0cb5">pbx_findapp</a>(argv[1]);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123    <span class="keywordflow">if</span> (app) {
<a name="l01124"></a>01124       res = <a class="code" href="pbx_8c.html#5970fbcb6a776848d11bf1c8ddb1c948">pbx_exec</a>(chan, app, argv[2]);
<a name="l01125"></a>01125    } <span class="keywordflow">else</span> {
<a name="l01126"></a>01126       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not find application (%s)\n"</span>, argv[1]);
<a name="l01127"></a>01127       res = -2;
<a name="l01128"></a>01128    }
<a name="l01129"></a>01129    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, res);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131    <span class="keywordflow">return</span> res;
<a name="l01132"></a>01132 }
<a name="l01133"></a>01133 
<a name="l01134"></a><a class="code" href="res__agi_8c.html#a86683e6156a5763449d4690a0e348de">01134</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a86683e6156a5763449d4690a0e348de">handle_setcallerid</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01135"></a>01135 {
<a name="l01136"></a>01136    <span class="keywordtype">char</span> tmp[256]=<span class="stringliteral">""</span>;
<a name="l01137"></a>01137    <span class="keywordtype">char</span> *l = NULL, *n = NULL;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (argv[2]) {
<a name="l01140"></a>01140       ast_copy_string(tmp, argv[2], <span class="keyword">sizeof</span>(tmp));
<a name="l01141"></a>01141       <a class="code" href="callerid_8c.html#914d0eb3b42ed9d3547306d24d2e67a0">ast_callerid_parse</a>(tmp, &amp;n, &amp;l);
<a name="l01142"></a>01142       <span class="keywordflow">if</span> (l)
<a name="l01143"></a>01143          <a class="code" href="callerid_8c.html#472e6c01db8037ff1904969285f4e91c">ast_shrink_phone_number</a>(l);
<a name="l01144"></a>01144       <span class="keywordflow">else</span>
<a name="l01145"></a>01145          l = <span class="stringliteral">""</span>;
<a name="l01146"></a>01146       <span class="keywordflow">if</span> (!n)
<a name="l01147"></a>01147          n = <span class="stringliteral">""</span>;
<a name="l01148"></a>01148       <a class="code" href="channel_8c.html#7f8abba078071d5d796f25ebc9198974">ast_set_callerid</a>(chan, l, n, NULL);
<a name="l01149"></a>01149    }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l01152"></a>01152    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01153"></a>01153 }
<a name="l01154"></a>01154 
<a name="l01155"></a><a class="code" href="res__agi_8c.html#9790dda5dc67ae37ee9f32971892cf1e">01155</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#9790dda5dc67ae37ee9f32971892cf1e">handle_channelstatus</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01156"></a>01156 {
<a name="l01157"></a>01157    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l01158"></a>01158    <span class="keywordflow">if</span> (argc == 2) {
<a name="l01159"></a>01159       <span class="comment">/* no argument: supply info on the current channel */</span>
<a name="l01160"></a>01160       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>);
<a name="l01161"></a>01161       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01162"></a>01162    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 3) {
<a name="l01163"></a>01163       <span class="comment">/* one argument: look for info on the specified channel */</span>
<a name="l01164"></a>01164       c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(argv[2]);
<a name="l01165"></a>01165       <span class="keywordflow">if</span> (c) {
<a name="l01166"></a>01166          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%d\n"</span>, c-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>);
<a name="l01167"></a>01167          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l01168"></a>01168          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01169"></a>01169       }
<a name="l01170"></a>01170       <span class="comment">/* if we get this far no channel name matched the argument given */</span>
<a name="l01171"></a>01171       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=-1\n"</span>);
<a name="l01172"></a>01172       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01173"></a>01173    } <span class="keywordflow">else</span> {
<a name="l01174"></a>01174       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01175"></a>01175    }
<a name="l01176"></a>01176 }
<a name="l01177"></a>01177 
<a name="l01178"></a><a class="code" href="res__agi_8c.html#f460620c4d77c64c3c3d2411b687902f">01178</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#f460620c4d77c64c3c3d2411b687902f">handle_setvariable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180    <span class="keywordflow">if</span> (argv[3])
<a name="l01181"></a>01181       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, argv[2], argv[3]);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l01184"></a>01184    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a><a class="code" href="res__agi_8c.html#8bb0c9d9cadd2694bd9b8aaf40ef4cf9">01187</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#8bb0c9d9cadd2694bd9b8aaf40ef4cf9">handle_getvariable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189    <span class="keywordtype">char</span> *ret;
<a name="l01190"></a>01190    <span class="keywordtype">char</span> tempstr[1024];
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <span class="keywordflow">if</span> (argc != 3)
<a name="l01193"></a>01193       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="comment">/* check if we want to execute an ast_custom_function */</span>
<a name="l01196"></a>01196    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(argv[2]) &amp;&amp; (argv[2][strlen(argv[2]) - 1] == <span class="charliteral">')'</span>)) {
<a name="l01197"></a>01197       ret = <a class="code" href="pbx_8c.html#fc067f1890b3fdeeacbc538e92a39fbd">ast_func_read</a>(chan, argv[2], tempstr, <span class="keyword">sizeof</span>(tempstr)) ? NULL : tempstr;
<a name="l01198"></a>01198    } <span class="keywordflow">else</span> {
<a name="l01199"></a>01199       <a class="code" href="pbx_8c.html#2753b759766c3d305e2551f63e403677">pbx_retrieve_variable</a>(chan, argv[2], &amp;ret, tempstr, <span class="keyword">sizeof</span>(tempstr), NULL);
<a name="l01200"></a>01200    }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <span class="keywordflow">if</span> (ret)
<a name="l01203"></a>01203       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1 (%s)\n"</span>, ret);
<a name="l01204"></a>01204    <span class="keywordflow">else</span>
<a name="l01205"></a>01205       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01210"></a><a class="code" href="res__agi_8c.html#06e17409e5839609597864ce6705df45">01210</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#06e17409e5839609597864ce6705df45">handle_getvariablefull</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01211"></a>01211 {
<a name="l01212"></a>01212    <span class="keywordtype">char</span> tmp[4096] = <span class="stringliteral">""</span>;
<a name="l01213"></a>01213    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *chan2=NULL;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215    <span class="keywordflow">if</span> ((argc != 4) &amp;&amp; (argc != 5))
<a name="l01216"></a>01216       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01217"></a>01217    <span class="keywordflow">if</span> (argc == 5) {
<a name="l01218"></a>01218       chan2 = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(argv[4]);
<a name="l01219"></a>01219    } <span class="keywordflow">else</span> {
<a name="l01220"></a>01220       chan2 = chan;
<a name="l01221"></a>01221    }
<a name="l01222"></a>01222    <span class="keywordflow">if</span> (chan) { <span class="comment">/* XXX isn't this chan2 ? */</span>
<a name="l01223"></a>01223       <a class="code" href="pbx_8c.html#7f62e5d5f926a2eeedb559b6afd3d80a">pbx_substitute_variables_helper</a>(chan2, argv[3], tmp, <span class="keyword">sizeof</span>(tmp) - 1);
<a name="l01224"></a>01224       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1 (%s)\n"</span>, tmp);
<a name="l01225"></a>01225    } <span class="keywordflow">else</span> {
<a name="l01226"></a>01226       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01227"></a>01227    }
<a name="l01228"></a>01228    <span class="keywordflow">if</span> (chan2 &amp;&amp; (chan2 != chan))
<a name="l01229"></a>01229       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(chan2);
<a name="l01230"></a>01230    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01231"></a>01231 }
<a name="l01232"></a>01232 
<a name="l01233"></a><a class="code" href="res__agi_8c.html#a70f54bf586ad67b28d6dc7d9ba1efbc">01233</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#41a087a72619630d56abab64d5cd459f">handle_verbose</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01234"></a>01234 {
<a name="l01235"></a>01235    <span class="keywordtype">int</span> level = 0;
<a name="l01236"></a>01236    <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#93583f8993b24e7afddf9578925bd1d8">prefix</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238    <span class="keywordflow">if</span> (argc &lt; 2)
<a name="l01239"></a>01239       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01240"></a>01240 
<a name="l01241"></a>01241    <span class="keywordflow">if</span> (argv[2])
<a name="l01242"></a>01242       sscanf(argv[2], <span class="stringliteral">"%d"</span>, &amp;level);
<a name="l01243"></a>01243 
<a name="l01244"></a>01244    <span class="keywordflow">switch</span> (level) {
<a name="l01245"></a>01245       <span class="keywordflow">case</span> 4:
<a name="l01246"></a>01246          prefix = <a class="code" href="logger_8h.html#8f25f582e7a737b25f607fb6ad653807">VERBOSE_PREFIX_4</a>;
<a name="l01247"></a>01247          <span class="keywordflow">break</span>;
<a name="l01248"></a>01248       <span class="keywordflow">case</span> 3:
<a name="l01249"></a>01249          prefix = <a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a>;
<a name="l01250"></a>01250          <span class="keywordflow">break</span>;
<a name="l01251"></a>01251       <span class="keywordflow">case</span> 2:
<a name="l01252"></a>01252          prefix = <a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a>;
<a name="l01253"></a>01253          <span class="keywordflow">break</span>;
<a name="l01254"></a>01254       <span class="keywordflow">case</span> 1:
<a name="l01255"></a>01255       <span class="keywordflow">default</span>:
<a name="l01256"></a>01256          prefix = <a class="code" href="logger_8h.html#be88e5e9e0316971a55422c09f04e996">VERBOSE_PREFIX_1</a>;
<a name="l01257"></a>01257          <span class="keywordflow">break</span>;
<a name="l01258"></a>01258    }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260    <span class="keywordflow">if</span> (level &lt;= <a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a>)
<a name="l01261"></a>01261       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"%s %s: %s\n"</span>, prefix, chan-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, argv[1]);
<a name="l01262"></a>01262    
<a name="l01263"></a>01263    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1\n"</span>);
<a name="l01264"></a>01264    
<a name="l01265"></a>01265    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267 
<a name="l01268"></a><a class="code" href="res__agi_8c.html#dc3355ca54239b950eceeb5bbaf366b5">01268</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#dc3355ca54239b950eceeb5bbaf366b5">handle_dbget</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270    <span class="keywordtype">int</span> res;
<a name="l01271"></a>01271    <span class="keywordtype">char</span> tmp[256];
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <span class="keywordflow">if</span> (argc != 4)
<a name="l01274"></a>01274       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01275"></a>01275    res = <a class="code" href="db_8c.html#b231f400b91f7d6fc366d33bf95beb5b">ast_db_get</a>(argv[2], argv[3], tmp, <span class="keyword">sizeof</span>(tmp));
<a name="l01276"></a>01276    <span class="keywordflow">if</span> (res) 
<a name="l01277"></a>01277       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01278"></a>01278    <span class="keywordflow">else</span>
<a name="l01279"></a>01279       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=1 (%s)\n"</span>, tmp);
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a><a class="code" href="res__agi_8c.html#2dbc5bbcc57d95ea9849fa1ad23b64d5">01284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2dbc5bbcc57d95ea9849fa1ad23b64d5">handle_dbput</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286    <span class="keywordtype">int</span> res;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288    <span class="keywordflow">if</span> (argc != 5)
<a name="l01289"></a>01289       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01290"></a>01290    res = <a class="code" href="db_8c.html#64bcb3650812a7f83ccc47971e23bedd">ast_db_put</a>(argv[2], argv[3], argv[4]);
<a name="l01291"></a>01291    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%c\n"</span>, res ? <span class="charliteral">'0'</span> : <span class="charliteral">'1'</span>);
<a name="l01292"></a>01292    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01293"></a>01293 }
<a name="l01294"></a>01294 
<a name="l01295"></a><a class="code" href="res__agi_8c.html#031edd8ef5519f6c69c53f3f611339e2">01295</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#031edd8ef5519f6c69c53f3f611339e2">handle_dbdel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01296"></a>01296 {
<a name="l01297"></a>01297    <span class="keywordtype">int</span> res;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    <span class="keywordflow">if</span> (argc != 4)
<a name="l01300"></a>01300       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01301"></a>01301    res = <a class="code" href="db_8c.html#c2c657f2d37dd1dc1aca774f16b5a4a4">ast_db_del</a>(argv[2], argv[3]);
<a name="l01302"></a>01302    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%c\n"</span>, res ? <span class="charliteral">'0'</span> : <span class="charliteral">'1'</span>);
<a name="l01303"></a>01303    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a><a class="code" href="res__agi_8c.html#bf75e76dfc30a7d4d5b1c44b545db375">01306</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#bf75e76dfc30a7d4d5b1c44b545db375">handle_dbdeltree</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308    <span class="keywordtype">int</span> res;
<a name="l01309"></a>01309    <span class="keywordflow">if</span> ((argc &lt; 3) || (argc &gt; 4))
<a name="l01310"></a>01310       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01311"></a>01311    <span class="keywordflow">if</span> (argc == 4)
<a name="l01312"></a>01312       res = <a class="code" href="db_8c.html#5d82f4659e09c74ec7d2509d149256f1">ast_db_deltree</a>(argv[2], argv[3]);
<a name="l01313"></a>01313    <span class="keywordflow">else</span>
<a name="l01314"></a>01314       res = <a class="code" href="db_8c.html#5d82f4659e09c74ec7d2509d149256f1">ast_db_deltree</a>(argv[2], NULL);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=%c\n"</span>, res ? <span class="charliteral">'0'</span> : <span class="charliteral">'1'</span>);
<a name="l01317"></a>01317    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01318"></a>01318 }
<a name="l01319"></a>01319 
<a name="l01320"></a><a class="code" href="res__agi_8c.html#1cb31a28c9ad667c4ff43a8ce64ab5c6">01320</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="rtp_8c.html#1cb31a28c9ad667c4ff43a8ce64ab5c6">debug_usage</a>[] = 
<a name="l01321"></a>01321 <span class="stringliteral">"Usage: agi debug\n"</span>
<a name="l01322"></a>01322 <span class="stringliteral">"       Enables dumping of AGI transactions for debugging purposes\n"</span>;
<a name="l01323"></a>01323 
<a name="l01324"></a><a class="code" href="res__agi_8c.html#ff2330b956119073430306e84dc3332c">01324</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="rtp_8c.html#ff2330b956119073430306e84dc3332c">no_debug_usage</a>[] = 
<a name="l01325"></a>01325 <span class="stringliteral">"Usage: agi nodebug\n"</span>
<a name="l01326"></a>01326 <span class="stringliteral">"       Disables dumping of AGI transactions for debugging purposes\n"</span>;
<a name="l01327"></a>01327 
<a name="l01328"></a><a class="code" href="res__agi_8c.html#a2b8aed0bf228bef263de39c54671673">01328</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a2b8aed0bf228bef263de39c54671673">agi_do_debug</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01329"></a>01329 {
<a name="l01330"></a>01330    <span class="keywordflow">if</span> (argc != 2)
<a name="l01331"></a>01331       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01332"></a>01332    <a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">agidebug</a> = 1;
<a name="l01333"></a>01333    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"AGI Debugging Enabled\n"</span>);
<a name="l01334"></a>01334    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 
<a name="l01337"></a><a class="code" href="res__agi_8c.html#2bd4822889d53862394a547c1d4da3f4">01337</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2bd4822889d53862394a547c1d4da3f4">agi_no_debug</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01338"></a>01338 {
<a name="l01339"></a>01339    <span class="keywordflow">if</span> (argc != 2)
<a name="l01340"></a>01340       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01341"></a>01341    <a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">agidebug</a> = 0;
<a name="l01342"></a>01342    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"AGI Debugging Disabled\n"</span>);
<a name="l01343"></a>01343    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01344"></a>01344 }
<a name="l01345"></a>01345 
<a name="l01346"></a><a class="code" href="res__agi_8c.html#e2abc80001dcb7a8c0b6f627e2bcb2ba">01346</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#e2abc80001dcb7a8c0b6f627e2bcb2ba">handle_noop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> arg, <span class="keywordtype">char</span> *argv[])
<a name="l01347"></a>01347 {
<a name="l01348"></a>01348    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01349"></a>01349    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a><a class="code" href="res__agi_8c.html#c0c715558f96cdc8459737c879c9f3ee">01352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#c0c715558f96cdc8459737c879c9f3ee">handle_setmusic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01353"></a>01353 {
<a name="l01354"></a>01354    <span class="keywordflow">if</span> (!strncasecmp(argv[2], <span class="stringliteral">"on"</span>, 2))
<a name="l01355"></a>01355       <a class="code" href="channel_8c.html#8b713a18df0470dcb9ad2b97c33b6e6a">ast_moh_start</a>(chan, argc &gt; 3 ? argv[3] : NULL, NULL);
<a name="l01356"></a>01356    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(argv[2], <span class="stringliteral">"off"</span>, 3))
<a name="l01357"></a>01357       <a class="code" href="channel_8c.html#db35d3bab46e0655f359b751cdca0ce3">ast_moh_stop</a>(chan);
<a name="l01358"></a>01358    <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"200 result=0\n"</span>);
<a name="l01359"></a>01359    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01360"></a>01360 }
<a name="l01361"></a>01361 
<a name="l01362"></a><a class="code" href="res__agi_8c.html#3798f388c9b73fdb143638c5315e0e8a">01362</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#3798f388c9b73fdb143638c5315e0e8a">usage_setmusic</a>[] =
<a name="l01363"></a>01363 <span class="stringliteral">" Usage: SET MUSIC ON &lt;on|off&gt; &lt;class&gt;\n"</span>
<a name="l01364"></a>01364 <span class="stringliteral">"  Enables/Disables the music on hold generator.  If &lt;class&gt; is\n"</span>
<a name="l01365"></a>01365 <span class="stringliteral">" not specified, then the default music on hold class will be used.\n"</span>
<a name="l01366"></a>01366 <span class="stringliteral">" Always returns 0.\n"</span>;
<a name="l01367"></a>01367 
<a name="l01368"></a><a class="code" href="res__agi_8c.html#a9d812a17ee18e5fa85178eff6d94f37">01368</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a9d812a17ee18e5fa85178eff6d94f37">usage_dbput</a>[] =
<a name="l01369"></a>01369 <span class="stringliteral">" Usage: DATABASE PUT &lt;family&gt; &lt;key&gt; &lt;value&gt;\n"</span>
<a name="l01370"></a>01370 <span class="stringliteral">"  Adds or updates an entry in the Asterisk database for a\n"</span>
<a name="l01371"></a>01371 <span class="stringliteral">" given family, key, and value.\n"</span>
<a name="l01372"></a>01372 <span class="stringliteral">" Returns 1 if successful, 0 otherwise.\n"</span>;
<a name="l01373"></a>01373 
<a name="l01374"></a><a class="code" href="res__agi_8c.html#5f738b86fe34d34cfee6ce6b46947123">01374</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#5f738b86fe34d34cfee6ce6b46947123">usage_dbget</a>[] =
<a name="l01375"></a>01375 <span class="stringliteral">" Usage: DATABASE GET &lt;family&gt; &lt;key&gt;\n"</span>
<a name="l01376"></a>01376 <span class="stringliteral">"  Retrieves an entry in the Asterisk database for a\n"</span>
<a name="l01377"></a>01377 <span class="stringliteral">" given family and key.\n"</span>
<a name="l01378"></a>01378 <span class="stringliteral">" Returns 0 if &lt;key&gt; is not set.  Returns 1 if &lt;key&gt;\n"</span>
<a name="l01379"></a>01379 <span class="stringliteral">" is set and returns the variable in parentheses.\n"</span>
<a name="l01380"></a>01380 <span class="stringliteral">" Example return code: 200 result=1 (testvariable)\n"</span>;
<a name="l01381"></a>01381 
<a name="l01382"></a><a class="code" href="res__agi_8c.html#c10d6783f1eea719753e5450411439e7">01382</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#c10d6783f1eea719753e5450411439e7">usage_dbdel</a>[] =
<a name="l01383"></a>01383 <span class="stringliteral">" Usage: DATABASE DEL &lt;family&gt; &lt;key&gt;\n"</span>
<a name="l01384"></a>01384 <span class="stringliteral">"  Deletes an entry in the Asterisk database for a\n"</span>
<a name="l01385"></a>01385 <span class="stringliteral">" given family and key.\n"</span>
<a name="l01386"></a>01386 <span class="stringliteral">" Returns 1 if successful, 0 otherwise.\n"</span>;
<a name="l01387"></a>01387 
<a name="l01388"></a><a class="code" href="res__agi_8c.html#9ff00532251e0f91a61f0464fe41f31c">01388</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#9ff00532251e0f91a61f0464fe41f31c">usage_dbdeltree</a>[] =
<a name="l01389"></a>01389 <span class="stringliteral">" Usage: DATABASE DELTREE &lt;family&gt; [keytree]\n"</span>
<a name="l01390"></a>01390 <span class="stringliteral">"  Deletes a family or specific keytree within a family\n"</span>
<a name="l01391"></a>01391 <span class="stringliteral">" in the Asterisk database.\n"</span>
<a name="l01392"></a>01392 <span class="stringliteral">" Returns 1 if successful, 0 otherwise.\n"</span>;
<a name="l01393"></a>01393 
<a name="l01394"></a><a class="code" href="res__agi_8c.html#b4544170311b7bad3e0e9753e978b2a8">01394</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#b4544170311b7bad3e0e9753e978b2a8">usage_verbose</a>[] =
<a name="l01395"></a>01395 <span class="stringliteral">" Usage: VERBOSE &lt;message&gt; &lt;level&gt;\n"</span>
<a name="l01396"></a>01396 <span class="stringliteral">"  Sends &lt;message&gt; to the console via verbose message system.\n"</span>
<a name="l01397"></a>01397 <span class="stringliteral">" &lt;level&gt; is the the verbose level (1-4)\n"</span>
<a name="l01398"></a>01398 <span class="stringliteral">" Always returns 1.\n"</span>;
<a name="l01399"></a>01399 
<a name="l01400"></a><a class="code" href="res__agi_8c.html#ef055ffa551dfae68e355b26323dbed1">01400</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#ef055ffa551dfae68e355b26323dbed1">usage_getvariable</a>[] =
<a name="l01401"></a>01401 <span class="stringliteral">" Usage: GET VARIABLE &lt;variablename&gt;\n"</span>
<a name="l01402"></a>01402 <span class="stringliteral">"  Returns 0 if &lt;variablename&gt; is not set.  Returns 1 if &lt;variablename&gt;\n"</span>
<a name="l01403"></a>01403 <span class="stringliteral">" is set and returns the variable in parentheses.\n"</span>
<a name="l01404"></a>01404 <span class="stringliteral">" example return code: 200 result=1 (testvariable)\n"</span>;
<a name="l01405"></a>01405 
<a name="l01406"></a><a class="code" href="res__agi_8c.html#b980eb9387953a5075d1983b4a1117d6">01406</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#b980eb9387953a5075d1983b4a1117d6">usage_getvariablefull</a>[] =
<a name="l01407"></a>01407 <span class="stringliteral">" Usage: GET FULL VARIABLE &lt;variablename&gt; [&lt;channel name&gt;]\n"</span>
<a name="l01408"></a>01408 <span class="stringliteral">"  Returns 0 if &lt;variablename&gt; is not set or channel does not exist.  Returns 1\n"</span>
<a name="l01409"></a>01409 <span class="stringliteral">"if &lt;variablename&gt;  is set and returns the variable in parenthesis.  Understands\n"</span>
<a name="l01410"></a>01410 <span class="stringliteral">"complex variable names and builtin variables, unlike GET VARIABLE.\n"</span>
<a name="l01411"></a>01411 <span class="stringliteral">" example return code: 200 result=1 (testvariable)\n"</span>;
<a name="l01412"></a>01412 
<a name="l01413"></a><a class="code" href="res__agi_8c.html#c228e3031e3d5b2f9658857cc7137ef5">01413</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#c228e3031e3d5b2f9658857cc7137ef5">usage_setvariable</a>[] =
<a name="l01414"></a>01414 <span class="stringliteral">" Usage: SET VARIABLE &lt;variablename&gt; &lt;value&gt;\n"</span>;
<a name="l01415"></a>01415 
<a name="l01416"></a><a class="code" href="res__agi_8c.html#dee294c1099a03265e9bc93f043ee9f6">01416</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#dee294c1099a03265e9bc93f043ee9f6">usage_channelstatus</a>[] =
<a name="l01417"></a>01417 <span class="stringliteral">" Usage: CHANNEL STATUS [&lt;channelname&gt;]\n"</span>
<a name="l01418"></a>01418 <span class="stringliteral">"  Returns the status of the specified channel.\n"</span> 
<a name="l01419"></a>01419 <span class="stringliteral">" If no channel name is given the returns the status of the\n"</span>
<a name="l01420"></a>01420 <span class="stringliteral">" current channel.  Return values:\n"</span>
<a name="l01421"></a>01421 <span class="stringliteral">"  0 Channel is down and available\n"</span>
<a name="l01422"></a>01422 <span class="stringliteral">"  1 Channel is down, but reserved\n"</span>
<a name="l01423"></a>01423 <span class="stringliteral">"  2 Channel is off hook\n"</span>
<a name="l01424"></a>01424 <span class="stringliteral">"  3 Digits (or equivalent) have been dialed\n"</span>
<a name="l01425"></a>01425 <span class="stringliteral">"  4 Line is ringing\n"</span>
<a name="l01426"></a>01426 <span class="stringliteral">"  5 Remote end is ringing\n"</span>
<a name="l01427"></a>01427 <span class="stringliteral">"  6 Line is up\n"</span>
<a name="l01428"></a>01428 <span class="stringliteral">"  7 Line is busy\n"</span>;
<a name="l01429"></a>01429 
<a name="l01430"></a><a class="code" href="res__agi_8c.html#d08280ffb41005b7ce4430791a28b4b7">01430</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#d08280ffb41005b7ce4430791a28b4b7">usage_setcallerid</a>[] =
<a name="l01431"></a>01431 <span class="stringliteral">" Usage: SET CALLERID &lt;number&gt;\n"</span>
<a name="l01432"></a>01432 <span class="stringliteral">"  Changes the callerid of the current channel.\n"</span>;
<a name="l01433"></a>01433 
<a name="l01434"></a><a class="code" href="res__agi_8c.html#331249f8333e7da6226795bc47dc82d3">01434</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#331249f8333e7da6226795bc47dc82d3">usage_exec</a>[] =
<a name="l01435"></a>01435 <span class="stringliteral">" Usage: EXEC &lt;application&gt; &lt;options&gt;\n"</span>
<a name="l01436"></a>01436 <span class="stringliteral">"  Executes &lt;application&gt; with given &lt;options&gt;.\n"</span>
<a name="l01437"></a>01437 <span class="stringliteral">" Returns whatever the application returns, or -2 on failure to find application\n"</span>;
<a name="l01438"></a>01438 
<a name="l01439"></a><a class="code" href="res__agi_8c.html#554be8e55d664108ce0a1a2048fd283b">01439</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#554be8e55d664108ce0a1a2048fd283b">usage_hangup</a>[] =
<a name="l01440"></a>01440 <span class="stringliteral">" Usage: HANGUP [&lt;channelname&gt;]\n"</span>
<a name="l01441"></a>01441 <span class="stringliteral">"  Hangs up the specified channel.\n"</span>
<a name="l01442"></a>01442 <span class="stringliteral">" If no channel name is given, hangs up the current channel\n"</span>;
<a name="l01443"></a>01443 
<a name="l01444"></a><a class="code" href="res__agi_8c.html#634e6379741151a7ab8e6585225f75fe">01444</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#634e6379741151a7ab8e6585225f75fe">usage_answer</a>[] = 
<a name="l01445"></a>01445 <span class="stringliteral">" Usage: ANSWER\n"</span>
<a name="l01446"></a>01446 <span class="stringliteral">"  Answers channel if not already in answer state. Returns -1 on\n"</span>
<a name="l01447"></a>01447 <span class="stringliteral">" channel failure, or 0 if successful.\n"</span>;
<a name="l01448"></a>01448 
<a name="l01449"></a><a class="code" href="res__agi_8c.html#a71de6692120cfdd0bb9512dc34f0969">01449</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a71de6692120cfdd0bb9512dc34f0969">usage_waitfordigit</a>[] = 
<a name="l01450"></a>01450 <span class="stringliteral">" Usage: WAIT FOR DIGIT &lt;timeout&gt;\n"</span>
<a name="l01451"></a>01451 <span class="stringliteral">"  Waits up to 'timeout' milliseconds for channel to receive a DTMF digit.\n"</span>
<a name="l01452"></a>01452 <span class="stringliteral">" Returns -1 on channel failure, 0 if no digit is received in the timeout, or\n"</span>
<a name="l01453"></a>01453 <span class="stringliteral">" the numerical value of the ascii of the digit if one is received.  Use -1\n"</span>
<a name="l01454"></a>01454 <span class="stringliteral">" for the timeout value if you desire the call to block indefinitely.\n"</span>;
<a name="l01455"></a>01455 
<a name="l01456"></a><a class="code" href="res__agi_8c.html#b5d10e76878d95b4b2b1cb4e1baee1aa">01456</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#b5d10e76878d95b4b2b1cb4e1baee1aa">usage_sendtext</a>[] =
<a name="l01457"></a>01457 <span class="stringliteral">" Usage: SEND TEXT \"&lt;text to send&gt;\"\n"</span>
<a name="l01458"></a>01458 <span class="stringliteral">"  Sends the given text on a channel. Most channels do not support the\n"</span>
<a name="l01459"></a>01459 <span class="stringliteral">" transmission of text.  Returns 0 if text is sent, or if the channel does not\n"</span>
<a name="l01460"></a>01460 <span class="stringliteral">" support text transmission.  Returns -1 only on error/hangup.  Text\n"</span>
<a name="l01461"></a>01461 <span class="stringliteral">" consisting of greater than one word should be placed in quotes since the\n"</span>
<a name="l01462"></a>01462 <span class="stringliteral">" command only accepts a single argument.\n"</span>;
<a name="l01463"></a>01463 
<a name="l01464"></a><a class="code" href="res__agi_8c.html#631b0de9df728240a261e6392b0e1708">01464</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#631b0de9df728240a261e6392b0e1708">usage_recvchar</a>[] =
<a name="l01465"></a>01465 <span class="stringliteral">" Usage: RECEIVE CHAR &lt;timeout&gt;\n"</span>
<a name="l01466"></a>01466 <span class="stringliteral">"  Receives a character of text on a channel. Specify timeout to be the\n"</span>
<a name="l01467"></a>01467 <span class="stringliteral">" maximum time to wait for input in milliseconds, or 0 for infinite. Most channels\n"</span>
<a name="l01468"></a>01468 <span class="stringliteral">" do not support the reception of text. Returns the decimal value of the character\n"</span>
<a name="l01469"></a>01469 <span class="stringliteral">" if one is received, or 0 if the channel does not support text reception.  Returns\n"</span>
<a name="l01470"></a>01470 <span class="stringliteral">" -1 only on error/hangup.\n"</span>;
<a name="l01471"></a>01471 
<a name="l01472"></a><a class="code" href="res__agi_8c.html#6dd8e633eaa3e911cc98e7747b4cc585">01472</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#6dd8e633eaa3e911cc98e7747b4cc585">usage_recvtext</a>[] =
<a name="l01473"></a>01473 <span class="stringliteral">" Usage: RECEIVE TEXT &lt;timeout&gt;\n"</span>
<a name="l01474"></a>01474 <span class="stringliteral">"  Receives a string of text on a channel. Specify timeout to be the\n"</span>
<a name="l01475"></a>01475 <span class="stringliteral">" maximum time to wait for input in milliseconds, or 0 for infinite. Most channels\n"</span>
<a name="l01476"></a>01476 <span class="stringliteral">" do not support the reception of text. Returns -1 for failure or 1 for success, and the string in parentheses.\n"</span>;
<a name="l01477"></a>01477 
<a name="l01478"></a><a class="code" href="res__agi_8c.html#64c993113659f5cc05e05fd870169313">01478</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#64c993113659f5cc05e05fd870169313">usage_tddmode</a>[] =
<a name="l01479"></a>01479 <span class="stringliteral">" Usage: TDD MODE &lt;on|off&gt;\n"</span>
<a name="l01480"></a>01480 <span class="stringliteral">"  Enable/Disable TDD transmission/reception on a channel. Returns 1 if\n"</span>
<a name="l01481"></a>01481 <span class="stringliteral">" successful, or 0 if channel is not TDD-capable.\n"</span>;
<a name="l01482"></a>01482 
<a name="l01483"></a><a class="code" href="res__agi_8c.html#740ff525d6f0c0130e49d79e39ad8350">01483</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#740ff525d6f0c0130e49d79e39ad8350">usage_sendimage</a>[] =
<a name="l01484"></a>01484 <span class="stringliteral">" Usage: SEND IMAGE &lt;image&gt;\n"</span>
<a name="l01485"></a>01485 <span class="stringliteral">"  Sends the given image on a channel. Most channels do not support the\n"</span>
<a name="l01486"></a>01486 <span class="stringliteral">" transmission of images. Returns 0 if image is sent, or if the channel does not\n"</span>
<a name="l01487"></a>01487 <span class="stringliteral">" support image transmission.  Returns -1 only on error/hangup. Image names\n"</span>
<a name="l01488"></a>01488 <span class="stringliteral">" should not include extensions.\n"</span>;
<a name="l01489"></a>01489 
<a name="l01490"></a><a class="code" href="res__agi_8c.html#f838dfe52f002224ad4991a2a60a603f">01490</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#f838dfe52f002224ad4991a2a60a603f">usage_streamfile</a>[] =
<a name="l01491"></a>01491 <span class="stringliteral">" Usage: STREAM FILE &lt;filename&gt; &lt;escape digits&gt; [sample offset]\n"</span>
<a name="l01492"></a>01492 <span class="stringliteral">"  Send the given file, allowing playback to be interrupted by the given\n"</span>
<a name="l01493"></a>01493 <span class="stringliteral">" digits, if any. Use double quotes for the digits if you wish none to be\n"</span>
<a name="l01494"></a>01494 <span class="stringliteral">" permitted. If sample offset is provided then the audio will seek to sample\n"</span>
<a name="l01495"></a>01495 <span class="stringliteral">" offset before play starts.  Returns 0 if playback completes without a digit\n"</span>
<a name="l01496"></a>01496 <span class="stringliteral">" being pressed, or the ASCII numerical value of the digit if one was pressed,\n"</span>
<a name="l01497"></a>01497 <span class="stringliteral">" or -1 on error or if the channel was disconnected. Remember, the file\n"</span>
<a name="l01498"></a>01498 <span class="stringliteral">" extension must not be included in the filename.\n"</span>;
<a name="l01499"></a>01499 
<a name="l01500"></a><a class="code" href="res__agi_8c.html#6c9e783dc286305d5f4bde2c5a7d5ce4">01500</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#6c9e783dc286305d5f4bde2c5a7d5ce4">usage_controlstreamfile</a>[] =
<a name="l01501"></a>01501 <span class="stringliteral">" Usage: CONTROL STREAM FILE &lt;filename&gt; &lt;escape digits&gt; [skipms] [ffchar] [rewchr] [pausechr]\n"</span>
<a name="l01502"></a>01502 <span class="stringliteral">"  Send the given file, allowing playback to be controled by the given\n"</span>
<a name="l01503"></a>01503 <span class="stringliteral">" digits, if any. Use double quotes for the digits if you wish none to be\n"</span>
<a name="l01504"></a>01504 <span class="stringliteral">" permitted.  Returns 0 if playback completes without a digit\n"</span>
<a name="l01505"></a>01505 <span class="stringliteral">" being pressed, or the ASCII numerical value of the digit if one was pressed,\n"</span>
<a name="l01506"></a>01506 <span class="stringliteral">" or -1 on error or if the channel was disconnected. Remember, the file\n"</span>
<a name="l01507"></a>01507 <span class="stringliteral">" extension must not be included in the filename.\n\n"</span>
<a name="l01508"></a>01508 <span class="stringliteral">" Note: ffchar and rewchar default to * and # respectively.\n"</span>;
<a name="l01509"></a>01509 
<a name="l01510"></a><a class="code" href="res__agi_8c.html#4204f0100e8abb3c51b72a6d4cbee074">01510</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#4204f0100e8abb3c51b72a6d4cbee074">usage_getoption</a>[] = 
<a name="l01511"></a>01511 <span class="stringliteral">" Usage: GET OPTION &lt;filename&gt; &lt;escape_digits&gt; [timeout]\n"</span>
<a name="l01512"></a>01512 <span class="stringliteral">"  Behaves similar to STREAM FILE but used with a timeout option.\n"</span>;
<a name="l01513"></a>01513 
<a name="l01514"></a><a class="code" href="res__agi_8c.html#805c6b7f726efae2f7f2c28d22d1997e">01514</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#805c6b7f726efae2f7f2c28d22d1997e">usage_saynumber</a>[] =
<a name="l01515"></a>01515 <span class="stringliteral">" Usage: SAY NUMBER &lt;number&gt; &lt;escape digits&gt; [gender]\n"</span>
<a name="l01516"></a>01516 <span class="stringliteral">"  Say a given number, returning early if any of the given DTMF digits\n"</span>
<a name="l01517"></a>01517 <span class="stringliteral">" are received on the channel.  Returns 0 if playback completes without a digit\n"</span>
<a name="l01518"></a>01518 <span class="stringliteral">" being pressed, or the ASCII numerical value of the digit if one was pressed or\n"</span>
<a name="l01519"></a>01519 <span class="stringliteral">" -1 on error/hangup.\n"</span>;
<a name="l01520"></a>01520 
<a name="l01521"></a><a class="code" href="res__agi_8c.html#a0160a9147f86329400f3a3cd1c6fc42">01521</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a0160a9147f86329400f3a3cd1c6fc42">usage_saydigits</a>[] =
<a name="l01522"></a>01522 <span class="stringliteral">" Usage: SAY DIGITS &lt;number&gt; &lt;escape digits&gt;\n"</span>
<a name="l01523"></a>01523 <span class="stringliteral">"  Say a given digit string, returning early if any of the given DTMF digits\n"</span>
<a name="l01524"></a>01524 <span class="stringliteral">" are received on the channel. Returns 0 if playback completes without a digit\n"</span>
<a name="l01525"></a>01525 <span class="stringliteral">" being pressed, or the ASCII numerical value of the digit if one was pressed or\n"</span>
<a name="l01526"></a>01526 <span class="stringliteral">" -1 on error/hangup.\n"</span>;
<a name="l01527"></a>01527 
<a name="l01528"></a><a class="code" href="res__agi_8c.html#d462ccbacb8fa3c8d28c51a3adcdbe09">01528</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#d462ccbacb8fa3c8d28c51a3adcdbe09">usage_sayalpha</a>[] =
<a name="l01529"></a>01529 <span class="stringliteral">" Usage: SAY ALPHA &lt;number&gt; &lt;escape digits&gt;\n"</span>
<a name="l01530"></a>01530 <span class="stringliteral">"  Say a given character string, returning early if any of the given DTMF digits\n"</span>
<a name="l01531"></a>01531 <span class="stringliteral">" are received on the channel. Returns 0 if playback completes without a digit\n"</span>
<a name="l01532"></a>01532 <span class="stringliteral">" being pressed, or the ASCII numerical value of the digit if one was pressed or\n"</span>
<a name="l01533"></a>01533 <span class="stringliteral">" -1 on error/hangup.\n"</span>;
<a name="l01534"></a>01534 
<a name="l01535"></a><a class="code" href="res__agi_8c.html#c5fa409a8fb14027654420d0861f198c">01535</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#c5fa409a8fb14027654420d0861f198c">usage_saydate</a>[] =
<a name="l01536"></a>01536 <span class="stringliteral">" Usage: SAY DATE &lt;date&gt; &lt;escape digits&gt;\n"</span>
<a name="l01537"></a>01537 <span class="stringliteral">"  Say a given date, returning early if any of the given DTMF digits are\n"</span>
<a name="l01538"></a>01538 <span class="stringliteral">" received on the channel.  &lt;date&gt; is number of seconds elapsed since 00:00:00\n"</span>
<a name="l01539"></a>01539 <span class="stringliteral">" on January 1, 1970, Coordinated Universal Time (UTC). Returns 0 if playback\n"</span>
<a name="l01540"></a>01540 <span class="stringliteral">" completes without a digit being pressed, or the ASCII numerical value of the\n"</span>
<a name="l01541"></a>01541 <span class="stringliteral">" digit if one was pressed or -1 on error/hangup.\n"</span>;
<a name="l01542"></a>01542 
<a name="l01543"></a><a class="code" href="res__agi_8c.html#a48955c60ad2535bd3244decd61ae17a">01543</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#a48955c60ad2535bd3244decd61ae17a">usage_saytime</a>[] =
<a name="l01544"></a>01544 <span class="stringliteral">" Usage: SAY TIME &lt;time&gt; &lt;escape digits&gt;\n"</span>
<a name="l01545"></a>01545 <span class="stringliteral">"  Say a given time, returning early if any of the given DTMF digits are\n"</span>
<a name="l01546"></a>01546 <span class="stringliteral">" received on the channel.  &lt;time&gt; is number of seconds elapsed since 00:00:00\n"</span>
<a name="l01547"></a>01547 <span class="stringliteral">" on January 1, 1970, Coordinated Universal Time (UTC). Returns 0 if playback\n"</span>
<a name="l01548"></a>01548 <span class="stringliteral">" completes without a digit being pressed, or the ASCII numerical value of the\n"</span>
<a name="l01549"></a>01549 <span class="stringliteral">" digit if one was pressed or -1 on error/hangup.\n"</span>;
<a name="l01550"></a>01550 
<a name="l01551"></a><a class="code" href="res__agi_8c.html#1e822fb304655513d90e41dfefb0ec59">01551</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#1e822fb304655513d90e41dfefb0ec59">usage_saydatetime</a>[] =
<a name="l01552"></a>01552 <span class="stringliteral">" Usage: SAY DATETIME &lt;time&gt; &lt;escape digits&gt; [format] [timezone]\n"</span>
<a name="l01553"></a>01553 <span class="stringliteral">"  Say a given time, returning early if any of the given DTMF digits are\n"</span>
<a name="l01554"></a>01554 <span class="stringliteral">" received on the channel.  &lt;time&gt; is number of seconds elapsed since 00:00:00\n"</span>
<a name="l01555"></a>01555 <span class="stringliteral">" on January 1, 1970, Coordinated Universal Time (UTC). [format] is the format\n"</span>
<a name="l01556"></a>01556 <span class="stringliteral">" the time should be said in.  See voicemail.conf (defaults to \"ABdY\n"</span>
<a name="l01557"></a>01557 <span class="stringliteral">" 'digits/at' IMp\").  Acceptable values for [timezone] can be found in\n"</span>
<a name="l01558"></a>01558 <span class="stringliteral">" /usr/share/zoneinfo.  Defaults to machine default. Returns 0 if playback\n"</span>
<a name="l01559"></a>01559 <span class="stringliteral">" completes without a digit being pressed, or the ASCII numerical value of the\n"</span>
<a name="l01560"></a>01560 <span class="stringliteral">" digit if one was pressed or -1 on error/hangup.\n"</span>;
<a name="l01561"></a>01561 
<a name="l01562"></a><a class="code" href="res__agi_8c.html#1a6e1fae21a1f6805feb04f6ff8c186d">01562</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#1a6e1fae21a1f6805feb04f6ff8c186d">usage_sayphonetic</a>[] =
<a name="l01563"></a>01563 <span class="stringliteral">" Usage: SAY PHONETIC &lt;string&gt; &lt;escape digits&gt;\n"</span>
<a name="l01564"></a>01564 <span class="stringliteral">"  Say a given character string with phonetics, returning early if any of the\n"</span>
<a name="l01565"></a>01565 <span class="stringliteral">" given DTMF digits are received on the channel. Returns 0 if playback\n"</span>
<a name="l01566"></a>01566 <span class="stringliteral">" completes without a digit pressed, the ASCII numerical value of the digit\n"</span>
<a name="l01567"></a>01567 <span class="stringliteral">" if one was pressed, or -1 on error/hangup.\n"</span>;
<a name="l01568"></a>01568 
<a name="l01569"></a><a class="code" href="res__agi_8c.html#13b752e7b1cd984530cdf86b30f56f2a">01569</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#13b752e7b1cd984530cdf86b30f56f2a">usage_getdata</a>[] =
<a name="l01570"></a>01570 <span class="stringliteral">" Usage: GET DATA &lt;file to be streamed&gt; [timeout] [max digits]\n"</span>
<a name="l01571"></a>01571 <span class="stringliteral">"  Stream the given file, and recieve DTMF data. Returns the digits received\n"</span>
<a name="l01572"></a>01572 <span class="stringliteral">"from the channel at the other end.\n"</span>;
<a name="l01573"></a>01573 
<a name="l01574"></a><a class="code" href="res__agi_8c.html#f553a12f5791876f6877a4773484d3c0">01574</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#f553a12f5791876f6877a4773484d3c0">usage_setcontext</a>[] =
<a name="l01575"></a>01575 <span class="stringliteral">" Usage: SET CONTEXT &lt;desired context&gt;\n"</span>
<a name="l01576"></a>01576 <span class="stringliteral">"  Sets the context for continuation upon exiting the application.\n"</span>;
<a name="l01577"></a>01577 
<a name="l01578"></a><a class="code" href="res__agi_8c.html#0eec60b21fc8da70f496e1507154e710">01578</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#0eec60b21fc8da70f496e1507154e710">usage_setextension</a>[] =
<a name="l01579"></a>01579 <span class="stringliteral">" Usage: SET EXTENSION &lt;new extension&gt;\n"</span>
<a name="l01580"></a>01580 <span class="stringliteral">"  Changes the extension for continuation upon exiting the application.\n"</span>;
<a name="l01581"></a>01581 
<a name="l01582"></a><a class="code" href="res__agi_8c.html#1e847a46f1e9eb58116cebc958ad2e19">01582</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#1e847a46f1e9eb58116cebc958ad2e19">usage_setpriority</a>[] =
<a name="l01583"></a>01583 <span class="stringliteral">" Usage: SET PRIORITY &lt;priority&gt;\n"</span>
<a name="l01584"></a>01584 <span class="stringliteral">"  Changes the priority for continuation upon exiting the application.\n"</span>
<a name="l01585"></a>01585 <span class="stringliteral">" The priority must be a valid priority or label.\n"</span>;
<a name="l01586"></a>01586 
<a name="l01587"></a><a class="code" href="res__agi_8c.html#efe587d12429f79d542237c7203ea6c9">01587</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#efe587d12429f79d542237c7203ea6c9">usage_recordfile</a>[] =
<a name="l01588"></a>01588 <span class="stringliteral">" Usage: RECORD FILE &lt;filename&gt; &lt;format&gt; &lt;escape digits&gt; &lt;timeout&gt; \\\n"</span>
<a name="l01589"></a>01589 <span class="stringliteral">"                                          [offset samples] [BEEP] [s=silence]\n"</span>
<a name="l01590"></a>01590 <span class="stringliteral">"  Record to a file until a given dtmf digit in the sequence is received\n"</span>
<a name="l01591"></a>01591 <span class="stringliteral">" Returns -1 on hangup or error.  The format will specify what kind of file\n"</span>
<a name="l01592"></a>01592 <span class="stringliteral">" will be recorded.  The timeout is the maximum record time in milliseconds, or\n"</span>
<a name="l01593"></a>01593 <span class="stringliteral">" -1 for no timeout. \"Offset samples\" is optional, and, if provided, will seek\n"</span>
<a name="l01594"></a>01594 <span class="stringliteral">" to the offset without exceeding the end of the file.  \"silence\" is the number\n"</span>
<a name="l01595"></a>01595 <span class="stringliteral">" of seconds of silence allowed before the function returns despite the\n"</span>
<a name="l01596"></a>01596 <span class="stringliteral">" lack of dtmf digits or reaching timeout.  Silence value must be\n"</span>
<a name="l01597"></a>01597 <span class="stringliteral">" preceeded by \"s=\" and is also optional.\n"</span>;
<a name="l01598"></a>01598 
<a name="l01599"></a><a class="code" href="res__agi_8c.html#121309fca6f63ea3de12a3beba194c64">01599</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#121309fca6f63ea3de12a3beba194c64">usage_autohangup</a>[] =
<a name="l01600"></a>01600 <span class="stringliteral">" Usage: SET AUTOHANGUP &lt;time&gt;\n"</span>
<a name="l01601"></a>01601 <span class="stringliteral">"  Cause the channel to automatically hangup at &lt;time&gt; seconds in the\n"</span>
<a name="l01602"></a>01602 <span class="stringliteral">" future.  Of course it can be hungup before then as well. Setting to 0 will\n"</span>
<a name="l01603"></a>01603 <span class="stringliteral">" cause the autohangup feature to be disabled on this channel.\n"</span>;
<a name="l01604"></a>01604 
<a name="l01605"></a><a class="code" href="res__agi_8c.html#2887e4ec35618ce7d6da8fa5eb3566d8">01605</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#2887e4ec35618ce7d6da8fa5eb3566d8">usage_noop</a>[] =
<a name="l01606"></a>01606 <span class="stringliteral">" Usage: NoOp\n"</span>
<a name="l01607"></a>01607 <span class="stringliteral">"  Does nothing.\n"</span>;
<a name="l01608"></a>01608 
<a name="l01609"></a><a class="code" href="res__agi_8c.html#ef2dcba5b54f6ff2ee5aa71379266f8b">01609</a> <span class="keyword">static</span> <a class="code" href="structagi__command.html">agi_command</a> <a class="code" href="res__agi_8c.html#ef2dcba5b54f6ff2ee5aa71379266f8b">commands</a>[<a class="code" href="res__agi_8c.html#9569e6c05b17196be7c63c6bf9170a62">MAX_COMMANDS</a>] = {
<a name="l01610"></a>01610    { { <span class="stringliteral">"answer"</span>, NULL }, <a class="code" href="res__agi_8c.html#bc2b7a25cf3bcaa42b1363105c57d6f7">handle_answer</a>, <span class="stringliteral">"Answer channel"</span>, usage_answer },
<a name="l01611"></a>01611    { { <span class="stringliteral">"channel"</span>, <span class="stringliteral">"status"</span>, NULL }, <a class="code" href="res__agi_8c.html#9790dda5dc67ae37ee9f32971892cf1e">handle_channelstatus</a>, <span class="stringliteral">"Returns status of the connected channel"</span>, usage_channelstatus },
<a name="l01612"></a>01612    { { <span class="stringliteral">"database"</span>, <span class="stringliteral">"del"</span>, NULL }, <a class="code" href="res__agi_8c.html#031edd8ef5519f6c69c53f3f611339e2">handle_dbdel</a>, <span class="stringliteral">"Removes database key/value"</span>, usage_dbdel },
<a name="l01613"></a>01613    { { <span class="stringliteral">"database"</span>, <span class="stringliteral">"deltree"</span>, NULL }, <a class="code" href="res__agi_8c.html#bf75e76dfc30a7d4d5b1c44b545db375">handle_dbdeltree</a>, <span class="stringliteral">"Removes database keytree/value"</span>, usage_dbdeltree },
<a name="l01614"></a>01614    { { <span class="stringliteral">"database"</span>, <span class="stringliteral">"get"</span>, NULL }, <a class="code" href="res__agi_8c.html#dc3355ca54239b950eceeb5bbaf366b5">handle_dbget</a>, <span class="stringliteral">"Gets database value"</span>, usage_dbget },
<a name="l01615"></a>01615    { { <span class="stringliteral">"database"</span>, <span class="stringliteral">"put"</span>, NULL }, <a class="code" href="res__agi_8c.html#2dbc5bbcc57d95ea9849fa1ad23b64d5">handle_dbput</a>, <span class="stringliteral">"Adds/updates database value"</span>, usage_dbput },
<a name="l01616"></a>01616    { { <span class="stringliteral">"exec"</span>, NULL }, <a class="code" href="res__agi_8c.html#978503dfa71afeb5d8aaa6a9d5004ca8">handle_exec</a>, <span class="stringliteral">"Executes a given Application"</span>, usage_exec },
<a name="l01617"></a>01617    { { <span class="stringliteral">"get"</span>, <span class="stringliteral">"data"</span>, NULL }, <a class="code" href="res__agi_8c.html#d422d9d9963d1e0253d2321938b3d20b">handle_getdata</a>, <span class="stringliteral">"Prompts for DTMF on a channel"</span>, usage_getdata },
<a name="l01618"></a>01618    { { <span class="stringliteral">"get"</span>, <span class="stringliteral">"full"</span>, <span class="stringliteral">"variable"</span>, NULL }, <a class="code" href="res__agi_8c.html#06e17409e5839609597864ce6705df45">handle_getvariablefull</a>, <span class="stringliteral">"Evaluates a channel expression"</span>, usage_getvariablefull },
<a name="l01619"></a>01619    { { <span class="stringliteral">"get"</span>, <span class="stringliteral">"option"</span>, NULL }, <a class="code" href="res__agi_8c.html#27ff6c8a89a9b9d9301e6094da06be5e">handle_getoption</a>, <span class="stringliteral">"Stream file, prompt for DTMF, with timeout"</span>, usage_getoption },
<a name="l01620"></a>01620    { { <span class="stringliteral">"get"</span>, <span class="stringliteral">"variable"</span>, NULL }, <a class="code" href="res__agi_8c.html#8bb0c9d9cadd2694bd9b8aaf40ef4cf9">handle_getvariable</a>, <span class="stringliteral">"Gets a channel variable"</span>, usage_getvariable },
<a name="l01621"></a>01621    { { <span class="stringliteral">"hangup"</span>, NULL }, <a class="code" href="res__agi_8c.html#e773232abfe9d3c84aef94491654c392">handle_hangup</a>, <span class="stringliteral">"Hangup the current channel"</span>, usage_hangup },
<a name="l01622"></a>01622    { { <span class="stringliteral">"noop"</span>, NULL }, <a class="code" href="res__agi_8c.html#e2abc80001dcb7a8c0b6f627e2bcb2ba">handle_noop</a>, <span class="stringliteral">"Does nothing"</span>, usage_noop },
<a name="l01623"></a>01623    { { <span class="stringliteral">"receive"</span>, <span class="stringliteral">"char"</span>, NULL }, <a class="code" href="res__agi_8c.html#8742911cf7c3a9e7a5ab1edd68a41e3e">handle_recvchar</a>, <span class="stringliteral">"Receives one character from channels supporting it"</span>, usage_recvchar },
<a name="l01624"></a>01624    { { <span class="stringliteral">"receive"</span>, <span class="stringliteral">"text"</span>, NULL }, <a class="code" href="res__agi_8c.html#9d24ec4282973b3631a1c11c766fee5d">handle_recvtext</a>, <span class="stringliteral">"Receives text from channels supporting it"</span>, usage_recvtext },
<a name="l01625"></a>01625    { { <span class="stringliteral">"record"</span>, <span class="stringliteral">"file"</span>, NULL }, <a class="code" href="res__agi_8c.html#9342d35e8dd1034d9524e3a66ffbddde">handle_recordfile</a>, <span class="stringliteral">"Records to a given file"</span>, usage_recordfile },
<a name="l01626"></a>01626    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"alpha"</span>, NULL }, <a class="code" href="res__agi_8c.html#1ca39ec03dfc8fe7cf5b3c14ee8f6ac9">handle_sayalpha</a>, <span class="stringliteral">"Says a given character string"</span>, usage_sayalpha },
<a name="l01627"></a>01627    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"digits"</span>, NULL }, <a class="code" href="res__agi_8c.html#9f62c0d7b3a64c5a00af91bdf4fb618c">handle_saydigits</a>, <span class="stringliteral">"Says a given digit string"</span>, usage_saydigits },
<a name="l01628"></a>01628    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"number"</span>, NULL }, <a class="code" href="res__agi_8c.html#0214c88314778e13476a773217054195">handle_saynumber</a>, <span class="stringliteral">"Says a given number"</span>, usage_saynumber },
<a name="l01629"></a>01629    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"phonetic"</span>, NULL }, <a class="code" href="res__agi_8c.html#6eb408169ba980d5e7b7c541674e35a3">handle_sayphonetic</a>, <span class="stringliteral">"Says a given character string with phonetics"</span>, usage_sayphonetic },
<a name="l01630"></a>01630    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"date"</span>, NULL }, <a class="code" href="res__agi_8c.html#65c8361f5e927a4bffc4fda2fbc6ca6a">handle_saydate</a>, <span class="stringliteral">"Says a given date"</span>, usage_saydate },
<a name="l01631"></a>01631    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"time"</span>, NULL }, <a class="code" href="res__agi_8c.html#07ef45783df80aed83fc5dd0f04350b9">handle_saytime</a>, <span class="stringliteral">"Says a given time"</span>, usage_saytime },
<a name="l01632"></a>01632    { { <span class="stringliteral">"say"</span>, <span class="stringliteral">"datetime"</span>, NULL }, <a class="code" href="res__agi_8c.html#784bb215b82e98d8ec2be943bbae44d2">handle_saydatetime</a>, <span class="stringliteral">"Says a given time as specfied by the format given"</span>, usage_saydatetime },
<a name="l01633"></a>01633    { { <span class="stringliteral">"send"</span>, <span class="stringliteral">"image"</span>, NULL }, <a class="code" href="res__agi_8c.html#5712452818e483e2c1a90a0318abcc24">handle_sendimage</a>, <span class="stringliteral">"Sends images to channels supporting it"</span>, usage_sendimage },
<a name="l01634"></a>01634    { { <span class="stringliteral">"send"</span>, <span class="stringliteral">"text"</span>, NULL }, <a class="code" href="res__agi_8c.html#2e21a47bde6e1f60c9fa240f8a1fada2">handle_sendtext</a>, <span class="stringliteral">"Sends text to channels supporting it"</span>, usage_sendtext },
<a name="l01635"></a>01635    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"autohangup"</span>, NULL }, <a class="code" href="res__agi_8c.html#a478e5a58f8a036278d9b707f902352e">handle_autohangup</a>, <span class="stringliteral">"Autohangup channel in some time"</span>, usage_autohangup },
<a name="l01636"></a>01636    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"callerid"</span>, NULL }, <a class="code" href="res__agi_8c.html#a86683e6156a5763449d4690a0e348de">handle_setcallerid</a>, <span class="stringliteral">"Sets callerid for the current channel"</span>, usage_setcallerid },
<a name="l01637"></a>01637    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"context"</span>, NULL }, <a class="code" href="res__agi_8c.html#6224d740431aae48e658420734c90768">handle_setcontext</a>, <span class="stringliteral">"Sets channel context"</span>, usage_setcontext },
<a name="l01638"></a>01638    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"extension"</span>, NULL }, <a class="code" href="res__agi_8c.html#a3911dab7741715253611d0dd36ff871">handle_setextension</a>, <span class="stringliteral">"Changes channel extension"</span>, usage_setextension },
<a name="l01639"></a>01639    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"music"</span>, NULL }, <a class="code" href="res__agi_8c.html#c0c715558f96cdc8459737c879c9f3ee">handle_setmusic</a>, <span class="stringliteral">"Enable/Disable Music on hold generator"</span>, usage_setmusic },
<a name="l01640"></a>01640    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"priority"</span>, NULL }, <a class="code" href="res__agi_8c.html#8d44f893b0f3d7778ba0e428c4b04adf">handle_setpriority</a>, <span class="stringliteral">"Set channel dialplan priority"</span>, usage_setpriority },
<a name="l01641"></a>01641    { { <span class="stringliteral">"set"</span>, <span class="stringliteral">"variable"</span>, NULL }, <a class="code" href="res__agi_8c.html#f460620c4d77c64c3c3d2411b687902f">handle_setvariable</a>, <span class="stringliteral">"Sets a channel variable"</span>, usage_setvariable },
<a name="l01642"></a>01642    { { <span class="stringliteral">"stream"</span>, <span class="stringliteral">"file"</span>, NULL }, <a class="code" href="res__agi_8c.html#cc1de4a44a54813f1d218afbe8895ba4">handle_streamfile</a>, <span class="stringliteral">"Sends audio file on channel"</span>, usage_streamfile },
<a name="l01643"></a>01643    { { <span class="stringliteral">"control"</span>, <span class="stringliteral">"stream"</span>, <span class="stringliteral">"file"</span>, NULL }, <a class="code" href="res__agi_8c.html#419ad0794400314f52b9ae921cbfa20b">handle_controlstreamfile</a>, <span class="stringliteral">"Sends audio file on channel and allows the listner to control the stream"</span>, usage_controlstreamfile },
<a name="l01644"></a>01644    { { <span class="stringliteral">"tdd"</span>, <span class="stringliteral">"mode"</span>, NULL }, <a class="code" href="res__agi_8c.html#2a9076635913f8aab2dac377c3618c7e">handle_tddmode</a>, <span class="stringliteral">"Toggles TDD mode (for the deaf)"</span>, usage_tddmode },
<a name="l01645"></a>01645    { { <span class="stringliteral">"verbose"</span>, NULL }, <a class="code" href="cli_8c.html#41a087a72619630d56abab64d5cd459f">handle_verbose</a>, <span class="stringliteral">"Logs a message to the asterisk verbose log"</span>, usage_verbose },
<a name="l01646"></a>01646    { { <span class="stringliteral">"wait"</span>, <span class="stringliteral">"for"</span>, <span class="stringliteral">"digit"</span>, NULL }, <a class="code" href="res__agi_8c.html#a8f58b66977ab3a1b90857dbd95be7d3">handle_waitfordigit</a>, <span class="stringliteral">"Waits for a digit to be pressed"</span>, usage_waitfordigit },
<a name="l01647"></a>01647 };
<a name="l01648"></a>01648 
<a name="l01649"></a><a class="code" href="res__agi_8c.html#985dbb98038d34194e35c1311baaf75c">01649</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#985dbb98038d34194e35c1311baaf75c">help_workhorse</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#b5f545ec55667a61a75dd2047251b4ac">match</a>[])
<a name="l01650"></a>01650 {
<a name="l01651"></a>01651    <span class="keywordtype">char</span> fullcmd[80];
<a name="l01652"></a>01652    <span class="keywordtype">char</span> matchstr[80];
<a name="l01653"></a>01653    <span class="keywordtype">int</span> x;
<a name="l01654"></a>01654    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l01655"></a>01655    <span class="keywordflow">if</span> (match)
<a name="l01656"></a>01656       <a class="code" href="utils_8c.html#33e7834c0d3de361f490e1c744011610">ast_join</a>(matchstr, <span class="keyword">sizeof</span>(matchstr), match);
<a name="l01657"></a>01657    <span class="keywordflow">for</span> (x=0;x&lt;<span class="keyword">sizeof</span>(commands)/<span class="keyword">sizeof</span>(commands[0]);x++) {
<a name="l01658"></a>01658       e = &amp;commands[x]; 
<a name="l01659"></a>01659       <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0])
<a name="l01660"></a>01660          <span class="keywordflow">break</span>;
<a name="l01661"></a>01661       <span class="comment">/* Hide commands that start with '_' */</span>
<a name="l01662"></a>01662       <span class="keywordflow">if</span> ((e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0])[0] == <span class="charliteral">'_'</span>)
<a name="l01663"></a>01663          <span class="keywordflow">continue</span>;
<a name="l01664"></a>01664       <a class="code" href="utils_8c.html#33e7834c0d3de361f490e1c744011610">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>);
<a name="l01665"></a>01665       <span class="keywordflow">if</span> (match &amp;&amp; strncasecmp(matchstr, fullcmd, strlen(matchstr)))
<a name="l01666"></a>01666          <span class="keywordflow">continue</span>;
<a name="l01667"></a>01667       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%20.20s   %s\n"</span>, fullcmd, e-&gt;<a class="code" href="structagi__command.html#a80da1282f2c775bbc5f2c92c836968b">summary</a>);
<a name="l01668"></a>01668    }
<a name="l01669"></a>01669    <span class="keywordflow">return</span> 0;
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01672"></a><a class="code" href="res__agi_8c.html#83d6f4a6fc6358efaacab70833cf7557">01672</a> <span class="keywordtype">int</span> <a class="code" href="agi_8h.html#7932e77d451cee1b6617188dc7e95e41">ast_agi_register</a>(<a class="code" href="structagi__command.html">agi_command</a> *agi)
<a name="l01673"></a>01673 {
<a name="l01674"></a>01674    <span class="keywordtype">int</span> x;
<a name="l01675"></a>01675    <span class="keywordflow">for</span> (x=0; x&lt;<a class="code" href="res__agi_8c.html#9569e6c05b17196be7c63c6bf9170a62">MAX_COMMANDS</a> - 1; x++) {
<a name="l01676"></a>01676       <span class="keywordflow">if</span> (commands[x].<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0] == agi-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0]) {
<a name="l01677"></a>01677          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Command already registered!\n"</span>);
<a name="l01678"></a>01678          <span class="keywordflow">return</span> -1;
<a name="l01679"></a>01679       }
<a name="l01680"></a>01680    }
<a name="l01681"></a>01681    <span class="keywordflow">for</span> (x=0; x&lt;<a class="code" href="res__agi_8c.html#9569e6c05b17196be7c63c6bf9170a62">MAX_COMMANDS</a> - 1; x++) {
<a name="l01682"></a>01682       <span class="keywordflow">if</span> (!commands[x].<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0]) {
<a name="l01683"></a>01683          commands[x] = *agi;
<a name="l01684"></a>01684          <span class="keywordflow">return</span> 0;
<a name="l01685"></a>01685       }
<a name="l01686"></a>01686    }
<a name="l01687"></a>01687    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No more room for new commands!\n"</span>);
<a name="l01688"></a>01688    <span class="keywordflow">return</span> -1;
<a name="l01689"></a>01689 }
<a name="l01690"></a>01690 
<a name="l01691"></a><a class="code" href="res__agi_8c.html#b86289e0d82948344c853db7c17738be">01691</a> <span class="keywordtype">void</span> <a class="code" href="agi_8h.html#a5ee8e2ee6cf7f37ce26c85611b69903">ast_agi_unregister</a>(<a class="code" href="structagi__command.html">agi_command</a> *agi)
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693    <span class="keywordtype">int</span> x;
<a name="l01694"></a>01694    <span class="keywordflow">for</span> (x=0; x&lt;<a class="code" href="res__agi_8c.html#9569e6c05b17196be7c63c6bf9170a62">MAX_COMMANDS</a> - 1; x++) {
<a name="l01695"></a>01695       <span class="keywordflow">if</span> (commands[x].<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0] == agi-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0]) {
<a name="l01696"></a>01696          memset(&amp;commands[x], 0, <span class="keyword">sizeof</span>(<a class="code" href="structagi__command.html">agi_command</a>));
<a name="l01697"></a>01697       }
<a name="l01698"></a>01698    }
<a name="l01699"></a>01699 }
<a name="l01700"></a>01700 
<a name="l01701"></a><a class="code" href="res__agi_8c.html#1fc9826322aaeff0b4e10e0b998642da">01701</a> <span class="keyword">static</span> <a class="code" href="structagi__command.html">agi_command</a> *<a class="code" href="chan__mgcp_8c.html#23024e5b84152d75c2151fd7c49db1e9">find_command</a>(<span class="keywordtype">char</span> *cmds[], <span class="keywordtype">int</span> exact)
<a name="l01702"></a>01702 {
<a name="l01703"></a>01703    <span class="keywordtype">int</span> x;
<a name="l01704"></a>01704    <span class="keywordtype">int</span> y;
<a name="l01705"></a>01705    <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#b5f545ec55667a61a75dd2047251b4ac">match</a>;
<a name="l01706"></a>01706 
<a name="l01707"></a>01707    <span class="keywordflow">for</span> (x=0; x &lt; <span class="keyword">sizeof</span>(commands) / <span class="keyword">sizeof</span>(commands[0]); x++) {
<a name="l01708"></a>01708       <span class="keywordflow">if</span> (!commands[x].<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0])
<a name="l01709"></a>01709          <span class="keywordflow">break</span>;
<a name="l01710"></a>01710       <span class="comment">/* start optimistic */</span>
<a name="l01711"></a>01711       match = 1;
<a name="l01712"></a>01712       <span class="keywordflow">for</span> (y=0; match &amp;&amp; cmds[y]; y++) {
<a name="l01713"></a>01713          <span class="comment">/* If there are no more words in the command (and we're looking for</span>
<a name="l01714"></a>01714 <span class="comment">            an exact match) or there is a difference between the two words,</span>
<a name="l01715"></a>01715 <span class="comment">            then this is not a match */</span>
<a name="l01716"></a>01716          <span class="keywordflow">if</span> (!commands[x].cmda[y] &amp;&amp; !exact)
<a name="l01717"></a>01717             <span class="keywordflow">break</span>;
<a name="l01718"></a>01718          <span class="comment">/* don't segfault if the next part of a command doesn't exist */</span>
<a name="l01719"></a>01719          <span class="keywordflow">if</span> (!commands[x].cmda[y])
<a name="l01720"></a>01720             <span class="keywordflow">return</span> NULL;
<a name="l01721"></a>01721          <span class="keywordflow">if</span> (strcasecmp(commands[x].cmda[y], cmds[y]))
<a name="l01722"></a>01722             match = 0;
<a name="l01723"></a>01723       }
<a name="l01724"></a>01724       <span class="comment">/* If more words are needed to complete the command then this is not</span>
<a name="l01725"></a>01725 <span class="comment">         a candidate (unless we're looking for a really inexact answer  */</span>
<a name="l01726"></a>01726       <span class="keywordflow">if</span> ((exact &gt; -1) &amp;&amp; commands[x].cmda[y])
<a name="l01727"></a>01727          match = 0;
<a name="l01728"></a>01728       <span class="keywordflow">if</span> (match)
<a name="l01729"></a>01729          <span class="keywordflow">return</span> &amp;commands[x];
<a name="l01730"></a>01730    }
<a name="l01731"></a>01731    <span class="keywordflow">return</span> NULL;
<a name="l01732"></a>01732 }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 
<a name="l01735"></a><a class="code" href="res__agi_8c.html#d1258e504fe6c13b8fcd63c573f6ed7d">01735</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#e01ab49bede0d1e1f151dc1380d1038a">parse_args</a>(<span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> *max, <span class="keywordtype">char</span> *argv[])
<a name="l01736"></a>01736 {
<a name="l01737"></a>01737    <span class="keywordtype">int</span> x=0;
<a name="l01738"></a>01738    <span class="keywordtype">int</span> quoted=0;
<a name="l01739"></a>01739    <span class="keywordtype">int</span> escaped=0;
<a name="l01740"></a>01740    <span class="keywordtype">int</span> whitespace=1;
<a name="l01741"></a>01741    <span class="keywordtype">char</span> *cur;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743    cur = s;
<a name="l01744"></a>01744    <span class="keywordflow">while</span>(*s) {
<a name="l01745"></a>01745       <span class="keywordflow">switch</span>(*s) {
<a name="l01746"></a>01746       <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
<a name="l01747"></a>01747          <span class="comment">/* If it's escaped, put a literal quote */</span>
<a name="l01748"></a>01748          <span class="keywordflow">if</span> (escaped) 
<a name="l01749"></a>01749             <span class="keywordflow">goto</span> normal;
<a name="l01750"></a>01750          <span class="keywordflow">else</span> 
<a name="l01751"></a>01751             quoted = !quoted;
<a name="l01752"></a>01752          <span class="keywordflow">if</span> (quoted &amp;&amp; whitespace) {
<a name="l01753"></a>01753             <span class="comment">/* If we're starting a quote, coming off white space start a new word, too */</span>
<a name="l01754"></a>01754             argv[x++] = cur;
<a name="l01755"></a>01755             whitespace=0;
<a name="l01756"></a>01756          }
<a name="l01757"></a>01757          escaped = 0;
<a name="l01758"></a>01758       <span class="keywordflow">break</span>;
<a name="l01759"></a>01759       <span class="keywordflow">case</span> <span class="charliteral">' '</span>:
<a name="l01760"></a>01760       <span class="keywordflow">case</span> <span class="charliteral">'\t'</span>:
<a name="l01761"></a>01761          <span class="keywordflow">if</span> (!quoted &amp;&amp; !escaped) {
<a name="l01762"></a>01762             <span class="comment">/* If we're not quoted, mark this as whitespace, and</span>
<a name="l01763"></a>01763 <span class="comment">               end the previous argument */</span>
<a name="l01764"></a>01764             whitespace = 1;
<a name="l01765"></a>01765             *(cur++) = <span class="charliteral">'\0'</span>;
<a name="l01766"></a>01766          } <span class="keywordflow">else</span>
<a name="l01767"></a>01767             <span class="comment">/* Otherwise, just treat it as anything else */</span> 
<a name="l01768"></a>01768             <span class="keywordflow">goto</span> normal;
<a name="l01769"></a>01769          <span class="keywordflow">break</span>;
<a name="l01770"></a>01770       <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
<a name="l01771"></a>01771          <span class="comment">/* If we're escaped, print a literal, otherwise enable escaping */</span>
<a name="l01772"></a>01772          <span class="keywordflow">if</span> (escaped) {
<a name="l01773"></a>01773             <span class="keywordflow">goto</span> normal;
<a name="l01774"></a>01774          } <span class="keywordflow">else</span> {
<a name="l01775"></a>01775             escaped=1;
<a name="l01776"></a>01776          }
<a name="l01777"></a>01777          <span class="keywordflow">break</span>;
<a name="l01778"></a>01778       <span class="keywordflow">default</span>:
<a name="l01779"></a>01779 normal:
<a name="l01780"></a>01780          <span class="keywordflow">if</span> (whitespace) {
<a name="l01781"></a>01781             <span class="keywordflow">if</span> (x &gt;= <a class="code" href="app__macro_8c.html#89467a4d712211f900a9a31bcc5a5f63">MAX_ARGS</a> -1) {
<a name="l01782"></a>01782                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Too many arguments, truncating\n"</span>);
<a name="l01783"></a>01783                <span class="keywordflow">break</span>;
<a name="l01784"></a>01784             }
<a name="l01785"></a>01785             <span class="comment">/* Coming off of whitespace, start the next argument */</span>
<a name="l01786"></a>01786             argv[x++] = cur;
<a name="l01787"></a>01787             whitespace=0;
<a name="l01788"></a>01788          }
<a name="l01789"></a>01789          *(cur++) = *s;
<a name="l01790"></a>01790          escaped=0;
<a name="l01791"></a>01791       }
<a name="l01792"></a>01792       s++;
<a name="l01793"></a>01793    }
<a name="l01794"></a>01794    <span class="comment">/* Null terminate */</span>
<a name="l01795"></a>01795    *(cur++) = <span class="charliteral">'\0'</span>;
<a name="l01796"></a>01796    argv[x] = NULL;
<a name="l01797"></a>01797    *max = x;
<a name="l01798"></a>01798    <span class="keywordflow">return</span> 0;
<a name="l01799"></a>01799 }
<a name="l01800"></a>01800 
<a name="l01801"></a><a class="code" href="res__agi_8c.html#2257b93fdaede07f69d4b0dddde94e23">01801</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2257b93fdaede07f69d4b0dddde94e23">agi_handle_command</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>)
<a name="l01802"></a>01802 {
<a name="l01803"></a>01803    <span class="keywordtype">char</span> *argv[<a class="code" href="app__macro_8c.html#89467a4d712211f900a9a31bcc5a5f63">MAX_ARGS</a>];
<a name="l01804"></a>01804    <span class="keywordtype">int</span> argc = <a class="code" href="app__macro_8c.html#89467a4d712211f900a9a31bcc5a5f63">MAX_ARGS</a>;
<a name="l01805"></a>01805    <span class="keywordtype">int</span> res;
<a name="l01806"></a>01806    <a class="code" href="structagi__command.html">agi_command</a> *c;
<a name="l01807"></a>01807 
<a name="l01808"></a>01808    <a class="code" href="cli_8c.html#e01ab49bede0d1e1f151dc1380d1038a">parse_args</a>(buf, &amp;argc, argv);
<a name="l01809"></a>01809    c = <a class="code" href="chan__mgcp_8c.html#23024e5b84152d75c2151fd7c49db1e9">find_command</a>(argv, 0);
<a name="l01810"></a>01810    <span class="keywordflow">if</span> (c) {
<a name="l01811"></a>01811       res = c-&gt;<a class="code" href="structagi__command.html#4226c36eb5bac75be08ed80b3b9d10a5">handler</a>(chan, agi, argc, argv);
<a name="l01812"></a>01812       <span class="keywordflow">switch</span>(res) {
<a name="l01813"></a>01813       <span class="keywordflow">case</span> RESULT_SHOWUSAGE:
<a name="l01814"></a>01814          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"520-Invalid command syntax.  Proper usage follows:\n"</span>);
<a name="l01815"></a>01815          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, c-&gt;<a class="code" href="structagi__command.html#9366282e11c151558bdfaab4a264aa1b">usage</a>);
<a name="l01816"></a>01816          <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, <span class="stringliteral">"520 End of proper usage.\n"</span>);
<a name="l01817"></a>01817          <span class="keywordflow">break</span>;
<a name="l01818"></a>01818       <span class="keywordflow">case</span> <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a>:
<a name="l01819"></a>01819          <span class="comment">/* We've been asked to keep alive, so do so */</span>
<a name="l01820"></a>01820          <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a>;
<a name="l01821"></a>01821          <span class="keywordflow">break</span>;
<a name="l01822"></a>01822       <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>:
<a name="l01823"></a>01823          <span class="comment">/* They've already given the failure.  We've been hung up on so handle this</span>
<a name="l01824"></a>01824 <span class="comment">            appropriately */</span>
<a name="l01825"></a>01825          <span class="keywordflow">return</span> -1;
<a name="l01826"></a>01826       }
<a name="l01827"></a>01827    } <span class="keywordflow">else</span> {
<a name="l01828"></a>01828       <a class="code" href="res__agi_8c.html#030cda5a10c55e8880999891715f40be">fdprintf</a>(agi-&gt;fd, <span class="stringliteral">"510 Invalid or unknown command\n"</span>);
<a name="l01829"></a>01829    }
<a name="l01830"></a>01830    <span class="keywordflow">return</span> 0;
<a name="l01831"></a>01831 }
<a name="l01832"></a><a class="code" href="res__agi_8c.html#c0cc02c3b3d55abb7bfb49ddbb4866c8">01832</a> <span class="preprocessor">#define RETRY  3</span>
<a name="l01833"></a><a class="code" href="res__agi_8c.html#62f311affcf7fd5992804e1a93dc6bfe">01833</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> <a class="code" href="res__agi_8c.html#62f311affcf7fd5992804e1a93dc6bfe">run_agi</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">char</span> *request, <a class="code" href="structagi__state.html">AGI</a> *agi, <span class="keywordtype">int</span> pid, <span class="keywordtype">int</span> *status, <span class="keywordtype">int</span> dead, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01834"></a>01834 {
<a name="l01835"></a>01835    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c;
<a name="l01836"></a>01836    <span class="keywordtype">int</span> outfd;
<a name="l01837"></a>01837    <span class="keywordtype">int</span> ms;
<a name="l01838"></a>01838    <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> returnstatus = <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>;
<a name="l01839"></a>01839    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01840"></a>01840    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[2048];
<a name="l01841"></a>01841    FILE *readf;
<a name="l01842"></a>01842    <span class="comment">/* how many times we'll retry if ast_waitfor_nandfs will return without either </span>
<a name="l01843"></a>01843 <span class="comment">     channel or file descriptor in case select is interrupted by a system call (EINTR) */</span>
<a name="l01844"></a>01844    <span class="keywordtype">int</span> retry = <a class="code" href="res__agi_8c.html#c0cc02c3b3d55abb7bfb49ddbb4866c8">RETRY</a>;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846    <span class="keywordflow">if</span> (!(readf = fdopen(agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>, <span class="stringliteral">"r"</span>))) {
<a name="l01847"></a>01847       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to fdopen file descriptor\n"</span>);
<a name="l01848"></a>01848       <span class="keywordflow">if</span> (pid &gt; -1)
<a name="l01849"></a>01849          kill(pid, SIGHUP);
<a name="l01850"></a>01850       close(agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>);
<a name="l01851"></a>01851       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l01852"></a>01852    }
<a name="l01853"></a>01853    setlinebuf(readf);
<a name="l01854"></a>01854    <a class="code" href="res__agi_8c.html#f311427971734204f497772df9a4b4c1">setup_env</a>(chan, request, agi-&gt;<a class="code" href="structagi__state.html#36eba1e1e343279857ea7f69a597324e">fd</a>, (agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a> &gt; -1), argc, argv);
<a name="l01855"></a>01855    <span class="keywordflow">for</span> (;;) {
<a name="l01856"></a>01856       ms = -1;
<a name="l01857"></a>01857       c = <a class="code" href="channel_8c.html#d1d8604e3228763d140c1bd188e3618d">ast_waitfor_nandfds</a>(&amp;chan, dead ? 0 : 1, &amp;agi-&gt;<a class="code" href="structagi__state.html#bbf7ea1d373e03d16d1418909b05eaf6">ctrl</a>, 1, NULL, &amp;outfd, &amp;ms);
<a name="l01858"></a>01858       <span class="keywordflow">if</span> (c) {
<a name="l01859"></a>01859          retry = <a class="code" href="res__agi_8c.html#c0cc02c3b3d55abb7bfb49ddbb4866c8">RETRY</a>;
<a name="l01860"></a>01860          <span class="comment">/* Idle the channel until we get a command */</span>
<a name="l01861"></a>01861          f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(c);
<a name="l01862"></a>01862          <span class="keywordflow">if</span> (!f) {
<a name="l01863"></a>01863             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01864"></a>01864                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"%s hungup\n"</span>, chan-&gt;name);
<a name="l01865"></a>01865             returnstatus = <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635ce08c955da0991c983be1ef35d678bf8e">AGI_RESULT_HANGUP</a>;
<a name="l01866"></a>01866             <span class="keywordflow">break</span>;
<a name="l01867"></a>01867          } <span class="keywordflow">else</span> {
<a name="l01868"></a>01868             <span class="comment">/* If it's voice, write it to the audio pipe */</span>
<a name="l01869"></a>01869             <span class="keywordflow">if</span> ((agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a> &gt; -1) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>)) {
<a name="l01870"></a>01870                <span class="comment">/* Write, ignoring errors */</span>
<a name="l01871"></a>01871                write(agi-&gt;<a class="code" href="structagi__state.html#a5ca0b5894324f8bb54bb9fffad29d1e">audio</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l01872"></a>01872             }
<a name="l01873"></a>01873             <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01874"></a>01874          }
<a name="l01875"></a>01875       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) {
<a name="l01876"></a>01876          retry = <a class="code" href="res__agi_8c.html#c0cc02c3b3d55abb7bfb49ddbb4866c8">RETRY</a>;
<a name="l01877"></a>01877          <span class="keywordflow">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), readf)) {
<a name="l01878"></a>01878             <span class="comment">/* Program terminated */</span>
<a name="l01879"></a>01879             <span class="keywordflow">if</span> (returnstatus)
<a name="l01880"></a>01880                returnstatus = -1;
<a name="l01881"></a>01881             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l01882"></a>01882                <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"AGI Script %s completed, returning %d\n"</span>, request, returnstatus);
<a name="l01883"></a>01883             <span class="keywordflow">if</span> (pid &gt; 0)
<a name="l01884"></a>01884                waitpid(pid, status, 0);
<a name="l01885"></a>01885             <span class="comment">/* No need to kill the pid anymore, since they closed us */</span>
<a name="l01886"></a>01886             pid = -1;
<a name="l01887"></a>01887             <span class="keywordflow">break</span>;
<a name="l01888"></a>01888          }
<a name="l01889"></a>01889          <span class="comment">/* get rid of trailing newline, if any */</span>
<a name="l01890"></a>01890          <span class="keywordflow">if</span> (*buf &amp;&amp; buf[strlen(buf) - 1] == <span class="charliteral">'\n'</span>)
<a name="l01891"></a>01891             buf[strlen(buf) - 1] = 0;
<a name="l01892"></a>01892          <span class="keywordflow">if</span> (<a class="code" href="res__agi_8c.html#7e0ab7a5e62508bffb28b8927f955cb4">agidebug</a>)
<a name="l01893"></a>01893             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"AGI Rx &lt;&lt; %s\n"</span>, buf);
<a name="l01894"></a>01894          returnstatus |= <a class="code" href="res__agi_8c.html#2257b93fdaede07f69d4b0dddde94e23">agi_handle_command</a>(chan, agi, buf);
<a name="l01895"></a>01895          <span class="comment">/* If the handle_command returns -1, we need to stop */</span>
<a name="l01896"></a>01896          <span class="keywordflow">if</span> ((returnstatus &lt; 0) || (returnstatus == <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a>)) {
<a name="l01897"></a>01897             <span class="keywordflow">break</span>;
<a name="l01898"></a>01898          }
<a name="l01899"></a>01899       } <span class="keywordflow">else</span> {
<a name="l01900"></a>01900          <span class="keywordflow">if</span> (--retry &lt;= 0) {
<a name="l01901"></a>01901             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No channel, no fd?\n"</span>);
<a name="l01902"></a>01902             returnstatus = <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l01903"></a>01903             <span class="keywordflow">break</span>;
<a name="l01904"></a>01904          }
<a name="l01905"></a>01905       }
<a name="l01906"></a>01906    }
<a name="l01907"></a>01907    <span class="comment">/* Notify process */</span>
<a name="l01908"></a>01908    <span class="keywordflow">if</span> (pid &gt; -1) {
<a name="l01909"></a>01909       <span class="keyword">const</span> <span class="keywordtype">char</span> *sighup = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"AGISIGHUP"</span>);
<a name="l01910"></a>01910       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(sighup) || !<a class="code" href="utils_8c.html#b293ff11e14865b872f7430896646c2e">ast_false</a>(sighup)) {
<a name="l01911"></a>01911          <span class="keywordflow">if</span> (kill(pid, SIGHUP))
<a name="l01912"></a>01912             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"unable to send SIGHUP to AGI process %d: %s\n"</span>, pid, strerror(errno));
<a name="l01913"></a>01913       }
<a name="l01914"></a>01914    }
<a name="l01915"></a>01915    fclose(readf);
<a name="l01916"></a>01916    <span class="keywordflow">return</span> returnstatus;
<a name="l01917"></a>01917 }
<a name="l01918"></a>01918 
<a name="l01919"></a><a class="code" href="res__agi_8c.html#2d117104c6721f110ab453fd8a6ebb56">01919</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#2d117104c6721f110ab453fd8a6ebb56">handle_showagi</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01920"></a>01920 {
<a name="l01921"></a>01921    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l01922"></a>01922    <span class="keywordtype">char</span> fullcmd[80];
<a name="l01923"></a>01923    <span class="keywordflow">if</span> ((argc &lt; 2))
<a name="l01924"></a>01924       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01925"></a>01925    <span class="keywordflow">if</span> (argc &gt; 2) {
<a name="l01926"></a>01926       e = <a class="code" href="chan__mgcp_8c.html#23024e5b84152d75c2151fd7c49db1e9">find_command</a>(argv + 2, 1);
<a name="l01927"></a>01927       <span class="keywordflow">if</span> (e) 
<a name="l01928"></a>01928          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, e-&gt;<a class="code" href="structagi__command.html#9366282e11c151558bdfaab4a264aa1b">usage</a>);
<a name="l01929"></a>01929       <span class="keywordflow">else</span> {
<a name="l01930"></a>01930          <span class="keywordflow">if</span> (<a class="code" href="chan__mgcp_8c.html#23024e5b84152d75c2151fd7c49db1e9">find_command</a>(argv + 2, -1)) {
<a name="l01931"></a>01931             <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#985dbb98038d34194e35c1311baaf75c">help_workhorse</a>(fd, argv + 1);
<a name="l01932"></a>01932          } <span class="keywordflow">else</span> {
<a name="l01933"></a>01933             <a class="code" href="utils_8c.html#33e7834c0d3de361f490e1c744011610">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), argv+1);
<a name="l01934"></a>01934             <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"No such command '%s'.\n"</span>, fullcmd);
<a name="l01935"></a>01935          }
<a name="l01936"></a>01936       }
<a name="l01937"></a>01937    } <span class="keywordflow">else</span> {
<a name="l01938"></a>01938       <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#985dbb98038d34194e35c1311baaf75c">help_workhorse</a>(fd, NULL);
<a name="l01939"></a>01939    }
<a name="l01940"></a>01940    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 <span class="comment"></span>
<a name="l01943"></a>01943 <span class="comment">/*! \brief Convert string to use HTML escaped characters</span>
<a name="l01944"></a>01944 <span class="comment">   \note Maybe this should be a generic function?</span>
<a name="l01945"></a>01945 <span class="comment">*/</span>
<a name="l01946"></a><a class="code" href="res__agi_8c.html#ffb9df0ec08d01ab5b4647298904f91a">01946</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__agi_8c.html#ffb9df0ec08d01ab5b4647298904f91a">write_html_escaped</a>(FILE *htmlfile, <span class="keywordtype">char</span> *str)
<a name="l01947"></a>01947 {
<a name="l01948"></a>01948    <span class="keywordtype">char</span> *cur = str;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950    <span class="keywordflow">while</span>(*cur) {
<a name="l01951"></a>01951       <span class="keywordflow">switch</span> (*cur) {
<a name="l01952"></a>01952       <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>:
<a name="l01953"></a>01953          fprintf(htmlfile, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"&amp;lt;"</span>);
<a name="l01954"></a>01954          <span class="keywordflow">break</span>;
<a name="l01955"></a>01955       <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>:
<a name="l01956"></a>01956          fprintf(htmlfile, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"&amp;gt;"</span>);
<a name="l01957"></a>01957          <span class="keywordflow">break</span>;
<a name="l01958"></a>01958       <span class="keywordflow">case</span> <span class="charliteral">'&amp;'</span>:
<a name="l01959"></a>01959          fprintf(htmlfile, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"&amp;amp;"</span>);
<a name="l01960"></a>01960          <span class="keywordflow">break</span>;
<a name="l01961"></a>01961       <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
<a name="l01962"></a>01962          fprintf(htmlfile, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"&amp;quot;"</span>);
<a name="l01963"></a>01963          <span class="keywordflow">break</span>;
<a name="l01964"></a>01964       <span class="keywordflow">default</span>:
<a name="l01965"></a>01965          fprintf(htmlfile, <span class="stringliteral">"%c"</span>, *cur);
<a name="l01966"></a>01966          <span class="keywordflow">break</span>;
<a name="l01967"></a>01967       }
<a name="l01968"></a>01968       cur++;
<a name="l01969"></a>01969    }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971    <span class="keywordflow">return</span>;
<a name="l01972"></a>01972 }
<a name="l01973"></a>01973 
<a name="l01974"></a><a class="code" href="res__agi_8c.html#74adbe4887b465e17905ea48bd08c744">01974</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#74adbe4887b465e17905ea48bd08c744">handle_agidumphtml</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l01975"></a>01975 {
<a name="l01976"></a>01976    <span class="keyword">struct </span><a class="code" href="structagi__command.html">agi_command</a> *e;
<a name="l01977"></a>01977    <span class="keywordtype">char</span> fullcmd[80];
<a name="l01978"></a>01978    <span class="keywordtype">int</span> x;
<a name="l01979"></a>01979    FILE *htmlfile;
<a name="l01980"></a>01980 
<a name="l01981"></a>01981    <span class="keywordflow">if</span> ((argc &lt; 3))
<a name="l01982"></a>01982       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01983"></a>01983 
<a name="l01984"></a>01984    <span class="keywordflow">if</span> (!(htmlfile = fopen(argv[2], <span class="stringliteral">"wt"</span>))) {
<a name="l01985"></a>01985       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Could not create file '%s'\n"</span>, argv[2]);
<a name="l01986"></a>01986       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l01987"></a>01987    }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989    fprintf(htmlfile, <span class="stringliteral">"&lt;HTML&gt;\n&lt;HEAD&gt;\n&lt;TITLE&gt;AGI Commands&lt;/TITLE&gt;\n&lt;/HEAD&gt;\n"</span>);
<a name="l01990"></a>01990    fprintf(htmlfile, <span class="stringliteral">"&lt;BODY&gt;\n&lt;CENTER&gt;&lt;B&gt;&lt;H1&gt;AGI Commands&lt;/H1&gt;&lt;/B&gt;&lt;/CENTER&gt;\n\n"</span>);
<a name="l01991"></a>01991 
<a name="l01992"></a>01992 
<a name="l01993"></a>01993    fprintf(htmlfile, <span class="stringliteral">"&lt;TABLE BORDER=\"0\" CELLSPACING=\"10\"&gt;\n"</span>);
<a name="l01994"></a>01994 
<a name="l01995"></a>01995    <span class="keywordflow">for</span> (x=0;x&lt;<span class="keyword">sizeof</span>(commands)/<span class="keyword">sizeof</span>(commands[0]);x++) {
<a name="l01996"></a>01996       <span class="keywordtype">char</span> *stringp, *tempstr;
<a name="l01997"></a>01997 
<a name="l01998"></a>01998       e = &amp;commands[x]; 
<a name="l01999"></a>01999       <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0])  <span class="comment">/* end ? */</span>
<a name="l02000"></a>02000          <span class="keywordflow">break</span>;
<a name="l02001"></a>02001       <span class="comment">/* Hide commands that start with '_' */</span>
<a name="l02002"></a>02002       <span class="keywordflow">if</span> ((e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>[0])[0] == <span class="charliteral">'_'</span>)
<a name="l02003"></a>02003          <span class="keywordflow">continue</span>;
<a name="l02004"></a>02004       <a class="code" href="utils_8c.html#33e7834c0d3de361f490e1c744011610">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), e-&gt;<a class="code" href="structagi__command.html#ec27655330419638d73b5c69b3f1168e">cmda</a>);
<a name="l02005"></a>02005 
<a name="l02006"></a>02006       fprintf(htmlfile, <span class="stringliteral">"&lt;TR&gt;&lt;TD&gt;&lt;TABLE BORDER=\"1\" CELLPADDING=\"5\" WIDTH=\"100%%\"&gt;\n"</span>);
<a name="l02007"></a>02007       fprintf(htmlfile, <span class="stringliteral">"&lt;TR&gt;&lt;TH ALIGN=\"CENTER\"&gt;&lt;B&gt;%s - %s&lt;/B&gt;&lt;/TH&gt;&lt;/TR&gt;\n"</span>, fullcmd,e-&gt;<a class="code" href="structagi__command.html#a80da1282f2c775bbc5f2c92c836968b">summary</a>);
<a name="l02008"></a>02008 
<a name="l02009"></a>02009       stringp=e-&gt;<a class="code" href="structagi__command.html#9366282e11c151558bdfaab4a264aa1b">usage</a>;
<a name="l02010"></a>02010       tempstr = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">"\n"</span>);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012       fprintf(htmlfile, <span class="stringliteral">"&lt;TR&gt;&lt;TD ALIGN=\"CENTER\"&gt;"</span>);
<a name="l02013"></a>02013       <a class="code" href="res__agi_8c.html#ffb9df0ec08d01ab5b4647298904f91a">write_html_escaped</a>(htmlfile, tempstr);
<a name="l02014"></a>02014       fprintf(htmlfile, <span class="stringliteral">"&lt;/TD&gt;&lt;/TR&gt;\n"</span>);
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       
<a name="l02017"></a>02017       fprintf(htmlfile, <span class="stringliteral">"&lt;TR&gt;&lt;TD ALIGN=\"CENTER\"&gt;\n"</span>);
<a name="l02018"></a>02018       <span class="keywordflow">while</span> ((tempstr = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">"\n"</span>)) != NULL) {
<a name="l02019"></a>02019          <a class="code" href="res__agi_8c.html#ffb9df0ec08d01ab5b4647298904f91a">write_html_escaped</a>(htmlfile, tempstr);
<a name="l02020"></a>02020          fprintf(htmlfile, <span class="stringliteral">"&lt;BR&gt;\n"</span>);
<a name="l02021"></a>02021       }
<a name="l02022"></a>02022       fprintf(htmlfile, <span class="stringliteral">"&lt;/TD&gt;&lt;/TR&gt;\n"</span>);
<a name="l02023"></a>02023       fprintf(htmlfile, <span class="stringliteral">"&lt;/TABLE&gt;&lt;/TD&gt;&lt;/TR&gt;\n\n"</span>);
<a name="l02024"></a>02024 
<a name="l02025"></a>02025    }
<a name="l02026"></a>02026 
<a name="l02027"></a>02027    fprintf(htmlfile, <span class="stringliteral">"&lt;/TABLE&gt;\n&lt;/BODY&gt;\n&lt;/HTML&gt;\n"</span>);
<a name="l02028"></a>02028    fclose(htmlfile);
<a name="l02029"></a>02029    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"AGI HTML Commands Dumped to: %s\n"</span>, argv[2]);
<a name="l02030"></a>02030    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l02031"></a>02031 }
<a name="l02032"></a>02032 
<a name="l02033"></a><a class="code" href="res__agi_8c.html#0ea89d2e6426c93f601bf23abbd53aed">02033</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#0ea89d2e6426c93f601bf23abbd53aed">agi_exec_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> enhanced, <span class="keywordtype">int</span> dead)
<a name="l02034"></a>02034 {
<a name="l02035"></a>02035    <span class="keyword">enum</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c">agi_result</a> res;
<a name="l02036"></a>02036    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l02037"></a>02037    <span class="keywordtype">char</span> *argv[<a class="code" href="app__macro_8c.html#89467a4d712211f900a9a31bcc5a5f63">MAX_ARGS</a>];
<a name="l02038"></a>02038    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[2048]=<span class="stringliteral">""</span>;
<a name="l02039"></a>02039    <span class="keywordtype">char</span> *tmp = buf;
<a name="l02040"></a>02040    <span class="keywordtype">int</span> argc = 0;
<a name="l02041"></a>02041    <span class="keywordtype">int</span> fds[2];
<a name="l02042"></a>02042    <span class="keywordtype">int</span> efd = -1;
<a name="l02043"></a>02043    <span class="keywordtype">int</span> pid;
<a name="l02044"></a>02044         <span class="keywordtype">char</span> *stringp;
<a name="l02045"></a>02045    <a class="code" href="structagi__state.html">AGI</a> agi;
<a name="l02046"></a>02046 
<a name="l02047"></a>02047    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(data)) {
<a name="l02048"></a>02048       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"AGI requires an argument (script)\n"</span>);
<a name="l02049"></a>02049       <span class="keywordflow">return</span> -1;
<a name="l02050"></a>02050    }
<a name="l02051"></a>02051    ast_copy_string(buf, data, <span class="keyword">sizeof</span>(buf));
<a name="l02052"></a>02052 
<a name="l02053"></a>02053    memset(&amp;agi, 0, <span class="keyword">sizeof</span>(agi));
<a name="l02054"></a>02054         <span class="keywordflow">while</span> ((stringp = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp, <span class="stringliteral">"|"</span>)) &amp;&amp; argc &lt; <a class="code" href="app__macro_8c.html#89467a4d712211f900a9a31bcc5a5f63">MAX_ARGS</a>-1)
<a name="l02055"></a>02055       argv[argc++] = stringp;
<a name="l02056"></a>02056    argv[argc] = NULL;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058    u = <a class="code" href="module_8h.html#01229151b3816d7323f7460fef4305c3">ast_module_user_add</a>(chan);
<a name="l02059"></a>02059 <span class="preprocessor">#if 0</span>
<a name="l02060"></a>02060 <span class="preprocessor"></span>    <span class="comment">/* Answer if need be */</span>
<a name="l02061"></a>02061         <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) {
<a name="l02062"></a>02062       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan)) {
<a name="l02063"></a>02063          LOCAL_USER_REMOVE(u);
<a name="l02064"></a>02064          <span class="keywordflow">return</span> -1;
<a name="l02065"></a>02065       }
<a name="l02066"></a>02066    }
<a name="l02067"></a>02067 <span class="preprocessor">#endif</span>
<a name="l02068"></a>02068 <span class="preprocessor"></span>   res = <a class="code" href="res__agi_8c.html#f65cb877b13ff2c55e746a208baba72b">launch_script</a>(argv[0], argv, fds, enhanced ? &amp;efd : NULL, &amp;pid);
<a name="l02069"></a>02069    <span class="keywordflow">if</span> (res == <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>) {
<a name="l02070"></a>02070       <span class="keywordtype">int</span> status = 0;
<a name="l02071"></a>02071       agi.fd = fds[1];
<a name="l02072"></a>02072       agi.ctrl = fds[0];
<a name="l02073"></a>02073       agi.audio = efd;
<a name="l02074"></a>02074       res = <a class="code" href="res__agi_8c.html#62f311affcf7fd5992804e1a93dc6bfe">run_agi</a>(chan, argv[0], &amp;agi, pid, &amp;status, dead, argc, argv);
<a name="l02075"></a>02075       <span class="comment">/* If the fork'd process returns non-zero, set AGISTATUS to FAILURE */</span>
<a name="l02076"></a>02076       <span class="keywordflow">if</span> (res == <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a> &amp;&amp; status)
<a name="l02077"></a>02077          res = <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>;
<a name="l02078"></a>02078       <span class="keywordflow">if</span> (fds[1] != fds[0])
<a name="l02079"></a>02079          close(fds[1]);
<a name="l02080"></a>02080       <span class="keywordflow">if</span> (efd &gt; -1)
<a name="l02081"></a>02081          close(efd);
<a name="l02082"></a>02082       <a class="code" href="asterisk_8c.html#7b40596f4569d57046d71c7a94394589">ast_unreplace_sigchld</a>();
<a name="l02083"></a>02083    }
<a name="l02084"></a>02084    <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02085"></a>02085 
<a name="l02086"></a>02086    <span class="keywordflow">switch</span> (res) {
<a name="l02087"></a>02087    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c23b47512bd5deadb2695067821887f6c">AGI_RESULT_SUCCESS</a>:
<a name="l02088"></a>02088       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"AGISTATUS"</span>, <span class="stringliteral">"SUCCESS"</span>);
<a name="l02089"></a>02089       <span class="keywordflow">break</span>;
<a name="l02090"></a>02090    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635c7fe6808fb92d9b44ef3fda45196901db">AGI_RESULT_FAILURE</a>:
<a name="l02091"></a>02091       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"AGISTATUS"</span>, <span class="stringliteral">"FAILURE"</span>);
<a name="l02092"></a>02092       <span class="keywordflow">break</span>;
<a name="l02093"></a>02093    <span class="keywordflow">case</span> <a class="code" href="res__agi_8c.html#371a02f1ee69d8df027050e473f3635ce08c955da0991c983be1ef35d678bf8e">AGI_RESULT_HANGUP</a>:
<a name="l02094"></a>02094       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"AGISTATUS"</span>, <span class="stringliteral">"HANGUP"</span>);
<a name="l02095"></a>02095       <span class="keywordflow">return</span> -1;
<a name="l02096"></a>02096    }
<a name="l02097"></a>02097 
<a name="l02098"></a>02098    <span class="keywordflow">return</span> 0;
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a><a class="code" href="res__agi_8c.html#57df2254f7bc88f8f393d4f8a8580b26">02101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#57df2254f7bc88f8f393d4f8a8580b26">agi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l02102"></a>02102 {
<a name="l02103"></a>02103    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a>)
<a name="l02104"></a>02104       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"If you want to run AGI on hungup channels you should use DeadAGI!\n"</span>);
<a name="l02105"></a>02105    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#0ea89d2e6426c93f601bf23abbd53aed">agi_exec_full</a>(chan, data, 0, 0);
<a name="l02106"></a>02106 }
<a name="l02107"></a>02107 
<a name="l02108"></a><a class="code" href="res__agi_8c.html#f62d526c79bb2218793c6b627bffed5e">02108</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#f62d526c79bb2218793c6b627bffed5e">eagi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l02109"></a>02109 {
<a name="l02110"></a>02110    <span class="keywordtype">int</span> readformat;
<a name="l02111"></a>02111    <span class="keywordtype">int</span> res;
<a name="l02112"></a>02112 
<a name="l02113"></a>02113    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a>)
<a name="l02114"></a>02114       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"If you want to run AGI on hungup channels you should use DeadAGI!\n"</span>);
<a name="l02115"></a>02115    readformat = chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l02116"></a>02116    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>)) {
<a name="l02117"></a>02117       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to set channel '%s' to linear mode\n"</span>, chan-&gt;name);
<a name="l02118"></a>02118       <span class="keywordflow">return</span> -1;
<a name="l02119"></a>02119    }
<a name="l02120"></a>02120    res = <a class="code" href="res__agi_8c.html#0ea89d2e6426c93f601bf23abbd53aed">agi_exec_full</a>(chan, data, 1, 0);
<a name="l02121"></a>02121    <span class="keywordflow">if</span> (!res) {
<a name="l02122"></a>02122       <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#8f102047453fca4cd6813696be1b9843">ast_set_read_format</a>(chan, readformat)) {
<a name="l02123"></a>02123          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to restore channel '%s' to format %s\n"</span>, chan-&gt;name, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(readformat));
<a name="l02124"></a>02124       }
<a name="l02125"></a>02125    }
<a name="l02126"></a>02126    <span class="keywordflow">return</span> res;
<a name="l02127"></a>02127 }
<a name="l02128"></a>02128 
<a name="l02129"></a><a class="code" href="res__agi_8c.html#a6c46443ea89812662c98e591c4bfa55">02129</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__agi_8c.html#a6c46443ea89812662c98e591c4bfa55">deadagi_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l02130"></a>02130 {
<a name="l02131"></a>02131    <span class="keywordflow">return</span> <a class="code" href="res__agi_8c.html#0ea89d2e6426c93f601bf23abbd53aed">agi_exec_full</a>(chan, data, 0, 1);
<a name="l02132"></a>02132 }
<a name="l02133"></a>02133 
<a name="l02134"></a><a class="code" href="res__agi_8c.html#25f0b62973db256a9b6f6a225aef940f">02134</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#25f0b62973db256a9b6f6a225aef940f">showagi_help</a>[] =
<a name="l02135"></a>02135 <span class="stringliteral">"Usage: agi show [topic]\n"</span>
<a name="l02136"></a>02136 <span class="stringliteral">"       When called with a topic as an argument, displays usage\n"</span>
<a name="l02137"></a>02137 <span class="stringliteral">"       information on the given command.  If called without a\n"</span>
<a name="l02138"></a>02138 <span class="stringliteral">"       topic, it provides a list of AGI commands.\n"</span>;
<a name="l02139"></a>02139 
<a name="l02140"></a>02140 
<a name="l02141"></a><a class="code" href="res__agi_8c.html#60d32661c3dfd5639c610650cd12a150">02141</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__agi_8c.html#60d32661c3dfd5639c610650cd12a150">dumpagihtml_help</a>[] =
<a name="l02142"></a>02142 <span class="stringliteral">"Usage: agi dumphtml &lt;filename&gt;\n"</span>
<a name="l02143"></a>02143 <span class="stringliteral">"  Dumps the agi command list in html format to given filename\n"</span>;
<a name="l02144"></a>02144 
<a name="l02145"></a><a class="code" href="res__agi_8c.html#714733a7ccf29cf1784e68b112ab9612">02145</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_agi[] = {
<a name="l02146"></a>02146    { { <span class="stringliteral">"agi"</span>, <span class="stringliteral">"debug"</span>, NULL },
<a name="l02147"></a>02147    <a class="code" href="res__agi_8c.html#a2b8aed0bf228bef263de39c54671673">agi_do_debug</a>, <span class="stringliteral">"Enable AGI debugging"</span>,
<a name="l02148"></a>02148    debug_usage },
<a name="l02149"></a>02149 
<a name="l02150"></a>02150    { { <span class="stringliteral">"agi"</span>, <span class="stringliteral">"debug"</span>, <span class="stringliteral">"off"</span>, NULL },
<a name="l02151"></a>02151    <a class="code" href="res__agi_8c.html#2bd4822889d53862394a547c1d4da3f4">agi_no_debug</a>, <span class="stringliteral">"Disable AGI debugging"</span>,
<a name="l02152"></a>02152    no_debug_usage },
<a name="l02153"></a>02153 
<a name="l02154"></a>02154    { { <span class="stringliteral">"agi"</span>, <span class="stringliteral">"show"</span>, NULL },
<a name="l02155"></a>02155    <a class="code" href="res__agi_8c.html#2d117104c6721f110ab453fd8a6ebb56">handle_showagi</a>, <span class="stringliteral">"List AGI commands or specific help"</span>,
<a name="l02156"></a>02156    showagi_help },
<a name="l02157"></a>02157 
<a name="l02158"></a>02158    { { <span class="stringliteral">"agi"</span>, <span class="stringliteral">"dumphtml"</span>, NULL },
<a name="l02159"></a>02159    <a class="code" href="res__agi_8c.html#74adbe4887b465e17905ea48bd08c744">handle_agidumphtml</a>, <span class="stringliteral">"Dumps a list of agi commands in html format"</span>,
<a name="l02160"></a>02160    dumpagihtml_help },
<a name="l02161"></a>02161 };
<a name="l02162"></a>02162 
<a name="l02163"></a><a class="code" href="res__agi_8c.html#eaf793e807a29b69460b0c6c94a79a0b">02163</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l02164"></a>02164 {
<a name="l02165"></a>02165    <a class="code" href="module_8h.html#c41f250c8ab8ddcb77214a7b149c9e71">ast_module_user_hangup_all</a>();
<a name="l02166"></a>02166    <a class="code" href="cli_8c.html#321c001e02fcba48873965ff141ff29b">ast_cli_unregister_multiple</a>(cli_agi, <span class="keyword">sizeof</span>(cli_agi) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l02167"></a>02167    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<a class="code" href="res__agi_8c.html#b6939ae065bca9f51c6eec6dfdd2ee6d">eapp</a>);
<a name="l02168"></a>02168    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<a class="code" href="res__agi_8c.html#4a42acd9389666cc5255b8753f04e52c">deadapp</a>);
<a name="l02169"></a>02169    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>);
<a name="l02170"></a>02170 }
<a name="l02171"></a>02171 
<a name="l02172"></a><a class="code" href="res__agi_8c.html#8c304b271325d497b3ce1886465a1abe">02172</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l02173"></a>02173 {
<a name="l02174"></a>02174    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_agi, <span class="keyword">sizeof</span>(cli_agi) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l02175"></a>02175    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<a class="code" href="res__agi_8c.html#4a42acd9389666cc5255b8753f04e52c">deadapp</a>, <a class="code" href="res__agi_8c.html#a6c46443ea89812662c98e591c4bfa55">deadagi_exec</a>, <a class="code" href="res__agi_8c.html#9fc385d9bba851f2111d7ea2b493599a">deadsynopsis</a>, <a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a>);
<a name="l02176"></a>02176    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<a class="code" href="res__agi_8c.html#b6939ae065bca9f51c6eec6dfdd2ee6d">eapp</a>, <a class="code" href="res__agi_8c.html#f62d526c79bb2218793c6b627bffed5e">eagi_exec</a>, <a class="code" href="res__agi_8c.html#ee6ed88e1831498c1b026dd08bc4a8b5">esynopsis</a>, <a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a>);
<a name="l02177"></a>02177    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>, <a class="code" href="res__agi_8c.html#57df2254f7bc88f8f393d4f8a8580b26">agi_exec</a>, <a class="code" href="chan__agent_8c.html#485d112e4e425dde393e2e7091451856">synopsis</a>, <a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a>);
<a name="l02178"></a>02178 }
<a name="l02179"></a>02179 
<a name="l02180"></a>02180 <a class="code" href="module_8h.html#237cb97341e39c38b6e3ecb88b7ea148">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#b4566594eeb42c8fc7d6733c7b4b6c0a0b99d39f1f6a9afeedd2f8e6632dd76c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">"Asterisk Gateway Interface (AGI)"</span>,
<a name="l02181"></a>02181                 .load = <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>,
<a name="l02182"></a>02182                 .unload = <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>,
<a name="l02183"></a>02183       );
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:48 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
