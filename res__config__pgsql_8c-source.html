<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:49 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_config_pgsql.c</h1><a href="res__config__pgsql_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- A telephony toolkit for Linux.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999-2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> * </span>
<a name="l00006"></a>00006 <span class="comment"> * Manuel Guesdon &lt;mguesdon@oxymium.net&gt; - Postgresql RealTime Driver Author/Adaptor</span>
<a name="l00007"></a>00007 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;  - Asterisk Author</span>
<a name="l00008"></a>00008 <span class="comment"> * Matthew Boehm &lt;mboehm@cytelcom.com&gt; - MySQL RealTime Driver Author</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * res_config_pgsql.c &lt;Postgresql plugin for RealTime configuration engine&gt;</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * v1.0   - (07-11-05) - Initial version based on res_config_mysql v2.0</span>
<a name="l00013"></a>00013 <span class="comment"> */</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">/*! \file</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * \brief Postgresql plugin for Asterisk RealTime Architecture</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00020"></a>00020 <span class="comment"> * \author Manuel Guesdon &lt;mguesdon@oxymium.net&gt; - Postgresql RealTime Driver Author/Adaptor</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * \arg http://www.postgresql.org</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">/*** MODULEINFO</span>
<a name="l00026"></a>00026 <span class="comment">   &lt;depend&gt;pgsql&lt;/depend&gt;</span>
<a name="l00027"></a>00027 <span class="comment"> ***/</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 #include &lt;stdlib.h&gt;
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;libpq-fe.h&gt;</span>         <span class="comment">/* PostgreSQL */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <a class="code" href="lock_8h.html#4291c0bd75dfaf0052799003d3305e16">AST_MUTEX_DEFINE_STATIC</a>(pgsql_lock);
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="res__config__pgsql_8c.html#1ac5543c2a28139c8a7263b1d57b53e9">00051</a> <span class="preprocessor">#define RES_CONFIG_PGSQL_CONF "res_pgsql.conf"</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">00053</a> PGconn *<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a> = NULL;
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">00055</a> <span class="preprocessor">#define MAX_DB_OPTION_SIZE 64</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">00057</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>[<a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">MAX_DB_OPTION_SIZE</a>] = <span class="stringliteral">""</span>;
<a name="l00058"></a><a class="code" href="res__config__pgsql_8c.html#a883a54ffaa7c2b851872f3cde988f96">00058</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>[<a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">MAX_DB_OPTION_SIZE</a>] = <span class="stringliteral">""</span>;
<a name="l00059"></a><a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">00059</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>[<a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">MAX_DB_OPTION_SIZE</a>] = <span class="stringliteral">""</span>;
<a name="l00060"></a><a class="code" href="res__config__pgsql_8c.html#0b634eec38d43697d699955dc66e8921">00060</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>[<a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">MAX_DB_OPTION_SIZE</a>] = <span class="stringliteral">""</span>;
<a name="l00061"></a><a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">00061</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>[<a class="code" href="res__config__pgsql_8c.html#d790d88416381f6a078f74d36661e2fb">MAX_DB_OPTION_SIZE</a>] = <span class="stringliteral">""</span>;
<a name="l00062"></a><a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">00062</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a> = 5432;
<a name="l00063"></a><a class="code" href="res__config__pgsql_8c.html#d5c66d45146d1cfddb1040c593312d9d">00063</a> <span class="keyword">static</span> time_t <a class="code" href="res__config__pgsql_8c.html#d5c66d45146d1cfddb1040c593312d9d">connect_time</a> = 0;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="codec__adpcm_8c.html#36977d043c20a810ce9f805853c0424e">parse_config</a>(<span class="keywordtype">void</span>);
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database);
<a name="l00067"></a>00067 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#bc9aed9daac60799f0b13b5eb4b39f85">realtime_pgsql_status</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv);
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="res__config__pgsql_8c.html#2f3188439d48b72b2b84ed628f4bfe9c">00069</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="res__config__pgsql_8c.html#2f3188439d48b72b2b84ed628f4bfe9c">cli_realtime_pgsql_status_usage</a>[] =
<a name="l00070"></a>00070    <span class="stringliteral">"Usage: realtime pgsql status\n"</span>
<a name="l00071"></a>00071    <span class="stringliteral">"       Shows connection information for the Postgresql RealTime driver\n"</span>;
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="res__config__pgsql_8c.html#77741c5842ccb030ffac395561f99898">00073</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_realtime[] = {
<a name="l00074"></a>00074    { { <span class="stringliteral">"realtime"</span>, <span class="stringliteral">"pgsql"</span>, <span class="stringliteral">"status"</span>, NULL },
<a name="l00075"></a>00075    <a class="code" href="res__config__pgsql_8c.html#bc9aed9daac60799f0b13b5eb4b39f85">realtime_pgsql_status</a>, <span class="stringliteral">"Shows connection information for the Postgresql RealTime driver"</span>,
<a name="l00076"></a>00076    <a class="code" href="res__config__pgsql_8c.html#2f3188439d48b72b2b84ed628f4bfe9c">cli_realtime_pgsql_status_usage</a> },
<a name="l00077"></a>00077 };
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="res__config__pgsql_8c.html#968dd9610f63d3c103bbc2b5a5594378">00079</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="res__config__pgsql_8c.html#968dd9610f63d3c103bbc2b5a5594378">realtime_pgsql</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#aab9e1de16f38176f86d7a92ba337a8d">table</a>, va_list ap)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081    PGresult *<a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = NULL;
<a name="l00082"></a>00082    <span class="keywordtype">int</span> num_rows = 0;
<a name="l00083"></a>00083    <span class="keywordtype">char</span> sql[256];
<a name="l00084"></a>00084    <span class="keywordtype">char</span> *stringp;
<a name="l00085"></a>00085    <span class="keywordtype">char</span> *chunk;
<a name="l00086"></a>00086    <span class="keywordtype">char</span> *op;
<a name="l00087"></a>00087    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00088"></a>00088    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a> = NULL, *prev = NULL;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090    <span class="keywordflow">if</span> (!table) {
<a name="l00091"></a>00091       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Postgresql RealTime: No table specified.\n"</span>);
<a name="l00092"></a>00092       <span class="keywordflow">return</span> NULL;
<a name="l00093"></a>00093    }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00096"></a>00096    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00097"></a>00097    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00098"></a>00098    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00099"></a>00099       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00100"></a>00100             <span class="stringliteral">"Postgresql RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n"</span>);
<a name="l00101"></a>00101       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) {
<a name="l00102"></a>00102          PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00103"></a>00103          pgsqlConn = NULL;
<a name="l00104"></a>00104       };
<a name="l00105"></a>00105       <span class="keywordflow">return</span> NULL;
<a name="l00106"></a>00106    }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00109"></a>00109 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00110"></a>00110    op = strchr(newparam, <span class="charliteral">' '</span>) ? <span class="stringliteral">""</span> : <span class="stringliteral">" ="</span>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112    snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">"SELECT * FROM %s WHERE %s%s '%s'"</span>, table, newparam, op,
<a name="l00113"></a>00113           newval);
<a name="l00114"></a>00114    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00115"></a>00115       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00116"></a>00116       <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">' '</span>))
<a name="l00117"></a>00117          op = <span class="stringliteral">" ="</span>;
<a name="l00118"></a>00118       <span class="keywordflow">else</span>
<a name="l00119"></a>00119          op = <span class="stringliteral">""</span>;
<a name="l00120"></a>00120       snprintf(sql + strlen(sql), <span class="keyword">sizeof</span>(sql) - strlen(sql), <span class="stringliteral">" AND %s%s '%s'"</span>, newparam,
<a name="l00121"></a>00121              op, newval);
<a name="l00122"></a>00122    }
<a name="l00123"></a>00123    va_end(ap);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00126"></a>00126    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00127"></a>00127    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(database)) {
<a name="l00128"></a>00128       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00129"></a>00129       <span class="keywordflow">return</span> NULL;
<a name="l00130"></a>00130    }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>, sql))) {
<a name="l00133"></a>00133       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00134"></a>00134             <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00135"></a>00135       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00136"></a>00136          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00137"></a>00137          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s\n"</span>,
<a name="l00138"></a>00138                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00139"></a>00139       }
<a name="l00140"></a>00140       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00141"></a>00141       <span class="keywordflow">return</span> NULL;
<a name="l00142"></a>00142    } <span class="keywordflow">else</span> {
<a name="l00143"></a>00143       ExecStatusType result_status = PQresultStatus(result);
<a name="l00144"></a>00144       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00145"></a>00145          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00146"></a>00146          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00147"></a>00147          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00148"></a>00148                <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00149"></a>00149          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00150"></a>00150             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00151"></a>00151             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s (%s)\n"</span>,
<a name="l00152"></a>00152                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00153"></a>00153          }
<a name="l00154"></a>00154          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00155"></a>00155          <span class="keywordflow">return</span> NULL;
<a name="l00156"></a>00156       }
<a name="l00157"></a>00157    }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00160"></a>00160       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"1Postgresql RealTime: Result=%p Query: %s\n"</span>, result, sql);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l00163"></a>00163       <span class="keywordtype">int</span> i = 0;
<a name="l00164"></a>00164       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l00165"></a>00165       <span class="keywordtype">int</span> numFields = PQnfields(result);
<a name="l00166"></a>00166       <span class="keywordtype">char</span> **fieldnames = NULL;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00169"></a>00169          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Found %d rows.\n"</span>, num_rows);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171       <span class="keywordflow">if</span> (!(fieldnames = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, numFields * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00172"></a>00172          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00173"></a>00173          PQclear(result);
<a name="l00174"></a>00174          <span class="keywordflow">return</span> NULL;
<a name="l00175"></a>00175       }
<a name="l00176"></a>00176       <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++)
<a name="l00177"></a>00177          fieldnames[i] = PQfname(result, i);
<a name="l00178"></a>00178       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l00179"></a>00179          <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++) {
<a name="l00180"></a>00180             stringp = PQgetvalue(result, rowIndex, i);
<a name="l00181"></a>00181             <span class="keywordflow">while</span> (stringp) {
<a name="l00182"></a>00182                chunk = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">";"</span>);
<a name="l00183"></a>00183                <span class="keywordflow">if</span> (chunk &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(ast_strip(chunk))) {
<a name="l00184"></a>00184                   <span class="keywordflow">if</span> (prev) {
<a name="l00185"></a>00185                      prev-&gt;next = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(fieldnames[i], chunk);
<a name="l00186"></a>00186                      <span class="keywordflow">if</span> (prev-&gt;next) {
<a name="l00187"></a>00187                         prev = prev-&gt;next;
<a name="l00188"></a>00188                      }
<a name="l00189"></a>00189                   } <span class="keywordflow">else</span> {
<a name="l00190"></a>00190                      prev = var = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(fieldnames[i], chunk);
<a name="l00191"></a>00191                   }
<a name="l00192"></a>00192                }
<a name="l00193"></a>00193             }
<a name="l00194"></a>00194          }
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fieldnames);
<a name="l00197"></a>00197    } <span class="keywordflow">else</span> {
<a name="l00198"></a>00198       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00199"></a>00199             <span class="stringliteral">"Postgresql RealTime: Could not find any rows in table %s.\n"</span>, table);
<a name="l00200"></a>00200    }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00203"></a>00203    PQclear(result);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205    <span class="keywordflow">return</span> var;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="res__config__pgsql_8c.html#63db7efba31277a19e9c466814c6a8eb">00208</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="res__config__pgsql_8c.html#63db7efba31277a19e9c466814c6a8eb">realtime_multi_pgsql</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#aab9e1de16f38176f86d7a92ba337a8d">table</a>, va_list ap)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210    PGresult *<a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = NULL;
<a name="l00211"></a>00211    <span class="keywordtype">int</span> num_rows = 0;
<a name="l00212"></a>00212    <span class="keywordtype">char</span> sql[256];
<a name="l00213"></a>00213    <span class="keyword">const</span> <span class="keywordtype">char</span> *initfield = NULL;
<a name="l00214"></a>00214    <span class="keywordtype">char</span> *stringp;
<a name="l00215"></a>00215    <span class="keywordtype">char</span> *chunk;
<a name="l00216"></a>00216    <span class="keywordtype">char</span> *op;
<a name="l00217"></a>00217    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00218"></a>00218    <span class="keyword">struct </span><a class="code" href="structast__realloca.html">ast_realloca</a> ra;
<a name="l00219"></a>00219    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a> = NULL;
<a name="l00220"></a>00220    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l00221"></a>00221    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat = NULL;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223    <span class="keywordflow">if</span> (!table) {
<a name="l00224"></a>00224       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Postgresql RealTime: No table specified.\n"</span>);
<a name="l00225"></a>00225       <span class="keywordflow">return</span> NULL;
<a name="l00226"></a>00226    }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228    memset(&amp;ra, 0, <span class="keyword">sizeof</span>(ra));
<a name="l00229"></a>00229 
<a name="l00230"></a>00230    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8c.html#5fee2f4a603882efcf21120190f2b803">ast_config_new</a>()))
<a name="l00231"></a>00231       <span class="keywordflow">return</span> NULL;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00234"></a>00234    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00235"></a>00235    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00236"></a>00236    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00237"></a>00237       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00238"></a>00238             <span class="stringliteral">"Postgresql RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n"</span>);
<a name="l00239"></a>00239       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) {
<a name="l00240"></a>00240          PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00241"></a>00241          pgsqlConn = NULL;
<a name="l00242"></a>00242       };
<a name="l00243"></a>00243       <span class="keywordflow">return</span> NULL;
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246    initfield = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(newparam);
<a name="l00247"></a>00247    <span class="keywordflow">if</span> ((op = strchr(initfield, <span class="charliteral">' '</span>))) {
<a name="l00248"></a>00248       *op = <span class="charliteral">'\0'</span>;
<a name="l00249"></a>00249    }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00252"></a>00252 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">' '</span>))
<a name="l00255"></a>00255       op = <span class="stringliteral">" ="</span>;
<a name="l00256"></a>00256    <span class="keywordflow">else</span>
<a name="l00257"></a>00257       op = <span class="stringliteral">""</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259    snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">"SELECT * FROM %s WHERE %s%s '%s'"</span>, table, newparam, op,
<a name="l00260"></a>00260           newval);
<a name="l00261"></a>00261    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00262"></a>00262       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00263"></a>00263       <span class="keywordflow">if</span> (!strchr(newparam, <span class="charliteral">' '</span>))
<a name="l00264"></a>00264          op = <span class="stringliteral">" ="</span>;
<a name="l00265"></a>00265       <span class="keywordflow">else</span>
<a name="l00266"></a>00266          op = <span class="stringliteral">""</span>;
<a name="l00267"></a>00267       snprintf(sql + strlen(sql), <span class="keyword">sizeof</span>(sql) - strlen(sql), <span class="stringliteral">" AND %s%s '%s'"</span>, newparam,
<a name="l00268"></a>00268              op, newval);
<a name="l00269"></a>00269    }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <span class="keywordflow">if</span> (initfield) {
<a name="l00272"></a>00272       snprintf(sql + strlen(sql), <span class="keyword">sizeof</span>(sql) - strlen(sql), <span class="stringliteral">" ORDER BY %s"</span>, initfield);
<a name="l00273"></a>00273    }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    va_end(ap);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00278"></a>00278    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00279"></a>00279    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(database)) {
<a name="l00280"></a>00280       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00281"></a>00281       <span class="keywordflow">return</span> NULL;
<a name="l00282"></a>00282    }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>, sql))) {
<a name="l00285"></a>00285       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00286"></a>00286             <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00287"></a>00287       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00288"></a>00288          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00289"></a>00289          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s\n"</span>,
<a name="l00290"></a>00290                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00291"></a>00291       }
<a name="l00292"></a>00292       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00293"></a>00293       <span class="keywordflow">return</span> NULL;
<a name="l00294"></a>00294    } <span class="keywordflow">else</span> {
<a name="l00295"></a>00295       ExecStatusType result_status = PQresultStatus(result);
<a name="l00296"></a>00296       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00297"></a>00297          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00298"></a>00298          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00299"></a>00299          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00300"></a>00300                <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00301"></a>00301          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00302"></a>00302             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00303"></a>00303             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s (%s)\n"</span>,
<a name="l00304"></a>00304                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00305"></a>00305          }
<a name="l00306"></a>00306          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00307"></a>00307          <span class="keywordflow">return</span> NULL;
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00312"></a>00312       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"2Postgresql RealTime: Result=%p Query: %s\n"</span>, result, sql);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l00315"></a>00315       <span class="keywordtype">int</span> numFields = PQnfields(result);
<a name="l00316"></a>00316       <span class="keywordtype">int</span> i = 0;
<a name="l00317"></a>00317       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l00318"></a>00318       <span class="keywordtype">char</span> **fieldnames = NULL;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00321"></a>00321          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Found %d rows.\n"</span>, num_rows);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       <span class="keywordflow">if</span> (!(fieldnames = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, numFields * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00324"></a>00324          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00325"></a>00325          PQclear(result);
<a name="l00326"></a>00326          <span class="keywordflow">return</span> NULL;
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328       <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++)
<a name="l00329"></a>00329          fieldnames[i] = PQfname(result, i);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l00332"></a>00332          var = NULL;
<a name="l00333"></a>00333          <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8c.html#7c91d609091f9ffcb3b4a9f8aaa82e7b">ast_category_new</a>(<span class="stringliteral">""</span>)))
<a name="l00334"></a>00334             <span class="keywordflow">continue</span>;
<a name="l00335"></a>00335          <span class="keywordflow">for</span> (i = 0; i &lt; numFields; i++) {
<a name="l00336"></a>00336             stringp = PQgetvalue(result, rowIndex, i);
<a name="l00337"></a>00337             <span class="keywordflow">while</span> (stringp) {
<a name="l00338"></a>00338                chunk = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;stringp, <span class="stringliteral">";"</span>);
<a name="l00339"></a>00339                <span class="keywordflow">if</span> (chunk &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(ast_strip(chunk))) {
<a name="l00340"></a>00340                   <span class="keywordflow">if</span> (initfield &amp;&amp; !strcmp(initfield, fieldnames[i])) {
<a name="l00341"></a>00341                      <a class="code" href="config_8c.html#8629d76affd844c6b15a901eb2aa63d7">ast_category_rename</a>(cat, chunk);
<a name="l00342"></a>00342                   }
<a name="l00343"></a>00343                   var = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(fieldnames[i], chunk);
<a name="l00344"></a>00344                   <a class="code" href="config_8c.html#6b8deaf1a9df252e014d697e09cb68b9">ast_variable_append</a>(cat, var);
<a name="l00345"></a>00345                }
<a name="l00346"></a>00346             }
<a name="l00347"></a>00347          }
<a name="l00348"></a>00348          <a class="code" href="config_8c.html#9efd51e40d45378faf85951179110981">ast_category_append</a>(cfg, cat);
<a name="l00349"></a>00349       }
<a name="l00350"></a>00350       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fieldnames);
<a name="l00351"></a>00351    } <span class="keywordflow">else</span> {
<a name="l00352"></a>00352       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00353"></a>00353             <span class="stringliteral">"Postgresql RealTime: Could not find any rows in table %s.\n"</span>, table);
<a name="l00354"></a>00354    }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00357"></a>00357    PQclear(result);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359    <span class="keywordflow">return</span> cfg;
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="res__config__pgsql_8c.html#df95dd5e04d64492357c3eb6302eaf96">00362</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#df95dd5e04d64492357c3eb6302eaf96">update_pgsql</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#aab9e1de16f38176f86d7a92ba337a8d">table</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *keyfield,
<a name="l00363"></a>00363                   <span class="keyword">const</span> <span class="keywordtype">char</span> *lookup, va_list ap)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365    PGresult *<a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = NULL;
<a name="l00366"></a>00366    <span class="keywordtype">int</span> numrows = 0;
<a name="l00367"></a>00367    <span class="keywordtype">char</span> sql[256];
<a name="l00368"></a>00368    <span class="keyword">const</span> <span class="keywordtype">char</span> *newparam, *newval;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370    <span class="keywordflow">if</span> (!table) {
<a name="l00371"></a>00371       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Postgresql RealTime: No table specified.\n"</span>);
<a name="l00372"></a>00372       <span class="keywordflow">return</span> -1;
<a name="l00373"></a>00373    }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    <span class="comment">/* Get the first parameter and first value in our list of passed paramater/value pairs */</span>
<a name="l00376"></a>00376    newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00377"></a>00377    newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00378"></a>00378    <span class="keywordflow">if</span> (!newparam || !newval) {
<a name="l00379"></a>00379       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00380"></a>00380             <span class="stringliteral">"Postgresql RealTime: Realtime retrieval requires at least 1 parameter and 1 value to search on.\n"</span>);
<a name="l00381"></a>00381       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) {
<a name="l00382"></a>00382          PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00383"></a>00383          pgsqlConn = NULL;
<a name="l00384"></a>00384       };
<a name="l00385"></a>00385       <span class="keywordflow">return</span> -1;
<a name="l00386"></a>00386    }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388    <span class="comment">/* Create the first part of the query using the first parameter/value pairs we just extracted</span>
<a name="l00389"></a>00389 <span class="comment">      If there is only 1 set, then we have our query. Otherwise, loop thru the list and concat */</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391    snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">"UPDATE %s SET %s = '%s'"</span>, table, newparam, newval);
<a name="l00392"></a>00392    <span class="keywordflow">while</span> ((newparam = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00393"></a>00393       newval = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00394"></a>00394       snprintf(sql + strlen(sql), <span class="keyword">sizeof</span>(sql) - strlen(sql), <span class="stringliteral">", %s = '%s'"</span>, newparam,
<a name="l00395"></a>00395              newval);
<a name="l00396"></a>00396    }
<a name="l00397"></a>00397    va_end(ap);
<a name="l00398"></a>00398    snprintf(sql + strlen(sql), <span class="keyword">sizeof</span>(sql) - strlen(sql), <span class="stringliteral">" WHERE %s = '%s'"</span>, keyfield,
<a name="l00399"></a>00399           lookup);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00402"></a>00402       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Update SQL: %s\n"</span>, sql);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00405"></a>00405    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00406"></a>00406    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(database)) {
<a name="l00407"></a>00407       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00408"></a>00408       <span class="keywordflow">return</span> -1;
<a name="l00409"></a>00409    }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>, sql))) {
<a name="l00412"></a>00412       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00413"></a>00413             <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00414"></a>00414       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00415"></a>00415          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00416"></a>00416          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s\n"</span>,
<a name="l00417"></a>00417                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00418"></a>00418       }
<a name="l00419"></a>00419       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00420"></a>00420       <span class="keywordflow">return</span> -1;
<a name="l00421"></a>00421    } <span class="keywordflow">else</span> {
<a name="l00422"></a>00422       ExecStatusType result_status = PQresultStatus(result);
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00424"></a>00424          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00425"></a>00425          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00426"></a>00426          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00427"></a>00427                <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00428"></a>00428          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00429"></a>00429             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00430"></a>00430             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s (%s)\n"</span>,
<a name="l00431"></a>00431                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00432"></a>00432          }
<a name="l00433"></a>00433          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00434"></a>00434          <span class="keywordflow">return</span> -1;
<a name="l00435"></a>00435       }
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    numrows = atoi(PQcmdTuples(result));
<a name="l00439"></a>00439    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00442"></a>00442       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Updated %d rows on table: %s\n"</span>, numrows,
<a name="l00443"></a>00443             table);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    <span class="comment">/* From http://dev.pgsql.com/doc/pgsql/en/pgsql-affected-rows.html</span>
<a name="l00446"></a>00446 <span class="comment">    * An integer greater than zero indicates the number of rows affected</span>
<a name="l00447"></a>00447 <span class="comment">    * Zero indicates that no records were updated</span>
<a name="l00448"></a>00448 <span class="comment">    * -1 indicates that the query returned an error (although, if the query failed, it should have been caught above.)</span>
<a name="l00449"></a>00449 <span class="comment">    */</span>
<a name="l00450"></a>00450 
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (numrows &gt;= 0)
<a name="l00452"></a>00452       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) numrows;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <span class="keywordflow">return</span> -1;
<a name="l00455"></a>00455 }
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="res__config__pgsql_8c.html#f0d94cd2e923619db5a5b2b78a6487e5">00457</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="res__config__pgsql_8c.html#f0d94cd2e923619db5a5b2b78a6487e5">config_pgsql</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#aab9e1de16f38176f86d7a92ba337a8d">table</a>,
<a name="l00458"></a>00458                   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg,
<a name="l00459"></a>00459                   <span class="keywordtype">int</span> withcomments)
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461    PGresult *<a class="code" href="cdr__pgsql_8c.html#b4a88417b3d0170d754c647c30b7216a">result</a> = NULL;
<a name="l00462"></a>00462    <span class="keywordtype">long</span> num_rows;
<a name="l00463"></a>00463    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *new_v;
<a name="l00464"></a>00464    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cur_cat = NULL;
<a name="l00465"></a>00465    <span class="keywordtype">char</span> sqlbuf[1024] = <span class="stringliteral">""</span>;
<a name="l00466"></a>00466    <span class="keywordtype">char</span> *sql;
<a name="l00467"></a>00467    size_t sqlleft = <span class="keyword">sizeof</span>(sqlbuf);
<a name="l00468"></a>00468    <span class="keywordtype">char</span> <a class="code" href="pbx__gtkconsole_8c.html#98bd1c45684cf587ac2347a92dd7bb51">last</a>[80] = <span class="stringliteral">""</span>;
<a name="l00469"></a>00469    <span class="keywordtype">int</span> last_cat_metric = 0;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <a class="code" href="pbx__gtkconsole_8c.html#98bd1c45684cf587ac2347a92dd7bb51">last</a>[0] = <span class="charliteral">'\0'</span>;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="keywordflow">if</span> (!file || !strcmp(file, <a class="code" href="res__config__pgsql_8c.html#1ac5543c2a28139c8a7263b1d57b53e9">RES_CONFIG_PGSQL_CONF</a>)) {
<a name="l00474"></a>00474       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Postgresql RealTime: Cannot configure myself.\n"</span>);
<a name="l00475"></a>00475       <span class="keywordflow">return</span> NULL;
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478    <a class="code" href="utils_8c.html#70e74c4fd16006eae45dd31f7956d6c1">ast_build_string</a>(&amp;sql, &amp;sqlleft, <span class="stringliteral">"SELECT category, var_name, var_val, cat_metric FROM %s "</span>, table);
<a name="l00479"></a>00479    <a class="code" href="utils_8c.html#70e74c4fd16006eae45dd31f7956d6c1">ast_build_string</a>(&amp;sql, &amp;sqlleft, <span class="stringliteral">"WHERE filename='%s' and commented=0"</span>, file);
<a name="l00480"></a>00480    <a class="code" href="utils_8c.html#70e74c4fd16006eae45dd31f7956d6c1">ast_build_string</a>(&amp;sql, &amp;sqlleft, <span class="stringliteral">"ORDER BY cat_metric DESC, var_metric ASC, category, var_name "</span>);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00483"></a>00483       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Static SQL: %s\n"</span>, sqlbuf);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    <span class="comment">/* We now have our complete statement; Lets connect to the server and execute it. */</span>
<a name="l00486"></a>00486    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00487"></a>00487    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(database)) {
<a name="l00488"></a>00488       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00489"></a>00489       <span class="keywordflow">return</span> NULL;
<a name="l00490"></a>00490    }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="keywordflow">if</span> (!(result = PQexec(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>, sqlbuf))) {
<a name="l00493"></a>00493       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00494"></a>00494             <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00495"></a>00495       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00496"></a>00496          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00497"></a>00497          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s\n"</span>,
<a name="l00498"></a>00498                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00499"></a>00499       }
<a name="l00500"></a>00500       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00501"></a>00501       <span class="keywordflow">return</span> NULL;
<a name="l00502"></a>00502    } <span class="keywordflow">else</span> {
<a name="l00503"></a>00503       ExecStatusType result_status = PQresultStatus(result);
<a name="l00504"></a>00504       <span class="keywordflow">if</span> (result_status != PGRES_COMMAND_OK
<a name="l00505"></a>00505          &amp;&amp; result_status != PGRES_TUPLES_OK
<a name="l00506"></a>00506          &amp;&amp; result_status != PGRES_NONFATAL_ERROR) {
<a name="l00507"></a>00507          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00508"></a>00508                <span class="stringliteral">"Postgresql RealTime: Failed to query database. Check debug for more info.\n"</span>);
<a name="l00509"></a>00509          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00510"></a>00510             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query: %s\n"</span>, sql);
<a name="l00511"></a>00511             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Query Failed because: %s (%s)\n"</span>,
<a name="l00512"></a>00512                   PQresultErrorMessage(result), PQresStatus(result_status));
<a name="l00513"></a>00513          }
<a name="l00514"></a>00514          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00515"></a>00515          <span class="keywordflow">return</span> NULL;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517    }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519    <span class="keywordflow">if</span> ((num_rows = PQntuples(result)) &gt; 0) {
<a name="l00520"></a>00520       <span class="keywordtype">int</span> rowIndex = 0;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00523"></a>00523          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Found %ld rows.\n"</span>, num_rows);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525       <span class="keywordflow">for</span> (rowIndex = 0; rowIndex &lt; num_rows; rowIndex++) {
<a name="l00526"></a>00526          <span class="keywordtype">char</span> *field_category = PQgetvalue(result, rowIndex, 0);
<a name="l00527"></a>00527          <span class="keywordtype">char</span> *field_var_name = PQgetvalue(result, rowIndex, 1);
<a name="l00528"></a>00528          <span class="keywordtype">char</span> *field_var_val = PQgetvalue(result, rowIndex, 2);
<a name="l00529"></a>00529          <span class="keywordtype">char</span> *field_cat_metric = PQgetvalue(result, rowIndex, 3);
<a name="l00530"></a>00530          <span class="keywordflow">if</span> (!strcmp(field_var_name, <span class="stringliteral">"#include"</span>)) {
<a name="l00531"></a>00531             <span class="keywordflow">if</span> (!<a class="code" href="config_8c.html#c3ab4e0c51bb2d6537b62b9d8b997c0e">ast_config_internal_load</a>(field_var_val, cfg, 0)) {
<a name="l00532"></a>00532                PQclear(result);
<a name="l00533"></a>00533                <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00534"></a>00534                <span class="keywordflow">return</span> NULL;
<a name="l00535"></a>00535             }
<a name="l00536"></a>00536             <span class="keywordflow">continue</span>;
<a name="l00537"></a>00537          }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539          <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx__gtkconsole_8c.html#98bd1c45684cf587ac2347a92dd7bb51">last</a>, field_category) || last_cat_metric != atoi(field_cat_metric)) {
<a name="l00540"></a>00540             cur_cat = <a class="code" href="config_8c.html#7c91d609091f9ffcb3b4a9f8aaa82e7b">ast_category_new</a>(field_category);
<a name="l00541"></a>00541             <span class="keywordflow">if</span> (!cur_cat)
<a name="l00542"></a>00542                <span class="keywordflow">break</span>;
<a name="l00543"></a>00543             strcpy(<a class="code" href="pbx__gtkconsole_8c.html#98bd1c45684cf587ac2347a92dd7bb51">last</a>, field_category);
<a name="l00544"></a>00544             last_cat_metric = atoi(field_cat_metric);
<a name="l00545"></a>00545             <a class="code" href="config_8c.html#9efd51e40d45378faf85951179110981">ast_category_append</a>(cfg, cur_cat);
<a name="l00546"></a>00546          }
<a name="l00547"></a>00547          new_v = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(field_var_name, field_var_val);
<a name="l00548"></a>00548          <a class="code" href="config_8c.html#6b8deaf1a9df252e014d697e09cb68b9">ast_variable_append</a>(cur_cat, new_v);
<a name="l00549"></a>00549       }
<a name="l00550"></a>00550    } <span class="keywordflow">else</span> {
<a name="l00551"></a>00551       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00552"></a>00552             <span class="stringliteral">"Postgresql RealTime: Could not find config '%s' in database.\n"</span>, file);
<a name="l00553"></a>00553    }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555    PQclear(result);
<a name="l00556"></a>00556    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <span class="keywordflow">return</span> cfg;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="res__config__pgsql_8c.html#2d2533afc8353ec33d206b531f8f7091">00561</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config__engine.html">ast_config_engine</a> pgsql_engine = {
<a name="l00562"></a>00562    .<a class="code" href="structast__config__engine.html#b068931cc450442b63f5b3d276ea4297">name</a> = <span class="stringliteral">"pgsql"</span>,
<a name="l00563"></a>00563    .load_func = <a class="code" href="res__config__pgsql_8c.html#f0d94cd2e923619db5a5b2b78a6487e5">config_pgsql</a>,
<a name="l00564"></a>00564    .realtime_func = <a class="code" href="res__config__pgsql_8c.html#968dd9610f63d3c103bbc2b5a5594378">realtime_pgsql</a>,
<a name="l00565"></a>00565    .realtime_multi_func = <a class="code" href="res__config__pgsql_8c.html#63db7efba31277a19e9c466814c6a8eb">realtime_multi_pgsql</a>,
<a name="l00566"></a>00566    .update_func = <a class="code" href="res__config__pgsql_8c.html#df95dd5e04d64492357c3eb6302eaf96">update_pgsql</a>
<a name="l00567"></a>00567 };
<a name="l00568"></a>00568 
<a name="l00569"></a><a class="code" href="res__config__pgsql_8c.html#8c304b271325d497b3ce1886465a1abe">00569</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l00570"></a>00570 {
<a name="l00571"></a>00571    <span class="keywordflow">if</span>(!<a class="code" href="codec__adpcm_8c.html#36977d043c20a810ce9f805853c0424e">parse_config</a>())
<a name="l00572"></a>00572       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#6b66b922ea50fb20d0a8a25ba8317b0adea6426eed250d0d922d7e289a706663">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(NULL)) {
<a name="l00577"></a>00577       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00578"></a>00578             <span class="stringliteral">"Postgresql RealTime: Couldn't establish connection. Check debug.\n"</span>);
<a name="l00579"></a>00579       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00580"></a>00580          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Cannot Connect: %s\n"</span>,
<a name="l00581"></a>00581                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00582"></a>00582    }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584    <a class="code" href="config_8c.html#e2204638bef8e7bd5c552daf3b927b8c">ast_config_engine_register</a>(&amp;pgsql_engine);
<a name="l00585"></a>00585    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a>) {
<a name="l00586"></a>00586       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"Postgresql RealTime driver loaded.\n"</span>);
<a name="l00587"></a>00587    }
<a name="l00588"></a>00588    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_realtime, <span class="keyword">sizeof</span>(cli_realtime) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592    <span class="keywordflow">return</span> 0;
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a><a class="code" href="res__config__pgsql_8c.html#eaf793e807a29b69460b0c6c94a79a0b">00595</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597    <span class="comment">/* Aquire control before doing anything to the module itself. */</span>
<a name="l00598"></a>00598    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) {
<a name="l00601"></a>00601       PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00602"></a>00602       pgsqlConn = NULL;
<a name="l00603"></a>00603    };
<a name="l00604"></a>00604    <a class="code" href="cli_8c.html#321c001e02fcba48873965ff141ff29b">ast_cli_unregister_multiple</a>(cli_realtime, <span class="keyword">sizeof</span>(cli_realtime) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l00605"></a>00605    <a class="code" href="config_8c.html#8623aace9f1a314413e15da66d77839f">ast_config_engine_deregister</a>(&amp;pgsql_engine);
<a name="l00606"></a>00606    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a>) {
<a name="l00607"></a>00607       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"Postgresql RealTime unloaded.\n"</span>);
<a name="l00608"></a>00608    }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610    <a class="code" href="module_8h.html#c41f250c8ab8ddcb77214a7b149c9e71">ast_module_user_hangup_all</a>();
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="comment">/* Unlock so something else can destroy the lock. */</span>
<a name="l00613"></a>00613    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615    <span class="keywordflow">return</span> 0;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a><a class="code" href="res__config__pgsql_8c.html#91875b0435b600b8ed0e424d70d492b0">00618</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>(<span class="keywordtype">void</span>)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620    <span class="comment">/* Aquire control before doing anything to the module itself. */</span>
<a name="l00621"></a>00621    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;pgsql_lock);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) {
<a name="l00624"></a>00624       PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00625"></a>00625       pgsqlConn = NULL;
<a name="l00626"></a>00626    };
<a name="l00627"></a>00627    <a class="code" href="codec__adpcm_8c.html#36977d043c20a810ce9f805853c0424e">parse_config</a>();
<a name="l00628"></a>00628 
<a name="l00629"></a>00629    <span class="keywordflow">if</span> (!<a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(NULL)) {
<a name="l00630"></a>00630       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00631"></a>00631             <span class="stringliteral">"Postgresql RealTime: Couldn't establish connection. Check debug.\n"</span>);
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00633"></a>00633          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Cannot Connect: %s\n"</span>,
<a name="l00634"></a>00634                PQerrorMessage(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>));
<a name="l00635"></a>00635    }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637    <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Postgresql RealTime reloaded.\n"</span>);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639    <span class="comment">/* Done reloading. Release lock so others can now use driver. */</span>
<a name="l00640"></a>00640    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;pgsql_lock);
<a name="l00641"></a>00641 
<a name="l00642"></a>00642    <span class="keywordflow">return</span> 0;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a><a class="code" href="res__config__pgsql_8c.html#36977d043c20a810ce9f805853c0424e">00645</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="codec__adpcm_8c.html#36977d043c20a810ce9f805853c0424e">parse_config</a>(<span class="keywordtype">void</span>)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>;
<a name="l00648"></a>00648    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650    config = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<a class="code" href="res__config__pgsql_8c.html#1ac5543c2a28139c8a7263b1d57b53e9">RES_CONFIG_PGSQL_CONF</a>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    <span class="keywordflow">if</span> (!config) {
<a name="l00653"></a>00653       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to load config %s\n"</span>,<a class="code" href="res__config__pgsql_8c.html#1ac5543c2a28139c8a7263b1d57b53e9">RES_CONFIG_PGSQL_CONF</a>);
<a name="l00654"></a>00654       <span class="keywordflow">return</span> 0;
<a name="l00655"></a>00655    }
<a name="l00656"></a>00656    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbuser"</span>))) {
<a name="l00657"></a>00657       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00658"></a>00658             <span class="stringliteral">"Postgresql RealTime: No database user found, using 'asterisk' as default.\n"</span>);
<a name="l00659"></a>00659       strcpy(<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>, <span class="stringliteral">"asterisk"</span>);
<a name="l00660"></a>00660    } <span class="keywordflow">else</span> {
<a name="l00661"></a>00661       ast_copy_string(<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>));
<a name="l00662"></a>00662    }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbpass"</span>))) {
<a name="l00665"></a>00665       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00666"></a>00666             <span class="stringliteral">"Postgresql RealTime: No database password found, using 'asterisk' as default.\n"</span>);
<a name="l00667"></a>00667       strcpy(<a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>, <span class="stringliteral">"asterisk"</span>);
<a name="l00668"></a>00668    } <span class="keywordflow">else</span> {
<a name="l00669"></a>00669       ast_copy_string(<a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>));
<a name="l00670"></a>00670    }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbhost"</span>))) {
<a name="l00673"></a>00673       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00674"></a>00674             <span class="stringliteral">"Postgresql RealTime: No database host found, using localhost via socket.\n"</span>);
<a name="l00675"></a>00675       <a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>[0] = <span class="charliteral">'\0'</span>;
<a name="l00676"></a>00676    } <span class="keywordflow">else</span> {
<a name="l00677"></a>00677       ast_copy_string(<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>));
<a name="l00678"></a>00678    }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbname"</span>))) {
<a name="l00681"></a>00681       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00682"></a>00682             <span class="stringliteral">"Postgresql RealTime: No database name found, using 'asterisk' as default.\n"</span>);
<a name="l00683"></a>00683       strcpy(<a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, <span class="stringliteral">"asterisk"</span>);
<a name="l00684"></a>00684    } <span class="keywordflow">else</span> {
<a name="l00685"></a>00685       ast_copy_string(<a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>));
<a name="l00686"></a>00686    }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688    <span class="keywordflow">if</span> (!(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbport"</span>))) {
<a name="l00689"></a>00689       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00690"></a>00690             <span class="stringliteral">"Postgresql RealTime: No database port found, using 5432 as default.\n"</span>);
<a name="l00691"></a>00691       <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a> = 5432;
<a name="l00692"></a>00692    } <span class="keywordflow">else</span> {
<a name="l00693"></a>00693       <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a> = atoi(s);
<a name="l00694"></a>00694    }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a> &amp;&amp; !(s = <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(config, <span class="stringliteral">"general"</span>, <span class="stringliteral">"dbsock"</span>))) {
<a name="l00697"></a>00697       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,
<a name="l00698"></a>00698             <span class="stringliteral">"Postgresql RealTime: No database socket found, using '/tmp/pgsql.sock' as default.\n"</span>);
<a name="l00699"></a>00699       strcpy(<a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>, <span class="stringliteral">"/tmp/pgsql.sock"</span>);
<a name="l00700"></a>00700    } <span class="keywordflow">else</span> {
<a name="l00701"></a>00701       ast_copy_string(<a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>, s, <span class="keyword">sizeof</span>(<a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>));
<a name="l00702"></a>00702    }
<a name="l00703"></a>00703    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(config);
<a name="l00704"></a>00704 
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l00706"></a>00706       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>) {
<a name="l00707"></a>00707          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime Host: %s\n"</span>, dbhost);
<a name="l00708"></a>00708          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime Port: %i\n"</span>, <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a>);
<a name="l00709"></a>00709       } <span class="keywordflow">else</span> {
<a name="l00710"></a>00710          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime Socket: %s\n"</span>, <a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>);
<a name="l00711"></a>00711       }
<a name="l00712"></a>00712       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime User: %s\n"</span>, <a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>);
<a name="l00713"></a>00713       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime Password: %s\n"</span>, <a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>);
<a name="l00714"></a>00714       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime DBName: %s\n"</span>, <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>);
<a name="l00715"></a>00715    }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717    <span class="keywordflow">return</span> 1;
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a><a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">00720</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#c55365be31b2b5d893333a64e8717372">pgsql_reconnect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722    <span class="keywordtype">char</span> my_database[50];
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    ast_copy_string(my_database, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(database, <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>), <span class="keyword">sizeof</span>(my_database));
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    <span class="comment">/* mutex lock should have been locked before calling this function. */</span>
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) != CONNECTION_OK) {
<a name="l00729"></a>00729       PQfinish(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00730"></a>00730       pgsqlConn = NULL;
<a name="l00731"></a>00731    }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    <span class="keywordflow">if</span> ((!<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) &amp;&amp; (<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a> || <a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>) &amp;&amp; <a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a> &amp;&amp; <a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a> &amp;&amp; my_database) {
<a name="l00734"></a>00734       <span class="keywordtype">char</span> *connInfo = NULL;
<a name="l00735"></a>00735       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 100 + strlen(<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>)
<a name="l00736"></a>00736          + strlen(<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>)
<a name="l00737"></a>00737          + strlen(<a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>)
<a name="l00738"></a>00738          + strlen(my_database);
<a name="l00739"></a>00739       
<a name="l00740"></a>00740       <span class="keywordflow">if</span> (!(connInfo = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(size)))
<a name="l00741"></a>00741          <span class="keywordflow">return</span> 0;
<a name="l00742"></a>00742       
<a name="l00743"></a>00743       sprintf(connInfo, <span class="stringliteral">"host=%s port=%d dbname=%s user=%s password=%s"</span>,
<a name="l00744"></a>00744                <a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>, <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a>, my_database, <a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>, <a class="code" href="res__config__pgsql_8c.html#d2491e37bfd8845c48030af14a01830d">dbpass</a>);
<a name="l00745"></a>00745       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00746"></a>00746          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"%u connInfo=%s\n"</span>, size, connInfo);
<a name="l00747"></a>00747       <a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a> = PQconnectdb(connInfo);
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00749"></a>00749          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"%u connInfo=%s\n"</span>, size, connInfo);
<a name="l00750"></a>00750       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(connInfo);
<a name="l00751"></a>00751       connInfo = NULL;
<a name="l00752"></a>00752       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00753"></a>00753          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"pgsqlConn=%p\n"</span>, <a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>);
<a name="l00754"></a>00754       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) == CONNECTION_OK) {
<a name="l00755"></a>00755          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00756"></a>00756             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Successfully connected to database.\n"</span>);
<a name="l00757"></a>00757          <a class="code" href="res__config__pgsql_8c.html#d5c66d45146d1cfddb1040c593312d9d">connect_time</a> = time(NULL);
<a name="l00758"></a>00758          <span class="keywordflow">return</span> 1;
<a name="l00759"></a>00759       } <span class="keywordflow">else</span> {
<a name="l00760"></a>00760          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>,
<a name="l00761"></a>00761                <span class="stringliteral">"Postgresql RealTime: Failed to connect database server %s on %s. Check debug for more info.\n"</span>,
<a name="l00762"></a>00762                <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>);
<a name="l00763"></a>00763          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00764"></a>00764             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Postgresql RealTime: Cannot Connect: %s\n"</span>,
<a name="l00765"></a>00765                   PQresultErrorMessage(NULL));
<a name="l00766"></a>00766          <span class="keywordflow">return</span> 0;
<a name="l00767"></a>00767       }
<a name="l00768"></a>00768    } <span class="keywordflow">else</span> {
<a name="l00769"></a>00769       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00770"></a>00770          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Postgresql RealTime: Everything is fine.\n"</span>);
<a name="l00771"></a>00771       <span class="keywordflow">return</span> 1;
<a name="l00772"></a>00772    }
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a><a class="code" href="res__config__pgsql_8c.html#bc9aed9daac60799f0b13b5eb4b39f85">00775</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__pgsql_8c.html#bc9aed9daac60799f0b13b5eb4b39f85">realtime_pgsql_status</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00776"></a>00776 {
<a name="l00777"></a>00777    <span class="keywordtype">char</span> status[256], status2[100] = <span class="stringliteral">""</span>;
<a name="l00778"></a>00778    <span class="keywordtype">int</span> ctime = time(NULL) - <a class="code" href="res__config__pgsql_8c.html#d5c66d45146d1cfddb1040c593312d9d">connect_time</a>;
<a name="l00779"></a>00779 
<a name="l00780"></a>00780    <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a> &amp;&amp; PQstatus(<a class="code" href="res__config__pgsql_8c.html#d4833e45f5ea946b1abe1915c97c6ae6">pgsqlConn</a>) == CONNECTION_OK) {
<a name="l00781"></a>00781       <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#220005a7d71c5d405697712239e7af22">dbhost</a>) {
<a name="l00782"></a>00782          snprintf(status, 255, <span class="stringliteral">"Connected to %s@%s, port %d"</span>, <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, dbhost, <a class="code" href="res__config__pgsql_8c.html#a79dd7e2fe73ba0df82f016addb123b8">dbport</a>);
<a name="l00783"></a>00783       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>) {
<a name="l00784"></a>00784          snprintf(status, 255, <span class="stringliteral">"Connected to %s on socket file %s"</span>, <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, <a class="code" href="res__config__pgsql_8c.html#a0a40f916795056f84fc753d82e56524">dbsock</a>);
<a name="l00785"></a>00785       } <span class="keywordflow">else</span> {
<a name="l00786"></a>00786          snprintf(status, 255, <span class="stringliteral">"Connected to %s@%s"</span>, <a class="code" href="cdr__tds_8c.html#4cd4a49f25984e26fe708c1fbd896653">dbname</a>, dbhost);
<a name="l00787"></a>00787       }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789       <span class="keywordflow">if</span> (<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a> &amp;&amp; *<a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>) {
<a name="l00790"></a>00790          snprintf(status2, 99, <span class="stringliteral">" with username %s"</span>, <a class="code" href="cdr__tds_8c.html#6402673de752e4271e326e0f2029848a">dbuser</a>);
<a name="l00791"></a>00791       }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793       <span class="keywordflow">if</span> (ctime &gt; 31536000) {
<a name="l00794"></a>00794          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s%s for %d years, %d days, %d hours, %d minutes, %d seconds.\n"</span>,
<a name="l00795"></a>00795                status, status2, ctime / 31536000, (ctime % 31536000) / 86400,
<a name="l00796"></a>00796                (ctime % 86400) / 3600, (ctime % 3600) / 60, ctime % 60);
<a name="l00797"></a>00797       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctime &gt; 86400) {
<a name="l00798"></a>00798          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s%s for %d days, %d hours, %d minutes, %d seconds.\n"</span>, status,
<a name="l00799"></a>00799                status2, ctime / 86400, (ctime % 86400) / 3600, (ctime % 3600) / 60,
<a name="l00800"></a>00800                ctime % 60);
<a name="l00801"></a>00801       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctime &gt; 3600) {
<a name="l00802"></a>00802          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s%s for %d hours, %d minutes, %d seconds.\n"</span>, status, status2,
<a name="l00803"></a>00803                ctime / 3600, (ctime % 3600) / 60, ctime % 60);
<a name="l00804"></a>00804       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctime &gt; 60) {
<a name="l00805"></a>00805          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s%s for %d minutes, %d seconds.\n"</span>, status, status2, ctime / 60,
<a name="l00806"></a>00806                ctime % 60);
<a name="l00807"></a>00807       } <span class="keywordflow">else</span> {
<a name="l00808"></a>00808          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%s%s for %d seconds.\n"</span>, status, status2, ctime);
<a name="l00809"></a>00809       }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00812"></a>00812    } <span class="keywordflow">else</span> {
<a name="l00813"></a>00813       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#029ade91f74f40adbbae98503f72e91b">RESULT_FAILURE</a>;
<a name="l00814"></a>00814    }
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 <span class="comment">/* needs usecount semantics defined */</span>
<a name="l00818"></a>00818 <a class="code" href="module_8h.html#237cb97341e39c38b6e3ecb88b7ea148">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#b4566594eeb42c8fc7d6733c7b4b6c0a0b99d39f1f6a9afeedd2f8e6632dd76c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">"PostgreSQL RealTime Configuration Driver"</span>,
<a name="l00819"></a>00819       .load = <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>,
<a name="l00820"></a>00820       .unload = <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>,
<a name="l00821"></a>00821       .<a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a> = <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>
<a name="l00822"></a>00822           );
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:49 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
