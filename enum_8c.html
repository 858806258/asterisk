<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:27 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>enum.c File Reference</h1>ENUM Support for Asterisk. <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="asterisk_8h-source.html">asterisk.h</a>&quot;</code><br>
<code>#include &lt;sys/types.h&gt;</code><br>
<code>#include &lt;sys/socket.h&gt;</code><br>
<code>#include &lt;netinet/in.h&gt;</code><br>
<code>#include &lt;arpa/nameser.h&gt;</code><br>
<code>#include &lt;resolv.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;ctype.h&gt;</code><br>
<code>#include &lt;regex.h&gt;</code><br>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;errno.h&gt;</code><br>
<code>#include &quot;<a class="el" href="logger_8h-source.html">asterisk/logger.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="options_8h-source.html">asterisk/options.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="enum_8h-source.html">asterisk/enum.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="dns_8h-source.html">asterisk/dns.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="channel_8h-source.html">asterisk/channel.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="config_8h-source.html">asterisk/config.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="utils_8h-source.html">asterisk/utils.h</a>&quot;</code><br>

<p>
<a href="enum_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structenum__search.html">enum_search</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#16e1fac00538171b399441662981db4a">TOPLEV</a>&nbsp;&nbsp;&nbsp;&quot;e164.arpa.&quot;</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#38b0f30a351c03e99bcf678c23a412db">ast_enum_init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize the ENUM support subsystem.  <a href="#38b0f30a351c03e99bcf678c23a412db"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#4b5c4efdd790567bb9c84cc7d0a798c0">ast_enum_reload</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#e0be79c05583f9e7c919c9dfa55d54a2">ast_get_enum</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, const char *<a class="el" href="structnumber.html">number</a>, char *dst, int dstlen, char *tech, int techlen, char *suffix, char *options, unsigned int record, struct <a class="el" href="structenum__context.html">enum_context</a> **argcontext)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Lookup entry in ENUM Returns 1 if found, 0 if not found, -1 on hangup.  <a href="#e0be79c05583f9e7c919c9dfa55d54a2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#d89c316893d352020d8dab01d6c17e30">ast_get_txt</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, const char *<a class="el" href="structnumber.html">number</a>, char *dst, int dstlen, char *tech, int techlen, char *txt, int txtlen)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Lookup DNS TXT record (used by app TXTCIDnum.  <a href="#d89c316893d352020d8dab01d6c17e30"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#b33494d6e1743a529a70b577964c0612">AST_MUTEX_DEFINE_STATIC</a> (enumlock)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#142880f81dc26c3ab290fa2b58e162e0">enum_callback</a> (void *<a class="el" href="cdr__tds_8c.html#5c18ef72771564b7f43c497dc507aeab">context</a>, unsigned char *<a class="el" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, int len, unsigned char *fullanswer)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Callback from ENUM lookup function.  <a href="#142880f81dc26c3ab290fa2b58e162e0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static struct <a class="el" href="structenum__search.html">enum_search</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#a6adcdb1292b83c88aba50586b6b2a98">enum_newtoplev</a> (char *s)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add enum tree to linked list.  <a href="#a6adcdb1292b83c88aba50586b6b2a98"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#25b84225c5d58c760b6ffd10cb27f14e">parse_ie</a> (char *data, unsigned int maxdatalen, unsigned char *src, unsigned int srclen)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse NAPTR record information elements.  <a href="#25b84225c5d58c760b6ffd10cb27f14e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#f012db47459604384c13d56b7701f5a4">parse_naptr</a> (char *dst, int dstsize, char *tech, int techsize, unsigned char *<a class="el" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, int len, char *naptrinput)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse DNS NAPTR record used in ENUM ---.  <a href="#f012db47459604384c13d56b7701f5a4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#bb82156bb23a604afde8db589e7c6a51">txt_callback</a> (void *<a class="el" href="cdr__tds_8c.html#5c18ef72771564b7f43c497dc507aeab">context</a>, unsigned char *<a class="el" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, int len, unsigned char *fullanswer)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Callback for TXT record lookup.  <a href="#bb82156bb23a604afde8db589e7c6a51"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static struct <a class="el" href="structenum__search.html">enum_search</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
ENUM Support for Asterisk. 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt;</dd></dl>
<ul>
<li>Funding provided by nic.at</li>
</ul>
<dl compact><dt><b>Enum standards</b></dt><dd></dd></dl>
<ul>
<li>NAPTR records: <a href="http://ietf.nri.reston.va.us/rfc/rfc2915.txt">http://ietf.nri.reston.va.us/rfc/rfc2915.txt</a></li><li>DNS SRV records: <a href="http://www.ietf.org/rfc/rfc2782.txt">http://www.ietf.org/rfc/rfc2782.txt</a></li><li>ENUM <a href="http://www.ietf.org/rfc/rfc3761.txt">http://www.ietf.org/rfc/rfc3761.txt</a></li><li>ENUM for H.323: <a href="http://www.ietf.org/rfc/rfc3762.txt">http://www.ietf.org/rfc/rfc3762.txt</a></li><li>ENUM SIP: <a href="http://www.ietf.org/rfc/rfc3764.txt">http://www.ietf.org/rfc/rfc3764.txt</a></li><li>IANA ENUM Services: <a href="http://www.iana.org/assignments/enum-services">http://www.iana.org/assignments/enum-services</a></li></ul>
<p>
<dl compact><dt><b>Possible improvement</b></dt><dd></dd></dl>
<dl compact><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>Implement a caching mechanism for multile enum lookups<ul>
<li>See <a href="http://bugs.digium.com/view.php?id=6739">http://bugs.digium.com/view.php?id=6739</a> </li></ul>
</dd></dl>

<p>
Definition in file <a class="el" href="enum_8c-source.html">enum.c</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="83bd02551d0d85f5573c8aa214aa8ee1"></a><!-- doxytag: member="enum.c::ENUMLOOKUP_OPTIONS_COUNT" ref="83bd02551d0d85f5573c8aa214aa8ee1" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define ENUMLOOKUP_OPTIONS_COUNT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00294">294</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00367">ast_get_enum()</a>, and <a class="el" href="enum_8c-source.html#l00330">enum_callback()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="16e1fac00538171b399441662981db4a"></a><!-- doxytag: member="enum.c::TOPLEV" ref="16e1fac00538171b399441662981db4a" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define TOPLEV&nbsp;&nbsp;&nbsp;&quot;e164.arpa.&quot;          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The IETF Enum standard root, managed by the ITU 
<p>
Definition at line <a class="el" href="enum_8c-source.html#l00082">82</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00613">ast_enum_init()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="38b0f30a351c03e99bcf678c23a412db"></a><!-- doxytag: member="enum.c::ast_enum_init" ref="38b0f30a351c03e99bcf678c23a412db" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_enum_init           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initialize the ENUM support subsystem. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00613">613</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="config_8c-source.html#l00555">ast_config_destroy()</a>, <a class="el" href="config_8c-source.html#l01278">ast_config_load()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="config_8c-source.html#l00222">ast_variable_browse()</a>, <a class="el" href="enum_8c-source.html#l00602">enum_newtoplev()</a>, <a class="el" href="enum_8c-source.html#l00090">enumver</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="config_8h-source.html#l00039">ast_variable::name</a>, <a class="el" href="enum_8c-source.html#l00087">enum_search::next</a>, <a class="el" href="config_8h-source.html#l00046">ast_variable::next</a>, <a class="el" href="aesopt_8h-source.html#l00399">s</a>, <a class="el" href="enum_8c-source.html#l00082">TOPLEV</a>, <a class="el" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>, and <a class="el" href="config_8h-source.html#l00040">ast_variable::value</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00654">ast_enum_reload()</a>, and <a class="el" href="asterisk_8c-source.html#l02570">main()</a>.<div class="fragment"><pre class="fragment"><a name="l00614"></a>00614 {
<a name="l00615"></a>00615    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00616"></a>00616    <span class="keyword">struct </span><a class="code" href="structenum__search.html">enum_search</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, *sl;
<a name="l00617"></a>00617    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619    <span class="comment">/* Destroy existing list */</span>
<a name="l00620"></a>00620    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;enumlock);
<a name="l00621"></a>00621    s = <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>;
<a name="l00622"></a>00622    <span class="keywordflow">while</span> (s) {
<a name="l00623"></a>00623       sl = s;
<a name="l00624"></a>00624       s = s-&gt;<a class="code" href="structenum__search.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00625"></a>00625       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(sl);
<a name="l00626"></a>00626    }
<a name="l00627"></a>00627    <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a> = NULL;
<a name="l00628"></a>00628    cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<span class="stringliteral">"enum.conf"</span>);
<a name="l00629"></a>00629    <span class="keywordflow">if</span> (cfg) {
<a name="l00630"></a>00630       sl = NULL;
<a name="l00631"></a>00631       v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"general"</span>);
<a name="l00632"></a>00632       <span class="keywordflow">while</span> (v) {
<a name="l00633"></a>00633          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"search"</span>)) {
<a name="l00634"></a>00634             s = <a class="code" href="enum_8c.html#a6adcdb1292b83c88aba50586b6b2a98">enum_newtoplev</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00635"></a>00635             <span class="keywordflow">if</span> (s) {
<a name="l00636"></a>00636                <span class="keywordflow">if</span> (sl)
<a name="l00637"></a>00637                   sl-&gt;next = s;
<a name="l00638"></a>00638                <span class="keywordflow">else</span>
<a name="l00639"></a>00639                   <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a> = s;
<a name="l00640"></a>00640                sl = s;
<a name="l00641"></a>00641             }
<a name="l00642"></a>00642          }
<a name="l00643"></a>00643          v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00644"></a>00644       }
<a name="l00645"></a>00645       <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l00646"></a>00646    } <span class="keywordflow">else</span> {
<a name="l00647"></a>00647       <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a> = <a class="code" href="enum_8c.html#a6adcdb1292b83c88aba50586b6b2a98">enum_newtoplev</a>(<a class="code" href="enum_8c.html#16e1fac00538171b399441662981db4a">TOPLEV</a>);
<a name="l00648"></a>00648    }
<a name="l00649"></a>00649    <a class="code" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a>++;
<a name="l00650"></a>00650    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;enumlock);
<a name="l00651"></a>00651    <span class="keywordflow">return</span> 0;
<a name="l00652"></a>00652 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="4b5c4efdd790567bb9c84cc7d0a798c0"></a><!-- doxytag: member="enum.c::ast_enum_reload" ref="4b5c4efdd790567bb9c84cc7d0a798c0" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_enum_reload           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00654">654</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="enum_8c-source.html#l00613">ast_enum_init()</a>.<div class="fragment"><pre class="fragment"><a name="l00655"></a>00655 {
<a name="l00656"></a>00656    <span class="keywordflow">return</span> <a class="code" href="enum_8c.html#38b0f30a351c03e99bcf678c23a412db">ast_enum_init</a>();
<a name="l00657"></a>00657 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="e0be79c05583f9e7c919c9dfa55d54a2"></a><!-- doxytag: member="enum.c::ast_get_enum" ref="e0be79c05583f9e7c919c9dfa55d54a2" args="(struct ast_channel *chan, const char *number, char *dst, int dstlen, char *tech, int techlen, char *suffix, char *options, unsigned int record, struct enum_context **argcontext)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_get_enum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>location</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxloc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>technology</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxtech</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>suffix</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>options</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>record</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>struct <a class="el" href="structenum__context.html">enum_context</a> **&nbsp;</td>
          <td class="mdname" nowrap> <em>argcontext</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Lookup entry in ENUM Returns 1 if found, 0 if not found, -1 on hangup. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>Channel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>number</em>&nbsp;</td><td>E164 number with or without the leading + </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>location</em>&nbsp;</td><td>Number returned (or SIP uri) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxloc</em>&nbsp;</td><td>Max length </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>technology</em>&nbsp;</td><td>Technology (from url scheme in response) You can set it to get particular answer RR, if there are many techs in DNS response, example: "sip" If you need any record, then set it to empty string </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxtech</em>&nbsp;</td><td>Max length </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>suffix</em>&nbsp;</td><td>Zone suffix (if is NULL then use enum.conf 'search' variable) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>options</em>&nbsp;</td><td>Options ('c' to count number of NAPTR RR) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>record</em>&nbsp;</td><td>The position of required RR in the answer list </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>argcontext</em>&nbsp;</td><td>Argument for caching results into an <a class="el" href="structenum__context.html">enum_context</a> pointer (NULL is used for not caching) </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00367">367</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="autoservice_8c-source.html#l00096">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c-source.html#l00130">ast_autoservice_stop()</a>, <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="dns_8c-source.html#l00201">ast_search_dns()</a>, <a class="el" href="enum_8c-source.html#l00330">enum_callback()</a>, <a class="el" href="enum_8c-source.html#l00294">ENUMLOOKUP_OPTIONS_COUNT</a>, <a class="el" href="enum_8c-source.html#l00090">enumver</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="enum_8h-source.html#l00047">enum_context::naptrinput</a>, <a class="el" href="enum_8c-source.html#l00087">enum_search::next</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="aesopt_8h-source.html#l00399">s</a>, <a class="el" href="enum_8c-source.html#l00086">enum_search::toplev</a>, and <a class="el" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>.
<p>
Referenced by <a class="el" href="func__enum_8c-source.html#l00155">enum_query_read()</a>, and <a class="el" href="func__enum_8c-source.html#l00057">function_enum()</a>.<div class="fragment"><pre class="fragment"><a name="l00368"></a>00368 {
<a name="l00369"></a>00369    <span class="keyword">struct </span><a class="code" href="structenum__context.html">enum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00370"></a>00370    <span class="keywordtype">char</span> tmp[259 + 512];
<a name="l00371"></a>00371    <span class="keywordtype">char</span> <a class="code" href="structenum__context.html#c8ecfcb421364b9d2037aa1d9304ca80">naptrinput</a>[512];
<a name="l00372"></a>00372    <span class="keywordtype">int</span> pos = strlen(<a class="code" href="structnumber.html">number</a>) - 1;
<a name="l00373"></a>00373    <span class="keywordtype">int</span> newpos = 0;
<a name="l00374"></a>00374    <span class="keywordtype">int</span> ret = -1;
<a name="l00375"></a>00375    <span class="keyword">struct </span><a class="code" href="structenum__search.html">enum_search</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = NULL;
<a name="l00376"></a>00376    <span class="keywordtype">int</span> version = -1;
<a name="l00377"></a>00377    <span class="comment">/* for ISN rewrite */</span>
<a name="l00378"></a>00378    <span class="keywordtype">char</span> *p1 = NULL;
<a name="l00379"></a>00379    <span class="keywordtype">char</span> *p2 = NULL;
<a name="l00380"></a>00380    <span class="keywordtype">int</span> k = 0;
<a name="l00381"></a>00381    <span class="keywordtype">int</span> i = 0;
<a name="l00382"></a>00382    <span class="keywordtype">int</span> z = 0;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <span class="keywordflow">if</span> (!(context = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*context))))
<a name="l00385"></a>00385       <span class="keywordflow">return</span> -1;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387    ast_copy_string(naptrinput, <a class="code" href="structnumber.html">number</a>[0] == <span class="charliteral">'n'</span> ? <a class="code" href="structnumber.html">number</a>+1 : <a class="code" href="structnumber.html">number</a>, <span class="keyword">sizeof</span>(naptrinput));
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    context-&gt;naptrinput = naptrinput;   <span class="comment">/* The number */</span>
<a name="l00390"></a>00390    context-&gt;dst = dst;        <span class="comment">/* Return string */</span>
<a name="l00391"></a>00391    context-&gt;dstlen = dstlen;
<a name="l00392"></a>00392    context-&gt;tech = tech;
<a name="l00393"></a>00393    context-&gt;techlen = techlen;
<a name="l00394"></a>00394    context-&gt;options = 0;
<a name="l00395"></a>00395    context-&gt;position = record;
<a name="l00396"></a>00396    context-&gt;naptr_rrs = NULL;
<a name="l00397"></a>00397    context-&gt;naptr_rrs_count = 0;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    <span class="keywordflow">if</span> (options != NULL) {
<a name="l00400"></a>00400       <span class="keywordflow">if</span> (*options == <span class="charliteral">'c'</span>) {
<a name="l00401"></a>00401          context-&gt;options = <a class="code" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>;
<a name="l00402"></a>00402          context-&gt;position = 0;
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404    }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_get_enum(): n='%s', tech='%s', suffix='%s', options='%d', record='%d'\n"</span>,
<a name="l00407"></a>00407          <a class="code" href="structnumber.html">number</a>, tech, suffix, context-&gt;options, context-&gt;position);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409    <span class="keywordflow">if</span> (pos &gt; 128)
<a name="l00410"></a>00410       pos = 128;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <span class="comment">/* ISN rewrite */</span>
<a name="l00413"></a>00413    p1 = strchr(<a class="code" href="structnumber.html">number</a>, <span class="charliteral">'*'</span>);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="keywordflow">if</span> (<a class="code" href="structnumber.html">number</a>[0] == <span class="charliteral">'n'</span>) { <span class="comment">/* do not perform ISN rewrite ('n' is testing flag) */</span>
<a name="l00416"></a>00416       p1 = NULL;
<a name="l00417"></a>00417       k = 1; <span class="comment">/* strip 'n' from number */</span>
<a name="l00418"></a>00418    }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420    <span class="keywordflow">if</span> (p1 != NULL) {
<a name="l00421"></a>00421       p2 = p1+1;
<a name="l00422"></a>00422       <span class="keywordflow">while</span> (p1 &gt; <a class="code" href="structnumber.html">number</a>){
<a name="l00423"></a>00423          p1--;
<a name="l00424"></a>00424          tmp[newpos++] = *p1;
<a name="l00425"></a>00425          tmp[newpos++] = <span class="charliteral">'.'</span>;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427       <span class="keywordflow">if</span> (*p2) {
<a name="l00428"></a>00428          <span class="keywordflow">while</span> (*p2 &amp;&amp; newpos &lt; 128){
<a name="l00429"></a>00429             tmp[newpos++] = *p2;
<a name="l00430"></a>00430             p2++;
<a name="l00431"></a>00431          }
<a name="l00432"></a>00432          tmp[newpos++] = <span class="charliteral">'.'</span>;
<a name="l00433"></a>00433       }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    } <span class="keywordflow">else</span> {
<a name="l00436"></a>00436       <span class="keywordflow">while</span> (pos &gt;= k) {
<a name="l00437"></a>00437          <span class="keywordflow">if</span> (isdigit(<a class="code" href="structnumber.html">number</a>[pos])) {
<a name="l00438"></a>00438             tmp[newpos++] = <a class="code" href="structnumber.html">number</a>[pos];
<a name="l00439"></a>00439             tmp[newpos++] = <span class="charliteral">'.'</span>;
<a name="l00440"></a>00440          }
<a name="l00441"></a>00441          pos--;
<a name="l00442"></a>00442       }
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    <span class="keywordflow">if</span> (chan &amp;&amp; <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(chan) &lt; 0) {
<a name="l00446"></a>00446       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context);
<a name="l00447"></a>00447       <span class="keywordflow">return</span> -1;
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (suffix) {
<a name="l00451"></a>00451       ast_copy_string(tmp + newpos, suffix, <span class="keyword">sizeof</span>(tmp) - newpos);
<a name="l00452"></a>00452       ret = <a class="code" href="dns_8c.html#336c75db464da83f0de567a19d26c64d">ast_search_dns</a>(context, tmp, C_IN, T_NAPTR, <a class="code" href="enum_8c.html#142880f81dc26c3ab290fa2b58e162e0">enum_callback</a>);
<a name="l00453"></a>00453       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_get_enum: ast_search_dns(%s) returned %d\n"</span>, tmp, ret);
<a name="l00454"></a>00454    } <span class="keywordflow">else</span> {
<a name="l00455"></a>00455       ret = -1;      <span class="comment">/* this is actually dead code since the demise of app_enum.c */</span>
<a name="l00456"></a>00456       <span class="keywordflow">for</span> (;;) {
<a name="l00457"></a>00457          <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;enumlock);
<a name="l00458"></a>00458          <span class="keywordflow">if</span> (version != <a class="code" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a>) {
<a name="l00459"></a>00459             <span class="comment">/* Ooh, a reload... */</span>
<a name="l00460"></a>00460             s = <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>;
<a name="l00461"></a>00461             version = <a class="code" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a>;
<a name="l00462"></a>00462          } <span class="keywordflow">else</span> {
<a name="l00463"></a>00463             s = s-&gt;<a class="code" href="structenum__search.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00464"></a>00464          }
<a name="l00465"></a>00465          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;enumlock);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467          <span class="keywordflow">if</span> (!s)
<a name="l00468"></a>00468             <span class="keywordflow">break</span>;
<a name="l00469"></a>00469    
<a name="l00470"></a>00470          ast_copy_string(tmp + newpos, s-&gt;<a class="code" href="structenum__search.html#b0dd6c59bbba66963fdc96642fec39c6">toplev</a>, <span class="keyword">sizeof</span>(tmp) - newpos);
<a name="l00471"></a>00471          ret = <a class="code" href="dns_8c.html#336c75db464da83f0de567a19d26c64d">ast_search_dns</a>(&amp;context, tmp, C_IN, T_NAPTR, <a class="code" href="enum_8c.html#142880f81dc26c3ab290fa2b58e162e0">enum_callback</a>);
<a name="l00472"></a>00472          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"ast_get_enum: ast_search_dns(%s) returned %d\n"</span>, tmp, ret);
<a name="l00473"></a>00473          <span class="keywordflow">if</span> (ret &gt; 0)
<a name="l00474"></a>00474             <span class="keywordflow">break</span>;
<a name="l00475"></a>00475       }
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478    <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l00479"></a>00479       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00480"></a>00480          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"No such number found: %s (%s)\n"</span>, tmp, strerror(errno));
<a name="l00481"></a>00481       strcpy(dst, <span class="stringliteral">"0"</span>);
<a name="l00482"></a>00482       ret = 0;
<a name="l00483"></a>00483    }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    <span class="keywordflow">if</span> (context-&gt;naptr_rrs_count &gt;= context-&gt;position &amp;&amp; ! (context-&gt;options &amp; <a class="code" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>)) {
<a name="l00486"></a>00486       <span class="comment">/* sort array by NAPTR order/preference */</span>
<a name="l00487"></a>00487       <span class="keywordflow">for</span> (k = 0; k &lt; context-&gt;naptr_rrs_count; k++) {
<a name="l00488"></a>00488          <span class="keywordflow">for</span> (i = 0; i &lt; context-&gt;naptr_rrs_count; i++) {
<a name="l00489"></a>00489             <span class="comment">/* use order first and then preference to compare */</span>
<a name="l00490"></a>00490             <span class="keywordflow">if</span> ((ntohs(context-&gt;naptr_rrs[k].naptr.order) &lt; ntohs(context-&gt;naptr_rrs[i].naptr.order)
<a name="l00491"></a>00491                   &amp;&amp; context-&gt;naptr_rrs[k].sort_pos &gt; context-&gt;naptr_rrs[i].sort_pos)
<a name="l00492"></a>00492                || (ntohs(context-&gt;naptr_rrs[k].naptr.order) &gt; ntohs(context-&gt;naptr_rrs[i].naptr.order)
<a name="l00493"></a>00493                   &amp;&amp; context-&gt;naptr_rrs[k].sort_pos &lt; context-&gt;naptr_rrs[i].sort_pos)){
<a name="l00494"></a>00494                z = context-&gt;naptr_rrs[k].sort_pos;
<a name="l00495"></a>00495                context-&gt;naptr_rrs[k].sort_pos = context-&gt;naptr_rrs[i].sort_pos;
<a name="l00496"></a>00496                context-&gt;naptr_rrs[i].sort_pos = z;
<a name="l00497"></a>00497                <span class="keywordflow">continue</span>;
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499             <span class="keywordflow">if</span> (ntohs(context-&gt;naptr_rrs[k].naptr.order) == ntohs(context-&gt;naptr_rrs[i].naptr.order)) {
<a name="l00500"></a>00500                <span class="keywordflow">if</span> ((ntohs(context-&gt;naptr_rrs[k].naptr.pref) &lt; ntohs(context-&gt;naptr_rrs[i].naptr.pref)
<a name="l00501"></a>00501                      &amp;&amp; context-&gt;naptr_rrs[k].sort_pos &gt; context-&gt;naptr_rrs[i].sort_pos)
<a name="l00502"></a>00502                   || (ntohs(context-&gt;naptr_rrs[k].naptr.pref) &gt; ntohs(context-&gt;naptr_rrs[i].naptr.pref)
<a name="l00503"></a>00503                      &amp;&amp; context-&gt;naptr_rrs[k].sort_pos &lt; context-&gt;naptr_rrs[i].sort_pos)){
<a name="l00504"></a>00504                   z = context-&gt;naptr_rrs[k].sort_pos;
<a name="l00505"></a>00505                   context-&gt;naptr_rrs[k].sort_pos = context-&gt;naptr_rrs[i].sort_pos;
<a name="l00506"></a>00506                   context-&gt;naptr_rrs[i].sort_pos = z;
<a name="l00507"></a>00507                }
<a name="l00508"></a>00508             }
<a name="l00509"></a>00509          }
<a name="l00510"></a>00510       }
<a name="l00511"></a>00511       <span class="keywordflow">for</span> (k = 0; k &lt; context-&gt;naptr_rrs_count; k++) {
<a name="l00512"></a>00512          <span class="keywordflow">if</span> (context-&gt;naptr_rrs[k].sort_pos == context-&gt;position-1) {
<a name="l00513"></a>00513             ast_copy_string(context-&gt;dst, context-&gt;naptr_rrs[k].result, dstlen);
<a name="l00514"></a>00514             ast_copy_string(context-&gt;tech, context-&gt;naptr_rrs[k].tech, techlen);
<a name="l00515"></a>00515             <span class="keywordflow">break</span>;
<a name="l00516"></a>00516          }
<a name="l00517"></a>00517       }
<a name="l00518"></a>00518    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(context-&gt;options &amp; <a class="code" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>)) {
<a name="l00519"></a>00519       context-&gt;dst[0] = 0;
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    <span class="keywordflow">if</span> (chan)
<a name="l00522"></a>00522       ret |= <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(chan);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524    <span class="keywordflow">if</span> (!argcontext) {
<a name="l00525"></a>00525       <span class="keywordflow">for</span> (k = 0; k &lt; context-&gt;naptr_rrs_count; k++) {
<a name="l00526"></a>00526          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context-&gt;naptr_rrs[k].result);
<a name="l00527"></a>00527          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context-&gt;naptr_rrs[k].tech);
<a name="l00528"></a>00528       }
<a name="l00529"></a>00529       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context-&gt;naptr_rrs);
<a name="l00530"></a>00530       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context);
<a name="l00531"></a>00531    } <span class="keywordflow">else</span>
<a name="l00532"></a>00532       *argcontext = context;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534    <span class="keywordflow">return</span> ret;
<a name="l00535"></a>00535 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d89c316893d352020d8dab01d6c17e30"></a><!-- doxytag: member="enum.c::ast_get_txt" ref="d89c316893d352020d8dab01d6c17e30" args="(struct ast_channel *chan, const char *number, char *dst, int dstlen, char *tech, int techlen, char *txt, int txtlen)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_get_txt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>location</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxloc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>technology</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxtech</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>txt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxtxt</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Lookup DNS TXT record (used by app TXTCIDnum. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>Channel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>number</em>&nbsp;</td><td>E164 number with or without the leading + </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>location</em>&nbsp;</td><td>Number returned (or SIP uri) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxloc</em>&nbsp;</td><td>Max length of number </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>technology</em>&nbsp;</td><td>Technology (not used in TXT records) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxtech</em>&nbsp;</td><td>Max length </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>txt</em>&nbsp;</td><td>Text string (return value) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxtxt</em>&nbsp;</td><td>Max length of "txt" </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00540">540</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="autoservice_8c-source.html#l00096">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c-source.html#l00130">ast_autoservice_stop()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="dns_8c-source.html#l00201">ast_search_dns()</a>, <a class="el" href="enum_8h-source.html#l00041">enum_context::dst</a>, <a class="el" href="enum_8h-source.html#l00042">enum_context::dstlen</a>, <a class="el" href="enum_8c-source.html#l00090">enumver</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="enum_8h-source.html#l00047">enum_context::naptrinput</a>, <a class="el" href="enum_8c-source.html#l00087">enum_search::next</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="aesopt_8h-source.html#l00399">s</a>, <a class="el" href="enum_8h-source.html#l00043">enum_context::tech</a>, <a class="el" href="enum_8h-source.html#l00044">enum_context::techlen</a>, <a class="el" href="enum_8c-source.html#l00086">enum_search::toplev</a>, <a class="el" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>, <a class="el" href="enum_8h-source.html#l00045">enum_context::txt</a>, <a class="el" href="enum_8c-source.html#l00298">txt_callback()</a>, and <a class="el" href="enum_8h-source.html#l00046">enum_context::txtlen</a>.
<p>
Referenced by <a class="el" href="func__enum_8c-source.html#l00346">function_txtcidname()</a>.<div class="fragment"><pre class="fragment"><a name="l00541"></a>00541 {
<a name="l00542"></a>00542    <span class="keyword">struct </span><a class="code" href="structenum__context.html">enum_context</a> context;
<a name="l00543"></a>00543    <span class="keywordtype">char</span> tmp[259 + 512];
<a name="l00544"></a>00544    <span class="keywordtype">char</span> <a class="code" href="structenum__context.html#c8ecfcb421364b9d2037aa1d9304ca80">naptrinput</a>[512] = <span class="stringliteral">"+"</span>;
<a name="l00545"></a>00545    <span class="keywordtype">int</span> pos = strlen(<a class="code" href="structnumber.html">number</a>) - 1;
<a name="l00546"></a>00546    <span class="keywordtype">int</span> newpos = 0;
<a name="l00547"></a>00547    <span class="keywordtype">int</span> ret = -1;
<a name="l00548"></a>00548    <span class="keyword">struct </span><a class="code" href="structenum__search.html">enum_search</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = NULL;
<a name="l00549"></a>00549    <span class="keywordtype">int</span> version = -1;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551    strncat(naptrinput, <a class="code" href="structnumber.html">number</a>, <span class="keyword">sizeof</span>(naptrinput) - 2);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    context.<a class="code" href="structenum__context.html#c8ecfcb421364b9d2037aa1d9304ca80">naptrinput</a> = naptrinput;
<a name="l00554"></a>00554    context.<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a> = dst;
<a name="l00555"></a>00555    context.<a class="code" href="structenum__context.html#24a6f272aa2ede869d96392164f49ab7">dstlen</a> = dstlen;
<a name="l00556"></a>00556    context.<a class="code" href="structenum__context.html#d9f9133fb120cd6096870bc2b496805b">tech</a> = tech;
<a name="l00557"></a>00557    context.<a class="code" href="structenum__context.html#cda08beed7cf3165d9c9b01582f0b72e">techlen</a> = techlen;
<a name="l00558"></a>00558    context.<a class="code" href="structenum__context.html#c7824f3d4d5f7b2f22d034758c1e9454">txt</a> = txt;
<a name="l00559"></a>00559    context.<a class="code" href="structenum__context.html#313fa57a116718d78e518390ce2bb1c1">txtlen</a> = txtlen;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    <span class="keywordflow">if</span> (pos &gt; 128)
<a name="l00562"></a>00562       pos = 128;
<a name="l00563"></a>00563    <span class="keywordflow">while</span> (pos &gt;= 0) {
<a name="l00564"></a>00564       tmp[newpos++] = <a class="code" href="structnumber.html">number</a>[pos--];
<a name="l00565"></a>00565       tmp[newpos++] = <span class="charliteral">'.'</span>;
<a name="l00566"></a>00566    }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568    <span class="keywordflow">if</span> (chan &amp;&amp; <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(chan) &lt; 0)
<a name="l00569"></a>00569       <span class="keywordflow">return</span> -1;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571    <span class="keywordflow">for</span> (;;) {
<a name="l00572"></a>00572       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;enumlock);
<a name="l00573"></a>00573       <span class="keywordflow">if</span> (version != <a class="code" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a>) {
<a name="l00574"></a>00574          <span class="comment">/* Ooh, a reload... */</span>
<a name="l00575"></a>00575          s = <a class="code" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a>;
<a name="l00576"></a>00576          version = <a class="code" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a>;
<a name="l00577"></a>00577       } <span class="keywordflow">else</span> {
<a name="l00578"></a>00578          s = s-&gt;<a class="code" href="structenum__search.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00579"></a>00579       }
<a name="l00580"></a>00580       <span class="keywordflow">if</span> (s) {
<a name="l00581"></a>00581          ast_copy_string(tmp + newpos, s-&gt;<a class="code" href="structenum__search.html#b0dd6c59bbba66963fdc96642fec39c6">toplev</a>, <span class="keyword">sizeof</span>(tmp) - newpos);
<a name="l00582"></a>00582       }
<a name="l00583"></a>00583       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;enumlock);
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (!s)
<a name="l00585"></a>00585          <span class="keywordflow">break</span>;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587       ret = <a class="code" href="dns_8c.html#336c75db464da83f0de567a19d26c64d">ast_search_dns</a>(&amp;context, tmp, C_IN, T_TXT, <a class="code" href="enum_8c.html#bb82156bb23a604afde8db589e7c6a51">txt_callback</a>);
<a name="l00588"></a>00588       <span class="keywordflow">if</span> (ret &gt; 0)
<a name="l00589"></a>00589          <span class="keywordflow">break</span>;
<a name="l00590"></a>00590    }
<a name="l00591"></a>00591    <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l00592"></a>00592       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l00593"></a>00593          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"No such number found in ENUM: %s (%s)\n"</span>, tmp, strerror(errno));
<a name="l00594"></a>00594       ret = 0;
<a name="l00595"></a>00595    }
<a name="l00596"></a>00596    <span class="keywordflow">if</span> (chan)
<a name="l00597"></a>00597       ret |= <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(chan);
<a name="l00598"></a>00598    <span class="keywordflow">return</span> ret;
<a name="l00599"></a>00599 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b33494d6e1743a529a70b577964c0612"></a><!-- doxytag: member="enum.c::AST_MUTEX_DEFINE_STATIC" ref="b33494d6e1743a529a70b577964c0612" args="(enumlock)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">AST_MUTEX_DEFINE_STATIC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">enumlock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="142880f81dc26c3ab290fa2b58e162e0"></a><!-- doxytag: member="enum.c::enum_callback" ref="142880f81dc26c3ab290fa2b58e162e0" args="(void *context, unsigned char *answer, int len, unsigned char *fullanswer)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int enum_callback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void *&nbsp;</td>
          <td class="mdname" nowrap> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>answer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>fullanswer</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Callback from ENUM lookup function. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00330">330</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="enum_8h-source.html#l00041">enum_context::dst</a>, <a class="el" href="enum_8h-source.html#l00042">enum_context::dstlen</a>, <a class="el" href="enum_8c-source.html#l00294">ENUMLOOKUP_OPTIONS_COUNT</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="enum_8h-source.html#l00034">enum_naptr_rr::naptr</a>, <a class="el" href="enum_8h-source.html#l00050">enum_context::naptr_rrs</a>, <a class="el" href="enum_8h-source.html#l00051">enum_context::naptr_rrs_count</a>, <a class="el" href="enum_8h-source.html#l00047">enum_context::naptrinput</a>, <a class="el" href="enum_8h-source.html#l00049">enum_context::options</a>, <a class="el" href="enum_8c-source.html#l00116">parse_naptr()</a>, <a class="el" href="enum_8h-source.html#l00048">enum_context::position</a>, <a class="el" href="enum_8h-source.html#l00035">enum_naptr_rr::result</a>, <a class="el" href="enum_8h-source.html#l00037">enum_naptr_rr::sort_pos</a>, <a class="el" href="astmm_8h-source.html#l00075">strdup</a>, <a class="el" href="enum_8h-source.html#l00036">enum_naptr_rr::tech</a>, <a class="el" href="enum_8h-source.html#l00043">enum_context::tech</a>, and <a class="el" href="enum_8h-source.html#l00044">enum_context::techlen</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00367">ast_get_enum()</a>.<div class="fragment"><pre class="fragment"><a name="l00331"></a>00331 {
<a name="l00332"></a>00332    <span class="keyword">struct </span><a class="code" href="structenum__context.html">enum_context</a> *c = <a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00333"></a>00333    <span class="keywordtype">void</span> *p = NULL;
<a name="l00334"></a>00334    <span class="keywordtype">int</span> res;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336    res = <a class="code" href="enum_8c.html#f012db47459604384c13d56b7701f5a4">parse_naptr</a>(c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>, c-&gt;<a class="code" href="structenum__context.html#24a6f272aa2ede869d96392164f49ab7">dstlen</a>, c-&gt;<a class="code" href="structenum__context.html#d9f9133fb120cd6096870bc2b496805b">tech</a>, c-&gt;<a class="code" href="structenum__context.html#cda08beed7cf3165d9c9b01582f0b72e">techlen</a>, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, c-&gt;<a class="code" href="structenum__context.html#c8ecfcb421364b9d2037aa1d9304ca80">naptrinput</a>);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00339"></a>00339       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to parse naptr :(\n"</span>);
<a name="l00340"></a>00340       <span class="keywordflow">return</span> -1;
<a name="l00341"></a>00341    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>)){ <span class="comment">/* ok, we got needed NAPTR */</span>
<a name="l00342"></a>00342       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structenum__context.html#93da65a9fd0004d9477aeac024e08e15">options</a> &amp; <a class="code" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>){ <span class="comment">/* counting RRs */</span>
<a name="l00343"></a>00343          c-&gt;<a class="code" href="structenum__context.html#4757fe07fd492a8be0ea6a760d683d6e">position</a>++;
<a name="l00344"></a>00344          snprintf(c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>, c-&gt;<a class="code" href="structenum__context.html#24a6f272aa2ede869d96392164f49ab7">dstlen</a>, <span class="stringliteral">"%d"</span>, c-&gt;<a class="code" href="structenum__context.html#4757fe07fd492a8be0ea6a760d683d6e">position</a>);
<a name="l00345"></a>00345       } <span class="keywordflow">else</span>  {
<a name="l00346"></a>00346          <span class="keywordflow">if</span> ((p = <a class="code" href="utils_8h.html#009723420c269c3a1ecb1953558e608d">ast_realloc</a>(c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>, <span class="keyword">sizeof</span>(*c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>) * (c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a> + 1)))) {
<a name="l00347"></a>00347             c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a> = p;
<a name="l00348"></a>00348             memcpy(&amp;c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>[c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>].naptr, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>-&gt;<a class="code" href="structenum__naptr__rr.html#edc47e7e285466ff710ed0b4d31764cf">naptr</a>));
<a name="l00349"></a>00349             c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>[c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>].<a class="code" href="structenum__naptr__rr.html#b4a88417b3d0170d754c647c30b7216a">result</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>);
<a name="l00350"></a>00350             c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>[c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>].<a class="code" href="structenum__naptr__rr.html#d9f9133fb120cd6096870bc2b496805b">tech</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(c-&gt;<a class="code" href="structenum__context.html#d9f9133fb120cd6096870bc2b496805b">tech</a>);
<a name="l00351"></a>00351             c-&gt;<a class="code" href="structenum__context.html#5c83fe522914e02dbb291cd9e0bddc64">naptr_rrs</a>[c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>].<a class="code" href="structenum__naptr__rr.html#8e0adb13b9376122db66603df18a08fe">sort_pos</a> = c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>;
<a name="l00352"></a>00352             c-&gt;<a class="code" href="structenum__context.html#dc5eff4941055879075292f3cbad76a7">naptr_rrs_count</a>++;
<a name="l00353"></a>00353          }
<a name="l00354"></a>00354          c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>[0] = 0;
<a name="l00355"></a>00355       }
<a name="l00356"></a>00356       <span class="keywordflow">return</span> 0;
<a name="l00357"></a>00357    }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structenum__context.html#93da65a9fd0004d9477aeac024e08e15">options</a> &amp; <a class="code" href="enum_8c.html#83bd02551d0d85f5573c8aa214aa8ee1">ENUMLOOKUP_OPTIONS_COUNT</a>)   { <span class="comment">/* counting RRs */</span>
<a name="l00360"></a>00360       snprintf(c-&gt;<a class="code" href="structenum__context.html#28e3d688a3c077b887921cea3fb1dbc7">dst</a>, c-&gt;<a class="code" href="structenum__context.html#24a6f272aa2ede869d96392164f49ab7">dstlen</a>, <span class="stringliteral">"%d"</span>, c-&gt;<a class="code" href="structenum__context.html#4757fe07fd492a8be0ea6a760d683d6e">position</a>);
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363    <span class="keywordflow">return</span> 0;
<a name="l00364"></a>00364 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6adcdb1292b83c88aba50586b6b2a98"></a><!-- doxytag: member="enum.c::enum_newtoplev" ref="a6adcdb1292b83c88aba50586b6b2a98" args="(char *s)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static struct <a class="el" href="structenum__search.html">enum_search</a>* enum_newtoplev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>s</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Add enum tree to linked list. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00602">602</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00613">ast_enum_init()</a>.<div class="fragment"><pre class="fragment"><a name="l00603"></a>00603 {
<a name="l00604"></a>00604    <span class="keyword">struct </span><a class="code" href="structenum__search.html">enum_search</a> *tmp;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606    <span class="keywordflow">if</span> ((tmp = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tmp)))) {      
<a name="l00607"></a>00607       ast_copy_string(tmp-&gt;toplev, <a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">sizeof</span>(tmp-&gt;toplev));
<a name="l00608"></a>00608    }
<a name="l00609"></a>00609    <span class="keywordflow">return</span> tmp;
<a name="l00610"></a>00610 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="25b84225c5d58c760b6ffd10cb27f14e"></a><!-- doxytag: member="enum.c::parse_ie" ref="25b84225c5d58c760b6ffd10cb27f14e" args="(char *data, unsigned int maxdatalen, unsigned char *src, unsigned int srclen)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static unsigned int parse_ie           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>maxdatalen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>srclen</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Parse NAPTR record information elements. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00095">95</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="utils_8h-source.html#l00386">len</a>, and <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00116">parse_naptr()</a>.<div class="fragment"><pre class="fragment"><a name="l00096"></a>00096 {
<a name="l00097"></a>00097    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, olen;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099    len = olen = (<span class="keywordtype">unsigned</span> int) src[0];
<a name="l00100"></a>00100    src++;
<a name="l00101"></a>00101    srclen--;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="keywordflow">if</span> (len &gt; srclen) {
<a name="l00104"></a>00104       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"ENUM parsing failed: Wanted %d characters, got %d\n"</span>, len, srclen);
<a name="l00105"></a>00105       <span class="keywordflow">return</span> -1;
<a name="l00106"></a>00106    }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="keywordflow">if</span> (len &gt; maxdatalen)
<a name="l00109"></a>00109       len = maxdatalen;
<a name="l00110"></a>00110    memcpy(data, src, len);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112    <span class="keywordflow">return</span> olen + 1;
<a name="l00113"></a>00113 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="f012db47459604384c13d56b7701f5a4"></a><!-- doxytag: member="enum.c::parse_naptr" ref="f012db47459604384c13d56b7701f5a4" args="(char *dst, int dstsize, char *tech, int techsize, unsigned char *answer, int len, char *naptrinput)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int parse_naptr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname" nowrap> <em>dst</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dstsize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>tech</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>techsize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>answer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>naptrinput</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Parse DNS NAPTR record used in ENUM ---. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00116">116</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, and <a class="el" href="enum_8c-source.html#l00095">parse_ie()</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00330">enum_callback()</a>.<div class="fragment"><pre class="fragment"><a name="l00117"></a>00117 {
<a name="l00118"></a>00118    <span class="keywordtype">char</span> tech_return[80];
<a name="l00119"></a>00119    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *oanswer = <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>;
<a name="l00120"></a>00120    <span class="keywordtype">char</span> flags[512] = <span class="stringliteral">""</span>;
<a name="l00121"></a>00121    <span class="keywordtype">char</span> services[512] = <span class="stringliteral">""</span>;
<a name="l00122"></a>00122    <span class="keywordtype">char</span> *p;
<a name="l00123"></a>00123    <span class="keywordtype">char</span> regexp[512] = <span class="stringliteral">""</span>;
<a name="l00124"></a>00124    <span class="keywordtype">char</span> repl[512] = <span class="stringliteral">""</span>;
<a name="l00125"></a>00125    <span class="keywordtype">char</span> temp[512] = <span class="stringliteral">""</span>;
<a name="l00126"></a>00126    <span class="keywordtype">char</span> delim;
<a name="l00127"></a>00127    <span class="keywordtype">char</span> *delim2;
<a name="l00128"></a>00128    <span class="keywordtype">char</span> *pattern, *subst, *d;
<a name="l00129"></a>00129    <span class="keywordtype">int</span> res;
<a name="l00130"></a>00130    <span class="keywordtype">int</span> regexp_len, size, backref;
<a name="l00131"></a>00131    <span class="keywordtype">int</span> d_len = <span class="keyword">sizeof</span>(temp) - 1;
<a name="l00132"></a>00132    regex_t preg;
<a name="l00133"></a>00133    regmatch_t pmatch[9];
<a name="l00134"></a>00134 
<a name="l00135"></a>00135    tech_return[0] = <span class="charliteral">'\0'</span>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    dst[0] = <span class="charliteral">'\0'</span>;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structnaptr.html">naptr</a>)) {
<a name="l00140"></a>00140       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"NAPTR record length too short\n"</span>);
<a name="l00141"></a>00141       <span class="keywordflow">return</span> -1;
<a name="l00142"></a>00142    }
<a name="l00143"></a>00143    <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> += <span class="keyword">sizeof</span>(<span class="keyword">struct </span>naptr);
<a name="l00144"></a>00144    <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= <span class="keyword">sizeof</span>(<span class="keyword">struct </span>naptr);
<a name="l00145"></a>00145    <span class="keywordflow">if</span> ((res = <a class="code" href="enum_8c.html#25b84225c5d58c760b6ffd10cb27f14e">parse_ie</a>(flags, <span class="keyword">sizeof</span>(flags) - 1, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)) &lt; 0) {
<a name="l00146"></a>00146       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to get flags from NAPTR record\n"</span>);
<a name="l00147"></a>00147       <span class="keywordflow">return</span> -1;
<a name="l00148"></a>00148    } <span class="keywordflow">else</span> {
<a name="l00149"></a>00149       <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> += res;
<a name="l00150"></a>00150       <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= res;
<a name="l00151"></a>00151    }
<a name="l00152"></a>00152    <span class="keywordflow">if</span> ((res = <a class="code" href="enum_8c.html#25b84225c5d58c760b6ffd10cb27f14e">parse_ie</a>(services, <span class="keyword">sizeof</span>(services) - 1, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)) &lt; 0) {
<a name="l00153"></a>00153       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to get services from NAPTR record\n"</span>);
<a name="l00154"></a>00154       <span class="keywordflow">return</span> -1;
<a name="l00155"></a>00155    } <span class="keywordflow">else</span> {
<a name="l00156"></a>00156       <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> += res;
<a name="l00157"></a>00157       <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= res;
<a name="l00158"></a>00158    }
<a name="l00159"></a>00159    <span class="keywordflow">if</span> ((res = <a class="code" href="enum_8c.html#25b84225c5d58c760b6ffd10cb27f14e">parse_ie</a>(regexp, <span class="keyword">sizeof</span>(regexp) - 1, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)) &lt; 0) {
<a name="l00160"></a>00160       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to get regexp from NAPTR record\n"</span>);
<a name="l00161"></a>00161       <span class="keywordflow">return</span> -1;
<a name="l00162"></a>00162    } <span class="keywordflow">else</span> {
<a name="l00163"></a>00163       <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> += res;
<a name="l00164"></a>00164       <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= res;
<a name="l00165"></a>00165    }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167    <span class="keywordflow">if</span> ((res = dn_expand(oanswer, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> + <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, repl, <span class="keyword">sizeof</span>(repl) - 1)) &lt; 0) {
<a name="l00168"></a>00168       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to expand hostname\n"</span>);
<a name="l00169"></a>00169       <span class="keywordflow">return</span> -1;
<a name="l00170"></a>00170    }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 2)   <span class="comment">/* Advanced NAPTR debugging */</span>
<a name="l00173"></a>00173       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"NAPTR input='%s', flags='%s', services='%s', regexp='%s', repl='%s'\n"</span>,
<a name="l00174"></a>00174          naptrinput, flags, services, regexp, repl);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176    <span class="keywordflow">if</span> (tolower(flags[0]) != <span class="charliteral">'u'</span>) {
<a name="l00177"></a>00177       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"NAPTR Flag must be 'U' or 'u'.\n"</span>);
<a name="l00178"></a>00178       <span class="keywordflow">return</span> -1;
<a name="l00179"></a>00179    }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181    p = strstr(services, <span class="stringliteral">"e2u+"</span>);
<a name="l00182"></a>00182    <span class="keywordflow">if</span> (p == NULL)
<a name="l00183"></a>00183       p = strstr(services, <span class="stringliteral">"E2U+"</span>);
<a name="l00184"></a>00184    <span class="keywordflow">if</span> (p){
<a name="l00185"></a>00185       p = p + 4;
<a name="l00186"></a>00186       <span class="keywordflow">if</span> (strchr(p, <span class="charliteral">':'</span>)){
<a name="l00187"></a>00187          p = strchr(p, <span class="charliteral">':'</span>) + 1;
<a name="l00188"></a>00188       }
<a name="l00189"></a>00189       ast_copy_string(tech_return, p, <span class="keyword">sizeof</span>(tech_return));
<a name="l00190"></a>00190    } <span class="keywordflow">else</span> {
<a name="l00191"></a>00191 
<a name="l00192"></a>00192       p = strstr(services, <span class="stringliteral">"+e2u"</span>);
<a name="l00193"></a>00193       <span class="keywordflow">if</span> (p == NULL)
<a name="l00194"></a>00194          p = strstr(services, <span class="stringliteral">"+E2U"</span>);
<a name="l00195"></a>00195       <span class="keywordflow">if</span> (p) {
<a name="l00196"></a>00196          *p = 0;
<a name="l00197"></a>00197          p = strchr(services, <span class="charliteral">':'</span>);
<a name="l00198"></a>00198          <span class="keywordflow">if</span> (p)
<a name="l00199"></a>00199             *p = 0;
<a name="l00200"></a>00200          ast_copy_string(tech_return, services, <span class="keyword">sizeof</span>(tech_return));
<a name="l00201"></a>00201       }
<a name="l00202"></a>00202    }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204    <span class="comment">/* DEDBUGGING STUB</span>
<a name="l00205"></a>00205 <span class="comment">   ast_copy_string(regexp, "!^\\+43(.*)$!\\1@bla.fasel!", sizeof(regexp) - 1);</span>
<a name="l00206"></a>00206 <span class="comment">   */</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    regexp_len = strlen(regexp);
<a name="l00209"></a>00209    <span class="keywordflow">if</span> (regexp_len &lt; 7) {
<a name="l00210"></a>00210       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Regex too short to be meaningful.\n"</span>);
<a name="l00211"></a>00211       <span class="keywordflow">return</span> -1;
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215    delim = regexp[0];
<a name="l00216"></a>00216    delim2 = strchr(regexp + 1, delim);
<a name="l00217"></a>00217    <span class="keywordflow">if</span> ((delim2 == NULL) || (regexp[regexp_len-1] != delim)) {
<a name="l00218"></a>00218       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Regex delimiter error (on \"%s\").\n"</span>,regexp);
<a name="l00219"></a>00219       <span class="keywordflow">return</span> -1;
<a name="l00220"></a>00220    }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222    pattern = regexp + 1;
<a name="l00223"></a>00223    *delim2 = 0;
<a name="l00224"></a>00224    subst   = delim2 + 1;
<a name="l00225"></a>00225    regexp[regexp_len-1] = 0;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="comment">/*</span>
<a name="l00228"></a>00228 <span class="comment"> * now do the regex wizardry.</span>
<a name="l00229"></a>00229 <span class="comment"> */</span>
<a name="l00230"></a>00230 
<a name="l00231"></a>00231    <span class="keywordflow">if</span> (regcomp(&amp;preg, pattern, REG_EXTENDED | REG_NEWLINE)) {
<a name="l00232"></a>00232       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"NAPTR Regex compilation error (regex = \"%s\").\n"</span>,regexp);
<a name="l00233"></a>00233       <span class="keywordflow">return</span> -1;
<a name="l00234"></a>00234    }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236    <span class="keywordflow">if</span> (preg.re_nsub &gt; 9) {
<a name="l00237"></a>00237       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"NAPTR Regex compilation error: too many subs.\n"</span>);
<a name="l00238"></a>00238       regfree(&amp;preg);
<a name="l00239"></a>00239       <span class="keywordflow">return</span> -1;
<a name="l00240"></a>00240    }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242    <span class="keywordflow">if</span> (regexec(&amp;preg, naptrinput, 9, pmatch, 0)) {
<a name="l00243"></a>00243       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"NAPTR Regex match failed.\n"</span>);
<a name="l00244"></a>00244       regfree(&amp;preg);
<a name="l00245"></a>00245       <span class="keywordflow">return</span> -1;
<a name="l00246"></a>00246    }
<a name="l00247"></a>00247    regfree(&amp;preg);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249    d = temp;
<a name="l00250"></a>00250    d_len--;
<a name="l00251"></a>00251    <span class="keywordflow">while</span> (*subst &amp;&amp; (d_len &gt; 0)) {
<a name="l00252"></a>00252       <span class="keywordflow">if</span> ((subst[0] == <span class="charliteral">'\\'</span>) &amp;&amp; isdigit(subst[1]) &amp;&amp; (pmatch[subst[1]-<span class="charliteral">'0'</span>].rm_so != -1)) {
<a name="l00253"></a>00253          backref = subst[1]-<span class="charliteral">'0'</span>;
<a name="l00254"></a>00254          size = pmatch[backref].rm_eo - pmatch[backref].rm_so;
<a name="l00255"></a>00255          <span class="keywordflow">if</span> (size &gt; d_len) {
<a name="l00256"></a>00256             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Not enough space during NAPTR regex substitution.\n"</span>);
<a name="l00257"></a>00257             <span class="keywordflow">return</span> -1;
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259          memcpy(d, naptrinput + pmatch[backref].rm_so, size);
<a name="l00260"></a>00260          d += size;
<a name="l00261"></a>00261          d_len -= size;
<a name="l00262"></a>00262          subst += 2;
<a name="l00263"></a>00263       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isprint(*subst)) {
<a name="l00264"></a>00264          *d++ = *subst++;
<a name="l00265"></a>00265          d_len--;
<a name="l00266"></a>00266       } <span class="keywordflow">else</span> {
<a name="l00267"></a>00267          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Error during regex substitution.\n"</span>);
<a name="l00268"></a>00268          <span class="keywordflow">return</span> -1;
<a name="l00269"></a>00269       }
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271    *d = 0;
<a name="l00272"></a>00272    ast_copy_string(dst, temp, dstsize);
<a name="l00273"></a>00273    dst[dstsize - 1] = <span class="charliteral">'\0'</span>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">if</span> (*tech != <span class="charliteral">'\0'</span>){ <span class="comment">/* check if it is requested NAPTR */</span>
<a name="l00276"></a>00276       <span class="keywordflow">if</span> (!strncasecmp(tech, <span class="stringliteral">"ALL"</span>, techsize)){
<a name="l00277"></a>00277          <span class="keywordflow">return</span> 1; <span class="comment">/* return or count any RR */</span>
<a name="l00278"></a>00278       }
<a name="l00279"></a>00279       <span class="keywordflow">if</span> (!strncasecmp(tech_return, tech, <span class="keyword">sizeof</span>(tech_return)&lt;techsize?<span class="keyword">sizeof</span>(tech_return):techsize)){
<a name="l00280"></a>00280          ast_copy_string(tech, tech_return, techsize);
<a name="l00281"></a>00281          <span class="keywordflow">return</span> 1; <span class="comment">/* we got out RR */</span>
<a name="l00282"></a>00282       } <span class="keywordflow">else</span> { <span class="comment">/* go to the next RR in the DNS answer */</span>
<a name="l00283"></a>00283          <span class="keywordflow">return</span> 0;
<a name="l00284"></a>00284       }
<a name="l00285"></a>00285    }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287    <span class="comment">/* tech was not specified, return first parsed RR */</span>
<a name="l00288"></a>00288    ast_copy_string(tech, tech_return, techsize);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290    <span class="keywordflow">return</span> 1;
<a name="l00291"></a>00291 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="bb82156bb23a604afde8db589e7c6a51"></a><!-- doxytag: member="enum.c::txt_callback" ref="bb82156bb23a604afde8db589e7c6a51" args="(void *context, unsigned char *answer, int len, unsigned char *fullanswer)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int txt_callback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void *&nbsp;</td>
          <td class="mdname" nowrap> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>answer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>fullanswer</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Callback for TXT record lookup. 
<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00298">298</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
References <a class="el" href="enum_8h-source.html#l00045">enum_context::txt</a>, and <a class="el" href="enum_8h-source.html#l00046">enum_context::txtlen</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00540">ast_get_txt()</a>.<div class="fragment"><pre class="fragment"><a name="l00299"></a>00299 {
<a name="l00300"></a>00300    <span class="keyword">struct </span><a class="code" href="structenum__context.html">enum_context</a> *c = (<span class="keyword">struct </span><a class="code" href="structenum__context.html">enum_context</a> *)<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (<a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> == NULL) {
<a name="l00303"></a>00303       c-&gt;<a class="code" href="structenum__context.html#c7824f3d4d5f7b2f22d034758c1e9454">txt</a> = NULL;
<a name="l00304"></a>00304       c-&gt;<a class="code" href="structenum__context.html#313fa57a116718d78e518390ce2bb1c1">txtlen</a> = 0;
<a name="l00305"></a>00305       <span class="keywordflow">return</span> 0;
<a name="l00306"></a>00306    }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    <span class="comment">/* skip over first byte, as for some reason it's a vertical tab character */</span>
<a name="l00309"></a>00309    <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a> += 1;
<a name="l00310"></a>00310    <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= 1;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312    <span class="comment">/* answer is not null-terminated, but should be */</span>
<a name="l00313"></a>00313    <span class="comment">/* this is safe to do, as answer has extra bytes on the end we can</span>
<a name="l00314"></a>00314 <span class="comment">    * safely overwrite with a null */</span>
<a name="l00315"></a>00315    <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>[<a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>] = <span class="charliteral">'\0'</span>;
<a name="l00316"></a>00316    <span class="comment">/* now increment len so that len includes the null, so that we can</span>
<a name="l00317"></a>00317 <span class="comment">    * compare apples to apples */</span>
<a name="l00318"></a>00318    <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> +=1;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320    <span class="comment">/* finally, copy the answer into c-&gt;txt */</span>
<a name="l00321"></a>00321    ast_copy_string(c-&gt;<a class="code" href="structenum__context.html#c7824f3d4d5f7b2f22d034758c1e9454">txt</a>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="answer_8h.html#e308b49e5dc27c5848510086e585d7e1">answer</a>, len &lt; c-&gt;<a class="code" href="structenum__context.html#313fa57a116718d78e518390ce2bb1c1">txtlen</a> ? <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> : (c-&gt;<a class="code" href="structenum__context.html#313fa57a116718d78e518390ce2bb1c1">txtlen</a>));
<a name="l00322"></a>00322 
<a name="l00323"></a>00323    <span class="comment">/* just to be safe, let's make sure c-&gt;txt is null terminated */</span>
<a name="l00324"></a>00324    c-&gt;<a class="code" href="structenum__context.html#c7824f3d4d5f7b2f22d034758c1e9454">txt</a>[(c-&gt;<a class="code" href="structenum__context.html#313fa57a116718d78e518390ce2bb1c1">txtlen</a>)-1] = <span class="charliteral">'\0'</span>;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="keywordflow">return</span> 1;
<a name="l00327"></a>00327 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="52d62262f7c3f83f6b7e085044dcbfeb"></a><!-- doxytag: member="enum.c::enumver" ref="52d62262f7c3f83f6b7e085044dcbfeb" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int <a class="el" href="enum_8c.html#52d62262f7c3f83f6b7e085044dcbfeb">enumver</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="enum_8c-source.html#l00090">90</a> of file <a class="el" href="enum_8c-source.html">enum.c</a>.
<p>
Referenced by <a class="el" href="enum_8c-source.html#l00613">ast_enum_init()</a>, <a class="el" href="enum_8c-source.html#l00367">ast_get_enum()</a>, and <a class="el" href="enum_8c-source.html#l00540">ast_get_txt()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="26a79dec4884d639255f89fba90ecc82"></a><!-- doxytag: member="enum.c::toplevs" ref="26a79dec4884d639255f89fba90ecc82" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structenum__search.html">enum_search</a> * <a class="el" href="enum_8c.html#26a79dec4884d639255f89fba90ecc82">toplevs</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="enum_8c-source.html#l00613">ast_enum_init()</a>, <a class="el" href="enum_8c-source.html#l00367">ast_get_enum()</a>, and <a class="el" href="enum_8c-source.html#l00540">ast_get_txt()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:27 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
