<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:37 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2F.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2Fasterisk_2F.html">asterisk</a></div>
<h1>monitor.h File Reference</h1>Channel monitoring. <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="channel_8h-source.html">asterisk/channel.h</a>&quot;</code><br>

<p>
<a href="monitor_8h-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__channel__monitor.html">ast_channel_monitor</a></td></tr>

<tr><td colspan="2"><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088">AST_MONITORING_STATE</a> { <a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>, 
<a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996">AST_MONITOR_PAUSED</a>
 }</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, const char *fname_base, int need_lock)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#ce422ff6a5850f68e038e967a5b094ce">ast_monitor_pause</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#21b1d71c9387ac99b6c5a7066a8a845c">ast_monitor_setjoinfiles</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, int turnon)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#4f4e162179064c9f0c8444a33f6fe27d">ast_monitor_start</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, const char *format_spec, const char *fname_base, int need_lock)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, int need_lock)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#7cfb30d07bb72866508802173a655ba1">ast_monitor_unpause</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Channel monitoring. 
<p>

<p>
Definition in file <a class="el" href="monitor_8h-source.html">monitor.h</a>.<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="68c252a4174f79a63bcedd9f1c005088"></a><!-- doxytag: member="monitor.h::AST_MONITORING_STATE" ref="68c252a4174f79a63bcedd9f1c005088" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">enum <a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088">AST_MONITORING_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef"></a><!-- doxytag: member="AST_MONITOR_RUNNING" ref="68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef" args="" -->AST_MONITOR_RUNNING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996"></a><!-- doxytag: member="AST_MONITOR_PAUSED" ref="68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996" args="" -->AST_MONITOR_PAUSED</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="monitor_8h-source.html#l00028">28</a> of file <a class="el" href="monitor_8h-source.html">monitor.h</a>.<div class="fragment"><pre class="fragment"><a name="l00028"></a>00028                           {
<a name="l00029"></a>00029    <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>,
<a name="l00030"></a>00030    <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996">AST_MONITOR_PAUSED</a>
<a name="l00031"></a>00031 };
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="b920883a248d93215cda31effa692ed3"></a><!-- doxytag: member="monitor.h::ast_monitor_change_fname" ref="b920883a248d93215cda31effa692ed3" args="(struct ast_channel *chan, const char *fname_base, int need_lock)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_monitor_change_fname           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>fname_base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>need_lock</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00358">358</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="asterisk_8c-source.html#l00214">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="asterisk_8c-source.html#l00746">ast_safe_system()</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="monitor_8h-source.html#l00039">ast_channel_monitor::filename_base</a>, <a class="el" href="monitor_8h-source.html#l00040">ast_channel_monitor::filename_changed</a>, <a class="el" href="private_8h-source.html#l00144">FILENAME_MAX</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="res__monitor_8c-source.html#l00054">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="channel_8h-source.html#l00457">ast_channel::monitor</a>, <a class="el" href="callerid_8c-source.html#l01043">name</a>, <a class="el" href="astmm_8h-source.html#l00075">strdup</a>, and <a class="el" href="res__monitor_8c-source.html#l00059">UNLOCK_IF_NEEDED</a>.
<p>
Referenced by <a class="el" href="res__monitor_8c-source.html#l00566">change_monitor_action()</a>, <a class="el" href="res__monitor_8c-source.html#l00462">change_monitor_exec()</a>, <a class="el" href="res__monitor_8c-source.html#l00481">start_monitor_action()</a>, and <a class="el" href="res__monitor_8c-source.html#l00389">start_monitor_exec()</a>.<div class="fragment"><pre class="fragment"><a name="l00359"></a>00359 {
<a name="l00360"></a>00360    <span class="keywordtype">char</span> tmp[256];
<a name="l00361"></a>00361    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname_base)) {
<a name="l00362"></a>00362       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot change monitor filename of channel %s to null\n"</span>, chan-&gt;name);
<a name="l00363"></a>00363       <span class="keywordflow">return</span> -1;
<a name="l00364"></a>00364    }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00369"></a>00369       <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00370"></a>00370       <span class="comment">/* try creating the directory just in case it doesn't exist */</span>
<a name="l00371"></a>00371       <span class="keywordflow">if</span> (directory) {
<a name="l00372"></a>00372          <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(fname_base);
<a name="l00373"></a>00373          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"mkdir -p %s"</span>,dirname(name));
<a name="l00374"></a>00374          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(name);
<a name="l00375"></a>00375          <a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp);
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378       snprintf(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s"</span>, directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, fname_base);
<a name="l00379"></a>00379       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#df66eb304be2a1bf4a34beba678a82fd">filename_changed</a> = 1;
<a name="l00380"></a>00380    } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot change monitor filename of channel %s to %s, monitoring not started\n"</span>, chan-&gt;name, fname_base);
<a name="l00382"></a>00382    }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    <span class="keywordflow">return</span> 0;
<a name="l00387"></a>00387 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="ce422ff6a5850f68e038e967a5b094ce"></a><!-- doxytag: member="monitor.h::ast_monitor_pause" ref="ce422ff6a5850f68e038e967a5b094ce" args="(struct ast_channel *chan)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_monitor_pause           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>chan</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00336">336</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996">AST_MONITOR_PAUSED</a>, and <a class="el" href="res__monitor_8c-source.html#l00114">ast_monitor_set_state()</a>.
<p>
Referenced by <a class="el" href="res__monitor_8c-source.html#l00606">do_pause_or_unpause()</a>, and <a class="el" href="res__monitor_8c-source.html#l00347">pause_monitor_exec()</a>.<div class="fragment"><pre class="fragment"><a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996">AST_MONITOR_PAUSED</a>);
<a name="l00339"></a>00339 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="21b1d71c9387ac99b6c5a7066a8a845c"></a><!-- doxytag: member="monitor.h::ast_monitor_setjoinfiles" ref="21b1d71c9387ac99b6c5a7066a8a845c" args="(struct ast_channel *chan, int turnon)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ast_monitor_setjoinfiles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>turnon</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00594">594</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="monitor_8h-source.html#l00042">ast_channel_monitor::joinfiles</a>, and <a class="el" href="channel_8h-source.html#l00457">ast_channel::monitor</a>.
<p>
Referenced by <a class="el" href="chan__agent_8c-source.html#l00394">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c-source.html#l00481">start_monitor_action()</a>, <a class="el" href="res__monitor_8c-source.html#l00389">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c-source.html#l02421">try_calling()</a>.<div class="fragment"><pre class="fragment"><a name="l00595"></a>00595 {
<a name="l00596"></a>00596    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>)
<a name="l00597"></a>00597       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#55dc53055b6d97c2c86b93c76c625b85">joinfiles</a> = turnon;
<a name="l00598"></a>00598 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="4f4e162179064c9f0c8444a33f6fe27d"></a><!-- doxytag: member="monitor.h::ast_monitor_start" ref="4f4e162179064c9f0c8444a33f6fe27d" args="(struct ast_channel *chan, const char *format_spec, const char *fname_base, int need_lock)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_monitor_start           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>format_spec</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>fname_base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>need_lock</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00127">127</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="file_8c-source.html#l00701">ast_closestream()</a>, <a class="el" href="asterisk_8c-source.html#l00214">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="asterisk_8h-source.html#l00041">AST_FILE_MODE</a>, <a class="el" href="file_8c-source.html#l00766">ast_filedelete()</a>, <a class="el" href="file_8c-source.html#l00752">ast_fileexists()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>, <a class="el" href="res__monitor_8c-source.html#l00114">ast_monitor_set_state()</a>, <a class="el" href="res__monitor_8c-source.html#l00254">ast_monitor_stop()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="asterisk_8c-source.html#l00746">ast_safe_system()</a>, <a class="el" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="file_8c-source.html#l00856">ast_writefile()</a>, <a class="el" href="private_8h-source.html#l00144">FILENAME_MAX</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="res__monitor_8c-source.html#l00054">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="channel_8h-source.html#l00457">ast_channel::monitor</a>, <a class="el" href="chan__phone_8c-source.html#l00111">monitor</a>, <a class="el" href="callerid_8c-source.html#l01043">name</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="pbx_8c-source.html#l05821">pbx_builtin_setvar_helper()</a>, <a class="el" href="app__sms_8c-source.html#l00072">seq</a>, <a class="el" href="astmm_8h-source.html#l00075">strdup</a>, and <a class="el" href="res__monitor_8c-source.html#l00059">UNLOCK_IF_NEEDED</a>.
<p>
Referenced by <a class="el" href="chan__agent_8c-source.html#l00394">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c-source.html#l00481">start_monitor_action()</a>, <a class="el" href="res__monitor_8c-source.html#l00389">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c-source.html#l02421">try_calling()</a>.<div class="fragment"><pre class="fragment"><a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keywordtype">int</span> res = 0;
<a name="l00131"></a>00131    <span class="keywordtype">char</span> tmp[256];
<a name="l00132"></a>00132 
<a name="l00133"></a>00133    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135    <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>)) {
<a name="l00136"></a>00136       <span class="keyword">struct </span><a class="code" href="structast__channel__monitor.html">ast_channel_monitor</a> *<a class="code" href="chan__phone_8c.html#08b5411f848a2581a41672a759c87380">monitor</a>;
<a name="l00137"></a>00137       <span class="keywordtype">char</span> *channel_name, *p;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139       <span class="comment">/* Create monitoring directory if needed */</span>
<a name="l00140"></a>00140       <span class="keywordflow">if</span> (mkdir(<a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, 0770) &lt; 0) {
<a name="l00141"></a>00141          <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l00142"></a>00142             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create audio monitor directory: %s\n"</span>,
<a name="l00143"></a>00143                strerror(errno));
<a name="l00144"></a>00144          }
<a name="l00145"></a>00145       }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147       <span class="keywordflow">if</span> (!(monitor = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*monitor)))) {
<a name="l00148"></a>00148          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00149"></a>00149          <span class="keywordflow">return</span> -1;
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152       <span class="comment">/* Determine file names */</span>
<a name="l00153"></a>00153       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname_base)) {
<a name="l00154"></a>00154          <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00155"></a>00155          <span class="comment">/* try creating the directory just in case it doesn't exist */</span>
<a name="l00156"></a>00156          <span class="keywordflow">if</span> (directory) {
<a name="l00157"></a>00157             <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(fname_base);
<a name="l00158"></a>00158             snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"mkdir -p \"%s\""</span>,dirname(name));
<a name="l00159"></a>00159             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(name);
<a name="l00160"></a>00160             <a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp);
<a name="l00161"></a>00161          }
<a name="l00162"></a>00162          snprintf(monitor-&gt;read_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s-in"</span>,
<a name="l00163"></a>00163                   directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, fname_base);
<a name="l00164"></a>00164          snprintf(monitor-&gt;write_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s-out"</span>,
<a name="l00165"></a>00165                   directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, fname_base);
<a name="l00166"></a>00166          ast_copy_string(monitor-&gt;filename_base, fname_base, <span class="keyword">sizeof</span>(monitor-&gt;filename_base));
<a name="l00167"></a>00167       } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168          <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;monitorlock);
<a name="l00169"></a>00169          snprintf(monitor-&gt;read_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/audio-in-%ld"</span>,
<a name="l00170"></a>00170                   <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>);
<a name="l00171"></a>00171          snprintf(monitor-&gt;write_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/audio-out-%ld"</span>,
<a name="l00172"></a>00172                   <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>);
<a name="l00173"></a>00173          <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>++;
<a name="l00174"></a>00174          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;monitorlock);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176          channel_name = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(chan-&gt;name);
<a name="l00177"></a>00177          <span class="keywordflow">while</span> ((p = strchr(channel_name, <span class="charliteral">'/'</span>))) {
<a name="l00178"></a>00178             *p = <span class="charliteral">'-'</span>;
<a name="l00179"></a>00179          }
<a name="l00180"></a>00180          snprintf(monitor-&gt;filename_base, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%d-%s"</span>,
<a name="l00181"></a>00181                 <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, (<span class="keywordtype">int</span>)time(NULL), channel_name);
<a name="l00182"></a>00182          monitor-&gt;filename_changed = 1;
<a name="l00183"></a>00183       }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185       monitor-&gt;stop = <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       <span class="comment">/* Determine file format */</span>
<a name="l00188"></a>00188       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(format_spec)) {
<a name="l00189"></a>00189          monitor-&gt;format = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(format_spec);
<a name="l00190"></a>00190       } <span class="keywordflow">else</span> {
<a name="l00191"></a>00191          monitor-&gt;format = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(<span class="stringliteral">"wav"</span>);
<a name="l00192"></a>00192       }
<a name="l00193"></a>00193       
<a name="l00194"></a>00194       <span class="comment">/* open files */</span>
<a name="l00195"></a>00195       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(monitor-&gt;read_filename, NULL, NULL) &gt; 0) {
<a name="l00196"></a>00196          <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(monitor-&gt;read_filename, NULL);
<a name="l00197"></a>00197       }
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (!(monitor-&gt;read_stream = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(monitor-&gt;read_filename,
<a name="l00199"></a>00199                   monitor-&gt;format, NULL,
<a name="l00200"></a>00200                   O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>))) {
<a name="l00201"></a>00201          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not create file %s\n"</span>,
<a name="l00202"></a>00202                   monitor-&gt;read_filename);
<a name="l00203"></a>00203          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(monitor);
<a name="l00204"></a>00204          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00205"></a>00205          <span class="keywordflow">return</span> -1;
<a name="l00206"></a>00206       }
<a name="l00207"></a>00207       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(monitor-&gt;write_filename, NULL, NULL) &gt; 0) {
<a name="l00208"></a>00208          <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(monitor-&gt;write_filename, NULL);
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (!(monitor-&gt;write_stream = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(monitor-&gt;write_filename,
<a name="l00211"></a>00211                   monitor-&gt;format, NULL,
<a name="l00212"></a>00212                   O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>))) {
<a name="l00213"></a>00213          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not create file %s\n"</span>,
<a name="l00214"></a>00214                   monitor-&gt;write_filename);
<a name="l00215"></a>00215          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(monitor-&gt;read_stream);
<a name="l00216"></a>00216          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(monitor);
<a name="l00217"></a>00217          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00218"></a>00218          <span class="keywordflow">return</span> -1;
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = monitor;
<a name="l00221"></a>00221       <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>);
<a name="l00222"></a>00222       <span class="comment">/* so we know this call has been monitored in case we need to bill for it or something */</span>
<a name="l00223"></a>00223       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"__MONITORED"</span>,<span class="stringliteral">"true"</span>);
<a name="l00224"></a>00224    } <span class="keywordflow">else</span> {
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00226"></a>00226          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>,<span class="stringliteral">"Cannot start monitoring %s, already monitored\n"</span>,
<a name="l00227"></a>00227                   chan-&gt;name);
<a name="l00228"></a>00228       res = -1;
<a name="l00229"></a>00229    }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233    <span class="keywordflow">return</span> res;
<a name="l00234"></a>00234 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="0105c193291bd5aa095b584f2f4ea126"></a><!-- doxytag: member="monitor.h::ast_monitor_stop" ref="0105c193291bd5aa095b584f2f4ea126" args="(struct ast_channel *chan, int need_lock)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_monitor_stop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>need_lock</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00254">254</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="file_8c-source.html#l00701">ast_closestream()</a>, <a class="el" href="asterisk_8c-source.html#l00214">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="file_8c-source.html#l00766">ast_filedelete()</a>, <a class="el" href="file_8c-source.html#l00752">ast_fileexists()</a>, <a class="el" href="file_8c-source.html#l00771">ast_filerename()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="asterisk_8c-source.html#l00746">ast_safe_system()</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="adsistub_8c-source.html#l00083">dir</a>, <a class="el" href="monitor_8h-source.html#l00039">ast_channel_monitor::filename_base</a>, <a class="el" href="monitor_8h-source.html#l00040">ast_channel_monitor::filename_changed</a>, <a class="el" href="private_8h-source.html#l00144">FILENAME_MAX</a>, <a class="el" href="monitor_8h-source.html#l00041">ast_channel_monitor::format</a>, <a class="el" href="chan__alsa_8c-source.html#l00103">format</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="res__monitor_8c-source.html#l00241">get_soxmix_format()</a>, <a class="el" href="monitor_8h-source.html#l00042">ast_channel_monitor::joinfiles</a>, <a class="el" href="res__monitor_8c-source.html#l00054">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h-source.html#l00094">LOG_DEBUG</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="channel_8h-source.html#l00457">ast_channel::monitor</a>, <a class="el" href="callerid_8c-source.html#l01043">name</a>, <a class="el" href="asterisk_8c-source.html#l00164">option_debug</a>, <a class="el" href="pbx_8c-source.html#l05762">pbx_builtin_getvar_helper()</a>, <a class="el" href="monitor_8h-source.html#l00037">ast_channel_monitor::read_filename</a>, <a class="el" href="monitor_8h-source.html#l00035">ast_channel_monitor::read_stream</a>, <a class="el" href="res__monitor_8c-source.html#l00059">UNLOCK_IF_NEEDED</a>, <a class="el" href="monitor_8h-source.html#l00038">ast_channel_monitor::write_filename</a>, and <a class="el" href="monitor_8h-source.html#l00036">ast_channel_monitor::write_stream</a>.
<p>
Referenced by <a class="el" href="res__monitor_8c-source.html#l00127">ast_monitor_start()</a>, <a class="el" href="res__features_8c-source.html#l00562">builtin_automonitor()</a>, <a class="el" href="res__monitor_8c-source.html#l00534">stop_monitor_action()</a>, and <a class="el" href="res__monitor_8c-source.html#l00457">stop_monitor_exec()</a>.<div class="fragment"><pre class="fragment"><a name="l00255"></a>00255 {
<a name="l00256"></a>00256    <span class="keywordtype">int</span> delfiles = 0;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00261"></a>00261       <span class="keywordtype">char</span> filename[ <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a> ];
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>) {
<a name="l00264"></a>00264          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>);
<a name="l00265"></a>00265       }
<a name="l00266"></a>00266       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>) {
<a name="l00267"></a>00267          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>);
<a name="l00268"></a>00268       }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#df66eb304be2a1bf4a34beba678a82fd">filename_changed</a> &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>)) {
<a name="l00271"></a>00271          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00272"></a>00272             snprintf(filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s-in"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>);
<a name="l00273"></a>00273             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00274"></a>00274                <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(filename, NULL);
<a name="l00275"></a>00275             }
<a name="l00276"></a>00276             <a class="code" href="file_8c.html#6550c411c28c65446c5ad2a8307b50eb">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00277"></a>00277          } <span class="keywordflow">else</span> {
<a name="l00278"></a>00278             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s not found\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>);
<a name="l00279"></a>00279          }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00282"></a>00282             snprintf(filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s-out"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>);
<a name="l00283"></a>00283             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00284"></a>00284                <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(filename, NULL);
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286             <a class="code" href="file_8c.html#6550c411c28c65446c5ad2a8307b50eb">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00287"></a>00287          } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s not found\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>);
<a name="l00289"></a>00289          }
<a name="l00290"></a>00290       }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#55dc53055b6d97c2c86b93c76c625b85">joinfiles</a> &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>)) {
<a name="l00293"></a>00293          <span class="keywordtype">char</span> tmp[1024];
<a name="l00294"></a>00294          <span class="keywordtype">char</span> tmp2[1024];
<a name="l00295"></a>00295          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = !strcasecmp(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,<span class="stringliteral">"wav49"</span>) ? <span class="stringliteral">"WAV"</span> : chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00296"></a>00296          <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>;
<a name="l00297"></a>00297          <span class="keywordtype">int</span> directory = strchr(name, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00298"></a>00298          <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#736007832d2167baaae763fd3a3f3cf1">dir</a> = directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>;
<a name="l00299"></a>00299          <span class="keyword">const</span> <span class="keywordtype">char</span> *execute, *execute_args;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301          <span class="comment">/* Set the execute application */</span>
<a name="l00302"></a>00302          execute = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"MONITOR_EXEC"</span>);
<a name="l00303"></a>00303          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(execute)) { 
<a name="l00304"></a>00304             execute = <span class="stringliteral">"nice -n 19 soxmix"</span>;
<a name="l00305"></a>00305             format = <a class="code" href="res__monitor_8c.html#50adae321837c2e2dfbfb1c620ce8f78">get_soxmix_format</a>(format);
<a name="l00306"></a>00306             delfiles = 1;
<a name="l00307"></a>00307          } 
<a name="l00308"></a>00308          execute_args = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"MONITOR_EXEC_ARGS"</span>);
<a name="l00309"></a>00309          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(execute_args)) {
<a name="l00310"></a>00310             execute_args = <span class="stringliteral">""</span>;
<a name="l00311"></a>00311          }
<a name="l00312"></a>00312          
<a name="l00313"></a>00313          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s \"%s/%s-in.%s\" \"%s/%s-out.%s\" \"%s/%s.%s\" %s &amp;"</span>, execute, dir, name, format, dir, name, format, dir, name, format,execute_args);
<a name="l00314"></a>00314          <span class="keywordflow">if</span> (delfiles) {
<a name="l00315"></a>00315             snprintf(tmp2,<span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">"( %s&amp; rm -f \"%s/%s-\"* ) &amp;"</span>,tmp, dir ,name); <span class="comment">/* remove legs when done mixing */</span>
<a name="l00316"></a>00316             ast_copy_string(tmp, tmp2, <span class="keyword">sizeof</span>(tmp));
<a name="l00317"></a>00317          }
<a name="l00318"></a>00318          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00319"></a>00319             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>,<span class="stringliteral">"monitor executing %s\n"</span>,tmp);
<a name="l00320"></a>00320          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp) == -1)
<a name="l00321"></a>00321             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Execute of %s failed.\n"</span>,tmp);
<a name="l00322"></a>00322       }
<a name="l00323"></a>00323       
<a name="l00324"></a>00324       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00325"></a>00325       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>);
<a name="l00326"></a>00326       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = NULL;
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="keywordflow">return</span> 0;
<a name="l00332"></a>00332 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="7cfb30d07bb72866508802173a655ba1"></a><!-- doxytag: member="monitor.h::ast_monitor_unpause" ref="7cfb30d07bb72866508802173a655ba1" args="(struct ast_channel *chan)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_monitor_unpause           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>chan</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__monitor_8c-source.html#l00342">342</a> of file <a class="el" href="res__monitor_8c-source.html">res_monitor.c</a>.
<p>
References <a class="el" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>, and <a class="el" href="res__monitor_8c-source.html#l00114">ast_monitor_set_state()</a>.
<p>
Referenced by <a class="el" href="res__monitor_8c-source.html#l00606">do_pause_or_unpause()</a>, and <a class="el" href="res__monitor_8c-source.html#l00352">unpause_monitor_exec()</a>.<div class="fragment"><pre class="fragment"><a name="l00343"></a>00343 {
<a name="l00344"></a>00344    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>);
<a name="l00345"></a>00345 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:37 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
