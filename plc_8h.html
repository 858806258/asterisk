<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:42 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2F.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Finclude_2Fasterisk_2F.html">asterisk</a></div>
<h1>plc.h File Reference</h1>SpanDSP - a series of DSP components for telephony. <a href="#_details">More...</a>
<p>
<code>#include &lt;stdint.h&gt;</code><br>

<p>
<a href="plc_8h-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structplc__state__t.html">plc_state_t</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#86f406a7a8f5c48bdc26cee16be77af4">_PLC_H_</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#39f566c6883296b670eb9e6d60127bc7">CORRELATION_SPAN</a>&nbsp;&nbsp;&nbsp;160</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a>&nbsp;&nbsp;&nbsp;(CORRELATION_SPAN + PLC_PITCH_MIN)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#06d301ddcbd06e5c173fb5520c2fea8f">PLC_PITCH_MAX</a>&nbsp;&nbsp;&nbsp;40</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#15b2951603350ca19b8443c389a4afb4">PLC_PITCH_MIN</a>&nbsp;&nbsp;&nbsp;120</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#8fda67d6b8fe23eacdf02fe9fa28588d">PLC_PITCH_OVERLAP_MAX</a>&nbsp;&nbsp;&nbsp;(PLC_PITCH_MIN &gt;&gt; 2)</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#18dd65497a17553ef65cefcec39c064b">plc_fillin</a> (<a class="el" href="structplc__state__t.html">plc_state_t</a> *s, int16_t amp[], int len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Fill-in a block of missing audio samples.  <a href="#18dd65497a17553ef65cefcec39c064b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structplc__state__t.html">plc_state_t</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#7a2bb3cee685bd3dea83032b410b9179">plc_init</a> (<a class="el" href="structplc__state__t.html">plc_state_t</a> *s)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process a block of received V.29 modem audio samples.  <a href="#7a2bb3cee685bd3dea83032b410b9179"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="plc_8h.html#3bc3f79ef039ed2a8bbc3eb176a2b0a6">plc_rx</a> (<a class="el" href="structplc__state__t.html">plc_state_t</a> *s, int16_t amp[], int len)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process a block of received audio samples.  <a href="#3bc3f79ef039ed2a8bbc3eb176a2b0a6"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
SpanDSP - a series of DSP components for telephony. 
<p>
<a class="el" href="plc_8h.html">plc.h</a><p>
<dl compact><dt><b>Author:</b></dt><dd>Steve Underwood &lt;<a href="mailto:steveu@coppice.org">steveu@coppice.org</a>&gt;</dd></dl>
Copyright (C) 2004 Steve Underwood<p>
All rights reserved.<p>
This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.<p>
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.<p>
You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.<p>
This version may be optionally licenced under the GNU LGPL licence.<p>
A license has been granted to Digium (via disclaimer) for the use of this code. 
<p>
Definition in file <a class="el" href="plc_8h-source.html">plc.h</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="86f406a7a8f5c48bdc26cee16be77af4"></a><!-- doxytag: member="plc.h::_PLC_H_" ref="86f406a7a8f5c48bdc26cee16be77af4" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define _PLC_H_          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="plc_8h-source.html#l00034">34</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="39f566c6883296b670eb9e6d60127bc7"></a><!-- doxytag: member="plc.h::CORRELATION_SPAN" ref="39f566c6883296b670eb9e6d60127bc7" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define CORRELATION_SPAN&nbsp;&nbsp;&nbsp;160          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The length over which the AMDF function looks for similarity (20 ms) 
<p>
Definition at line <a class="el" href="plc_8h-source.html#l00107">107</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.
<p>
Referenced by <a class="el" href="plc_8c-source.html#l00174">plc_fillin()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="030c3d36cbb031ab682df369984c7e69"></a><!-- doxytag: member="plc.h::PLC_HISTORY_LEN" ref="030c3d36cbb031ab682df369984c7e69" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PLC_HISTORY_LEN&nbsp;&nbsp;&nbsp;(CORRELATION_SPAN + PLC_PITCH_MIN)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
History buffer length. The buffer much also be at leat 1.25 times PLC_PITCH_MIN, but that is much smaller than the buffer needs to be for the pitch assessment. 
<p>
Definition at line <a class="el" href="plc_8h-source.html#l00111">111</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.
<p>
Referenced by <a class="el" href="plc_8c-source.html#l00093">normalise_history()</a>, <a class="el" href="plc_8c-source.html#l00174">plc_fillin()</a>, and <a class="el" href="plc_8c-source.html#l00070">save_history()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="06d301ddcbd06e5c173fb5520c2fea8f"></a><!-- doxytag: member="plc.h::PLC_PITCH_MAX" ref="06d301ddcbd06e5c173fb5520c2fea8f" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PLC_PITCH_MAX&nbsp;&nbsp;&nbsp;40          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Maximum allowed pitch (200 Hz) 
<p>
Definition at line <a class="el" href="plc_8h-source.html#l00103">103</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.
<p>
Referenced by <a class="el" href="plc_8c-source.html#l00174">plc_fillin()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="15b2951603350ca19b8443c389a4afb4"></a><!-- doxytag: member="plc.h::PLC_PITCH_MIN" ref="15b2951603350ca19b8443c389a4afb4" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PLC_PITCH_MIN&nbsp;&nbsp;&nbsp;120          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Minimum allowed pitch (66 Hz) 
<p>
Definition at line <a class="el" href="plc_8h-source.html#l00101">101</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.
<p>
Referenced by <a class="el" href="plc_8c-source.html#l00174">plc_fillin()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="8fda67d6b8fe23eacdf02fe9fa28588d"></a><!-- doxytag: member="plc.h::PLC_PITCH_OVERLAP_MAX" ref="8fda67d6b8fe23eacdf02fe9fa28588d" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PLC_PITCH_OVERLAP_MAX&nbsp;&nbsp;&nbsp;(PLC_PITCH_MIN &gt;&gt; 2)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Maximum pitch OLA window 
<p>
Definition at line <a class="el" href="plc_8h-source.html#l00105">105</a> of file <a class="el" href="plc_8h-source.html">plc.h</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="18dd65497a17553ef65cefcec39c064b"></a><!-- doxytag: member="plc.h::plc_fillin" ref="18dd65497a17553ef65cefcec39c064b" args="(plc_state_t *s, int16_t amp[], int len)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int plc_fillin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structplc__state__t.html">plc_state_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int16_t&nbsp;</td>
          <td class="mdname" nowrap> <em>amp</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Fill-in a block of missing audio samples. 
<p>
Fill-in a block of missing audio samples. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td>The packet loss concealer context. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>amp</em>&nbsp;</td><td>The audio sample buffer. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>len</em>&nbsp;</td><td>The number of samples to be synthesised. </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>The number of samples synthesized. </dd></dl>

<p>
Definition at line <a class="el" href="plc_8c-source.html#l00174">174</a> of file <a class="el" href="plc_8c-source.html">plc.c</a>.
<p>
References <a class="el" href="plc_8c-source.html#l00107">amdf_pitch()</a>, <a class="el" href="plc_8c-source.html#l00057">ATTENUATION_INCREMENT</a>, <a class="el" href="plc_8h-source.html#l00107">CORRELATION_SPAN</a>, <a class="el" href="plc_8c-source.html#l00061">fsaturate()</a>, <a class="el" href="plc_8h-source.html#l00124">plc_state_t::history</a>, <a class="el" href="plc_8h-source.html#l00116">plc_state_t::missing_samples</a>, <a class="el" href="plc_8c-source.html#l00093">normalise_history()</a>, <a class="el" href="plc_8h-source.html#l00120">plc_state_t::pitch</a>, <a class="el" href="plc_8h-source.html#l00118">plc_state_t::pitch_offset</a>, <a class="el" href="plc_8h-source.html#l00122">plc_state_t::pitchbuf</a>, <a class="el" href="plc_8h-source.html#l00111">PLC_HISTORY_LEN</a>, <a class="el" href="plc_8h-source.html#l00103">PLC_PITCH_MAX</a>, <a class="el" href="plc_8h-source.html#l00101">PLC_PITCH_MIN</a>, and <a class="el" href="plc_8c-source.html#l00070">save_history()</a>.
<p>
Referenced by <a class="el" href="translate_8c-source.html#l00150">framein()</a>.<div class="fragment"><pre class="fragment"><a name="l00175"></a>00175 {
<a name="l00176"></a>00176    <span class="keywordtype">int</span> i;
<a name="l00177"></a>00177    <span class="keywordtype">int</span> pitch_overlap;
<a name="l00178"></a>00178    <span class="keywordtype">float</span> old_step;
<a name="l00179"></a>00179    <span class="keywordtype">float</span> new_step;
<a name="l00180"></a>00180    <span class="keywordtype">float</span> old_weight;
<a name="l00181"></a>00181    <span class="keywordtype">float</span> new_weight;
<a name="l00182"></a>00182    <span class="keywordtype">float</span> gain;
<a name="l00183"></a>00183    int16_t *orig_amp;
<a name="l00184"></a>00184    <span class="keywordtype">int</span> orig_len;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186    orig_amp = amp;
<a name="l00187"></a>00187    orig_len = <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00188"></a>00188    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a> == 0) {
<a name="l00189"></a>00189       <span class="comment">/* As the gap in real speech starts we need to assess the last known pitch,</span>
<a name="l00190"></a>00190 <span class="comment">         and prepare the synthetic data we will use for fill-in */</span>
<a name="l00191"></a>00191       <a class="code" href="plc_8c.html#03eb47659a134de8d72b3d1aa94a3d9b">normalise_history</a>(s);
<a name="l00192"></a>00192       s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> = <a class="code" href="plc_8c.html#86c32477e3b97311a73dea46e8ffa692">amdf_pitch</a>(<a class="code" href="plc_8h.html#15b2951603350ca19b8443c389a4afb4">PLC_PITCH_MIN</a>, <a class="code" href="plc_8h.html#06d301ddcbd06e5c173fb5520c2fea8f">PLC_PITCH_MAX</a>, s-&gt;<a class="code" href="structplc__state__t.html#8866e1a5481cd4125c118914ce255237">history</a> + <a class="code" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a> - <a class="code" href="plc_8h.html#39f566c6883296b670eb9e6d60127bc7">CORRELATION_SPAN</a> - <a class="code" href="plc_8h.html#15b2951603350ca19b8443c389a4afb4">PLC_PITCH_MIN</a>, <a class="code" href="plc_8h.html#39f566c6883296b670eb9e6d60127bc7">CORRELATION_SPAN</a>);
<a name="l00193"></a>00193       <span class="comment">/* We overlap a 1/4 wavelength */</span>
<a name="l00194"></a>00194       pitch_overlap = s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> &gt;&gt; 2;
<a name="l00195"></a>00195       <span class="comment">/* Cook up a single cycle of pitch, using a single of the real signal with 1/4</span>
<a name="l00196"></a>00196 <span class="comment">         cycle OLA'ed to make the ends join up nicely */</span>
<a name="l00197"></a>00197       <span class="comment">/* The first 3/4 of the cycle is a simple copy */</span>
<a name="l00198"></a>00198       <span class="keywordflow">for</span> (i = 0;  i &lt; s-&gt;pitch - pitch_overlap;  i++)
<a name="l00199"></a>00199          s-&gt;<a class="code" href="structplc__state__t.html#fbc2354be7b081bb7a7683da7b8a62a5">pitchbuf</a>[i] = s-&gt;<a class="code" href="structplc__state__t.html#8866e1a5481cd4125c118914ce255237">history</a>[<a class="code" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a> - s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> + i];
<a name="l00200"></a>00200       <span class="comment">/* The last 1/4 of the cycle is overlapped with the end of the previous cycle */</span>
<a name="l00201"></a>00201       new_step = 1.0/pitch_overlap;
<a name="l00202"></a>00202       new_weight = new_step;
<a name="l00203"></a>00203       <span class="keywordflow">for</span> ( ; i &lt; s-&gt;pitch; i++) {
<a name="l00204"></a>00204          s-&gt;<a class="code" href="structplc__state__t.html#fbc2354be7b081bb7a7683da7b8a62a5">pitchbuf</a>[i] = s-&gt;<a class="code" href="structplc__state__t.html#8866e1a5481cd4125c118914ce255237">history</a>[<a class="code" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a> - s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> + i] * (1.0 - new_weight) + s-&gt;<a class="code" href="structplc__state__t.html#8866e1a5481cd4125c118914ce255237">history</a>[<a class="code" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a> - 2 * s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> + i]*new_weight;
<a name="l00205"></a>00205          new_weight += new_step;
<a name="l00206"></a>00206       }
<a name="l00207"></a>00207       <span class="comment">/* We should now be ready to fill in the gap with repeated, decaying cycles</span>
<a name="l00208"></a>00208 <span class="comment">         of what is in pitchbuf */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210       <span class="comment">/* We need to OLA the first 1/4 wavelength of the synthetic data, to smooth</span>
<a name="l00211"></a>00211 <span class="comment">         it into the previous real data. To avoid the need to introduce a delay</span>
<a name="l00212"></a>00212 <span class="comment">         in the stream, reverse the last 1/4 wavelength, and OLA with that. */</span>
<a name="l00213"></a>00213       gain = 1.0;
<a name="l00214"></a>00214       new_step = 1.0 / pitch_overlap;
<a name="l00215"></a>00215       old_step = new_step;
<a name="l00216"></a>00216       new_weight = new_step;
<a name="l00217"></a>00217       old_weight = 1.0 - new_step;
<a name="l00218"></a>00218       <span class="keywordflow">for</span> (i = 0; i &lt; pitch_overlap; i++) {
<a name="l00219"></a>00219          amp[i] = <a class="code" href="plc_8c.html#658df892af11387a81dd55973a65aa50">fsaturate</a>(old_weight * s-&gt;<a class="code" href="structplc__state__t.html#8866e1a5481cd4125c118914ce255237">history</a>[<a class="code" href="plc_8h.html#030c3d36cbb031ab682df369984c7e69">PLC_HISTORY_LEN</a> - 1 - i] + new_weight * s-&gt;<a class="code" href="structplc__state__t.html#fbc2354be7b081bb7a7683da7b8a62a5">pitchbuf</a>[i]);
<a name="l00220"></a>00220          new_weight += new_step;
<a name="l00221"></a>00221          old_weight -= old_step;
<a name="l00222"></a>00222          <span class="keywordflow">if</span> (old_weight &lt; 0.0)
<a name="l00223"></a>00223             old_weight = 0.0;
<a name="l00224"></a>00224       }
<a name="l00225"></a>00225       s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a> = i;
<a name="l00226"></a>00226    } <span class="keywordflow">else</span> {
<a name="l00227"></a>00227       gain = 1.0 - s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a>*<a class="code" href="plc_8c.html#9fbb1600d92a85bd084d9637c2c8bf7e">ATTENUATION_INCREMENT</a>;
<a name="l00228"></a>00228       i = 0;
<a name="l00229"></a>00229    }
<a name="l00230"></a>00230    <span class="keywordflow">for</span> ( ; gain &gt; 0.0 &amp;&amp; i &lt; <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>; i++) {
<a name="l00231"></a>00231       amp[i] = s-&gt;<a class="code" href="structplc__state__t.html#fbc2354be7b081bb7a7683da7b8a62a5">pitchbuf</a>[s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a>] * gain;
<a name="l00232"></a>00232       gain -= <a class="code" href="plc_8c.html#9fbb1600d92a85bd084d9637c2c8bf7e">ATTENUATION_INCREMENT</a>;
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (++s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a> &gt;= s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a>)
<a name="l00234"></a>00234          s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a> = 0;
<a name="l00235"></a>00235    }
<a name="l00236"></a>00236    <span class="keywordflow">for</span> ( ; i &lt; <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>; i++)
<a name="l00237"></a>00237       amp[i] = 0;
<a name="l00238"></a>00238    s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a> += orig_len;
<a name="l00239"></a>00239    <a class="code" href="plc_8c.html#208ea3dc9521aabe7d987c3022efffbd">save_history</a>(s, amp, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l00240"></a>00240    <span class="keywordflow">return</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00241"></a>00241 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="7a2bb3cee685bd3dea83032b410b9179"></a><!-- doxytag: member="plc.h::plc_init" ref="7a2bb3cee685bd3dea83032b410b9179" args="(plc_state_t *s)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="structplc__state__t.html">plc_state_t</a>* plc_init           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structplc__state__t.html">plc_state_t</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>s</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Process a block of received V.29 modem audio samples. 
<p>
Process a block of received V.29 modem audio samples. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td>The packet loss concealer context. </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>A pointer to the he packet loss concealer context. </dd></dl>

<p>
Definition at line <a class="el" href="plc_8c-source.html#l00245">245</a> of file <a class="el" href="plc_8c-source.html">plc.c</a>.<div class="fragment"><pre class="fragment"><a name="l00246"></a>00246 {
<a name="l00247"></a>00247    memset(s, 0, <span class="keyword">sizeof</span>(*s));
<a name="l00248"></a>00248    <span class="keywordflow">return</span> s;
<a name="l00249"></a>00249 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="3bc3f79ef039ed2a8bbc3eb176a2b0a6"></a><!-- doxytag: member="plc.h::plc_rx" ref="3bc3f79ef039ed2a8bbc3eb176a2b0a6" args="(plc_state_t *s, int16_t amp[], int len)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int plc_rx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structplc__state__t.html">plc_state_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int16_t&nbsp;</td>
          <td class="mdname" nowrap> <em>amp</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Process a block of received audio samples. 
<p>
Process a block of received audio samples. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td>The packet loss concealer context. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>amp</em>&nbsp;</td><td>The audio sample buffer. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>len</em>&nbsp;</td><td>The number of samples in the buffer. </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>The number of samples in the buffer. </dd></dl>

<p>
Definition at line <a class="el" href="plc_8c-source.html#l00131">131</a> of file <a class="el" href="plc_8c-source.html">plc.c</a>.
<p>
References <a class="el" href="plc_8c-source.html#l00057">ATTENUATION_INCREMENT</a>, <a class="el" href="plc_8c-source.html#l00061">fsaturate()</a>, <a class="el" href="plc_8h-source.html#l00116">plc_state_t::missing_samples</a>, <a class="el" href="plc_8h-source.html#l00120">plc_state_t::pitch</a>, <a class="el" href="plc_8h-source.html#l00118">plc_state_t::pitch_offset</a>, <a class="el" href="plc_8h-source.html#l00122">plc_state_t::pitchbuf</a>, and <a class="el" href="plc_8c-source.html#l00070">save_history()</a>.
<p>
Referenced by <a class="el" href="translate_8c-source.html#l00150">framein()</a>.<div class="fragment"><pre class="fragment"><a name="l00132"></a>00132 {
<a name="l00133"></a>00133    <span class="keywordtype">int</span> i;
<a name="l00134"></a>00134    <span class="keywordtype">int</span> pitch_overlap;
<a name="l00135"></a>00135    <span class="keywordtype">float</span> old_step;
<a name="l00136"></a>00136    <span class="keywordtype">float</span> new_step;
<a name="l00137"></a>00137    <span class="keywordtype">float</span> old_weight;
<a name="l00138"></a>00138    <span class="keywordtype">float</span> new_weight;
<a name="l00139"></a>00139    <span class="keywordtype">float</span> gain;
<a name="l00140"></a>00140    
<a name="l00141"></a>00141    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a>) {
<a name="l00142"></a>00142       <span class="comment">/* Although we have a real signal, we need to smooth it to fit well</span>
<a name="l00143"></a>00143 <span class="comment">      with the synthetic signal we used for the previous block */</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145       <span class="comment">/* The start of the real data is overlapped with the next 1/4 cycle</span>
<a name="l00146"></a>00146 <span class="comment">         of the synthetic data. */</span>
<a name="l00147"></a>00147       pitch_overlap = s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a> &gt;&gt; 2;
<a name="l00148"></a>00148       <span class="keywordflow">if</span> (pitch_overlap &gt; <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)
<a name="l00149"></a>00149          pitch_overlap = <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00150"></a>00150       gain = 1.0 - s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a>*<a class="code" href="plc_8c.html#9fbb1600d92a85bd084d9637c2c8bf7e">ATTENUATION_INCREMENT</a>;
<a name="l00151"></a>00151       <span class="keywordflow">if</span> (gain &lt; 0.0)
<a name="l00152"></a>00152          gain = 0.0;
<a name="l00153"></a>00153       new_step = 1.0/pitch_overlap;
<a name="l00154"></a>00154       old_step = new_step*gain;
<a name="l00155"></a>00155       new_weight = new_step;
<a name="l00156"></a>00156       old_weight = (1.0 - new_step)*gain;
<a name="l00157"></a>00157       <span class="keywordflow">for</span> (i = 0; i &lt; pitch_overlap; i++) {
<a name="l00158"></a>00158          amp[i] = <a class="code" href="plc_8c.html#658df892af11387a81dd55973a65aa50">fsaturate</a>(old_weight * s-&gt;<a class="code" href="structplc__state__t.html#fbc2354be7b081bb7a7683da7b8a62a5">pitchbuf</a>[s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a>] + new_weight * amp[i]);
<a name="l00159"></a>00159          <span class="keywordflow">if</span> (++s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a> &gt;= s-&gt;<a class="code" href="structplc__state__t.html#8ee0b79fb35b0efe85b44c0ee243f8d5">pitch</a>)
<a name="l00160"></a>00160             s-&gt;<a class="code" href="structplc__state__t.html#68b8547720f45e0eaadf7b68eafa21f6">pitch_offset</a> = 0;
<a name="l00161"></a>00161          new_weight += new_step;
<a name="l00162"></a>00162          old_weight -= old_step;
<a name="l00163"></a>00163          <span class="keywordflow">if</span> (old_weight &lt; 0.0)
<a name="l00164"></a>00164             old_weight = 0.0;
<a name="l00165"></a>00165       }
<a name="l00166"></a>00166       s-&gt;<a class="code" href="structplc__state__t.html#3cb5dc51cdb8f6abc5f02ff512f0b866">missing_samples</a> = 0;
<a name="l00167"></a>00167    }
<a name="l00168"></a>00168    <a class="code" href="plc_8c.html#208ea3dc9521aabe7d987c3022efffbd">save_history</a>(s, amp, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l00169"></a>00169    <span class="keywordflow">return</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00170"></a>00170 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:42 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
