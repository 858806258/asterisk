<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:49 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_features.c</h1><a href="res__features_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Routines implementing call features as call pickup, parking and transfer</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;pthread.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="causes_8h.html">asterisk/causes.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="translate_8h.html">asterisk/translate.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="say_8h.html">asterisk/say.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="features_8h.html">asterisk/features.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="musiconhold_8h.html">asterisk/musiconhold.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="manager_8h.html">asterisk/manager.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="adsi_8h.html">asterisk/adsi.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="devicestate_8h.html">asterisk/devicestate.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="monitor_8h.html">asterisk/monitor.h</a>"</span>
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="res__features_8c.html#7c3f52dfb0d0a143e81f48996dba0579">00062</a> <span class="preprocessor">#define DEFAULT_PARK_TIME 45000</span>
<a name="l00063"></a><a class="code" href="res__features_8c.html#f7afae2b70d4bc616be3364b65384e59">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_TRANSFER_DIGIT_TIMEOUT 3000</span>
<a name="l00064"></a><a class="code" href="res__features_8c.html#19f1c4d65f5e18e457aca3bca34e00da">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_FEATURE_DIGIT_TIMEOUT 500</span>
<a name="l00065"></a><a class="code" href="res__features_8c.html#09307d2bf2155595f4977f6a1db99890">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER 15000</span>
<a name="l00066"></a><a class="code" href="res__features_8c.html#16f194b1ed2ce4bb3d724e59e9731fdf">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_ATXFER_DROP_CALL 0</span>
<a name="l00067"></a><a class="code" href="res__features_8c.html#9b60acd9fc728db55e4be04aad40f490">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_ATXFER_LOOP_DELAY 10000</span>
<a name="l00068"></a><a class="code" href="res__features_8c.html#d7834bac727c309d16f837933156df3c">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_ATXFER_CALLBACK_RETRIES 2</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a><a class="code" href="res__features_8c.html#91e22cf128e1f0b62755cd9f9b4fc002">00070</a> <span class="preprocessor">#define AST_MAX_WATCHERS 256</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a>00072 <span class="keyword">enum</span> {
<a name="l00073"></a>00073    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a> = (1 &lt;&lt; 0),
<a name="l00074"></a>00074    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef20e49040e82575ddc0bc864e501e5cb7">AST_FEATURE_FLAG_ONPEER</a> =    (1 &lt;&lt; 1),
<a name="l00075"></a>00075    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efbfdc26da820d520cf35171586fb5b81a">AST_FEATURE_FLAG_ONSELF</a> =    (1 &lt;&lt; 2),
<a name="l00076"></a>00076    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a> =  (1 &lt;&lt; 3),
<a name="l00077"></a>00077    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a> =  (1 &lt;&lt; 4),
<a name="l00078"></a>00078    <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>  =   (3 &lt;&lt; 3),
<a name="l00079"></a>00079 };
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="res__features_8c.html#6799a0be08d3bdfe0b2b5f19d7546798">00081</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#6799a0be08d3bdfe0b2b5f19d7546798">parkedcall</a> = <span class="stringliteral">"ParkedCall"</span>;
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="res__features_8c.html#9182c07816a170c7341ddd2583fe21f5">00083</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#9182c07816a170c7341ddd2583fe21f5">parkaddhints</a> = 0;                               <span class="comment">/*!&lt; Add parking hints automatically */</span>
<a name="l00084"></a><a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">00084</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = 0;                        <span class="comment">/*!&lt; Enable DTMF based transfers on bridge when picking up parked calls */</span>
<a name="l00085"></a><a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">00085</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> = 0;                        <span class="comment">/*!&lt; Enable DTMF based parking on bridge when picking up parked calls */</span>
<a name="l00086"></a><a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">00086</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a> = <a class="code" href="res__features_8c.html#7c3f52dfb0d0a143e81f48996dba0579">DEFAULT_PARK_TIME</a>;                <span class="comment">/*!&lt; No more than 45 seconds parked before you do something with them */</span>
<a name="l00087"></a><a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">00087</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];                <span class="comment">/*!&lt; Context for which parking is made accessible */</span>
<a name="l00088"></a><a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">00088</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];           <span class="comment">/*!&lt; Context for dialback for parking (KLUDGE) */</span>
<a name="l00089"></a><a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">00089</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];                <span class="comment">/*!&lt; Extension you type to park the call */</span>
<a name="l00090"></a><a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">00090</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">pickup_ext</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];                 <span class="comment">/*!&lt; Call pickup extension */</span>
<a name="l00091"></a><a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">00091</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>[<a class="code" href="channel_8h.html#7c3359b925cb4caf244a7f0e7d553b13">MAX_MUSICCLASS</a>];                  <span class="comment">/*!&lt; Music class used for parking */</span>
<a name="l00092"></a><a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">00092</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a>;                                  <span class="comment">/*!&lt; First available extension for parking */</span>
<a name="l00093"></a><a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">00093</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a>;                                   <span class="comment">/*!&lt; Last available extension for parking */</span>
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">00095</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>[256];                             <span class="comment">/*!&lt; Courtesy tone */</span>
<a name="l00096"></a><a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">00096</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> = 0;                                 <span class="comment">/*!&lt; Who to play the courtesy tone to */</span>
<a name="l00097"></a><a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">00097</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>[256];                                <span class="comment">/*!&lt; Call transfer sound */</span>
<a name="l00098"></a><a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">00098</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>[256];                            <span class="comment">/*!&lt; Call transfer failure sound */</span>
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="res__features_8c.html#705d46cc57ca1e0bca847c76e2485b4c">00100</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#705d46cc57ca1e0bca847c76e2485b4c">parking_offset</a>;
<a name="l00101"></a><a class="code" href="res__features_8c.html#3307cc7b19dbe62fab2483af01449e20">00101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#3307cc7b19dbe62fab2483af01449e20">parkfindnext</a>;
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="res__features_8c.html#e8f11b21e02217176b0804f5bc589941">00103</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#e8f11b21e02217176b0804f5bc589941">adsipark</a>;
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">00105</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a>;
<a name="l00106"></a><a class="code" href="res__features_8c.html#9c377c53990dd55a57a71e8b85d40e73">00106</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a>;
<a name="l00107"></a><a class="code" href="res__features_8c.html#0d0097fcffce18c1b3c2a8904c087f83">00107</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#0d0097fcffce18c1b3c2a8904c087f83">comebacktoorigin</a> = 1;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">00109</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>;
<a name="l00110"></a><a class="code" href="res__features_8c.html#3dfbecf9aa153bd233694a1c60f2161b">00110</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#3dfbecf9aa153bd233694a1c60f2161b">atxferdropcall</a>;
<a name="l00111"></a><a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">00111</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a>;
<a name="l00112"></a><a class="code" href="res__features_8c.html#b912136f198ae4b8d6737fff37c17309">00112</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#b912136f198ae4b8d6737fff37c17309">atxfercallbackretries</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="res__features_8c.html#5940569cd1d60781f856f93235b072ee">00114</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a> = <span class="stringliteral">"res_features"</span>;        <span class="comment">/*!&lt; Registrar for operations */</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="comment">/* module and CLI command definitions */</span>
<a name="l00117"></a><a class="code" href="res__features_8c.html#512fbb4e7b617c04031f58b631f2b05d">00117</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#485d112e4e425dde393e2e7091451856">synopsis</a> = <span class="stringliteral">"Answer a parked call"</span>;
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="res__features_8c.html#109a898ddfbe5f3573de9ef7ed6c5295">00119</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a> = <span class="stringliteral">"ParkedCall(exten):"</span>
<a name="l00120"></a>00120 <span class="stringliteral">"Used to connect to a parked call.  This application is always\n"</span>
<a name="l00121"></a>00121 <span class="stringliteral">"registered internally and does not need to be explicitly added\n"</span>
<a name="l00122"></a>00122 <span class="stringliteral">"into the dialplan, although you should include the 'parkedcalls'\n"</span>
<a name="l00123"></a>00123 <span class="stringliteral">"context.\n"</span>;
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="res__features_8c.html#d4db798eecbddaa591e0427c6267cdb8">00125</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#d4db798eecbddaa591e0427c6267cdb8">parkcall</a> = <span class="stringliteral">"Park"</span>;
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="res__features_8c.html#4ba02cd55a25f5f329069177b73d406f">00127</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#4ba02cd55a25f5f329069177b73d406f">synopsis2</a> = <span class="stringliteral">"Park yourself"</span>;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="res__features_8c.html#cb536af3cf5b3ba3c4772802aec813d6">00129</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#cb536af3cf5b3ba3c4772802aec813d6">descrip2</a> = <span class="stringliteral">"Park():"</span>
<a name="l00130"></a>00130 <span class="stringliteral">"Used to park yourself (typically in combination with a supervised\n"</span>
<a name="l00131"></a>00131 <span class="stringliteral">"transfer to know the parking space). This application is always\n"</span>
<a name="l00132"></a>00132 <span class="stringliteral">"registered internally and does not need to be explicitly added\n"</span>
<a name="l00133"></a>00133 <span class="stringliteral">"into the dialplan, although you should include the 'parkedcalls'\n"</span>
<a name="l00134"></a>00134 <span class="stringliteral">"context (or the context specified in features.conf).\n\n"</span>
<a name="l00135"></a>00135 <span class="stringliteral">"If you set the PARKINGEXTEN variable to an extension in your\n"</span>
<a name="l00136"></a>00136 <span class="stringliteral">"parking context, park() will park the call on that extension, unless\n"</span>
<a name="l00137"></a>00137 <span class="stringliteral">"it already exists. In that case, execution will continue at next\n"</span>
<a name="l00138"></a>00138 <span class="stringliteral">"priority.\n"</span> ;
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="res__features_8c.html#efaecc331c9dfbb44692cc61faeeeb73">00140</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__app.html">ast_app</a> *<a class="code" href="res__features_8c.html#efaecc331c9dfbb44692cc61faeeeb73">monitor_app</a> = NULL;
<a name="l00141"></a><a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">00141</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">monitor_ok</a> = 1;
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="structparkeduser.html">00143</a> <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> {
<a name="l00144"></a><a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">00144</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>;                   <span class="comment">/*!&lt; Parking channel */</span>
<a name="l00145"></a><a class="code" href="structparkeduser.html#ea2b2676c28c0db26d39331a336c6b92">00145</a>    <span class="keyword">struct </span>timeval start;                       <span class="comment">/*!&lt; Time the parking started */</span>
<a name="l00146"></a><a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">00146</a>    <span class="keywordtype">int</span> <a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a>;                             <span class="comment">/*!&lt; Parking lot */</span>
<a name="l00147"></a><a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">00147</a>    <span class="keywordtype">char</span> <a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];       <span class="comment">/*!&lt; If set beforehand, parking extension used for this call */</span>
<a name="l00148"></a><a class="code" href="structparkeduser.html#c1ae8ba118483c4c23841d72b5e7ebbb">00148</a>    <span class="keywordtype">char</span> <a class="code" href="structparkeduser.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>[<a class="code" href="channel_8h.html#4d1ee7076af5032452aaba4ead082588">AST_MAX_CONTEXT</a>];              <span class="comment">/*!&lt; Where to go if our parking time expires */</span>
<a name="l00149"></a><a class="code" href="structparkeduser.html#5aedfeaeaac21e5e5f297360633ea9a3">00149</a>    <span class="keywordtype">char</span> <a class="code" href="structparkeduser.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l00150"></a><a class="code" href="structparkeduser.html#b988295c268025b49dfb3df26171ddc3">00150</a>    <span class="keywordtype">int</span> <a class="code" href="structparkeduser.html#b988295c268025b49dfb3df26171ddc3">priority</a>;
<a name="l00151"></a><a class="code" href="structparkeduser.html#c700875891439809b350a5e629558902">00151</a>    <span class="keywordtype">int</span> <a class="code" href="structparkeduser.html#c700875891439809b350a5e629558902">parkingtime</a>;                            <span class="comment">/*!&lt; Maximum length in parking lot before return */</span>
<a name="l00152"></a><a class="code" href="structparkeduser.html#abd25c1411415ae93a1a7ec80f270e3e">00152</a>    <span class="keywordtype">int</span> <a class="code" href="structparkeduser.html#abd25c1411415ae93a1a7ec80f270e3e">notquiteyet</a>;
<a name="l00153"></a><a class="code" href="structparkeduser.html#c918796d8b2a501b03d3814d1d2c7a0e">00153</a>    <span class="keywordtype">char</span> <a class="code" href="structparkeduser.html#c918796d8b2a501b03d3814d1d2c7a0e">peername</a>[1024];
<a name="l00154"></a><a class="code" href="structparkeduser.html#728bc02aa6dd2569cbf6a27a00659cbe">00154</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structparkeduser.html#728bc02aa6dd2569cbf6a27a00659cbe">moh_trys</a>;
<a name="l00155"></a><a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">00155</a>    <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00156"></a>00156 };
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="res__features_8c.html#5854e71c08151ba6487b269e519ca1d4">00158</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *<a class="code" href="res__features_8c.html#5854e71c08151ba6487b269e519ca1d4">parkinglot</a>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <a class="code" href="lock_8h.html#4291c0bd75dfaf0052799003d3305e16">AST_MUTEX_DEFINE_STATIC</a>(parking_lock); <span class="comment">/*!&lt; protects all static variables above */</span>
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="res__features_8c.html#a1b4c23e2029d94fb9090c489fdb6bcf">00162</a> <span class="keyword">static</span> pthread_t <a class="code" href="res__features_8c.html#a1b4c23e2029d94fb9090c489fdb6bcf">parking_thread</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="res__features_8c.html#592f5491321993926462dffa87ba0bab">00164</a> <span class="keywordtype">char</span> *<a class="code" href="features_8h.html#592f5491321993926462dffa87ba0bab">ast_parking_ext</a>(<span class="keywordtype">void</span>)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166    <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="res__features_8c.html#907f86dbd402c7f215ba3047f8c54a94">00169</a> <span class="keywordtype">char</span> *<a class="code" href="features_8h.html#907f86dbd402c7f215ba3047f8c54a94">ast_pickup_ext</a>(<span class="keywordtype">void</span>)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171    <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">pickup_ext</a>;
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="structast__bridge__thread__obj.html">00174</a> <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> 
<a name="l00175"></a>00175 {
<a name="l00176"></a><a class="code" href="structast__bridge__thread__obj.html#31a483ddbf1c3fb9ad5ecfe9a9c27b2b">00176</a>    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html">ast_bridge_config</a> bconfig;
<a name="l00177"></a><a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">00177</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l00178"></a><a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">00178</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>;
<a name="l00179"></a><a class="code" href="structast__bridge__thread__obj.html#f24086cc16b61a8efc5ef913a0ea3246">00179</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__bridge__thread__obj.html#f24086cc16b61a8efc5ef913a0ea3246">return_to_pbx</a>:1;
<a name="l00180"></a>00180 };
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment"></span>
<a name="l00184"></a>00184 <span class="comment">/*! \brief store context, priority and extension */</span>
<a name="l00185"></a><a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">00185</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#abf77184f55403d75b9d51d79162a7ca">ext</a>, <span class="keywordtype">int</span> pri)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187    ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>));
<a name="l00188"></a>00188    ast_copy_string(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, ext, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>));
<a name="l00189"></a>00189    chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = pri;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="res__features_8c.html#e31296f1ba1e1918bd7f86ec2f9d7c63">00192</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#e31296f1ba1e1918bd7f86ec2f9d7c63">check_goto_on_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>) 
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *xferchan;
<a name="l00195"></a>00195    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a> = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"GOTO_ON_BLINDXFR"</span>);
<a name="l00196"></a>00196    <span class="keywordtype">char</span> *x, *goto_on_transfer;
<a name="l00197"></a>00197    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(val))
<a name="l00200"></a>00200       <span class="keywordflow">return</span>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    goto_on_transfer = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(val);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204    <span class="keywordflow">if</span> (!(xferchan = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, 0, chan-&gt;name)))
<a name="l00205"></a>00205       <span class="keywordflow">return</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207    <span class="keywordflow">for</span> (x = goto_on_transfer; x &amp;&amp; *x; x++) {
<a name="l00208"></a>00208       <span class="keywordflow">if</span> (*x == <span class="charliteral">'^'</span>)
<a name="l00209"></a>00209          *x = <span class="charliteral">'|'</span>;
<a name="l00210"></a>00210    }
<a name="l00211"></a>00211    <span class="comment">/* Make formats okay */</span>
<a name="l00212"></a>00212    xferchan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> = chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l00213"></a>00213    xferchan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l00214"></a>00214    <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(xferchan, chan);
<a name="l00215"></a>00215    <a class="code" href="pbx_8c.html#86eba1ec3178373f61c082e1f1f12b68">ast_parseable_goto</a>(xferchan, goto_on_transfer);
<a name="l00216"></a>00216    xferchan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>;
<a name="l00217"></a>00217    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);  
<a name="l00218"></a>00218    xferchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l00219"></a>00219    <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(xferchan))) {
<a name="l00220"></a>00220       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00221"></a>00221       f = NULL;
<a name="l00222"></a>00222       <a class="code" href="pbx_8c.html#c55e82ff3dabed89efd77f20209b1006">ast_pbx_start</a>(xferchan);
<a name="l00223"></a>00223    } <span class="keywordflow">else</span> {
<a name="l00224"></a>00224       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(xferchan);
<a name="l00225"></a>00225    }
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *caller, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *transferee, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *outstate, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, <span class="keywordtype">int</span> igncallerstate);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="res__features_8c.html#8d242ad016ad1d742400a3647d4638f2">00231</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__features_8c.html#8d242ad016ad1d742400a3647d4638f2">ast_bridge_call_thread</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>) 
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj = data;
<a name="l00234"></a>00234    <span class="keywordtype">int</span> res;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#63469c3c4f19f07c737127a117296de4">appl</a> = !tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f24086cc16b61a8efc5ef913a0ea3246">return_to_pbx</a> ? <span class="stringliteral">"Transferred Call"</span> : <span class="stringliteral">"ManagerBridge"</span>;
<a name="l00237"></a>00237    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a> = tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;name;
<a name="l00238"></a>00238    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;<a class="code" href="structast__channel.html#63469c3c4f19f07c737127a117296de4">appl</a> = !tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f24086cc16b61a8efc5ef913a0ea3246">return_to_pbx</a> ? <span class="stringliteral">"Transferred Call"</span> : <span class="stringliteral">"ManagerBridge"</span>;
<a name="l00239"></a>00239    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a> = tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {
<a name="l00242"></a>00242       <a class="code" href="cdr_8c.html#32799fa5951db39f7b0a4016bee27cf5">ast_cdr_reset</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, NULL);
<a name="l00243"></a>00243       <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;name);
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245    <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {
<a name="l00246"></a>00246       <a class="code" href="cdr_8c.html#32799fa5951db39f7b0a4016bee27cf5">ast_cdr_reset</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, NULL);
<a name="l00247"></a>00247       <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l00248"></a>00248    }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250    <a class="code" href="features_8h.html#61263ca8af831dbacdf11ec96ed61076">ast_bridge_call</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>, &amp;tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#31a483ddbf1c3fb9ad5ecfe9a9c27b2b">bconfig</a>);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f24086cc16b61a8efc5ef913a0ea3246">return_to_pbx</a>) {
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>)) {
<a name="l00254"></a>00254          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"putting peer %s into PBX again\n"</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;name);
<a name="l00255"></a>00255          res = <a class="code" href="pbx_8c.html#c55e82ff3dabed89efd77f20209b1006">ast_pbx_start</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>);
<a name="l00256"></a>00256          <span class="keywordflow">if</span> (res != <a class="code" href="pbx_8h.html#bc3ba53eb07b914cc39444bfcf88a912c86643c5e19588b3eb7dce58a2b4145a">AST_PBX_SUCCESS</a>)
<a name="l00257"></a>00257             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"FAILED continuing PBX on peer %s\n"</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>-&gt;name);
<a name="l00258"></a>00258       } <span class="keywordflow">else</span>
<a name="l00259"></a>00259          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>);
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>)) {
<a name="l00261"></a>00261          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"putting chan %s into PBX again\n"</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l00262"></a>00262          res = <a class="code" href="pbx_8c.html#c55e82ff3dabed89efd77f20209b1006">ast_pbx_start</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l00263"></a>00263          <span class="keywordflow">if</span> (res != <a class="code" href="pbx_8h.html#bc3ba53eb07b914cc39444bfcf88a912c86643c5e19588b3eb7dce58a2b4145a">AST_PBX_SUCCESS</a>)
<a name="l00264"></a>00264             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"FAILED continuing PBX on chan %s\n"</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l00265"></a>00265       } <span class="keywordflow">else</span>
<a name="l00266"></a>00266          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l00267"></a>00267    } <span class="keywordflow">else</span> {
<a name="l00268"></a>00268       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l00269"></a>00269       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#f8fe68b4c4cba197efa9c8bbd45f144e">peer</a>);
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(tobj);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="keywordflow">return</span> NULL;
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a><a class="code" href="res__features_8c.html#154203f487a3163df7709494f6c89372">00277</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#154203f487a3163df7709494f6c89372">ast_bridge_call_thread_launch</a>(<span class="keywordtype">void</span> *data) 
<a name="l00278"></a>00278 {
<a name="l00279"></a>00279    pthread_t <a class="code" href="app__meetme_8c.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a>;
<a name="l00280"></a>00280    pthread_attr_t attr;
<a name="l00281"></a>00281    <span class="keyword">struct </span>sched_param sched;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283    pthread_attr_init(&amp;attr);
<a name="l00284"></a>00284    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
<a name="l00285"></a>00285    <a class="code" href="utils_8h.html#89a8ad746b25627dd12304511d68a24c">ast_pthread_create</a>(&amp;thread, &amp;attr,<a class="code" href="res__features_8c.html#8d242ad016ad1d742400a3647d4638f2">ast_bridge_call_thread</a>, data);
<a name="l00286"></a>00286    pthread_attr_destroy(&amp;attr);
<a name="l00287"></a>00287    memset(&amp;sched, 0, <span class="keyword">sizeof</span>(sched));
<a name="l00288"></a>00288    pthread_setschedparam(thread, SCHED_RR, &amp;sched);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="res__features_8c.html#da019e20f76270834e30c1b497b8cc13">00291</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#da019e20f76270834e30c1b497b8cc13">adsi_announce_park</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">char</span> *parkingexten)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293    <span class="keywordtype">int</span> res;
<a name="l00294"></a>00294    <span class="keywordtype">int</span> <a class="code" href="app__adsiprog_8c.html#b64645b87543cc9eafb2641b6d4ca2fc">justify</a>[5] = {<a class="code" href="adsi_8h.html#809c8d746981c35675e642a72edad17e">ADSI_JUST_CENT</a>, <a class="code" href="adsi_8h.html#809c8d746981c35675e642a72edad17e">ADSI_JUST_CENT</a>, ADSI_JUST_CENT, ADSI_JUST_CENT};
<a name="l00295"></a>00295    <span class="keywordtype">char</span> tmp[256];
<a name="l00296"></a>00296    <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a>[5] = {NULL, NULL, NULL, NULL, NULL};
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"Parked on %s"</span>, parkingexten);
<a name="l00299"></a>00299    message[0] = tmp;
<a name="l00300"></a>00300    res = <a class="code" href="adsi_8h.html#ce3248beba760c229c6a6e561ad692bd">ast_adsi_load_session</a>(chan, NULL, 0, 1);
<a name="l00301"></a>00301    <span class="keywordflow">if</span> (res == -1)
<a name="l00302"></a>00302       <span class="keywordflow">return</span> res;
<a name="l00303"></a>00303    <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#edfc2727feaa97dce38bf3199fd6aa16">ast_adsi_print</a>(chan, message, justify, 1);
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 <span class="comment"></span>
<a name="l00306"></a>00306 <span class="comment">/*! \brief Notify metermaids that we've changed an extension */</span>
<a name="l00307"></a><a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">00307</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(<span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 3)
<a name="l00310"></a>00310       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Notification of state change to metermaids %s@%s\n"</span>, exten, context);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312    <span class="comment">/* Send notification to devicestate subsystem */</span>
<a name="l00313"></a>00313    <a class="code" href="devicestate_8c.html#cb1f907e1a925c05cbdaf6f0b00f08ee">ast_device_state_changed</a>(<span class="stringliteral">"park:%s@%s"</span>, exten, context);
<a name="l00314"></a>00314    <span class="keywordflow">return</span>;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 <span class="comment"></span>
<a name="l00317"></a>00317 <span class="comment">/*! \brief metermaids callback from devicestate.c */</span>
<a name="l00318"></a><a class="code" href="res__features_8c.html#20c7953bc61de19e6265a62527213440">00318</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8c.html#108baa7a6e968d91099ef15c445e215c">ast_device_state</a> <a class="code" href="res__features_8c.html#20c7953bc61de19e6265a62527213440">metermaidstate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320    <span class="keyword">enum</span> <a class="code" href="devicestate_8c.html#108baa7a6e968d91099ef15c445e215c">ast_device_state</a> res = <a class="code" href="devicestate_8h.html#b32c9d7f2a117281efcc381ee116cc9e9cc12f38e2eec4c5ed63a43bc967834d">AST_DEVICE_INVALID</a>;
<a name="l00321"></a>00321    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a> = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(data);
<a name="l00322"></a>00322    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    exten = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;context, <span class="stringliteral">"@"</span>);
<a name="l00325"></a>00325    <span class="keywordflow">if</span> (!context)
<a name="l00326"></a>00326       <span class="keywordflow">return</span> res;
<a name="l00327"></a>00327    
<a name="l00328"></a>00328    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 3)
<a name="l00329"></a>00329       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Checking state of exten %s in context %s\n"</span>, exten, context);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    res = <a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(NULL, context, exten, 1, NULL);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333    <span class="keywordflow">if</span> (res == <a class="code" href="devicestate_8h.html#b32c9d7f2a117281efcc381ee116cc9ec0882f63fc5e52ac924c0e826d4782d3">AST_DEVICE_UNKNOWN</a>)
<a name="l00334"></a>00334       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#b32c9d7f2a117281efcc381ee116cc9e0fe2efc106235ced7c3742c8fb054544">AST_DEVICE_NOT_INUSE</a>;
<a name="l00335"></a>00335    <span class="keywordflow">else</span>
<a name="l00336"></a>00336       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#b32c9d7f2a117281efcc381ee116cc9eb54883b8e5fcba0b30f9db4b98eb0f42">AST_DEVICE_INUSE</a>;
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 <span class="comment"></span>
<a name="l00339"></a>00339 <span class="comment">/*! \brief Park a call </span>
<a name="l00340"></a>00340 <span class="comment">   \note We put the user in the parking list, then wake up the parking thread to be sure it looks</span>
<a name="l00341"></a>00341 <span class="comment">   after these channels too */</span>
<a name="l00342"></a><a class="code" href="res__features_8c.html#ae6f8d15dde194f3732f5cb3d7146020">00342</a> <span class="keywordtype">int</span> <a class="code" href="features_8h.html#c9d53b3e6972e1cb4fd0153b648e204a">ast_park_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *extout)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344    <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *pu, *cur;
<a name="l00345"></a>00345    <span class="keywordtype">int</span> i, x = -1, parking_range;
<a name="l00346"></a>00346    <span class="keyword">struct </span><a class="code" href="structast__context.html">ast_context</a> *con;
<a name="l00347"></a>00347    <span class="keyword">const</span> <span class="keywordtype">char</span> *parkingexten;
<a name="l00348"></a>00348    
<a name="l00349"></a>00349    <span class="comment">/* Allocate memory for parking data */</span>
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (!(pu = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*pu)))) 
<a name="l00351"></a>00351       <span class="keywordflow">return</span> -1;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <span class="comment">/* Lock parking lot */</span>
<a name="l00354"></a>00354    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;parking_lock);
<a name="l00355"></a>00355    <span class="comment">/* Check for channel variable PARKINGEXTEN */</span>
<a name="l00356"></a>00356    parkingexten = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"PARKINGEXTEN"</span>);
<a name="l00357"></a>00357    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(parkingexten)) {
<a name="l00358"></a>00358       <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(NULL, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, parkingexten, 1, NULL)) {
<a name="l00359"></a>00359          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l00360"></a>00360          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(pu);
<a name="l00361"></a>00361          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Requested parking extension already exists: %s@%s\n"</span>, parkingexten, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l00362"></a>00362          <span class="keywordflow">return</span> 0;   <span class="comment">/* Continue execution if possible */</span>
<a name="l00363"></a>00363       }
<a name="l00364"></a>00364       ast_copy_string(pu-&gt;parkingexten, parkingexten, <span class="keyword">sizeof</span>(pu-&gt;parkingexten));
<a name="l00365"></a>00365       x = atoi(parkingexten);
<a name="l00366"></a>00366    } <span class="keywordflow">else</span> {
<a name="l00367"></a>00367       <span class="comment">/* Select parking space within range */</span>
<a name="l00368"></a>00368       parking_range = <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a> - <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a>+1;
<a name="l00369"></a>00369       <span class="keywordflow">for</span> (i = 0; i &lt; parking_range; i++) {
<a name="l00370"></a>00370          x = (i + <a class="code" href="res__features_8c.html#705d46cc57ca1e0bca847c76e2485b4c">parking_offset</a>) % parking_range + parking_start;
<a name="l00371"></a>00371          cur = parkinglot;
<a name="l00372"></a>00372          <span class="keywordflow">while</span>(cur) {
<a name="l00373"></a>00373             <span class="keywordflow">if</span> (cur-&gt;parkingnum == x) 
<a name="l00374"></a>00374                <span class="keywordflow">break</span>;
<a name="l00375"></a>00375             cur = cur-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00376"></a>00376          }
<a name="l00377"></a>00377          <span class="keywordflow">if</span> (!cur)
<a name="l00378"></a>00378             <span class="keywordflow">break</span>;
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381       <span class="keywordflow">if</span> (!(i &lt; parking_range)) {
<a name="l00382"></a>00382          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No more parking spaces\n"</span>);
<a name="l00383"></a>00383          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(pu);
<a name="l00384"></a>00384          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l00385"></a>00385          <span class="keywordflow">return</span> -1;
<a name="l00386"></a>00386       }
<a name="l00387"></a>00387       <span class="comment">/* Set pointer for next parking */</span>
<a name="l00388"></a>00388       <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#3307cc7b19dbe62fab2483af01449e20">parkfindnext</a>) 
<a name="l00389"></a>00389          <a class="code" href="res__features_8c.html#705d46cc57ca1e0bca847c76e2485b4c">parking_offset</a> = x - parking_start + 1;
<a name="l00390"></a>00390    }
<a name="l00391"></a>00391    
<a name="l00392"></a>00392    chan-&gt;<a class="code" href="structast__channel.html#63469c3c4f19f07c737127a117296de4">appl</a> = <span class="stringliteral">"Parked Call"</span>;
<a name="l00393"></a>00393    chan-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a> = NULL; 
<a name="l00394"></a>00394 
<a name="l00395"></a>00395    pu-&gt;chan = chan;
<a name="l00396"></a>00396    
<a name="l00397"></a>00397    <span class="comment">/* Put the parked channel on hold if we have two different channels */</span>
<a name="l00398"></a>00398    <span class="keywordflow">if</span> (chan != peer) {
<a name="l00399"></a>00399       <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(pu-&gt;chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>, 
<a name="l00400"></a>00400          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>, NULL),
<a name="l00401"></a>00401          !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) ? strlen(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) + 1 : 0);
<a name="l00402"></a>00402    }
<a name="l00403"></a>00403    
<a name="l00404"></a>00404    pu-&gt;start = ast_tvnow();
<a name="l00405"></a>00405    pu-&gt;parkingnum = x;
<a name="l00406"></a>00406    pu-&gt;parkingtime = (timeout &gt; 0) ? timeout : <a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a>;
<a name="l00407"></a>00407    <span class="keywordflow">if</span> (extout)
<a name="l00408"></a>00408       *extout = x;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410    <span class="keywordflow">if</span> (peer) 
<a name="l00411"></a>00411       ast_copy_string(pu-&gt;peername, peer-&gt;name, <span class="keyword">sizeof</span>(pu-&gt;peername));
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <span class="comment">/* Remember what had been dialed, so that if the parking</span>
<a name="l00414"></a>00414 <span class="comment">      expires, we try to come back to the same place */</span>
<a name="l00415"></a>00415    ast_copy_string(pu-&gt;context, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#d26b4f540a5723a140b9836f73cf62a4">macrocontext</a>, chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>), <span class="keyword">sizeof</span>(pu-&gt;context));
<a name="l00416"></a>00416    ast_copy_string(pu-&gt;exten, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#abf9ad08121b2a624ad15e74c17f2b59">macroexten</a>, chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>), <span class="keyword">sizeof</span>(pu-&gt;exten));
<a name="l00417"></a>00417    pu-&gt;priority = chan-&gt;<a class="code" href="structast__channel.html#eb0665337d177a3a6fb6076ee2d317bd">macropriority</a> ? chan-&gt;<a class="code" href="structast__channel.html#eb0665337d177a3a6fb6076ee2d317bd">macropriority</a> : chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>;
<a name="l00418"></a>00418    pu-&gt;next = parkinglot;
<a name="l00419"></a>00419    parkinglot = pu;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421    <span class="comment">/* If parking a channel directly, don't quiet yet get parking running on it */</span>
<a name="l00422"></a>00422    <span class="keywordflow">if</span> (peer == chan) 
<a name="l00423"></a>00423       pu-&gt;<a class="code" href="structparkeduser.html#abd25c1411415ae93a1a7ec80f270e3e">notquiteyet</a> = 1;
<a name="l00424"></a>00424    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l00425"></a>00425    <span class="comment">/* Wake up the (presumably select()ing) thread */</span>
<a name="l00426"></a>00426    pthread_kill(<a class="code" href="res__features_8c.html#a1b4c23e2029d94fb9090c489fdb6bcf">parking_thread</a>, SIGURG);
<a name="l00427"></a>00427    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) 
<a name="l00428"></a>00428       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Parked %s on %d@%s. Will timeout back to extension [%s] %s, %d in %d seconds\n"</span>, pu-&gt;chan-&gt;name, pu-&gt;parkingnum, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, pu-&gt;context, pu-&gt;exten, pu-&gt;priority, (pu-&gt;parkingtime/1000));
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    <span class="keywordflow">if</span> (pu-&gt;parkingnum != -1)
<a name="l00431"></a>00431       snprintf(pu-&gt;parkingexten, <span class="keyword">sizeof</span>(pu-&gt;parkingexten), <span class="stringliteral">"%d"</span>, x);
<a name="l00432"></a>00432    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"ParkedCall"</span>,
<a name="l00433"></a>00433       <span class="stringliteral">"Exten: %s\r\n"</span>
<a name="l00434"></a>00434       <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l00435"></a>00435       <span class="stringliteral">"From: %s\r\n"</span>
<a name="l00436"></a>00436       <span class="stringliteral">"Timeout: %ld\r\n"</span>
<a name="l00437"></a>00437       <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l00438"></a>00438       <span class="stringliteral">"CallerIDName: %s\r\n"</span>,
<a name="l00439"></a>00439       pu-&gt;parkingexten, pu-&gt;chan-&gt;name, peer ? peer-&gt;name : <span class="stringliteral">""</span>,
<a name="l00440"></a>00440       (<span class="keywordtype">long</span>)pu-&gt;start.tv_sec + (<span class="keywordtype">long</span>)(pu-&gt;parkingtime/1000) - (<span class="keywordtype">long</span>)time(NULL),
<a name="l00441"></a>00441       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;chan-&gt;cid.cid_num, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l00442"></a>00442       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;chan-&gt;cid.cid_name, <span class="stringliteral">"&lt;unknown&gt;"</span>)
<a name="l00443"></a>00443       );
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    <span class="keywordflow">if</span> (peer &amp;&amp; <a class="code" href="res__features_8c.html#e8f11b21e02217176b0804f5bc589941">adsipark</a> &amp;&amp; <a class="code" href="adsi_8h.html#70400be4898ab6fbd733b93751dcc539">ast_adsi_available</a>(peer)) {
<a name="l00446"></a>00446       <a class="code" href="res__features_8c.html#da019e20f76270834e30c1b497b8cc13">adsi_announce_park</a>(peer, pu-&gt;parkingexten);  <span class="comment">/* Only supports parking numbers */</span>
<a name="l00447"></a>00447       <a class="code" href="adsi_8h.html#2f8323d710716d7bb9c902fa47b29558">ast_adsi_unload_session</a>(peer);
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (!con) 
<a name="l00452"></a>00452       con = <a class="code" href="pbx_8c.html#9b7261abb02956903bb17c5bf8af265a">ast_context_create</a>(NULL, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>);
<a name="l00453"></a>00453    <span class="keywordflow">if</span> (!con)   <span class="comment">/* Still no context? Bad */</span>
<a name="l00454"></a>00454       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Parking context '%s' does not exist and unable to create\n"</span>, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l00455"></a>00455    <span class="keywordflow">else</span> {      <span class="comment">/* Add extension to context */</span>
<a name="l00456"></a>00456       <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#0985a9a977ba8aa4f370da3a495437ae">ast_add_extension2</a>(con, 1, pu-&gt;parkingexten, 1, NULL, NULL, <a class="code" href="res__features_8c.html#6799a0be08d3bdfe0b2b5f19d7546798">parkedcall</a>, <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(pu-&gt;parkingexten), <a class="code" href="utils_8h.html#801d8022c2922d0d4f73ba9e72c93865">ast_free</a>, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>))
<a name="l00457"></a>00457          <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(pu-&gt;parkingexten, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l00458"></a>00458    }
<a name="l00459"></a>00459    <span class="comment">/* Tell the peer channel the number of the parking space */</span>
<a name="l00460"></a>00460    <span class="keywordflow">if</span> (peer &amp;&amp; pu-&gt;parkingnum != -1) <span class="comment">/* Only say number if it's a number */</span>
<a name="l00461"></a>00461       <a class="code" href="channel_8c.html#e02ce58f997ad8095efa170689df89cf">ast_say_digits</a>(peer, pu-&gt;parkingnum, <span class="stringliteral">""</span>, peer-&gt;language);
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (pu-&gt;notquiteyet) {
<a name="l00463"></a>00463       <span class="comment">/* Wake up parking thread if we're really done */</span>
<a name="l00464"></a>00464       <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(pu-&gt;chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>, 
<a name="l00465"></a>00465          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>, NULL),
<a name="l00466"></a>00466          !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) ? strlen(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) + 1 : 0);
<a name="l00467"></a>00467       pu-&gt;notquiteyet = 0;
<a name="l00468"></a>00468       pthread_kill(<a class="code" href="res__features_8c.html#a1b4c23e2029d94fb9090c489fdb6bcf">parking_thread</a>, SIGURG);
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470    <span class="keywordflow">return</span> 0;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a><a class="code" href="res__features_8c.html#ee0b2e279f201b712627832c04d5a1ae">00473</a> <span class="keywordtype">int</span> <a class="code" href="features_8h.html#b0191433f37b2a33e542c9e4f7ededf9">ast_masq_park_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *rchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *extout)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l00476"></a>00476    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478    <span class="comment">/* Make a new, fake channel that we'll use to masquerade in the real one */</span>
<a name="l00479"></a>00479    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, 0, 0, rchan-&gt;accountcode, rchan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, rchan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, rchan-&gt;<a class="code" href="structast__channel.html#d5aa4bb1461fe3d863bd95fb137e2284">amaflags</a>, <span class="stringliteral">"Parked/%s"</span>,rchan-&gt;name))) {
<a name="l00480"></a>00480       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create parked channel\n"</span>);
<a name="l00481"></a>00481       <span class="keywordflow">return</span> -1;
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="comment">/* Make formats okay */</span>
<a name="l00485"></a>00485    chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> = rchan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l00486"></a>00486    chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> = rchan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l00487"></a>00487    <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(chan, rchan);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489    <span class="comment">/* Setup the extensions and such */</span>
<a name="l00490"></a>00490    <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(chan, rchan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, rchan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, rchan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="comment">/* Make the masq execute */</span>
<a name="l00493"></a>00493    f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l00494"></a>00494    <span class="keywordflow">if</span> (f)
<a name="l00495"></a>00495       <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <a class="code" href="features_8h.html#c9d53b3e6972e1cb4fd0153b648e204a">ast_park_call</a>(chan, peer, timeout, extout);
<a name="l00498"></a>00498    <span class="keywordflow">return</span> 0;
<a name="l00499"></a>00499 }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="res__features_8c.html#3dbe53f4f45b27a99950a1c56c125a88">00502</a> <span class="preprocessor">#define FEATURE_RETURN_HANGUP    -1</span>
<a name="l00503"></a><a class="code" href="res__features_8c.html#5fe70eb28d6e9ad38f586fb34509facf">00503</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_SUCCESSBREAK  0</span>
<a name="l00504"></a><a class="code" href="res__features_8c.html#c2314b9d3cb58cee23bed252b6a857e1">00504</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_PBX_KEEPALIVE   AST_PBX_KEEPALIVE</span>
<a name="l00505"></a><a class="code" href="res__features_8c.html#8a10cef1de20ed931d0caa1d33ea452f">00505</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_NO_HANGUP_PEER  AST_PBX_NO_HANGUP_PEER</span>
<a name="l00506"></a><a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">00506</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_PASSDIGITS    21</span>
<a name="l00507"></a><a class="code" href="res__features_8c.html#6420cac24c738a5a0b17afe3eb84c9e1">00507</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_STOREDIGITS   22</span>
<a name="l00508"></a><a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">00508</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_RETURN_SUCCESS       23</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>
<a name="l00510"></a><a class="code" href="res__features_8c.html#bd2f1cd557108bff60f29245c9fd0b15">00510</a> <span class="preprocessor">#define FEATURE_SENSE_CHAN (1 &lt;&lt; 0)</span>
<a name="l00511"></a><a class="code" href="res__features_8c.html#34918b66feeac9340849ed1c5a1e105d">00511</a> <span class="preprocessor"></span><span class="preprocessor">#define FEATURE_SENSE_PEER (1 &lt;&lt; 1)</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00513"></a>00513 <span class="comment">/*! \brief</span>
<a name="l00514"></a>00514 <span class="comment"> * set caller and callee according to the direction</span>
<a name="l00515"></a>00515 <span class="comment"> */</span>
<a name="l00516"></a><a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">00516</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">set_peers</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **caller, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> **callee,
<a name="l00517"></a>00517    <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> sense)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519    <span class="keywordflow">if</span> (sense == <a class="code" href="res__features_8c.html#34918b66feeac9340849ed1c5a1e105d">FEATURE_SENSE_PEER</a>) {
<a name="l00520"></a>00520       *caller = peer;
<a name="l00521"></a>00521       *callee = chan;
<a name="l00522"></a>00522    } <span class="keywordflow">else</span> {
<a name="l00523"></a>00523       *callee = peer;
<a name="l00524"></a>00524       *caller = chan;
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 <span class="comment"></span>
<a name="l00528"></a>00528 <span class="comment">/*! \brief support routing for one touch call parking */</span>
<a name="l00529"></a><a class="code" href="res__features_8c.html#a7d290365a1ebd9e260c171cb720ac99">00529</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#a7d290365a1ebd9e260c171cb720ac99">builtin_parkcall</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *parker;
<a name="l00532"></a>00532         <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *parkee;
<a name="l00533"></a>00533    <span class="keywordtype">int</span> res = 0;
<a name="l00534"></a>00534    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536    u = <a class="code" href="module_8h.html#01229151b3816d7323f7460fef4305c3">ast_module_user_add</a>(chan);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">set_peers</a>(&amp;parker, &amp;parkee, peer, chan, sense);
<a name="l00539"></a>00539    <span class="comment">/* Setup the exten/priority to be s/1 since we don't know</span>
<a name="l00540"></a>00540 <span class="comment">      where this call should return */</span>
<a name="l00541"></a>00541    strcpy(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="stringliteral">"s"</span>);
<a name="l00542"></a>00542    chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = 1;
<a name="l00543"></a>00543    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l00544"></a>00544       res = <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan);
<a name="l00545"></a>00545    <span class="keywordflow">if</span> (!res)
<a name="l00546"></a>00546       res = <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(chan, 1000);
<a name="l00547"></a>00547    <span class="keywordflow">if</span> (!res)
<a name="l00548"></a>00548       res = <a class="code" href="features_8h.html#c9d53b3e6972e1cb4fd0153b648e204a">ast_park_call</a>(parkee, parker, 0, NULL);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552    <span class="keywordflow">if</span> (!res) {
<a name="l00553"></a>00553       <span class="keywordflow">if</span> (sense == <a class="code" href="res__features_8c.html#bd2f1cd557108bff60f29245c9fd0b15">FEATURE_SENSE_CHAN</a>)
<a name="l00554"></a>00554          res = <a class="code" href="pbx_8h.html#5e2459a77c1072ded5128a9c607a9e95">AST_PBX_NO_HANGUP_PEER</a>;
<a name="l00555"></a>00555       <span class="keywordflow">else</span>
<a name="l00556"></a>00556          res = <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a>;
<a name="l00557"></a>00557    }
<a name="l00558"></a>00558    <span class="keywordflow">return</span> res;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="res__features_8c.html#0cfda63da762909d5df7638341859a8b">00562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#0cfda63da762909d5df7638341859a8b">builtin_automonitor</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564    <span class="keywordtype">char</span> *caller_chan_id = NULL, *callee_chan_id = NULL, *args = NULL, *touch_filename = NULL;
<a name="l00565"></a>00565    <span class="keywordtype">int</span> x = 0;
<a name="l00566"></a>00566    size_t <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00567"></a>00567    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *caller_chan, *callee_chan;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569    <span class="keywordflow">if</span> (!<a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">monitor_ok</a>) {
<a name="l00570"></a>00570       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>,<span class="stringliteral">"Cannot record the call. The monitor application is disabled.\n"</span>);
<a name="l00571"></a>00571       <span class="keywordflow">return</span> -1;
<a name="l00572"></a>00572    }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (!monitor_app &amp;&amp; !(monitor_app = <a class="code" href="pbx_8c.html#d407cf204ec8fc50e5a578c8c17e0cb5">pbx_findapp</a>(<span class="stringliteral">"Monitor"</span>))) {
<a name="l00575"></a>00575       <a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">monitor_ok</a> = 0;
<a name="l00576"></a>00576       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>,<span class="stringliteral">"Cannot record the call. The monitor application is disabled.\n"</span>);
<a name="l00577"></a>00577       <span class="keywordflow">return</span> -1;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">set_peers</a>(&amp;caller_chan, &amp;callee_chan, peer, chan, sense);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>)) {
<a name="l00583"></a>00583       <span class="keywordflow">if</span> (<a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(callee_chan))
<a name="l00584"></a>00584          <span class="keywordflow">return</span> -1;
<a name="l00585"></a>00585       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(caller_chan, <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, <span class="stringliteral">""</span>)) {
<a name="l00586"></a>00586          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play courtesy tone!\n"</span>);
<a name="l00587"></a>00587          <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(callee_chan);
<a name="l00588"></a>00588          <span class="keywordflow">return</span> -1;
<a name="l00589"></a>00589       }
<a name="l00590"></a>00590       <span class="keywordflow">if</span> (<a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(callee_chan))
<a name="l00591"></a>00591          <span class="keywordflow">return</span> -1;
<a name="l00592"></a>00592    }
<a name="l00593"></a>00593    
<a name="l00594"></a>00594    <span class="keywordflow">if</span> (callee_chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00595"></a>00595       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 3)
<a name="l00596"></a>00596          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"User hit '%s' to stop recording call.\n"</span>, code);
<a name="l00597"></a>00597       <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>(callee_chan, 1);
<a name="l00598"></a>00598       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00599"></a>00599    }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601    <span class="keywordflow">if</span> (caller_chan &amp;&amp; callee_chan) {
<a name="l00602"></a>00602       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_format = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">"TOUCH_MONITOR_FORMAT"</span>);
<a name="l00603"></a>00603       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_monitor = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">"TOUCH_MONITOR"</span>);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605       <span class="keywordflow">if</span> (!touch_format)
<a name="l00606"></a>00606          touch_format = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">"TOUCH_MONITOR_FORMAT"</span>);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       <span class="keywordflow">if</span> (!touch_monitor)
<a name="l00609"></a>00609          touch_monitor = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">"TOUCH_MONITOR"</span>);
<a name="l00610"></a>00610    
<a name="l00611"></a>00611       <span class="keywordflow">if</span> (touch_monitor) {
<a name="l00612"></a>00612          len = strlen(touch_monitor) + 50;
<a name="l00613"></a>00613          args = alloca(len);
<a name="l00614"></a>00614          touch_filename = alloca(len);
<a name="l00615"></a>00615          snprintf(touch_filename, len, <span class="stringliteral">"auto-%ld-%s"</span>, (<span class="keywordtype">long</span>)time(NULL), touch_monitor);
<a name="l00616"></a>00616          snprintf(args, len, <span class="stringliteral">"%s|%s|m"</span>, (touch_format) ? touch_format : <span class="stringliteral">"wav"</span>, touch_filename);
<a name="l00617"></a>00617       } <span class="keywordflow">else</span> {
<a name="l00618"></a>00618          caller_chan_id = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(<a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(caller_chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, caller_chan-&gt;name));
<a name="l00619"></a>00619          callee_chan_id = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(<a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(callee_chan-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, callee_chan-&gt;name));
<a name="l00620"></a>00620          len = strlen(caller_chan_id) + strlen(callee_chan_id) + 50;
<a name="l00621"></a>00621          args = alloca(len);
<a name="l00622"></a>00622          touch_filename = alloca(len);
<a name="l00623"></a>00623          snprintf(touch_filename, len, <span class="stringliteral">"auto-%ld-%s-%s"</span>, (<span class="keywordtype">long</span>)time(NULL), caller_chan_id, callee_chan_id);
<a name="l00624"></a>00624          snprintf(args, len, <span class="stringliteral">"%s|%s|m"</span>, <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(touch_format, <span class="stringliteral">"wav"</span>), touch_filename);
<a name="l00625"></a>00625       }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627       <span class="keywordflow">for</span>(x = 0; x &lt; strlen(args); x++) {
<a name="l00628"></a>00628          <span class="keywordflow">if</span> (args[x] == <span class="charliteral">'/'</span>)
<a name="l00629"></a>00629             args[x] = <span class="charliteral">'-'</span>;
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631       
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 3)
<a name="l00633"></a>00633          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"User hit '%s' to record call. filename: %s\n"</span>, code, args);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635       <a class="code" href="pbx_8c.html#5970fbcb6a776848d11bf1c8ddb1c948">pbx_exec</a>(callee_chan, monitor_app, args);
<a name="l00636"></a>00636       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(callee_chan, <span class="stringliteral">"TOUCH_MONITOR_OUTPUT"</span>, touch_filename);
<a name="l00637"></a>00637       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(caller_chan, <span class="stringliteral">"TOUCH_MONITOR_OUTPUT"</span>, touch_filename);
<a name="l00638"></a>00638    
<a name="l00639"></a>00639       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00640"></a>00640    }
<a name="l00641"></a>00641    
<a name="l00642"></a>00642    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>,<span class="stringliteral">"Cannot record the call. One or both channels have gone away.\n"</span>);  
<a name="l00643"></a>00643    <span class="keywordflow">return</span> -1;
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="res__features_8c.html#c4c500279ce612f3a82ba1b03450953c">00646</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#c4c500279ce612f3a82ba1b03450953c">builtin_disconnect</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 3)
<a name="l00649"></a>00649       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"User hit '%s' to disconnect call.\n"</span>, code);
<a name="l00650"></a>00650    <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#3dbe53f4f45b27a99950a1c56c125a88">FEATURE_RETURN_HANGUP</a>;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">00653</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655         <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l00656"></a>00656   
<a name="l00657"></a>00657         <span class="keywordflow">return</span> <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(chan);
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 <span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">/*! \brief Find the context for the transfer */</span>
<a name="l00661"></a><a class="code" href="res__features_8c.html#ce7bff6cc370846ca0572763c7afbec5">00661</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#ce7bff6cc370846ca0572763c7afbec5">real_ctx</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *transferer, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *transferee)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a> = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(transferer, <span class="stringliteral">"TRANSFER_CONTEXT"</span>);
<a name="l00664"></a>00664         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(s))
<a name="l00665"></a>00665                 s = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(transferee, <span class="stringliteral">"TRANSFER_CONTEXT"</span>);
<a name="l00666"></a>00666         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(s)) <span class="comment">/* Use the non-macro context to transfer the call XXX ? */</span>
<a name="l00667"></a>00667                 s = transferer-&gt;<a class="code" href="structast__channel.html#d26b4f540a5723a140b9836f73cf62a4">macrocontext</a>;
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(s))
<a name="l00669"></a>00669                 s = transferer-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00670"></a>00670         <span class="keywordflow">return</span> s;  
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a><a class="code" href="res__features_8c.html#bf804a3ca23b09244a2a1dd792b5434a">00673</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#bf804a3ca23b09244a2a1dd792b5434a">builtin_blindtransfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *transferer;
<a name="l00676"></a>00676    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *transferee;
<a name="l00677"></a>00677    <span class="keyword">const</span> <span class="keywordtype">char</span> *transferer_real_context;
<a name="l00678"></a>00678    <span class="keywordtype">char</span> xferto[256];
<a name="l00679"></a>00679    <span class="keywordtype">int</span> res;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    <a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">set_peers</a>(&amp;transferer, &amp;transferee, peer, chan, sense);
<a name="l00682"></a>00682    transferer_real_context = <a class="code" href="res__features_8c.html#ce7bff6cc370846ca0572763c7afbec5">real_ctx</a>(transferer, transferee);
<a name="l00683"></a>00683    <span class="comment">/* Start autoservice on chan while we talk to the originator */</span>
<a name="l00684"></a>00684    <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(transferee);
<a name="l00685"></a>00685    <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687    memset(xferto, 0, <span class="keyword">sizeof</span>(xferto));
<a name="l00688"></a>00688    
<a name="l00689"></a>00689    <span class="comment">/* Transfer */</span>
<a name="l00690"></a>00690    res = <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <span class="stringliteral">"pbx-transfer"</span>, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>);
<a name="l00691"></a>00691    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00692"></a>00692       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00693"></a>00693       <span class="keywordflow">return</span> -1; <span class="comment">/* error ? */</span>
<a name="l00694"></a>00694    }
<a name="l00695"></a>00695    <span class="keywordflow">if</span> (res &gt; 0)   <span class="comment">/* If they've typed a digit already, handle it */</span>
<a name="l00696"></a>00696       xferto[0] = (char) res;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698    <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(transferer);
<a name="l00699"></a>00699    res = <a class="code" href="app_8c.html#476d62feae06d775217ae80e79eca38e">ast_app_dtget</a>(transferer, transferer_real_context, xferto, <span class="keyword">sizeof</span>(xferto), 100, <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a>);
<a name="l00700"></a>00700    <span class="keywordflow">if</span> (res &lt; 0) {  <span class="comment">/* hangup, would be 0 for invalid and 1 for valid */</span>
<a name="l00701"></a>00701       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00702"></a>00702       <span class="keywordflow">return</span> res;
<a name="l00703"></a>00703    }
<a name="l00704"></a>00704    <span class="keywordflow">if</span> (!strcmp(xferto, <a class="code" href="features_8h.html#592f5491321993926462dffa87ba0bab">ast_parking_ext</a>())) {
<a name="l00705"></a>00705       res = <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00706"></a>00706       <span class="keywordflow">if</span> (res)
<a name="l00707"></a>00707          res = -1;
<a name="l00708"></a>00708       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="features_8h.html#c9d53b3e6972e1cb4fd0153b648e204a">ast_park_call</a>(transferee, transferer, 0, NULL)) { <span class="comment">/* success */</span>
<a name="l00709"></a>00709          <span class="comment">/* We return non-zero, but tell the PBX not to hang the channel when</span>
<a name="l00710"></a>00710 <span class="comment">            the thread dies -- We have to be careful now though.  We are responsible for </span>
<a name="l00711"></a>00711 <span class="comment">            hanging up the channel, else it will never be hung up! */</span>
<a name="l00712"></a>00712 
<a name="l00713"></a>00713          <span class="keywordflow">return</span> (transferer == peer) ? <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a> : <a class="code" href="pbx_8h.html#5e2459a77c1072ded5128a9c607a9e95">AST_PBX_NO_HANGUP_PEER</a>;
<a name="l00714"></a>00714       } <span class="keywordflow">else</span> {
<a name="l00715"></a>00715          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to park call %s\n"</span>, transferee-&gt;name);
<a name="l00716"></a>00716       }<span class="comment"></span>
<a name="l00717"></a>00717 <span class="comment">      /*! \todo XXX Maybe we should have another message here instead of invalid extension XXX */</span>
<a name="l00718"></a>00718    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(transferee, transferer_real_context, xferto, 1, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)) {
<a name="l00719"></a>00719       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(peer, <span class="stringliteral">"BLINDTRANSFER"</span>, transferee-&gt;name);
<a name="l00720"></a>00720       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BLINDTRANSFER"</span>, peer-&gt;name);
<a name="l00721"></a>00721       res=<a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00722"></a>00722       <span class="keywordflow">if</span> (!transferer-&gt;cdr) {
<a name="l00723"></a>00723          transferer-&gt;cdr=<a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l00724"></a>00724          <span class="keywordflow">if</span> (transferer) {
<a name="l00725"></a>00725             <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(transferer-&gt;cdr, transferer); <span class="comment">/* initilize our channel's cdr */</span>
<a name="l00726"></a>00726             <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(transferer-&gt;cdr);
<a name="l00727"></a>00727          }
<a name="l00728"></a>00728       }
<a name="l00729"></a>00729       <span class="keywordflow">if</span> (transferer-&gt;cdr) {
<a name="l00730"></a>00730          <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(transferer-&gt;cdr, transferee-&gt;name);
<a name="l00731"></a>00731          <a class="code" href="cdr_8c.html#018b6c8a00209b6cf1fd7386b493f930">ast_cdr_setapp</a>(transferer-&gt;cdr, <span class="stringliteral">"BLINDTRANSFER"</span>,<span class="stringliteral">""</span>);
<a name="l00732"></a>00732       }
<a name="l00733"></a>00733       <span class="keywordflow">if</span> (!transferee-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a>) {
<a name="l00734"></a>00734          <span class="comment">/* Doh!  Use our handy async_goto functions */</span>
<a name="l00735"></a>00735          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l00736"></a>00736             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Transferring %s to '%s' (context %s) priority 1\n"</span>
<a name="l00737"></a>00737                         ,transferee-&gt;name, xferto, transferer_real_context);
<a name="l00738"></a>00738          <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#563b92a651459898f8ccfdc367746147">ast_async_goto</a>(transferee, transferer_real_context, xferto, 1))
<a name="l00739"></a>00739             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Async goto failed :-(\n"</span>);
<a name="l00740"></a>00740          res = -1;
<a name="l00741"></a>00741       } <span class="keywordflow">else</span> {
<a name="l00742"></a>00742          <span class="comment">/* Set the channel's new extension, since it exists, using transferer context */</span>
<a name="l00743"></a>00743          <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(transferee, transferer_real_context, xferto, 0);
<a name="l00744"></a>00744       }
<a name="l00745"></a>00745       <a class="code" href="res__features_8c.html#e31296f1ba1e1918bd7f86ec2f9d7c63">check_goto_on_transfer</a>(transferer);
<a name="l00746"></a>00746       <span class="keywordflow">return</span> res;
<a name="l00747"></a>00747    } <span class="keywordflow">else</span> {
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l00749"></a>00749          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Unable to find extension '%s' in context '%s'\n"</span>, xferto, transferer_real_context);
<a name="l00750"></a>00750    }
<a name="l00751"></a>00751    <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>) &lt; 0) {
<a name="l00752"></a>00752       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00753"></a>00753       <span class="keywordflow">return</span> -1;
<a name="l00754"></a>00754    }
<a name="l00755"></a>00755    <a class="code" href="file_8c.html#460c61941bbb0132a2513ec9d5529e0c">ast_stopstream</a>(transferer);
<a name="l00756"></a>00756    res = <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00757"></a>00757    <span class="keywordflow">if</span> (res) {
<a name="l00758"></a>00758       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1)
<a name="l00759"></a>00759          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Hungup during autoservice stop on '%s'\n"</span>, transferee-&gt;name);
<a name="l00760"></a>00760       <span class="keywordflow">return</span> res;
<a name="l00761"></a>00761    }
<a name="l00762"></a>00762    <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a><a class="code" href="res__features_8c.html#8013c6b54961bc66bcfae0b61c7c6390">00765</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#8013c6b54961bc66bcfae0b61c7c6390">check_compat</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *newchan)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(c, newchan) &lt; 0) {
<a name="l00768"></a>00768       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Had to drop call because I couldn't make %s compatible with %s\n"</span>,
<a name="l00769"></a>00769          c-&gt;name, newchan-&gt;name);
<a name="l00770"></a>00770       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00771"></a>00771       <span class="keywordflow">return</span> -1;
<a name="l00772"></a>00772    }
<a name="l00773"></a>00773    <span class="keywordflow">return</span> 0;
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="res__features_8c.html#139a28567b7a4b64cdcd054240ef7ece">00776</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#139a28567b7a4b64cdcd054240ef7ece">builtin_atxfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *transferer;
<a name="l00779"></a>00779    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *transferee;
<a name="l00780"></a>00780    <span class="keyword">const</span> <span class="keywordtype">char</span> *transferer_real_context;
<a name="l00781"></a>00781    <span class="keywordtype">char</span> xferto[256] = <span class="stringliteral">""</span>;
<a name="l00782"></a>00782    <span class="keywordtype">char</span> callbackto[256] = <span class="stringliteral">""</span>;
<a name="l00783"></a>00783    <span class="keywordtype">int</span> res;
<a name="l00784"></a>00784    <span class="keywordtype">int</span> outstate=0;
<a name="l00785"></a>00785    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *newchan;
<a name="l00786"></a>00786    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *xferchan;
<a name="l00787"></a>00787    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj;
<a name="l00788"></a>00788    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html">ast_bridge_config</a> bconfig;
<a name="l00789"></a>00789    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00790"></a>00790    <span class="keywordtype">int</span> l;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00793"></a>00793       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Executing Attended Transfer %s, %s (sense=%d) \n"</span>, chan-&gt;name, peer-&gt;name, sense);
<a name="l00794"></a>00794    <a class="code" href="res__features_8c.html#5be71d22f873509755fe04540acb7d1a">set_peers</a>(&amp;transferer, &amp;transferee, peer, chan, sense);
<a name="l00795"></a>00795         transferer_real_context = <a class="code" href="res__features_8c.html#ce7bff6cc370846ca0572763c7afbec5">real_ctx</a>(transferer, transferee);
<a name="l00796"></a>00796    <span class="comment">/* Start autoservice on chan while we talk to the originator */</span>
<a name="l00797"></a>00797    <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(transferee);
<a name="l00798"></a>00798    <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>);
<a name="l00799"></a>00799    
<a name="l00800"></a>00800    <span class="comment">/* Transfer */</span>
<a name="l00801"></a>00801    res = <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <span class="stringliteral">"pbx-transfer"</span>, <a class="code" href="file_8h.html#4da2b9e8d896d755e4003168efa23b45">AST_DIGIT_ANY</a>);
<a name="l00802"></a>00802    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00803"></a>00803       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00804"></a>00804       <span class="keywordflow">return</span> res;
<a name="l00805"></a>00805    }
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (res &gt; 0) <span class="comment">/* If they've typed a digit already, handle it */</span>
<a name="l00807"></a>00807       xferto[0] = (char) res;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809    <span class="comment">/* this is specific of atxfer */</span>
<a name="l00810"></a>00810    res = <a class="code" href="app_8c.html#476d62feae06d775217ae80e79eca38e">ast_app_dtget</a>(transferer, transferer_real_context, xferto, <span class="keyword">sizeof</span>(xferto), 100, <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a>);
<a name="l00811"></a>00811         <span class="keywordflow">if</span> (res &lt; 0) {  <span class="comment">/* hangup, would be 0 for invalid and 1 for valid */</span>
<a name="l00812"></a>00812                 <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00813"></a>00813                 <span class="keywordflow">return</span> res;
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815    <span class="keywordflow">if</span> (res == 0) {
<a name="l00816"></a>00816       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Did not read data.\n"</span>);
<a name="l00817"></a>00817       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00818"></a>00818       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <span class="stringliteral">"beeperr"</span>, <span class="stringliteral">""</span>))
<a name="l00819"></a>00819          <span class="keywordflow">return</span> -1;
<a name="l00820"></a>00820       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00821"></a>00821    }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823    <span class="comment">/* valid extension, res == 1 */</span>
<a name="l00824"></a>00824    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(transferer, transferer_real_context, xferto, 1, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>)) {
<a name="l00825"></a>00825       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Extension %s does not exist in context %s\n"</span>,xferto,transferer_real_context);
<a name="l00826"></a>00826       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00827"></a>00827       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <span class="stringliteral">"beeperr"</span>, <span class="stringliteral">""</span>))
<a name="l00828"></a>00828          <span class="keywordflow">return</span> -1;
<a name="l00829"></a>00829       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00830"></a>00830    }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832    l = strlen(xferto);
<a name="l00833"></a>00833    snprintf(xferto + l, <span class="keyword">sizeof</span>(xferto) - l, <span class="stringliteral">"@%s/n"</span>, transferer_real_context);   <span class="comment">/* append context */</span>
<a name="l00834"></a>00834    newchan = <a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(transferer, transferee, <span class="stringliteral">"Local"</span>, <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(transferer-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>),
<a name="l00835"></a>00835       xferto, <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>, &amp;outstate, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, 1);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(transferer)) {
<a name="l00838"></a>00838       <span class="comment">/* Transferer is up - old behaviour */</span>
<a name="l00839"></a>00839       <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferer, -1);
<a name="l00840"></a>00840       <span class="keywordflow">if</span> (!newchan) {
<a name="l00841"></a>00841          <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00842"></a>00842          <span class="comment">/* any reason besides user requested cancel and busy triggers the failed sound */</span>
<a name="l00843"></a>00843          <span class="keywordflow">if</span> (outstate != <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a> &amp;&amp; outstate != <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a> &amp;&amp;
<a name="l00844"></a>00844             <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>, <span class="stringliteral">""</span>))
<a name="l00845"></a>00845             <span class="keywordflow">return</span> -1;
<a name="l00846"></a>00846          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, <span class="stringliteral">""</span>))
<a name="l00847"></a>00847             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play transfer sound!\n"</span>);
<a name="l00848"></a>00848          <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00849"></a>00849       }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#8013c6b54961bc66bcfae0b61c7c6390">check_compat</a>(transferer, newchan))
<a name="l00852"></a>00852          <span class="keywordflow">return</span> -1;
<a name="l00853"></a>00853       memset(&amp;bconfig,0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a>));
<a name="l00854"></a>00854       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(bconfig.<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04e55f4f77a24039b6ade9954efba0493">AST_FEATURE_DISCONNECT</a>);
<a name="l00855"></a>00855       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(bconfig.<a class="code" href="structast__bridge__config.html#fa6efc124166cce0351265506b27ec86">features_callee</a>), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04e55f4f77a24039b6ade9954efba0493">AST_FEATURE_DISCONNECT</a>);
<a name="l00856"></a>00856       res = <a class="code" href="features_8h.html#61263ca8af831dbacdf11ec96ed61076">ast_bridge_call</a>(transferer, newchan, &amp;bconfig);
<a name="l00857"></a>00857       <span class="keywordflow">if</span> (newchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> || !transferer-&gt;_softhangup) {
<a name="l00858"></a>00858          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00859"></a>00859          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferer, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, <span class="stringliteral">""</span>))
<a name="l00860"></a>00860             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play transfer sound!\n"</span>);
<a name="l00861"></a>00861          <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l00862"></a>00862          transferer-&gt;_softhangup = 0;
<a name="l00863"></a>00863          <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00864"></a>00864       }
<a name="l00865"></a>00865       <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#8013c6b54961bc66bcfae0b61c7c6390">check_compat</a>(transferee, newchan))
<a name="l00866"></a>00866          <span class="keywordflow">return</span> -1;
<a name="l00867"></a>00867       <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869       <span class="keywordflow">if</span> ((<a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(transferee) &lt; 0)
<a name="l00870"></a>00870        || (<a class="code" href="channel_8c.html#b02063e7425e3cfb63ba24edf8081835">ast_waitfordigit</a>(transferee, 100) &lt; 0)
<a name="l00871"></a>00871        || (<a class="code" href="channel_8c.html#b02063e7425e3cfb63ba24edf8081835">ast_waitfordigit</a>(newchan, 100) &lt; 0)
<a name="l00872"></a>00872        || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(transferee)
<a name="l00873"></a>00873        || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(newchan)) {
<a name="l00874"></a>00874          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00875"></a>00875          <span class="keywordflow">return</span> -1;
<a name="l00876"></a>00876       }
<a name="l00877"></a>00877       xferchan = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, 0, <span class="stringliteral">"Transfered/%s"</span>, transferee-&gt;name);
<a name="l00878"></a>00878       <span class="keywordflow">if</span> (!xferchan) {
<a name="l00879"></a>00879          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00880"></a>00880          <span class="keywordflow">return</span> -1;
<a name="l00881"></a>00881       }
<a name="l00882"></a>00882       <span class="comment">/* Make formats okay */</span>
<a name="l00883"></a>00883       xferchan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l00884"></a>00884       xferchan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l00885"></a>00885       <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(xferchan, transferee);
<a name="l00886"></a>00886       <a class="code" href="pbx_8c.html#1e0079c7f2934dd7ebe801fefe4057da">ast_explicit_goto</a>(xferchan, transferee-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, transferee-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, transferee-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>);
<a name="l00887"></a>00887       xferchan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>;
<a name="l00888"></a>00888       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);
<a name="l00889"></a>00889       xferchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l00890"></a>00890       <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(xferchan)))
<a name="l00891"></a>00891          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00892"></a>00892       newchan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>;
<a name="l00893"></a>00893       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(newchan, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);
<a name="l00894"></a>00894       newchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l00895"></a>00895       <span class="keywordflow">if</span> (!(tobj = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l00896"></a>00896          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(xferchan);
<a name="l00897"></a>00897          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00898"></a>00898          <span class="keywordflow">return</span> -1;
<a name="l00899"></a>00899       }
<a name="l00900"></a>00900       tobj-&gt;chan = xferchan;
<a name="l00901"></a>00901       tobj-&gt;peer = newchan;
<a name="l00902"></a>00902       tobj-&gt;bconfig = *config;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(newchan, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, <span class="stringliteral">""</span>))
<a name="l00905"></a>00905          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play transfer sound!\n"</span>);
<a name="l00906"></a>00906       <a class="code" href="res__features_8c.html#154203f487a3163df7709494f6c89372">ast_bridge_call_thread_launch</a>(tobj);
<a name="l00907"></a>00907       <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX meaning the channel is bridged ? */</span>
<a name="l00908"></a>00908    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(transferee)) {
<a name="l00909"></a>00909       <span class="comment">/* act as blind transfer */</span>
<a name="l00910"></a>00910       <span class="keywordflow">if</span> (<a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(transferee) &lt; 0) {
<a name="l00911"></a>00911          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00912"></a>00912          <span class="keywordflow">return</span> -1;
<a name="l00913"></a>00913       }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915       <span class="keywordflow">if</span> (!newchan) {
<a name="l00916"></a>00916          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tries = 0;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918          <span class="comment">/* newchan wasn't created - we should callback to transferer */</span>
<a name="l00919"></a>00919          <span class="keywordflow">if</span> (!<a class="code" href="pbx_8c.html#90b58be34145fcfd99652f0c3ae7377d">ast_exists_extension</a>(transferer, transferer_real_context, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, 1, transferee-&gt;cid.cid_num)) {
<a name="l00920"></a>00920             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Extension %s does not exist in context %s - callback failed\n"</span>,transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>,transferer_real_context);
<a name="l00921"></a>00921             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(transferee, <span class="stringliteral">"beeperr"</span>, <span class="stringliteral">""</span>))
<a name="l00922"></a>00922                <span class="keywordflow">return</span> -1;
<a name="l00923"></a>00923             <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;
<a name="l00924"></a>00924          }
<a name="l00925"></a>00925          snprintf(callbackto, <span class="keyword">sizeof</span>(callbackto), <span class="stringliteral">"%s@%s/n"</span>, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, transferer_real_context);  <span class="comment">/* append context */</span>
<a name="l00926"></a>00926 
<a name="l00927"></a>00927          newchan = <a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(transferee, NULL, <span class="stringliteral">"Local"</span>, <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(transferee-&gt;nativeformats),
<a name="l00928"></a>00928             callbackto, <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>, &amp;outstate, transferee-&gt;cid.cid_num, transferee-&gt;cid.cid_name, 0);
<a name="l00929"></a>00929          <span class="keywordflow">while</span> (!newchan &amp;&amp; !<a class="code" href="res__features_8c.html#3dfbecf9aa153bd233694a1c60f2161b">atxferdropcall</a> &amp;&amp; tries &lt; <a class="code" href="res__features_8c.html#b912136f198ae4b8d6737fff37c17309">atxfercallbackretries</a>) {
<a name="l00930"></a>00930             <span class="comment">/* Trying to transfer again */</span>
<a name="l00931"></a>00931             <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(transferee);
<a name="l00932"></a>00932             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934             newchan = <a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(transferer, transferee, <span class="stringliteral">"Local"</span>, <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(transferer-&gt;<a class="code" href="structast__channel.html#adbc0bbfec600539582f92b30ed1ecd7">nativeformats</a>),
<a name="l00935"></a>00935             xferto, <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>, &amp;outstate, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, transferer-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, 1);
<a name="l00936"></a>00936             <span class="keywordflow">if</span> (<a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(transferee) &lt; 0) {
<a name="l00937"></a>00937                <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00938"></a>00938                <span class="keywordflow">return</span> -1;
<a name="l00939"></a>00939             }
<a name="l00940"></a>00940             <span class="keywordflow">if</span> (!newchan) {
<a name="l00941"></a>00941                <span class="comment">/* Transfer failed, sleeping */</span>
<a name="l00942"></a>00942                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00943"></a>00943                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Sleeping for %d ms before callback.\n"</span>, <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a>);
<a name="l00944"></a>00944                <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(transferee, <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a>);
<a name="l00945"></a>00945                <span class="keywordflow">if</span> (option_debug)
<a name="l00946"></a>00946                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"Trying to callback...\n"</span>);
<a name="l00947"></a>00947                newchan = <a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(transferee, NULL, <span class="stringliteral">"Local"</span>, <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(transferee-&gt;nativeformats),
<a name="l00948"></a>00948                   callbackto, <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>, &amp;outstate, transferee-&gt;cid.cid_num, transferee-&gt;cid.cid_name, 0);
<a name="l00949"></a>00949             }
<a name="l00950"></a>00950             tries++;
<a name="l00951"></a>00951          }
<a name="l00952"></a>00952       }
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (!newchan)
<a name="l00954"></a>00954          <span class="keywordflow">return</span> -1;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956       <span class="comment">/* newchan is up, we should prepare transferee and bridge them */</span>
<a name="l00957"></a>00957       <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#8013c6b54961bc66bcfae0b61c7c6390">check_compat</a>(transferee, newchan))
<a name="l00958"></a>00958          <span class="keywordflow">return</span> -1;
<a name="l00959"></a>00959       <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961       <span class="keywordflow">if</span> ((<a class="code" href="channel_8c.html#b02063e7425e3cfb63ba24edf8081835">ast_waitfordigit</a>(transferee, 100) &lt; 0)
<a name="l00962"></a>00962          || (<a class="code" href="channel_8c.html#b02063e7425e3cfb63ba24edf8081835">ast_waitfordigit</a>(newchan, 100) &lt; 0)
<a name="l00963"></a>00963          || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(transferee)
<a name="l00964"></a>00964          || <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(newchan)) {
<a name="l00965"></a>00965          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00966"></a>00966          <span class="keywordflow">return</span> -1;
<a name="l00967"></a>00967       }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969       xferchan = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, 0, <span class="stringliteral">"Transfered/%s"</span>, transferee-&gt;name);
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (!xferchan) {
<a name="l00971"></a>00971          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00972"></a>00972          <span class="keywordflow">return</span> -1;
<a name="l00973"></a>00973       }
<a name="l00974"></a>00974       <span class="comment">/* Make formats okay */</span>
<a name="l00975"></a>00975       xferchan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> = transferee-&gt;readformat;
<a name="l00976"></a>00976       xferchan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> = transferee-&gt;writeformat;
<a name="l00977"></a>00977       <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(xferchan, transferee);
<a name="l00978"></a>00978       <a class="code" href="pbx_8c.html#1e0079c7f2934dd7ebe801fefe4057da">ast_explicit_goto</a>(xferchan, transferee-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, transferee-&gt;exten, transferee-&gt;priority);
<a name="l00979"></a>00979       xferchan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>;
<a name="l00980"></a>00980       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);
<a name="l00981"></a>00981       xferchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l00982"></a>00982       <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(xferchan)))
<a name="l00983"></a>00983          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l00984"></a>00984       newchan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> = <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>;
<a name="l00985"></a>00985       <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(newchan, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);
<a name="l00986"></a>00986       newchan-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> = 0;
<a name="l00987"></a>00987       <span class="keywordflow">if</span> (!(tobj = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l00988"></a>00988          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(xferchan);
<a name="l00989"></a>00989          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(newchan);
<a name="l00990"></a>00990          <span class="keywordflow">return</span> -1;
<a name="l00991"></a>00991       }
<a name="l00992"></a>00992       tobj-&gt;chan = xferchan;
<a name="l00993"></a>00993       tobj-&gt;peer = newchan;
<a name="l00994"></a>00994       tobj-&gt;bconfig = *config;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(newchan, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, <span class="stringliteral">""</span>))
<a name="l00997"></a>00997          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play transfer sound!\n"</span>);
<a name="l00998"></a>00998       <a class="code" href="res__features_8c.html#154203f487a3163df7709494f6c89372">ast_bridge_call_thread_launch</a>(tobj);
<a name="l00999"></a>00999       <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX meaning the channel is bridged ? */</span>
<a name="l01000"></a>01000    } <span class="keywordflow">else</span> {
<a name="l01001"></a>01001       <span class="comment">/* Transferee hung up */</span>
<a name="l01002"></a>01002       <a class="code" href="res__features_8c.html#8bc3aecc8e57b4b5bdeb0ab0bb36f8d7">finishup</a>(transferee);
<a name="l01003"></a>01003       <span class="keywordflow">return</span> -1;
<a name="l01004"></a>01004    }
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 <span class="comment">/* add atxfer and automon as undefined so you can only use em if you configure them */</span>
<a name="l01008"></a><a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">01008</a> <span class="preprocessor">#define FEATURES_COUNT ARRAY_LEN(builtin_features)</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>
<a name="l01010"></a>01010 <a class="code" href="lock_8h.html#0a6f04cdf7f74e689a454716e55cb473">AST_RWLOCK_DEFINE_STATIC</a>(features_lock);
<a name="l01011"></a>01011 
<a name="l01012"></a><a class="code" href="res__features_8c.html#db954913384557d27f3c7d47c35d3508">01012</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> builtin_features[] = 
<a name="l01013"></a>01013  {
<a name="l01014"></a>01014    { <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>, <span class="stringliteral">"Blind Transfer"</span>, <span class="stringliteral">"blindxfer"</span>, <span class="stringliteral">"#"</span>, <span class="stringliteral">"#"</span>, <a class="code" href="res__features_8c.html#bf804a3ca23b09244a2a1dd792b5434a">builtin_blindtransfer</a>, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>, <span class="stringliteral">""</span> },
<a name="l01015"></a>01015    { <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>, <span class="stringliteral">"Attended Transfer"</span>, <span class="stringliteral">"atxfer"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <a class="code" href="res__features_8c.html#139a28567b7a4b64cdcd054240ef7ece">builtin_atxfer</a>, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>, <span class="stringliteral">""</span> },
<a name="l01016"></a>01016    { <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d0f9a5c8452526c77703890c2cb6784eb6">AST_FEATURE_AUTOMON</a>, <span class="stringliteral">"One Touch Monitor"</span>, <span class="stringliteral">"automon"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <a class="code" href="res__features_8c.html#0cfda63da762909d5df7638341859a8b">builtin_automonitor</a>, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>, <span class="stringliteral">""</span> },
<a name="l01017"></a>01017    { <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04e55f4f77a24039b6ade9954efba0493">AST_FEATURE_DISCONNECT</a>, <span class="stringliteral">"Disconnect Call"</span>, <span class="stringliteral">"disconnect"</span>, <span class="stringliteral">"*"</span>, <span class="stringliteral">"*"</span>, <a class="code" href="res__features_8c.html#c4c500279ce612f3a82ba1b03450953c">builtin_disconnect</a>, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>, <span class="stringliteral">""</span> },
<a name="l01018"></a>01018    { <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d0bc5c3869d149426e287f8f773f8d3f38">AST_FEATURE_PARKCALL</a>, <span class="stringliteral">"Park Call"</span>, <span class="stringliteral">"parkcall"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">""</span>, <a class="code" href="res__features_8c.html#a7d290365a1ebd9e260c171cb720ac99">builtin_parkcall</a>, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>, <span class="stringliteral">""</span> },
<a name="l01019"></a>01019 };
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 
<a name="l01022"></a>01022 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(feature_list,<a class="code" href="structast__call__feature.html">ast_call_feature</a>);
<a name="l01023"></a>01023 <span class="comment"></span>
<a name="l01024"></a>01024 <span class="comment">/*! \brief register new feature into feature_list*/</span>
<a name="l01025"></a><a class="code" href="res__features_8c.html#f3669c57747d1ce65a0c6589e03386c0">01025</a> <span class="keywordtype">void</span> <a class="code" href="features_8h.html#f3669c57747d1ce65a0c6589e03386c0">ast_register_feature</a>(<span class="keyword">struct</span> <a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature)
<a name="l01026"></a>01026 {
<a name="l01027"></a>01027    <span class="keywordflow">if</span> (!feature) {
<a name="l01028"></a>01028       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>,<span class="stringliteral">"You didn't pass a feature!\n"</span>);
<a name="l01029"></a>01029          <span class="keywordflow">return</span>;
<a name="l01030"></a>01030    }
<a name="l01031"></a>01031   
<a name="l01032"></a>01032    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l01033"></a>01033    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;feature_list,feature,feature_entry);
<a name="l01034"></a>01034    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01035"></a>01035 
<a name="l01036"></a>01036    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt;= 2) 
<a name="l01037"></a>01037       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Registered Feature '%s'\n"</span>,feature-&gt;<a class="code" href="structast__call__feature.html#d16edd3fe2bbc564136da7d1e79586df">sname</a>);
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 <span class="comment"></span>
<a name="l01040"></a>01040 <span class="comment">/*! \brief unregister feature from feature_list */</span>
<a name="l01041"></a><a class="code" href="res__features_8c.html#3a56dc06bcdf3fe4cba843356ef33b50">01041</a> <span class="keywordtype">void</span> <a class="code" href="features_8h.html#3a56dc06bcdf3fe4cba843356ef33b50">ast_unregister_feature</a>(<span class="keyword">struct</span> <a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature)
<a name="l01042"></a>01042 {
<a name="l01043"></a>01043    <span class="keywordflow">if</span> (!feature)
<a name="l01044"></a>01044       <span class="keywordflow">return</span>;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l01047"></a>01047    <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;feature_list,feature,feature_entry);
<a name="l01048"></a>01048    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01049"></a>01049    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(feature);
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 <span class="comment"></span>
<a name="l01052"></a>01052 <span class="comment">/*! \brief Remove all features in the list */</span>
<a name="l01053"></a><a class="code" href="res__features_8c.html#1aebc3ae7af33b2493efe057cf5f9f09">01053</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#1aebc3ae7af33b2493efe057cf5f9f09">ast_unregister_features</a>(<span class="keywordtype">void</span>)
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l01056"></a>01056 
<a name="l01057"></a>01057    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l01058"></a>01058    <span class="keywordflow">while</span> ((feature = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;feature_list,feature_entry)))
<a name="l01059"></a>01059       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(feature);
<a name="l01060"></a>01060    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 <span class="comment"></span>
<a name="l01063"></a>01063 <span class="comment">/*! \brief find a call feature by name */</span>
<a name="l01064"></a><a class="code" href="res__features_8c.html#80dac60ab696b3c164c0c9f53595eab5">01064</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *<a class="code" href="res__features_8c.html#80dac60ab696b3c164c0c9f53595eab5">find_dynamic_feature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l01065"></a>01065 {
<a name="l01066"></a>01066    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *tmp;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;feature_list, tmp, feature_entry) {
<a name="l01069"></a>01069       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__call__feature.html#d16edd3fe2bbc564136da7d1e79586df">sname</a>, name))
<a name="l01070"></a>01070          <span class="keywordflow">break</span>;
<a name="l01071"></a>01071    }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073    <span class="keywordflow">return</span> tmp;
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01076"></a><a class="code" href="res__features_8c.html#eda7b3ca1113877d673e72fdfe2b1649">01076</a> <span class="keywordtype">void</span> <a class="code" href="features_8h.html#eda7b3ca1113877d673e72fdfe2b1649">ast_rdlock_call_features</a>(<span class="keywordtype">void</span>)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;features_lock);
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 
<a name="l01081"></a><a class="code" href="res__features_8c.html#4dd763461ee81e87a7924033c30123bb">01081</a> <span class="keywordtype">void</span> <a class="code" href="features_8h.html#4dd763461ee81e87a7924033c30123bb">ast_unlock_call_features</a>(<span class="keywordtype">void</span>)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01084"></a>01084 }
<a name="l01085"></a>01085 <span class="comment"></span>
<a name="l01086"></a>01086 <span class="comment">/*! \brief find a call feature by name */</span>
<a name="l01087"></a><a class="code" href="res__features_8c.html#bce7613c9a8c4b637a579aa8aefba2f4">01087</a> <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *<a class="code" href="features_8h.html#bce7613c9a8c4b637a579aa8aefba2f4">ast_find_call_feature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089    <span class="keywordtype">int</span> x;
<a name="l01090"></a>01090    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++) {
<a name="l01091"></a>01091       <span class="keywordflow">if</span> (!strcasecmp(name, builtin_features[x].<a class="code" href="structast__call__feature.html#d16edd3fe2bbc564136da7d1e79586df">sname</a>))
<a name="l01092"></a>01092          <span class="keywordflow">return</span> &amp;builtin_features[x];
<a name="l01093"></a>01093    }
<a name="l01094"></a>01094    <span class="keywordflow">return</span> NULL;
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 <span class="comment"></span>
<a name="l01097"></a>01097 <span class="comment">/*! \brief exec an app by feature */</span>
<a name="l01098"></a><a class="code" href="res__features_8c.html#e84b0ba9bed83da8caaa0c3ee75dde98">01098</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#e84b0ba9bed83da8caaa0c3ee75dde98">feature_exec_app</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l01099"></a>01099 {
<a name="l01100"></a>01100    <span class="keyword">struct </span><a class="code" href="structast__app.html">ast_app</a> *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>;
<a name="l01101"></a>01101    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l01102"></a>01102    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *work, *idle;
<a name="l01103"></a>01103    <span class="keywordtype">int</span> res;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l01106"></a>01106    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;feature_list, feature, feature_entry) {
<a name="l01107"></a>01107       <span class="keywordflow">if</span> (!strcasecmp(feature-&gt;<a class="code" href="structast__call__feature.html#c4e1c560a6e8d177b293258ab07bf352">exten</a>, code))
<a name="l01108"></a>01108          <span class="keywordflow">break</span>;
<a name="l01109"></a>01109    }
<a name="l01110"></a>01110    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112    <span class="keywordflow">if</span> (!feature) { <span class="comment">/* shouldn't ever happen! */</span>
<a name="l01113"></a>01113       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Found feature before, but at execing we've lost it??\n"</span>);
<a name="l01114"></a>01114       <span class="keywordflow">return</span> -1; 
<a name="l01115"></a>01115    }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117    <span class="keywordflow">if</span> (sense == <a class="code" href="res__features_8c.html#bd2f1cd557108bff60f29245c9fd0b15">FEATURE_SENSE_CHAN</a>) {
<a name="l01118"></a>01118       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>))
<a name="l01119"></a>01119          <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">FEATURE_RETURN_PASSDIGITS</a>;
<a name="l01120"></a>01120       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efbfdc26da820d520cf35171586fb5b81a">AST_FEATURE_FLAG_ONSELF</a>)) {
<a name="l01121"></a>01121          work = chan;
<a name="l01122"></a>01122          idle = peer;
<a name="l01123"></a>01123       } <span class="keywordflow">else</span> {
<a name="l01124"></a>01124          work = peer;
<a name="l01125"></a>01125          idle = chan;
<a name="l01126"></a>01126       }
<a name="l01127"></a>01127    } <span class="keywordflow">else</span> {
<a name="l01128"></a>01128       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>))
<a name="l01129"></a>01129          <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">FEATURE_RETURN_PASSDIGITS</a>;
<a name="l01130"></a>01130       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efbfdc26da820d520cf35171586fb5b81a">AST_FEATURE_FLAG_ONSELF</a>)) {
<a name="l01131"></a>01131          work = peer;
<a name="l01132"></a>01132          idle = chan;
<a name="l01133"></a>01133       } <span class="keywordflow">else</span> {
<a name="l01134"></a>01134          work = chan;
<a name="l01135"></a>01135          idle = peer;
<a name="l01136"></a>01136       }
<a name="l01137"></a>01137    }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (!(app = <a class="code" href="pbx_8c.html#d407cf204ec8fc50e5a578c8c17e0cb5">pbx_findapp</a>(feature-&gt;<a class="code" href="structast__call__feature.html#e520492cda1519675365ce229091c185">app</a>))) {
<a name="l01140"></a>01140       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not find application (%s)\n"</span>, feature-&gt;<a class="code" href="structast__call__feature.html#e520492cda1519675365ce229091c185">app</a>);
<a name="l01141"></a>01141       <span class="keywordflow">return</span> -2;
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <a class="code" href="autoservice_8c.html#50d164d68da7c101dd0eadd519069afd">ast_autoservice_start</a>(idle);
<a name="l01145"></a>01145    
<a name="l01146"></a>01146    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(feature-&gt;<a class="code" href="structast__call__feature.html#e90befbe6d116c9258649367c45892ba">moh_class</a>))
<a name="l01147"></a>01147       <a class="code" href="channel_8c.html#8b713a18df0470dcb9ad2b97c33b6e6a">ast_moh_start</a>(idle, feature-&gt;<a class="code" href="structast__call__feature.html#e90befbe6d116c9258649367c45892ba">moh_class</a>, NULL);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    res = <a class="code" href="pbx_8c.html#5970fbcb6a776848d11bf1c8ddb1c948">pbx_exec</a>(work, app, feature-&gt;<a class="code" href="structast__call__feature.html#84e1bede4735b5e10efeaa278a27d7dd">app_args</a>);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(feature-&gt;<a class="code" href="structast__call__feature.html#e90befbe6d116c9258649367c45892ba">moh_class</a>))
<a name="l01152"></a>01152       <a class="code" href="channel_8c.html#db35d3bab46e0655f359b751cdca0ce3">ast_moh_stop</a>(idle);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154    <a class="code" href="autoservice_8c.html#f982194640c676dffb9052dacb2b21fd">ast_autoservice_stop</a>(idle);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156    <span class="keywordflow">if</span> (res == <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a>)
<a name="l01157"></a>01157       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#c2314b9d3cb58cee23bed252b6a857e1">FEATURE_RETURN_PBX_KEEPALIVE</a>;
<a name="l01158"></a>01158    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="pbx_8h.html#5e2459a77c1072ded5128a9c607a9e95">AST_PBX_NO_HANGUP_PEER</a>)
<a name="l01159"></a>01159       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#8a10cef1de20ed931d0caa1d33ea452f">FEATURE_RETURN_NO_HANGUP_PEER</a>;
<a name="l01160"></a>01160    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res)
<a name="l01161"></a>01161       <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5fe70eb28d6e9ad38f586fb34509facf">FEATURE_RETURN_SUCCESSBREAK</a>;
<a name="l01162"></a>01162    
<a name="l01163"></a>01163    <span class="keywordflow">return</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>;   <span class="comment">/*! \todo XXX should probably return res */</span>
<a name="l01164"></a>01164 }
<a name="l01165"></a>01165 
<a name="l01166"></a><a class="code" href="res__features_8c.html#90c5a9b8ffd142d1bc12fe7eadc541e4">01166</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#90c5a9b8ffd142d1bc12fe7eadc541e4">unmap_features</a>(<span class="keywordtype">void</span>)
<a name="l01167"></a>01167 {
<a name="l01168"></a>01168    <span class="keywordtype">int</span> x;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <a class="code" href="lock_8h.html#25d2e851f878ee9a64d36b67b67ede6e">ast_rwlock_wrlock</a>(&amp;features_lock);
<a name="l01171"></a>01171    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++)
<a name="l01172"></a>01172       strcpy(builtin_features[x].<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, builtin_features[x].default_exten);
<a name="l01173"></a>01173    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 
<a name="l01176"></a><a class="code" href="res__features_8c.html#bc427f202ff5074e9d9c045ad9e985a0">01176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#bc427f202ff5074e9d9c045ad9e985a0">remap_feature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01177"></a>01177 {
<a name="l01178"></a>01178    <span class="keywordtype">int</span> x, res = -1;
<a name="l01179"></a>01179 
<a name="l01180"></a>01180    <a class="code" href="lock_8h.html#25d2e851f878ee9a64d36b67b67ede6e">ast_rwlock_wrlock</a>(&amp;features_lock);
<a name="l01181"></a>01181    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++) {
<a name="l01182"></a>01182       <span class="keywordflow">if</span> (strcasecmp(builtin_features[x].sname, name))
<a name="l01183"></a>01183          <span class="keywordflow">continue</span>;
<a name="l01184"></a>01184 
<a name="l01185"></a>01185       ast_copy_string(builtin_features[x].<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, value, <span class="keyword">sizeof</span>(builtin_features[x].exten));
<a name="l01186"></a>01186       res = 0;
<a name="l01187"></a>01187       <span class="keywordflow">break</span>;
<a name="l01188"></a>01188    }
<a name="l01189"></a>01189    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191    <span class="keywordflow">return</span> res;
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 
<a name="l01194"></a><a class="code" href="res__features_8c.html#effe84690a12a8ac703528fd4ab6c1b7">01194</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#effe84690a12a8ac703528fd4ab6c1b7">ast_feature_interpret</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, <span class="keywordtype">char</span> *code, <span class="keywordtype">int</span> sense)
<a name="l01195"></a>01195 {
<a name="l01196"></a>01196    <span class="keywordtype">int</span> x;
<a name="l01197"></a>01197    <span class="keyword">struct </span><a class="code" href="structast__flags.html">ast_flags</a> features;
<a name="l01198"></a>01198    <span class="keywordtype">int</span> res = <a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">FEATURE_RETURN_PASSDIGITS</a>;
<a name="l01199"></a>01199    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l01200"></a>01200    <span class="keyword">const</span> <span class="keywordtype">char</span> *dynamic_features=<a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan,<span class="stringliteral">"DYNAMIC_FEATURES"</span>);
<a name="l01201"></a>01201    <span class="keywordtype">char</span> *tmp, *tok;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203    <span class="keywordflow">if</span> (sense == <a class="code" href="res__features_8c.html#bd2f1cd557108bff60f29245c9fd0b15">FEATURE_SENSE_CHAN</a>)
<a name="l01204"></a>01204       <a class="code" href="utils_8h.html#7963ad5058a8544f02f00fc94199cbc3">ast_copy_flags</a>(&amp;features, &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>), <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);   
<a name="l01205"></a>01205    <span class="keywordflow">else</span>
<a name="l01206"></a>01206       <a class="code" href="utils_8h.html#7963ad5058a8544f02f00fc94199cbc3">ast_copy_flags</a>(&amp;features, &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#fa6efc124166cce0351265506b27ec86">features_callee</a>), <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);   
<a name="l01207"></a>01207    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 2)
<a name="l01208"></a>01208       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Feature interpret: chan=%s, peer=%s, sense=%d, features=%d\n"</span>, chan-&gt;name, peer-&gt;name, sense, features.<a class="code" href="structast__channel.html#4e5868d676cb634aa75b125a0f741abf">flags</a>);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;features_lock);
<a name="l01211"></a>01211    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++) {
<a name="l01212"></a>01212       <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;features, builtin_features[x].<a class="code" href="structast__call__feature.html#ba97a0d002836d222e1d495aa262f196">feature_mask</a>)) &amp;&amp;
<a name="l01213"></a>01213           !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(builtin_features[x].<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>)) {
<a name="l01214"></a>01214          <span class="comment">/* Feature is up for consideration */</span>
<a name="l01215"></a>01215          <span class="keywordflow">if</span> (!strcmp(builtin_features[x].exten, code)) {
<a name="l01216"></a>01216             res = builtin_features[x].<a class="code" href="structast__call__feature.html#5f3439a40149f6927cf398753bc064a6">operation</a>(chan, peer, config, code, sense);
<a name="l01217"></a>01217             <span class="keywordflow">break</span>;
<a name="l01218"></a>01218          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(builtin_features[x].exten, code, strlen(code))) {
<a name="l01219"></a>01219             <span class="keywordflow">if</span> (res == <a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">FEATURE_RETURN_PASSDIGITS</a>)
<a name="l01220"></a>01220                res = <a class="code" href="res__features_8c.html#6420cac24c738a5a0b17afe3eb84c9e1">FEATURE_RETURN_STOREDIGITS</a>;
<a name="l01221"></a>01221          }
<a name="l01222"></a>01222       }
<a name="l01223"></a>01223    }
<a name="l01224"></a>01224    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01225"></a>01225 
<a name="l01226"></a>01226    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dynamic_features))
<a name="l01227"></a>01227       <span class="keywordflow">return</span> res;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229    tmp = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(dynamic_features);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <span class="keywordflow">while</span> ((tok = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp, <span class="stringliteral">"#"</span>))) {
<a name="l01232"></a>01232       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list); 
<a name="l01233"></a>01233       <span class="keywordflow">if</span> (!(feature = <a class="code" href="res__features_8c.html#80dac60ab696b3c164c0c9f53595eab5">find_dynamic_feature</a>(tok)))
<a name="l01234"></a>01234          <span class="keywordflow">continue</span>;
<a name="l01235"></a>01235          
<a name="l01236"></a>01236       <span class="comment">/* Feature is up for consideration */</span>
<a name="l01237"></a>01237       <span class="keywordflow">if</span> (!strcmp(feature-&gt;<a class="code" href="structast__call__feature.html#c4e1c560a6e8d177b293258ab07bf352">exten</a>, code)) {
<a name="l01238"></a>01238          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l01239"></a>01239             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">" Feature Found: %s exten: %s\n"</span>,feature-&gt;<a class="code" href="structast__call__feature.html#d16edd3fe2bbc564136da7d1e79586df">sname</a>, tok);
<a name="l01240"></a>01240          res = feature-&gt;<a class="code" href="structast__call__feature.html#5f3439a40149f6927cf398753bc064a6">operation</a>(chan, peer, config, code, sense);
<a name="l01241"></a>01241          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01242"></a>01242          <span class="keywordflow">break</span>;
<a name="l01243"></a>01243       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(feature-&gt;<a class="code" href="structast__call__feature.html#c4e1c560a6e8d177b293258ab07bf352">exten</a>, code, strlen(code)))
<a name="l01244"></a>01244          res = <a class="code" href="res__features_8c.html#6420cac24c738a5a0b17afe3eb84c9e1">FEATURE_RETURN_STOREDIGITS</a>;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248    
<a name="l01249"></a>01249    <span class="keywordflow">return</span> res;
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a><a class="code" href="res__features_8c.html#14bc492d1716a87183526f58266a6a37">01252</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#14bc492d1716a87183526f58266a6a37">set_config_flags</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer, <span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254    <span class="keywordtype">int</span> x;
<a name="l01255"></a>01255    
<a name="l01256"></a>01256    <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(config, <a class="code" href="utils_8h.html#c07aaa6d930db5c5594b7f4813d75982">AST_FLAGS_ALL</a>);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;features_lock);
<a name="l01259"></a>01259    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++) {
<a name="l01260"></a>01260       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(builtin_features + x, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>))
<a name="l01261"></a>01261          <span class="keywordflow">continue</span>;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>), builtin_features[x].<a class="code" href="structast__call__feature.html#ba97a0d002836d222e1d495aa262f196">feature_mask</a>))
<a name="l01264"></a>01264          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#8681ed1fe1fa7446abae5740777a5778">AST_BRIDGE_DTMF_CHANNEL_0</a>);
<a name="l01265"></a>01265 
<a name="l01266"></a>01266       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;(config-&gt;features_callee), builtin_features[x].<a class="code" href="structast__call__feature.html#ba97a0d002836d222e1d495aa262f196">feature_mask</a>))
<a name="l01267"></a>01267          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#2919689ff25adb292a33ffc670ff5663">AST_BRIDGE_DTMF_CHANNEL_1</a>);
<a name="l01268"></a>01268    }
<a name="l01269"></a>01269    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01270"></a>01270    
<a name="l01271"></a>01271    <span class="keywordflow">if</span> (chan &amp;&amp; peer &amp;&amp; !(<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(config, <a class="code" href="channel_8h.html#8681ed1fe1fa7446abae5740777a5778">AST_BRIDGE_DTMF_CHANNEL_0</a>) &amp;&amp; <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(config, <a class="code" href="channel_8h.html#2919689ff25adb292a33ffc670ff5663">AST_BRIDGE_DTMF_CHANNEL_1</a>))) {
<a name="l01272"></a>01272       <span class="keyword">const</span> <span class="keywordtype">char</span> *dynamic_features = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"DYNAMIC_FEATURES"</span>);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274       <span class="keywordflow">if</span> (dynamic_features) {
<a name="l01275"></a>01275          <span class="keywordtype">char</span> *tmp = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(dynamic_features);
<a name="l01276"></a>01276          <span class="keywordtype">char</span> *tok;
<a name="l01277"></a>01277          <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279          <span class="comment">/* while we have a feature */</span>
<a name="l01280"></a>01280          <span class="keywordflow">while</span> ((tok = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp, <span class="stringliteral">"#"</span>))) {
<a name="l01281"></a>01281             <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l01282"></a>01282             <span class="keywordflow">if</span> ((feature = <a class="code" href="res__features_8c.html#80dac60ab696b3c164c0c9f53595eab5">find_dynamic_feature</a>(tok)) &amp;&amp; <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>)) {
<a name="l01283"></a>01283                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>))
<a name="l01284"></a>01284                   <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#8681ed1fe1fa7446abae5740777a5778">AST_BRIDGE_DTMF_CHANNEL_0</a>);
<a name="l01285"></a>01285                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>))
<a name="l01286"></a>01286                   <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#2919689ff25adb292a33ffc670ff5663">AST_BRIDGE_DTMF_CHANNEL_1</a>);
<a name="l01287"></a>01287             }
<a name="l01288"></a>01288             <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l01289"></a>01289          }
<a name="l01290"></a>01290       }
<a name="l01291"></a>01291    }
<a name="l01292"></a>01292 }
<a name="l01293"></a>01293 <span class="comment"></span>
<a name="l01294"></a>01294 <span class="comment">/*! \todo XXX Check - this is very similar to the code in channel.c */</span>
<a name="l01295"></a><a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">01295</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="res__features_8c.html#43611145550390e57b6805c21f721db0">ast_feature_request_and_dial</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *caller, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *transferee, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a>, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> *outstate, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ca3c0eb6b6e898f3a32aed5de1320774">cid_num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#70f178a59d8df82fe5e107da71415b9b">cid_name</a>, <span class="keywordtype">int</span> igncallerstate)
<a name="l01296"></a>01296 {
<a name="l01297"></a>01297    <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a> = 0;
<a name="l01298"></a>01298    <span class="keywordtype">int</span> cause = 0;
<a name="l01299"></a>01299    <span class="keywordtype">int</span> to;
<a name="l01300"></a>01300    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l01301"></a>01301    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *monitor_chans[2];
<a name="l01302"></a>01302    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *active_channel;
<a name="l01303"></a>01303    <span class="keywordtype">int</span> res = 0, ready = 0;
<a name="l01304"></a>01304    
<a name="l01305"></a>01305    <span class="keywordflow">if</span> ((chan = <a class="code" href="channel_8c.html#e6f72d6b14d12c48f2e224412f10fb99">ast_request</a>(type, format, data, &amp;cause))) {
<a name="l01306"></a>01306       <a class="code" href="channel_8c.html#7f8abba078071d5d796f25ebc9198974">ast_set_callerid</a>(chan, cid_num, cid_name, cid_num);
<a name="l01307"></a>01307       <a class="code" href="channel_8c.html#8fb30ace7afdc2899f9b9cdafbf49ff7">ast_channel_inherit_variables</a>(caller, chan); 
<a name="l01308"></a>01308       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"TRANSFERERNAME"</span>, caller-&gt;name);
<a name="l01309"></a>01309       <span class="keywordflow">if</span> (!chan-&gt;cdr) {
<a name="l01310"></a>01310          chan-&gt;cdr=<a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l01311"></a>01311          <span class="keywordflow">if</span> (chan-&gt;cdr) {
<a name="l01312"></a>01312             <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(chan-&gt;cdr, chan); <span class="comment">/* initilize our channel's cdr */</span>
<a name="l01313"></a>01313             <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(chan-&gt;cdr);
<a name="l01314"></a>01314          }
<a name="l01315"></a>01315       }
<a name="l01316"></a>01316          
<a name="l01317"></a>01317       <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#37e2b9b65c43c783c6b43552cd20b438">ast_call</a>(chan, data, timeout)) {
<a name="l01318"></a>01318          <span class="keyword">struct </span>timeval started;
<a name="l01319"></a>01319          <span class="keywordtype">int</span> x, <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = 0;
<a name="l01320"></a>01320          <span class="keywordtype">char</span> *disconnect_code = NULL, *dialed_code = NULL;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>);
<a name="l01323"></a>01323          <span class="comment">/* support dialing of the featuremap disconnect code while performing an attended tranfer */</span>
<a name="l01324"></a>01324          <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;features_lock);
<a name="l01325"></a>01325          <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; x++) {
<a name="l01326"></a>01326             <span class="keywordflow">if</span> (strcasecmp(builtin_features[x].sname, <span class="stringliteral">"disconnect"</span>))
<a name="l01327"></a>01327                <span class="keywordflow">continue</span>;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329             disconnect_code = builtin_features[x].<a class="code" href="structast__call__feature.html#c4e1c560a6e8d177b293258ab07bf352">exten</a>;
<a name="l01330"></a>01330             len = strlen(disconnect_code) + 1;
<a name="l01331"></a>01331             dialed_code = alloca(len);
<a name="l01332"></a>01332             memset(dialed_code, 0, len);
<a name="l01333"></a>01333             <span class="keywordflow">break</span>;
<a name="l01334"></a>01334          }
<a name="l01335"></a>01335          <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l01336"></a>01336          x = 0;
<a name="l01337"></a>01337          started = ast_tvnow();
<a name="l01338"></a>01338          to = timeout;
<a name="l01339"></a>01339          <span class="keywordflow">while</span> (!((transferee &amp;&amp; transferee-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a>) &amp;&amp; (!igncallerstate &amp;&amp; <a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(caller))) &amp;&amp; timeout &amp;&amp; (chan-&gt;_state != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)) {
<a name="l01340"></a>01340             <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l01341"></a>01341 
<a name="l01342"></a>01342             monitor_chans[0] = caller;
<a name="l01343"></a>01343             monitor_chans[1] = chan;
<a name="l01344"></a>01344             active_channel = <a class="code" href="channel_8c.html#96a31a1429603c4049e5ef10d7ce2470">ast_waitfor_n</a>(monitor_chans, 2, &amp;to);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346             <span class="comment">/* see if the timeout has been violated */</span>
<a name="l01347"></a>01347             <span class="keywordflow">if</span>(ast_tvdiff_ms(ast_tvnow(), started) &gt; timeout) {
<a name="l01348"></a>01348                state = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>;
<a name="l01349"></a>01349                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"We exceeded our AT-timeout\n"</span>);
<a name="l01350"></a>01350                <span class="keywordflow">break</span>; <span class="comment">/*doh! timeout*/</span>
<a name="l01351"></a>01351             }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353             <span class="keywordflow">if</span> (!active_channel)
<a name="l01354"></a>01354                <span class="keywordflow">continue</span>;
<a name="l01355"></a>01355 
<a name="l01356"></a>01356             <span class="keywordflow">if</span> (chan &amp;&amp; (chan == active_channel)){
<a name="l01357"></a>01357                <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l01358"></a>01358                <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> == NULL) { <span class="comment">/*doh! where'd he go?*/</span>
<a name="l01359"></a>01359                   state = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>;
<a name="l01360"></a>01360                   res = 0;
<a name="l01361"></a>01361                   <span class="keywordflow">break</span>;
<a name="l01362"></a>01362                }
<a name="l01363"></a>01363                
<a name="l01364"></a>01364                <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> || <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype == <a class="code" href="frame_8h.html#41e7a80287a24ece13159c2d8b1b9375">AST_FRAME_DTMF</a> || <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92696800d27feca415d5c80113fb740f44">AST_FRAME_TEXT</a>) {
<a name="l01365"></a>01365                   <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>) {
<a name="l01366"></a>01366                      state = <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass;
<a name="l01367"></a>01367                      <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l01368"></a>01368                         <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is ringing\n"</span>, chan-&gt;name);
<a name="l01369"></a>01369                      <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>);
<a name="l01370"></a>01370                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>) || (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>)) {
<a name="l01371"></a>01371                      state = <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass;
<a name="l01372"></a>01372                      <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l01373"></a>01373                         <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"%s is busy\n"</span>, chan-&gt;name);
<a name="l01374"></a>01374                      <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>);
<a name="l01375"></a>01375                      <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>);
<a name="l01376"></a>01376                      <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l01377"></a>01377                      <span class="keywordflow">break</span>;
<a name="l01378"></a>01378                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>) {
<a name="l01379"></a>01379                      <span class="comment">/* This is what we are hoping for */</span>
<a name="l01380"></a>01380                      state = <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass;
<a name="l01381"></a>01381                      <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>);
<a name="l01382"></a>01382                      <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l01383"></a>01383                      ready=1;
<a name="l01384"></a>01384                      <span class="keywordflow">break</span>;
<a name="l01385"></a>01385                   } <span class="keywordflow">else</span> {
<a name="l01386"></a>01386                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Don't know what to do about control frame: %d\n"</span>, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass);
<a name="l01387"></a>01387                   }
<a name="l01388"></a>01388                   <span class="comment">/* else who cares */</span>
<a name="l01389"></a>01389                }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (caller &amp;&amp; (active_channel == caller)) {
<a name="l01392"></a>01392                <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(caller);
<a name="l01393"></a>01393                <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> == NULL) { <span class="comment">/*doh! where'd he go?*/</span>
<a name="l01394"></a>01394                   <span class="keywordflow">if</span> (!igncallerstate) {
<a name="l01395"></a>01395                      <span class="keywordflow">if</span> (caller-&gt;<a class="code" href="structast__channel.html#639992b4f019d91b38ac20bc55e05805">_softhangup</a> &amp;&amp; !chan-&gt;_softhangup) {
<a name="l01396"></a>01396                         <span class="comment">/* make this a blind transfer */</span>
<a name="l01397"></a>01397                         ready = 1;
<a name="l01398"></a>01398                         <span class="keywordflow">break</span>;
<a name="l01399"></a>01399                      }
<a name="l01400"></a>01400                      state = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>;
<a name="l01401"></a>01401                      res = 0;
<a name="l01402"></a>01402                      <span class="keywordflow">break</span>;
<a name="l01403"></a>01403                   }
<a name="l01404"></a>01404                } <span class="keywordflow">else</span> {
<a name="l01405"></a>01405                
<a name="l01406"></a>01406                   <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype == <a class="code" href="frame_8h.html#41e7a80287a24ece13159c2d8b1b9375">AST_FRAME_DTMF</a>) {
<a name="l01407"></a>01407                      dialed_code[x++] = <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass;
<a name="l01408"></a>01408                      dialed_code[x] = <span class="charliteral">'\0'</span>;
<a name="l01409"></a>01409                      <span class="keywordflow">if</span> (strlen(dialed_code) == len) {
<a name="l01410"></a>01410                         x = 0;
<a name="l01411"></a>01411                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &amp;&amp; strncmp(dialed_code, disconnect_code, x)) {
<a name="l01412"></a>01412                         x = 0;
<a name="l01413"></a>01413                         dialed_code[x] = <span class="charliteral">'\0'</span>;
<a name="l01414"></a>01414                      }
<a name="l01415"></a>01415                      <span class="keywordflow">if</span> (*dialed_code &amp;&amp; !strcmp(dialed_code, disconnect_code)) {
<a name="l01416"></a>01416                         <span class="comment">/* Caller Canceled the call */</span>
<a name="l01417"></a>01417                         state = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>;
<a name="l01418"></a>01418                         <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>);
<a name="l01419"></a>01419                         <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a> = NULL;
<a name="l01420"></a>01420                         <span class="keywordflow">break</span>;
<a name="l01421"></a>01421                      }
<a name="l01422"></a>01422                   }
<a name="l01423"></a>01423                }
<a name="l01424"></a>01424             }
<a name="l01425"></a>01425             <span class="keywordflow">if</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>)
<a name="l01426"></a>01426                <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>);
<a name="l01427"></a>01427          } <span class="comment">/* end while */</span>
<a name="l01428"></a>01428       } <span class="keywordflow">else</span>
<a name="l01429"></a>01429          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to call channel %s/%s\n"</span>, type, (<span class="keywordtype">char</span> *)data);
<a name="l01430"></a>01430    } <span class="keywordflow">else</span> {
<a name="l01431"></a>01431       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to request channel %s/%s\n"</span>, <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, (<span class="keywordtype">char</span> *)<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l01432"></a>01432       <span class="keywordflow">switch</span>(cause) {
<a name="l01433"></a>01433       <span class="keywordflow">case</span> AST_CAUSE_BUSY:
<a name="l01434"></a>01434          <a class="code" href="structstate.html">state</a> = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>;
<a name="l01435"></a>01435          <span class="keywordflow">break</span>;
<a name="l01436"></a>01436       <span class="keywordflow">case</span> AST_CAUSE_CONGESTION:
<a name="l01437"></a>01437          <a class="code" href="structstate.html">state</a> = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>;
<a name="l01438"></a>01438          <span class="keywordflow">break</span>;
<a name="l01439"></a>01439       }
<a name="l01440"></a>01440    }
<a name="l01441"></a>01441    
<a name="l01442"></a>01442    <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(caller, -1);
<a name="l01443"></a>01443    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> &amp;&amp; ready) {
<a name="l01444"></a>01444       <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> == <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>) 
<a name="l01445"></a>01445          <a class="code" href="structstate.html">state</a> = <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>;
<a name="l01446"></a>01446       res = 0;
<a name="l01447"></a>01447    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>) {
<a name="l01448"></a>01448       res = -1;
<a name="l01449"></a>01449       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l01450"></a>01450       <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> = NULL;
<a name="l01451"></a>01451    } <span class="keywordflow">else</span> {
<a name="l01452"></a>01452       res = -1;
<a name="l01453"></a>01453    }
<a name="l01454"></a>01454    
<a name="l01455"></a>01455    <span class="keywordflow">if</span> (outstate)
<a name="l01456"></a>01456       *outstate = <a class="code" href="structstate.html">state</a>;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> &amp;&amp; res &lt;= 0) {
<a name="l01459"></a>01459       <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> || (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>())) {
<a name="l01460"></a>01460          <span class="keywordtype">char</span> tmp[256];
<a name="l01461"></a>01461          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l01462"></a>01462          snprintf(tmp, 256, <span class="stringliteral">"%s/%s"</span>, <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, (<span class="keywordtype">char</span> *)<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>);
<a name="l01463"></a>01463          <a class="code" href="cdr_8c.html#018b6c8a00209b6cf1fd7386b493f930">ast_cdr_setapp</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>,<span class="stringliteral">"Dial"</span>,tmp);
<a name="l01464"></a>01464          <a class="code" href="cdr_8c.html#0247fba893abcaf42f3861b4982361db">ast_cdr_update</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l01465"></a>01465          <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01466"></a>01466          <a class="code" href="cdr_8c.html#545d0bb7a87e9317b6eb3ce2245145cc">ast_cdr_end</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01467"></a>01467          <span class="comment">/* If the cause wasn't handled properly */</span>
<a name="l01468"></a>01468          <span class="keywordflow">if</span> (<a class="code" href="cdr_8c.html#995ca95113dc7070faca1a0969a72eb9">ast_cdr_disposition</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>,<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#8be5f831332d8ff714e90c2cf85171fe">hangupcause</a>))
<a name="l01469"></a>01469             <a class="code" href="cdr_8c.html#3f2e573eb7fde7a250ca8aa95a0d367d">ast_cdr_failed</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01470"></a>01470       } <span class="keywordflow">else</span> {
<a name="l01471"></a>01471          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create Call Detail Record\n"</span>);
<a name="l01472"></a>01472       }
<a name="l01473"></a>01473    }
<a name="l01474"></a>01474    
<a name="l01475"></a>01475    <span class="keywordflow">return</span> <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>;
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
<a name="l01478"></a><a class="code" href="res__features_8c.html#61263ca8af831dbacdf11ec96ed61076">01478</a> <span class="keywordtype">int</span> <a class="code" href="features_8h.html#61263ca8af831dbacdf11ec96ed61076">ast_bridge_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>,<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *peer,<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>)
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480    <span class="comment">/* Copy voice back and forth between the two channels.  Give the peer</span>
<a name="l01481"></a>01481 <span class="comment">      the ability to transfer calls with '#&lt;extension' syntax. */</span>
<a name="l01482"></a>01482    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01483"></a>01483    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *who;
<a name="l01484"></a>01484    <span class="keywordtype">char</span> chan_featurecode[<a class="code" href="features_8h.html#9015c3c18d05709358864ff48e71223c">FEATURE_MAX_LEN</a> + 1]=<span class="stringliteral">""</span>;
<a name="l01485"></a>01485    <span class="keywordtype">char</span> peer_featurecode[<a class="code" href="features_8h.html#9015c3c18d05709358864ff48e71223c">FEATURE_MAX_LEN</a> + 1]=<span class="stringliteral">""</span>;
<a name="l01486"></a>01486    <span class="keywordtype">int</span> res;
<a name="l01487"></a>01487    <span class="keywordtype">int</span> diff;
<a name="l01488"></a>01488    <span class="keywordtype">int</span> hasfeatures=0;
<a name="l01489"></a>01489    <span class="keywordtype">int</span> hadfeatures=0;
<a name="l01490"></a>01490    <span class="keyword">struct </span><a class="code" href="structast__option__header.html">ast_option_header</a> *aoh;
<a name="l01491"></a>01491    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html">ast_bridge_config</a> backup_config;
<a name="l01492"></a>01492    <span class="keyword">struct </span><a class="code" href="structast__cdr.html">ast_cdr</a> *bridge_cdr;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494    memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(backup_config));
<a name="l01495"></a>01495 
<a name="l01496"></a>01496    config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a> = ast_tvnow();
<a name="l01497"></a>01497 
<a name="l01498"></a>01498    <span class="keywordflow">if</span> (chan &amp;&amp; peer) {
<a name="l01499"></a>01499       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BRIDGEPEER"</span>, peer-&gt;name);
<a name="l01500"></a>01500       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(peer, <span class="stringliteral">"BRIDGEPEER"</span>, chan-&gt;name);
<a name="l01501"></a>01501    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan)
<a name="l01502"></a>01502       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BLINDTRANSFER"</span>, NULL);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504    <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">monitor_ok</a>) {
<a name="l01505"></a>01505       <span class="keyword">const</span> <span class="keywordtype">char</span> *monitor_exec;
<a name="l01506"></a>01506       <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *src = NULL;
<a name="l01507"></a>01507       <span class="keywordflow">if</span> (!monitor_app) { 
<a name="l01508"></a>01508          <span class="keywordflow">if</span> (!(monitor_app = <a class="code" href="pbx_8c.html#d407cf204ec8fc50e5a578c8c17e0cb5">pbx_findapp</a>(<span class="stringliteral">"Monitor"</span>)))
<a name="l01509"></a>01509             <a class="code" href="res__features_8c.html#a1f02527220665b8b661a7c62b1ae67c">monitor_ok</a>=0;
<a name="l01510"></a>01510       }
<a name="l01511"></a>01511       <span class="keywordflow">if</span> ((monitor_exec = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"AUTO_MONITOR"</span>))) 
<a name="l01512"></a>01512          src = chan;
<a name="l01513"></a>01513       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((monitor_exec = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(peer, <span class="stringliteral">"AUTO_MONITOR"</span>)))
<a name="l01514"></a>01514          src = peer;
<a name="l01515"></a>01515       <span class="keywordflow">if</span> (monitor_app &amp;&amp; src) {
<a name="l01516"></a>01516          <span class="keywordtype">char</span> *tmp = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(monitor_exec);
<a name="l01517"></a>01517          <a class="code" href="pbx_8c.html#5970fbcb6a776848d11bf1c8ddb1c948">pbx_exec</a>(src, monitor_app, tmp);
<a name="l01518"></a>01518       }
<a name="l01519"></a>01519    }
<a name="l01520"></a>01520    
<a name="l01521"></a>01521    <a class="code" href="res__features_8c.html#14bc492d1716a87183526f58266a6a37">set_config_flags</a>(chan, peer, config);
<a name="l01522"></a>01522    config-&gt;<a class="code" href="structast__bridge__config.html#b9313589eca257aaed154d3517ab7f0f">firstpass</a> = 1;
<a name="l01523"></a>01523 
<a name="l01524"></a>01524    <span class="comment">/* Answer if need be */</span>
<a name="l01525"></a>01525    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan))
<a name="l01526"></a>01526       <span class="keywordflow">return</span> -1;
<a name="l01527"></a>01527    peer-&gt;<a class="code" href="structast__channel.html#63469c3c4f19f07c737127a117296de4">appl</a> = <span class="stringliteral">"Bridged Call"</span>;
<a name="l01528"></a>01528    peer-&gt;<a class="code" href="structast__channel.html#8d777f385d3dfec8815d20f7496026dc">data</a> = chan-&gt;name;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530    <span class="comment">/* copy the userfield from the B-leg to A-leg if applicable */</span>
<a name="l01531"></a>01531    <span class="keywordflow">if</span> (chan-&gt;cdr &amp;&amp; peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>-&gt;<a class="code" href="structast__cdr.html#07c0f6b6a5bf53c1c68383f1f0c9398e">userfield</a>)) {
<a name="l01532"></a>01532       <span class="keywordtype">char</span> tmp[256];
<a name="l01533"></a>01533       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;cdr-&gt;userfield)) {
<a name="l01534"></a>01534          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s;%s"</span>, chan-&gt;cdr-&gt;userfield, peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>-&gt;<a class="code" href="structast__cdr.html#07c0f6b6a5bf53c1c68383f1f0c9398e">userfield</a>);
<a name="l01535"></a>01535          <a class="code" href="cdr_8c.html#4ba69b96a8d7733c5e70a5555e94306f">ast_cdr_appenduserfield</a>(chan, tmp);
<a name="l01536"></a>01536       } <span class="keywordflow">else</span>
<a name="l01537"></a>01537          <a class="code" href="cdr_8c.html#7faf485af47fef9299ce51da70c13c8b">ast_cdr_setuserfield</a>(chan, peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>-&gt;<a class="code" href="structast__cdr.html#07c0f6b6a5bf53c1c68383f1f0c9398e">userfield</a>);
<a name="l01538"></a>01538       <span class="comment">/* free the peer's cdr without ast_cdr_free complaining */</span>
<a name="l01539"></a>01539       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01540"></a>01540       peer-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = NULL;
<a name="l01541"></a>01541    }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543    <span class="keywordflow">for</span> (;;) {
<a name="l01544"></a>01544       <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *other; <span class="comment">/* used later */</span>
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       res = <a class="code" href="channel_8c.html#63ab4d8e95fedaabf03d0f492368e930">ast_channel_bridge</a>(chan, peer, config, &amp;f, &amp;who);
<a name="l01547"></a>01547 
<a name="l01548"></a>01548       <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a>) {
<a name="l01549"></a>01549          <span class="comment">/* Update time limit for next pass */</span>
<a name="l01550"></a>01550          diff = ast_tvdiff_ms(ast_tvnow(), config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a>);
<a name="l01551"></a>01551          config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> -= diff;
<a name="l01552"></a>01552          <span class="keywordflow">if</span> (hasfeatures) {
<a name="l01553"></a>01553             <span class="comment">/* Running on backup config, meaning a feature might be being</span>
<a name="l01554"></a>01554 <span class="comment">               activated, but that's no excuse to keep things going </span>
<a name="l01555"></a>01555 <span class="comment">               indefinitely! */</span>
<a name="l01556"></a>01556             <span class="keywordflow">if</span> (backup_config.feature_timer &amp;&amp; ((backup_config.feature_timer -= diff) &lt;= 0)) {
<a name="l01557"></a>01557                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01558"></a>01558                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Timed out, realtime this time!\n"</span>);
<a name="l01559"></a>01559                config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> = 0;
<a name="l01560"></a>01560                who = chan;
<a name="l01561"></a>01561                <span class="keywordflow">if</span> (f)
<a name="l01562"></a>01562                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01563"></a>01563                f = NULL;
<a name="l01564"></a>01564                res = 0;
<a name="l01565"></a>01565             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> &lt;= 0) {
<a name="l01566"></a>01566                <span class="comment">/* Not *really* out of time, just out of time for</span>
<a name="l01567"></a>01567 <span class="comment">                  digits to come in for features. */</span>
<a name="l01568"></a>01568                <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01569"></a>01569                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Timed out for feature!\n"</span>);
<a name="l01570"></a>01570                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(peer_featurecode)) {
<a name="l01571"></a>01571                   <a class="code" href="app_8c.html#8199b7508395e37a031a6b4ff2ebe0a7">ast_dtmf_stream</a>(chan, peer, peer_featurecode, 0);
<a name="l01572"></a>01572                   memset(peer_featurecode, 0, <span class="keyword">sizeof</span>(peer_featurecode));
<a name="l01573"></a>01573                }
<a name="l01574"></a>01574                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan_featurecode)) {
<a name="l01575"></a>01575                   <a class="code" href="app_8c.html#8199b7508395e37a031a6b4ff2ebe0a7">ast_dtmf_stream</a>(peer, chan, chan_featurecode, 0);
<a name="l01576"></a>01576                   memset(chan_featurecode, 0, <span class="keyword">sizeof</span>(chan_featurecode));
<a name="l01577"></a>01577                }
<a name="l01578"></a>01578                <span class="keywordflow">if</span> (f)
<a name="l01579"></a>01579                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01580"></a>01580                hasfeatures = !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan_featurecode) || !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(peer_featurecode);
<a name="l01581"></a>01581                <span class="keywordflow">if</span> (!hasfeatures) {
<a name="l01582"></a>01582                   <span class="comment">/* Restore original (possibly time modified) bridge config */</span>
<a name="l01583"></a>01583                   memcpy(config, &amp;backup_config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a>));
<a name="l01584"></a>01584                   memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(backup_config));
<a name="l01585"></a>01585                }
<a name="l01586"></a>01586                hadfeatures = hasfeatures;
<a name="l01587"></a>01587                <span class="comment">/* Continue as we were */</span>
<a name="l01588"></a>01588                <span class="keywordflow">continue</span>;
<a name="l01589"></a>01589             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!f) {
<a name="l01590"></a>01590                <span class="comment">/* The bridge returned without a frame and there is a feature in progress.</span>
<a name="l01591"></a>01591 <span class="comment">                * However, we don't think the feature has quite yet timed out, so just</span>
<a name="l01592"></a>01592 <span class="comment">                * go back into the bridge. */</span>
<a name="l01593"></a>01593                <span class="keywordflow">continue</span>;
<a name="l01594"></a>01594             }
<a name="l01595"></a>01595          } <span class="keywordflow">else</span> {
<a name="l01596"></a>01596             <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> &lt;=0) {
<a name="l01597"></a>01597                <span class="comment">/* We ran out of time */</span>
<a name="l01598"></a>01598                config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> = 0;
<a name="l01599"></a>01599                who = chan;
<a name="l01600"></a>01600                <span class="keywordflow">if</span> (f)
<a name="l01601"></a>01601                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01602"></a>01602                f = NULL;
<a name="l01603"></a>01603                res = 0;
<a name="l01604"></a>01604             }
<a name="l01605"></a>01605          }
<a name="l01606"></a>01606       }
<a name="l01607"></a>01607       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01608"></a>01608          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Bridge failed on channels %s and %s\n"</span>, chan-&gt;name, peer-&gt;name);
<a name="l01609"></a>01609          <span class="keywordflow">return</span> -1;
<a name="l01610"></a>01610       }
<a name="l01611"></a>01611       
<a name="l01612"></a>01612       <span class="keywordflow">if</span> (!f || (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> &amp;&amp;
<a name="l01613"></a>01613             (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a> || f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a> || 
<a name="l01614"></a>01614                f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>))) {
<a name="l01615"></a>01615          res = -1;
<a name="l01616"></a>01616          <span class="keywordflow">break</span>;
<a name="l01617"></a>01617       }
<a name="l01618"></a>01618       <span class="comment">/* many things should be sent to the 'other' channel */</span>
<a name="l01619"></a>01619       other = (who == chan) ? peer : chan;
<a name="l01620"></a>01620       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>) {
<a name="l01621"></a>01621          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>)
<a name="l01622"></a>01622             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(other, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>);
<a name="l01623"></a>01623          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == -1)
<a name="l01624"></a>01624             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(other, -1);
<a name="l01625"></a>01625          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3899da5863316de5e07e562d773bb39e94a">AST_CONTROL_FLASH</a>)
<a name="l01626"></a>01626             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(other, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3899da5863316de5e07e562d773bb39e94a">AST_CONTROL_FLASH</a>);
<a name="l01627"></a>01627          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> == <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e18699f69d7f0d792d74b5a50732765f">AST_CONTROL_OPTION</a>) {
<a name="l01628"></a>01628             aoh = f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l01629"></a>01629             <span class="comment">/* Forward option Requests */</span>
<a name="l01630"></a>01630             <span class="keywordflow">if</span> (aoh &amp;&amp; aoh-&gt;<a class="code" href="structast__option__header.html#327a6c4304ad5938eaf0efb6cc3e53dc">flag</a> == <a class="code" href="frame_8h.html#40fdb73aaab11ca6d798133d215ff1bd">AST_OPTION_FLAG_REQUEST</a>)
<a name="l01631"></a>01631                <a class="code" href="channel_8c.html#fd050188748d1697051e8176fb5fee36">ast_channel_setoption</a>(other, ntohs(aoh-&gt;<a class="code" href="structast__option__header.html#ef3e30e070f70244fd6578d88a6b77ac">option</a>), aoh-&gt;<a class="code" href="structast__option__header.html#59a6c49cfff82ce638c44fec9cd91ddb">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__option__header.html">ast_option_header</a>), 0);
<a name="l01632"></a>01632          }
<a name="l01633"></a>01633       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f923c709a87ba681b04d6a6285d6d0af892">AST_FRAME_DTMF_BEGIN</a>) {
<a name="l01634"></a>01634          <span class="comment">/* eat it */</span>
<a name="l01635"></a>01635       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#41e7a80287a24ece13159c2d8b1b9375">AST_FRAME_DTMF</a>) {
<a name="l01636"></a>01636          <span class="keywordtype">char</span> *featurecode;
<a name="l01637"></a>01637          <span class="keywordtype">int</span> sense;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639          hadfeatures = hasfeatures;
<a name="l01640"></a>01640          <span class="comment">/* This cannot overrun because the longest feature is one shorter than our buffer */</span>
<a name="l01641"></a>01641          <span class="keywordflow">if</span> (who == chan) {
<a name="l01642"></a>01642             sense = <a class="code" href="res__features_8c.html#bd2f1cd557108bff60f29245c9fd0b15">FEATURE_SENSE_CHAN</a>;
<a name="l01643"></a>01643             featurecode = chan_featurecode;
<a name="l01644"></a>01644          } <span class="keywordflow">else</span>  {
<a name="l01645"></a>01645             sense = <a class="code" href="res__features_8c.html#34918b66feeac9340849ed1c5a1e105d">FEATURE_SENSE_PEER</a>;
<a name="l01646"></a>01646             featurecode = peer_featurecode;
<a name="l01647"></a>01647          }<span class="comment"></span>
<a name="l01648"></a>01648 <span class="comment">         /*! append the event to featurecode. we rely on the string being zero-filled, and</span>
<a name="l01649"></a>01649 <span class="comment">          * not overflowing it. </span>
<a name="l01650"></a>01650 <span class="comment">          * \todo XXX how do we guarantee the latter ?</span>
<a name="l01651"></a>01651 <span class="comment">          */</span>
<a name="l01652"></a>01652          featurecode[strlen(featurecode)] = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l01653"></a>01653          <span class="comment">/* Get rid of the frame before we start doing "stuff" with the channels */</span>
<a name="l01654"></a>01654          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01655"></a>01655          f = NULL;
<a name="l01656"></a>01656          config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> = backup_config.feature_timer;
<a name="l01657"></a>01657          res = <a class="code" href="res__features_8c.html#effe84690a12a8ac703528fd4ab6c1b7">ast_feature_interpret</a>(chan, peer, config, featurecode, sense);
<a name="l01658"></a>01658          <span class="keywordflow">switch</span>(res) {
<a name="l01659"></a>01659          <span class="keywordflow">case</span> FEATURE_RETURN_PASSDIGITS:
<a name="l01660"></a>01660             <a class="code" href="app_8c.html#8199b7508395e37a031a6b4ff2ebe0a7">ast_dtmf_stream</a>(other, who, featurecode, 0);
<a name="l01661"></a>01661             <span class="comment">/* Fall through */</span>
<a name="l01662"></a>01662          <span class="keywordflow">case</span> <a class="code" href="res__features_8c.html#5e030ad573431b2bda6282aa4351a449">FEATURE_RETURN_SUCCESS</a>:
<a name="l01663"></a>01663             memset(featurecode, 0, <span class="keyword">sizeof</span>(chan_featurecode));
<a name="l01664"></a>01664             <span class="keywordflow">break</span>;
<a name="l01665"></a>01665          }
<a name="l01666"></a>01666          <span class="keywordflow">if</span> (res &gt;= <a class="code" href="res__features_8c.html#1bc8fc72a69097020e846cba3ec9b836">FEATURE_RETURN_PASSDIGITS</a>) {
<a name="l01667"></a>01667             res = 0;
<a name="l01668"></a>01668          } <span class="keywordflow">else</span> 
<a name="l01669"></a>01669             <span class="keywordflow">break</span>;
<a name="l01670"></a>01670          hasfeatures = !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan_featurecode) || !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(peer_featurecode);
<a name="l01671"></a>01671          <span class="keywordflow">if</span> (hadfeatures &amp;&amp; !hasfeatures) {
<a name="l01672"></a>01672             <span class="comment">/* Restore backup */</span>
<a name="l01673"></a>01673             memcpy(config, &amp;backup_config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a>));
<a name="l01674"></a>01674             memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ast_bridge_config));
<a name="l01675"></a>01675          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hasfeatures) {
<a name="l01676"></a>01676             <span class="keywordflow">if</span> (!hadfeatures) {
<a name="l01677"></a>01677                <span class="comment">/* Backup configuration */</span>
<a name="l01678"></a>01678                memcpy(&amp;backup_config, config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a>));
<a name="l01679"></a>01679                <span class="comment">/* Setup temporary config options */</span>
<a name="l01680"></a>01680                config-&gt;<a class="code" href="structast__bridge__config.html#09928184e097afa29194fffb0063815f">play_warning</a> = 0;
<a name="l01681"></a>01681                <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#9775c13d5cb338f60cdd1eeebf66c249">features_caller</a>), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04040ce118987e724063d0b58eafd9b4f">AST_FEATURE_PLAY_WARNING</a>);
<a name="l01682"></a>01682                <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#fa6efc124166cce0351265506b27ec86">features_callee</a>), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d04040ce118987e724063d0b58eafd9b4f">AST_FEATURE_PLAY_WARNING</a>);
<a name="l01683"></a>01683                config-&gt;<a class="code" href="structast__bridge__config.html#fcf98f20f13092d41dfe08cb2aec545b">warning_freq</a> = 0;
<a name="l01684"></a>01684                config-&gt;<a class="code" href="structast__bridge__config.html#9e189dff12c1fb230c009fc4ab527943">warning_sound</a> = NULL;
<a name="l01685"></a>01685                config-&gt;<a class="code" href="structast__bridge__config.html#9a91b3041002dbc3bdeef606ad9a28be">end_sound</a> = NULL;
<a name="l01686"></a>01686                config-&gt;<a class="code" href="structast__bridge__config.html#2dd6d1b658d4294b5eefd558b669488e">start_sound</a> = NULL;
<a name="l01687"></a>01687                config-&gt;<a class="code" href="structast__bridge__config.html#b9313589eca257aaed154d3517ab7f0f">firstpass</a> = 0;
<a name="l01688"></a>01688             }
<a name="l01689"></a>01689             config-&gt;<a class="code" href="structast__bridge__config.html#c4d98dbd5badae901761ab6422fa3e70">start_time</a> = ast_tvnow();
<a name="l01690"></a>01690             config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a> = <a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a>;
<a name="l01691"></a>01691             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01692"></a>01692                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Set time limit to %ld\n"</span>, config-&gt;<a class="code" href="structast__bridge__config.html#dfe9693aa0a7a7c3ac9558a7fc78338f">feature_timer</a>);
<a name="l01693"></a>01693          }
<a name="l01694"></a>01694       }
<a name="l01695"></a>01695       <span class="keywordflow">if</span> (f)
<a name="l01696"></a>01696          <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698    }
<a name="l01699"></a>01699    <span class="comment">/* arrange the cdrs */</span>
<a name="l01700"></a>01700    bridge_cdr = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>();
<a name="l01701"></a>01701    <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l01702"></a>01702       <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> &amp;&amp; peer-&gt;cdr) { <span class="comment">/* both of them? merge */</span>
<a name="l01703"></a>01703          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(bridge_cdr,<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>); <span class="comment">/* seems more logicaller to use the  destination as a base, but, really, it's random */</span>
<a name="l01704"></a>01704          <a class="code" href="cdr_8c.html#56e1b7b9d5acada4d22d345813710582">ast_cdr_start</a>(bridge_cdr); <span class="comment">/* now is the time to start */</span>
<a name="l01705"></a>01705          
<a name="l01706"></a>01706          <span class="comment">/* absorb the channel cdr */</span>
<a name="l01707"></a>01707          <a class="code" href="cdr_8c.html#b7fa0bd117aed5d3693e653d00985aa0">ast_cdr_merge</a>(bridge_cdr, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01708"></a>01708          <a class="code" href="cdr_8c.html#46e80e6b7ec200439ddd4fc6bdea4f5b">ast_cdr_discard</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>); <span class="comment">/* no posting these guys */</span>
<a name="l01709"></a>01709          
<a name="l01710"></a>01710          <span class="comment">/* absorb the peer cdr */</span>
<a name="l01711"></a>01711          <a class="code" href="cdr_8c.html#b7fa0bd117aed5d3693e653d00985aa0">ast_cdr_merge</a>(bridge_cdr, peer-&gt;cdr);
<a name="l01712"></a>01712          <a class="code" href="cdr_8c.html#46e80e6b7ec200439ddd4fc6bdea4f5b">ast_cdr_discard</a>(peer-&gt;cdr); <span class="comment">/* no posting these guys */</span>
<a name="l01713"></a>01713          peer-&gt;cdr = NULL;
<a name="l01714"></a>01714          <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = bridge_cdr; <span class="comment">/* make this available to the rest of the world via the chan while the call is in progress */</span>
<a name="l01715"></a>01715       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>) {
<a name="l01716"></a>01716          <span class="comment">/* take the cdr from the channel - literally */</span>
<a name="l01717"></a>01717          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(bridge_cdr,<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l01718"></a>01718          <span class="comment">/* absorb this data */</span>
<a name="l01719"></a>01719          <a class="code" href="cdr_8c.html#b7fa0bd117aed5d3693e653d00985aa0">ast_cdr_merge</a>(bridge_cdr, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>);
<a name="l01720"></a>01720          <a class="code" href="cdr_8c.html#46e80e6b7ec200439ddd4fc6bdea4f5b">ast_cdr_discard</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>); <span class="comment">/* no posting these guys */</span>
<a name="l01721"></a>01721          <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = bridge_cdr; <span class="comment">/* make this available to the rest of the world via the chan while the call is in progress */</span>
<a name="l01722"></a>01722       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;cdr) {
<a name="l01723"></a>01723          <span class="comment">/* take the cdr from the peer - literally */</span>
<a name="l01724"></a>01724          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(bridge_cdr,peer);
<a name="l01725"></a>01725          <span class="comment">/* absorb this data */</span>
<a name="l01726"></a>01726          <a class="code" href="cdr_8c.html#b7fa0bd117aed5d3693e653d00985aa0">ast_cdr_merge</a>(bridge_cdr, peer-&gt;cdr);
<a name="l01727"></a>01727          <a class="code" href="cdr_8c.html#46e80e6b7ec200439ddd4fc6bdea4f5b">ast_cdr_discard</a>(peer-&gt;cdr); <span class="comment">/* no posting these guys */</span>
<a name="l01728"></a>01728          peer-&gt;cdr = NULL;
<a name="l01729"></a>01729          peer-&gt;cdr = bridge_cdr; <span class="comment">/* make this available to the rest of the world via the chan while the call is in progress */</span>
<a name="l01730"></a>01730       } <span class="keywordflow">else</span> {
<a name="l01731"></a>01731          <span class="comment">/* make up a new cdr */</span>
<a name="l01732"></a>01732          <a class="code" href="cdr_8c.html#4d85bb268956ffbf0b19df25915726e8">ast_cdr_init</a>(bridge_cdr,<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>); <span class="comment">/* eh, just pick one of them */</span>
<a name="l01733"></a>01733          <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = bridge_cdr; <span class="comment">/*  */</span>
<a name="l01734"></a>01734       }
<a name="l01735"></a>01735       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(bridge_cdr-&gt;dstchannel)) {
<a name="l01736"></a>01736          <span class="keywordflow">if</span> (strcmp(bridge_cdr-&gt;channel, peer-&gt;name) != 0)
<a name="l01737"></a>01737             <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(bridge_cdr, peer-&gt;name);
<a name="l01738"></a>01738          <span class="keywordflow">else</span>
<a name="l01739"></a>01739             <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(bridge_cdr, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l01740"></a>01740       }
<a name="l01741"></a>01741    }
<a name="l01742"></a>01742    <span class="keywordflow">return</span> res;
<a name="l01743"></a>01743 }
<a name="l01744"></a>01744 <span class="comment"></span>
<a name="l01745"></a>01745 <span class="comment">/*! \brief Output parking event to manager */</span>
<a name="l01746"></a><a class="code" href="res__features_8c.html#fa5f88633ba5583d4a9ad6ac1ab18787">01746</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#fa5f88633ba5583d4a9ad6ac1ab18787">post_manager_event</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">struct</span> <a class="code" href="structparkeduser.html">parkeduser</a> *pu)
<a name="l01747"></a>01747 {
<a name="l01748"></a>01748    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, s,
<a name="l01749"></a>01749       <span class="stringliteral">"Exten: %s\r\n"</span>
<a name="l01750"></a>01750       <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l01751"></a>01751       <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l01752"></a>01752       <span class="stringliteral">"CallerIDName: %s\r\n\r\n"</span>,
<a name="l01753"></a>01753       pu-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, 
<a name="l01754"></a>01754       pu-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name,
<a name="l01755"></a>01755       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l01756"></a>01756       <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">"&lt;unknown&gt;"</span>)
<a name="l01757"></a>01757       );
<a name="l01758"></a>01758 }
<a name="l01759"></a>01759 <span class="comment"></span>
<a name="l01760"></a>01760 <span class="comment">/*! \brief Take care of parked calls and unpark them if needed */</span>
<a name="l01761"></a><a class="code" href="res__features_8c.html#1cb474fc7a9c1efaa139eb3b8aa96254">01761</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__features_8c.html#1cb474fc7a9c1efaa139eb3b8aa96254">do_parking_thread</a>(<span class="keywordtype">void</span> *ignore)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763    <span class="keywordtype">char</span> parkingslot[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01764"></a>01764    fd_set rfds, efds;   <span class="comment">/* results from previous select, to be preserved across loops. */</span>
<a name="l01765"></a>01765 
<a name="l01766"></a>01766    FD_ZERO(&amp;rfds);
<a name="l01767"></a>01767    FD_ZERO(&amp;efds);
<a name="l01768"></a>01768 
<a name="l01769"></a>01769    <span class="keywordflow">for</span> (;;) {
<a name="l01770"></a>01770       <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *pu, *pl, *pt = NULL;
<a name="l01771"></a>01771       <span class="keywordtype">int</span> ms = -1;   <span class="comment">/* select timeout, uninitialized */</span>
<a name="l01772"></a>01772       <span class="keywordtype">int</span> max = -1;  <span class="comment">/* max fd, none there yet */</span>
<a name="l01773"></a>01773       fd_set nrfds, nefds; <span class="comment">/* args for the next select */</span>
<a name="l01774"></a>01774       FD_ZERO(&amp;nrfds);
<a name="l01775"></a>01775       FD_ZERO(&amp;nefds);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;parking_lock);
<a name="l01778"></a>01778       pl = NULL;
<a name="l01779"></a>01779       pu = parkinglot;
<a name="l01780"></a>01780       <span class="comment">/* navigate the list with prev-cur pointers to support removals */</span>
<a name="l01781"></a>01781       <span class="keywordflow">while</span> (pu) {
<a name="l01782"></a>01782          <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a> = pu-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>;   <span class="comment">/* shorthand */</span>
<a name="l01783"></a>01783          <span class="keywordtype">int</span> tms;        <span class="comment">/* timeout for this item */</span>
<a name="l01784"></a>01784          <span class="keywordtype">int</span> x;          <span class="comment">/* fd index in channel */</span>
<a name="l01785"></a>01785          <span class="keyword">struct </span><a class="code" href="structast__context.html">ast_context</a> *con;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787          <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#abd25c1411415ae93a1a7ec80f270e3e">notquiteyet</a>) { <span class="comment">/* Pretend this one isn't here yet */</span>
<a name="l01788"></a>01788             pl = pu;
<a name="l01789"></a>01789             pu = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01790"></a>01790             <span class="keywordflow">continue</span>;
<a name="l01791"></a>01791          }
<a name="l01792"></a>01792          tms = ast_tvdiff_ms(ast_tvnow(), pu-&gt;<a class="code" href="structparkeduser.html#ea2b2676c28c0db26d39331a336c6b92">start</a>);
<a name="l01793"></a>01793          <span class="keywordflow">if</span> (tms &gt; pu-&gt;<a class="code" href="structparkeduser.html#c700875891439809b350a5e629558902">parkingtime</a>) {
<a name="l01794"></a>01794             <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l01795"></a>01795             <span class="comment">/* Get chan, exten from derived kludge */</span>
<a name="l01796"></a>01796             <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#c918796d8b2a501b03d3814d1d2c7a0e">peername</a>[0]) {
<a name="l01797"></a>01797                <span class="keywordtype">char</span> *peername = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(pu-&gt;<a class="code" href="structparkeduser.html#c918796d8b2a501b03d3814d1d2c7a0e">peername</a>);
<a name="l01798"></a>01798                <span class="keywordtype">char</span> *cp = strrchr(peername, <span class="charliteral">'-'</span>);
<a name="l01799"></a>01799                <span class="keywordflow">if</span> (cp) 
<a name="l01800"></a>01800                   *cp = 0;
<a name="l01801"></a>01801                con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>);
<a name="l01802"></a>01802                <span class="keywordflow">if</span> (!con) {
<a name="l01803"></a>01803                   con = <a class="code" href="pbx_8c.html#9b7261abb02956903bb17c5bf8af265a">ast_context_create</a>(NULL, <a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>);
<a name="l01804"></a>01804                   <span class="keywordflow">if</span> (!con)
<a name="l01805"></a>01805                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Parking dial context '%s' does not exist and unable to create\n"</span>, <a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>);
<a name="l01806"></a>01806                }
<a name="l01807"></a>01807                <span class="keywordflow">if</span> (con) {
<a name="l01808"></a>01808                   <span class="keywordtype">char</span> returnexten[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l01809"></a>01809                   snprintf(returnexten, <span class="keyword">sizeof</span>(returnexten), <span class="stringliteral">"%s||t"</span>, peername);
<a name="l01810"></a>01810                   <a class="code" href="pbx_8c.html#0985a9a977ba8aa4f370da3a495437ae">ast_add_extension2</a>(con, 1, peername, 1, NULL, NULL, <span class="stringliteral">"Dial"</span>, <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(returnexten), <a class="code" href="utils_8h.html#801d8022c2922d0d4f73ba9e72c93865">ast_free</a>, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>);
<a name="l01811"></a>01811                }
<a name="l01812"></a>01812                <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#0d0097fcffce18c1b3c2a8904c087f83">comebacktoorigin</a>) { 
<a name="l01813"></a>01813                   <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(chan, <a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>, peername, 1);
<a name="l01814"></a>01814                } <span class="keywordflow">else</span> {
<a name="l01815"></a>01815                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"now going to parkedcallstimeout,s,1 | ps is %d\n"</span>,pu-&gt;<a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a>);
<a name="l01816"></a>01816                   snprintf(parkingslot, <span class="keyword">sizeof</span>(parkingslot), <span class="stringliteral">"%d"</span>, pu-&gt;<a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a>);
<a name="l01817"></a>01817                   <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(pu-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="stringliteral">"PARKINGSLOT"</span>, parkingslot);
<a name="l01818"></a>01818                   <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(chan, <span class="stringliteral">"parkedcallstimeout"</span>, peername, 1);
<a name="l01819"></a>01819                }
<a name="l01820"></a>01820             } <span class="keywordflow">else</span> {
<a name="l01821"></a>01821                <span class="comment">/* They've been waiting too long, send them back to where they came.  Theoretically they</span>
<a name="l01822"></a>01822 <span class="comment">                  should have their original extensions and such, but we copy to be on the safe side */</span>
<a name="l01823"></a>01823                <a class="code" href="res__features_8c.html#9c0ecc5bd697a45c673ff75714458a83">set_c_e_p</a>(chan, pu-&gt;<a class="code" href="structparkeduser.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, pu-&gt;<a class="code" href="structparkeduser.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, pu-&gt;<a class="code" href="structparkeduser.html#b988295c268025b49dfb3df26171ddc3">priority</a>);
<a name="l01824"></a>01824             }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826             <a class="code" href="res__features_8c.html#fa5f88633ba5583d4a9ad6ac1ab18787">post_manager_event</a>(<span class="stringliteral">"ParkedCallTimeOut"</span>, pu);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) 
<a name="l01829"></a>01829                <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Timeout for %s parked on %d. Returning to %s,%s,%d\n"</span>, chan-&gt;name, pu-&gt;<a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a>, chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>);
<a name="l01830"></a>01830             <span class="comment">/* Start up the PBX, or hang them up */</span>
<a name="l01831"></a>01831             <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#c55e82ff3dabed89efd77f20209b1006">ast_pbx_start</a>(chan))  {
<a name="l01832"></a>01832                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to restart the PBX for user on '%s', hanging them up...\n"</span>, chan-&gt;name);
<a name="l01833"></a>01833                <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(chan);
<a name="l01834"></a>01834             }
<a name="l01835"></a>01835             <span class="comment">/* And take them out of the parking lot */</span>
<a name="l01836"></a>01836             <span class="keywordflow">if</span> (pl) 
<a name="l01837"></a>01837                pl-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01838"></a>01838             <span class="keywordflow">else</span>
<a name="l01839"></a>01839                parkinglot = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01840"></a>01840             pt = pu;
<a name="l01841"></a>01841             pu = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01842"></a>01842             con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l01843"></a>01843             <span class="keywordflow">if</span> (con) {
<a name="l01844"></a>01844                <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#c1d85c0d2ff75a7c476fa8379affd931">ast_context_remove_extension2</a>(con, pt-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, 1, NULL))
<a name="l01845"></a>01845                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, failed to remove the extension!\n"</span>);
<a name="l01846"></a>01846                <span class="keywordflow">else</span>
<a name="l01847"></a>01847                   <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(pt-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l01848"></a>01848             } <span class="keywordflow">else</span>
<a name="l01849"></a>01849                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, no parking context?\n"</span>);
<a name="l01850"></a>01850             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(pt);
<a name="l01851"></a>01851          } <span class="keywordflow">else</span> { <span class="comment">/* still within parking time, process descriptors */</span>
<a name="l01852"></a>01852             <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a>; x++) {
<a name="l01853"></a>01853                <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l01854"></a>01854 
<a name="l01855"></a>01855                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x] == -1 || (!FD_ISSET(chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x], &amp;rfds) &amp;&amp; !FD_ISSET(chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x], &amp;efds)))
<a name="l01856"></a>01856                   <span class="keywordflow">continue</span>;   <span class="comment">/* nothing on this descriptor */</span>
<a name="l01857"></a>01857 
<a name="l01858"></a>01858                <span class="keywordflow">if</span> (FD_ISSET(chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x], &amp;efds))
<a name="l01859"></a>01859                   <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l01860"></a>01860                <span class="keywordflow">else</span>
<a name="l01861"></a>01861                   <a class="code" href="utils_8h.html#c2399a33be6ffb658bcf7c6a35531732">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#68986ab776eb5d6b5a809a1c005a7300e16a5c3eb4b46399b147040658306ff5">AST_FLAG_EXCEPTION</a>);
<a name="l01862"></a>01862                chan-&gt;fdno = x;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                <span class="comment">/* See if they need servicing */</span>
<a name="l01865"></a>01865                f = <a class="code" href="channel_8c.html#1446a8c0bddf626bf26b000fbeae117f">ast_read</a>(chan);
<a name="l01866"></a>01866                <span class="keywordflow">if</span> (!f || (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> ==  <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3896a1de835fbf024ef925569eb775de67f">AST_CONTROL_HANGUP</a>)) {
<a name="l01867"></a>01867                   <span class="keywordflow">if</span> (f)
<a name="l01868"></a>01868                      <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01869"></a>01869                   <a class="code" href="res__features_8c.html#fa5f88633ba5583d4a9ad6ac1ab18787">post_manager_event</a>(<span class="stringliteral">"ParkedCallGiveUp"</span>, pu);
<a name="l01870"></a>01870 
<a name="l01871"></a>01871                   <span class="comment">/* There's a problem, hang them up*/</span>
<a name="l01872"></a>01872                   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 1) 
<a name="l01873"></a>01873                      <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"%s got tired of being parked\n"</span>, chan-&gt;name);
<a name="l01874"></a>01874                   <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(chan);
<a name="l01875"></a>01875                   <span class="comment">/* And take them out of the parking lot */</span>
<a name="l01876"></a>01876                   <span class="keywordflow">if</span> (pl) 
<a name="l01877"></a>01877                      pl-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01878"></a>01878                   <span class="keywordflow">else</span>
<a name="l01879"></a>01879                      parkinglot = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01880"></a>01880                   pt = pu;
<a name="l01881"></a>01881                   pu = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01882"></a>01882                   con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l01883"></a>01883                   <span class="keywordflow">if</span> (con) {
<a name="l01884"></a>01884                      <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#c1d85c0d2ff75a7c476fa8379affd931">ast_context_remove_extension2</a>(con, pt-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, 1, NULL))
<a name="l01885"></a>01885                         <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, failed to remove the extension!\n"</span>);
<a name="l01886"></a>01886                      <span class="keywordflow">else</span>
<a name="l01887"></a>01887                         <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(pt-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l01888"></a>01888                   } <span class="keywordflow">else</span>
<a name="l01889"></a>01889                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, no parking context?\n"</span>);
<a name="l01890"></a>01890                   <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(pt);
<a name="l01891"></a>01891                   <span class="keywordflow">break</span>;
<a name="l01892"></a>01892                } <span class="keywordflow">else</span> {<span class="comment"></span>
<a name="l01893"></a>01893 <span class="comment">                  /*! \todo XXX Maybe we could do something with packets, like dial "0" for operator or something XXX */</span>
<a name="l01894"></a>01894                   <a class="code" href="frame_8h.html#506c759ec4950e7f7465e8f090a6252b">ast_frfree</a>(f);
<a name="l01895"></a>01895                   <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#728bc02aa6dd2569cbf6a27a00659cbe">moh_trys</a> &lt; 3 &amp;&amp; !chan-&gt;generatordata) {
<a name="l01896"></a>01896                      <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01897"></a>01897                         <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"MOH on parked call stopped by outside source.  Restarting.\n"</span>);
<a name="l01898"></a>01898                      <a class="code" href="channel_8c.html#f1b18b170d0068311ca47c2e0d0ede5c">ast_indicate_data</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dcaa1b03a8c60073c53c1b662418697f">AST_CONTROL_HOLD</a>, 
<a name="l01899"></a>01899                         <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>, NULL),
<a name="l01900"></a>01900                         !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) ? strlen(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>) + 1 : 0);
<a name="l01901"></a>01901                      pu-&gt;<a class="code" href="structparkeduser.html#728bc02aa6dd2569cbf6a27a00659cbe">moh_trys</a>++;
<a name="l01902"></a>01902                   }
<a name="l01903"></a>01903                   <span class="keywordflow">goto</span> std;   <span class="comment">/*! \todo XXX Ick: jumping into an else statement??? XXX */</span>
<a name="l01904"></a>01904                }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906             } <span class="comment">/* end for */</span>
<a name="l01907"></a>01907             <span class="keywordflow">if</span> (x &gt;= <a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a>) {
<a name="l01908"></a>01908 std:              <span class="keywordflow">for</span> (x=0; x&lt;<a class="code" href="channel_8h.html#83204f17b88e7752d76b1a751a501a65">AST_MAX_FDS</a>; x++) {  <span class="comment">/* mark fds for next round */</span>
<a name="l01909"></a>01909                   <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x] &gt; -1) {
<a name="l01910"></a>01910                      FD_SET(chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x], &amp;nrfds);
<a name="l01911"></a>01911                      FD_SET(chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x], &amp;nefds);
<a name="l01912"></a>01912                      <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x] &gt; max)
<a name="l01913"></a>01913                         max = chan-&gt;<a class="code" href="structast__channel.html#33e8e7d77d33bb6375690c9b23527f82">fds</a>[x];
<a name="l01914"></a>01914                   }
<a name="l01915"></a>01915                }
<a name="l01916"></a>01916                <span class="comment">/* Keep track of our shortest wait */</span>
<a name="l01917"></a>01917                <span class="keywordflow">if</span> (tms &lt; ms || ms &lt; 0)
<a name="l01918"></a>01918                   ms = tms;
<a name="l01919"></a>01919                pl = pu;
<a name="l01920"></a>01920                pu = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01921"></a>01921             }
<a name="l01922"></a>01922          }
<a name="l01923"></a>01923       } <span class="comment">/* end while */</span>
<a name="l01924"></a>01924       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l01925"></a>01925       rfds = nrfds;
<a name="l01926"></a>01926       efds = nefds;
<a name="l01927"></a>01927       {
<a name="l01928"></a>01928          <span class="keyword">struct </span>timeval tv = ast_samp2tv(ms, 1000);
<a name="l01929"></a>01929          <span class="comment">/* Wait for something to happen */</span>
<a name="l01930"></a>01930          <a class="code" href="channel_8h.html#d611a8ad6ce8c46f46f564095af0f264">ast_select</a>(max + 1, &amp;rfds, NULL, &amp;efds, (ms &gt; -1) ? &amp;tv : NULL);
<a name="l01931"></a>01931       }
<a name="l01932"></a>01932       pthread_testcancel();
<a name="l01933"></a>01933    }
<a name="l01934"></a>01934    <span class="keywordflow">return</span> NULL;   <span class="comment">/* Never reached */</span>
<a name="l01935"></a>01935 }
<a name="l01936"></a>01936 <span class="comment"></span>
<a name="l01937"></a>01937 <span class="comment">/*! \brief Park a call */</span>
<a name="l01938"></a><a class="code" href="res__features_8c.html#304e90ce99e65886b32d545331b0688b">01938</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#304e90ce99e65886b32d545331b0688b">park_call_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l01939"></a>01939 {
<a name="l01940"></a>01940    <span class="comment">/* Data is unused at the moment but could contain a parking</span>
<a name="l01941"></a>01941 <span class="comment">      lot context eventually */</span>
<a name="l01942"></a>01942    <span class="keywordtype">int</span> res = 0;
<a name="l01943"></a>01943    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945    u = <a class="code" href="module_8h.html#01229151b3816d7323f7460fef4305c3">ast_module_user_add</a>(chan);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <span class="comment">/* Setup the exten/priority to be s/1 since we don't know</span>
<a name="l01948"></a>01948 <span class="comment">      where this call should return */</span>
<a name="l01949"></a>01949    strcpy(chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, <span class="stringliteral">"s"</span>);
<a name="l01950"></a>01950    chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> = 1;
<a name="l01951"></a>01951    <span class="comment">/* Answer if call is not up */</span>
<a name="l01952"></a>01952    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l01953"></a>01953       res = <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan);
<a name="l01954"></a>01954    <span class="comment">/* Sleep to allow VoIP streams to settle down */</span>
<a name="l01955"></a>01955    <span class="keywordflow">if</span> (!res)
<a name="l01956"></a>01956       res = <a class="code" href="channel_8c.html#24a36b04429e3cdef17e161363c13900">ast_safe_sleep</a>(chan, 1000);
<a name="l01957"></a>01957    <span class="comment">/* Park the call */</span>
<a name="l01958"></a>01958    <span class="keywordflow">if</span> (!res)
<a name="l01959"></a>01959       res = <a class="code" href="features_8h.html#c9d53b3e6972e1cb4fd0153b648e204a">ast_park_call</a>(chan, chan, 0, NULL);
<a name="l01960"></a>01960 
<a name="l01961"></a>01961    <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l01962"></a>01962 
<a name="l01963"></a>01963    <span class="keywordflow">return</span> !res ? <a class="code" href="pbx_8h.html#60ed4b0965b6f9aa117240879d402201">AST_PBX_KEEPALIVE</a> : res;
<a name="l01964"></a>01964 }
<a name="l01965"></a>01965 <span class="comment"></span>
<a name="l01966"></a>01966 <span class="comment">/*! \brief Pickup parked call */</span>
<a name="l01967"></a><a class="code" href="res__features_8c.html#e0bf626041a7d438d7fdb4f3e667dca1">01967</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#e0bf626041a7d438d7fdb4f3e667dca1">park_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l01968"></a>01968 {
<a name="l01969"></a>01969    <span class="keywordtype">int</span> res = 0;
<a name="l01970"></a>01970    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l01971"></a>01971    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *peer=NULL;
<a name="l01972"></a>01972    <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *pu, *pl=NULL;
<a name="l01973"></a>01973    <span class="keyword">struct </span><a class="code" href="structast__context.html">ast_context</a> *con;
<a name="l01974"></a>01974 
<a name="l01975"></a>01975    <span class="keywordtype">int</span> park;
<a name="l01976"></a>01976    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html">ast_bridge_config</a> config;
<a name="l01977"></a>01977 
<a name="l01978"></a>01978    <span class="keywordflow">if</span> (!data) {
<a name="l01979"></a>01979       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Parkedcall requires an argument (extension number)\n"</span>);
<a name="l01980"></a>01980       <span class="keywordflow">return</span> -1;
<a name="l01981"></a>01981    }
<a name="l01982"></a>01982    
<a name="l01983"></a>01983    u = <a class="code" href="module_8h.html#01229151b3816d7323f7460fef4305c3">ast_module_user_add</a>(chan);
<a name="l01984"></a>01984 
<a name="l01985"></a>01985    park = atoi((<span class="keywordtype">char</span> *)data);
<a name="l01986"></a>01986    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;parking_lock);
<a name="l01987"></a>01987    pu = parkinglot;
<a name="l01988"></a>01988    <span class="keywordflow">while</span>(pu) {
<a name="l01989"></a>01989       <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a> == park) {
<a name="l01990"></a>01990          <span class="keywordflow">if</span> (pl)
<a name="l01991"></a>01991             pl-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01992"></a>01992          <span class="keywordflow">else</span>
<a name="l01993"></a>01993             parkinglot = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01994"></a>01994          <span class="keywordflow">break</span>;
<a name="l01995"></a>01995       }
<a name="l01996"></a>01996       pl = pu;
<a name="l01997"></a>01997       pu = pu-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01998"></a>01998    }
<a name="l01999"></a>01999    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l02000"></a>02000    <span class="keywordflow">if</span> (pu) {
<a name="l02001"></a>02001       peer = pu-&gt;chan;
<a name="l02002"></a>02002       con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l02003"></a>02003       <span class="keywordflow">if</span> (con) {
<a name="l02004"></a>02004          <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#c1d85c0d2ff75a7c476fa8379affd931">ast_context_remove_extension2</a>(con, pu-&gt;parkingexten, 1, NULL))
<a name="l02005"></a>02005             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, failed to remove the extension!\n"</span>);
<a name="l02006"></a>02006          <span class="keywordflow">else</span>
<a name="l02007"></a>02007             <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(pu-&gt;parkingexten, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l02008"></a>02008       } <span class="keywordflow">else</span>
<a name="l02009"></a>02009          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Whoa, no parking context?\n"</span>);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"UnParkedCall"</span>,
<a name="l02012"></a>02012          <span class="stringliteral">"Exten: %s\r\n"</span>
<a name="l02013"></a>02013          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l02014"></a>02014          <span class="stringliteral">"From: %s\r\n"</span>
<a name="l02015"></a>02015          <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l02016"></a>02016          <span class="stringliteral">"CallerIDName: %s\r\n"</span>,
<a name="l02017"></a>02017          pu-&gt;parkingexten, pu-&gt;chan-&gt;name, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name,
<a name="l02018"></a>02018          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;chan-&gt;cid.cid_num, <span class="stringliteral">"&lt;unknown&gt;"</span>),
<a name="l02019"></a>02019          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(pu-&gt;chan-&gt;cid.cid_name, <span class="stringliteral">"&lt;unknown&gt;"</span>)
<a name="l02020"></a>02020          );
<a name="l02021"></a>02021 
<a name="l02022"></a>02022       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(pu);
<a name="l02023"></a>02023    }
<a name="l02024"></a>02024    <span class="comment">/* JK02: it helps to answer the channel if not already up */</span>
<a name="l02025"></a>02025    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l02026"></a>02026       <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028    <span class="keywordflow">if</span> (peer) {
<a name="l02029"></a>02029       <span class="comment">/* Play a courtesy to the source(s) configured to prefix the bridge connecting */</span>
<a name="l02030"></a>02030       
<a name="l02031"></a>02031       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>)) {
<a name="l02032"></a>02032          <span class="keywordtype">int</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a> = 0;
<a name="l02033"></a>02033          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(peer, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>);
<a name="l02034"></a>02034          <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> == 0) {
<a name="l02035"></a>02035             error = <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, <span class="stringliteral">""</span>);
<a name="l02036"></a>02036          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> == 1) {
<a name="l02037"></a>02037             error = <a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(peer, <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, <span class="stringliteral">""</span>);
<a name="l02038"></a>02038          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> == 2) {
<a name="l02039"></a>02039             <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;language) &amp;&amp;
<a name="l02040"></a>02040                   !<a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(peer, <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;language)) {<span class="comment"></span>
<a name="l02041"></a>02041 <span class="comment">               /*! \todo XXX we would like to wait on both! */</span>
<a name="l02042"></a>02042                res = <a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="stringliteral">""</span>);
<a name="l02043"></a>02043                <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l02044"></a>02044                   res = <a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(peer, <span class="stringliteral">""</span>);
<a name="l02045"></a>02045                <span class="keywordflow">if</span> (res &lt; 0)
<a name="l02046"></a>02046                   error = 1;
<a name="l02047"></a>02047             }
<a name="l02048"></a>02048                         }
<a name="l02049"></a>02049          <span class="keywordflow">if</span> (error) {
<a name="l02050"></a>02050             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play courtesy tone!\n"</span>);
<a name="l02051"></a>02051             <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(peer);
<a name="l02052"></a>02052             <span class="keywordflow">return</span> -1;
<a name="l02053"></a>02053          }
<a name="l02054"></a>02054       } <span class="keywordflow">else</span>
<a name="l02055"></a>02055          <a class="code" href="channel_8c.html#90b88ba4c6f05bc0b655583c899c0269">ast_indicate</a>(peer, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389582c81bc89b064f8093864a6c023a823">AST_CONTROL_UNHOLD</a>); 
<a name="l02056"></a>02056 
<a name="l02057"></a>02057       res = <a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, peer);
<a name="l02058"></a>02058       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02059"></a>02059          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not make channels %s and %s compatible for bridge\n"</span>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name, peer-&gt;name);
<a name="l02060"></a>02060          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(peer);
<a name="l02061"></a>02061          <span class="keywordflow">return</span> -1;
<a name="l02062"></a>02062       }
<a name="l02063"></a>02063       <span class="comment">/* This runs sorta backwards, since we give the incoming channel control, as if it</span>
<a name="l02064"></a>02064 <span class="comment">         were the person called. */</span>
<a name="l02065"></a>02065       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l02066"></a>02066          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Channel %s connected to parked call %d\n"</span>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name, park);
<a name="l02067"></a>02067 
<a name="l02068"></a>02068       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="stringliteral">"PARKEDCHANNEL"</span>, peer-&gt;name);
<a name="l02069"></a>02069       <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, peer-&gt;name);
<a name="l02070"></a>02070       memset(&amp;<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html">ast_bridge_config</a>));
<a name="l02071"></a>02071       <span class="keywordflow">if</span> ((<a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>) || (<a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>))
<a name="l02072"></a>02072          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>.features_callee), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>);
<a name="l02073"></a>02073       <span class="keywordflow">if</span> ((<a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>) || (<a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>))
<a name="l02074"></a>02074          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>.features_caller), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d06d1225b2615ed409be56bda96c5b71b9">AST_FEATURE_REDIRECT</a>);
<a name="l02075"></a>02075       <span class="keywordflow">if</span> ((<a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>) || (<a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>))
<a name="l02076"></a>02076          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>.features_callee), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d0bc5c3869d149426e287f8f773f8d3f38">AST_FEATURE_PARKCALL</a>);
<a name="l02077"></a>02077       <span class="keywordflow">if</span> ((<a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>) || (<a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> == <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>))
<a name="l02078"></a>02078          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(&amp;(<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>.features_caller), <a class="code" href="channel_8h.html#02653d87b6fa8554fc0d1a3726fea2d0bc5c3869d149426e287f8f773f8d3f38">AST_FEATURE_PARKCALL</a>);
<a name="l02079"></a>02079       res = <a class="code" href="features_8h.html#61263ca8af831dbacdf11ec96ed61076">ast_bridge_call</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, peer, &amp;<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>);
<a name="l02080"></a>02080 
<a name="l02081"></a>02081       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="stringliteral">"PARKEDCHANNEL"</span>, peer-&gt;name);
<a name="l02082"></a>02082       <a class="code" href="cdr_8c.html#56172e6c8989e2325ed4c47c3d03f1fc">ast_cdr_setdestchan</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a>, peer-&gt;name);
<a name="l02083"></a>02083 
<a name="l02084"></a>02084       <span class="comment">/* Simulate the PBX hanging up */</span>
<a name="l02085"></a>02085       <span class="keywordflow">if</span> (res != <a class="code" href="pbx_8h.html#5e2459a77c1072ded5128a9c607a9e95">AST_PBX_NO_HANGUP_PEER</a>)
<a name="l02086"></a>02086          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(peer);
<a name="l02087"></a>02087       <span class="keywordflow">return</span> res;
<a name="l02088"></a>02088    } <span class="keywordflow">else</span> {<span class="comment"></span>
<a name="l02089"></a>02089 <span class="comment">      /*! \todo XXX Play a message XXX */</span>
<a name="l02090"></a>02090       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#65052c94377323821185d04e2600dda2">ast_stream_and_wait</a>(<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="stringliteral">"pbx-invalidpark"</span>, <span class="stringliteral">""</span>))
<a name="l02091"></a>02091          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"ast_streamfile of %s failed on %s\n"</span>, <span class="stringliteral">"pbx-invalidpark"</span>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name);
<a name="l02092"></a>02092       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2) 
<a name="l02093"></a>02093          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Channel %s tried to talk to nonexistent parked call %d\n"</span>, <a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name, park);
<a name="l02094"></a>02094       res = -1;
<a name="l02095"></a>02095    }
<a name="l02096"></a>02096 
<a name="l02097"></a>02097    <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02098"></a>02098 
<a name="l02099"></a>02099    <span class="keywordflow">return</span> res;
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a><a class="code" href="res__features_8c.html#69aa0cf162d3e6608771251b0b6eb82d">02102</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#69aa0cf162d3e6608771251b0b6eb82d">handle_showfeatures</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02103"></a>02103 {
<a name="l02104"></a>02104    <span class="keywordtype">int</span> i;
<a name="l02105"></a>02105    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l02106"></a>02106    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>[] = <span class="stringliteral">"%-25s %-7s %-7s\n"</span>;
<a name="l02107"></a>02107 
<a name="l02108"></a>02108    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"Builtin Feature"</span>, <span class="stringliteral">"Default"</span>, <span class="stringliteral">"Current"</span>);
<a name="l02109"></a>02109    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"---------------"</span>, <span class="stringliteral">"-------"</span>, <span class="stringliteral">"-------"</span>);
<a name="l02110"></a>02110 
<a name="l02111"></a>02111    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"Pickup"</span>, <span class="stringliteral">"*8"</span>, <a class="code" href="features_8h.html#907f86dbd402c7f215ba3047f8c54a94">ast_pickup_ext</a>());      <span class="comment">/* default hardcoded above, so we'll hardcode it here */</span>
<a name="l02112"></a>02112 
<a name="l02113"></a>02113    <a class="code" href="lock_8h.html#f4b8158bcd471d4f28b380768e3ee073">ast_rwlock_rdlock</a>(&amp;features_lock);
<a name="l02114"></a>02114    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="res__features_8c.html#2d0d4837f1493a92f80f074c81a7a9fb">FEATURES_COUNT</a>; i++)
<a name="l02115"></a>02115       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, builtin_features[i].<a class="code" href="structast__call__feature.html#a3da707b651c79ecc39a4986516180b2">fname</a>, builtin_features[i].<a class="code" href="structast__call__feature.html#8fe5a6b801adf62f1abf4ed2becee891">default_exten</a>, builtin_features[i].<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>);
<a name="l02116"></a>02116    <a class="code" href="lock_8h.html#97ed909ef0a0582cf3870dd0629852c8">ast_rwlock_unlock</a>(&amp;features_lock);
<a name="l02117"></a>02117 
<a name="l02118"></a>02118    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\n"</span>);
<a name="l02119"></a>02119    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"Dynamic Feature"</span>, <span class="stringliteral">"Default"</span>, <span class="stringliteral">"Current"</span>);
<a name="l02120"></a>02120    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, <span class="stringliteral">"---------------"</span>, <span class="stringliteral">"-------"</span>, <span class="stringliteral">"-------"</span>);
<a name="l02121"></a>02121    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;feature_list))
<a name="l02122"></a>02122       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"(none)\n"</span>);
<a name="l02123"></a>02123    <span class="keywordflow">else</span> {
<a name="l02124"></a>02124       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l02125"></a>02125       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;feature_list, feature, feature_entry)
<a name="l02126"></a>02126          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, format, feature-&gt;<a class="code" href="structast__call__feature.html#d16edd3fe2bbc564136da7d1e79586df">sname</a>, <span class="stringliteral">"no def"</span>, feature-&gt;<a class="code" href="structast__call__feature.html#c4e1c560a6e8d177b293258ab07bf352">exten</a>); 
<a name="l02127"></a>02127       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l02128"></a>02128    }
<a name="l02129"></a>02129    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\nCall parking\n"</span>);
<a name="l02130"></a>02130    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"------------\n"</span>);
<a name="l02131"></a>02131    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"%-20s:   %s\n"</span>, <span class="stringliteral">"Parking extension"</span>, <a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>);
<a name="l02132"></a>02132    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"%-20s:   %s\n"</span>, <span class="stringliteral">"Parking context"</span>, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l02133"></a>02133    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"%-20s:   %d-%d\n"</span>, <span class="stringliteral">"Parked call extensions"</span>, <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a>, <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a>);
<a name="l02134"></a>02134    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"\n"</span>);
<a name="l02135"></a>02135    
<a name="l02136"></a>02136    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l02137"></a>02137 }
<a name="l02138"></a>02138 
<a name="l02139"></a><a class="code" href="res__features_8c.html#e76a3b7d237bff25a01a5b80a573fd66">02139</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#e76a3b7d237bff25a01a5b80a573fd66">mandescr_bridge</a>[] =
<a name="l02140"></a>02140 <span class="stringliteral">"Description: Bridge together two channels already in the PBX\n"</span>
<a name="l02141"></a>02141 <span class="stringliteral">"Variables: ( Headers marked with * are required )\n"</span>
<a name="l02142"></a>02142 <span class="stringliteral">"   *Channel1: Channel to Bridge to Channel2\n"</span>
<a name="l02143"></a>02143 <span class="stringliteral">"   *Channel2: Channel to Bridge to Channel1\n"</span>
<a name="l02144"></a>02144 <span class="stringliteral">"        Tone: (Yes|No) Play courtesy tone to Channel 2\n"</span>
<a name="l02145"></a>02145 <span class="stringliteral">"\n"</span>;
<a name="l02146"></a>02146 
<a name="l02147"></a><a class="code" href="res__features_8c.html#0ccd3c45d8833ebc992808719746985c">02147</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#0ccd3c45d8833ebc992808719746985c">do_bridge_masquerade</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *tmpchan)
<a name="l02148"></a>02148 {
<a name="l02149"></a>02149    <a class="code" href="channel_8c.html#db35d3bab46e0655f359b751cdca0ce3">ast_moh_stop</a>(chan);
<a name="l02150"></a>02150    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02151"></a>02151    <a class="code" href="channel_8c.html#c3e562760bdf7c23ebd561ce1352399e">ast_setstate</a>(tmpchan, chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a>);
<a name="l02152"></a>02152    tmpchan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a> = chan-&gt;<a class="code" href="structast__channel.html#c9d2702466074da94d21f26822247ed8">readformat</a>;
<a name="l02153"></a>02153    tmpchan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a> = chan-&gt;<a class="code" href="structast__channel.html#45a38ca474a4f1df88fe13d68bbb0b44">writeformat</a>;
<a name="l02154"></a>02154    <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(tmpchan, chan);
<a name="l02155"></a>02155    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;tmpchan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02156"></a>02156    <a class="code" href="channel_8c.html#f788595bd51a58be12bb3c3b28a950ec">ast_do_masquerade</a>(tmpchan);
<a name="l02157"></a>02157    <span class="comment">/* when returning from bridge, the channel will continue at the next priority */</span>
<a name="l02158"></a>02158    <a class="code" href="pbx_8c.html#1e0079c7f2934dd7ebe801fefe4057da">ast_explicit_goto</a>(tmpchan, chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a> + 1);
<a name="l02159"></a>02159    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;tmpchan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02160"></a>02160    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02161"></a>02161 }
<a name="l02162"></a>02162 
<a name="l02163"></a><a class="code" href="res__features_8c.html#400db228c82f0ac94aea507e1eaa2e5c">02163</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#400db228c82f0ac94aea507e1eaa2e5c">action_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02164"></a>02164 {
<a name="l02165"></a>02165    <span class="keyword">const</span> <span class="keywordtype">char</span> *channela = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel1"</span>);
<a name="l02166"></a>02166    <span class="keyword">const</span> <span class="keywordtype">char</span> *channelb = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel2"</span>);
<a name="l02167"></a>02167    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__morsecode_8c.html#10fe3def2af3c2c57ec5d7f4bf668a37">playtone</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Tone"</span>);
<a name="l02168"></a>02168    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *chana = NULL, *chanb = NULL;
<a name="l02169"></a>02169    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *tmpchana = NULL, *tmpchanb = NULL;
<a name="l02170"></a>02170    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj = NULL;
<a name="l02171"></a>02171 
<a name="l02172"></a>02172    <span class="comment">/* make sure valid channels were specified */</span>
<a name="l02173"></a>02173    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(channela) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(channelb)) {
<a name="l02174"></a>02174       chana = <a class="code" href="channel_8c.html#73dcef78b8c7fc8cb85dde3ee0058c57">ast_get_channel_by_name_prefix_locked</a>(channela, strlen(channela));
<a name="l02175"></a>02175       chanb = <a class="code" href="channel_8c.html#73dcef78b8c7fc8cb85dde3ee0058c57">ast_get_channel_by_name_prefix_locked</a>(channelb, strlen(channelb));
<a name="l02176"></a>02176       <span class="keywordflow">if</span> (chana)
<a name="l02177"></a>02177          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chana-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02178"></a>02178       <span class="keywordflow">if</span> (chanb)
<a name="l02179"></a>02179          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;chanb-&gt;lock);
<a name="l02180"></a>02180 
<a name="l02181"></a>02181       <span class="comment">/* send errors if any of the channels could not be found/locked */</span>
<a name="l02182"></a>02182       <span class="keywordflow">if</span> (!chana) {
<a name="l02183"></a>02183          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[256];
<a name="l02184"></a>02184          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"Channel1 does not exists: %s"</span>, channela);
<a name="l02185"></a>02185          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, buf);
<a name="l02186"></a>02186          <span class="keywordflow">return</span> 0;
<a name="l02187"></a>02187       }
<a name="l02188"></a>02188       <span class="keywordflow">if</span> (!chanb) {
<a name="l02189"></a>02189          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[256];
<a name="l02190"></a>02190          snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"Channel2 does not exists: %s"</span>, channelb);
<a name="l02191"></a>02191          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, buf);
<a name="l02192"></a>02192          <span class="keywordflow">return</span> 0;
<a name="l02193"></a>02193       }
<a name="l02194"></a>02194    } <span class="keywordflow">else</span> {
<a name="l02195"></a>02195       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Missing channel parameter in request"</span>);
<a name="l02196"></a>02196       <span class="keywordflow">return</span> 0;
<a name="l02197"></a>02197    }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199    <span class="comment">/* Answer the channels if needed */</span>
<a name="l02200"></a>02200    <span class="keywordflow">if</span> (chana-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l02201"></a>02201       <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chana);
<a name="l02202"></a>02202    <span class="keywordflow">if</span> (chanb-&gt;_state != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l02203"></a>02203       <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chanb);
<a name="l02204"></a>02204 
<a name="l02205"></a>02205    <span class="comment">/* create the placeholder channels and grab the other channels */</span>
<a name="l02206"></a>02206    <span class="keywordflow">if</span> (!(tmpchana = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l02207"></a>02207       NULL, NULL, 0, <span class="stringliteral">"Bridge/%s"</span>, chana-&gt;name))) {
<a name="l02208"></a>02208       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Unable to create temporary channel!"</span>);
<a name="l02209"></a>02209       <span class="keywordflow">return</span> 1;
<a name="l02210"></a>02210    }
<a name="l02211"></a>02211 
<a name="l02212"></a>02212    <span class="keywordflow">if</span> (!(tmpchanb = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l02213"></a>02213       NULL, NULL, 0, <span class="stringliteral">"Bridge/%s"</span>, chanb-&gt;name))) {
<a name="l02214"></a>02214       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Unable to create temporary channels!"</span>);
<a name="l02215"></a>02215       <a class="code" href="channel_8c.html#230a804b09060fecdf699c2c9613fff7">ast_channel_free</a>(tmpchana);
<a name="l02216"></a>02216       <span class="keywordflow">return</span> 1;
<a name="l02217"></a>02217    }
<a name="l02218"></a>02218 
<a name="l02219"></a>02219    <a class="code" href="res__features_8c.html#0ccd3c45d8833ebc992808719746985c">do_bridge_masquerade</a>(chana, tmpchana);
<a name="l02220"></a>02220    <a class="code" href="res__features_8c.html#0ccd3c45d8833ebc992808719746985c">do_bridge_masquerade</a>(chanb, tmpchanb);
<a name="l02221"></a>02221    
<a name="l02222"></a>02222    <span class="comment">/* make the channels compatible, send error if we fail doing so */</span>
<a name="l02223"></a>02223    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(tmpchana, tmpchanb)) {
<a name="l02224"></a>02224       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not make channels %s and %s compatible for manager bridge\n"</span>, tmpchana-&gt;name, tmpchanb-&gt;name);
<a name="l02225"></a>02225       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Could not make channels compatible for manager bridge"</span>);
<a name="l02226"></a>02226       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tmpchana);
<a name="l02227"></a>02227       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tmpchanb);
<a name="l02228"></a>02228       <span class="keywordflow">return</span> 1;
<a name="l02229"></a>02229    }
<a name="l02230"></a>02230 
<a name="l02231"></a>02231    <span class="comment">/* setup the bridge thread object and start the bridge */</span>
<a name="l02232"></a>02232    <span class="keywordflow">if</span> (!(tobj = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l02233"></a>02233       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to spawn a new bridge thread on %s and %s: %s\n"</span>, tmpchana-&gt;name, tmpchanb-&gt;name, strerror(errno));
<a name="l02234"></a>02234       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Unable to spawn a new bridge thread"</span>);
<a name="l02235"></a>02235       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tmpchana);
<a name="l02236"></a>02236       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(tmpchanb);
<a name="l02237"></a>02237       <span class="keywordflow">return</span> 1;
<a name="l02238"></a>02238    }
<a name="l02239"></a>02239 
<a name="l02240"></a>02240    tobj-&gt;chan = tmpchana;
<a name="l02241"></a>02241    tobj-&gt;peer = tmpchanb;
<a name="l02242"></a>02242    tobj-&gt;return_to_pbx = 1;
<a name="l02243"></a>02243    
<a name="l02244"></a>02244    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(playtone)) {
<a name="l02245"></a>02245       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>) &amp;&amp; !<a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(tmpchanb, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, tmpchanb-&gt;language)) {
<a name="l02246"></a>02246          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(tmpchanb, <span class="stringliteral">""</span>) &lt; 0)
<a name="l02247"></a>02247             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play a courtesy tone on chan %s\n"</span>, tmpchanb-&gt;name);
<a name="l02248"></a>02248       }
<a name="l02249"></a>02249    }
<a name="l02250"></a>02250 
<a name="l02251"></a>02251    <a class="code" href="res__features_8c.html#154203f487a3163df7709494f6c89372">ast_bridge_call_thread_launch</a>(tobj);
<a name="l02252"></a>02252 
<a name="l02253"></a>02253    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Launched bridge thread with success"</span>);
<a name="l02254"></a>02254 
<a name="l02255"></a>02255    <span class="keywordflow">return</span> 0;
<a name="l02256"></a>02256 }
<a name="l02257"></a>02257 
<a name="l02258"></a><a class="code" href="res__features_8c.html#5252f4f12d19f83a1aa53b535e76c477">02258</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#5252f4f12d19f83a1aa53b535e76c477">showfeatures_help</a>[] =
<a name="l02259"></a>02259 <span class="stringliteral">"Usage: feature list\n"</span>
<a name="l02260"></a>02260 <span class="stringliteral">"       Lists currently configured features.\n"</span>;
<a name="l02261"></a>02261 
<a name="l02262"></a><a class="code" href="res__features_8c.html#a687dfae79ee5dacfabc51b62cb19b9e">02262</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#a687dfae79ee5dacfabc51b62cb19b9e">handle_parkedcalls</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02263"></a>02263 {
<a name="l02264"></a>02264    <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *cur;
<a name="l02265"></a>02265    <span class="keywordtype">int</span> numparked = 0;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%4s %25s (%-15s %-12s %-4s) %-6s \n"</span>, <span class="stringliteral">"Num"</span>, <span class="stringliteral">"Channel"</span>
<a name="l02268"></a>02268       , <span class="stringliteral">"Context"</span>, <span class="stringliteral">"Extension"</span>, <span class="stringliteral">"Pri"</span>, <span class="stringliteral">"Timeout"</span>);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;parking_lock);
<a name="l02271"></a>02271 
<a name="l02272"></a>02272    <span class="keywordflow">for</span> (cur = parkinglot; cur; cur = cur-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02273"></a>02273       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%-10.10s %25s (%-15s %-12s %-4d) %6lds\n"</span>
<a name="l02274"></a>02274          ,cur-&gt;<a class="code" href="structparkeduser.html#a520becf30f3f6dac99c717edd01c963">parkingexten</a>, cur-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name, cur-&gt;<a class="code" href="structparkeduser.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, cur-&gt;<a class="code" href="structparkeduser.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>
<a name="l02275"></a>02275          ,cur-&gt;<a class="code" href="structparkeduser.html#b988295c268025b49dfb3df26171ddc3">priority</a>, cur-&gt;<a class="code" href="structparkeduser.html#ea2b2676c28c0db26d39331a336c6b92">start</a>.tv_sec + (cur-&gt;<a class="code" href="structparkeduser.html#c700875891439809b350a5e629558902">parkingtime</a>/1000) - time(NULL));
<a name="l02276"></a>02276 
<a name="l02277"></a>02277       numparked++;
<a name="l02278"></a>02278    }
<a name="l02279"></a>02279    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l02280"></a>02280    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%d parked call%s.\n"</span>, numparked, <a class="code" href="cli_8h.html#9f130886d424a4c673e63f0d0f3b0086">ESS</a>(numparked));
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 
<a name="l02283"></a>02283    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l02284"></a>02284 }
<a name="l02285"></a>02285 
<a name="l02286"></a><a class="code" href="res__features_8c.html#6892001d77f6a35d550d599ce0af3396">02286</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#6892001d77f6a35d550d599ce0af3396">showparked_help</a>[] =
<a name="l02287"></a>02287 <span class="stringliteral">"Usage: show parkedcalls\n"</span>
<a name="l02288"></a>02288 <span class="stringliteral">"       Lists currently parked calls.\n"</span>;
<a name="l02289"></a>02289 
<a name="l02290"></a><a class="code" href="res__features_8c.html#da677dcd520a48bfdd4b29f2cdf19f46">02290</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> cli_features[] = {
<a name="l02291"></a>02291    { { <span class="stringliteral">"feature"</span>, <span class="stringliteral">"show"</span>, NULL },
<a name="l02292"></a>02292    <a class="code" href="res__features_8c.html#69aa0cf162d3e6608771251b0b6eb82d">handle_showfeatures</a>, <span class="stringliteral">"Lists configured features"</span>,
<a name="l02293"></a>02293    showfeatures_help },
<a name="l02294"></a>02294 
<a name="l02295"></a>02295    { { <span class="stringliteral">"show"</span>, <span class="stringliteral">"parkedcalls"</span>, NULL },
<a name="l02296"></a>02296    <a class="code" href="res__features_8c.html#a687dfae79ee5dacfabc51b62cb19b9e">handle_parkedcalls</a>, <span class="stringliteral">"Lists parked calls"</span>,
<a name="l02297"></a>02297    showparked_help },
<a name="l02298"></a>02298 };
<a name="l02299"></a>02299 <span class="comment"></span>
<a name="l02300"></a>02300 <span class="comment">/*! \brief Dump lot status */</span>
<a name="l02301"></a><a class="code" href="res__features_8c.html#a760944ed197d622dbdc5da62e1a410b">02301</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#a760944ed197d622dbdc5da62e1a410b">manager_parking_status</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02302"></a>02302 {
<a name="l02303"></a>02303    <span class="keyword">struct </span><a class="code" href="structparkeduser.html">parkeduser</a> *cur;
<a name="l02304"></a>02304    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"ActionID"</span>);
<a name="l02305"></a>02305    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">""</span>;
<a name="l02306"></a>02306 
<a name="l02307"></a>02307    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l02308"></a>02308       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">"ActionID: %s\r\n"</span>, <span class="keywordtype">id</span>);
<a name="l02309"></a>02309 
<a name="l02310"></a>02310    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Parked calls will follow"</span>);
<a name="l02311"></a>02311 
<a name="l02312"></a>02312    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;parking_lock);
<a name="l02313"></a>02313 
<a name="l02314"></a>02314    <span class="keywordflow">for</span> (cur = parkinglot; cur; cur = cur-&gt;<a class="code" href="structparkeduser.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02315"></a>02315       <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s, <span class="stringliteral">"Event: ParkedCall\r\n"</span>
<a name="l02316"></a>02316          <span class="stringliteral">"Exten: %d\r\n"</span>
<a name="l02317"></a>02317          <span class="stringliteral">"Channel: %s\r\n"</span>
<a name="l02318"></a>02318          <span class="stringliteral">"From: %s\r\n"</span>
<a name="l02319"></a>02319          <span class="stringliteral">"Timeout: %ld\r\n"</span>
<a name="l02320"></a>02320          <span class="stringliteral">"CallerIDNum: %s\r\n"</span>
<a name="l02321"></a>02321          <span class="stringliteral">"CallerIDName: %s\r\n"</span>
<a name="l02322"></a>02322          <span class="stringliteral">"%s"</span>
<a name="l02323"></a>02323          <span class="stringliteral">"\r\n"</span>,
<a name="l02324"></a>02324          cur-&gt;<a class="code" href="structparkeduser.html#6828d3299306abfba7f2e37a88f79a86">parkingnum</a>, cur-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;name, cur-&gt;<a class="code" href="structparkeduser.html#c918796d8b2a501b03d3814d1d2c7a0e">peername</a>,
<a name="l02325"></a>02325          (<span class="keywordtype">long</span>) cur-&gt;<a class="code" href="structparkeduser.html#ea2b2676c28c0db26d39331a336c6b92">start</a>.tv_sec + (<span class="keywordtype">long</span>) (cur-&gt;<a class="code" href="structparkeduser.html#c700875891439809b350a5e629558902">parkingtime</a> / 1000) - (<span class="keywordtype">long</span>) time(NULL),
<a name="l02326"></a>02326          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(cur-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#64191918d2ec3d68a26f486c5d134221">cid_num</a>, <span class="stringliteral">""</span>),   <span class="comment">/* XXX in other places it is &lt;unknown&gt; */</span>
<a name="l02327"></a>02327          <a class="code" href="strings_8h.html#a5b939153ec133be2de0e3647df143f4">S_OR</a>(cur-&gt;<a class="code" href="structparkeduser.html#26c322652770620e64ac90682eb6504c">chan</a>-&gt;<a class="code" href="structast__channel.html#4b7cc5694dd3a265bac326eaba31266e">cid</a>.<a class="code" href="structast__callerid.html#51ae63e8ccffb05b130f96cc397ec7b0">cid_name</a>, <span class="stringliteral">""</span>),
<a name="l02328"></a>02328          idText);
<a name="l02329"></a>02329    }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331    <a class="code" href="group__Group__AMI.html#gb743ac558357307ea2fdd322561e371b">astman_append</a>(s,
<a name="l02332"></a>02332       <span class="stringliteral">"Event: ParkedCallsComplete\r\n"</span>
<a name="l02333"></a>02333       <span class="stringliteral">"%s"</span>
<a name="l02334"></a>02334       <span class="stringliteral">"\r\n"</span>,idText);
<a name="l02335"></a>02335 
<a name="l02336"></a>02336    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;parking_lock);
<a name="l02337"></a>02337 
<a name="l02338"></a>02338    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l02339"></a>02339 }
<a name="l02340"></a>02340 
<a name="l02341"></a><a class="code" href="res__features_8c.html#2c0601910ca6c1327b2aa9d2735245c0">02341</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__features_8c.html#2c0601910ca6c1327b2aa9d2735245c0">mandescr_park</a>[] =
<a name="l02342"></a>02342 <span class="stringliteral">"Description: Park a channel.\n"</span>
<a name="l02343"></a>02343 <span class="stringliteral">"Variables: (Names marked with * are required)\n"</span>
<a name="l02344"></a>02344 <span class="stringliteral">"  *Channel: Channel name to park\n"</span>
<a name="l02345"></a>02345 <span class="stringliteral">"  *Channel2: Channel to announce park info to (and return to if timeout)\n"</span>
<a name="l02346"></a>02346 <span class="stringliteral">"  Timeout: Number of milliseconds to wait before callback.\n"</span>;  
<a name="l02347"></a>02347 
<a name="l02348"></a><a class="code" href="res__features_8c.html#16f883e8bf12e4fdcf78be58d879f951">02348</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#16f883e8bf12e4fdcf78be58d879f951">manager_park</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02349"></a>02349 {
<a name="l02350"></a>02350    <span class="keyword">const</span> <span class="keywordtype">char</span> *channel = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l02351"></a>02351    <span class="keyword">const</span> <span class="keywordtype">char</span> *channel2 = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel2"</span>);
<a name="l02352"></a>02352    <span class="keyword">const</span> <span class="keywordtype">char</span> *timeout = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Timeout"</span>);
<a name="l02353"></a>02353    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[BUFSIZ];
<a name="l02354"></a>02354    <span class="keywordtype">int</span> to = 0;
<a name="l02355"></a>02355    <span class="keywordtype">int</span> res = 0;
<a name="l02356"></a>02356    <span class="keywordtype">int</span> parkExt = 0;
<a name="l02357"></a>02357    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *ch1, *ch2;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(channel)) {
<a name="l02360"></a>02360       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Channel not specified"</span>);
<a name="l02361"></a>02361       <span class="keywordflow">return</span> 0;
<a name="l02362"></a>02362    }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(channel2)) {
<a name="l02365"></a>02365       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Channel2 not specified"</span>);
<a name="l02366"></a>02366       <span class="keywordflow">return</span> 0;
<a name="l02367"></a>02367    }
<a name="l02368"></a>02368 
<a name="l02369"></a>02369    ch1 = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(channel);
<a name="l02370"></a>02370    <span class="keywordflow">if</span> (!ch1) {
<a name="l02371"></a>02371       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"Channel does not exist: %s"</span>, channel);
<a name="l02372"></a>02372       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, buf);
<a name="l02373"></a>02373       <span class="keywordflow">return</span> 0;
<a name="l02374"></a>02374    }
<a name="l02375"></a>02375 
<a name="l02376"></a>02376    ch2 = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(channel2);
<a name="l02377"></a>02377    <span class="keywordflow">if</span> (!ch2) {
<a name="l02378"></a>02378       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"Channel does not exist: %s"</span>, channel2);
<a name="l02379"></a>02379       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, buf);
<a name="l02380"></a>02380       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(ch1);
<a name="l02381"></a>02381       <span class="keywordflow">return</span> 0;
<a name="l02382"></a>02382    }
<a name="l02383"></a>02383 
<a name="l02384"></a>02384    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(timeout)) {
<a name="l02385"></a>02385       sscanf(timeout, <span class="stringliteral">"%d"</span>, &amp;to);
<a name="l02386"></a>02386    }
<a name="l02387"></a>02387 
<a name="l02388"></a>02388    res = <a class="code" href="features_8h.html#b0191433f37b2a33e542c9e4f7ededf9">ast_masq_park_call</a>(ch1, ch2, to, &amp;parkExt);
<a name="l02389"></a>02389    <span class="keywordflow">if</span> (!res) {
<a name="l02390"></a>02390       <a class="code" href="channel_8c.html#a1a142039194e9f6dfb632b28a0c5eb5">ast_softhangup</a>(ch2, <a class="code" href="channel_8h.html#a4d79cb252987ad7f099770543e601a1fe8eae384d045bee039ff9140421beb8">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l02391"></a>02391       <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Park successful"</span>);
<a name="l02392"></a>02392    } <span class="keywordflow">else</span> {
<a name="l02393"></a>02393       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Park failure"</span>);
<a name="l02394"></a>02394    }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(ch1);
<a name="l02397"></a>02397    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(ch2);
<a name="l02398"></a>02398 
<a name="l02399"></a>02399    <span class="keywordflow">return</span> 0;
<a name="l02400"></a>02400 }
<a name="l02401"></a>02401 
<a name="l02402"></a>02402 
<a name="l02403"></a><a class="code" href="res__features_8c.html#a8e9ef5e6ec2534444a59331177bed20">02403</a> <span class="keywordtype">int</span> <a class="code" href="features_8h.html#a8e9ef5e6ec2534444a59331177bed20">ast_pickup_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l02404"></a>02404 {
<a name="l02405"></a>02405    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *cur = NULL;
<a name="l02406"></a>02406    <span class="keywordtype">int</span> res = -1;
<a name="l02407"></a>02407 
<a name="l02408"></a>02408    <span class="keywordflow">while</span> ((cur = <a class="code" href="channel_8c.html#8ada12445e0d71c8bcd465f6838bf4e5">ast_channel_walk_locked</a>(cur)) != NULL) {
<a name="l02409"></a>02409       <span class="keywordflow">if</span> (!cur-&gt;<a class="code" href="structast__channel.html#569f7a090087f9e7071a247a24ea0809">pbx</a> &amp;&amp; 
<a name="l02410"></a>02410          (cur != chan) &amp;&amp;
<a name="l02411"></a>02411          (chan-&gt;<a class="code" href="structast__channel.html#6a5ae60e87b5caa521ea5c2b36de96cc">pickupgroup</a> &amp; cur-&gt;<a class="code" href="structast__channel.html#d435ec54d713513ab1d94049cbc33629">callgroup</a>) &amp;&amp;
<a name="l02412"></a>02412          ((cur-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> == <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a85da5b3ea10583d638bc7ce8fe638ec2">AST_STATE_RINGING</a>) ||
<a name="l02413"></a>02413           (cur-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> == <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a0789c8ad2fe8eda2081eb587a0bfbe42">AST_STATE_RING</a>))) {
<a name="l02414"></a>02414             <span class="keywordflow">break</span>;
<a name="l02415"></a>02415       }
<a name="l02416"></a>02416       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(cur);
<a name="l02417"></a>02417    }
<a name="l02418"></a>02418    <span class="keywordflow">if</span> (cur) {
<a name="l02419"></a>02419       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02420"></a>02420          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Call pickup on chan '%s' by '%s'\n"</span>,cur-&gt;name, chan-&gt;name);
<a name="l02421"></a>02421       res = <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(chan);
<a name="l02422"></a>02422       <span class="keywordflow">if</span> (res)
<a name="l02423"></a>02423          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to answer '%s'\n"</span>, chan-&gt;name);
<a name="l02424"></a>02424       res = <a class="code" href="channel_8c.html#9c10dd50747025f5100adeb1da23c2e1">ast_queue_control</a>(chan, <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>);
<a name="l02425"></a>02425       <span class="keywordflow">if</span> (res)
<a name="l02426"></a>02426          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"Unable to queue answer on '%s'\n"</span>, chan-&gt;name);
<a name="l02427"></a>02427       res = <a class="code" href="channel_8c.html#8e30c09190bd2388188cd8bab35ba595">ast_channel_masquerade</a>(cur, chan);
<a name="l02428"></a>02428       <span class="keywordflow">if</span> (res)
<a name="l02429"></a>02429          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_WARNING, <span class="stringliteral">"Unable to masquerade '%s' into '%s'\n"</span>, chan-&gt;name, cur-&gt;name);     <span class="comment">/* Done */</span>
<a name="l02430"></a>02430       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(cur);
<a name="l02431"></a>02431    } <span class="keywordflow">else</span>   {
<a name="l02432"></a>02432       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02433"></a>02433          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"No call pickup possible...\n"</span>);
<a name="l02434"></a>02434    }
<a name="l02435"></a>02435    <span class="keywordflow">return</span> res;
<a name="l02436"></a>02436 }
<a name="l02437"></a>02437 <span class="comment"></span>
<a name="l02438"></a>02438 <span class="comment">/*! \brief Add parking hints for all defined parking lots */</span>
<a name="l02439"></a><a class="code" href="res__features_8c.html#81f5d9d5e94a57b9bc24bee2488dc740">02439</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__features_8c.html#81f5d9d5e94a57b9bc24bee2488dc740">park_add_hints</a>(<span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> <a class="code" href="app__queue_8c.html#ef399b2d446bb37b7c32ad2cc1b6045b">stop</a>)
<a name="l02440"></a>02440 {
<a name="l02441"></a>02441    <span class="keywordtype">int</span> numext;
<a name="l02442"></a>02442    <span class="keywordtype">char</span> device[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l02443"></a>02443    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>[10];
<a name="l02444"></a>02444 
<a name="l02445"></a>02445    <span class="keywordflow">for</span> (numext = start; numext &lt;= stop; numext++) {
<a name="l02446"></a>02446       snprintf(exten, <span class="keyword">sizeof</span>(exten), <span class="stringliteral">"%d"</span>, numext);
<a name="l02447"></a>02447       snprintf(device, <span class="keyword">sizeof</span>(device), <span class="stringliteral">"park:%s@%s"</span>, exten, context);
<a name="l02448"></a>02448       <a class="code" href="pbx_8c.html#b77a5344eb4a1e2404c81a2a593deff5">ast_add_extension</a>(context, 1, exten, <a class="code" href="pbx_8h.html#ab1e94ec9073ecc8bcedd7b11dd82001">PRIORITY_HINT</a>, NULL, NULL, device, NULL, NULL, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>);
<a name="l02449"></a>02449    }
<a name="l02450"></a>02450 }
<a name="l02451"></a>02451 
<a name="l02452"></a>02452 
<a name="l02453"></a><a class="code" href="res__features_8c.html#1630c58a25341e544032331a525418fe">02453</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__alarmreceiver_8c.html#1630c58a25341e544032331a525418fe">load_config</a>(<span class="keywordtype">void</span>) 
<a name="l02454"></a>02454 {
<a name="l02455"></a>02455    <span class="keywordtype">int</span> start = 0, end = 0;
<a name="l02456"></a>02456    <span class="keywordtype">int</span> res;
<a name="l02457"></a>02457    <span class="keyword">struct </span><a class="code" href="structast__context.html">ast_context</a> *con = NULL;
<a name="l02458"></a>02458    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l02459"></a>02459    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a> = NULL;
<a name="l02460"></a>02460    <span class="keywordtype">char</span> old_parking_ext[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>];
<a name="l02461"></a>02461    <span class="keywordtype">char</span> old_parking_con[<a class="code" href="channel_8h.html#729d25558b5b1940c1a6ff9d806f944c">AST_MAX_EXTENSION</a>] = <span class="stringliteral">""</span>;
<a name="l02462"></a>02462 
<a name="l02463"></a>02463    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>)) {
<a name="l02464"></a>02464       strcpy(old_parking_ext, <a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>);
<a name="l02465"></a>02465       strcpy(old_parking_con, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l02466"></a>02466    } 
<a name="l02467"></a>02467 
<a name="l02468"></a>02468    <span class="comment">/* Reset to defaults */</span>
<a name="l02469"></a>02469    strcpy(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, <span class="stringliteral">"parkedcalls"</span>);
<a name="l02470"></a>02470    strcpy(<a class="code" href="res__features_8c.html#d3b3ab5f9960ab4e6a953956eca629ae">parking_con_dial</a>, <span class="stringliteral">"park-dial"</span>);
<a name="l02471"></a>02471    strcpy(<a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>, <span class="stringliteral">"700"</span>);
<a name="l02472"></a>02472    strcpy(<a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">pickup_ext</a>, <span class="stringliteral">"*8"</span>);
<a name="l02473"></a>02473    strcpy(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>, <span class="stringliteral">"default"</span>);
<a name="l02474"></a>02474    <a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>[0] = <span class="charliteral">'\0'</span>;
<a name="l02475"></a>02475    strcpy(<a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, <span class="stringliteral">"beep"</span>);
<a name="l02476"></a>02476    strcpy(<a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>, <span class="stringliteral">"pbx-invalid"</span>);
<a name="l02477"></a>02477    <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a> = 701;
<a name="l02478"></a>02478    <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a> = 750;
<a name="l02479"></a>02479    <a class="code" href="res__features_8c.html#3307cc7b19dbe62fab2483af01449e20">parkfindnext</a> = 0;
<a name="l02480"></a>02480    <a class="code" href="res__features_8c.html#e8f11b21e02217176b0804f5bc589941">adsipark</a> = 0;
<a name="l02481"></a>02481    <a class="code" href="res__features_8c.html#0d0097fcffce18c1b3c2a8904c087f83">comebacktoorigin</a> = 1;
<a name="l02482"></a>02482    <a class="code" href="res__features_8c.html#9182c07816a170c7341ddd2583fe21f5">parkaddhints</a> = 0;
<a name="l02483"></a>02483    <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = 0;
<a name="l02484"></a>02484    <a class="code" href="res__features_8c.html#29173b88cca85d864c05be85b428ac05">parkedcallreparking</a> = 0;
<a name="l02485"></a>02485 
<a name="l02486"></a>02486    <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a> = <a class="code" href="res__features_8c.html#f7afae2b70d4bc616be3364b65384e59">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>;
<a name="l02487"></a>02487    <a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a> = <a class="code" href="res__features_8c.html#19f1c4d65f5e18e457aca3bca34e00da">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>;
<a name="l02488"></a>02488    <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a> = <a class="code" href="res__features_8c.html#09307d2bf2155595f4977f6a1db99890">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>;
<a name="l02489"></a>02489    <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a> = <a class="code" href="res__features_8c.html#9b60acd9fc728db55e4be04aad40f490">DEFAULT_ATXFER_LOOP_DELAY</a>;
<a name="l02490"></a>02490    <a class="code" href="res__features_8c.html#3dfbecf9aa153bd233694a1c60f2161b">atxferdropcall</a> = <a class="code" href="res__features_8c.html#16f194b1ed2ce4bb3d724e59e9731fdf">DEFAULT_ATXFER_DROP_CALL</a>;
<a name="l02491"></a>02491    <a class="code" href="res__features_8c.html#b912136f198ae4b8d6737fff37c17309">atxfercallbackretries</a> = <a class="code" href="res__features_8c.html#d7834bac727c309d16f837933156df3c">DEFAULT_ATXFER_CALLBACK_RETRIES</a>;
<a name="l02492"></a>02492 
<a name="l02493"></a>02493    cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<span class="stringliteral">"features.conf"</span>);
<a name="l02494"></a>02494    <span class="keywordflow">if</span> (!cfg) {
<a name="l02495"></a>02495       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>,<span class="stringliteral">"Could not load features.conf\n"</span>);
<a name="l02496"></a>02496       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#6b66b922ea50fb20d0a8a25ba8317b0adea6426eed250d0d922d7e289a706663">AST_MODULE_LOAD_DECLINE</a>;
<a name="l02497"></a>02497    }
<a name="l02498"></a>02498    <span class="keywordflow">for</span> (var = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"general"</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02499"></a>02499       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkext"</span>)) {
<a name="l02500"></a>02500          ast_copy_string(<a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>));
<a name="l02501"></a>02501       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"context"</span>)) {
<a name="l02502"></a>02502          ast_copy_string(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>));
<a name="l02503"></a>02503       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkingtime"</span>)) {
<a name="l02504"></a>02504          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;<a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a>) != 1) || (<a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a> &lt; 1)) {
<a name="l02505"></a>02505             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid parkingtime\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02506"></a>02506             <a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a> = <a class="code" href="res__features_8c.html#7c3f52dfb0d0a143e81f48996dba0579">DEFAULT_PARK_TIME</a>;
<a name="l02507"></a>02507          } <span class="keywordflow">else</span>
<a name="l02508"></a>02508             <a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a> = <a class="code" href="res__features_8c.html#c700875891439809b350a5e629558902">parkingtime</a> * 1000;
<a name="l02509"></a>02509       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkpos"</span>)) {
<a name="l02510"></a>02510          <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d-%d"</span>, &amp;start, &amp;end) != 2) {
<a name="l02511"></a>02511             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Format for parking positions is a-b, where a and b are numbers at line %d of parking.conf\n"</span>, var-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l02512"></a>02512          } <span class="keywordflow">else</span> {
<a name="l02513"></a>02513             <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a> = start;
<a name="l02514"></a>02514             <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a> = end;
<a name="l02515"></a>02515          }
<a name="l02516"></a>02516       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"findslot"</span>)) {
<a name="l02517"></a>02517          <a class="code" href="res__features_8c.html#3307cc7b19dbe62fab2483af01449e20">parkfindnext</a> = (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"next"</span>));
<a name="l02518"></a>02518       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkinghints"</span>)) {
<a name="l02519"></a>02519          <a class="code" href="res__features_8c.html#9182c07816a170c7341ddd2583fe21f5">parkaddhints</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02520"></a>02520       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkedcalltransfers"</span>)) {
<a name="l02521"></a>02521          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"both"</span>))
<a name="l02522"></a>02522             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l02523"></a>02523          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"caller"</span>))
<a name="l02524"></a>02524             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l02525"></a>02525          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"callee"</span>))
<a name="l02526"></a>02526             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l02527"></a>02527       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkedcallreparking"</span>)) {
<a name="l02528"></a>02528          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"both"</span>))
<a name="l02529"></a>02529             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l02530"></a>02530          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"caller"</span>))
<a name="l02531"></a>02531             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l02532"></a>02532          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"callee"</span>))
<a name="l02533"></a>02533             <a class="code" href="res__features_8c.html#db2f09f93e8cc69a80f66eb98e7d5817">parkedcalltransfers</a> = <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l02534"></a>02534       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"adsipark"</span>)) {
<a name="l02535"></a>02535          <a class="code" href="res__features_8c.html#e8f11b21e02217176b0804f5bc589941">adsipark</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02536"></a>02536       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"transferdigittimeout"</span>)) {
<a name="l02537"></a>02537          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;<a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a>) != 1) || (<a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a> &lt; 1)) {
<a name="l02538"></a>02538             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid transferdigittimeout\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02539"></a>02539             <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a> = <a class="code" href="res__features_8c.html#f7afae2b70d4bc616be3364b65384e59">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>;
<a name="l02540"></a>02540          } <span class="keywordflow">else</span>
<a name="l02541"></a>02541             <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a> = <a class="code" href="res__features_8c.html#cbc03319094e5b0beeb51fe0a38326a9">transferdigittimeout</a> * 1000;
<a name="l02542"></a>02542       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"featuredigittimeout"</span>)) {
<a name="l02543"></a>02543          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;<a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a>) != 1) || (<a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a> &lt; 1)) {
<a name="l02544"></a>02544             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid featuredigittimeout\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02545"></a>02545             <a class="code" href="app__followme_8c.html#9c377c53990dd55a57a71e8b85d40e73">featuredigittimeout</a> = <a class="code" href="res__features_8c.html#19f1c4d65f5e18e457aca3bca34e00da">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>;
<a name="l02546"></a>02546          }
<a name="l02547"></a>02547       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"atxfernoanswertimeout"</span>)) {
<a name="l02548"></a>02548          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;<a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a>) != 1) || (<a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a> &lt; 1)) {
<a name="l02549"></a>02549             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid atxfernoanswertimeout\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02550"></a>02550             <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a> = <a class="code" href="res__features_8c.html#09307d2bf2155595f4977f6a1db99890">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>;
<a name="l02551"></a>02551          } <span class="keywordflow">else</span>
<a name="l02552"></a>02552             <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a> = <a class="code" href="res__features_8c.html#6137343e473296557b4bc40bc2047176">atxfernoanswertimeout</a> * 1000;
<a name="l02553"></a>02553       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"atxferloopdelay"</span>)) {
<a name="l02554"></a>02554          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%u"</span>, &amp;<a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a>) != 1)) {
<a name="l02555"></a>02555             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid atxferloopdelay\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02556"></a>02556             <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a> = <a class="code" href="res__features_8c.html#9b60acd9fc728db55e4be04aad40f490">DEFAULT_ATXFER_LOOP_DELAY</a>;
<a name="l02557"></a>02557          } <span class="keywordflow">else</span> 
<a name="l02558"></a>02558             <a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a> *= 1000;
<a name="l02559"></a>02559       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"atxferdropcall"</span>)) {
<a name="l02560"></a>02560          <a class="code" href="res__features_8c.html#3dfbecf9aa153bd233694a1c60f2161b">atxferdropcall</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02561"></a>02561       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"atxfercallbackretries"</span>)) {
<a name="l02562"></a>02562          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%u"</span>, &amp;<a class="code" href="res__features_8c.html#e2b0400e55191600a1da186de69eccfc">atxferloopdelay</a>) != 1)) {
<a name="l02563"></a>02563             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"%s is not a valid atxfercallbackretries\n"</span>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02564"></a>02564             <a class="code" href="res__features_8c.html#b912136f198ae4b8d6737fff37c17309">atxfercallbackretries</a> = <a class="code" href="res__features_8c.html#d7834bac727c309d16f837933156df3c">DEFAULT_ATXFER_CALLBACK_RETRIES</a>;
<a name="l02565"></a>02565          }
<a name="l02566"></a>02566       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"courtesytone"</span>)) {
<a name="l02567"></a>02567          ast_copy_string(<a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#c7e82f6517ce6c30ea7e88cf659e5182">courtesytone</a>));
<a name="l02568"></a>02568       }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkedplay"</span>)) {
<a name="l02569"></a>02569          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"both"</span>))
<a name="l02570"></a>02570             <a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> = 2;
<a name="l02571"></a>02571          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"parked"</span>))
<a name="l02572"></a>02572             <a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> = 1;
<a name="l02573"></a>02573          <span class="keywordflow">else</span>
<a name="l02574"></a>02574             <a class="code" href="res__features_8c.html#5bb0abbcde92e654cf8f47e96823257e">parkedplay</a> = 0;
<a name="l02575"></a>02575       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"xfersound"</span>)) {
<a name="l02576"></a>02576          ast_copy_string(<a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>));
<a name="l02577"></a>02577       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"xferfailsound"</span>)) {
<a name="l02578"></a>02578          ast_copy_string(<a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#fe3b497b643cf5808b5eac8eeb112fe1">xferfailsound</a>));
<a name="l02579"></a>02579       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"pickupexten"</span>)) {
<a name="l02580"></a>02580          ast_copy_string(<a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">pickup_ext</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#12945224a84508b6d29891d86c8f0f7c">pickup_ext</a>));
<a name="l02581"></a>02581       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"comebacktoorigin"</span>)) {
<a name="l02582"></a>02582          <a class="code" href="res__features_8c.html#0d0097fcffce18c1b3c2a8904c087f83">comebacktoorigin</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02583"></a>02583       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"parkedmusicclass"</span>)) {
<a name="l02584"></a>02584          ast_copy_string(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#5cd266893eca16634e9bd66eeb7a1c3a">parkmohclass</a>));
<a name="l02585"></a>02585       }
<a name="l02586"></a>02586    }
<a name="l02587"></a>02587 
<a name="l02588"></a>02588    <a class="code" href="res__features_8c.html#90c5a9b8ffd142d1bc12fe7eadc541e4">unmap_features</a>();
<a name="l02589"></a>02589    <span class="keywordflow">for</span> (var = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"featuremap"</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02590"></a>02590       <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#bc427f202ff5074e9d9c045ad9e985a0">remap_feature</a>(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>))
<a name="l02591"></a>02591          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unknown feature '%s'\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l02592"></a>02592    }
<a name="l02593"></a>02593 
<a name="l02594"></a>02594    <span class="comment">/* Map a key combination to an application*/</span>
<a name="l02595"></a>02595    <a class="code" href="res__features_8c.html#1aebc3ae7af33b2493efe057cf5f9f09">ast_unregister_features</a>();
<a name="l02596"></a>02596    <span class="keywordflow">for</span> (var = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"applicationmap"</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l02597"></a>02597       <span class="keywordtype">char</span> *tmp_val = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l02598"></a>02598       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, *activateon, *activatedby, *<a class="code" href="adsistub_8c.html#d2a57dc1d883fd21fb9951699df71cc7">app</a>, *app_args, *moh_class; 
<a name="l02599"></a>02599       <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l02600"></a>02600 
<a name="l02601"></a>02601       <span class="comment">/* strsep() sets the argument to NULL if match not found, and it</span>
<a name="l02602"></a>02602 <span class="comment">       * is safe to use it with a NULL argument, so we don't check</span>
<a name="l02603"></a>02603 <span class="comment">       * between calls.</span>
<a name="l02604"></a>02604 <span class="comment">       */</span>
<a name="l02605"></a>02605       exten = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp_val,<span class="stringliteral">","</span>);
<a name="l02606"></a>02606       activatedby = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp_val,<span class="stringliteral">","</span>);
<a name="l02607"></a>02607       app = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp_val,<span class="stringliteral">","</span>);
<a name="l02608"></a>02608       app_args = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp_val,<span class="stringliteral">","</span>);
<a name="l02609"></a>02609       moh_class = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;tmp_val,<span class="stringliteral">","</span>);
<a name="l02610"></a>02610 
<a name="l02611"></a>02611       activateon = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;activatedby, <span class="stringliteral">"/"</span>);   
<a name="l02612"></a>02612 <span class="comment"></span>
<a name="l02613"></a>02613 <span class="comment">      /*! \todo XXX var_name or app_args ? */</span>
<a name="l02614"></a>02614       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(app) || <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(exten) || <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(activateon) || <a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>)) {
<a name="l02615"></a>02615          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Please check the feature Mapping Syntax, either extension, name, or app aren't provided %s %s %s %s\n"</span>,
<a name="l02616"></a>02616             app, exten, activateon, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l02617"></a>02617          <span class="keywordflow">continue</span>;
<a name="l02618"></a>02618       }
<a name="l02619"></a>02619 
<a name="l02620"></a>02620       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;feature_list);
<a name="l02621"></a>02621       <span class="keywordflow">if</span> ((feature = <a class="code" href="res__features_8c.html#80dac60ab696b3c164c0c9f53595eab5">find_dynamic_feature</a>(var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>))) {
<a name="l02622"></a>02622          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l02623"></a>02623          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Dynamic Feature '%s' specified more than once!\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l02624"></a>02624          <span class="keywordflow">continue</span>;
<a name="l02625"></a>02625       }
<a name="l02626"></a>02626       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;feature_list);
<a name="l02627"></a>02627             
<a name="l02628"></a>02628       <span class="keywordflow">if</span> (!(feature = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*feature))))
<a name="l02629"></a>02629          <span class="keywordflow">continue</span>;               
<a name="l02630"></a>02630 
<a name="l02631"></a>02631       ast_copy_string(feature-&gt;sname, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="features_8h.html#2683fe658a7a4a8441eb3cb2674c1907">FEATURE_SNAME_LEN</a>);
<a name="l02632"></a>02632       ast_copy_string(feature-&gt;app, app, <a class="code" href="features_8h.html#313bef0c50a1046100eb9d8537d14a9f">FEATURE_APP_LEN</a>);
<a name="l02633"></a>02633       ast_copy_string(feature-&gt;exten, exten, <a class="code" href="features_8h.html#83573695a0ba2e3a1047aa3a06a4229e">FEATURE_EXTEN_LEN</a>);
<a name="l02634"></a>02634       
<a name="l02635"></a>02635       <span class="keywordflow">if</span> (app_args) 
<a name="l02636"></a>02636          ast_copy_string(feature-&gt;app_args, app_args, <a class="code" href="features_8h.html#824ae0621aa2d0f059ee003b9d0c1984">FEATURE_APP_ARGS_LEN</a>);
<a name="l02637"></a>02637 
<a name="l02638"></a>02638       <span class="keywordflow">if</span> (moh_class)
<a name="l02639"></a>02639          ast_copy_string(feature-&gt;moh_class, moh_class, <a class="code" href="features_8h.html#797af9710da9286abcc5f301f2656b07">FEATURE_MOH_LEN</a>);
<a name="l02640"></a>02640          
<a name="l02641"></a>02641       ast_copy_string(feature-&gt;exten, exten, <span class="keyword">sizeof</span>(feature-&gt;exten));
<a name="l02642"></a>02642       feature-&gt;operation = <a class="code" href="res__features_8c.html#e84b0ba9bed83da8caaa0c3ee75dde98">feature_exec_app</a>;
<a name="l02643"></a>02643       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef46fd5f15d30b2788d651d0fda1ef2432">AST_FEATURE_FLAG_NEEDSDTMF</a>);
<a name="l02644"></a>02644 
<a name="l02645"></a>02645       <span class="comment">/* Allow caller and calle to be specified for backwards compatability */</span>
<a name="l02646"></a>02646       <span class="keywordflow">if</span> (!strcasecmp(activateon, <span class="stringliteral">"self"</span>) || !strcasecmp(activateon, <span class="stringliteral">"caller"</span>))
<a name="l02647"></a>02647          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efbfdc26da820d520cf35171586fb5b81a">AST_FEATURE_FLAG_ONSELF</a>);
<a name="l02648"></a>02648       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activateon, <span class="stringliteral">"peer"</span>) || !strcasecmp(activateon, <span class="stringliteral">"callee"</span>))
<a name="l02649"></a>02649          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef20e49040e82575ddc0bc864e501e5cb7">AST_FEATURE_FLAG_ONPEER</a>);
<a name="l02650"></a>02650       <span class="keywordflow">else</span> {
<a name="l02651"></a>02651          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid 'ActivateOn' specification for feature '%s',"</span>
<a name="l02652"></a>02652             <span class="stringliteral">" must be 'self', or 'peer'\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l02653"></a>02653          <span class="keywordflow">continue</span>;
<a name="l02654"></a>02654       }
<a name="l02655"></a>02655 
<a name="l02656"></a>02656       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(activatedby))
<a name="l02657"></a>02657          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>);
<a name="l02658"></a>02658       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">"caller"</span>))
<a name="l02659"></a>02659          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efe58ac0c173859e1287bf9eb2299e3a03">AST_FEATURE_FLAG_BYCALLER</a>);
<a name="l02660"></a>02660       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">"callee"</span>))
<a name="l02661"></a>02661          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516efa8b766715e0f5b814a1d2727c0388af8">AST_FEATURE_FLAG_BYCALLEE</a>);
<a name="l02662"></a>02662       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">"both"</span>))
<a name="l02663"></a>02663          <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(feature, <a class="code" href="res__features_8c.html#dca29a1140aadadfd92b34a02fa516ef9dcd818f0d6de83f599985cde36b8a92">AST_FEATURE_FLAG_BYBOTH</a>);
<a name="l02664"></a>02664       <span class="keywordflow">else</span> {
<a name="l02665"></a>02665          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid 'ActivatedBy' specification for feature '%s',"</span>
<a name="l02666"></a>02666             <span class="stringliteral">" must be 'caller', or 'callee', or 'both'\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l02667"></a>02667          <span class="keywordflow">continue</span>;
<a name="l02668"></a>02668       }
<a name="l02669"></a>02669 
<a name="l02670"></a>02670       <a class="code" href="features_8h.html#f3669c57747d1ce65a0c6589e03386c0">ast_register_feature</a>(feature);
<a name="l02671"></a>02671          
<a name="l02672"></a>02672       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt;= 1)
<a name="l02673"></a>02673          <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#6e3640436a97291b451a8d264b5ab15d">VERBOSE_PREFIX_2</a> <span class="stringliteral">"Mapping Feature '%s' to app '%s(%s)' with code '%s'\n"</span>, var-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, app, app_args, exten);  
<a name="l02674"></a>02674    }   
<a name="l02675"></a>02675    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l02676"></a>02676 
<a name="l02677"></a>02677    <span class="comment">/* Remove the old parking extension */</span>
<a name="l02678"></a>02678    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(old_parking_con) &amp;&amp; (con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(old_parking_con))) {
<a name="l02679"></a>02679       <span class="keywordflow">if</span>(<a class="code" href="pbx_8c.html#c1d85c0d2ff75a7c476fa8379affd931">ast_context_remove_extension2</a>(con, old_parking_ext, 1, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>))
<a name="l02680"></a>02680             <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(old_parking_ext, old_parking_con);
<a name="l02681"></a>02681       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02682"></a>02682          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Removed old parking extension %s@%s\n"</span>, old_parking_ext, old_parking_con);
<a name="l02683"></a>02683    }
<a name="l02684"></a>02684    
<a name="l02685"></a>02685    <span class="keywordflow">if</span> (!(con = <a class="code" href="pbx_8c.html#f8c5b4e7d06b7aff72707b5d7d7c94e1">ast_context_find</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>)) &amp;&amp; !(con = <a class="code" href="pbx_8c.html#9b7261abb02956903bb17c5bf8af265a">ast_context_create</a>(NULL, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>))) {
<a name="l02686"></a>02686       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Parking context '%s' does not exist and unable to create\n"</span>, <a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>);
<a name="l02687"></a>02687       <span class="keywordflow">return</span> -1;
<a name="l02688"></a>02688    }
<a name="l02689"></a>02689    res = <a class="code" href="pbx_8c.html#0985a9a977ba8aa4f370da3a495437ae">ast_add_extension2</a>(con, 1, <a class="code" href="features_8h.html#592f5491321993926462dffa87ba0bab">ast_parking_ext</a>(), 1, NULL, NULL, <a class="code" href="res__features_8c.html#d4db798eecbddaa591e0427c6267cdb8">parkcall</a>, NULL, NULL, <a class="code" href="pbx__ael_8c.html#5940569cd1d60781f856f93235b072ee">registrar</a>);
<a name="l02690"></a>02690    <span class="keywordflow">if</span> (<a class="code" href="res__features_8c.html#9182c07816a170c7341ddd2583fe21f5">parkaddhints</a>)
<a name="l02691"></a>02691       <a class="code" href="res__features_8c.html#81f5d9d5e94a57b9bc24bee2488dc740">park_add_hints</a>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, <a class="code" href="res__features_8c.html#b0afcd98c89216f6836dc9e09cd3551c">parking_start</a>, <a class="code" href="res__features_8c.html#8b29b99f16241c2b9ba71dd3a8fa6be7">parking_stop</a>);
<a name="l02692"></a>02692    <span class="keywordflow">if</span> (!res)
<a name="l02693"></a>02693       <a class="code" href="res__features_8c.html#1b66c04241a96d9698bbe2f70e913f9a">notify_metermaids</a>(<a class="code" href="features_8h.html#592f5491321993926462dffa87ba0bab">ast_parking_ext</a>(), parking_con);
<a name="l02694"></a>02694    <span class="keywordflow">return</span> res;
<a name="l02695"></a>02695 
<a name="l02696"></a>02696 }
<a name="l02697"></a>02697 
<a name="l02698"></a><a class="code" href="res__features_8c.html#006876152b700a9f981f4e8e58079e4d">02698</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#006876152b700a9f981f4e8e58079e4d">app_bridge</a> = <span class="stringliteral">"Bridge"</span>;
<a name="l02699"></a><a class="code" href="res__features_8c.html#2a47b1a37e47f320ac6933f273f7e540">02699</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#2a47b1a37e47f320ac6933f273f7e540">bridge_synopsis</a> = <span class="stringliteral">"Bridge two channels"</span>;
<a name="l02700"></a><a class="code" href="res__features_8c.html#7180e2be1229b3ca11de3dafda181eb4">02700</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__features_8c.html#7180e2be1229b3ca11de3dafda181eb4">bridge_descrip</a> =
<a name="l02701"></a>02701 <span class="stringliteral">"Usage: Bridge(channel[|options])\n"</span>
<a name="l02702"></a>02702 <span class="stringliteral">"  Allows the ability to bridge two channels via the dialplan.\n"</span>
<a name="l02703"></a>02703 <span class="stringliteral">"The current channel is bridged to the specified 'channel'.\n"</span>
<a name="l02704"></a>02704 <span class="stringliteral">"The following options are supported:\n"</span>
<a name="l02705"></a>02705 <span class="stringliteral">"   p - Play a courtesy tone to 'channel'.\n"</span>
<a name="l02706"></a>02706 <span class="stringliteral">"BRIDGERESULT dial plan variable will contain SUCCESS, FAILURE, LOOP, NONEXISTENT or INCOMPATIBLE.\n"</span>;
<a name="l02707"></a>02707 
<a name="l02708"></a>02708 <span class="keyword">enum</span> {
<a name="l02709"></a>02709    <a class="code" href="res__features_8c.html#68986ab776eb5d6b5a809a1c005a730086991876a86bcf49e9ed308ff3a5f676">BRIDGE_OPT_PLAYTONE</a> = (1 &lt;&lt; 0),
<a name="l02710"></a>02710 };
<a name="l02711"></a>02711 
<a name="l02712"></a>02712 <a class="code" href="app_8h.html#b96145dff1ad8af55cb4a56c80c40f6f">AST_APP_OPTIONS</a>(bridge_exec_options, <a class="code" href="app_8h.html#3355729aa51933941e8b2572240eb3a3">BEGIN_OPTIONS</a>
<a name="l02713"></a>02713    <a class="code" href="app_8h.html#1691312cccf5e495974d500b5bc2c4e0">AST_APP_OPTION</a>(<span class="charliteral">'p'</span>, <a class="code" href="res__features_8c.html#68986ab776eb5d6b5a809a1c005a730086991876a86bcf49e9ed308ff3a5f676">BRIDGE_OPT_PLAYTONE</a>)
<a name="l02714"></a>02714 <a class="code" href="app_8h.html#83ad61ff036280856ac7c2e8673499ff">END_OPTIONS</a> );
<a name="l02715"></a>02715 
<a name="l02716"></a><a class="code" href="res__features_8c.html#ea74625bb7af3e0a47a43f2961ddfdef">02716</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__features_8c.html#ea74625bb7af3e0a47a43f2961ddfdef">bridge_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l02717"></a>02717 {
<a name="l02718"></a>02718    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u;
<a name="l02719"></a>02719    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *current_dest_chan, *final_dest_chan;
<a name="l02720"></a>02720    <span class="keywordtype">char</span> *tmp_data  = NULL;
<a name="l02721"></a>02721    <span class="keyword">struct </span><a class="code" href="structast__flags.html">ast_flags</a> opts = { 0, };
<a name="l02722"></a>02722    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html">ast_bridge_config</a> bconfig = { { 0, }, };
<a name="l02723"></a>02723 
<a name="l02724"></a>02724    <a class="code" href="app_8h.html#f2237dba0ffbe2f9ec8209c3f9fe82a7">AST_DECLARE_APP_ARGS</a>(args,
<a name="l02725"></a>02725       <a class="code" href="app_8h.html#a6b5292002b488b8ce11fedacb317800">AST_APP_ARG</a>(dest_chan);
<a name="l02726"></a>02726       <a class="code" href="app_8h.html#a6b5292002b488b8ce11fedacb317800">AST_APP_ARG</a>(options);
<a name="l02727"></a>02727    );
<a name="l02728"></a>02728    
<a name="l02729"></a>02729    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(data)) {
<a name="l02730"></a>02730       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Bridge require at least 1 argument specifying the other end of the bridge\n"</span>);
<a name="l02731"></a>02731       <span class="keywordflow">return</span> -1;
<a name="l02732"></a>02732    }
<a name="l02733"></a>02733    
<a name="l02734"></a>02734    u = <a class="code" href="module_8h.html#01229151b3816d7323f7460fef4305c3">ast_module_user_add</a>(chan);
<a name="l02735"></a>02735 
<a name="l02736"></a>02736    tmp_data = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(data);
<a name="l02737"></a>02737    <a class="code" href="app_8h.html#c086f828d1f39897759c5668a4d20127">AST_STANDARD_APP_ARGS</a>(args, tmp_data);
<a name="l02738"></a>02738    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(args.options))
<a name="l02739"></a>02739       <a class="code" href="app_8c.html#54fd988ba7570b2d55d749d4d07372d3">ast_app_parse_options</a>(bridge_exec_options, &amp;opts, NULL, args.options);
<a name="l02740"></a>02740 
<a name="l02741"></a>02741    <span class="comment">/* avoid bridge with ourselves */</span>
<a name="l02742"></a>02742    <span class="keywordflow">if</span> (!strncmp(chan-&gt;name, args.dest_chan, 
<a name="l02743"></a>02743       strlen(chan-&gt;name) &lt; strlen(args.dest_chan) ? 
<a name="l02744"></a>02744       strlen(chan-&gt;name) : strlen(args.dest_chan))) {
<a name="l02745"></a>02745       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to bridge channel %s with itself\n"</span>, chan-&gt;name);
<a name="l02746"></a>02746       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"BridgeExec"</span>,
<a name="l02747"></a>02747                <span class="stringliteral">"Response: Failed\r\n"</span>
<a name="l02748"></a>02748                <span class="stringliteral">"Reason: Unable to bridge channel to itself\r\n"</span>
<a name="l02749"></a>02749                <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l02750"></a>02750                <span class="stringliteral">"Channel2: %s\r\n"</span>,
<a name="l02751"></a>02751                chan-&gt;name, args.dest_chan);
<a name="l02752"></a>02752       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BRIDGERESULT"</span>, <span class="stringliteral">"LOOP"</span>);
<a name="l02753"></a>02753       <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02754"></a>02754       <span class="keywordflow">return</span> 0;
<a name="l02755"></a>02755    }
<a name="l02756"></a>02756 
<a name="l02757"></a>02757    <span class="comment">/* make sure we have a valid end point */</span>
<a name="l02758"></a>02758    <span class="keywordflow">if</span> (!(current_dest_chan = <a class="code" href="channel_8c.html#73dcef78b8c7fc8cb85dde3ee0058c57">ast_get_channel_by_name_prefix_locked</a>(args.dest_chan, 
<a name="l02759"></a>02759       strlen(args.dest_chan)))) {
<a name="l02760"></a>02760       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Bridge failed because channel %s does not exists or we "</span>
<a name="l02761"></a>02761          <span class="stringliteral">"cannot get its lock\n"</span>, args.dest_chan);
<a name="l02762"></a>02762       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"BridgeExec"</span>,
<a name="l02763"></a>02763                <span class="stringliteral">"Response: Failed\r\n"</span>
<a name="l02764"></a>02764                <span class="stringliteral">"Reason: Cannot grab end point\r\n"</span>
<a name="l02765"></a>02765                <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l02766"></a>02766                <span class="stringliteral">"Channel2: %s\r\n"</span>, chan-&gt;name, args.dest_chan);
<a name="l02767"></a>02767       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BRIDGERESULT"</span>, <span class="stringliteral">"NONEXISTENT"</span>);
<a name="l02768"></a>02768       <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02769"></a>02769       <span class="keywordflow">return</span> 0;
<a name="l02770"></a>02770    }
<a name="l02771"></a>02771    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;current_dest_chan-&gt;<a class="code" href="structast__channel.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l02772"></a>02772 
<a name="l02773"></a>02773    <span class="comment">/* answer the channel if needed */</span>
<a name="l02774"></a>02774    <span class="keywordflow">if</span> (current_dest_chan-&gt;<a class="code" href="structast__channel.html#fb303761f789500fe4c0c9938c1c0245">_state</a> != <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87aea66d48cb3e294b70a35486fb5fe2ce6">AST_STATE_UP</a>)
<a name="l02775"></a>02775       <a class="code" href="channel_8c.html#9e089c979b071a1df466a09497fdfa31">ast_answer</a>(current_dest_chan);
<a name="l02776"></a>02776 
<a name="l02777"></a>02777    <span class="comment">/* try to allocate a place holder where current_dest_chan will be placed */</span>
<a name="l02778"></a>02778    <span class="keywordflow">if</span> (!(final_dest_chan = <a class="code" href="channel_8c.html#3e12df96f6a8fc8b7293ad03b29c729f">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#c04acac682ff0cff5eda96378318b87a3c9bf8b90a4d4f25fc98dd1360bba58b">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l02779"></a>02779       NULL, NULL, 0, <span class="stringliteral">"Bridge/%s"</span>, current_dest_chan-&gt;name))) {
<a name="l02780"></a>02780       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot create placeholder channel for chan %s\n"</span>, args.dest_chan);
<a name="l02781"></a>02781       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"BridgeExec"</span>,
<a name="l02782"></a>02782                <span class="stringliteral">"Response: Failed\r\n"</span>
<a name="l02783"></a>02783                <span class="stringliteral">"Reason: cannot create placeholder\r\n"</span>
<a name="l02784"></a>02784                <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l02785"></a>02785                <span class="stringliteral">"Channel2: %s\r\n"</span>, chan-&gt;name, args.dest_chan);
<a name="l02786"></a>02786    }
<a name="l02787"></a>02787    <a class="code" href="res__features_8c.html#0ccd3c45d8833ebc992808719746985c">do_bridge_masquerade</a>(current_dest_chan, final_dest_chan);
<a name="l02788"></a>02788 
<a name="l02789"></a>02789    <span class="comment">/* now current_dest_chan is a ZOMBIE and with softhangup set to 1 and final_dest_chan is our end point */</span>
<a name="l02790"></a>02790    <span class="comment">/* try to make compatible, send error if we fail */</span>
<a name="l02791"></a>02791    <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#d8ebadafdad36d56ae069bd9bbcf7c42">ast_channel_make_compatible</a>(chan, final_dest_chan) &lt; 0) {
<a name="l02792"></a>02792       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not make channels %s and %s compatible for bridge\n"</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l02793"></a>02793       <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"BridgeExec"</span>,
<a name="l02794"></a>02794                <span class="stringliteral">"Response: Failed\r\n"</span>
<a name="l02795"></a>02795                <span class="stringliteral">"Reason: Could not make channels compatible for bridge\r\n"</span>
<a name="l02796"></a>02796                <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l02797"></a>02797                <span class="stringliteral">"Channel2: %s\r\n"</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l02798"></a>02798       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(final_dest_chan); <span class="comment">/* may be we should return this channel to the PBX? */</span>
<a name="l02799"></a>02799       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BRIDGERESULT"</span>, <span class="stringliteral">"INCOMPATIBLE"</span>);
<a name="l02800"></a>02800       <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02801"></a>02801       <span class="keywordflow">return</span> 0;
<a name="l02802"></a>02802    }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804    <span class="comment">/* Report that the bridge will be successfull */</span>
<a name="l02805"></a>02805    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <span class="stringliteral">"BridgeExec"</span>,
<a name="l02806"></a>02806             <span class="stringliteral">"Response: Success\r\n"</span>
<a name="l02807"></a>02807             <span class="stringliteral">"Channel1: %s\r\n"</span>
<a name="l02808"></a>02808             <span class="stringliteral">"Channel2: %s\r\n"</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l02809"></a>02809 
<a name="l02810"></a>02810    <span class="comment">/* we have 2 valid channels to bridge, now it is just a matter of setting up the bridge config and starting the bridge */</span>  
<a name="l02811"></a>02811    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(&amp;opts, <a class="code" href="res__features_8c.html#68986ab776eb5d6b5a809a1c005a730086991876a86bcf49e9ed308ff3a5f676">BRIDGE_OPT_PLAYTONE</a>) &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(<a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>)) {
<a name="l02812"></a>02812       <span class="keywordflow">if</span> (!<a class="code" href="file_8c.html#323e58584ef6ab2486be5b347b23ebe0">ast_streamfile</a>(final_dest_chan, <a class="code" href="res__features_8c.html#3297f5743610ef4e1d96d09afe4eeafd">xfersound</a>, final_dest_chan-&gt;language)) {
<a name="l02813"></a>02813          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#634a25400a6a724d278b9129b9b5181b">ast_waitstream</a>(final_dest_chan, <span class="stringliteral">""</span>) &lt; 0)
<a name="l02814"></a>02814             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to play courtesy tone on %s\n"</span>, final_dest_chan-&gt;name);
<a name="l02815"></a>02815       }
<a name="l02816"></a>02816    }
<a name="l02817"></a>02817    
<a name="l02818"></a>02818    <span class="comment">/* do the bridge */</span>
<a name="l02819"></a>02819    <a class="code" href="features_8h.html#61263ca8af831dbacdf11ec96ed61076">ast_bridge_call</a>(chan, final_dest_chan, &amp;bconfig);
<a name="l02820"></a>02820 
<a name="l02821"></a>02821    <span class="comment">/* the bridge has ended, set BRIDGERESULT to SUCCESS. If the other channel has not been hung up, return it to the PBX */</span>
<a name="l02822"></a>02822    <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"BRIDGERESULT"</span>, <span class="stringliteral">"SUCCESS"</span>);
<a name="l02823"></a>02823    <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#042e64a8d465783855a52ec8c56a9373">ast_check_hangup</a>(final_dest_chan)) {
<a name="l02824"></a>02824       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>) {
<a name="l02825"></a>02825          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"starting new PBX in %s,%s,%d for chan %s\n"</span>, 
<a name="l02826"></a>02826          final_dest_chan-&gt;<a class="code" href="structast__channel.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, final_dest_chan-&gt;<a class="code" href="structast__channel.html#5aedfeaeaac21e5e5f297360633ea9a3">exten</a>, 
<a name="l02827"></a>02827          final_dest_chan-&gt;<a class="code" href="structast__channel.html#b988295c268025b49dfb3df26171ddc3">priority</a>, final_dest_chan-&gt;name);
<a name="l02828"></a>02828       }
<a name="l02829"></a>02829 
<a name="l02830"></a>02830       <span class="keywordflow">if</span> (<a class="code" href="pbx_8c.html#c55e82ff3dabed89efd77f20209b1006">ast_pbx_start</a>(final_dest_chan) != <a class="code" href="pbx_8h.html#bc3ba53eb07b914cc39444bfcf88a912c86643c5e19588b3eb7dce58a2b4145a">AST_PBX_SUCCESS</a>) {
<a name="l02831"></a>02831          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"FAILED continuing PBX on dest chan %s\n"</span>, final_dest_chan-&gt;name);
<a name="l02832"></a>02832          <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(final_dest_chan);
<a name="l02833"></a>02833       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (option_debug)
<a name="l02834"></a>02834          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"SUCCESS continuing PBX on chan %s\n"</span>, final_dest_chan-&gt;name);
<a name="l02835"></a>02835    } <span class="keywordflow">else</span> {
<a name="l02836"></a>02836       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l02837"></a>02837          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"hangup chan %s since the other endpoint has hung up\n"</span>, final_dest_chan-&gt;name);
<a name="l02838"></a>02838       <a class="code" href="channel_8c.html#ff55e854df5692f9b3b8dc64c95a5619">ast_hangup</a>(final_dest_chan);
<a name="l02839"></a>02839    }
<a name="l02840"></a>02840 
<a name="l02841"></a>02841    <a class="code" href="module_8h.html#bc801fe463749e03a890acb67c37fbdd">ast_module_user_remove</a>(u);
<a name="l02842"></a>02842 
<a name="l02843"></a>02843    <span class="keywordflow">return</span> 0;
<a name="l02844"></a>02844 }
<a name="l02845"></a>02845 
<a name="l02846"></a><a class="code" href="res__features_8c.html#91875b0435b600b8ed0e424d70d492b0">02846</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>(<span class="keywordtype">void</span>)
<a name="l02847"></a>02847 {
<a name="l02848"></a>02848    <span class="keywordflow">return</span> <a class="code" href="app__alarmreceiver_8c.html#1630c58a25341e544032331a525418fe">load_config</a>();
<a name="l02849"></a>02849 }
<a name="l02850"></a>02850 
<a name="l02851"></a><a class="code" href="res__features_8c.html#8c304b271325d497b3ce1886465a1abe">02851</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l02852"></a>02852 {
<a name="l02853"></a>02853    <span class="keywordtype">int</span> res;
<a name="l02854"></a>02854 
<a name="l02855"></a>02855    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(app_bridge, <a class="code" href="res__features_8c.html#ea74625bb7af3e0a47a43f2961ddfdef">bridge_exec</a>, bridge_synopsis, bridge_descrip); 
<a name="l02856"></a>02856 
<a name="l02857"></a>02857    memset(<a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#c54a405a0a0f539f9bca43450d6e2541">parking_ext</a>));
<a name="l02858"></a>02858    memset(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="res__features_8c.html#743e866266a3e8e07813ea74b9400fc9">parking_con</a>));
<a name="l02859"></a>02859 
<a name="l02860"></a>02860    <span class="keywordflow">if</span> ((res = <a class="code" href="app__alarmreceiver_8c.html#1630c58a25341e544032331a525418fe">load_config</a>()))
<a name="l02861"></a>02861       <span class="keywordflow">return</span> res;
<a name="l02862"></a>02862    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(cli_features, <span class="keyword">sizeof</span>(cli_features) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l02863"></a>02863    <a class="code" href="utils_8h.html#89a8ad746b25627dd12304511d68a24c">ast_pthread_create</a>(&amp;<a class="code" href="res__features_8c.html#a1b4c23e2029d94fb9090c489fdb6bcf">parking_thread</a>, NULL, <a class="code" href="res__features_8c.html#1cb474fc7a9c1efaa139eb3b8aa96254">do_parking_thread</a>, NULL);
<a name="l02864"></a>02864    res = <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<a class="code" href="res__features_8c.html#6799a0be08d3bdfe0b2b5f19d7546798">parkedcall</a>, <a class="code" href="res__features_8c.html#e0bf626041a7d438d7fdb4f3e667dca1">park_exec</a>, <a class="code" href="chan__agent_8c.html#485d112e4e425dde393e2e7091451856">synopsis</a>, <a class="code" href="chan__agent_8c.html#b0592624714016bb262956be1db49c74">descrip</a>);
<a name="l02865"></a>02865    <span class="keywordflow">if</span> (!res)
<a name="l02866"></a>02866       res = <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<a class="code" href="res__features_8c.html#d4db798eecbddaa591e0427c6267cdb8">parkcall</a>, <a class="code" href="res__features_8c.html#304e90ce99e65886b32d545331b0688b">park_call_exec</a>, <a class="code" href="app__meetme_8c.html#4ba02cd55a25f5f329069177b73d406f">synopsis2</a>, <a class="code" href="app__meetme_8c.html#cb536af3cf5b3ba3c4772802aec813d6">descrip2</a>);
<a name="l02867"></a>02867    <span class="keywordflow">if</span> (!res) {
<a name="l02868"></a>02868       <a class="code" href="manager_8h.html#e4738d78136f7a3a390d7729872d206e">ast_manager_register</a>(<span class="stringliteral">"ParkedCalls"</span>, 0, <a class="code" href="res__features_8c.html#a760944ed197d622dbdc5da62e1a410b">manager_parking_status</a>, <span class="stringliteral">"List parked calls"</span>);
<a name="l02869"></a>02869       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Park"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__features_8c.html#16f883e8bf12e4fdcf78be58d879f951">manager_park</a>,
<a name="l02870"></a>02870          <span class="stringliteral">"Park a channel"</span>, mandescr_park); 
<a name="l02871"></a>02871       <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Bridge"</span>, <a class="code" href="manager_8h.html#055847dde76185d8491133f37610d68d">EVENT_FLAG_COMMAND</a>, <a class="code" href="res__features_8c.html#400db228c82f0ac94aea507e1eaa2e5c">action_bridge</a>, <span class="stringliteral">"Bridge two channels already in the PBX"</span>, mandescr_bridge);
<a name="l02872"></a>02872    }
<a name="l02873"></a>02873 
<a name="l02874"></a>02874    res |= <a class="code" href="devicestate_8c.html#bb0b7d59cba82040757824a5e6df4cf1">ast_devstate_prov_add</a>(<span class="stringliteral">"Park"</span>, <a class="code" href="res__features_8c.html#20c7953bc61de19e6265a62527213440">metermaidstate</a>);
<a name="l02875"></a>02875 
<a name="l02876"></a>02876    <span class="keywordflow">return</span> res;
<a name="l02877"></a>02877 }
<a name="l02878"></a>02878 
<a name="l02879"></a>02879 
<a name="l02880"></a><a class="code" href="res__features_8c.html#eaf793e807a29b69460b0c6c94a79a0b">02880</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l02881"></a>02881 {
<a name="l02882"></a>02882    <a class="code" href="module_8h.html#c41f250c8ab8ddcb77214a7b149c9e71">ast_module_user_hangup_all</a>();
<a name="l02883"></a>02883 
<a name="l02884"></a>02884    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"ParkedCalls"</span>);
<a name="l02885"></a>02885    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"Bridge"</span>);
<a name="l02886"></a>02886    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"Park"</span>);
<a name="l02887"></a>02887    <a class="code" href="cli_8c.html#321c001e02fcba48873965ff141ff29b">ast_cli_unregister_multiple</a>(cli_features, <span class="keyword">sizeof</span>(cli_features) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l02888"></a>02888    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<a class="code" href="res__features_8c.html#d4db798eecbddaa591e0427c6267cdb8">parkcall</a>);
<a name="l02889"></a>02889    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(app_bridge);
<a name="l02890"></a>02890    <a class="code" href="devicestate_8c.html#1996c0db248eebe4b033249932023f02">ast_devstate_prov_del</a>(<span class="stringliteral">"Park"</span>);
<a name="l02891"></a>02891    <span class="keywordflow">return</span> <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<a class="code" href="res__features_8c.html#6799a0be08d3bdfe0b2b5f19d7546798">parkedcall</a>);
<a name="l02892"></a>02892 }
<a name="l02893"></a>02893 
<a name="l02894"></a>02894 <a class="code" href="module_8h.html#237cb97341e39c38b6e3ecb88b7ea148">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#b4566594eeb42c8fc7d6733c7b4b6c0a0b99d39f1f6a9afeedd2f8e6632dd76c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">"Call Features Resource"</span>,
<a name="l02895"></a>02895       .load = <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>,
<a name="l02896"></a>02896       .unload = <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>,
<a name="l02897"></a>02897       .<a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a> = <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>,
<a name="l02898"></a>02898          );
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:49 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
