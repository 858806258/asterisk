<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:27:44 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_odbc.c File Reference</h1>ODBC resource manager. <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="asterisk_8h-source.html">asterisk.h</a>&quot;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &quot;<a class="el" href="file_8h-source.html">asterisk/file.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="logger_8h-source.html">asterisk/logger.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="channel_8h-source.html">asterisk/channel.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="config_8h-source.html">asterisk/config.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="options_8h-source.html">asterisk/options.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="pbx_8h-source.html">asterisk/pbx.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="module_8h-source.html">asterisk/module.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="cli_8h-source.html">asterisk/cli.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="lock_8h-source.html">asterisk/lock.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="res__odbc_8h-source.html">asterisk/res_odbc.h</a>&quot;</code><br>

<p>
<a href="res__odbc_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structodbc__class.html">odbc_class</a></td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#fd87c742392aeacdf280f0b5850fbcb9">AST_LIST_HEAD_STATIC</a> (odbc_list, <a class="el" href="structodbc__class.html">odbc_class</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#a08d39533e8ed9d7f0f5ec75144a8fd8">AST_MODULE_INFO</a> (ASTERISK_GPL_KEY, AST_MODFLAG_GLOBAL_SYMBOLS,&quot;ODBC Resource&quot;,.load=load_module,.unload=unload_module,.reload=reload,)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">SQLHSTMT&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#bf1b89cadc264a6dc88d710c1adc3d8b">ast_odbc_prepare_and_execute</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj, SQLHSTMT(*prepare_cb)(struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj, void *data), void *data)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepares, executes, and returns the resulting statement handle.  <a href="#bf1b89cadc264a6dc88d710c1adc3d8b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#4d7bd206977d04ca110b3850529a5a52">ast_odbc_release_obj</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Releases an ODBC object previously allocated by odbc_request_obj().  <a href="#4d7bd206977d04ca110b3850529a5a52"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#ec1931837e30ff1bf6ec10ae7901328d">ast_odbc_request_obj</a> (const char *<a class="el" href="cdr__tds_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, int check)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Retrieves a connected ODBC object.  <a href="#ec1931837e30ff1bf6ec10ae7901328d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Checks an ODBC object to ensure it is still connected.  <a href="#51a9d1dfb7cccabfde99c97efb0ca968"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#97debb2a25b7aa98164e8372dded0427">ast_odbc_smart_execute</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj, SQLHSTMT stmt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Executes a prepared statement handle.  <a href="#97debb2a25b7aa98164e8372dded0427"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#42b9d592c79c07b36de775afcfa56dca">load_odbc_config</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d">odbc_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#5339baa4ffe6373fc7d14e18a392c430">odbc_obj_connect</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d">odbc_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#440f2e0d3912c5fdebc9b8d36b8c21ff">odbc_obj_disconnect</a> (struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#e6044282b7e259cbd58663ebffbceb2b">odbc_register_class</a> (struct <a class="el" href="structodbc__class.html">odbc_class</a> *class, int connect)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#d5f120614ea3f4bedfd28fe1836de307">odbc_show_command</a> (int fd, int argc, char **argv)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a> (void)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#59fddb8dae33c8b7281dada54629f853">cli_odbc</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static const char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__odbc_8c.html#5e6e2655436c34a31ad44b6961da88ec">show_usage</a> []</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
ODBC resource manager. 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt; <p>
Anthony Minessale II &lt;<a href="mailto:anthmct@yahoo.com">anthmct@yahoo.com</a>&gt;</dd></dl>
<ul>
<li>See also: <a class="el" href="cdr_odbc.html">ODBC CDR driver configuration</a> </li>
</ul>

<p>
Definition in file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.<hr><h2>Function Documentation</h2>
<a class="anchor" name="fd87c742392aeacdf280f0b5850fbcb9"></a><!-- doxytag: member="res_odbc.c::AST_LIST_HEAD_STATIC" ref="fd87c742392aeacdf280f0b5850fbcb9" args="(odbc_list, odbc_class)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">AST_LIST_HEAD_STATIC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">odbc_list&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="structodbc__class.html">odbc_class</a>&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a08d39533e8ed9d7f0f5ec75144a8fd8"></a><!-- doxytag: member="res_odbc.c::AST_MODULE_INFO" ref="a08d39533e8ed9d7f0f5ec75144a8fd8" args="(ASTERISK_GPL_KEY, AST_MODFLAG_GLOBAL_SYMBOLS,&quot;ODBC Resource&quot;,.load=load_module,.unload=unload_module,.reload=reload,)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">AST_MODULE_INFO           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ASTERISK_GPL_KEY&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>AST_MODFLAG_GLOBAL_SYMBOLS&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>&quot;ODBC Resource&quot;&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>.&nbsp;</td>
          <td class="mdname" nowrap> <em>load</em> = <code>load_module</code>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>.&nbsp;</td>
          <td class="mdname" nowrap> <em>unload</em> = <code>unload_module</code>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>.&nbsp;</td>
          <td class="mdname" nowrap> <em>reload</em> = <code>reload</code></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="bf1b89cadc264a6dc88d710c1adc3d8b"></a><!-- doxytag: member="res_odbc.c::ast_odbc_prepare_and_execute" ref="bf1b89cadc264a6dc88d710c1adc3d8b" args="(struct odbc_obj *obj, SQLHSTMT(*prepare_cb)(struct odbc_obj *obj, void *data), void *data)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">SQLHSTMT ast_odbc_prepare_and_execute           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>SQLHSTMT(*)(struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *obj, void *data)&nbsp;</td>
          <td class="mdname" nowrap> <em>prepare_cb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>void *&nbsp;</td>
          <td class="mdname" nowrap> <em>data</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Prepares, executes, and returns the resulting statement handle. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td>The ODBC object </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>prepare_cb</em>&nbsp;</td><td>A function callback, which, when called, should return a statement handle prepared, with any necessary parameters or result columns bound. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>A parameter to be passed to the prepare_cb parameter function, indicating which statement handle is to be prepared. </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns a statement handle or NULL on error. </dd></dl>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00079">79</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="res__odbc_8c-source.html#l00172">ast_odbc_sanity_check()</a>, and <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>.
<p>
Referenced by <a class="el" href="func__odbc_8c-source.html#l00199">acf_odbc_read()</a>, <a class="el" href="func__odbc_8c-source.html#l00099">acf_odbc_write()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00483">config_odbc()</a>, and <a class="el" href="cdr__adaptive__odbc_8c-source.html#l00299">odbc_log()</a>.<div class="fragment"><pre class="fragment"><a name="l00080"></a>00080 {
<a name="l00081"></a>00081    <span class="keywordtype">int</span> res = 0, i, attempt;
<a name="l00082"></a>00082    SQLINTEGER nativeerror=0, numfields=0;
<a name="l00083"></a>00083    SQLSMALLINT diagbytes=0;
<a name="l00084"></a>00084    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structstate.html">state</a>[10], diagnostic[256];
<a name="l00085"></a>00085    SQLHSTMT stmt;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087    <span class="keywordflow">for</span> (attempt = 0; attempt &lt; 2; attempt++) {
<a name="l00088"></a>00088       <span class="comment">/* This prepare callback may do more than just prepare -- it may also</span>
<a name="l00089"></a>00089 <span class="comment">       * bind parameters, bind results, etc.  The real key, here, is that</span>
<a name="l00090"></a>00090 <span class="comment">       * when we disconnect, all handles become invalid for most databases.</span>
<a name="l00091"></a>00091 <span class="comment">       * We must therefore redo everything when we establish a new</span>
<a name="l00092"></a>00092 <span class="comment">       * connection. */</span>
<a name="l00093"></a>00093       stmt = prepare_cb(obj, data);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095       <span class="keywordflow">if</span> (stmt) {
<a name="l00096"></a>00096          res = SQLExecute(stmt);
<a name="l00097"></a>00097          <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO) &amp;&amp; (res != SQL_NO_DATA)) {
<a name="l00098"></a>00098             <span class="keywordflow">if</span> (res == SQL_ERROR) {
<a name="l00099"></a>00099                SQLGetDiagField(SQL_HANDLE_STMT, stmt, 1, SQL_DIAG_NUMBER, &amp;numfields, SQL_IS_INTEGER, &amp;diagbytes);
<a name="l00100"></a>00100                <span class="keywordflow">for</span> (i = 0; i &lt; numfields; i++) {
<a name="l00101"></a>00101                   SQLGetDiagRec(SQL_HANDLE_STMT, stmt, i + 1, state, &amp;nativeerror, diagnostic, <span class="keyword">sizeof</span>(diagnostic), &amp;diagbytes);
<a name="l00102"></a>00102                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"SQL Execute returned an error %d: %s: %s (%d)\n"</span>, res, state, diagnostic, diagbytes);
<a name="l00103"></a>00103                   <span class="keywordflow">if</span> (i &gt; 10) {
<a name="l00104"></a>00104                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Oh, that was good.  There are really %d diagnostics?\n"</span>, (<span class="keywordtype">int</span>)numfields);
<a name="l00105"></a>00105                      <span class="keywordflow">break</span>;
<a name="l00106"></a>00106                   }
<a name="l00107"></a>00107                }
<a name="l00108"></a>00108             }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"SQL Execute error %d! Attempting a reconnect...\n"</span>, res);
<a name="l00111"></a>00111             SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l00112"></a>00112             stmt = NULL;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114             obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00115"></a>00115             <span class="comment">/*</span>
<a name="l00116"></a>00116 <span class="comment">             * While this isn't the best way to try to correct an error, this won't automatically</span>
<a name="l00117"></a>00117 <span class="comment">             * fail when the statement handle invalidates.</span>
<a name="l00118"></a>00118 <span class="comment">             */</span>
<a name="l00119"></a>00119             <a class="code" href="res__odbc_8h.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a>(obj);
<a name="l00120"></a>00120             <span class="keywordflow">continue</span>;
<a name="l00121"></a>00121          }
<a name="l00122"></a>00122          <span class="keywordflow">break</span>;
<a name="l00123"></a>00123       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (attempt == 0)
<a name="l00124"></a>00124          <a class="code" href="res__odbc_8h.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a>(obj);
<a name="l00125"></a>00125    }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127    <span class="keywordflow">return</span> stmt;
<a name="l00128"></a>00128 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="4d7bd206977d04ca110b3850529a5a52"></a><!-- doxytag: member="res_odbc.c::ast_odbc_release_obj" ref="4d7bd206977d04ca110b3850529a5a52" args="(struct odbc_obj *obj)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ast_odbc_release_obj           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>obj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Releases an ODBC object previously allocated by odbc_request_obj(). 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td>The ODBC object </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00377">377</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="res__odbc_8h-source.html#l00040">odbc_obj::used</a>.
<p>
Referenced by <a class="el" href="func__odbc_8c-source.html#l00199">acf_odbc_read()</a>, <a class="el" href="func__odbc_8c-source.html#l00099">acf_odbc_write()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00483">config_odbc()</a>, <a class="el" href="cdr__adaptive__odbc_8c-source.html#l00083">load_config()</a>, <a class="el" href="cdr__adaptive__odbc_8c-source.html#l00299">odbc_log()</a>, <a class="el" href="res__odbc_8c-source.html#l00355">odbc_register_class()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00204">realtime_multi_odbc()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00056">realtime_odbc()</a>, and <a class="el" href="res__config__odbc_8c-source.html#l00361">update_odbc()</a>.<div class="fragment"><pre class="fragment"><a name="l00378"></a>00378 {
<a name="l00379"></a>00379    <span class="comment">/* For pooled connections, this frees the connection to be</span>
<a name="l00380"></a>00380 <span class="comment">    * reused.  For non-pooled connections, it does nothing. */</span>
<a name="l00381"></a>00381    obj-&gt;<a class="code" href="structodbc__obj.html#1aec9c5d0644e11fd9dd0f9fb36009fb">used</a> = 0;
<a name="l00382"></a>00382 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="ec1931837e30ff1bf6ec10ae7901328d"></a><!-- doxytag: member="res_odbc.c::ast_odbc_request_obj" ref="ec1931837e30ff1bf6ec10ae7901328d" args="(const char *name, int check)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a>* ast_odbc_request_obj           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>check</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Retrieves a connected ODBC object. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>The name of the ODBC class for which a connection is needed. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>check</em>&nbsp;</td><td>Whether to ensure that a connection is valid before returning the handle. Usually unnecessary. </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns an ODBC object or NULL if there is no connection available with the requested name.</dd></dl>
Connection classes may, in fact, contain multiple connection handles. If the connection is pooled, then each connection will be dedicated to the thread which requests it. Note that all connections should be released when the thread is done by calling odbc_release_obj(), below. 
<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00384">384</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="linkedlists_8h-source.html#l00650">AST_LIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h-source.html#l00670">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h-source.html#l00038">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h-source.html#l00453">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h-source.html#l00104">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00525">ast_mutex_destroy()</a>, <a class="el" href="lock_8h-source.html#l00508">ast_mutex_init()</a>, <a class="el" href="res__odbc_8c-source.html#l00172">ast_odbc_sanity_check()</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d811154e1a371e8517989c329c5499980">ODBC_FAIL</a>, <a class="el" href="res__odbc_8c-source.html#l00473">odbc_obj_connect()</a>, and <a class="el" href="res__odbc_8h-source.html#l00040">odbc_obj::used</a>.
<p>
Referenced by <a class="el" href="func__odbc_8c-source.html#l00199">acf_odbc_read()</a>, <a class="el" href="func__odbc_8c-source.html#l00099">acf_odbc_write()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00483">config_odbc()</a>, <a class="el" href="cdr__adaptive__odbc_8c-source.html#l00083">load_config()</a>, <a class="el" href="cdr__adaptive__odbc_8c-source.html#l00299">odbc_log()</a>, <a class="el" href="res__odbc_8c-source.html#l00355">odbc_register_class()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00204">realtime_multi_odbc()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00056">realtime_odbc()</a>, and <a class="el" href="res__config__odbc_8c-source.html#l00361">update_odbc()</a>.<div class="fragment"><pre class="fragment"><a name="l00385"></a>00385 {
<a name="l00386"></a>00386    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html">odbc_obj</a> *obj = NULL;
<a name="l00387"></a>00387    <span class="keyword">struct </span><a class="code" href="structodbc__class.html">odbc_class</a> *<span class="keyword">class</span>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;odbc_list);
<a name="l00390"></a>00390    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;odbc_list, <span class="keyword">class</span>, list) {
<a name="l00391"></a>00391       <span class="keywordflow">if</span> (!strcmp(class-&gt;name, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>))
<a name="l00392"></a>00392          <span class="keywordflow">break</span>;
<a name="l00393"></a>00393    }
<a name="l00394"></a>00394    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;odbc_list);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="keywordflow">if</span> (!<span class="keyword">class</span>)
<a name="l00397"></a>00397       <span class="keywordflow">return</span> NULL;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;class-&gt;odbc_obj);
<a name="l00400"></a>00400    <span class="keywordflow">if</span> (class-&gt;haspool) {
<a name="l00401"></a>00401       <span class="comment">/* Recycle connections before building another */</span>
<a name="l00402"></a>00402       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;class-&gt;odbc_obj, obj, list) {
<a name="l00403"></a>00403          <span class="keywordflow">if</span> (! obj-&gt;<a class="code" href="structodbc__obj.html#1aec9c5d0644e11fd9dd0f9fb36009fb">used</a>) {
<a name="l00404"></a>00404             obj-&gt;<a class="code" href="structodbc__obj.html#1aec9c5d0644e11fd9dd0f9fb36009fb">used</a> = 1;
<a name="l00405"></a>00405             <span class="keywordflow">break</span>;
<a name="l00406"></a>00406          }
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409       <span class="keywordflow">if</span> (!obj &amp;&amp; (class-&gt;count &lt; class-&gt;limit)) {
<a name="l00410"></a>00410          <span class="keyword">class</span>-&gt;count++;
<a name="l00411"></a>00411          obj = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*obj));
<a name="l00412"></a>00412          <span class="keywordflow">if</span> (!obj) {
<a name="l00413"></a>00413             <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;class-&gt;odbc_obj);
<a name="l00414"></a>00414             <span class="keywordflow">return</span> NULL;
<a name="l00415"></a>00415          }
<a name="l00416"></a>00416          <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00417"></a>00417          obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a> = <span class="keyword">class</span>;
<a name="l00418"></a>00418          <a class="code" href="res__odbc_8c.html#5339baa4ffe6373fc7d14e18a392c430">odbc_obj_connect</a>(obj);
<a name="l00419"></a>00419          <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;class-&gt;odbc_obj, obj, list);
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421    } <span class="keywordflow">else</span> {
<a name="l00422"></a>00422       <span class="comment">/* Non-pooled connection: multiple modules can use the same connection. */</span>
<a name="l00423"></a>00423       <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;class-&gt;odbc_obj, obj, list) {
<a name="l00424"></a>00424          <span class="comment">/* Non-pooled connection: if there is an entry, return it */</span>
<a name="l00425"></a>00425          <span class="keywordflow">break</span>;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428       <span class="keywordflow">if</span> (!obj) {
<a name="l00429"></a>00429          <span class="comment">/* No entry: build one */</span>
<a name="l00430"></a>00430          obj = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*obj));
<a name="l00431"></a>00431          <span class="keywordflow">if</span> (!obj) {
<a name="l00432"></a>00432             <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;class-&gt;odbc_obj);
<a name="l00433"></a>00433             <span class="keywordflow">return</span> NULL;
<a name="l00434"></a>00434          }
<a name="l00435"></a>00435          <a class="code" href="lock_8h.html#33e99ac90b0ca47211841b5cab79ffc4">ast_mutex_init</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00436"></a>00436          obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a> = <span class="keyword">class</span>;
<a name="l00437"></a>00437          <span class="keywordflow">if</span> (<a class="code" href="res__odbc_8c.html#5339baa4ffe6373fc7d14e18a392c430">odbc_obj_connect</a>(obj) == <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d811154e1a371e8517989c329c5499980">ODBC_FAIL</a>) {
<a name="l00438"></a>00438             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Failed to connect to %s\n"</span>, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00439"></a>00439             <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00440"></a>00440             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(obj);
<a name="l00441"></a>00441             obj = NULL;
<a name="l00442"></a>00442          } <span class="keywordflow">else</span> {
<a name="l00443"></a>00443             <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;class-&gt;odbc_obj, obj, list);
<a name="l00444"></a>00444          }
<a name="l00445"></a>00445       }
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;class-&gt;odbc_obj);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="keywordflow">if</span> (obj &amp;&amp; check) {
<a name="l00450"></a>00450       <a class="code" href="res__odbc_8h.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a>(obj);
<a name="l00451"></a>00451    }
<a name="l00452"></a>00452    <span class="keywordflow">return</span> obj;
<a name="l00453"></a>00453 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="51a9d1dfb7cccabfde99c97efb0ca968"></a><!-- doxytag: member="res_odbc.c::ast_odbc_sanity_check" ref="51a9d1dfb7cccabfde99c97efb0ca968" args="(struct odbc_obj *obj)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_odbc_sanity_check           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>obj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Checks an ODBC object to ensure it is still connected. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td>The ODBC object </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns 0 if connected, -1 otherwise. </dd></dl>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00172">172</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="res__odbc_8h-source.html#l00038">odbc_obj::con</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="res__odbc_8c-source.html#l00473">odbc_obj_connect()</a>, <a class="el" href="res__odbc_8c-source.html#l00455">odbc_obj_disconnect()</a>, <a class="el" href="res__odbc_8h-source.html#l00039">odbc_obj::parent</a>, and <a class="el" href="res__odbc_8h-source.html#l00041">odbc_obj::up</a>.
<p>
Referenced by <a class="el" href="res__odbc_8c-source.html#l00079">ast_odbc_prepare_and_execute()</a>, <a class="el" href="res__odbc_8c-source.html#l00384">ast_odbc_request_obj()</a>, and <a class="el" href="res__odbc_8c-source.html#l00312">odbc_show_command()</a>.<div class="fragment"><pre class="fragment"><a name="l00173"></a>00173 {
<a name="l00174"></a>00174    <span class="keywordtype">char</span> *test_sql = <span class="stringliteral">"select 1"</span>;
<a name="l00175"></a>00175    SQLHSTMT stmt;
<a name="l00176"></a>00176    <span class="keywordtype">int</span> res = 0;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178    <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;sanitysql)
<a name="l00179"></a>00179       test_sql = obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;sanitysql;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181    <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a>) {
<a name="l00182"></a>00182       res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>, &amp;stmt);
<a name="l00183"></a>00183       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00184"></a>00184          obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00185"></a>00185       } <span class="keywordflow">else</span> {
<a name="l00186"></a>00186          res = SQLPrepare(stmt, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)test_sql, SQL_NTS);
<a name="l00187"></a>00187          <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00188"></a>00188             obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00189"></a>00189          } <span class="keywordflow">else</span> {
<a name="l00190"></a>00190             res = SQLExecute(stmt);
<a name="l00191"></a>00191             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00192"></a>00192                obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00193"></a>00193             }
<a name="l00194"></a>00194          }
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l00197"></a>00197    }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199    <span class="keywordflow">if</span> (!obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a>) { <span class="comment">/* Try to reconnect! */</span>
<a name="l00200"></a>00200       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Connection is down attempting to reconnect...\n"</span>);
<a name="l00201"></a>00201       <a class="code" href="res__odbc_8c.html#440f2e0d3912c5fdebc9b8d36b8c21ff">odbc_obj_disconnect</a>(obj);
<a name="l00202"></a>00202       <a class="code" href="res__odbc_8c.html#5339baa4ffe6373fc7d14e18a392c430">odbc_obj_connect</a>(obj);
<a name="l00203"></a>00203    }
<a name="l00204"></a>00204    <span class="keywordflow">return</span> obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a>;
<a name="l00205"></a>00205 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="97debb2a25b7aa98164e8372dded0427"></a><!-- doxytag: member="res_odbc.c::ast_odbc_smart_execute" ref="97debb2a25b7aa98164e8372dded0427" args="(struct odbc_obj *obj, SQLHSTMT stmt)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ast_odbc_smart_execute           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>SQLHSTMT&nbsp;</td>
          <td class="mdname" nowrap> <em>stmt</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Executes a prepared statement handle. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td>The non-NULL result of odbc_request_obj() </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>stmt</em>&nbsp;</td><td>The prepared statement handle </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>Returns 0 on success or -1 on failure</dd></dl>
This function was originally designed simply to execute a prepared statement handle and to retry if the initial execution failed. Unfortunately, it did this by disconnecting and reconnecting the database handle which on most databases causes the statement handle to become invalid. Therefore, this method has been deprecated in favor of odbc_prepare_and_execute() which allows the statement to be prepared multiple times, if necessary, in case of a loss of connection.<p>
This function really only ever worked with MySQL, where the statement handle is not prepared on the server. If you are not using MySQL, you should avoid it. 
<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00130">130</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="res__odbc_8h-source.html#l00037">odbc_obj::lock</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="res__odbc_8c-source.html#l00473">odbc_obj_connect()</a>, <a class="el" href="res__odbc_8c-source.html#l00455">odbc_obj_disconnect()</a>, and <a class="el" href="res__odbc_8h-source.html#l00041">odbc_obj::up</a>.
<p>
Referenced by <a class="el" href="res__config__odbc_8c-source.html#l00204">realtime_multi_odbc()</a>, <a class="el" href="res__config__odbc_8c-source.html#l00056">realtime_odbc()</a>, and <a class="el" href="res__config__odbc_8c-source.html#l00361">update_odbc()</a>.<div class="fragment"><pre class="fragment"><a name="l00131"></a>00131 {
<a name="l00132"></a>00132    <span class="keywordtype">int</span> res = 0, i;
<a name="l00133"></a>00133    SQLINTEGER nativeerror=0, numfields=0;
<a name="l00134"></a>00134    SQLSMALLINT diagbytes=0;
<a name="l00135"></a>00135    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structstate.html">state</a>[10], diagnostic[256];
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    res = SQLExecute(stmt);
<a name="l00138"></a>00138    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO) &amp;&amp; (res != SQL_NO_DATA)) {
<a name="l00139"></a>00139       <span class="keywordflow">if</span> (res == SQL_ERROR) {
<a name="l00140"></a>00140          SQLGetDiagField(SQL_HANDLE_STMT, stmt, 1, SQL_DIAG_NUMBER, &amp;numfields, SQL_IS_INTEGER, &amp;diagbytes);
<a name="l00141"></a>00141          <span class="keywordflow">for</span> (i = 0; i &lt; numfields; i++) {
<a name="l00142"></a>00142             SQLGetDiagRec(SQL_HANDLE_STMT, stmt, i + 1, state, &amp;nativeerror, diagnostic, <span class="keyword">sizeof</span>(diagnostic), &amp;diagbytes);
<a name="l00143"></a>00143             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"SQL Execute returned an error %d: %s: %s (%d)\n"</span>, res, state, diagnostic, diagbytes);
<a name="l00144"></a>00144             <span class="keywordflow">if</span> (i &gt; 10) {
<a name="l00145"></a>00145                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Oh, that was good.  There are really %d diagnostics?\n"</span>, (<span class="keywordtype">int</span>)numfields);
<a name="l00146"></a>00146                <span class="keywordflow">break</span>;
<a name="l00147"></a>00147             }
<a name="l00148"></a>00148          }
<a name="l00149"></a>00149       }
<a name="l00150"></a>00150 <span class="preprocessor">#if 0</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>      <span class="comment">/* This is a really bad method of trying to correct a dead connection.  It</span>
<a name="l00152"></a>00152 <span class="comment">       * only ever really worked with MySQL.  It will not work with any other</span>
<a name="l00153"></a>00153 <span class="comment">       * database, since most databases prepare their statements on the server,</span>
<a name="l00154"></a>00154 <span class="comment">       * and if you disconnect, you invalidate the statement handle.  Hence, if</span>
<a name="l00155"></a>00155 <span class="comment">       * you disconnect, you're going to fail anyway, whether you try to execute</span>
<a name="l00156"></a>00156 <span class="comment">       * a second time or not.</span>
<a name="l00157"></a>00157 <span class="comment">       */</span>
<a name="l00158"></a>00158       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"SQL Execute error %d! Attempting a reconnect...\n"</span>, res);
<a name="l00159"></a>00159       <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00160"></a>00160       obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00161"></a>00161       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00162"></a>00162       <a class="code" href="res__odbc_8c.html#440f2e0d3912c5fdebc9b8d36b8c21ff">odbc_obj_disconnect</a>(obj);
<a name="l00163"></a>00163       <a class="code" href="res__odbc_8c.html#5339baa4ffe6373fc7d14e18a392c430">odbc_obj_connect</a>(obj);
<a name="l00164"></a>00164       res = SQLExecute(stmt);
<a name="l00165"></a>00165 <span class="preprocessor">#endif</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>   }
<a name="l00167"></a>00167    
<a name="l00168"></a>00168    <span class="keywordflow">return</span> res;
<a name="l00169"></a>00169 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="8c304b271325d497b3ce1886465a1abe"></a><!-- doxytag: member="res_odbc.c::load_module" ref="8c304b271325d497b3ce1886465a1abe" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int load_module           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00680">680</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="cli_8c-source.html#l01352">ast_cli_register_multiple()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="module_8h.html#6b66b922ea50fb20d0a8a25ba8317b0adea6426eed250d0d922d7e289a706663">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="res__odbc_8c-source.html#l00207">load_odbc_config()</a>, and <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>.<div class="fragment"><pre class="fragment"><a name="l00681"></a>00681 {
<a name="l00682"></a>00682    <span class="keywordflow">if</span>(<a class="code" href="res__odbc_8c.html#42b9d592c79c07b36de775afcfa56dca">load_odbc_config</a>() == -1)
<a name="l00683"></a>00683       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#6b66b922ea50fb20d0a8a25ba8317b0adea6426eed250d0d922d7e289a706663">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00684"></a>00684    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(<a class="code" href="res__odbc_8c.html#59fddb8dae33c8b7281dada54629f853">cli_odbc</a>, <span class="keyword">sizeof</span>(cli_odbc) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l00685"></a>00685    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"res_odbc loaded.\n"</span>);
<a name="l00686"></a>00686    <span class="keywordflow">return</span> 0;
<a name="l00687"></a>00687 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="42b9d592c79c07b36de775afcfa56dca"></a><!-- doxytag: member="res_odbc.c::load_odbc_config" ref="42b9d592c79c07b36de775afcfa56dca" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int load_odbc_config           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00207">207</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="config_8c-source.html#l00357">ast_category_browse()</a>, <a class="el" href="config_8c-source.html#l00555">ast_config_destroy()</a>, <a class="el" href="config_8c-source.html#l01278">ast_config_load()</a>, <a class="el" href="utils_8c-source.html#l00741">ast_false()</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="utils_8c-source.html#l00724">ast_true()</a>, <a class="el" href="config_8c-source.html#l00222">ast_variable_browse()</a>, <a class="el" href="chan__agent_8c-source.html#l00077">config</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">dsn</a>, <a class="el" href="cdr_8c-source.html#l00091">enabled</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="config_8h-source.html#l00039">ast_variable::name</a>, <a class="el" href="config_8h-source.html#l00046">ast_variable::next</a>, <a class="el" href="res__odbc_8c-source.html#l00355">odbc_register_class()</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">password</a>, <a class="el" href="strcompat_8c-source.html#l00062">setenv()</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">username</a>, and <a class="el" href="config_8h-source.html#l00040">ast_variable::value</a>.
<p>
Referenced by <a class="el" href="res__odbc_8c-source.html#l00680">load_module()</a>.<div class="fragment"><pre class="fragment"><a name="l00208"></a>00208 {
<a name="l00209"></a>00209    <span class="keyword">static</span> <span class="keywordtype">char</span> *cfg = <span class="stringliteral">"res_odbc.conf"</span>;
<a name="l00210"></a>00210    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>;
<a name="l00211"></a>00211    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00212"></a>00212    <span class="keywordtype">char</span> *cat, *<a class="code" href="cdr__odbc_8c.html#da532bf806defa26fdbeee5dd2e0d68f">dsn</a>, *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, *<a class="code" href="cdr__odbc_8c.html#5f4dcc3b5aa765d61d8327deb882cf99">password</a>, *sanitysql;
<a name="l00213"></a>00213    <span class="keywordtype">int</span> <a class="code" href="cdr_8c.html#a10311459433adf322f2590a4987c423">enabled</a>, pooling, limit;
<a name="l00214"></a>00214    <span class="keywordtype">int</span> connect = 0, res = 0;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216    <span class="keyword">struct </span><a class="code" href="structodbc__class.html">odbc_class</a> *<span class="keyword">new</span>;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218    config = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(cfg);
<a name="l00219"></a>00219    <span class="keywordflow">if</span> (!config) {
<a name="l00220"></a>00220       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to load config file res_odbc.conf\n"</span>);
<a name="l00221"></a>00221       <span class="keywordflow">return</span> -1;
<a name="l00222"></a>00222    }
<a name="l00223"></a>00223    <span class="keywordflow">for</span> (cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(config, NULL); cat; cat=<a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(config, cat)) {
<a name="l00224"></a>00224       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">"ENV"</span>)) {
<a name="l00225"></a>00225          <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(config, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00226"></a>00226             <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, 1);
<a name="l00227"></a>00227             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Adding ENV var: %s=%s\n"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00228"></a>00228          }
<a name="l00229"></a>00229       } <span class="keywordflow">else</span> {
<a name="l00230"></a>00230          <span class="comment">/* Reset all to defaults for each class of odbc connections */</span>
<a name="l00231"></a>00231          dsn = username = password = sanitysql = NULL;
<a name="l00232"></a>00232          enabled = 1;
<a name="l00233"></a>00233          connect = 0;
<a name="l00234"></a>00234          pooling = 0;
<a name="l00235"></a>00235          limit = 0;
<a name="l00236"></a>00236          <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(config, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00237"></a>00237             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"pooling"</span>)) {
<a name="l00238"></a>00238                <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>))
<a name="l00239"></a>00239                   pooling = 1;
<a name="l00240"></a>00240             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"limit"</span>)) {
<a name="l00241"></a>00241                sscanf(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;limit);
<a name="l00242"></a>00242                <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>) &amp;&amp; !limit) {
<a name="l00243"></a>00243                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Limit should be a number, not a boolean: '%s'.  Setting limit to 1023 for ODBC class '%s'.\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, cat);
<a name="l00244"></a>00244                   limit = 1023;
<a name="l00245"></a>00245                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#b293ff11e14865b872f7430896646c2e">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>)) {
<a name="l00246"></a>00246                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Limit should be a number, not a boolean: '%s'.  Disabling ODBC class '%s'.\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, cat);
<a name="l00247"></a>00247                   enabled = 0;
<a name="l00248"></a>00248                   <span class="keywordflow">break</span>;
<a name="l00249"></a>00249                }
<a name="l00250"></a>00250             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"enabled"</span>)) {
<a name="l00251"></a>00251                enabled = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00252"></a>00252             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"pre-connect"</span>)) {
<a name="l00253"></a>00253                connect = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00254"></a>00254             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"dsn"</span>)) {
<a name="l00255"></a>00255                dsn = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00256"></a>00256             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"username"</span>)) {
<a name="l00257"></a>00257                username = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00258"></a>00258             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"password"</span>)) {
<a name="l00259"></a>00259                password = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00260"></a>00260             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"sanitysql"</span>)) {
<a name="l00261"></a>00261                sanitysql = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00262"></a>00262             }
<a name="l00263"></a>00263          }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265          <span class="keywordflow">if</span> (enabled &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dsn)) {
<a name="l00266"></a>00266             <span class="keyword">new</span> = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*<span class="keyword">new</span>));
<a name="l00267"></a>00267 
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l00269"></a>00269                res = -1;
<a name="l00270"></a>00270                <span class="keywordflow">break</span>;
<a name="l00271"></a>00271             }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273             <span class="keywordflow">if</span> (cat)
<a name="l00274"></a>00274                ast_copy_string(new-&gt;name, cat, <span class="keyword">sizeof</span>(new-&gt;name));
<a name="l00275"></a>00275             <span class="keywordflow">if</span> (dsn)
<a name="l00276"></a>00276                ast_copy_string(new-&gt;dsn, dsn, <span class="keyword">sizeof</span>(new-&gt;dsn));
<a name="l00277"></a>00277             <span class="keywordflow">if</span> (username)
<a name="l00278"></a>00278                ast_copy_string(new-&gt;username, username, <span class="keyword">sizeof</span>(new-&gt;username));
<a name="l00279"></a>00279             <span class="keywordflow">if</span> (password)
<a name="l00280"></a>00280                ast_copy_string(new-&gt;password, password, <span class="keyword">sizeof</span>(new-&gt;password));
<a name="l00281"></a>00281             <span class="keywordflow">if</span> (sanitysql)
<a name="l00282"></a>00282                ast_copy_string(new-&gt;sanitysql, sanitysql, <span class="keyword">sizeof</span>(new-&gt;sanitysql));
<a name="l00283"></a>00283 
<a name="l00284"></a>00284             SQLAllocHandle(SQL_HANDLE_ENV, SQL_NULL_HANDLE, &amp;new-&gt;env);
<a name="l00285"></a>00285             res = SQLSetEnvAttr(new-&gt;env, SQL_ATTR_ODBC_VERSION, (<span class="keywordtype">void</span> *) SQL_OV_ODBC3, 0);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00288"></a>00288                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: Error SetEnv\n"</span>);
<a name="l00289"></a>00289                SQLFreeHandle(SQL_HANDLE_ENV, new-&gt;env);
<a name="l00290"></a>00290                <span class="keywordflow">return</span> res;
<a name="l00291"></a>00291             }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293             <span class="keywordflow">if</span> (pooling) {
<a name="l00294"></a>00294                <span class="keyword">new</span>-&gt;haspool = pooling;
<a name="l00295"></a>00295                <span class="keywordflow">if</span> (limit) {
<a name="l00296"></a>00296                   <span class="keyword">new</span>-&gt;limit = limit;
<a name="l00297"></a>00297                } <span class="keywordflow">else</span> {
<a name="l00298"></a>00298                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Pooling without also setting a limit is pointless.  Changing limit from 0 to 5.\n"</span>);
<a name="l00299"></a>00299                   <span class="keyword">new</span>-&gt;limit = 5;
<a name="l00300"></a>00300                }
<a name="l00301"></a>00301             }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303             <a class="code" href="res__odbc_8c.html#e6044282b7e259cbd58663ebffbceb2b">odbc_register_class</a>(<span class="keyword">new</span>, connect);
<a name="l00304"></a>00304             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Registered ODBC class '%s' dsn-&gt;[%s]\n"</span>, cat, dsn);
<a name="l00305"></a>00305          }
<a name="l00306"></a>00306       }
<a name="l00307"></a>00307    }
<a name="l00308"></a>00308    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(config);
<a name="l00309"></a>00309    <span class="keywordflow">return</span> res;
<a name="l00310"></a>00310 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="5339baa4ffe6373fc7d14e18a392c430"></a><!-- doxytag: member="res_odbc.c::odbc_obj_connect" ref="5339baa4ffe6373fc7d14e18a392c430" args="(struct odbc_obj *obj)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d">odbc_status</a> odbc_obj_connect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>obj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00473">473</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="res__odbc_8h-source.html#l00038">odbc_obj::con</a>, <a class="el" href="res__odbc_8h-source.html#l00037">odbc_obj::lock</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="adsistub_8c-source.html#l00061">msg</a>, <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d811154e1a371e8517989c329c5499980">ODBC_FAIL</a>, <a class="el" href="res__odbc_8c-source.html#l00455">odbc_obj_disconnect()</a>, <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d52980cf07eb0cd6d8a1a6009ece2413d">ODBC_SUCCESS</a>, <a class="el" href="res__odbc_8h-source.html#l00039">odbc_obj::parent</a>, and <a class="el" href="res__odbc_8h-source.html#l00041">odbc_obj::up</a>.
<p>
Referenced by <a class="el" href="res__odbc_8c-source.html#l00384">ast_odbc_request_obj()</a>, <a class="el" href="res__odbc_8c-source.html#l00172">ast_odbc_sanity_check()</a>, and <a class="el" href="res__odbc_8c-source.html#l00130">ast_odbc_smart_execute()</a>.<div class="fragment"><pre class="fragment"><a name="l00474"></a>00474 {
<a name="l00475"></a>00475    <span class="keywordtype">int</span> res;
<a name="l00476"></a>00476    SQLINTEGER err;
<a name="l00477"></a>00477    <span class="keywordtype">short</span> <span class="keywordtype">int</span> mlen;
<a name="l00478"></a>00478    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>[200], stat[10];
<a name="l00479"></a>00479 <span class="preprocessor">#ifdef NEEDTRACE</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>   SQLINTEGER enable = 1;
<a name="l00481"></a>00481    <span class="keywordtype">char</span> *tracefile = <span class="stringliteral">"/tmp/odbc.trace"</span>;
<a name="l00482"></a>00482 <span class="preprocessor">#endif</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    res = SQLAllocHandle(SQL_HANDLE_DBC, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;env, &amp;obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00488"></a>00488 
<a name="l00489"></a>00489       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: Error AllocHDB %d\n"</span>, res);
<a name="l00490"></a>00490       SQLFreeHandle(SQL_HANDLE_ENV, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;env);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00493"></a>00493       <span class="keywordflow">return</span> <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d811154e1a371e8517989c329c5499980">ODBC_FAIL</a>;
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495    SQLSetConnectAttr(obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>, SQL_LOGIN_TIMEOUT, (SQLPOINTER *) 10, 0);
<a name="l00496"></a>00496 <span class="preprocessor">#ifdef NEEDTRACE</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span>   SQLSetConnectAttr(obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>, SQL_ATTR_TRACE, &amp;enable, SQL_IS_INTEGER);
<a name="l00498"></a>00498    SQLSetConnectAttr(obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>, SQL_ATTR_TRACEFILE, tracefile, strlen(tracefile));
<a name="l00499"></a>00499 <span class="preprocessor">#endif</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>
<a name="l00501"></a>00501    <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a>) {
<a name="l00502"></a>00502       <a class="code" href="res__odbc_8c.html#440f2e0d3912c5fdebc9b8d36b8c21ff">odbc_obj_disconnect</a>(obj);
<a name="l00503"></a>00503       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Re-connecting %s\n"</span>, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;name);
<a name="l00504"></a>00504    } <span class="keywordflow">else</span> {
<a name="l00505"></a>00505       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Connecting %s\n"</span>, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;name);
<a name="l00506"></a>00506    }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508    res = SQLConnect(obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>,
<a name="l00509"></a>00509          (SQLCHAR *) obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;dsn, SQL_NTS,
<a name="l00510"></a>00510          (SQLCHAR *) obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;username, SQL_NTS,
<a name="l00511"></a>00511          (SQLCHAR *) obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;password, SQL_NTS);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00514"></a>00514       SQLGetDiagRec(SQL_HANDLE_DBC, obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>, 1, stat, &amp;err, msg, 100, &amp;mlen);
<a name="l00515"></a>00515       <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00516"></a>00516       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: Error SQLConnect=%d errno=%d %s\n"</span>, res, (<span class="keywordtype">int</span>)err, msg);
<a name="l00517"></a>00517       <span class="keywordflow">return</span> <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d811154e1a371e8517989c329c5499980">ODBC_FAIL</a>;
<a name="l00518"></a>00518    } <span class="keywordflow">else</span> {
<a name="l00519"></a>00519       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"res_odbc: Connected to %s [%s]\n"</span>, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;name, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;dsn);
<a name="l00520"></a>00520       obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 1;
<a name="l00521"></a>00521    }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00524"></a>00524    <span class="keywordflow">return</span> <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d52980cf07eb0cd6d8a1a6009ece2413d">ODBC_SUCCESS</a>;
<a name="l00525"></a>00525 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="440f2e0d3912c5fdebc9b8d36b8c21ff"></a><!-- doxytag: member="res_odbc.c::odbc_obj_disconnect" ref="440f2e0d3912c5fdebc9b8d36b8c21ff" args="(struct odbc_obj *obj)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d">odbc_status</a> odbc_obj_disconnect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__obj.html">odbc_obj</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>obj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00455">455</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00530">ast_mutex_lock()</a>, <a class="el" href="lock_8h-source.html#l00520">ast_mutex_unlock()</a>, <a class="el" href="res__odbc_8h-source.html#l00038">odbc_obj::con</a>, <a class="el" href="res__odbc_8h-source.html#l00037">odbc_obj::lock</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d52980cf07eb0cd6d8a1a6009ece2413d">ODBC_SUCCESS</a>, <a class="el" href="res__odbc_8h-source.html#l00039">odbc_obj::parent</a>, and <a class="el" href="res__odbc_8h-source.html#l00041">odbc_obj::up</a>.
<p>
Referenced by <a class="el" href="res__odbc_8c-source.html#l00172">ast_odbc_sanity_check()</a>, <a class="el" href="res__odbc_8c-source.html#l00130">ast_odbc_smart_execute()</a>, <a class="el" href="res__odbc_8c-source.html#l00473">odbc_obj_connect()</a>, and <a class="el" href="res__odbc_8c-source.html#l00527">reload()</a>.<div class="fragment"><pre class="fragment"><a name="l00456"></a>00456 {
<a name="l00457"></a>00457    <span class="keywordtype">int</span> res;
<a name="l00458"></a>00458    <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460    res = SQLDisconnect(obj-&gt;<a class="code" href="structodbc__obj.html#7ed201fa20d25d22b291dc85ae9e5ced">con</a>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (res == <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d52980cf07eb0cd6d8a1a6009ece2413d">ODBC_SUCCESS</a>) {
<a name="l00463"></a>00463       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: disconnected %d from %s [%s]\n"</span>, res, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;name, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;dsn);
<a name="l00464"></a>00464    } <span class="keywordflow">else</span> {
<a name="l00465"></a>00465       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: %s [%s] already disconnected\n"</span>,
<a name="l00466"></a>00466       obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;name, obj-&gt;<a class="code" href="structodbc__obj.html#d0e45878043844ffc41aac437e86b602">parent</a>-&gt;dsn);
<a name="l00467"></a>00467    }
<a name="l00468"></a>00468    obj-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> = 0;
<a name="l00469"></a>00469    <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;obj-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00470"></a>00470    <span class="keywordflow">return</span> <a class="code" href="res__odbc_8h.html#84c51aa1304300f5998525c675616e1d52980cf07eb0cd6d8a1a6009ece2413d">ODBC_SUCCESS</a>;
<a name="l00471"></a>00471 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="e6044282b7e259cbd58663ebffbceb2b"></a><!-- doxytag: member="res_odbc.c::odbc_register_class" ref="e6044282b7e259cbd58663ebffbceb2b" args="(struct odbc_class *class, int connect)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int odbc_register_class           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="structodbc__class.html">odbc_class</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>class</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>connect</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00355">355</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="linkedlists_8h-source.html#l00650">AST_LIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h-source.html#l00038">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h-source.html#l00104">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="res__odbc_8c-source.html#l00377">ast_odbc_release_obj()</a>, <a class="el" href="res__odbc_8c-source.html#l00384">ast_odbc_request_obj()</a>, and <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>.
<p>
Referenced by <a class="el" href="res__odbc_8c-source.html#l00207">load_odbc_config()</a>, and <a class="el" href="res__odbc_8c-source.html#l00527">reload()</a>.<div class="fragment"><pre class="fragment"><a name="l00356"></a>00356 {
<a name="l00357"></a>00357    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html">odbc_obj</a> *obj;
<a name="l00358"></a>00358    <span class="keywordflow">if</span> (<span class="keyword">class</span>) {
<a name="l00359"></a>00359       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;odbc_list);
<a name="l00360"></a>00360       <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;odbc_list, <span class="keyword">class</span>, list);
<a name="l00361"></a>00361       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;odbc_list);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363       <span class="keywordflow">if</span> (connect) {
<a name="l00364"></a>00364          <span class="comment">/* Request and release builds a connection */</span>
<a name="l00365"></a>00365          obj = <a class="code" href="res__odbc_8h.html#ec1931837e30ff1bf6ec10ae7901328d">ast_odbc_request_obj</a>(class-&gt;name, 0);
<a name="l00366"></a>00366          <span class="keywordflow">if</span> (obj)
<a name="l00367"></a>00367             <a class="code" href="res__odbc_8h.html#4d7bd206977d04ca110b3850529a5a52">ast_odbc_release_obj</a>(obj);
<a name="l00368"></a>00368       }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370       <span class="keywordflow">return</span> 0;
<a name="l00371"></a>00371    } <span class="keywordflow">else</span> {
<a name="l00372"></a>00372       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Attempted to register a NULL class?\n"</span>);
<a name="l00373"></a>00373       <span class="keywordflow">return</span> -1;
<a name="l00374"></a>00374    }
<a name="l00375"></a>00375 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d5f120614ea3f4bedfd28fe1836de307"></a><!-- doxytag: member="res_odbc.c::odbc_show_command" ref="d5f120614ea3f4bedfd28fe1836de307" args="(int fd, int argc, char **argv)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int odbc_show_command           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char **&nbsp;</td>
          <td class="mdname" nowrap> <em>argv</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00312">312</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="cli_8c-source.html#l00057">ast_cli()</a>, <a class="el" href="linkedlists_8h-source.html#l00038">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h-source.html#l00453">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h-source.html#l00104">AST_LIST_UNLOCK</a>, <a class="el" href="res__odbc_8c-source.html#l00172">ast_odbc_sanity_check()</a>, and <a class="el" href="res__odbc_8h-source.html#l00041">odbc_obj::up</a>.<div class="fragment"><pre class="fragment"><a name="l00313"></a>00313 {
<a name="l00314"></a>00314    <span class="keyword">struct </span><a class="code" href="structodbc__class.html">odbc_class</a> *<span class="keyword">class</span>;
<a name="l00315"></a>00315    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html">odbc_obj</a> *current;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;odbc_list);
<a name="l00318"></a>00318    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;odbc_list, <span class="keyword">class</span>, list) {
<a name="l00319"></a>00319       <span class="keywordflow">if</span> ((argc == 2) || (argc == 3 &amp;&amp; !strcmp(argv[2], <span class="stringliteral">"all"</span>)) || (!strcmp(argv[2], class-&gt;name))) {
<a name="l00320"></a>00320          <span class="keywordtype">int</span> count = 0;
<a name="l00321"></a>00321          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Name: %s\nDSN: %s\n"</span>, class-&gt;name, class-&gt;dsn);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323          <span class="keywordflow">if</span> (class-&gt;haspool) {
<a name="l00324"></a>00324             <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Pooled: yes\nLimit: %d\nConnections in use: %d\n"</span>, class-&gt;limit, class-&gt;count);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326             <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;(class-&gt;odbc_obj), current, list) {
<a name="l00327"></a>00327                <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Connection %d: %s"</span>, ++count, current-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> &amp;&amp; <a class="code" href="res__odbc_8h.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a>(current) ? <span class="stringliteral">"connected"</span> : <span class="stringliteral">"disconnected"</span>);
<a name="l00328"></a>00328             }
<a name="l00329"></a>00329          } <span class="keywordflow">else</span> {
<a name="l00330"></a>00330             <span class="comment">/* Should only ever be one of these */</span>
<a name="l00331"></a>00331             <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;(class-&gt;odbc_obj), current, list) {
<a name="l00332"></a>00332                <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Pooled: no\nConnected: %s\n"</span>, current-&gt;<a class="code" href="structodbc__obj.html#46c48bec0d282018b9d167eef7711b2c">up</a> &amp;&amp; <a class="code" href="res__odbc_8h.html#51a9d1dfb7cccabfde99c97efb0ca968">ast_odbc_sanity_check</a>(current) ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>);
<a name="l00333"></a>00333             }
<a name="l00334"></a>00334          }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336             <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\n"</span>);
<a name="l00337"></a>00337       }
<a name="l00338"></a>00338    }
<a name="l00339"></a>00339    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;odbc_list);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341    <span class="keywordflow">return</span> 0;
<a name="l00342"></a>00342 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="91875b0435b600b8ed0e424d70d492b0"></a><!-- doxytag: member="res_odbc.c::reload" ref="91875b0435b600b8ed0e424d70d492b0" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int reload           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00527">527</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.
<p>
References <a class="el" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>, <a class="el" href="config_8c-source.html#l00357">ast_category_browse()</a>, <a class="el" href="config_8c-source.html#l00555">ast_config_destroy()</a>, <a class="el" href="config_8c-source.html#l01278">ast_config_load()</a>, <a class="el" href="utils_8c-source.html#l00741">ast_false()</a>, <a class="el" href="linkedlists_8h-source.html#l00038">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h-source.html#l00516">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h-source.html#l00453">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h-source.html#l00491">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h-source.html#l00554">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h-source.html#l00104">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c-source.html#l00866">ast_log()</a>, <a class="el" href="lock_8h-source.html#l00525">ast_mutex_destroy()</a>, <a class="el" href="strings_8h-source.html#l00037">ast_strlen_zero()</a>, <a class="el" href="utils_8c-source.html#l00724">ast_true()</a>, <a class="el" href="config_8c-source.html#l00222">ast_variable_browse()</a>, <a class="el" href="chan__agent_8c-source.html#l00077">config</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">dsn</a>, <a class="el" href="cdr_8c-source.html#l00091">enabled</a>, <a class="el" href="astmm_8h-source.html#l00069">free</a>, <a class="el" href="res__odbc_8h-source.html#l00037">odbc_obj::lock</a>, <a class="el" href="logger_8h-source.html#l00106">LOG_NOTICE</a>, <a class="el" href="logger_8h-source.html#l00112">LOG_WARNING</a>, <a class="el" href="config_8h-source.html#l00039">ast_variable::name</a>, <a class="el" href="config_8h-source.html#l00046">ast_variable::next</a>, <a class="el" href="res__odbc_8c-source.html#l00455">odbc_obj_disconnect()</a>, <a class="el" href="res__odbc_8c-source.html#l00355">odbc_register_class()</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">password</a>, <a class="el" href="strcompat_8c-source.html#l00062">setenv()</a>, <a class="el" href="cdr__odbc_8c-source.html#l00069">username</a>, and <a class="el" href="config_8h-source.html#l00040">ast_variable::value</a>.<div class="fragment"><pre class="fragment"><a name="l00528"></a>00528 {
<a name="l00529"></a>00529    <span class="keyword">static</span> <span class="keywordtype">char</span> *cfg = <span class="stringliteral">"res_odbc.conf"</span>;
<a name="l00530"></a>00530    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="chan__agent_8c.html#71d63bae4fa3507f57ae4e35f6de4c63">config</a>;
<a name="l00531"></a>00531    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00532"></a>00532    <span class="keywordtype">char</span> *cat, *<a class="code" href="cdr__odbc_8c.html#da532bf806defa26fdbeee5dd2e0d68f">dsn</a>, *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, *<a class="code" href="cdr__odbc_8c.html#5f4dcc3b5aa765d61d8327deb882cf99">password</a>, *sanitysql;
<a name="l00533"></a>00533    <span class="keywordtype">int</span> <a class="code" href="cdr_8c.html#a10311459433adf322f2590a4987c423">enabled</a>, pooling, limit;
<a name="l00534"></a>00534    <span class="keywordtype">int</span> connect = 0, res = 0;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536    <span class="keyword">struct </span><a class="code" href="structodbc__class.html">odbc_class</a> *<span class="keyword">new</span>, *<span class="keyword">class</span>;
<a name="l00537"></a>00537    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html">odbc_obj</a> *current;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="comment">/* First, mark all to be purged */</span>
<a name="l00540"></a>00540    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;odbc_list);
<a name="l00541"></a>00541    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;odbc_list, <span class="keyword">class</span>, list) {
<a name="l00542"></a>00542       <span class="keyword">class</span>-&gt;delme = 1;
<a name="l00543"></a>00543    }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545    config = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(cfg);
<a name="l00546"></a>00546    <span class="keywordflow">if</span> (config) {
<a name="l00547"></a>00547       <span class="keywordflow">for</span> (cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(config, NULL); cat; cat=<a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(config, cat)) {
<a name="l00548"></a>00548          <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">"ENV"</span>)) {
<a name="l00549"></a>00549             <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(config, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00550"></a>00550                <a class="code" href="strcompat_8c.html#f83efd3887c3d2aec29d418f842ab448">setenv</a>(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, 1);
<a name="l00551"></a>00551                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Adding ENV var: %s=%s\n"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00552"></a>00552             }
<a name="l00553"></a>00553          } <span class="keywordflow">else</span> {
<a name="l00554"></a>00554             <span class="comment">/* Reset all to defaults for each class of odbc connections */</span>
<a name="l00555"></a>00555             dsn = username = password = sanitysql = NULL;
<a name="l00556"></a>00556             enabled = 1;
<a name="l00557"></a>00557             connect = 0;
<a name="l00558"></a>00558             pooling = 0;
<a name="l00559"></a>00559             limit = 0;
<a name="l00560"></a>00560             <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(config, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00561"></a>00561                <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"pooling"</span>)) {
<a name="l00562"></a>00562                   pooling = 1;
<a name="l00563"></a>00563                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"limit"</span>)) {
<a name="l00564"></a>00564                   sscanf(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;limit);
<a name="l00565"></a>00565                   <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>) &amp;&amp; !limit) {
<a name="l00566"></a>00566                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Limit should be a number, not a boolean: '%s'.  Setting limit to 1023 for ODBC class '%s'.\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, cat);
<a name="l00567"></a>00567                      limit = 1023;
<a name="l00568"></a>00568                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#b293ff11e14865b872f7430896646c2e">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>)) {
<a name="l00569"></a>00569                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Limit should be a number, not a boolean: '%s'.  Disabling ODBC class '%s'.\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, cat);
<a name="l00570"></a>00570                      enabled = 0;
<a name="l00571"></a>00571                      <span class="keywordflow">break</span>;
<a name="l00572"></a>00572                   }
<a name="l00573"></a>00573                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"enabled"</span>)) {
<a name="l00574"></a>00574                   enabled = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00575"></a>00575                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"pre-connect"</span>)) {
<a name="l00576"></a>00576                   connect = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00577"></a>00577                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"dsn"</span>)) {
<a name="l00578"></a>00578                   dsn = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00579"></a>00579                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"username"</span>)) {
<a name="l00580"></a>00580                   username = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00581"></a>00581                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"password"</span>)) {
<a name="l00582"></a>00582                   password = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00583"></a>00583                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"sanitysql"</span>)) {
<a name="l00584"></a>00584                   sanitysql = v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>;
<a name="l00585"></a>00585                }
<a name="l00586"></a>00586             }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588             <span class="keywordflow">if</span> (enabled &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(dsn)) {
<a name="l00589"></a>00589                <span class="comment">/* First, check the list to see if it already exists */</span>
<a name="l00590"></a>00590                <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;odbc_list, <span class="keyword">class</span>, list) {
<a name="l00591"></a>00591                   <span class="keywordflow">if</span> (!strcmp(class-&gt;name, cat)) {
<a name="l00592"></a>00592                      <span class="keyword">class</span>-&gt;delme = 0;
<a name="l00593"></a>00593                      <span class="keywordflow">break</span>;
<a name="l00594"></a>00594                   }
<a name="l00595"></a>00595                }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597                <span class="keywordflow">if</span> (<span class="keyword">class</span>) {
<a name="l00598"></a>00598                   <span class="keyword">new</span> = <span class="keyword">class</span>;
<a name="l00599"></a>00599                } <span class="keywordflow">else</span> {
<a name="l00600"></a>00600                   <span class="keyword">new</span> = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*<span class="keyword">new</span>));
<a name="l00601"></a>00601                }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603                <span class="keywordflow">if</span> (!<span class="keyword">new</span>) {
<a name="l00604"></a>00604                   res = -1;
<a name="l00605"></a>00605                   <span class="keywordflow">break</span>;
<a name="l00606"></a>00606                }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608                <span class="keywordflow">if</span> (cat)
<a name="l00609"></a>00609                   ast_copy_string(new-&gt;name, cat, <span class="keyword">sizeof</span>(new-&gt;name));
<a name="l00610"></a>00610                <span class="keywordflow">if</span> (dsn)
<a name="l00611"></a>00611                   ast_copy_string(new-&gt;dsn, dsn, <span class="keyword">sizeof</span>(new-&gt;dsn));
<a name="l00612"></a>00612                <span class="keywordflow">if</span> (username)
<a name="l00613"></a>00613                   ast_copy_string(new-&gt;username, username, <span class="keyword">sizeof</span>(new-&gt;username));
<a name="l00614"></a>00614                <span class="keywordflow">if</span> (password)
<a name="l00615"></a>00615                   ast_copy_string(new-&gt;password, password, <span class="keyword">sizeof</span>(new-&gt;password));
<a name="l00616"></a>00616                <span class="keywordflow">if</span> (sanitysql)
<a name="l00617"></a>00617                   ast_copy_string(new-&gt;sanitysql, sanitysql, <span class="keyword">sizeof</span>(new-&gt;sanitysql));
<a name="l00618"></a>00618 
<a name="l00619"></a>00619                <span class="keywordflow">if</span> (!<span class="keyword">class</span>) {
<a name="l00620"></a>00620                   SQLAllocHandle(SQL_HANDLE_ENV, SQL_NULL_HANDLE, &amp;new-&gt;env);
<a name="l00621"></a>00621                   res = SQLSetEnvAttr(new-&gt;env, SQL_ATTR_ODBC_VERSION, (<span class="keywordtype">void</span> *) SQL_OV_ODBC3, 0);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623                   <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l00624"></a>00624                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"res_odbc: Error SetEnv\n"</span>);
<a name="l00625"></a>00625                      SQLFreeHandle(SQL_HANDLE_ENV, new-&gt;env);
<a name="l00626"></a>00626                      <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;odbc_list);
<a name="l00627"></a>00627                      <span class="keywordflow">return</span> res;
<a name="l00628"></a>00628                   }
<a name="l00629"></a>00629                }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631                <span class="keywordflow">if</span> (pooling) {
<a name="l00632"></a>00632                   <span class="keyword">new</span>-&gt;haspool = pooling;
<a name="l00633"></a>00633                   <span class="keywordflow">if</span> (limit) {
<a name="l00634"></a>00634                      <span class="keyword">new</span>-&gt;limit = limit;
<a name="l00635"></a>00635                   } <span class="keywordflow">else</span> {
<a name="l00636"></a>00636                      <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Pooling without also setting a limit is pointless.  Changing limit from 0 to 5.\n"</span>);
<a name="l00637"></a>00637                      <span class="keyword">new</span>-&gt;limit = 5;
<a name="l00638"></a>00638                   }
<a name="l00639"></a>00639                }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641                <span class="keywordflow">if</span> (<span class="keyword">class</span>) {
<a name="l00642"></a>00642                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Refreshing ODBC class '%s' dsn-&gt;[%s]\n"</span>, cat, dsn);
<a name="l00643"></a>00643                } <span class="keywordflow">else</span> {
<a name="l00644"></a>00644                   <a class="code" href="res__odbc_8c.html#e6044282b7e259cbd58663ebffbceb2b">odbc_register_class</a>(<span class="keyword">new</span>, connect);
<a name="l00645"></a>00645                   <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Registered ODBC class '%s' dsn-&gt;[%s]\n"</span>, cat, dsn);
<a name="l00646"></a>00646                }
<a name="l00647"></a>00647             }
<a name="l00648"></a>00648          }
<a name="l00649"></a>00649       }
<a name="l00650"></a>00650       <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(config);
<a name="l00651"></a>00651    }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653    <span class="comment">/* Purge classes that we know can go away (pooled with 0, only) */</span>
<a name="l00654"></a>00654    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;odbc_list, <span class="keyword">class</span>, list) {
<a name="l00655"></a>00655       <span class="keywordflow">if</span> (class-&gt;delme &amp;&amp; class-&gt;haspool &amp;&amp; class-&gt;count == 0) {
<a name="l00656"></a>00656          <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;(class-&gt;odbc_obj), current, list) {
<a name="l00657"></a>00657             <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;(class-&gt;odbc_obj), list);
<a name="l00658"></a>00658             <a class="code" href="res__odbc_8c.html#440f2e0d3912c5fdebc9b8d36b8c21ff">odbc_obj_disconnect</a>(current);
<a name="l00659"></a>00659             <a class="code" href="lock_8h.html#1b27af7774f46859ffe2b1340ee7c082">ast_mutex_destroy</a>(&amp;current-&gt;<a class="code" href="structodbc__obj.html#dce7c4174ce9323904a934a486c41288">lock</a>);
<a name="l00660"></a>00660             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(current);
<a name="l00661"></a>00661          }
<a name="l00662"></a>00662          <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;odbc_list, list);
<a name="l00665"></a>00665          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(<span class="keyword">class</span>);
<a name="l00666"></a>00666       }
<a name="l00667"></a>00667    }
<a name="l00668"></a>00668    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00669"></a>00669    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;odbc_list);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671    <span class="keywordflow">return</span> 0;
<a name="l00672"></a>00672 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="eaf793e807a29b69460b0c6c94a79a0b"></a><!-- doxytag: member="res_odbc.c::unload_module" ref="eaf793e807a29b69460b0c6c94a79a0b" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static int unload_module           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00674">674</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.<div class="fragment"><pre class="fragment"><a name="l00675"></a>00675 {
<a name="l00676"></a>00676    <span class="comment">/* Prohibit unloading */</span>
<a name="l00677"></a>00677    <span class="keywordflow">return</span> -1;
<a name="l00678"></a>00678 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="59fddb8dae33c8b7281dada54629f853"></a><!-- doxytag: member="res_odbc.c::cli_odbc" ref="59fddb8dae33c8b7281dada54629f853" args="[]" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__odbc_8c.html#59fddb8dae33c8b7281dada54629f853">cli_odbc</a>[]<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   { { <span class="stringliteral">"odbc"</span>, <span class="stringliteral">"show"</span>, NULL },
   <a class="code" href="res__odbc_8c.html#d5f120614ea3f4bedfd28fe1836de307">odbc_show_command</a>, <span class="stringliteral">"List ODBC DSN(s)"</span>,
   <a class="code" href="res__odbc_8c.html#5e6e2655436c34a31ad44b6961da88ec">show_usage</a> },
}
</pre></div>
<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00349">349</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="5e6e2655436c34a31ad44b6961da88ec"></a><!-- doxytag: member="res_odbc.c::show_usage" ref="5e6e2655436c34a31ad44b6961da88ec" args="[]" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">const char <a class="el" href="res__odbc_8c.html#5e6e2655436c34a31ad44b6961da88ec">show_usage</a>[]<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><div class="fragment"><pre class="fragment">
<span class="stringliteral">"Usage: odbc show [&lt;class&gt;]\n"</span>
<span class="stringliteral">"       List settings of a particular ODBC class.\n"</span>
<span class="stringliteral">"       or, if not specified, all classes.\n"</span>
</pre></div>
<p>
Definition at line <a class="el" href="res__odbc_8c-source.html#l00344">344</a> of file <a class="el" href="res__odbc_8c-source.html">res_odbc.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:27:44 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
