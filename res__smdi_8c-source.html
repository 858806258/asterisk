<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:50 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_smdi.c</h1><a href="res__smdi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- A telephony toolkit for Linux.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2005-2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Matthew A. Nicholson &lt;mnicholson@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*!</span>
<a name="l00020"></a>00020 <span class="comment"> * \file</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief SMDI support for Asterisk.</span>
<a name="l00022"></a>00022 <span class="comment"> * \author Matthew A. Nicholson &lt;mnicholson@digium.com&gt;</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 #include &lt;stdio.h&gt;
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;termios.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html">time.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="smdi_8h.html">asterisk/smdi.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="astobj_8h.html">asterisk/astobj.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="io_8h.html">asterisk/io.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">/* Message expiry time in milliseconds */</span>
<a name="l00048"></a><a class="code" href="res__smdi_8c.html#972d0b700b758b9521036303c88220eb">00048</a> <span class="preprocessor">#define SMDI_MSG_EXPIRY_TIME  30000 </span><span class="comment">/* 30 seconds */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="res__smdi_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">00050</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>[] = <span class="stringliteral">"smdi.conf"</span>;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__smdi_8c.html#0181b98f25d11787f95d8437d0c9cf1b">ast_smdi_md_message_push</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l00053"></a>00053 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__smdi_8c.html#7d34810fdec934d79f8d0ffc0686bdc9">ast_smdi_mwi_message_push</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>);
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__smdi_8c.html#0fec9cd6787ca7fd02a6b01764a89db3">smdi_read</a>(<span class="keywordtype">void</span> *iface_p);
<a name="l00056"></a>00056 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__smdi_8c.html#6ad11282475060d8211cba4ab15456e9">smdi_load</a>(<span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>);
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="res__smdi_8c.html#ab86a1e1ef70dff97959067b723c5c24">00058</a> <span class="keyword">struct </span>module_symbols *<a class="code" href="app__mixmonitor_8c.html#ab86a1e1ef70dff97959067b723c5c24">me</a>; <span class="comment">/* initialized in load_module() */</span>
<a name="l00059"></a>00059 <span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment">/*! \brief SMDI interface container. */</span>
<a name="l00061"></a><a class="code" href="structast__smdi__interface__container.html">00061</a> <span class="keyword">struct </span><a class="code" href="structast__smdi__interface__container.html">ast_smdi_interface_container</a> {
<a name="l00062"></a>00062    <a class="code" href="structast__smdi__interface__container.html#dd0e05a26779c29acb5f802ae9fc5a2c">ASTOBJ_CONTAINER_COMPONENTS</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a>);
<a name="l00063"></a>00063 } <a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>;
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">/*! </span>
<a name="l00066"></a>00066 <span class="comment"> * \internal</span>
<a name="l00067"></a>00067 <span class="comment"> * \brief Push an SMDI message to the back of an interface's message queue.</span>
<a name="l00068"></a>00068 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00069"></a>00069 <span class="comment"> * \param md_msg a pointer to the message to use.</span>
<a name="l00070"></a>00070 <span class="comment"> */</span>
<a name="l00071"></a><a class="code" href="res__smdi_8c.html#0181b98f25d11787f95d8437d0c9cf1b">00071</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__smdi_8c.html#0181b98f25d11787f95d8437d0c9cf1b">ast_smdi_md_message_push</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073    <a class="code" href="astobj_8h.html#c74876ccd172249461ff2f6a2f2e3078">ASTOBJ_CONTAINER_LINK_END</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>, md_msg);
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">/*!</span>
<a name="l00077"></a>00077 <span class="comment"> * \internal</span>
<a name="l00078"></a>00078 <span class="comment"> * \brief Push an SMDI message to the back of an interface's message queue.</span>
<a name="l00079"></a>00079 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00080"></a>00080 <span class="comment"> * \param mwi_msg a pointer to the message to use.</span>
<a name="l00081"></a>00081 <span class="comment"> */</span>
<a name="l00082"></a><a class="code" href="res__smdi_8c.html#7d34810fdec934d79f8d0ffc0686bdc9">00082</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__smdi_8c.html#7d34810fdec934d79f8d0ffc0686bdc9">ast_smdi_mwi_message_push</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084    <a class="code" href="astobj_8h.html#c74876ccd172249461ff2f6a2f2e3078">ASTOBJ_CONTAINER_LINK_END</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>, mwi_msg);
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 <span class="comment"></span>
<a name="l00087"></a>00087 <span class="comment">/*!</span>
<a name="l00088"></a>00088 <span class="comment"> * \brief Set the MWI indicator for a mailbox.</span>
<a name="l00089"></a>00089 <span class="comment"> * \param iface the interface to use.</span>
<a name="l00090"></a>00090 <span class="comment"> * \param mailbox the mailbox to use.</span>
<a name="l00091"></a>00091 <span class="comment"> */</span>
<a name="l00092"></a><a class="code" href="res__smdi_8c.html#6018412a2ff79bc26234e3eb4986eb2e">00092</a> <span class="keywordtype">int</span> <a class="code" href="smdi_8h.html#6018412a2ff79bc26234e3eb4986eb2e">ast_smdi_mwi_set</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094    FILE *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>;
<a name="l00095"></a>00095    <span class="keywordtype">int</span> i;
<a name="l00096"></a>00096    
<a name="l00097"></a>00097    file = fopen(iface-&gt;name, <span class="stringliteral">"w"</span>);
<a name="l00098"></a>00098    <span class="keywordflow">if</span>(!file) {
<a name="l00099"></a>00099       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error opening SMDI interface %s (%s) for writing\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00100"></a>00100       <span class="keywordflow">return</span> 1;
<a name="l00101"></a>00101    }  
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <a class="code" href="astobj_8h.html#f2673da846e4ebbd185b124fa113d321">ASTOBJ_WRLOCK</a>(iface);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105    fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"OP:MWI "</span>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107    <span class="keywordflow">for</span>(i = 0; i &lt; iface-&gt;msdstrip; i++)
<a name="l00108"></a>00108       fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"0"</span>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110    fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"%s!\x04"</span>, <a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>);
<a name="l00111"></a>00111    fclose(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113    <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iface);
<a name="l00114"></a>00114    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00115"></a>00115       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Sent MWI set message for %s on %s\n"</span>, <a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>, iface-&gt;name);
<a name="l00116"></a>00116    <span class="keywordflow">return</span> 0;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 <span class="comment"></span>
<a name="l00119"></a>00119 <span class="comment">/*! </span>
<a name="l00120"></a>00120 <span class="comment"> * \brief Unset the MWI indicator for a mailbox.</span>
<a name="l00121"></a>00121 <span class="comment"> * \param iface the interface to use.</span>
<a name="l00122"></a>00122 <span class="comment"> * \param mailbox the mailbox to use.</span>
<a name="l00123"></a>00123 <span class="comment"> */</span>
<a name="l00124"></a><a class="code" href="res__smdi_8c.html#be4f7404e1d8acc32800d2f7ed9ba08c">00124</a> <span class="keywordtype">int</span> <a class="code" href="smdi_8h.html#be4f7404e1d8acc32800d2f7ed9ba08c">ast_smdi_mwi_unset</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126    FILE *<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>;
<a name="l00127"></a>00127    <span class="keywordtype">int</span> i;
<a name="l00128"></a>00128    
<a name="l00129"></a>00129    file = fopen(iface-&gt;name, <span class="stringliteral">"w"</span>);
<a name="l00130"></a>00130    <span class="keywordflow">if</span>(!file) {
<a name="l00131"></a>00131       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error opening SMDI interface %s (%s) for writing\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00132"></a>00132       <span class="keywordflow">return</span> 1;
<a name="l00133"></a>00133    }  
<a name="l00134"></a>00134 
<a name="l00135"></a>00135    <a class="code" href="astobj_8h.html#f2673da846e4ebbd185b124fa113d321">ASTOBJ_WRLOCK</a>(iface);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"RMV:MWI "</span>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <span class="keywordflow">for</span>(i = 0; i &lt; iface-&gt;msdstrip; i++)
<a name="l00140"></a>00140       fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"0"</span>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142    fprintf(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>, <span class="stringliteral">"%s!\x04"</span>, <a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>);
<a name="l00143"></a>00143    fclose(<a class="code" href="manager_8h.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145    <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iface);
<a name="l00146"></a>00146    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00147"></a>00147       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Sent MWI unset message for %s on %s\n"</span>, <a class="code" href="chan__mgcp_8c.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>, iface-&gt;name);
<a name="l00148"></a>00148    <span class="keywordflow">return</span> 0;
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 <span class="comment"></span>
<a name="l00151"></a>00151 <span class="comment">/*!</span>
<a name="l00152"></a>00152 <span class="comment"> * \brief Put an SMDI message back in the front of the queue.</span>
<a name="l00153"></a>00153 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00154"></a>00154 <span class="comment"> * \param md_msg a pointer to the message to use.</span>
<a name="l00155"></a>00155 <span class="comment"> *</span>
<a name="l00156"></a>00156 <span class="comment"> * This function puts a message back in the front of the specified queue.  It</span>
<a name="l00157"></a>00157 <span class="comment"> * should be used if a message was popped but is not going to be processed for</span>
<a name="l00158"></a>00158 <span class="comment"> * some reason, and the message needs to be returned to the queue.</span>
<a name="l00159"></a>00159 <span class="comment"> */</span>
<a name="l00160"></a><a class="code" href="res__smdi_8c.html#ba6b338bbc93c6f833e583d15bd794cc">00160</a> <span class="keywordtype">void</span> <a class="code" href="smdi_8h.html#7799acace876dddc57f90bacf516bad0">ast_smdi_md_message_putback</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162    <a class="code" href="astobj_8h.html#a79ba50d4a7a6e2c7190c4ff0baa6335">ASTOBJ_CONTAINER_LINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>, md_msg);
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 <span class="comment"></span>
<a name="l00165"></a>00165 <span class="comment">/*!</span>
<a name="l00166"></a>00166 <span class="comment"> * \brief Put an SMDI message back in the front of the queue.</span>
<a name="l00167"></a>00167 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00168"></a>00168 <span class="comment"> * \param mwi_msg a pointer to the message to use.</span>
<a name="l00169"></a>00169 <span class="comment"> *</span>
<a name="l00170"></a>00170 <span class="comment"> * This function puts a message back in the front of the specified queue.  It</span>
<a name="l00171"></a>00171 <span class="comment"> * should be used if a message was popped but is not going to be processed for</span>
<a name="l00172"></a>00172 <span class="comment"> * some reason, and the message needs to be returned to the queue.</span>
<a name="l00173"></a>00173 <span class="comment"> */</span>
<a name="l00174"></a><a class="code" href="res__smdi_8c.html#81f4d79f06e7f757cc0537d811882f73">00174</a> <span class="keywordtype">void</span> <a class="code" href="smdi_8h.html#2f8cc87ba46b9cf20020c836b34656f7">ast_smdi_mwi_message_putback</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keyword">struct</span> <a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176    <a class="code" href="astobj_8h.html#a79ba50d4a7a6e2c7190c4ff0baa6335">ASTOBJ_CONTAINER_LINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>, mwi_msg);
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 <span class="comment"></span>
<a name="l00179"></a>00179 <span class="comment">/*! </span>
<a name="l00180"></a>00180 <span class="comment"> * \brief Get the next SMDI message from the queue.</span>
<a name="l00181"></a>00181 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00182"></a>00182 <span class="comment"> *</span>
<a name="l00183"></a>00183 <span class="comment"> * This function pulls the first unexpired message from the SMDI message queue</span>
<a name="l00184"></a>00184 <span class="comment"> * on the specified interface.  It will purge all expired SMDI messages before</span>
<a name="l00185"></a>00185 <span class="comment"> * returning.</span>
<a name="l00186"></a>00186 <span class="comment"> *</span>
<a name="l00187"></a>00187 <span class="comment"> * \return the next SMDI message, or NULL if there were no pending messages.</span>
<a name="l00188"></a>00188 <span class="comment"> */</span>
<a name="l00189"></a><a class="code" href="res__smdi_8c.html#9dbb30234417d021937cb896ac0a0171">00189</a> <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="code" href="smdi_8h.html#9dbb30234417d021937cb896ac0a0171">ast_smdi_md_message_pop</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg = <a class="code" href="astobj_8h.html#daa092f2410b7d53c3d4c71fb170dc2a">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>);
<a name="l00192"></a>00192    <span class="keyword">struct </span>timeval now;
<a name="l00193"></a>00193    <span class="keywordtype">long</span> elapsed = 0;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195    <span class="comment">/* purge old messages */</span>
<a name="l00196"></a>00196    now = ast_tvnow();
<a name="l00197"></a>00197    <span class="keywordflow">while</span> (md_msg) {
<a name="l00198"></a>00198       elapsed = ast_tvdiff_ms(now, md_msg-&gt;<a class="code" href="structast__smdi__md__message.html#d7e6d55ba379a13d08c25d15faf2a23b">timestamp</a>);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200       <span class="keywordflow">if</span> (elapsed &gt; iface-&gt;<a class="code" href="structast__smdi__interface.html#1e5801b70e88261a93a6927ed7a250f2">msg_expiry</a>) {
<a name="l00201"></a>00201          <span class="comment">/* found an expired message */</span>
<a name="l00202"></a>00202          <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(md_msg, <a class="code" href="smdi_8h.html#a8435ff382225957ab4f884f143f478e">ast_smdi_md_message_destroy</a>);
<a name="l00203"></a>00203          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Purged expired message from %s SMDI MD message queue.  Message was %ld milliseconds too old.\n"</span>,
<a name="l00204"></a>00204             iface-&gt;name, elapsed - iface-&gt;<a class="code" href="structast__smdi__interface.html#1e5801b70e88261a93a6927ed7a250f2">msg_expiry</a>);
<a name="l00205"></a>00205          md_msg = <a class="code" href="astobj_8h.html#daa092f2410b7d53c3d4c71fb170dc2a">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>);
<a name="l00206"></a>00206       }
<a name="l00207"></a>00207       <span class="keywordflow">else</span> {
<a name="l00208"></a>00208          <span class="comment">/* good message, return it */</span>
<a name="l00209"></a>00209          <span class="keywordflow">break</span>;
<a name="l00210"></a>00210       }
<a name="l00211"></a>00211    }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213    <span class="keywordflow">return</span> md_msg;
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 <span class="comment"></span>
<a name="l00216"></a>00216 <span class="comment">/*!</span>
<a name="l00217"></a>00217 <span class="comment"> * \brief Get the next SMDI message from the queue.</span>
<a name="l00218"></a>00218 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00219"></a>00219 <span class="comment"> * \param timeout the time to wait before returning in milliseconds.</span>
<a name="l00220"></a>00220 <span class="comment"> *</span>
<a name="l00221"></a>00221 <span class="comment"> * This function pulls a message from the SMDI message queue on the specified</span>
<a name="l00222"></a>00222 <span class="comment"> * interface.  If no message is available this function will wait the specified</span>
<a name="l00223"></a>00223 <span class="comment"> * amount of time before returning.</span>
<a name="l00224"></a>00224 <span class="comment"> *</span>
<a name="l00225"></a>00225 <span class="comment"> * \return the next SMDI message, or NULL if there were no pending messages and</span>
<a name="l00226"></a>00226 <span class="comment"> * the timeout has expired.</span>
<a name="l00227"></a>00227 <span class="comment"> */</span>
<a name="l00228"></a><a class="code" href="res__smdi_8c.html#9babba9c2649950fdda3af91387e6f09">00228</a> <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="code" href="smdi_8h.html#9babba9c2649950fdda3af91387e6f09">ast_smdi_md_message_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keywordtype">int</span> timeout)
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230    <span class="keyword">struct </span>timeval start;
<a name="l00231"></a>00231    <span class="keywordtype">long</span> diff = 0;
<a name="l00232"></a>00232    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234    start = ast_tvnow();
<a name="l00235"></a>00235    <span class="keywordflow">while</span> (diff &lt; timeout) {
<a name="l00236"></a>00236 
<a name="l00237"></a>00237       <span class="keywordflow">if</span> ((msg = <a class="code" href="smdi_8h.html#9dbb30234417d021937cb896ac0a0171">ast_smdi_md_message_pop</a>(iface)))
<a name="l00238"></a>00238          <span class="keywordflow">return</span> msg;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240       <span class="comment">/* check timeout */</span>
<a name="l00241"></a>00241       diff = ast_tvdiff_ms(ast_tvnow(), start);
<a name="l00242"></a>00242    }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244    <span class="keywordflow">return</span> (<a class="code" href="smdi_8h.html#9dbb30234417d021937cb896ac0a0171">ast_smdi_md_message_pop</a>(iface));
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 <span class="comment"></span>
<a name="l00247"></a>00247 <span class="comment">/*!</span>
<a name="l00248"></a>00248 <span class="comment"> * \brief Get the next SMDI message from the queue.</span>
<a name="l00249"></a>00249 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00250"></a>00250 <span class="comment"> *</span>
<a name="l00251"></a>00251 <span class="comment"> * This function pulls the first unexpired message from the SMDI message queue</span>
<a name="l00252"></a>00252 <span class="comment"> * on the specified interface.  It will purge all expired SMDI messages before</span>
<a name="l00253"></a>00253 <span class="comment"> * returning.</span>
<a name="l00254"></a>00254 <span class="comment"> *</span>
<a name="l00255"></a>00255 <span class="comment"> * \return the next SMDI message, or NULL if there were no pending messages.</span>
<a name="l00256"></a>00256 <span class="comment"> */</span>
<a name="l00257"></a><a class="code" href="res__smdi_8c.html#9529aee88d9b3c388a3b902a34f255b2">00257</a> <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="code" href="smdi_8h.html#9529aee88d9b3c388a3b902a34f255b2">ast_smdi_mwi_message_pop</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg = <a class="code" href="astobj_8h.html#daa092f2410b7d53c3d4c71fb170dc2a">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>);
<a name="l00260"></a>00260    <span class="keyword">struct </span>timeval now;
<a name="l00261"></a>00261    <span class="keywordtype">long</span> elapsed = 0;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263    <span class="comment">/* purge old messages */</span>
<a name="l00264"></a>00264    now = ast_tvnow();
<a name="l00265"></a>00265    <span class="keywordflow">while</span> (mwi_msg)   {
<a name="l00266"></a>00266       elapsed = ast_tvdiff_ms(now, mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#d7e6d55ba379a13d08c25d15faf2a23b">timestamp</a>);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="keywordflow">if</span> (elapsed &gt; iface-&gt;<a class="code" href="structast__smdi__interface.html#1e5801b70e88261a93a6927ed7a250f2">msg_expiry</a>) {
<a name="l00269"></a>00269          <span class="comment">/* found an expired message */</span>
<a name="l00270"></a>00270          <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(mwi_msg, <a class="code" href="smdi_8h.html#26f240e1343fa898db0a1b6fb49c28ea">ast_smdi_mwi_message_destroy</a>);
<a name="l00271"></a>00271          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Purged expired message from %s SMDI MWI message queue.  Message was %ld milliseconds too old.\n"</span>,
<a name="l00272"></a>00272             iface-&gt;name, elapsed - iface-&gt;<a class="code" href="structast__smdi__interface.html#1e5801b70e88261a93a6927ed7a250f2">msg_expiry</a>);
<a name="l00273"></a>00273          mwi_msg = <a class="code" href="astobj_8h.html#daa092f2410b7d53c3d4c71fb170dc2a">ASTOBJ_CONTAINER_UNLINK_START</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>);
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275       <span class="keywordflow">else</span> {
<a name="l00276"></a>00276          <span class="comment">/* good message, return it */</span>
<a name="l00277"></a>00277          <span class="keywordflow">break</span>;
<a name="l00278"></a>00278       }
<a name="l00279"></a>00279    }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <span class="keywordflow">return</span> mwi_msg;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 <span class="comment"></span>
<a name="l00284"></a>00284 <span class="comment">/*!</span>
<a name="l00285"></a>00285 <span class="comment"> * \brief Get the next SMDI message from the queue.</span>
<a name="l00286"></a>00286 <span class="comment"> * \param iface a pointer to the interface to use.</span>
<a name="l00287"></a>00287 <span class="comment"> * \param timeout the time to wait before returning in milliseconds.</span>
<a name="l00288"></a>00288 <span class="comment"> *</span>
<a name="l00289"></a>00289 <span class="comment"> * This function pulls a message from the SMDI message queue on the specified</span>
<a name="l00290"></a>00290 <span class="comment"> * interface.  If no message is available this function will wait the specified</span>
<a name="l00291"></a>00291 <span class="comment"> * amount of time before returning.</span>
<a name="l00292"></a>00292 <span class="comment"> *</span>
<a name="l00293"></a>00293 <span class="comment"> * \return the next SMDI message, or NULL if there were no pending messages and</span>
<a name="l00294"></a>00294 <span class="comment"> * the timeout has expired.</span>
<a name="l00295"></a>00295 <span class="comment"> */</span>
<a name="l00296"></a><a class="code" href="res__smdi_8c.html#2cb785c8551401a05b5af729121464bf">00296</a> <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="code" href="smdi_8h.html#2cb785c8551401a05b5af729121464bf">ast_smdi_mwi_message_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface, <span class="keywordtype">int</span> timeout)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keyword">struct </span>timeval start;
<a name="l00299"></a>00299    <span class="keywordtype">long</span> diff = 0;
<a name="l00300"></a>00300    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    start = ast_tvnow();
<a name="l00303"></a>00303    <span class="keywordflow">while</span> (diff &lt; timeout) {
<a name="l00304"></a>00304 
<a name="l00305"></a>00305       <span class="keywordflow">if</span> ((msg = <a class="code" href="smdi_8h.html#9529aee88d9b3c388a3b902a34f255b2">ast_smdi_mwi_message_pop</a>(iface)))
<a name="l00306"></a>00306          <span class="keywordflow">return</span> msg;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308       <span class="comment">/* check timeout */</span>
<a name="l00309"></a>00309       diff = ast_tvdiff_ms(ast_tvnow(), start);
<a name="l00310"></a>00310    }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312    <span class="keywordflow">return</span> (<a class="code" href="smdi_8h.html#9529aee88d9b3c388a3b902a34f255b2">ast_smdi_mwi_message_pop</a>(iface));
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 <span class="comment"></span>
<a name="l00315"></a>00315 <span class="comment">/*!</span>
<a name="l00316"></a>00316 <span class="comment"> * \brief Find an SMDI interface with the specified name.</span>
<a name="l00317"></a>00317 <span class="comment"> * \param iface_name the name/port of the interface to search for.</span>
<a name="l00318"></a>00318 <span class="comment"> *</span>
<a name="l00319"></a>00319 <span class="comment"> * \return a pointer to the interface located or NULL if none was found.  This</span>
<a name="l00320"></a>00320 <span class="comment"> * actually returns an ASTOBJ reference and should be released using</span>
<a name="l00321"></a>00321 <span class="comment"> * #ASTOBJ_UNREF(iface, ast_smdi_interface_destroy).</span>
<a name="l00322"></a>00322 <span class="comment"> */</span>
<a name="l00323"></a><a class="code" href="res__smdi_8c.html#249d1773e8df65ccbc595e29342d17b6">00323</a> <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *<a class="code" href="smdi_8h.html#249d1773e8df65ccbc595e29342d17b6">ast_smdi_interface_find</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *iface_name)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325    <span class="keywordflow">return</span> (<a class="code" href="astobj_8h.html#bb4a582d1b01a686da4f5dacfab2cfba">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>, iface_name));
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 <span class="comment"></span>
<a name="l00328"></a>00328 <span class="comment">/*! \brief Read an SMDI message.</span>
<a name="l00329"></a>00329 <span class="comment"> *</span>
<a name="l00330"></a>00330 <span class="comment"> * \param iface_p the SMDI interface to read from.</span>
<a name="l00331"></a>00331 <span class="comment"> *</span>
<a name="l00332"></a>00332 <span class="comment"> * This function loops and reads from and SMDI interface.  It must be stopped</span>
<a name="l00333"></a>00333 <span class="comment"> * using pthread_cancel().</span>
<a name="l00334"></a>00334 <span class="comment"> */</span>
<a name="l00335"></a><a class="code" href="res__smdi_8c.html#0fec9cd6787ca7fd02a6b01764a89db3">00335</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__smdi_8c.html#0fec9cd6787ca7fd02a6b01764a89db3">smdi_read</a>(<span class="keywordtype">void</span> *iface_p)
<a name="l00336"></a>00336 {
<a name="l00337"></a>00337    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface = iface_p;
<a name="l00338"></a>00338    <span class="keyword">struct </span><a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *md_msg;
<a name="l00339"></a>00339    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg;
<a name="l00340"></a>00340    <span class="keywordtype">char</span> c = <span class="charliteral">'\0'</span>;
<a name="l00341"></a>00341    <span class="keywordtype">char</span> *cp = NULL;
<a name="l00342"></a>00342    <span class="keywordtype">int</span> i;
<a name="l00343"></a>00343    <span class="keywordtype">int</span> start = 0;
<a name="l00344"></a>00344       
<a name="l00345"></a>00345    <span class="comment">/* read an smdi message */</span>
<a name="l00346"></a>00346    <span class="keywordflow">while</span> ((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>))) {
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       <span class="comment">/* check if this is the start of a message */</span>
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (!start) {
<a name="l00350"></a>00350          <span class="keywordflow">if</span> (c == <span class="charliteral">'M'</span>)
<a name="l00351"></a>00351             start = 1;
<a name="l00352"></a>00352       }
<a name="l00353"></a>00353       <span class="keywordflow">else</span> { <span class="comment">/* Determine if this is a MD or MWI message */</span>
<a name="l00354"></a>00354          <span class="keywordflow">if</span>(c == <span class="charliteral">'D'</span>) { <span class="comment">/* MD message */</span>
<a name="l00355"></a>00355             start = 0;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (!(md_msg = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*md_msg)))) {
<a name="l00358"></a>00358                <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface,<a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00359"></a>00359                <span class="keywordflow">return</span> NULL;
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361             
<a name="l00362"></a>00362             <a class="code" href="astobj_8h.html#d98ac8e31e47134b19f5305e090ad209">ASTOBJ_INIT</a>(md_msg);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364             <span class="comment">/* read the message desk number */</span>
<a name="l00365"></a>00365             <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="smdi_8h.html#c471b138dcfc07750ec182399512c27d">SMDI_MESG_DESK_NUM_LEN</a>; i++)
<a name="l00366"></a>00366                md_msg-&gt;mesg_desk_num[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368             md_msg-&gt;mesg_desk_num[SMDI_MESG_DESK_NUM_LEN] = <span class="charliteral">'\0'</span>;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370             <span class="comment">/* read the message desk terminal number */</span>
<a name="l00371"></a>00371             <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="smdi_8h.html#a0b8b8d8fa9564c3aba837919eb83177">SMDI_MESG_DESK_TERM_LEN</a>; i++)
<a name="l00372"></a>00372                md_msg-&gt;mesg_desk_term[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374             md_msg-&gt;mesg_desk_term[SMDI_MESG_DESK_TERM_LEN] = <span class="charliteral">'\0'</span>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376             <span class="comment">/* read the message type */</span>
<a name="l00377"></a>00377             md_msg-&gt;type = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00378"></a>00378             
<a name="l00379"></a>00379             <span class="comment">/* read the forwarding station number (may be blank) */</span>
<a name="l00380"></a>00380             cp = &amp;md_msg-&gt;fwd_st[0];
<a name="l00381"></a>00381             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a> + 1; i++) {
<a name="l00382"></a>00382                <span class="keywordflow">if</span>((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>)) == <span class="charliteral">' '</span>) {
<a name="l00383"></a>00383                   *cp = <span class="charliteral">'\0'</span>;
<a name="l00384"></a>00384                   <span class="keywordflow">break</span>;
<a name="l00385"></a>00385                }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387                <span class="comment">/* store c in md_msg-&gt;fwd_st */</span>
<a name="l00388"></a>00388                <span class="keywordflow">if</span>( i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#9945c467d67fd7068c26fcedec175dd8">msdstrip</a>)
<a name="l00389"></a>00389                   *cp++ = c;
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392             <span class="comment">/* make sure the value is null terminated, even if this truncates it */</span>
<a name="l00393"></a>00393             md_msg-&gt;fwd_st[<a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a>] = <span class="charliteral">'\0'</span>;
<a name="l00394"></a>00394             cp = NULL;
<a name="l00395"></a>00395             
<a name="l00396"></a>00396             <span class="comment">/* read the calling station number (may be blank) */</span>
<a name="l00397"></a>00397             cp = &amp;md_msg-&gt;calling_st[0];
<a name="l00398"></a>00398             for (i = 0; i &lt; <a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a> + 1; i++) {
<a name="l00399"></a>00399                <span class="keywordflow">if</span> (!isdigit((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>)))) {
<a name="l00400"></a>00400                   *cp = <span class="charliteral">'\0'</span>;
<a name="l00401"></a>00401                   <span class="keywordflow">break</span>;
<a name="l00402"></a>00402                }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404                <span class="comment">/* store c in md_msg-&gt;calling_st */</span>
<a name="l00405"></a>00405                <span class="keywordflow">if</span> (i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#9945c467d67fd7068c26fcedec175dd8">msdstrip</a>)
<a name="l00406"></a>00406                   *cp++ = c;
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409             <span class="comment">/* make sure the value is null terminated, even if this truncates it */</span>
<a name="l00410"></a>00410             md_msg-&gt;calling_st[<a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a>] = <span class="charliteral">'\0'</span>;
<a name="l00411"></a>00411             cp = NULL;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             <span class="comment">/* add the message to the message queue */</span>
<a name="l00414"></a>00414             md_msg-&gt;timestamp = ast_tvnow();
<a name="l00415"></a>00415             <a class="code" href="res__smdi_8c.html#0181b98f25d11787f95d8437d0c9cf1b">ast_smdi_md_message_push</a>(iface, md_msg);
<a name="l00416"></a>00416             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00417"></a>00417                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Recieved SMDI MD message on %s\n"</span>, iface-&gt;name);
<a name="l00418"></a>00418             
<a name="l00419"></a>00419             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(md_msg, <a class="code" href="smdi_8h.html#a8435ff382225957ab4f884f143f478e">ast_smdi_md_message_destroy</a>);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421          } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(c == <span class="charliteral">'W'</span>) { <span class="comment">/* MWI message */</span>
<a name="l00422"></a>00422             start = 0;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424             <span class="keywordflow">if</span> (!(mwi_msg = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*mwi_msg)))) {
<a name="l00425"></a>00425                <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface,<a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00426"></a>00426                <span class="keywordflow">return</span> NULL;
<a name="l00427"></a>00427             }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429             <a class="code" href="astobj_8h.html#d98ac8e31e47134b19f5305e090ad209">ASTOBJ_INIT</a>(mwi_msg);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431             <span class="comment">/* discard the 'I' (from 'MWI') */</span>
<a name="l00432"></a>00432             fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00433"></a>00433             
<a name="l00434"></a>00434             <span class="comment">/* read the forwarding station number (may be blank) */</span>
<a name="l00435"></a>00435             cp = &amp;mwi_msg-&gt;fwd_st[0];
<a name="l00436"></a>00436             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a> + 1; i++) {
<a name="l00437"></a>00437                <span class="keywordflow">if</span> ((c = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>)) == <span class="charliteral">' '</span>) {
<a name="l00438"></a>00438                   *cp = <span class="charliteral">'\0'</span>;
<a name="l00439"></a>00439                   <span class="keywordflow">break</span>;
<a name="l00440"></a>00440                }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                <span class="comment">/* store c in md_msg-&gt;fwd_st */</span>
<a name="l00443"></a>00443                <span class="keywordflow">if</span> (i &gt;= iface-&gt;<a class="code" href="structast__smdi__interface.html#9945c467d67fd7068c26fcedec175dd8">msdstrip</a>)
<a name="l00444"></a>00444                   *cp++ = c;
<a name="l00445"></a>00445             }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447             <span class="comment">/* make sure the station number is null terminated, even if this will truncate it */</span>
<a name="l00448"></a>00448             mwi_msg-&gt;fwd_st[<a class="code" href="smdi_8h.html#401526b3ddf0fc503e47592b40770e1c">SMDI_MAX_STATION_NUM_LEN</a>] = <span class="charliteral">'\0'</span>;
<a name="l00449"></a>00449             cp = NULL;
<a name="l00450"></a>00450             
<a name="l00451"></a>00451             <span class="comment">/* read the mwi failure cause */</span>
<a name="l00452"></a>00452             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="smdi_8h.html#36f11a46ab62fb9d49abe23a0b219bf8">SMDI_MWI_FAIL_CAUSE_LEN</a>; i++)
<a name="l00453"></a>00453                mwi_msg-&gt;cause[i] = fgetc(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455             mwi_msg-&gt;cause[<a class="code" href="smdi_8h.html#36f11a46ab62fb9d49abe23a0b219bf8">SMDI_MWI_FAIL_CAUSE_LEN</a>] = <span class="charliteral">'\0'</span>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457             <span class="comment">/* add the message to the message queue */</span>
<a name="l00458"></a>00458             mwi_msg-&gt;timestamp = ast_tvnow();
<a name="l00459"></a>00459             <a class="code" href="res__smdi_8c.html#7d34810fdec934d79f8d0ffc0686bdc9">ast_smdi_mwi_message_push</a>(iface, mwi_msg);
<a name="l00460"></a>00460             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00461"></a>00461                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Recieved SMDI MWI message on %s\n"</span>, iface-&gt;name);
<a name="l00462"></a>00462             
<a name="l00463"></a>00463             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(mwi_msg, <a class="code" href="smdi_8h.html#26f240e1343fa898db0a1b6fb49c28ea">ast_smdi_mwi_message_destroy</a>);
<a name="l00464"></a>00464          } <span class="keywordflow">else</span> {
<a name="l00465"></a>00465             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Unknown SMDI message type recieved on %s (M%c).\n"</span>, iface-&gt;name, c);
<a name="l00466"></a>00466             start = 0;
<a name="l00467"></a>00467          }
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error reading from SMDI interface %s, stopping listener thread\n"</span>, iface-&gt;name);
<a name="l00472"></a>00472    <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface,<a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00473"></a>00473    <span class="keywordflow">return</span> NULL;
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 <span class="comment"></span>
<a name="l00476"></a>00476 <span class="comment">/*! \brief ast_smdi_md_message destructor. */</span>
<a name="l00477"></a><a class="code" href="res__smdi_8c.html#a8435ff382225957ab4f884f143f478e">00477</a> <span class="keywordtype">void</span> <a class="code" href="smdi_8h.html#a8435ff382225957ab4f884f143f478e">ast_smdi_md_message_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__md__message.html">ast_smdi_md_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(msg);
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 <span class="comment"></span>
<a name="l00482"></a>00482 <span class="comment">/*! \brief ast_smdi_mwi_message destructor. */</span>
<a name="l00483"></a><a class="code" href="res__smdi_8c.html#26f240e1343fa898db0a1b6fb49c28ea">00483</a> <span class="keywordtype">void</span> <a class="code" href="smdi_8h.html#26f240e1343fa898db0a1b6fb49c28ea">ast_smdi_mwi_message_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *<a class="code" href="adsistub_8c.html#6e2baaf3b97dbeef01c0043275f9a0e7">msg</a>)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(msg);
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 <span class="comment"></span>
<a name="l00488"></a>00488 <span class="comment">/*! \brief ast_smdi_interface destructor. */</span>
<a name="l00489"></a><a class="code" href="res__smdi_8c.html#9029aa568593edace124d7030046d4f2">00489</a> <span class="keywordtype">void</span> <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491    <span class="keywordflow">if</span> (iface-&gt;<a class="code" href="structast__smdi__interface.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a> != <a class="code" href="lock_8h.html#84e4b34008de83ea9d1fa44057758022">AST_PTHREADT_NULL</a> &amp;&amp; iface-&gt;<a class="code" href="structast__smdi__interface.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a> != <a class="code" href="lock_8h.html#8dcec06d78545e75eee3aa4723faeb1e">AST_PTHREADT_STOP</a>) {
<a name="l00492"></a>00492       pthread_cancel(iface-&gt;<a class="code" href="structast__smdi__interface.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a>);
<a name="l00493"></a>00493       pthread_join(iface-&gt;<a class="code" href="structast__smdi__interface.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a>, NULL);
<a name="l00494"></a>00494    }
<a name="l00495"></a>00495    
<a name="l00496"></a>00496    iface-&gt;<a class="code" href="structast__smdi__interface.html#dc127f5d2483352fd20eaddb38feb6d2">thread</a> = <a class="code" href="lock_8h.html#8dcec06d78545e75eee3aa4723faeb1e">AST_PTHREADT_STOP</a>;
<a name="l00497"></a>00497    
<a name="l00498"></a>00498    <span class="keywordflow">if</span>(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>) 
<a name="l00499"></a>00499       fclose(iface-&gt;<a class="code" href="structast__smdi__interface.html#8c7dd922ad47494fc02c388e12c00eac">file</a>);
<a name="l00500"></a>00500    
<a name="l00501"></a>00501    <a class="code" href="astobj_8h.html#d501a6c1936784f0e38c7460cd0450de">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>, <a class="code" href="smdi_8h.html#a8435ff382225957ab4f884f143f478e">ast_smdi_md_message_destroy</a>);
<a name="l00502"></a>00502    <a class="code" href="astobj_8h.html#d501a6c1936784f0e38c7460cd0450de">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>, <a class="code" href="smdi_8h.html#26f240e1343fa898db0a1b6fb49c28ea">ast_smdi_mwi_message_destroy</a>);
<a name="l00503"></a>00503    <a class="code" href="astobj_8h.html#49009cb461a700fd0edeede01cf60a45">ASTOBJ_CONTAINER_DESTROY</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#3f8c89d4dde4d73a610bf9598eb7f0d3">md_q</a>);
<a name="l00504"></a>00504    <a class="code" href="astobj_8h.html#49009cb461a700fd0edeede01cf60a45">ASTOBJ_CONTAINER_DESTROY</a>(&amp;iface-&gt;<a class="code" href="structast__smdi__interface.html#d7ac20fcf9593dfebaf7eed2b2533375">mwi_q</a>);
<a name="l00505"></a>00505    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(iface);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507    <a class="code" href="loader_8c.html#593d1afacbd4c5bd89aac5a810e50f6e">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 <span class="comment"></span>
<a name="l00510"></a>00510 <span class="comment">/*!</span>
<a name="l00511"></a>00511 <span class="comment"> * \internal</span>
<a name="l00512"></a>00512 <span class="comment"> * \brief Load and reload SMDI configuration.</span>
<a name="l00513"></a>00513 <span class="comment"> * \param reload this should be 1 if we are reloading and 0 if not.</span>
<a name="l00514"></a>00514 <span class="comment"> *</span>
<a name="l00515"></a>00515 <span class="comment"> * This function loads/reloads the SMDI configuration and starts and stops</span>
<a name="l00516"></a>00516 <span class="comment"> * interfaces accordingly.</span>
<a name="l00517"></a>00517 <span class="comment"> *</span>
<a name="l00518"></a>00518 <span class="comment"> * \return zero on success, -1 on failure, and 1 if no smdi interfaces were started.</span>
<a name="l00519"></a>00519 <span class="comment"> */</span>
<a name="l00520"></a><a class="code" href="res__smdi_8c.html#6ad11282475060d8211cba4ab15456e9">00520</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__smdi_8c.html#6ad11282475060d8211cba4ab15456e9">smdi_load</a>(<span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>)
<a name="l00521"></a>00521 {
<a name="l00522"></a>00522    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *conf;
<a name="l00523"></a>00523    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00524"></a>00524    <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *iface = NULL;
<a name="l00525"></a>00525    <span class="keywordtype">int</span> res = 0;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <span class="comment">/* Config options */</span>
<a name="l00528"></a>00528    speed_t baud_rate = B9600;     <span class="comment">/* 9600 baud rate */</span>
<a name="l00529"></a>00529    tcflag_t paritybit = PARENB;   <span class="comment">/* even parity checking */</span>
<a name="l00530"></a>00530    tcflag_t charsize = CS7;       <span class="comment">/* seven bit characters */</span>
<a name="l00531"></a>00531    <span class="keywordtype">int</span> stopbits = 0;              <span class="comment">/* One stop bit */</span>
<a name="l00532"></a>00532    
<a name="l00533"></a>00533    <span class="keywordtype">int</span> <a class="code" href="structast__smdi__interface.html#9945c467d67fd7068c26fcedec175dd8">msdstrip</a> = 0;              <span class="comment">/* strip zero digits */</span>
<a name="l00534"></a>00534    <span class="keywordtype">long</span> <a class="code" href="structast__smdi__interface.html#1e5801b70e88261a93a6927ed7a250f2">msg_expiry</a> = <a class="code" href="res__smdi_8c.html#972d0b700b758b9521036303c88220eb">SMDI_MSG_EXPIRY_TIME</a>;
<a name="l00535"></a>00535    
<a name="l00536"></a>00536    conf = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="keywordflow">if</span> (!conf) {
<a name="l00539"></a>00539       <span class="keywordflow">if</span> (reload)
<a name="l00540"></a>00540          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to reload config %s: SMDI untouched\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>);
<a name="l00541"></a>00541       <span class="keywordflow">else</span>
<a name="l00542"></a>00542          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_NOTICE, <span class="stringliteral">"Unable to load config %s: SMDI disabled\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>);
<a name="l00543"></a>00543       <span class="keywordflow">return</span> 1;
<a name="l00544"></a>00544    }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546    <span class="comment">/* Mark all interfaces that we are listening on.  We will unmark them</span>
<a name="l00547"></a>00547 <span class="comment">    * as we find them in the config file, this way we know any interfaces</span>
<a name="l00548"></a>00548 <span class="comment">    * still marked after we have finished parsing the config file should</span>
<a name="l00549"></a>00549 <span class="comment">    * be stopped.</span>
<a name="l00550"></a>00550 <span class="comment">    */</span>
<a name="l00551"></a>00551    <span class="keywordflow">if</span> (reload)
<a name="l00552"></a>00552       <a class="code" href="astobj_8h.html#89fd28c5d6a18d84529b13c4dda8dda4">ASTOBJ_CONTAINER_MARKALL</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    <span class="keywordflow">for</span> (v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(conf, <span class="stringliteral">"interfaces"</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>) {
<a name="l00555"></a>00555       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"baudrate"</span>)) {
<a name="l00556"></a>00556          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"9600"</span>))
<a name="l00557"></a>00557             baud_rate = B9600;
<a name="l00558"></a>00558          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"4800"</span>))
<a name="l00559"></a>00559             baud_rate = B4800;
<a name="l00560"></a>00560          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"2400"</span>))
<a name="l00561"></a>00561             baud_rate = B2400;
<a name="l00562"></a>00562          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"1200"</span>))
<a name="l00563"></a>00563             baud_rate = B1200;
<a name="l00564"></a>00564          <span class="keywordflow">else</span> {
<a name="l00565"></a>00565             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid baud rate '%s' specified in %s (line %d), using default\n"</span>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00566"></a>00566             baud_rate = B9600;
<a name="l00567"></a>00567          }
<a name="l00568"></a>00568       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"msdstrip"</span>)) {
<a name="l00569"></a>00569          <span class="keywordflow">if</span> (!sscanf(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%d"</span>, &amp;msdstrip)) {
<a name="l00570"></a>00570             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid msdstrip value in %s (line %d), using default\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00571"></a>00571             msdstrip = 0;
<a name="l00572"></a>00572          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 &gt; msdstrip || msdstrip &gt; 9) {
<a name="l00573"></a>00573             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid msdstrip value in %s (line %d), using default\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00574"></a>00574             msdstrip = 0;
<a name="l00575"></a>00575          }
<a name="l00576"></a>00576       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"msgexpirytime"</span>)) {
<a name="l00577"></a>00577          <span class="keywordflow">if</span> (!sscanf(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"%ld"</span>, &amp;msg_expiry)) {
<a name="l00578"></a>00578             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid msgexpirytime value in %s (line %d), using default\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00579"></a>00579             msg_expiry = <a class="code" href="res__smdi_8c.html#972d0b700b758b9521036303c88220eb">SMDI_MSG_EXPIRY_TIME</a>;
<a name="l00580"></a>00580          }
<a name="l00581"></a>00581       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"paritybit"</span>)) {
<a name="l00582"></a>00582          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"even"</span>))
<a name="l00583"></a>00583             paritybit = PARENB;
<a name="l00584"></a>00584          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"odd"</span>))
<a name="l00585"></a>00585             paritybit = PARENB | PARODD;
<a name="l00586"></a>00586          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"none"</span>))
<a name="l00587"></a>00587             paritybit = ~PARENB;
<a name="l00588"></a>00588          <span class="keywordflow">else</span> {
<a name="l00589"></a>00589             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid parity bit setting in %s (line %d), using default\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00590"></a>00590             paritybit = PARENB;
<a name="l00591"></a>00591          }
<a name="l00592"></a>00592       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"charsize"</span>)) {
<a name="l00593"></a>00593          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"7"</span>))
<a name="l00594"></a>00594             charsize = CS7;
<a name="l00595"></a>00595          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="stringliteral">"8"</span>))
<a name="l00596"></a>00596             charsize = CS8;
<a name="l00597"></a>00597          <span class="keywordflow">else</span> {
<a name="l00598"></a>00598             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Invalid character size setting in %s (line %d), using default\n"</span>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>, v-&gt;<a class="code" href="structast__variable.html#5525da36abafe9a243105119cea54be5">lineno</a>);
<a name="l00599"></a>00599             charsize = CS7;
<a name="l00600"></a>00600          }
<a name="l00601"></a>00601       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"twostopbits"</span>)) {
<a name="l00602"></a>00602          stopbits = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00603"></a>00603       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="stringliteral">"smdiport"</span>)) {
<a name="l00604"></a>00604          <span class="keywordflow">if</span> (reload) {
<a name="l00605"></a>00605             <span class="comment">/* we are reloading, check if we are already</span>
<a name="l00606"></a>00606 <span class="comment">             * monitoring this interface, if we are we do</span>
<a name="l00607"></a>00607 <span class="comment">             * not want to start it again.  This also has</span>
<a name="l00608"></a>00608 <span class="comment">             * the side effect of not updating different</span>
<a name="l00609"></a>00609 <span class="comment">             * setting for the serial port, but it should</span>
<a name="l00610"></a>00610 <span class="comment">             * be trivial to rewrite this section so that</span>
<a name="l00611"></a>00611 <span class="comment">             * options on the port are changed without</span>
<a name="l00612"></a>00612 <span class="comment">             * restarting the interface.  Or the interface</span>
<a name="l00613"></a>00613 <span class="comment">             * could be restarted with out emptying the</span>
<a name="l00614"></a>00614 <span class="comment">             * queue. */</span>
<a name="l00615"></a>00615             <span class="keywordflow">if</span> ((iface = <a class="code" href="astobj_8h.html#bb4a582d1b01a686da4f5dacfab2cfba">ASTOBJ_CONTAINER_FIND</a>(&amp;smdi_ifaces, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>))) {
<a name="l00616"></a>00616                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"SMDI interface %s already running, not restarting\n"</span>, iface-&gt;name);
<a name="l00617"></a>00617                <a class="code" href="astobj_8h.html#0a64e5d6351ea151fd82be7033731f29">ASTOBJ_UNMARK</a>(iface);
<a name="l00618"></a>00618                <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00619"></a>00619                <span class="keywordflow">continue</span>;
<a name="l00620"></a>00620             }
<a name="l00621"></a>00621          }
<a name="l00622"></a>00622                      
<a name="l00623"></a>00623          <span class="keywordflow">if</span> (!(iface = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*iface))))
<a name="l00624"></a>00624             <span class="keywordflow">continue</span>;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626          <a class="code" href="astobj_8h.html#d98ac8e31e47134b19f5305e090ad209">ASTOBJ_INIT</a>(iface);
<a name="l00627"></a>00627          <a class="code" href="astobj_8h.html#284e163c14171b2ee463adb64dc35f97">ASTOBJ_CONTAINER_INIT</a>(&amp;iface-&gt;md_q);
<a name="l00628"></a>00628          <a class="code" href="astobj_8h.html#284e163c14171b2ee463adb64dc35f97">ASTOBJ_CONTAINER_INIT</a>(&amp;iface-&gt;mwi_q);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630          ast_copy_string(iface-&gt;name, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(iface-&gt;name));
<a name="l00631"></a>00631 
<a name="l00632"></a>00632          <span class="keywordflow">if</span> (!(iface-&gt;file = fopen(iface-&gt;name, <span class="stringliteral">"r"</span>))) {
<a name="l00633"></a>00633             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error opening SMDI interface %s (%s)\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00634"></a>00634             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00635"></a>00635             <span class="keywordflow">continue</span>;
<a name="l00636"></a>00636          }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638          iface-&gt;fd = fileno(iface-&gt;file);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640          <span class="comment">/* Set the proper attributes for our serial port. */</span>
<a name="l00641"></a>00641 
<a name="l00642"></a>00642          <span class="comment">/* get the current attributes from the port */</span>
<a name="l00643"></a>00643          <span class="keywordflow">if</span> (tcgetattr(iface-&gt;fd, &amp;iface-&gt;mode)) {
<a name="l00644"></a>00644             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error getting atributes of %s (%s)\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00645"></a>00645             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00646"></a>00646             <span class="keywordflow">continue</span>;
<a name="l00647"></a>00647          }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649          <span class="comment">/* set the desired speed */</span>
<a name="l00650"></a>00650          <span class="keywordflow">if</span> (cfsetispeed(&amp;iface-&gt;mode, baud_rate) || cfsetospeed(&amp;iface-&gt;mode, baud_rate)) {
<a name="l00651"></a>00651             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error setting baud rate on %s (%s)\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00652"></a>00652             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00653"></a>00653             <span class="keywordflow">continue</span>;
<a name="l00654"></a>00654          }
<a name="l00655"></a>00655          
<a name="l00656"></a>00656          <span class="comment">/* set the stop bits */</span>
<a name="l00657"></a>00657          <span class="keywordflow">if</span> (stopbits)
<a name="l00658"></a>00658             iface-&gt;mode.c_cflag = iface-&gt;mode.c_cflag | CSTOPB;   <span class="comment">/* set two stop bits */</span>
<a name="l00659"></a>00659          <span class="keywordflow">else</span>
<a name="l00660"></a>00660             iface-&gt;mode.c_cflag = iface-&gt;mode.c_cflag &amp; ~CSTOPB;  <span class="comment">/* set one stop bit */</span>
<a name="l00661"></a>00661 
<a name="l00662"></a>00662          <span class="comment">/* set the parity */</span>
<a name="l00663"></a>00663          iface-&gt;mode.c_cflag = (iface-&gt;mode.c_cflag &amp; ~PARENB &amp; ~PARODD) | paritybit;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665          <span class="comment">/* set the character size */</span>
<a name="l00666"></a>00666          iface-&gt;mode.c_cflag = (iface-&gt;mode.c_cflag &amp; ~CSIZE) | charsize;
<a name="l00667"></a>00667          
<a name="l00668"></a>00668          <span class="comment">/* commit the desired attributes */</span>
<a name="l00669"></a>00669          <span class="keywordflow">if</span> (tcsetattr(iface-&gt;fd, TCSAFLUSH, &amp;iface-&gt;mode)) {
<a name="l00670"></a>00670             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error setting attributes on %s (%s)\n"</span>, iface-&gt;name, strerror(errno));
<a name="l00671"></a>00671             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00672"></a>00672             <span class="keywordflow">continue</span>;
<a name="l00673"></a>00673          }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675          <span class="comment">/* set the msdstrip */</span>
<a name="l00676"></a>00676          iface-&gt;msdstrip = msdstrip;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678          <span class="comment">/* set the message expiry time */</span>
<a name="l00679"></a>00679          iface-&gt;msg_expiry = msg_expiry;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681                         <span class="comment">/* start the listner thread */</span>
<a name="l00682"></a>00682          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ge36cdd7167e060bff70d00fbd82809eb">option_verbose</a> &gt; 2)
<a name="l00683"></a>00683             <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<a class="code" href="logger_8h.html#aefd5a67b7464040f5352e4ecdc535ca">VERBOSE_PREFIX_3</a> <span class="stringliteral">"Starting SMDI monitor thread for %s\n"</span>, iface-&gt;name);
<a name="l00684"></a>00684          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#351b78c7aeb62b2b57eb447287cdd9d4">ast_pthread_create_background</a>(&amp;iface-&gt;thread, NULL, <a class="code" href="res__smdi_8c.html#0fec9cd6787ca7fd02a6b01764a89db3">smdi_read</a>, iface)) {
<a name="l00685"></a>00685             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Error starting SMDI monitor thread for %s\n"</span>, iface-&gt;name);
<a name="l00686"></a>00686             <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00687"></a>00687             <span class="keywordflow">continue</span>;
<a name="l00688"></a>00688          }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690          <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;smdi_ifaces, iface);
<a name="l00691"></a>00691          <a class="code" href="astobj_8h.html#5a9448be019b56fa37bce1be4bc2a48f">ASTOBJ_UNREF</a>(iface, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00692"></a>00692          <a class="code" href="loader_8c.html#7dec48488624afa5d0a80ad2726071db">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l00693"></a>00693       } <span class="keywordflow">else</span> {
<a name="l00694"></a>00694          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Ignoring unknown option %s in %s\n"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="cdr__sqlite3__custom_8c.html#52bfd44f1c76ea9f6f2eaa6bfa24c3e2">config_file</a>);
<a name="l00695"></a>00695       }
<a name="l00696"></a>00696    }
<a name="l00697"></a>00697    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(conf);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699    <span class="comment">/* Prune any interfaces we should no longer monitor. */</span>
<a name="l00700"></a>00700    <span class="keywordflow">if</span> (<a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>)
<a name="l00701"></a>00701       <a class="code" href="astobj_8h.html#896f964ecc2aa186efa83ddd9fba70a9">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00702"></a>00702    
<a name="l00703"></a>00703    <a class="code" href="astobj_8h.html#fcb2926cde56962fb8887696bdb7dc2b">ASTOBJ_CONTAINER_RDLOCK</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>);
<a name="l00704"></a>00704    <span class="comment">/* TODO: this is bad, we need an ASTOBJ method for this! */</span>
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (!<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>.head)
<a name="l00706"></a>00706       res = 1;
<a name="l00707"></a>00707    <a class="code" href="astobj_8h.html#f70e8b93733ec7694c8390e70042c645">ASTOBJ_CONTAINER_UNLOCK</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>);
<a name="l00708"></a>00708          
<a name="l00709"></a>00709    <span class="keywordflow">return</span> res;
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
<a name="l00712"></a><a class="code" href="res__smdi_8c.html#8c304b271325d497b3ce1886465a1abe">00712</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l00713"></a>00713 {
<a name="l00714"></a>00714    <span class="keywordtype">int</span> res;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716    <span class="comment">/* initialize our containers */</span>
<a name="l00717"></a>00717    memset(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>));
<a name="l00718"></a>00718    <a class="code" href="astobj_8h.html#284e163c14171b2ee463adb64dc35f97">ASTOBJ_CONTAINER_INIT</a>(&amp;smdi_ifaces);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <span class="comment">/* load the config and start the listener threads*/</span>
<a name="l00721"></a>00721    res = <a class="code" href="res__smdi_8c.html#6ad11282475060d8211cba4ab15456e9">smdi_load</a>(0);
<a name="l00722"></a>00722    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00723"></a>00723       <span class="keywordflow">return</span> res;
<a name="l00724"></a>00724    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1) {
<a name="l00725"></a>00725       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No SMDI interfaces are available to listen on, not starting SDMI listener.\n"</span>);
<a name="l00726"></a>00726       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#6b66b922ea50fb20d0a8a25ba8317b0adea6426eed250d0d922d7e289a706663">AST_MODULE_LOAD_DECLINE</a>;;
<a name="l00727"></a>00727    } <span class="keywordflow">else</span>
<a name="l00728"></a>00728       <span class="keywordflow">return</span> 0;
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="res__smdi_8c.html#eaf793e807a29b69460b0c6c94a79a0b">00731</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733    <span class="comment">/* this destructor stops any running smdi_read threads */</span>
<a name="l00734"></a>00734    <a class="code" href="astobj_8h.html#d501a6c1936784f0e38c7460cd0450de">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>, <a class="code" href="smdi_8h.html#9029aa568593edace124d7030046d4f2">ast_smdi_interface_destroy</a>);
<a name="l00735"></a>00735    <a class="code" href="astobj_8h.html#49009cb461a700fd0edeede01cf60a45">ASTOBJ_CONTAINER_DESTROY</a>(&amp;<a class="code" href="res__smdi_8c.html#008b8c6323578d5bdece62e26931cab8">smdi_ifaces</a>);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    <span class="keywordflow">return</span> 0;
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a><a class="code" href="res__smdi_8c.html#91875b0435b600b8ed0e424d70d492b0">00740</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>(<span class="keywordtype">void</span>)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742    <span class="keywordtype">int</span> res;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744    res = <a class="code" href="res__smdi_8c.html#6ad11282475060d8211cba4ab15456e9">smdi_load</a>(1);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00747"></a>00747       <span class="keywordflow">return</span> res;
<a name="l00748"></a>00748    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1) {
<a name="l00749"></a>00749       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"No SMDI interfaces were specified to listen on, not starting SDMI listener.\n"</span>);
<a name="l00750"></a>00750       <span class="keywordflow">return</span> 0;
<a name="l00751"></a>00751    } <span class="keywordflow">else</span>
<a name="l00752"></a>00752       <span class="keywordflow">return</span> 0;
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <a class="code" href="module_8h.html#237cb97341e39c38b6e3ecb88b7ea148">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#b4566594eeb42c8fc7d6733c7b4b6c0a0b99d39f1f6a9afeedd2f8e6632dd76c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">"Simplified Message Desk Interface (SMDI) Resource"</span>,
<a name="l00756"></a>00756       .load = <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>,
<a name="l00757"></a>00757       .unload = <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>,
<a name="l00758"></a>00758       .<a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a> = <a class="code" href="chan__agent_8c.html#91875b0435b600b8ed0e424d70d492b0">reload</a>,
<a name="l00759"></a>00759           );
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:50 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
