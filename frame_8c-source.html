<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:42 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fmain_2F.html">main</a></div>
<h1>frame.c</h1><a href="frame_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Frame and codec manipulation routines</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;stdlib.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="frame_8h.html">asterisk/frame.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="term_8h.html">asterisk/term.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="threadstorage_8h.html">asterisk/threadstorage.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#ifdef TRACE_FRAMES</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> headers;
<a name="l00049"></a>00049 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(headerlist, <a class="code" href="structast__frame.html">ast_frame</a>);
<a name="l00050"></a>00050 <span class="preprocessor">#endif</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#7a96c29c7d892ca58f4a909c24d439ae">frame_cache_cleanup</a>(<span class="keywordtype">void</span> *data);
<a name="l00054"></a>00054 <span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">/*! \brief A per-thread cache of frame headers */</span>
<a name="l00056"></a>00056 <a class="code" href="threadstorage_8h.html#93a74b9666129ce5e07fc4f6bf37192e">AST_THREADSTORAGE_CUSTOM</a>(frame_cache, NULL, <a class="code" href="frame_8c.html#7a96c29c7d892ca58f4a909c24d439ae">frame_cache_cleanup</a>);
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">/*! </span>
<a name="l00059"></a>00059 <span class="comment"> * \brief Maximum ast_frame cache size</span>
<a name="l00060"></a>00060 <span class="comment"> *</span>
<a name="l00061"></a>00061 <span class="comment"> * In most cases where the frame header cache will be useful, the size</span>
<a name="l00062"></a>00062 <span class="comment"> * of the cache will stay very small.  However, it is not always the case that</span>
<a name="l00063"></a>00063 <span class="comment"> * the same thread that allocates the frame will be the one freeing them, so</span>
<a name="l00064"></a>00064 <span class="comment"> * sometimes a thread will never have any frames in its cache, or the cache</span>
<a name="l00065"></a>00065 <span class="comment"> * will never be pulled from.  For the latter case, we limit the maximum size. </span>
<a name="l00066"></a>00066 <span class="comment"> */</span> 
<a name="l00067"></a><a class="code" href="frame_8c.html#87e971d790bebfcf27c6924d2a541962">00067</a> <span class="preprocessor">#define FRAME_CACHE_MAX_SIZE  10</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">/*! \brief This is just so ast_frames, a list head struct for holding a list of</span>
<a name="l00070"></a>00070 <span class="comment"> *  ast_frame structures, is defined. */</span>
<a name="l00071"></a>00071 <a class="code" href="linkedlists_8h.html#0bcd5ca819474a5c8a780be977fef933">AST_LIST_HEAD_NOLOCK</a>(ast_frames, <a class="code" href="structast__frame.html">ast_frame</a>);
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="structast__frame__cache.html">00073</a> <span class="keyword">struct </span><a class="code" href="structast__frame__cache.html">ast_frame_cache</a> {
<a name="l00074"></a><a class="code" href="structast__frame__cache.html#10ae9fc7d453b0dd525d0edf2ede7961">00074</a>    <span class="keyword">struct </span>ast_frames list;
<a name="l00075"></a><a class="code" href="structast__frame__cache.html#f7bd60b75b29d79b660a2859395c1a24">00075</a>    size_t <a class="code" href="structast__frame__cache.html#f7bd60b75b29d79b660a2859395c1a24">size</a>;
<a name="l00076"></a>00076 };
<a name="l00077"></a>00077 <span class="preprocessor">#endif</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="frame_8c.html#4c4d677dbe54030f7b824011fda4c1f2">00079</a> <span class="preprocessor">#define SMOOTHER_SIZE 8000</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a><a class="code" href="frame_8c.html#4b01fdbd475cfb9e94271b62a217cd8c">00081</a> <span class="keyword">enum</span> <a class="code" href="frame_8c.html#4b01fdbd475cfb9e94271b62a217cd8c">frame_type</a> {
<a name="l00082"></a>00082    <a class="code" href="codec__speex_8c.html#a2b3fb087d30282dcdd9b33129467005">TYPE_HIGH</a>,     <span class="comment">/* 0x0 */</span>
<a name="l00083"></a>00083    <a class="code" href="codec__speex_8c.html#2bab38e384ef1b09ae7983dbdd56e54e">TYPE_LOW</a>,      <span class="comment">/* 0x1 */</span>
<a name="l00084"></a>00084    <a class="code" href="codec__speex_8c.html#e5a6dc5e8ad909a417c1e0cfdb58968b">TYPE_SILENCE</a>,  <span class="comment">/* 0x2 */</span>
<a name="l00085"></a>00085    <a class="code" href="frame_8c.html#4b01fdbd475cfb9e94271b62a217cd8cab6357a224ae82391894283119822575">TYPE_DONTSEND</a>  <span class="comment">/* 0x3 */</span>
<a name="l00086"></a>00086 };
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="frame_8c.html#e27eb787a050ee746c993029d47a484e">00088</a> <span class="preprocessor">#define TYPE_MASK 0x3</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="structast__smoother.html">00090</a> <span class="keyword">struct </span><a class="code" href="structast__smoother.html">ast_smoother</a> {
<a name="l00091"></a><a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">00091</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a>;
<a name="l00092"></a><a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">00092</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00093"></a><a class="code" href="structast__smoother.html#9eb0444a6df024c51d504a96ead77e41">00093</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#9eb0444a6df024c51d504a96ead77e41">readdata</a>;
<a name="l00094"></a><a class="code" href="structast__smoother.html#d6b06cbbe0d4d2fd01839aba757812da">00094</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#d6b06cbbe0d4d2fd01839aba757812da">optimizablestream</a>;
<a name="l00095"></a><a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">00095</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a>;
<a name="l00096"></a><a class="code" href="structast__smoother.html#7d6e203a822c06031004a99ca9fb3931">00096</a>    <span class="keywordtype">float</span> <a class="code" href="structast__smoother.html#7d6e203a822c06031004a99ca9fb3931">samplesperbyte</a>;
<a name="l00097"></a><a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">00097</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> f;
<a name="l00098"></a><a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">00098</a>    <span class="keyword">struct </span>timeval delivery;
<a name="l00099"></a><a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">00099</a>    <span class="keywordtype">char</span> <a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a>[<a class="code" href="frame_8c.html#4c4d677dbe54030f7b824011fda4c1f2">SMOOTHER_SIZE</a>];
<a name="l00100"></a><a class="code" href="structast__smoother.html#a2471faf0afccba62e896c7879c78f42">00100</a>    <span class="keywordtype">char</span> <a class="code" href="structast__smoother.html#a2471faf0afccba62e896c7879c78f42">framedata</a>[<a class="code" href="frame_8c.html#4c4d677dbe54030f7b824011fda4c1f2">SMOOTHER_SIZE</a> + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>];
<a name="l00101"></a><a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">00101</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a>;
<a name="l00102"></a><a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">00102</a>    <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00103"></a>00103 };
<a name="l00104"></a>00104 <span class="comment"></span>
<a name="l00105"></a>00105 <span class="comment">/*! \brief Definition of supported media formats (codecs) */</span>
<a name="l00106"></a><a class="code" href="frame_8c.html#9ce0aeba3d8697b633cb72e3f79c60ad">00106</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__format__list.html">ast_format_list</a> AST_FORMAT_LIST[] = {               <span class="comment">/*!&lt; Bit number: comment  - Bit numbers are hard coded in show_codec() */</span>
<a name="l00107"></a>00107    { 1, <a class="code" href="frame_8h.html#0b4ea457c95753454e021c511a5daecc">AST_FORMAT_G723_1</a> , <span class="stringliteral">"g723"</span> , <span class="stringliteral">"G.723.1"</span>, 20, 30, 300, 30, 30 },  <span class="comment">/*!&lt;  1 */</span>
<a name="l00108"></a>00108    { 1, <a class="code" href="frame_8h.html#9864508932a19f37d9afbbc7cabd5990">AST_FORMAT_GSM</a>, <span class="stringliteral">"gsm"</span> , <span class="stringliteral">"GSM"</span>, 33, 20, 300, 20, 20 },     <span class="comment">/*!&lt;  2: codec_gsm.c */</span>
<a name="l00109"></a>00109    { 1, <a class="code" href="frame_8h.html#a71706b2c864525ec1c9fcf925ae3802">AST_FORMAT_ULAW</a>, <span class="stringliteral">"ulaw"</span>, <span class="stringliteral">"G.711 u-law"</span>, 80, 10, 150, 10, 20 },  <span class="comment">/*!&lt;  3: codec_ulaw.c */</span>
<a name="l00110"></a>00110    { 1, <a class="code" href="frame_8h.html#edc237300fef31677662db961c07484b">AST_FORMAT_ALAW</a>, <span class="stringliteral">"alaw"</span>, <span class="stringliteral">"G.711 A-law"</span>, 80, 10, 150, 10, 20 },  <span class="comment">/*!&lt;  4: codec_alaw.c */</span>
<a name="l00111"></a>00111    { 1, <a class="code" href="frame_8h.html#a594899d5bea5f591eda7e20b5e2c161">AST_FORMAT_G726</a>, <span class="stringliteral">"g726"</span>, <span class="stringliteral">"G.726 RFC3551"</span>, 40, 10, 300, 10, 20 },   <span class="comment">/*!&lt;  5: codec_g726.c */</span>
<a name="l00112"></a>00112    { 1, <a class="code" href="frame_8h.html#b1048e305f2ee62aebab30899c88f8ce">AST_FORMAT_ADPCM</a>, <span class="stringliteral">"adpcm"</span> , <span class="stringliteral">"ADPCM"</span>, 40, 10, 300, 10, 20 },  <span class="comment">/*!&lt;  6: codec_adpcm.c */</span>
<a name="l00113"></a>00113    { 1, <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>, <span class="stringliteral">"slin"</span>, <span class="stringliteral">"16 bit Signed Linear PCM"</span>, 160, 10, 70, 10, 20, <a class="code" href="frame_8h.html#64fae9839fa3fe2cb6d7da31bf917812">AST_SMOOTHER_FLAG_BE</a> },   <span class="comment">/*!&lt; 7 */</span>
<a name="l00114"></a>00114    { 1, <a class="code" href="frame_8h.html#87eb67578117e5f22d34386b7c989e08">AST_FORMAT_LPC10</a>, <span class="stringliteral">"lpc10"</span>, <span class="stringliteral">"LPC10"</span>, 7, 20, 20, 20, 20 },     <span class="comment">/*!&lt;  8: codec_lpc10.c */</span> 
<a name="l00115"></a>00115    { 1, <a class="code" href="frame_8h.html#66b369abf91a6c6519ca7cad6c657ae7">AST_FORMAT_G729A</a>, <span class="stringliteral">"g729"</span>, <span class="stringliteral">"G.729A"</span>, 10, 10, 230, 10, 20, <a class="code" href="frame_8h.html#7ae0c97d2c7012da804f40caaf047042">AST_SMOOTHER_FLAG_G729</a> },   <span class="comment">/*!&lt;  9: Binary commercial distribution */</span>
<a name="l00116"></a>00116    { 1, <a class="code" href="frame_8h.html#a4f3a9e622d8cbe3fe3eed2a35923d8c">AST_FORMAT_SPEEX</a>, <span class="stringliteral">"speex"</span>, <span class="stringliteral">"SpeeX"</span>, 10, 10, 60, 10, 20 },    <span class="comment">/*!&lt; 10: codec_speex.c */</span>
<a name="l00117"></a>00117    { 1, <a class="code" href="frame_8h.html#c2f4d8d1a79322d795824fd91fb2706c">AST_FORMAT_ILBC</a>, <span class="stringliteral">"ilbc"</span>, <span class="stringliteral">"iLBC"</span>, 50, 30, 30, 30, 30 },    <span class="comment">/*!&lt; 11: codec_ilbc.c */</span> <span class="comment">/* inc=30ms - workaround */</span>
<a name="l00118"></a>00118    { 1, <a class="code" href="frame_8h.html#3c0408e35d11793967a2e178f93256cd">AST_FORMAT_G726_AAL2</a>, <span class="stringliteral">"g726aal2"</span>, <span class="stringliteral">"G.726 AAL2"</span>, 40, 10, 300, 10, 20 },   <span class="comment">/*!&lt;  12: codec_g726.c */</span>
<a name="l00119"></a>00119    { 1, <a class="code" href="frame_8h.html#b418abcb13f17e85f68a691f34e99e1a">AST_FORMAT_G722</a>, <span class="stringliteral">"g722"</span>, <span class="stringliteral">"G722"</span>},             <span class="comment">/*!&lt; 13 */</span>
<a name="l00120"></a>00120    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00121"></a>00121    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00122"></a>00122    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00123"></a>00123    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00124"></a>00124    { 0, <a class="code" href="frame_8h.html#165e3a55e2cf1a685ccaab3e4ecab88c">AST_FORMAT_MAX_AUDIO</a>, <span class="stringliteral">"maxaudio"</span>, <span class="stringliteral">"Maximum audio format"</span> },  
<a name="l00125"></a>00125    { 1, <a class="code" href="frame_8h.html#c938a69bcdf2ac558a48e761b31ccc7b">AST_FORMAT_JPEG</a>, <span class="stringliteral">"jpeg"</span>, <span class="stringliteral">"JPEG image"</span>}, <span class="comment">/*!&lt; 17: See format_jpeg.c */</span>
<a name="l00126"></a>00126    { 1, <a class="code" href="frame_8h.html#8143185ce3d3ff36da69fbdbe22c152d">AST_FORMAT_PNG</a>, <span class="stringliteral">"png"</span>, <span class="stringliteral">"PNG image"</span>}, <span class="comment">/*!&lt; 18: Image format */</span>
<a name="l00127"></a>00127    { 1, <a class="code" href="frame_8h.html#cb4e0559e389687ebc884fa05fbed4c4">AST_FORMAT_H261</a>, <span class="stringliteral">"h261"</span>, <span class="stringliteral">"H.261 Video"</span> },  <span class="comment">/*!&lt; 19: H.261 Video Passthrough */</span>
<a name="l00128"></a>00128    { 1, <a class="code" href="frame_8h.html#117dee0e1ceeee1a0db603fe212feea0">AST_FORMAT_H263</a>, <span class="stringliteral">"h263"</span>, <span class="stringliteral">"H.263 Video"</span> },  <span class="comment">/*!&lt; 20: H.263 Passthrough support, see format_h263.c */</span>
<a name="l00129"></a>00129    { 1, <a class="code" href="frame_8h.html#92b0b91625ab6273ff0aa040d104f797">AST_FORMAT_H263_PLUS</a>, <span class="stringliteral">"h263p"</span>, <span class="stringliteral">"H.263+ Video"</span> }, <span class="comment">/*!&lt; 21: H.263plus passthrough support See format_h263.c */</span>
<a name="l00130"></a>00130    { 1, <a class="code" href="frame_8h.html#d8c642c1411004051cc43b202aebdc64">AST_FORMAT_H264</a>, <span class="stringliteral">"h264"</span>, <span class="stringliteral">"H.264 Video"</span> },  <span class="comment">/*!&lt; 22: Passthrough support, see format_h263.c */</span>
<a name="l00131"></a>00131    { 1, <a class="code" href="frame_8h.html#c1fa6f71617728144288a2542a4994d4">AST_FORMAT_MP4_VIDEO</a>, <span class="stringliteral">"mpeg4"</span>, <span class="stringliteral">"MPEG4 Video"</span> }, <span class="comment">/*!&lt; Passthrough support for MPEG4 */</span>
<a name="l00132"></a>00132    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00133"></a>00133    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00134"></a>00134    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00135"></a>00135    { 0, <a class="code" href="frame_8h.html#c3eeac0a86246d4b2b2c9ea6881d56b4">AST_FORMAT_MAX_VIDEO</a>, <span class="stringliteral">"maxvideo"</span>, <span class="stringliteral">"Maximum video format"</span> },
<a name="l00136"></a>00136    { 1, <a class="code" href="frame_8h.html#e6ebe929c12bba52018c17fa9fdf2265">AST_FORMAT_T140</a>, <span class="stringliteral">"t140"</span>, <span class="stringliteral">"Passthrough T.140 Realtime Text"</span> },
<a name="l00137"></a>00137    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00138"></a>00138    { 0, 0, <span class="stringliteral">"nothing"</span>, <span class="stringliteral">"undefined"</span> },
<a name="l00139"></a>00139    { 0, <a class="code" href="frame_8h.html#ca0664a2b9a5933974c9f7f9dbe4347a">AST_FORMAT_MAX_TEXT</a>, <span class="stringliteral">"maxtext"</span>, <span class="stringliteral">"Maximum text format"</span> },
<a name="l00140"></a>00140 };
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="frame_8h.html#8bfe1415e256ff41d93a3ce9396e815f">00142</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> ast_null_frame = { <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92eaf38b643259d44fcc0a869ab36609b1">AST_FRAME_NULL</a>, };
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="frame_8h.html#20dbee702fb05e910164a2a7b6320b39">00144</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#728e81c6588ddb6b11345d50085359bd">ast_smoother_reset</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> size)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146    memset(s, 0, <span class="keyword">sizeof</span>(*s));
<a name="l00147"></a>00147    s-&gt;size = size;
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00150"></a><a class="code" href="frame_8h.html#afbbde21bf197958c8fad5d54e52d1ae">00150</a> <span class="keyword">struct </span><a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="frame_8c.html#3b520e6249c7ee888d133c43bbdda78a">ast_smoother_new</a>(<span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a>)
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152    <span class="keyword">struct </span><a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>;
<a name="l00153"></a>00153    <span class="keywordflow">if</span> (size &lt; 1)
<a name="l00154"></a>00154       <span class="keywordflow">return</span> NULL;
<a name="l00155"></a>00155    <span class="keywordflow">if</span> ((s = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(<span class="keyword">sizeof</span>(*s))))
<a name="l00156"></a>00156       <a class="code" href="frame_8c.html#728e81c6588ddb6b11345d50085359bd">ast_smoother_reset</a>(s, size);
<a name="l00157"></a>00157    <span class="keywordflow">return</span> s;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="frame_8h.html#6c60cea2f10fb5361052d6f5d50a23df">00160</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#4fb682b625a3cae6320d2b93d88c5625">ast_smoother_get_flags</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162    <span class="keywordflow">return</span> s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a>;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="frame_8h.html#09a5cd2a31884ca0b106bf8308405fd8">00165</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#0230908765b8b00e779a2890b6a2cfe6">ast_smoother_set_flags</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> <a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a>)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167    s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a> = flags;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="frame_8h.html#b59ec8d712f306e04bd1d30671604c31">00170</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#b59ec8d712f306e04bd1d30671604c31">ast_smoother_test_flag</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keywordtype">int</span> flag)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172    <span class="keywordflow">return</span> (s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; flag);
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="frame_8h.html#209b60cf300744b0801010641094b92d">00175</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#209b60cf300744b0801010641094b92d">__ast_smoother_feed</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>, <span class="keywordtype">int</span> swap)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) {
<a name="l00178"></a>00178       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Huh?  Can't smooth a non-voice frame!\n"</span>);
<a name="l00179"></a>00179       <span class="keywordflow">return</span> -1;
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181    <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>) {
<a name="l00182"></a>00182       s-&gt;<a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00183"></a>00183       s-&gt;<a class="code" href="structast__smoother.html#7d6e203a822c06031004a99ca9fb3931">samplesperbyte</a> = (float)f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> / (<span class="keywordtype">float</span>)f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00184"></a>00184    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> != f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l00185"></a>00185       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Smoother was working on %d format frames, now trying to feed %d?\n"</span>, s-&gt;<a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l00186"></a>00186       <span class="keywordflow">return</span> -1;
<a name="l00187"></a>00187    }
<a name="l00188"></a>00188    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> + f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> &gt; <a class="code" href="frame_8c.html#4c4d677dbe54030f7b824011fda4c1f2">SMOOTHER_SIZE</a>) {
<a name="l00189"></a>00189       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Out of smoother space\n"</span>);
<a name="l00190"></a>00190       <span class="keywordflow">return</span> -1;
<a name="l00191"></a>00191    }
<a name="l00192"></a>00192    <span class="keywordflow">if</span> (((f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> == s-&gt;<a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a>) || ((f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> &lt; 10) &amp;&amp; (s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="frame_8h.html#7ae0c97d2c7012da804f40caaf047042">AST_SMOOTHER_FLAG_G729</a>)))
<a name="l00193"></a>00193              &amp;&amp; !s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a> &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> &gt;= <a class="code" href="frame_8h.html#c56e1e73a66ee18799fd111f7a5c1f42">AST_MIN_OFFSET</a>)) {
<a name="l00194"></a>00194       <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>) {
<a name="l00195"></a>00195          <span class="comment">/* Optimize by sending the frame we just got</span>
<a name="l00196"></a>00196 <span class="comment">            on the next read, thus eliminating the douple</span>
<a name="l00197"></a>00197 <span class="comment">            copy */</span>
<a name="l00198"></a>00198          <span class="keywordflow">if</span> (swap)
<a name="l00199"></a>00199             <a class="code" href="frame_8c.html#ca38e3c89b3ad46cd6b4c67dea7e6e48">ast_swapcopy_samples</a>(f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>);
<a name="l00200"></a>00200          s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a> = f;
<a name="l00201"></a>00201          <span class="keywordflow">return</span> 0;
<a name="l00202"></a>00202       } <span class="keywordflow">else</span> {
<a name="l00203"></a>00203          s-&gt;<a class="code" href="structast__smoother.html#d6b06cbbe0d4d2fd01839aba757812da">optimizablestream</a>++;
<a name="l00204"></a>00204          <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#d6b06cbbe0d4d2fd01839aba757812da">optimizablestream</a> &gt; 10) {
<a name="l00205"></a>00205             <span class="comment">/* For the past 10 rounds, we have input and output</span>
<a name="l00206"></a>00206 <span class="comment">               frames of the correct size for this smoother, yet</span>
<a name="l00207"></a>00207 <span class="comment">               we were unable to optimize because there was still</span>
<a name="l00208"></a>00208 <span class="comment">               some cruft left over.  Lets just drop the cruft so</span>
<a name="l00209"></a>00209 <span class="comment">               we can move to a fully optimized path */</span>
<a name="l00210"></a>00210             <span class="keywordflow">if</span> (swap)
<a name="l00211"></a>00211                <a class="code" href="frame_8c.html#ca38e3c89b3ad46cd6b4c67dea7e6e48">ast_swapcopy_samples</a>(f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>);
<a name="l00212"></a>00212             s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = 0;
<a name="l00213"></a>00213             s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a> = f;
<a name="l00214"></a>00214             <span class="keywordflow">return</span> 0;
<a name="l00215"></a>00215          }
<a name="l00216"></a>00216       }
<a name="l00217"></a>00217    } <span class="keywordflow">else</span> 
<a name="l00218"></a>00218       s-&gt;<a class="code" href="structast__smoother.html#d6b06cbbe0d4d2fd01839aba757812da">optimizablestream</a> = 0;
<a name="l00219"></a>00219    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="frame_8h.html#7ae0c97d2c7012da804f40caaf047042">AST_SMOOTHER_FLAG_G729</a>) {
<a name="l00220"></a>00220       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> % 10) {
<a name="l00221"></a>00221          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Dropping extra frame of G.729 since we already have a VAD frame at the end\n"</span>);
<a name="l00222"></a>00222          <span class="keywordflow">return</span> 0;
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224    }
<a name="l00225"></a>00225    <span class="keywordflow">if</span> (swap)
<a name="l00226"></a>00226       <a class="code" href="frame_8c.html#ca38e3c89b3ad46cd6b4c67dea7e6e48">ast_swapcopy_samples</a>(s-&gt;<a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a>+s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>);
<a name="l00227"></a>00227    <span class="keywordflow">else</span>
<a name="l00228"></a>00228       memcpy(s-&gt;<a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a> + s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l00229"></a>00229    <span class="comment">/* If either side is empty, reset the delivery time */</span>
<a name="l00230"></a>00230    <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> || ast_tvzero(f-&gt;<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>) || ast_tvzero(s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>))   <span class="comment">/* XXX really ? */</span>
<a name="l00231"></a>00231       s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a> = f-&gt;<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>;
<a name="l00232"></a>00232    s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> += f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00233"></a>00233    <span class="keywordflow">return</span> 0;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="frame_8h.html#c57cb003ea501fa13139aa90210fbcef">00236</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="frame_8c.html#c57cb003ea501fa13139aa90210fbcef">ast_smoother_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *opt;
<a name="l00239"></a>00239    <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="comment">/* IF we have an optimization frame, send it */</span>
<a name="l00242"></a>00242    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a>) {
<a name="l00243"></a>00243       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a>-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> &lt; <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>)
<a name="l00244"></a>00244          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Returning a frame of inappropriate offset (%d).\n"</span>,
<a name="l00245"></a>00245                      s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a>-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>);
<a name="l00246"></a>00246       opt = s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a>;
<a name="l00247"></a>00247       s-&gt;<a class="code" href="structast__smoother.html#4d29ea5f748c4cfda37434ce76a5e788">opt</a> = NULL;
<a name="l00248"></a>00248       <span class="keywordflow">return</span> opt;
<a name="l00249"></a>00249    }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251    <span class="comment">/* Make sure we have enough data */</span>
<a name="l00252"></a>00252    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> &lt; s-&gt;<a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a>) {
<a name="l00253"></a>00253       <span class="comment">/* Or, if this is a G.729 frame with VAD on it, send it immediately anyway */</span>
<a name="l00254"></a>00254       <span class="keywordflow">if</span> (!((s-&gt;<a class="code" href="structast__smoother.html#4e5868d676cb634aa75b125a0f741abf">flags</a> &amp; <a class="code" href="frame_8h.html#7ae0c97d2c7012da804f40caaf047042">AST_SMOOTHER_FLAG_G729</a>) &amp;&amp; (s-&gt;<a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a> % 10)))
<a name="l00255"></a>00255          <span class="keywordflow">return</span> NULL;
<a name="l00256"></a>00256    }
<a name="l00257"></a>00257    len = s-&gt;<a class="code" href="structast__smoother.html#f7bd60b75b29d79b660a2859395c1a24">size</a>;
<a name="l00258"></a>00258    <span class="keywordflow">if</span> (len &gt; s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)
<a name="l00259"></a>00259       len = s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00260"></a>00260    <span class="comment">/* Make frame */</span>
<a name="l00261"></a>00261    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>;
<a name="l00262"></a>00262    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = s-&gt;<a class="code" href="structast__smoother.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00263"></a>00263    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = s-&gt;<a class="code" href="structast__smoother.html#a2471faf0afccba62e896c7879c78f42">framedata</a> + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00264"></a>00264    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00265"></a>00265    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = len;
<a name="l00266"></a>00266    <span class="comment">/* Samples will be improper given VAD, but with VAD the concept really doesn't even exist */</span>
<a name="l00267"></a>00267    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> = len * s-&gt;<a class="code" href="structast__smoother.html#7d6e203a822c06031004a99ca9fb3931">samplesperbyte</a>;   <span class="comment">/* XXX rounding */</span>
<a name="l00268"></a>00268    s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a> = s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>;
<a name="l00269"></a>00269    <span class="comment">/* Fill Data */</span>
<a name="l00270"></a>00270    memcpy(s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, s-&gt;<a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a>, len);
<a name="l00271"></a>00271    s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> -= len;
<a name="l00272"></a>00272    <span class="comment">/* Move remaining data to the front if applicable */</span>
<a name="l00273"></a>00273    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>) {
<a name="l00274"></a>00274       <span class="comment">/* In principle this should all be fine because if we are sending</span>
<a name="l00275"></a>00275 <span class="comment">         G.729 VAD, the next timestamp will take over anyawy */</span>
<a name="l00276"></a>00276       memmove(s-&gt;<a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a>, s-&gt;<a class="code" href="structast__smoother.html#a01814d3c0fd9b0b7ad068bdfa233645">data</a> + len, s-&gt;<a class="code" href="structast__smoother.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>);
<a name="l00277"></a>00277       <span class="keywordflow">if</span> (!ast_tvzero(s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>)) {
<a name="l00278"></a>00278          <span class="comment">/* If we have delivery time, increment it, otherwise, leave it at 0 */</span>
<a name="l00279"></a>00279          s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a> = <a class="code" href="utils_8c.html#f3d6e948bdc914615d61b50418162c81">ast_tvadd</a>(s-&gt;<a class="code" href="structast__smoother.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>, ast_samp2tv(s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>.<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>, 8000));
<a name="l00280"></a>00280       }
<a name="l00281"></a>00281    }
<a name="l00282"></a>00282    <span class="comment">/* Return frame */</span>
<a name="l00283"></a>00283    <span class="keywordflow">return</span> &amp;s-&gt;<a class="code" href="structast__smoother.html#8fa14cdd754f91cc6554c9e71929cce7">f</a>;
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="frame_8h.html#6933f1f7df532d61fa64417a0697a62a">00286</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#6933f1f7df532d61fa64417a0697a62a">ast_smoother_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(s);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="frame_8c.html#f18aa7bb49bcd182a4e6d1629fda1cf5">00291</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="frame_8c.html#f18aa7bb49bcd182a4e6d1629fda1cf5">ast_frame_header_new</a>(<span class="keywordtype">void</span>)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structast__frame__cache.html">ast_frame_cache</a> *<a class="code" href="iax2-parser_8c.html#dcdc1ac079a91d513a5a759b0fb9c1dc">frames</a>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    <span class="keywordflow">if</span> ((frames = ast_threadstorage_get(&amp;frame_cache, <span class="keyword">sizeof</span>(*frames)))) {
<a name="l00299"></a>00299       <span class="keywordflow">if</span> ((f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;frames-&gt;list, frame_list))) {
<a name="l00300"></a>00300          size_t mallocd_len = f-&gt;<a class="code" href="structast__frame.html#3a8d0b14f2c3d81531d25e8f120fff7e">mallocd_hdr_len</a>;
<a name="l00301"></a>00301          memset(f, 0, <span class="keyword">sizeof</span>(*f));
<a name="l00302"></a>00302          f-&gt;mallocd_hdr_len = mallocd_len;
<a name="l00303"></a>00303          f-&gt;mallocd = <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a>;
<a name="l00304"></a>00304          frames-&gt;size--;
<a name="l00305"></a>00305          <span class="keywordflow">return</span> f;
<a name="l00306"></a>00306       }
<a name="l00307"></a>00307    }
<a name="l00308"></a>00308    <span class="keywordflow">if</span> (!(f = <a class="code" href="astmm_8h.html#40acdc5114070a39e9f9a157dd7bb3c3">ast_calloc_cache</a>(1, <span class="keyword">sizeof</span>(*f))))
<a name="l00309"></a>00309       <span class="keywordflow">return</span> NULL;
<a name="l00310"></a>00310 <span class="preprocessor">#else</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!(f = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*f))))
<a name="l00312"></a>00312       <span class="keywordflow">return</span> NULL;
<a name="l00313"></a>00313 <span class="preprocessor">#endif</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>
<a name="l00315"></a>00315    f-&gt;mallocd_hdr_len = <span class="keyword">sizeof</span>(*f);
<a name="l00316"></a>00316 <span class="preprocessor">#ifdef TRACE_FRAMES</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>   <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;headerlist);
<a name="l00318"></a>00318    headers++;
<a name="l00319"></a>00319    <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;headerlist, f, frame_list);
<a name="l00320"></a>00320    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;headerlist);
<a name="l00321"></a>00321 <span class="preprocessor">#endif   </span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>   
<a name="l00323"></a>00323    <span class="keywordflow">return</span> f;
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00327"></a><a class="code" href="frame_8c.html#7a96c29c7d892ca58f4a909c24d439ae">00327</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#7a96c29c7d892ca58f4a909c24d439ae">frame_cache_cleanup</a>(<span class="keywordtype">void</span> *data)
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329    <span class="keyword">struct </span><a class="code" href="structast__frame__cache.html">ast_frame_cache</a> *<a class="code" href="iax2-parser_8c.html#dcdc1ac079a91d513a5a759b0fb9c1dc">frames</a> = data;
<a name="l00330"></a>00330    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <span class="keywordflow">while</span> ((f = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;frames-&gt;<a class="code" href="structast__frame__cache.html#10ae9fc7d453b0dd525d0edf2ede7961">list</a>, frame_list)))
<a name="l00333"></a>00333       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(f);
<a name="l00334"></a>00334    
<a name="l00335"></a>00335    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(frames);
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 <span class="preprocessor">#endif</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>
<a name="l00339"></a><a class="code" href="frame_8h.html#d7b97c92bb20dfea00aa12e7ecbeac89">00339</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#d7b97c92bb20dfea00aa12e7ecbeac89">ast_frame_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr, <span class="keywordtype">int</span> cache)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341    <span class="keywordflow">if</span> (!fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a>)
<a name="l00342"></a>00342       <span class="keywordflow">return</span>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (cache &amp;&amp; fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> == <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a>) {
<a name="l00346"></a>00346       <span class="comment">/* Cool, only the header is malloc'd, let's just cache those for now </span>
<a name="l00347"></a>00347 <span class="comment">       * to keep things simple... */</span>
<a name="l00348"></a>00348       <span class="keyword">struct </span><a class="code" href="structast__frame__cache.html">ast_frame_cache</a> *<a class="code" href="iax2-parser_8c.html#dcdc1ac079a91d513a5a759b0fb9c1dc">frames</a>;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       <span class="keywordflow">if</span> ((frames = ast_threadstorage_get(&amp;frame_cache, <span class="keyword">sizeof</span>(*frames))) 
<a name="l00351"></a>00351           &amp;&amp; frames-&gt;size &lt; <a class="code" href="frame_8c.html#87e971d790bebfcf27c6924d2a541962">FRAME_CACHE_MAX_SIZE</a>) {
<a name="l00352"></a>00352          <a class="code" href="linkedlists_8h.html#5df56040a8838bdc841ef8eb179b7609">AST_LIST_INSERT_HEAD</a>(&amp;frames-&gt;list, fr, frame_list);
<a name="l00353"></a>00353          frames-&gt;size++;
<a name="l00354"></a>00354          <span class="keywordflow">return</span>;
<a name="l00355"></a>00355       }
<a name="l00356"></a>00356    }
<a name="l00357"></a>00357 <span class="preprocessor">#endif</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>   
<a name="l00359"></a>00359    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#8cd7ea973e577911ae6e6ca3a106d6f9">AST_MALLOCD_DATA</a>) {
<a name="l00360"></a>00360       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>) 
<a name="l00361"></a>00361          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> - fr-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>);
<a name="l00362"></a>00362    }
<a name="l00363"></a>00363    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#9731628346dabba4a94b98f9a2d56ca3">AST_MALLOCD_SRC</a>) {
<a name="l00364"></a>00364       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>)
<a name="l00365"></a>00365          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">char</span> *)fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>);
<a name="l00366"></a>00366    }
<a name="l00367"></a>00367    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a>) {
<a name="l00368"></a>00368 <span class="preprocessor">#ifdef TRACE_FRAMES</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>      <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;headerlist);
<a name="l00370"></a>00370       headers--;
<a name="l00371"></a>00371       <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;headerlist, fr, frame_list);
<a name="l00372"></a>00372       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;headerlist);
<a name="l00373"></a>00373 <span class="preprocessor">#endif         </span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>      <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(fr);
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 <span class="comment"></span>
<a name="l00378"></a>00378 <span class="comment">/*!</span>
<a name="l00379"></a>00379 <span class="comment"> * \brief 'isolates' a frame by duplicating non-malloc'ed components</span>
<a name="l00380"></a>00380 <span class="comment"> * (header, src, data).</span>
<a name="l00381"></a>00381 <span class="comment"> * On return all components are malloc'ed</span>
<a name="l00382"></a>00382 <span class="comment"> */</span>
<a name="l00383"></a><a class="code" href="frame_8h.html#da06615ce64c8ef3ae0d652d53ac8454">00383</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="frame_8c.html#da06615ce64c8ef3ae0d652d53ac8454">ast_frisolate</a>(<span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *fr)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *out;
<a name="l00386"></a>00386    <span class="keywordtype">void</span> *newdata;
<a name="l00387"></a>00387    
<a name="l00388"></a>00388    <span class="keywordflow">if</span> (!(fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a>)) {
<a name="l00389"></a>00389       <span class="comment">/* Allocate a new header if needed */</span>
<a name="l00390"></a>00390       <span class="keywordflow">if</span> (!(out = <a class="code" href="frame_8c.html#f18aa7bb49bcd182a4e6d1629fda1cf5">ast_frame_header_new</a>()))
<a name="l00391"></a>00391          <span class="keywordflow">return</span> NULL;
<a name="l00392"></a>00392       out-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = fr-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>;
<a name="l00393"></a>00393       out-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = fr-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00394"></a>00394       out-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00395"></a>00395       out-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> = fr-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l00396"></a>00396       out-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = fr-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a>;
<a name="l00397"></a>00397       out-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l00398"></a>00398       <span class="comment">/* Copy the timing data */</span>
<a name="l00399"></a>00399       out-&gt;<a class="code" href="structast__frame.html#138bb3d6497bbfe1604b93aef03d5f09">has_timing_info</a> = fr-&gt;<a class="code" href="structast__frame.html#138bb3d6497bbfe1604b93aef03d5f09">has_timing_info</a>;
<a name="l00400"></a>00400       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#138bb3d6497bbfe1604b93aef03d5f09">has_timing_info</a>) {
<a name="l00401"></a>00401          out-&gt;<a class="code" href="structast__frame.html#4d682ec4eed27c53849758bc13b6e179">ts</a> = fr-&gt;<a class="code" href="structast__frame.html#4d682ec4eed27c53849758bc13b6e179">ts</a>;
<a name="l00402"></a>00402          out-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = fr-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00403"></a>00403          out-&gt;<a class="code" href="structast__frame.html#d8d8c9e3082c9d3cc78d718b0d250891">seqno</a> = fr-&gt;<a class="code" href="structast__frame.html#d8d8c9e3082c9d3cc78d718b0d250891">seqno</a>;
<a name="l00404"></a>00404       }
<a name="l00405"></a>00405    } <span class="keywordflow">else</span>
<a name="l00406"></a>00406       out = fr;
<a name="l00407"></a>00407    
<a name="l00408"></a>00408    <span class="keywordflow">if</span> (!(fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#9731628346dabba4a94b98f9a2d56ca3">AST_MALLOCD_SRC</a>)) {
<a name="l00409"></a>00409       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>) {
<a name="l00410"></a>00410          <span class="keywordflow">if</span> (!(out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>))) {
<a name="l00411"></a>00411             <span class="keywordflow">if</span> (out != fr)
<a name="l00412"></a>00412                <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(out);
<a name="l00413"></a>00413             <span class="keywordflow">return</span> NULL;
<a name="l00414"></a>00414          }
<a name="l00415"></a>00415       }
<a name="l00416"></a>00416    } <span class="keywordflow">else</span>
<a name="l00417"></a>00417       out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> = fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>;
<a name="l00418"></a>00418    
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (!(fr-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> &amp; <a class="code" href="frame_8h.html#8cd7ea973e577911ae6e6ca3a106d6f9">AST_MALLOCD_DATA</a>))  {
<a name="l00420"></a>00420       <span class="keywordflow">if</span> (!(newdata = <a class="code" href="utils_8h.html#efc2f2f953e736b509e4a2cee96151db">ast_malloc</a>(fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>))) {
<a name="l00421"></a>00421          <span class="keywordflow">if</span> (out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> != fr-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>)
<a name="l00422"></a>00422             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>((<span class="keywordtype">void</span> *) out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>);
<a name="l00423"></a>00423          <span class="keywordflow">if</span> (out != fr)
<a name="l00424"></a>00424             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(out);
<a name="l00425"></a>00425          <span class="keywordflow">return</span> NULL;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427       newdata += <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00428"></a>00428       out-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00429"></a>00429       out-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00430"></a>00430       memcpy(newdata, fr-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, fr-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l00431"></a>00431       out-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = newdata;
<a name="l00432"></a>00432    }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    out-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> = <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a> | <a class="code" href="frame_8h.html#9731628346dabba4a94b98f9a2d56ca3">AST_MALLOCD_SRC</a> | <a class="code" href="frame_8h.html#8cd7ea973e577911ae6e6ca3a106d6f9">AST_MALLOCD_DATA</a>;
<a name="l00435"></a>00435    
<a name="l00436"></a>00436    <span class="keywordflow">return</span> out;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a><a class="code" href="frame_8h.html#4f4af8be0de3d5fa5e34300a8c16bf76">00439</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="frame_8c.html#e7f7f3d8f817e56bbaf43b0b1ecf8997">ast_frdup</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *out = NULL;
<a name="l00442"></a>00442    <span class="keywordtype">int</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>, srclen = 0;
<a name="l00443"></a>00443    <span class="keywordtype">void</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a> = NULL;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structast__frame__cache.html">ast_frame_cache</a> *<a class="code" href="iax2-parser_8c.html#dcdc1ac079a91d513a5a759b0fb9c1dc">frames</a>;
<a name="l00447"></a>00447 <span class="preprocessor">#endif</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>
<a name="l00449"></a>00449    <span class="comment">/* Start with standard stuff */</span>
<a name="l00450"></a>00450    len = <span class="keyword">sizeof</span>(*out) + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a> + f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00451"></a>00451    <span class="comment">/* If we have a source, add space for it */</span>
<a name="l00452"></a>00452    <span class="comment">/*</span>
<a name="l00453"></a>00453 <span class="comment">    * XXX Watch out here - if we receive a src which is not terminated</span>
<a name="l00454"></a>00454 <span class="comment">    * properly, we can be easily attacked. Should limit the size we deal with.</span>
<a name="l00455"></a>00455 <span class="comment">    */</span>
<a name="l00456"></a>00456    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>)
<a name="l00457"></a>00457       srclen = strlen(f-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>);
<a name="l00458"></a>00458    <span class="keywordflow">if</span> (srclen &gt; 0)
<a name="l00459"></a>00459       len += srclen + 1;
<a name="l00460"></a>00460    
<a name="l00461"></a>00461 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00462"></a>00462 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((frames = ast_threadstorage_get(&amp;frame_cache, <span class="keyword">sizeof</span>(*frames)))) {
<a name="l00463"></a>00463       <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;frames-&gt;list, out, frame_list) {
<a name="l00464"></a>00464          <span class="keywordflow">if</span> (out-&gt;<a class="code" href="structast__frame.html#3a8d0b14f2c3d81531d25e8f120fff7e">mallocd_hdr_len</a> &gt;= len) {
<a name="l00465"></a>00465             size_t mallocd_len = out-&gt;<a class="code" href="structast__frame.html#3a8d0b14f2c3d81531d25e8f120fff7e">mallocd_hdr_len</a>;
<a name="l00466"></a>00466             <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;frames-&gt;list, frame_list);
<a name="l00467"></a>00467             memset(out, 0, <span class="keyword">sizeof</span>(*out));
<a name="l00468"></a>00468             out-&gt;mallocd_hdr_len = mallocd_len;
<a name="l00469"></a>00469             buf = out;
<a name="l00470"></a>00470             frames-&gt;size--;
<a name="l00471"></a>00471             <span class="keywordflow">break</span>;
<a name="l00472"></a>00472          }
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474       <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l00475"></a>00475    }
<a name="l00476"></a>00476 <span class="preprocessor">#endif</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span>
<a name="l00478"></a>00478    <span class="keywordflow">if</span> (!buf) {
<a name="l00479"></a>00479       <span class="keywordflow">if</span> (!(buf = <a class="code" href="astmm_8h.html#40acdc5114070a39e9f9a157dd7bb3c3">ast_calloc_cache</a>(1, len)))
<a name="l00480"></a>00480          <span class="keywordflow">return</span> NULL;
<a name="l00481"></a>00481       out = buf;
<a name="l00482"></a>00482       out-&gt;<a class="code" href="structast__frame.html#3a8d0b14f2c3d81531d25e8f120fff7e">mallocd_hdr_len</a> = len;
<a name="l00483"></a>00483    }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    out-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> = f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>;
<a name="l00486"></a>00486    out-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00487"></a>00487    out-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> = f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00488"></a>00488    out-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> = f-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>;
<a name="l00489"></a>00489    out-&gt;<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a> = f-&gt;<a class="code" href="structast__frame.html#7108537956afa2a526f96cc9da7b0c36">delivery</a>;
<a name="l00490"></a>00490    <span class="comment">/* Set us as having malloc'd header only, so it will eventually</span>
<a name="l00491"></a>00491 <span class="comment">      get freed. */</span>
<a name="l00492"></a>00492    out-&gt;<a class="code" href="structast__frame.html#21ad8fb6783b76b648f5178a208fb3d4">mallocd</a> = <a class="code" href="frame_8h.html#df4f73015193c13b65bda224d8c683f8">AST_MALLOCD_HDR</a>;
<a name="l00493"></a>00493    out-&gt;<a class="code" href="structast__frame.html#7a86c157ee9713c34fbd7a1ee40f0c5a">offset</a> = <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00494"></a>00494    <span class="keywordflow">if</span> (out-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>) {
<a name="l00495"></a>00495       out-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a> = buf + <span class="keyword">sizeof</span>(*out) + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a>;
<a name="l00496"></a>00496       memcpy(out-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, out-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>); 
<a name="l00497"></a>00497    }
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (srclen &gt; 0) {
<a name="l00499"></a>00499       out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> = buf + <span class="keyword">sizeof</span>(*out) + <a class="code" href="frame_8h.html#2d81423482d14a11460b216109864d5b">AST_FRIENDLY_OFFSET</a> + f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l00500"></a>00500       <span class="comment">/* Must have space since we allocated for it */</span>
<a name="l00501"></a>00501       strcpy((<span class="keywordtype">char</span> *)out-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>, f-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a>);
<a name="l00502"></a>00502    }
<a name="l00503"></a>00503    out-&gt;<a class="code" href="structast__frame.html#138bb3d6497bbfe1604b93aef03d5f09">has_timing_info</a> = f-&gt;<a class="code" href="structast__frame.html#138bb3d6497bbfe1604b93aef03d5f09">has_timing_info</a>;
<a name="l00504"></a>00504    out-&gt;<a class="code" href="structast__frame.html#4d682ec4eed27c53849758bc13b6e179">ts</a> = f-&gt;<a class="code" href="structast__frame.html#4d682ec4eed27c53849758bc13b6e179">ts</a>;
<a name="l00505"></a>00505    out-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a> = f-&gt;<a class="code" href="structast__frame.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00506"></a>00506    out-&gt;<a class="code" href="structast__frame.html#d8d8c9e3082c9d3cc78d718b0d250891">seqno</a> = f-&gt;<a class="code" href="structast__frame.html#d8d8c9e3082c9d3cc78d718b0d250891">seqno</a>;
<a name="l00507"></a>00507    <span class="keywordflow">return</span> out;
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00510"></a><a class="code" href="frame_8h.html#ca38e3c89b3ad46cd6b4c67dea7e6e48">00510</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#ca38e3c89b3ad46cd6b4c67dea7e6e48">ast_swapcopy_samples</a>(<span class="keywordtype">void</span> *dst, <span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">int</span> samples)
<a name="l00511"></a>00511 {
<a name="l00512"></a>00512    <span class="keywordtype">int</span> i;
<a name="l00513"></a>00513    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *dst_s = dst;
<a name="l00514"></a>00514    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *src_s = src;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516    <span class="keywordflow">for</span> (i = 0; i &lt; samples; i++)
<a name="l00517"></a>00517       dst_s[i] = (src_s[i]&lt;&lt;8) | (src_s[i]&gt;&gt;8);
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 
<a name="l00521"></a><a class="code" href="frame_8h.html#ede8db51d1dcb25109ed01739ae8b144">00521</a> <span class="keyword">struct </span><a class="code" href="structast__format__list.html">ast_format_list</a> *<a class="code" href="frame_8c.html#ede8db51d1dcb25109ed01739ae8b144">ast_get_format_list_index</a>(<span class="keywordtype">int</span> index) 
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523    <span class="keywordflow">return</span> &amp;AST_FORMAT_LIST[index];
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="frame_8h.html#b54cb1a4969ea1b764d3e620f8a02b40">00526</a> <span class="keyword">struct </span><a class="code" href="structast__format__list.html">ast_format_list</a> *<a class="code" href="frame_8c.html#b54cb1a4969ea1b764d3e620f8a02b40">ast_get_format_list</a>(size_t *size) 
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528    *size = (<span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]));
<a name="l00529"></a>00529    <span class="keywordflow">return</span> AST_FORMAT_LIST;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="frame_8h.html#fc9ce4e422290b7bda33cc8685094a97">00532</a> <span class="keywordtype">char</span>* <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(<span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>)
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534    <span class="keywordtype">int</span> x;
<a name="l00535"></a>00535    <span class="keywordtype">char</span> *ret = <span class="stringliteral">"unknown"</span>;
<a name="l00536"></a>00536    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#46cf0e59759c9b7f1112ca4b174343ef">visible</a> &amp;&amp; AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#cc411e6c13670e52124629b8ac83f7d0">bits</a> == format) {
<a name="l00538"></a>00538          ret = AST_FORMAT_LIST[x].name;
<a name="l00539"></a>00539          <span class="keywordflow">break</span>;
<a name="l00540"></a>00540       }
<a name="l00541"></a>00541    }
<a name="l00542"></a>00542    <span class="keywordflow">return</span> ret;
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="frame_8h.html#98f2e5f4c4b2d13cb63057889cc0b743">00545</a> <span class="keywordtype">char</span> *<a class="code" href="frame_8c.html#98f2e5f4c4b2d13cb63057889cc0b743">ast_getformatname_multiple</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, size_t size, <span class="keywordtype">int</span> format)
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547    <span class="keywordtype">int</span> x;
<a name="l00548"></a>00548    <span class="keywordtype">unsigned</span> <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>;
<a name="l00549"></a>00549    <span class="keywordtype">char</span> *start, *end = buf;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551    <span class="keywordflow">if</span> (!size)
<a name="l00552"></a>00552       <span class="keywordflow">return</span> buf;
<a name="l00553"></a>00553    snprintf(end, size, <span class="stringliteral">"0x%x ("</span>, format);
<a name="l00554"></a>00554    len = strlen(end);
<a name="l00555"></a>00555    end += len;
<a name="l00556"></a>00556    size -= len;
<a name="l00557"></a>00557    start = end;
<a name="l00558"></a>00558    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l00559"></a>00559       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#46cf0e59759c9b7f1112ca4b174343ef">visible</a> &amp;&amp; (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#cc411e6c13670e52124629b8ac83f7d0">bits</a> &amp; format)) {
<a name="l00560"></a>00560          snprintf(end, size,<span class="stringliteral">"%s|"</span>,AST_FORMAT_LIST[x].<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l00561"></a>00561          len = strlen(end);
<a name="l00562"></a>00562          end += len;
<a name="l00563"></a>00563          size -= len;
<a name="l00564"></a>00564       }
<a name="l00565"></a>00565    }
<a name="l00566"></a>00566    <span class="keywordflow">if</span> (start == end)
<a name="l00567"></a>00567       snprintf(start, size, <span class="stringliteral">"nothing)"</span>);
<a name="l00568"></a>00568    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size &gt; 1)
<a name="l00569"></a>00569       *(end -1) = <span class="charliteral">')'</span>;
<a name="l00570"></a>00570    <span class="keywordflow">return</span> buf;
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00573"></a><a class="code" href="structast__codec__alias__table.html">00573</a> <span class="keyword">static</span> <span class="keyword">struct</span> <a class="code" href="structast__codec__alias__table.html">ast_codec_alias_table</a> {
<a name="l00574"></a><a class="code" href="structast__codec__alias__table.html#724874d1be77f450a09b305fc1534afb">00574</a>    <span class="keywordtype">char</span> *alias;
<a name="l00575"></a><a class="code" href="structast__codec__alias__table.html#b9829befcf2ab1c17637b03b1d6e34f2">00575</a>    <span class="keywordtype">char</span> *realname;
<a name="l00576"></a>00576 } <a class="code" href="structast__codec__alias__table.html">ast_codec_alias_table</a>[] = {
<a name="l00577"></a>00577    { <span class="stringliteral">"slinear"</span>, <span class="stringliteral">"slin"</span>},
<a name="l00578"></a>00578    { <span class="stringliteral">"g723.1"</span>, <span class="stringliteral">"g723"</span>},
<a name="l00579"></a>00579 };
<a name="l00580"></a>00580 
<a name="l00581"></a><a class="code" href="frame_8c.html#75ec6d6e8eddcf15a52ed724a05bbe44">00581</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="frame_8c.html#75ec6d6e8eddcf15a52ed724a05bbe44">ast_expand_codec_alias</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *in)
<a name="l00582"></a>00582 {
<a name="l00583"></a>00583    <span class="keywordtype">int</span> x;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(<a class="code" href="structast__codec__alias__table.html">ast_codec_alias_table</a>) / <span class="keyword">sizeof</span>(ast_codec_alias_table[0]); x++) {
<a name="l00586"></a>00586       <span class="keywordflow">if</span> (!strcmp(in,ast_codec_alias_table[x].alias))
<a name="l00587"></a>00587          <span class="keywordflow">return</span> ast_codec_alias_table[x].realname;
<a name="l00588"></a>00588    }
<a name="l00589"></a>00589    <span class="keywordflow">return</span> in;
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="frame_8h.html#489f45519671fcf4964f385f4de2c689">00592</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#489f45519671fcf4964f385f4de2c689">ast_getformatbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594    <span class="keywordtype">int</span> x, all, format = 0;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    all = strcasecmp(name, <span class="stringliteral">"all"</span>) ? 0 : 1;
<a name="l00597"></a>00597    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l00598"></a>00598       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#46cf0e59759c9b7f1112ca4b174343ef">visible</a> &amp;&amp; (all || 
<a name="l00599"></a>00599            !strcasecmp(AST_FORMAT_LIST[x].name,name) ||
<a name="l00600"></a>00600            !strcasecmp(AST_FORMAT_LIST[x].name,<a class="code" href="frame_8c.html#75ec6d6e8eddcf15a52ed724a05bbe44">ast_expand_codec_alias</a>(name)))) {
<a name="l00601"></a>00601          format |= AST_FORMAT_LIST[x].bits;
<a name="l00602"></a>00602          <span class="keywordflow">if</span> (!all)
<a name="l00603"></a>00603             <span class="keywordflow">break</span>;
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605    }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607    <span class="keywordflow">return</span> format;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="frame_8h.html#c6ebfc9b1154b96db80bfca7651d2ca8">00610</a> <span class="keywordtype">char</span> *<a class="code" href="frame_8c.html#c6ebfc9b1154b96db80bfca7651d2ca8">ast_codec2str</a>(<span class="keywordtype">int</span> codec)
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612    <span class="keywordtype">int</span> x;
<a name="l00613"></a>00613    <span class="keywordtype">char</span> *ret = <span class="stringliteral">"unknown"</span>;
<a name="l00614"></a>00614    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l00615"></a>00615       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#46cf0e59759c9b7f1112ca4b174343ef">visible</a> &amp;&amp; AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#cc411e6c13670e52124629b8ac83f7d0">bits</a> == codec) {
<a name="l00616"></a>00616          ret = AST_FORMAT_LIST[x].desc;
<a name="l00617"></a>00617          <span class="keywordflow">break</span>;
<a name="l00618"></a>00618       }
<a name="l00619"></a>00619    }
<a name="l00620"></a>00620    <span class="keywordflow">return</span> ret;
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">00623</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">show_codecs</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625    <span class="keywordtype">int</span> i, found=0;
<a name="l00626"></a>00626    <span class="keywordtype">char</span> hex[25];
<a name="l00627"></a>00627    
<a name="l00628"></a>00628    <span class="keywordflow">if</span> ((argc &lt; 3) || (argc &gt; 4))
<a name="l00629"></a>00629       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631    <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#abfc77dbf0c5fceef45b463225f9df6b">ast_opt_dont_warn</a>)
<a name="l00632"></a>00632       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Disclaimer: this command is for informational purposes only.\n"</span>
<a name="l00633"></a>00633             <span class="stringliteral">"\tIt does not indicate anything about your configuration.\n"</span>);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%11s %9s %10s   TYPE   %8s   %s\n"</span>,<span class="stringliteral">"INT"</span>,<span class="stringliteral">"BINARY"</span>,<span class="stringliteral">"HEX"</span>,<span class="stringliteral">"NAME"</span>,<span class="stringliteral">"DESC"</span>);
<a name="l00636"></a>00636    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"--------------------------------------------------------------------------------\n"</span>);
<a name="l00637"></a>00637    <span class="keywordflow">if</span> ((argc == 3) || (!strcasecmp(argv[3],<span class="stringliteral">"audio"</span>))) {
<a name="l00638"></a>00638       found = 1;
<a name="l00639"></a>00639       <span class="keywordflow">for</span> (i=0;i&lt;13;i++) {
<a name="l00640"></a>00640          snprintf(hex,25,<span class="stringliteral">"(0x%x)"</span>,1&lt;&lt;i);
<a name="l00641"></a>00641          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%11u (1 &lt;&lt; %2d) %10s  audio   %8s   (%s)\n"</span>,1 &lt;&lt; i,i,hex,<a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(1&lt;&lt;i),<a class="code" href="frame_8c.html#c6ebfc9b1154b96db80bfca7651d2ca8">ast_codec2str</a>(1&lt;&lt;i));
<a name="l00642"></a>00642       }
<a name="l00643"></a>00643    }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645    <span class="keywordflow">if</span> ((argc == 3) || (!strcasecmp(argv[3],<span class="stringliteral">"image"</span>))) {
<a name="l00646"></a>00646       found = 1;
<a name="l00647"></a>00647       <span class="keywordflow">for</span> (i=16;i&lt;18;i++) {
<a name="l00648"></a>00648          snprintf(hex,25,<span class="stringliteral">"(0x%x)"</span>,1&lt;&lt;i);
<a name="l00649"></a>00649          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%11u (1 &lt;&lt; %2d) %10s  image   %8s   (%s)\n"</span>,1 &lt;&lt; i,i,hex,<a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(1&lt;&lt;i),<a class="code" href="frame_8c.html#c6ebfc9b1154b96db80bfca7651d2ca8">ast_codec2str</a>(1&lt;&lt;i));
<a name="l00650"></a>00650       }
<a name="l00651"></a>00651    }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653    <span class="keywordflow">if</span> ((argc == 3) || (!strcasecmp(argv[3],<span class="stringliteral">"video"</span>))) {
<a name="l00654"></a>00654       found = 1;
<a name="l00655"></a>00655       <span class="keywordflow">for</span> (i=18;i&lt;22;i++) {
<a name="l00656"></a>00656          snprintf(hex,25,<span class="stringliteral">"(0x%x)"</span>,1&lt;&lt;i);
<a name="l00657"></a>00657          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%11u (1 &lt;&lt; %2d) %10s  video   %8s   (%s)\n"</span>,1 &lt;&lt; i,i,hex,<a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(1&lt;&lt;i),<a class="code" href="frame_8c.html#c6ebfc9b1154b96db80bfca7651d2ca8">ast_codec2str</a>(1&lt;&lt;i));
<a name="l00658"></a>00658       }
<a name="l00659"></a>00659    }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661    <span class="keywordflow">if</span> (! found)
<a name="l00662"></a>00662       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00663"></a>00663    <span class="keywordflow">else</span>
<a name="l00664"></a>00664       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a><a class="code" href="frame_8c.html#07f9839f4feb5d34ab77c0f0bf3aec91">00667</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="frame_8c.html#07f9839f4feb5d34ab77c0f0bf3aec91">frame_show_codecs_usage</a>[] =
<a name="l00668"></a>00668 <span class="stringliteral">"Usage: core show codecs [audio|video|image]\n"</span>
<a name="l00669"></a>00669 <span class="stringliteral">"       Displays codec mapping\n"</span>;
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="frame_8c.html#bc9aa704fb93e336d7117d6074dcee68">00671</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#bc9aa704fb93e336d7117d6074dcee68">show_codec_n</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673    <span class="keywordtype">int</span> codec, i, found=0;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (argc != 4)
<a name="l00676"></a>00676       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678    <span class="keywordflow">if</span> (sscanf(argv[3],<span class="stringliteral">"%d"</span>,&amp;codec) != 1)
<a name="l00679"></a>00679       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    <span class="keywordflow">for</span> (i = 0; i &lt; 32; i++)
<a name="l00682"></a>00682       <span class="keywordflow">if</span> (codec &amp; (1 &lt;&lt; i)) {
<a name="l00683"></a>00683          found = 1;
<a name="l00684"></a>00684          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"%11u (1 &lt;&lt; %2d)  %s\n"</span>,1 &lt;&lt; i,i,<a class="code" href="frame_8c.html#c6ebfc9b1154b96db80bfca7651d2ca8">ast_codec2str</a>(1&lt;&lt;i));
<a name="l00685"></a>00685       }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687    <span class="keywordflow">if</span> (!found)
<a name="l00688"></a>00688       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Codec %d not found\n"</span>, codec);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="frame_8c.html#7a20af2ff721b3902e35e2c28f79931d">00693</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="frame_8c.html#7a20af2ff721b3902e35e2c28f79931d">frame_show_codec_n_usage</a>[] =
<a name="l00694"></a>00694 <span class="stringliteral">"Usage: core show codec &lt;number&gt;\n"</span>
<a name="l00695"></a>00695 <span class="stringliteral">"       Displays codec mapping\n"</span>;
<a name="l00696"></a>00696 <span class="comment"></span>
<a name="l00697"></a>00697 <span class="comment">/*! Dump a frame for debugging purposes */</span>
<a name="l00698"></a><a class="code" href="frame_8h.html#11dff4ae984427c6c3511b38359fe34a">00698</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#11dff4ae984427c6c3511b38359fe34a">ast_frame_dump</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#93583f8993b24e7afddf9578925bd1d8">prefix</a>)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700    <span class="keyword">const</span> <span class="keywordtype">char</span> noname[] = <span class="stringliteral">"unknown"</span>;
<a name="l00701"></a>00701    <span class="keywordtype">char</span> ftype[40] = <span class="stringliteral">"Unknown Frametype"</span>;
<a name="l00702"></a>00702    <span class="keywordtype">char</span> cft[80];
<a name="l00703"></a>00703    <span class="keywordtype">char</span> subclass[40] = <span class="stringliteral">"Unknown Subclass"</span>;
<a name="l00704"></a>00704    <span class="keywordtype">char</span> csub[80];
<a name="l00705"></a>00705    <span class="keywordtype">char</span> moreinfo[40] = <span class="stringliteral">""</span>;
<a name="l00706"></a>00706    <span class="keywordtype">char</span> cn[60];
<a name="l00707"></a>00707    <span class="keywordtype">char</span> cp[40];
<a name="l00708"></a>00708    <span class="keywordtype">char</span> cmn[40];
<a name="l00709"></a>00709 
<a name="l00710"></a>00710    <span class="keywordflow">if</span> (!name)
<a name="l00711"></a>00711       name = noname;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 
<a name="l00714"></a>00714    <span class="keywordflow">if</span> (!f) {
<a name="l00715"></a>00715       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"%s [ %s (NULL) ] [%s]\n"</span>, 
<a name="l00716"></a>00716          <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cp, prefix, <a class="code" href="term_8h.html#1aa594af665de225e032ba989d9b4472">COLOR_BRMAGENTA</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cp)),
<a name="l00717"></a>00717          <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cft, <span class="stringliteral">"HANGUP"</span>, <a class="code" href="term_8h.html#78836a2aadc2be182fa6c7a064810d6f">COLOR_BRRED</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cft)), 
<a name="l00718"></a>00718          <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cn, name, <a class="code" href="term_8h.html#dea6feda9ea7b5540bd1ad477a399c6f">COLOR_YELLOW</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cn)));
<a name="l00719"></a>00719       <span class="keywordflow">return</span>;
<a name="l00720"></a>00720    }
<a name="l00721"></a>00721    <span class="comment">/* XXX We should probably print one each of voice and video when the format changes XXX */</span>
<a name="l00722"></a>00722    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>)
<a name="l00723"></a>00723       <span class="keywordflow">return</span>;
<a name="l00724"></a>00724    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> == <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92f3104666df07b461099e43be37983393">AST_FRAME_VIDEO</a>)
<a name="l00725"></a>00725       <span class="keywordflow">return</span>;
<a name="l00726"></a>00726    <span class="keywordflow">switch</span>(f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>) {
<a name="l00727"></a>00727    <span class="keywordflow">case</span> AST_FRAME_DTMF_BEGIN:
<a name="l00728"></a>00728       strcpy(ftype, <span class="stringliteral">"DTMF Begin"</span>);
<a name="l00729"></a>00729       subclass[0] = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00730"></a>00730       subclass[1] = <span class="charliteral">'\0'</span>;
<a name="l00731"></a>00731       <span class="keywordflow">break</span>;
<a name="l00732"></a>00732    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927fc7453b6ac78761e7a4e46b3fcfa557">AST_FRAME_DTMF_END</a>:
<a name="l00733"></a>00733       strcpy(ftype, <span class="stringliteral">"DTMF End"</span>);
<a name="l00734"></a>00734       subclass[0] = f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>;
<a name="l00735"></a>00735       subclass[1] = <span class="charliteral">'\0'</span>;
<a name="l00736"></a>00736       <span class="keywordflow">break</span>;
<a name="l00737"></a>00737    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92d7fbcef5adafabe47c2e42258e4f019e">AST_FRAME_CONTROL</a>:
<a name="l00738"></a>00738       strcpy(ftype, <span class="stringliteral">"Control"</span>);
<a name="l00739"></a>00739       <span class="keywordflow">switch</span>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l00740"></a>00740       <span class="keywordflow">case</span> AST_CONTROL_HANGUP:
<a name="l00741"></a>00741          strcpy(subclass, <span class="stringliteral">"Hangup"</span>);
<a name="l00742"></a>00742          <span class="keywordflow">break</span>;
<a name="l00743"></a>00743       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f38963abb30bf566711b5ed8c9c64ac58f8e">AST_CONTROL_RING</a>:
<a name="l00744"></a>00744          strcpy(subclass, <span class="stringliteral">"Ring"</span>);
<a name="l00745"></a>00745          <span class="keywordflow">break</span>;
<a name="l00746"></a>00746       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3895749da867c771f2391b19ce9e08f0149">AST_CONTROL_RINGING</a>:
<a name="l00747"></a>00747          strcpy(subclass, <span class="stringliteral">"Ringing"</span>);
<a name="l00748"></a>00748          <span class="keywordflow">break</span>;
<a name="l00749"></a>00749       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389edaaffc26d24394cd2557ddb1db10f64">AST_CONTROL_ANSWER</a>:
<a name="l00750"></a>00750          strcpy(subclass, <span class="stringliteral">"Answer"</span>);
<a name="l00751"></a>00751          <span class="keywordflow">break</span>;
<a name="l00752"></a>00752       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3898c0ff5febeb7ff9d8880e2bc7f1d6ca1">AST_CONTROL_BUSY</a>:
<a name="l00753"></a>00753          strcpy(subclass, <span class="stringliteral">"Busy"</span>);
<a name="l00754"></a>00754          <span class="keywordflow">break</span>;
<a name="l00755"></a>00755       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3899c443151ff3f9c3801534eaaf6cdb1f9">AST_CONTROL_TAKEOFFHOOK</a>:
<a name="l00756"></a>00756          strcpy(subclass, <span class="stringliteral">"Take Off Hook"</span>);
<a name="l00757"></a>00757          <span class="keywordflow">break</span>;
<a name="l00758"></a>00758       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389dca4e33b1ad1492acbc6c1b05fd892dd">AST_CONTROL_OFFHOOK</a>:
<a name="l00759"></a>00759          strcpy(subclass, <span class="stringliteral">"Line Off Hook"</span>);
<a name="l00760"></a>00760          <span class="keywordflow">break</span>;
<a name="l00761"></a>00761       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389fafe5e503d0d74218854b57e66282419">AST_CONTROL_CONGESTION</a>:
<a name="l00762"></a>00762          strcpy(subclass, <span class="stringliteral">"Congestion"</span>);
<a name="l00763"></a>00763          <span class="keywordflow">break</span>;
<a name="l00764"></a>00764       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3899da5863316de5e07e562d773bb39e94a">AST_CONTROL_FLASH</a>:
<a name="l00765"></a>00765          strcpy(subclass, <span class="stringliteral">"Flash"</span>);
<a name="l00766"></a>00766          <span class="keywordflow">break</span>;
<a name="l00767"></a>00767       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f38908ddef6dbb9a89f543bc45b1d8e25368">AST_CONTROL_WINK</a>:
<a name="l00768"></a>00768          strcpy(subclass, <span class="stringliteral">"Wink"</span>);
<a name="l00769"></a>00769          <span class="keywordflow">break</span>;
<a name="l00770"></a>00770       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f389e18699f69d7f0d792d74b5a50732765f">AST_CONTROL_OPTION</a>:
<a name="l00771"></a>00771          strcpy(subclass, <span class="stringliteral">"Option"</span>);
<a name="l00772"></a>00772          <span class="keywordflow">break</span>;
<a name="l00773"></a>00773       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f38952daef298b8264b06a78e1782cff0d5f">AST_CONTROL_RADIO_KEY</a>:
<a name="l00774"></a>00774          strcpy(subclass, <span class="stringliteral">"Key Radio"</span>);
<a name="l00775"></a>00775          <span class="keywordflow">break</span>;
<a name="l00776"></a>00776       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2d127e187c7a98c4396c337f2d76f3897800219228c17aeb7b64ad99ba6c9537">AST_CONTROL_RADIO_UNKEY</a>:
<a name="l00777"></a>00777          strcpy(subclass, <span class="stringliteral">"Unkey Radio"</span>);
<a name="l00778"></a>00778          <span class="keywordflow">break</span>;
<a name="l00779"></a>00779       <span class="keywordflow">case</span> -1:
<a name="l00780"></a>00780          strcpy(subclass, <span class="stringliteral">"Stop generators"</span>);
<a name="l00781"></a>00781          <span class="keywordflow">break</span>;
<a name="l00782"></a>00782       <span class="keywordflow">default</span>:
<a name="l00783"></a>00783          snprintf(subclass, <span class="keyword">sizeof</span>(subclass), <span class="stringliteral">"Unknown control '%d'"</span>, f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>);
<a name="l00784"></a>00784       }
<a name="l00785"></a>00785       <span class="keywordflow">break</span>;
<a name="l00786"></a>00786    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92eaf38b643259d44fcc0a869ab36609b1">AST_FRAME_NULL</a>:
<a name="l00787"></a>00787       strcpy(ftype, <span class="stringliteral">"Null Frame"</span>);
<a name="l00788"></a>00788       strcpy(subclass, <span class="stringliteral">"N/A"</span>);
<a name="l00789"></a>00789       <span class="keywordflow">break</span>;
<a name="l00790"></a>00790    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92bf1d9c403ffb2c4b26845d97d1bce16e">AST_FRAME_IAX</a>:
<a name="l00791"></a>00791       <span class="comment">/* Should never happen */</span>
<a name="l00792"></a>00792       strcpy(ftype, <span class="stringliteral">"IAX Specific"</span>);
<a name="l00793"></a>00793       snprintf(subclass, <span class="keyword">sizeof</span>(subclass), <span class="stringliteral">"IAX Frametype %d"</span>, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass);
<a name="l00794"></a>00794       <span class="keywordflow">break</span>;
<a name="l00795"></a>00795    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92696800d27feca415d5c80113fb740f44">AST_FRAME_TEXT</a>:
<a name="l00796"></a>00796       strcpy(ftype, <span class="stringliteral">"Text"</span>);
<a name="l00797"></a>00797       strcpy(subclass, <span class="stringliteral">"N/A"</span>);
<a name="l00798"></a>00798       ast_copy_string(moreinfo, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;data, <span class="keyword">sizeof</span>(moreinfo));
<a name="l00799"></a>00799       <span class="keywordflow">break</span>;
<a name="l00800"></a>00800    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f927e5b7994ea6aabfce7d738e4c8278e1e">AST_FRAME_IMAGE</a>:
<a name="l00801"></a>00801       strcpy(ftype, <span class="stringliteral">"Image"</span>);
<a name="l00802"></a>00802       snprintf(subclass, <span class="keyword">sizeof</span>(subclass), <span class="stringliteral">"Image format %s\n"</span>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass));
<a name="l00803"></a>00803       <span class="keywordflow">break</span>;
<a name="l00804"></a>00804    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f92a9ac2233f0025ec1b3d23e720cee92be">AST_FRAME_HTML</a>:
<a name="l00805"></a>00805       strcpy(ftype, <span class="stringliteral">"HTML"</span>);
<a name="l00806"></a>00806       <span class="keywordflow">switch</span>(<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass) {
<a name="l00807"></a>00807       <span class="keywordflow">case</span> AST_HTML_URL:
<a name="l00808"></a>00808          strcpy(subclass, <span class="stringliteral">"URL"</span>);
<a name="l00809"></a>00809          ast_copy_string(moreinfo, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;data, <span class="keyword">sizeof</span>(moreinfo));
<a name="l00810"></a>00810          <span class="keywordflow">break</span>;
<a name="l00811"></a>00811       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#e579cf30d6c5f3a137da0ddf2686dcb2">AST_HTML_DATA</a>:
<a name="l00812"></a>00812          strcpy(subclass, <span class="stringliteral">"Data"</span>);
<a name="l00813"></a>00813          <span class="keywordflow">break</span>;
<a name="l00814"></a>00814       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#e9c27bfb1a657332e7bebe62ba8af8c9">AST_HTML_BEGIN</a>:
<a name="l00815"></a>00815          strcpy(subclass, <span class="stringliteral">"Begin"</span>);
<a name="l00816"></a>00816          <span class="keywordflow">break</span>;
<a name="l00817"></a>00817       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#738a26f4bd01de7b854f961a489da234">AST_HTML_END</a>:
<a name="l00818"></a>00818          strcpy(subclass, <span class="stringliteral">"End"</span>);
<a name="l00819"></a>00819          <span class="keywordflow">break</span>;
<a name="l00820"></a>00820       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#beae0923db0369c4cddff4b9d0a8ef5d">AST_HTML_LDCOMPLETE</a>:
<a name="l00821"></a>00821          strcpy(subclass, <span class="stringliteral">"Load Complete"</span>);
<a name="l00822"></a>00822          <span class="keywordflow">break</span>;
<a name="l00823"></a>00823       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#6157ac84bc5785739165bf75cb6b066d">AST_HTML_NOSUPPORT</a>:
<a name="l00824"></a>00824          strcpy(subclass, <span class="stringliteral">"No Support"</span>);
<a name="l00825"></a>00825          <span class="keywordflow">break</span>;
<a name="l00826"></a>00826       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2ef4d535e539e6a40d770f21f552815f">AST_HTML_LINKURL</a>:
<a name="l00827"></a>00827          strcpy(subclass, <span class="stringliteral">"Link URL"</span>);
<a name="l00828"></a>00828          ast_copy_string(moreinfo, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;data, <span class="keyword">sizeof</span>(moreinfo));
<a name="l00829"></a>00829          <span class="keywordflow">break</span>;
<a name="l00830"></a>00830       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#2e6faa061c057a4d0eaf31e1dcfd1140">AST_HTML_UNLINK</a>:
<a name="l00831"></a>00831          strcpy(subclass, <span class="stringliteral">"Unlink"</span>);
<a name="l00832"></a>00832          <span class="keywordflow">break</span>;
<a name="l00833"></a>00833       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#d85b1d44d8ecb029d8c3d9603ce2712e">AST_HTML_LINKREJECT</a>:
<a name="l00834"></a>00834          strcpy(subclass, <span class="stringliteral">"Link Reject"</span>);
<a name="l00835"></a>00835          <span class="keywordflow">break</span>;
<a name="l00836"></a>00836       <span class="keywordflow">default</span>:
<a name="l00837"></a>00837          snprintf(subclass, <span class="keyword">sizeof</span>(subclass), <span class="stringliteral">"Unknown HTML frame '%d'\n"</span>, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass);
<a name="l00838"></a>00838          <span class="keywordflow">break</span>;
<a name="l00839"></a>00839       }
<a name="l00840"></a>00840       <span class="keywordflow">break</span>;
<a name="l00841"></a>00841    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9258a9185f9370d3f1076917c963b0de50">AST_FRAME_MODEM</a>:
<a name="l00842"></a>00842       strcpy(ftype, <span class="stringliteral">"Modem"</span>);
<a name="l00843"></a>00843       <span class="keywordflow">switch</span> (<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass) {
<a name="l00844"></a>00844       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a79b4778f48da6e8e1df7ff28cb938bf">AST_MODEM_T38</a>:
<a name="l00845"></a>00845          strcpy(subclass, <span class="stringliteral">"T.38"</span>);
<a name="l00846"></a>00846          <span class="keywordflow">break</span>;
<a name="l00847"></a>00847       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#db920555b222d6ba3de6a15928327ea1">AST_MODEM_V150</a>:
<a name="l00848"></a>00848          strcpy(subclass, <span class="stringliteral">"V.150"</span>);
<a name="l00849"></a>00849          <span class="keywordflow">break</span>;
<a name="l00850"></a>00850       <span class="keywordflow">default</span>:
<a name="l00851"></a>00851          snprintf(subclass, <span class="keyword">sizeof</span>(subclass), <span class="stringliteral">"Unknown MODEM frame '%d'\n"</span>, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass);
<a name="l00852"></a>00852          <span class="keywordflow">break</span>;
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854       <span class="keywordflow">break</span>;
<a name="l00855"></a>00855    <span class="keywordflow">default</span>:
<a name="l00856"></a>00856       snprintf(ftype, <span class="keyword">sizeof</span>(ftype), <span class="stringliteral">"Unknown Frametype '%d'"</span>, <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype);
<a name="l00857"></a>00857    }
<a name="l00858"></a>00858    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(moreinfo))
<a name="l00859"></a>00859       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"%s [ TYPE: %s (%d) SUBCLASS: %s (%d) '%s' ] [%s]\n"</span>,  
<a name="l00860"></a>00860              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cp, <a class="code" href="http_8c.html#93583f8993b24e7afddf9578925bd1d8">prefix</a>, <a class="code" href="term_8h.html#1aa594af665de225e032ba989d9b4472">COLOR_BRMAGENTA</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cp)),
<a name="l00861"></a>00861              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cft, ftype, <a class="code" href="term_8h.html#78836a2aadc2be182fa6c7a064810d6f">COLOR_BRRED</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cft)),
<a name="l00862"></a>00862              <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype, 
<a name="l00863"></a>00863              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(csub, subclass, <a class="code" href="term_8h.html#ed35747ad832f24a4b7cf183cf619ad5">COLOR_BRCYAN</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(csub)),
<a name="l00864"></a>00864              <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass, 
<a name="l00865"></a>00865              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cmn, moreinfo, <a class="code" href="term_8h.html#c9a3ce6b9e40047633110f39c457ba52">COLOR_BRGREEN</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cmn)),
<a name="l00866"></a>00866              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cn, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="term_8h.html#dea6feda9ea7b5540bd1ad477a399c6f">COLOR_YELLOW</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cn)));
<a name="l00867"></a>00867    <span class="keywordflow">else</span>
<a name="l00868"></a>00868       <a class="code" href="logger_8c.html#6a1ef0a194bcc79fccfb662192954477">ast_verbose</a>(<span class="stringliteral">"%s [ TYPE: %s (%d) SUBCLASS: %s (%d) ] [%s]\n"</span>,  
<a name="l00869"></a>00869              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cp, <a class="code" href="http_8c.html#93583f8993b24e7afddf9578925bd1d8">prefix</a>, <a class="code" href="term_8h.html#1aa594af665de225e032ba989d9b4472">COLOR_BRMAGENTA</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cp)),
<a name="l00870"></a>00870              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cft, ftype, <a class="code" href="term_8h.html#78836a2aadc2be182fa6c7a064810d6f">COLOR_BRRED</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cft)),
<a name="l00871"></a>00871              <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;frametype, 
<a name="l00872"></a>00872              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(csub, subclass, <a class="code" href="term_8h.html#ed35747ad832f24a4b7cf183cf619ad5">COLOR_BRCYAN</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(csub)),
<a name="l00873"></a>00873              <a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>-&gt;subclass, 
<a name="l00874"></a>00874              <a class="code" href="term_8c.html#e93d6667c9a6823fef4ab75cd64c90ca">term_color</a>(cn, <a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="term_8h.html#dea6feda9ea7b5540bd1ad477a399c6f">COLOR_YELLOW</a>, <a class="code" href="term_8h.html#5e5cea0d4c88b925440f00651b538612">COLOR_BLACK</a>, <span class="keyword">sizeof</span>(cn)));
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 <span class="preprocessor">#ifdef TRACE_FRAMES</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> show_frame_stats(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00880"></a>00880 {
<a name="l00881"></a>00881    <span class="keyword">struct </span><a class="code" href="structast__frame.html">ast_frame</a> *<a class="code" href="format__g726_8c.html#85b9b17a7dd34a3638c560bc9152473b">f</a>;
<a name="l00882"></a>00882    <span class="keywordtype">int</span> x=1;
<a name="l00883"></a>00883    <span class="keywordflow">if</span> (argc != 4)
<a name="l00884"></a>00884       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00885"></a>00885    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;headerlist);
<a name="l00886"></a>00886    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"     Framer Statistics     \n"</span>);
<a name="l00887"></a>00887    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"---------------------------\n"</span>);
<a name="l00888"></a>00888    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Total allocated headers: %d\n"</span>, headers);
<a name="l00889"></a>00889    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Queue Dump:\n"</span>);
<a name="l00890"></a>00890    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;headerlist, f, frame_list)
<a name="l00891"></a>00891       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, "%d.  Type %d, subclass %d from %<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>\n", x++, f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a>, f-&gt;subclass, f-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> ? f-&gt;<a class="code" href="structast__frame.html#25d902c24283ab8cfbac54dfa101ad31">src</a> : "&lt;Unknown&gt;");
<a name="l00892"></a>00892    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;headerlist);
<a name="l00893"></a>00893    return <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 static const <span class="keywordtype">char</span> frame_stats_usage[] =
<a name="l00897"></a>00897 "Usage: core show frame stats\n"
<a name="l00898"></a>00898 "       Displays debugging statistics from framer\n";
<a name="l00899"></a>00899 #endif
<a name="l00900"></a>00900 
<a name="l00901"></a>00901 <span class="comment">/* Builtin Asterisk CLI-commands for debugging */</span>
<a name="l00902"></a><a class="code" href="frame_8c.html#d41cfb9797a324bfbf477ff50adc3368">00902</a> static struct <a class="code" href="structast__cli__entry.html">ast_cli_entry</a> <a class="code" href="frame_8c.html#d41cfb9797a324bfbf477ff50adc3368">my_clis</a>[] = {
<a name="l00903"></a>00903    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"codecs"</span>, NULL },
<a name="l00904"></a>00904    <a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">show_codecs</a>, <span class="stringliteral">"Displays a list of codecs"</span>,
<a name="l00905"></a>00905    frame_show_codecs_usage },
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"audio"</span>, <span class="stringliteral">"codecs"</span>, NULL },
<a name="l00908"></a>00908    <a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">show_codecs</a>, <span class="stringliteral">"Displays a list of audio codecs"</span>,
<a name="l00909"></a>00909    frame_show_codecs_usage },
<a name="l00910"></a>00910 
<a name="l00911"></a>00911    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"video"</span>, <span class="stringliteral">"codecs"</span>, NULL },
<a name="l00912"></a>00912    <a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">show_codecs</a>, <span class="stringliteral">"Displays a list of video codecs"</span>,
<a name="l00913"></a>00913    frame_show_codecs_usage },
<a name="l00914"></a>00914 
<a name="l00915"></a>00915    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"image"</span>, <span class="stringliteral">"codecs"</span>, NULL },
<a name="l00916"></a>00916    <a class="code" href="frame_8c.html#602c3b779a9fc08cd1056de32a3a7c59">show_codecs</a>, <span class="stringliteral">"Displays a list of image codecs"</span>,
<a name="l00917"></a>00917    frame_show_codecs_usage },
<a name="l00918"></a>00918 
<a name="l00919"></a>00919    { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"codec"</span>, NULL },
<a name="l00920"></a>00920    <a class="code" href="frame_8c.html#bc9aa704fb93e336d7117d6074dcee68">show_codec_n</a>, <span class="stringliteral">"Shows a specific codec"</span>,
<a name="l00921"></a>00921    frame_show_codec_n_usage },
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 <span class="preprocessor">#ifdef TRACE_FRAMES</span>
<a name="l00924"></a>00924 <span class="preprocessor"></span>   { { <span class="stringliteral">"core"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"frame"</span>, <span class="stringliteral">"stats"</span>, NULL },
<a name="l00925"></a>00925    show_frame_stats, <span class="stringliteral">"Shows frame statistics"</span>,
<a name="l00926"></a>00926    frame_stats_usage },
<a name="l00927"></a>00927 <span class="preprocessor">#endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>};
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="asterisk_8h.html#d40eb7b18ae20acf758c562e5a44abf1">00930</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#d40eb7b18ae20acf758c562e5a44abf1">init_framer</a>(<span class="keywordtype">void</span>)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(<a class="code" href="frame_8c.html#d41cfb9797a324bfbf477ff50adc3368">my_clis</a>, <span class="keyword">sizeof</span>(<a class="code" href="frame_8c.html#d41cfb9797a324bfbf477ff50adc3368">my_clis</a>) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html">ast_cli_entry</a>));
<a name="l00933"></a>00933    <span class="keywordflow">return</span> 0;   
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a><a class="code" href="frame_8h.html#6f50f49fb8877f8ddf48c139f37a8b8b">00936</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#6f50f49fb8877f8ddf48c139f37a8b8b">ast_codec_pref_convert</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">char</span> *buf, size_t size, <span class="keywordtype">int</span> right) 
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938    <span class="keywordtype">int</span> x, differential = (int) <span class="charliteral">'A'</span>, mem;
<a name="l00939"></a>00939    <span class="keywordtype">char</span> *from, *to;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941    <span class="keywordflow">if</span> (right) {
<a name="l00942"></a>00942       from = pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>;
<a name="l00943"></a>00943       to = buf;
<a name="l00944"></a>00944       mem = size;
<a name="l00945"></a>00945    } <span class="keywordflow">else</span> {
<a name="l00946"></a>00946       to = pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>;
<a name="l00947"></a>00947       from = buf;
<a name="l00948"></a>00948       mem = 32;
<a name="l00949"></a>00949    }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    memset(to, 0, mem);
<a name="l00952"></a>00952    <span class="keywordflow">for</span> (x = 0; x &lt; 32 ; x++) {
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (!from[x])
<a name="l00954"></a>00954          <span class="keywordflow">break</span>;
<a name="l00955"></a>00955       to[x] = right ? (from[x] + differential) : (from[x] - differential);
<a name="l00956"></a>00956    }
<a name="l00957"></a>00957 }
<a name="l00958"></a>00958 
<a name="l00959"></a><a class="code" href="frame_8h.html#611907362824d464d9e5b4c5eff95005">00959</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#611907362824d464d9e5b4c5eff95005">ast_codec_pref_string</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">char</span> *buf, size_t size) 
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961    <span class="keywordtype">int</span> x, codec; 
<a name="l00962"></a>00962    size_t total_len, slen;
<a name="l00963"></a>00963    <span class="keywordtype">char</span> *formatname;
<a name="l00964"></a>00964    
<a name="l00965"></a>00965    memset(buf,0,size);
<a name="l00966"></a>00966    total_len = size;
<a name="l00967"></a>00967    buf[0] = <span class="charliteral">'('</span>;
<a name="l00968"></a>00968    total_len--;
<a name="l00969"></a>00969    <span class="keywordflow">for</span>(x = 0; x &lt; 32 ; x++) {
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (total_len &lt;= 0)
<a name="l00971"></a>00971          <span class="keywordflow">break</span>;
<a name="l00972"></a>00972       <span class="keywordflow">if</span> (!(codec = <a class="code" href="frame_8c.html#6e71db7f2b8449c591c97f9c090917d2">ast_codec_pref_index</a>(pref,x)))
<a name="l00973"></a>00973          <span class="keywordflow">break</span>;
<a name="l00974"></a>00974       <span class="keywordflow">if</span> ((formatname = <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(codec))) {
<a name="l00975"></a>00975          slen = strlen(formatname);
<a name="l00976"></a>00976          <span class="keywordflow">if</span> (slen &gt; total_len)
<a name="l00977"></a>00977             <span class="keywordflow">break</span>;
<a name="l00978"></a>00978          strncat(buf,formatname,total_len);
<a name="l00979"></a>00979          total_len -= slen;
<a name="l00980"></a>00980       }
<a name="l00981"></a>00981       <span class="keywordflow">if</span> (total_len &amp;&amp; x &lt; 31 &amp;&amp; <a class="code" href="frame_8c.html#6e71db7f2b8449c591c97f9c090917d2">ast_codec_pref_index</a>(pref , x + 1)) {
<a name="l00982"></a>00982          strncat(buf,<span class="stringliteral">"|"</span>,total_len);
<a name="l00983"></a>00983          total_len--;
<a name="l00984"></a>00984       }
<a name="l00985"></a>00985    }
<a name="l00986"></a>00986    <span class="keywordflow">if</span> (total_len) {
<a name="l00987"></a>00987       strncat(buf,<span class="stringliteral">")"</span>,total_len);
<a name="l00988"></a>00988       total_len--;
<a name="l00989"></a>00989    }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991    <span class="keywordflow">return</span> size - total_len;
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 
<a name="l00994"></a><a class="code" href="frame_8h.html#6e71db7f2b8449c591c97f9c090917d2">00994</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#6e71db7f2b8449c591c97f9c090917d2">ast_codec_pref_index</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">int</span> index) 
<a name="l00995"></a>00995 {
<a name="l00996"></a>00996    <span class="keywordtype">int</span> slot = 0;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998    
<a name="l00999"></a>00999    <span class="keywordflow">if</span> ((index &gt;= 0) &amp;&amp; (index &lt; <span class="keyword">sizeof</span>(pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>))) {
<a name="l01000"></a>01000       slot = pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[index];
<a name="l01001"></a>01001    }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003    <span class="keywordflow">return</span> slot ? AST_FORMAT_LIST[slot-1].bits : 0;
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 <span class="comment"></span>
<a name="l01006"></a>01006 <span class="comment">/*! \brief Remove codec from pref list */</span>
<a name="l01007"></a><a class="code" href="frame_8h.html#7993d6a03e1e57cbb428c6deeec13d8c">01007</a> <span class="keywordtype">void</span> <a class="code" href="frame_8c.html#7993d6a03e1e57cbb428c6deeec13d8c">ast_codec_pref_remove</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">int</span> format)
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> oldorder;
<a name="l01010"></a>01010    <span class="keywordtype">int</span> x, y = 0;
<a name="l01011"></a>01011    <span class="keywordtype">int</span> slot;
<a name="l01012"></a>01012    <span class="keywordtype">int</span> size;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    <span class="keywordflow">if</span> (!pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[0])
<a name="l01015"></a>01015       <span class="keywordflow">return</span>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017    memcpy(&amp;oldorder, pref, <span class="keyword">sizeof</span>(oldorder));
<a name="l01018"></a>01018    memset(pref, 0, <span class="keyword">sizeof</span>(*pref));
<a name="l01019"></a>01019 
<a name="l01020"></a>01020    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01021"></a>01021       slot = oldorder.order[x];
<a name="l01022"></a>01022       size = oldorder.framing[x];
<a name="l01023"></a>01023       <span class="keywordflow">if</span> (! slot)
<a name="l01024"></a>01024          <span class="keywordflow">break</span>;
<a name="l01025"></a>01025       <span class="keywordflow">if</span> (AST_FORMAT_LIST[slot-1].bits != format) {
<a name="l01026"></a>01026          pref-&gt;order[y] = slot;
<a name="l01027"></a>01027          pref-&gt;framing[y++] = size;
<a name="l01028"></a>01028       }
<a name="l01029"></a>01029    }
<a name="l01030"></a>01030    
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 <span class="comment"></span>
<a name="l01033"></a>01033 <span class="comment">/*! \brief Append codec to list */</span>
<a name="l01034"></a><a class="code" href="frame_8h.html#3a43d24dea5c4914c4adbc498d3fec84">01034</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#3a43d24dea5c4914c4adbc498d3fec84">ast_codec_pref_append</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">int</span> format)
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036    <span class="keywordtype">int</span> x, newindex = -1;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038    <a class="code" href="frame_8c.html#7993d6a03e1e57cbb428c6deeec13d8c">ast_codec_pref_remove</a>(pref, format);
<a name="l01039"></a>01039 
<a name="l01040"></a>01040    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01041"></a>01041       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].bits == format) {
<a name="l01042"></a>01042          newindex = x + 1;
<a name="l01043"></a>01043          <span class="keywordflow">break</span>;
<a name="l01044"></a>01044       }
<a name="l01045"></a>01045    }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047    <span class="keywordflow">if</span> (newindex) {
<a name="l01048"></a>01048       <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01049"></a>01049          <span class="keywordflow">if</span> (!pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[x]) {
<a name="l01050"></a>01050             pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[x] = newindex;
<a name="l01051"></a>01051             <span class="keywordflow">break</span>;
<a name="l01052"></a>01052          }
<a name="l01053"></a>01053       }
<a name="l01054"></a>01054    }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    <span class="keywordflow">return</span> x;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059 <span class="comment"></span>
<a name="l01060"></a>01060 <span class="comment">/*! \brief Set packet size for codec */</span>
<a name="l01061"></a><a class="code" href="frame_8h.html#a1e66ce5adea4bd91d098fa5c98cf5e7">01061</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#a1e66ce5adea4bd91d098fa5c98cf5e7">ast_codec_pref_setsize</a>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *pref, <span class="keywordtype">int</span> format, <span class="keywordtype">int</span> framems)
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063    <span class="keywordtype">int</span> x, index = -1;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01066"></a>01066       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].bits == format) {
<a name="l01067"></a>01067          index = x;
<a name="l01068"></a>01068          <span class="keywordflow">break</span>;
<a name="l01069"></a>01069       }
<a name="l01070"></a>01070    }
<a name="l01071"></a>01071 
<a name="l01072"></a>01072    <span class="keywordflow">if</span> (index &lt; 0)
<a name="l01073"></a>01073       <span class="keywordflow">return</span> -1;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075    <span class="comment">/* size validation */</span>
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (!framems)
<a name="l01077"></a>01077       framems = AST_FORMAT_LIST[index].def_ms;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079    <span class="keywordflow">if</span> (AST_FORMAT_LIST[index].inc_ms &amp;&amp; framems % AST_FORMAT_LIST[index].inc_ms) <span class="comment">/* avoid division by zero */</span>
<a name="l01080"></a>01080       framems -= framems % AST_FORMAT_LIST[index].inc_ms;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082    <span class="keywordflow">if</span> (framems &lt; AST_FORMAT_LIST[index].min_ms)
<a name="l01083"></a>01083       framems = AST_FORMAT_LIST[index].min_ms;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085    <span class="keywordflow">if</span> (framems &gt; AST_FORMAT_LIST[index].max_ms)
<a name="l01086"></a>01086       framems = AST_FORMAT_LIST[index].max_ms;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 
<a name="l01089"></a>01089    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01090"></a>01090       <span class="keywordflow">if</span> (pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[x] == (index + 1)) {
<a name="l01091"></a>01091          pref-&gt;<a class="code" href="structast__codec__pref.html#8eb9be1f513faf031cb30a78e4c54d04">framing</a>[x] = framems;
<a name="l01092"></a>01092          <span class="keywordflow">break</span>;
<a name="l01093"></a>01093       }
<a name="l01094"></a>01094    }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096    <span class="keywordflow">return</span> x;
<a name="l01097"></a>01097 }
<a name="l01098"></a>01098 <span class="comment"></span>
<a name="l01099"></a>01099 <span class="comment">/*! \brief Get packet size for codec */</span>
<a name="l01100"></a><a class="code" href="frame_8h.html#9c573f275174b252500383079b5c4184">01100</a> <span class="keyword">struct </span><a class="code" href="structast__format__list.html">ast_format_list</a> ast_codec_pref_getsize(struct ast_codec_pref *pref, <span class="keywordtype">int</span> format)
<a name="l01101"></a>01101 {
<a name="l01102"></a>01102    <span class="keywordtype">int</span> x, index = -1, framems = 0;
<a name="l01103"></a>01103    <span class="keyword">struct</span> <a class="code" href="structast__format__list.html">ast_format_list</a> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a> = { 0, };
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01106"></a>01106       <span class="keywordflow">if</span> (AST_FORMAT_LIST[x].<a class="code" href="structast__format__list.html#cc411e6c13670e52124629b8ac83f7d0">bits</a> == format) {
<a name="l01107"></a>01107          <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a> = AST_FORMAT_LIST[x];
<a name="l01108"></a>01108          index = x;
<a name="l01109"></a>01109          <span class="keywordflow">break</span>;
<a name="l01110"></a>01110       }
<a name="l01111"></a>01111    }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01114"></a>01114       <span class="keywordflow">if</span> (pref-&gt;order[x] == (index + 1)) {
<a name="l01115"></a>01115          framems = pref-&gt;framing[x];
<a name="l01116"></a>01116          <span class="keywordflow">break</span>;
<a name="l01117"></a>01117       }
<a name="l01118"></a>01118    }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120    <span class="comment">/* size validation */</span>
<a name="l01121"></a>01121    <span class="keywordflow">if</span> (!framems)
<a name="l01122"></a>01122       framems = AST_FORMAT_LIST[index].<a class="code" href="structast__format__list.html#516605418c61473f1ecc5ae9b19ca4d4">def_ms</a>;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <span class="keywordflow">if</span> (AST_FORMAT_LIST[index].<a class="code" href="structast__format__list.html#75b4e1ddacd18acfd2d5901fd80bb299">inc_ms</a> &amp;&amp; framems % AST_FORMAT_LIST[index].<a class="code" href="structast__format__list.html#75b4e1ddacd18acfd2d5901fd80bb299">inc_ms</a>) <span class="comment">/* avoid division by zero */</span>
<a name="l01125"></a>01125       framems -= framems % AST_FORMAT_LIST[index].inc_ms;
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    <span class="keywordflow">if</span> (framems &lt; AST_FORMAT_LIST[index].<a class="code" href="structast__format__list.html#dd6de444202ef87460ccd8ed5c308dd8">min_ms</a>)
<a name="l01128"></a>01128       framems = AST_FORMAT_LIST[index].min_ms;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130    <span class="keywordflow">if</span> (framems &gt; AST_FORMAT_LIST[index].<a class="code" href="structast__format__list.html#8d081f23e40f6fb47bd856a7857b7ec0">max_ms</a>)
<a name="l01131"></a>01131       framems = AST_FORMAT_LIST[index].max_ms;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133    <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>.cur_ms = framems;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135    <span class="keywordflow">return</span> <a class="code" href="manager_8h.html#7631454338ff70b1a6b1262f5f36beac">fmt</a>;
<a name="l01136"></a>01136 }
<a name="l01137"></a>01137 <span class="comment"></span>
<a name="l01138"></a>01138 <span class="comment">/*! \brief Pick a codec */</span>
<a name="l01139"></a><a class="code" href="frame_8h.html#b44bee6c3d35e71f8ac931c5eb8d1b32">01139</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#b44bee6c3d35e71f8ac931c5eb8d1b32">ast_codec_choose</a>(<span class="keyword">struct</span> ast_codec_pref *pref, <span class="keywordtype">int</span> formats, <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#5be9502d1aa1a3046aef9e97e61a1611">find_best</a>)
<a name="l01140"></a>01140 {
<a name="l01141"></a>01141    <span class="keywordtype">int</span> x, ret = 0, slot;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143    <span class="keywordflow">for</span> (x = 0; x &lt; <span class="keyword">sizeof</span>(AST_FORMAT_LIST) / <span class="keyword">sizeof</span>(AST_FORMAT_LIST[0]); x++) {
<a name="l01144"></a>01144       slot = pref-&gt;<a class="code" href="structast__codec__pref.html#6d2f03f1137d7e94d7e21e919018353a">order</a>[x];
<a name="l01145"></a>01145 
<a name="l01146"></a>01146       <span class="keywordflow">if</span> (!slot)
<a name="l01147"></a>01147          <span class="keywordflow">break</span>;
<a name="l01148"></a>01148       <span class="keywordflow">if</span> (formats &amp; AST_FORMAT_LIST[slot-1].<a class="code" href="structast__format__list.html#cc411e6c13670e52124629b8ac83f7d0">bits</a>) {
<a name="l01149"></a>01149          ret = AST_FORMAT_LIST[slot-1].bits;
<a name="l01150"></a>01150          <span class="keywordflow">break</span>;
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152    }
<a name="l01153"></a>01153    <span class="keywordflow">if</span> (ret &amp; <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>)
<a name="l01154"></a>01154       <span class="keywordflow">return</span> ret;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 3)
<a name="l01157"></a>01157       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Could not find preferred codec - %s\n"</span>, find_best ? <span class="stringliteral">"Going for the best codec"</span> : <span class="stringliteral">"Returning zero codec"</span>);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159       <span class="keywordflow">return</span> find_best ? <a class="code" href="channel_8c.html#8aa2203afc4fb127e46d5be40718dc13">ast_best_codec</a>(formats) : 0;
<a name="l01160"></a>01160 }
<a name="l01161"></a>01161 
<a name="l01162"></a><a class="code" href="frame_8h.html#8ca22a4761271647fa7d079721f5badc">01162</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#8ca22a4761271647fa7d079721f5badc">ast_parse_allow_disallow</a>(<span class="keyword">struct</span> ast_codec_pref *pref, <span class="keywordtype">int</span> *mask, <span class="keyword">const</span> <span class="keywordtype">char</span> *list, <span class="keywordtype">int</span> allowing) 
<a name="l01163"></a>01163 {
<a name="l01164"></a>01164    <span class="keywordtype">int</span> errors = 0;
<a name="l01165"></a>01165    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#96d2a4ae057584ce23ca92b03303bd2f">parse</a> = NULL, *<span class="keyword">this</span> = NULL, *psize = NULL;
<a name="l01166"></a>01166    <span class="keywordtype">int</span> format = 0, framems = 0;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168    parse = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(list);
<a name="l01169"></a>01169    <span class="keywordflow">while</span> ((<span class="keyword">this</span> = <a class="code" href="strcompat_8c.html#a541370456ac872bdb4bdcc462fc6a6e">strsep</a>(&amp;parse, <span class="stringliteral">","</span>))) {
<a name="l01170"></a>01170       framems = 0;
<a name="l01171"></a>01171       <span class="keywordflow">if</span> ((psize = strrchr(<span class="keyword">this</span>, <span class="charliteral">':'</span>))) {
<a name="l01172"></a>01172          *psize++ = <span class="charliteral">'\0'</span>;
<a name="l01173"></a>01173          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01174"></a>01174             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>,<span class="stringliteral">"Packetization for codec: %s is %s\n"</span>, <span class="keyword">this</span>, psize);
<a name="l01175"></a>01175          framems = atoi(psize);
<a name="l01176"></a>01176          <span class="keywordflow">if</span> (framems &lt; 0) {
<a name="l01177"></a>01177             framems = 0;
<a name="l01178"></a>01178             errors++;
<a name="l01179"></a>01179             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Bad packetization value for codec %s\n"</span>, <span class="keyword">this</span>);
<a name="l01180"></a>01180          }
<a name="l01181"></a>01181       }
<a name="l01182"></a>01182       <span class="keywordflow">if</span> (!(format = <a class="code" href="frame_8c.html#489f45519671fcf4964f385f4de2c689">ast_getformatbyname</a>(<span class="keyword">this</span>))) {
<a name="l01183"></a>01183          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot %s unknown format '%s'\n"</span>, allowing ? <span class="stringliteral">"allow"</span> : <span class="stringliteral">"disallow"</span>, <span class="keyword">this</span>);
<a name="l01184"></a>01184          errors++;
<a name="l01185"></a>01185          <span class="keywordflow">continue</span>;
<a name="l01186"></a>01186       }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188       <span class="keywordflow">if</span> (mask) {
<a name="l01189"></a>01189          <span class="keywordflow">if</span> (allowing)
<a name="l01190"></a>01190             *mask |= format;
<a name="l01191"></a>01191          <span class="keywordflow">else</span>
<a name="l01192"></a>01192             *mask &amp;= ~format;
<a name="l01193"></a>01193       }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195       <span class="comment">/* Set up a preference list for audio. Do not include video in preferences </span>
<a name="l01196"></a>01196 <span class="comment">         since we can not transcode video and have to use whatever is offered</span>
<a name="l01197"></a>01197 <span class="comment">       */</span>
<a name="l01198"></a>01198       <span class="keywordflow">if</span> (pref &amp;&amp; (format &amp; <a class="code" href="frame_8h.html#71a0a9732267760506de172c34d7a625">AST_FORMAT_AUDIO_MASK</a>)) {
<a name="l01199"></a>01199          <span class="keywordflow">if</span> (strcasecmp(<span class="keyword">this</span>, <span class="stringliteral">"all"</span>)) {
<a name="l01200"></a>01200             <span class="keywordflow">if</span> (allowing) {
<a name="l01201"></a>01201                <a class="code" href="frame_8c.html#3a43d24dea5c4914c4adbc498d3fec84">ast_codec_pref_append</a>(pref, format);
<a name="l01202"></a>01202                <a class="code" href="frame_8c.html#a1e66ce5adea4bd91d098fa5c98cf5e7">ast_codec_pref_setsize</a>(pref, format, framems);
<a name="l01203"></a>01203             }
<a name="l01204"></a>01204             <span class="keywordflow">else</span>
<a name="l01205"></a>01205                <a class="code" href="frame_8c.html#7993d6a03e1e57cbb428c6deeec13d8c">ast_codec_pref_remove</a>(pref, format);
<a name="l01206"></a>01206          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!allowing) {
<a name="l01207"></a>01207             memset(pref, 0, <span class="keyword">sizeof</span>(*pref));
<a name="l01208"></a>01208          }
<a name="l01209"></a>01209       }
<a name="l01210"></a>01210    }
<a name="l01211"></a>01211    <span class="keywordflow">return</span> errors;
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a><a class="code" href="frame_8c.html#24b672de9db4c07a5a98639235edb490">01214</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#24b672de9db4c07a5a98639235edb490">g723_len</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216    <span class="keyword">enum</span> <a class="code" href="frame_8c.html#4b01fdbd475cfb9e94271b62a217cd8c">frame_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> = buf &amp; <a class="code" href="frame_8c.html#e27eb787a050ee746c993029d47a484e">TYPE_MASK</a>;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218    <span class="keywordflow">switch</span>(type) {
<a name="l01219"></a>01219    <span class="keywordflow">case</span> TYPE_DONTSEND:
<a name="l01220"></a>01220       <span class="keywordflow">return</span> 0;
<a name="l01221"></a>01221       <span class="keywordflow">break</span>;
<a name="l01222"></a>01222    <span class="keywordflow">case</span> TYPE_SILENCE:
<a name="l01223"></a>01223       <span class="keywordflow">return</span> 4;
<a name="l01224"></a>01224       <span class="keywordflow">break</span>;
<a name="l01225"></a>01225    <span class="keywordflow">case</span> TYPE_HIGH:
<a name="l01226"></a>01226       <span class="keywordflow">return</span> 24;
<a name="l01227"></a>01227       <span class="keywordflow">break</span>;
<a name="l01228"></a>01228    <span class="keywordflow">case</span> TYPE_LOW:
<a name="l01229"></a>01229       <span class="keywordflow">return</span> 20;
<a name="l01230"></a>01230       <span class="keywordflow">break</span>;
<a name="l01231"></a>01231    <span class="keywordflow">default</span>:
<a name="l01232"></a>01232       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Badly encoded frame (%d)\n"</span>, type);
<a name="l01233"></a>01233    }
<a name="l01234"></a>01234    <span class="keywordflow">return</span> -1;
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01237"></a><a class="code" href="frame_8c.html#c74b9ddb198c2982c8e773aaf905b4b0">01237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#c74b9ddb198c2982c8e773aaf905b4b0">g723_samples</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> maxlen)
<a name="l01238"></a>01238 {
<a name="l01239"></a>01239    <span class="keywordtype">int</span> pos = 0;
<a name="l01240"></a>01240    <span class="keywordtype">int</span> samples = 0;
<a name="l01241"></a>01241    <span class="keywordtype">int</span> res;
<a name="l01242"></a>01242    <span class="keywordflow">while</span>(pos &lt; maxlen) {
<a name="l01243"></a>01243       res = <a class="code" href="frame_8c.html#24b672de9db4c07a5a98639235edb490">g723_len</a>(buf[pos]);
<a name="l01244"></a>01244       <span class="keywordflow">if</span> (res &lt;= 0)
<a name="l01245"></a>01245          <span class="keywordflow">break</span>;
<a name="l01246"></a>01246       samples += 240;
<a name="l01247"></a>01247       pos += res;
<a name="l01248"></a>01248    }
<a name="l01249"></a>01249    <span class="keywordflow">return</span> samples;
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a><a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">01252</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> bit)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254    <span class="keywordtype">int</span> byte = bit / 8;       <span class="comment">/* byte containing first bit */</span>
<a name="l01255"></a>01255    <span class="keywordtype">int</span> rem = 8 - (bit % 8);  <span class="comment">/* remaining bits in first byte */</span>
<a name="l01256"></a>01256    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ret = 0;
<a name="l01257"></a>01257    
<a name="l01258"></a>01258    <span class="keywordflow">if</span> (n &lt;= 0 || n &gt; 8)
<a name="l01259"></a>01259       <span class="keywordflow">return</span> 0;
<a name="l01260"></a>01260 
<a name="l01261"></a>01261    <span class="keywordflow">if</span> (rem &lt; n) {
<a name="l01262"></a>01262       ret = (data[byte] &lt;&lt; (n - rem));
<a name="l01263"></a>01263       ret |= (data[byte + 1] &gt;&gt; (8 - n + rem));
<a name="l01264"></a>01264    } <span class="keywordflow">else</span> {
<a name="l01265"></a>01265       ret = (data[byte] &gt;&gt; (rem - n));
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="keywordflow">return</span> (ret &amp; (0xff &gt;&gt; (8 - n)));
<a name="l01269"></a>01269 }
<a name="l01270"></a>01270 
<a name="l01271"></a><a class="code" href="frame_8c.html#d0ff755f36e44b4462918d443b5e3a9b">01271</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#d0ff755f36e44b4462918d443b5e3a9b">speex_get_wb_sz_at</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> bit)
<a name="l01272"></a>01272 {
<a name="l01273"></a>01273    <span class="keyword">static</span> <span class="keywordtype">int</span> SpeexWBSubModeSz[] = {
<a name="l01274"></a>01274       0, 36, 112, 192,
<a name="l01275"></a>01275       352, 0, 0, 0 };
<a name="l01276"></a>01276    <span class="keywordtype">int</span> off = bit;
<a name="l01277"></a>01277    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="comment">/* skip up to two wideband frames */</span>
<a name="l01280"></a>01280    <span class="keywordflow">if</span> (((len * 8 - off) &gt;= 5) &amp;&amp; 
<a name="l01281"></a>01281       <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 1, off)) {
<a name="l01282"></a>01282       c = <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 3, off + 1);
<a name="l01283"></a>01283       off += SpeexWBSubModeSz[c];
<a name="l01284"></a>01284 
<a name="l01285"></a>01285       <span class="keywordflow">if</span> (((len * 8 - off) &gt;= 5) &amp;&amp; 
<a name="l01286"></a>01286          <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 1, off)) {
<a name="l01287"></a>01287          c = <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 3, off + 1);
<a name="l01288"></a>01288          off += SpeexWBSubModeSz[c];
<a name="l01289"></a>01289 
<a name="l01290"></a>01290          <span class="keywordflow">if</span> (((len * 8 - off) &gt;= 5) &amp;&amp; 
<a name="l01291"></a>01291             <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 1, off)) {
<a name="l01292"></a>01292             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Encountered corrupt speex frame; too many wideband frames in a row.\n"</span>);
<a name="l01293"></a>01293             <span class="keywordflow">return</span> -1;
<a name="l01294"></a>01294          }
<a name="l01295"></a>01295       }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297    }
<a name="l01298"></a>01298    <span class="keywordflow">return</span> off - bit;
<a name="l01299"></a>01299 }
<a name="l01300"></a>01300 
<a name="l01301"></a><a class="code" href="frame_8c.html#7c20a712f15b90d220464bfbfc1bb343">01301</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#7c20a712f15b90d220464bfbfc1bb343">speex_samples</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> len)
<a name="l01302"></a>01302 {
<a name="l01303"></a>01303    <span class="keyword">static</span> <span class="keywordtype">int</span> SpeexSubModeSz[] = {
<a name="l01304"></a>01304                5, 43, 119, 160,
<a name="l01305"></a>01305       220, 300, 364, 492, 
<a name="l01306"></a>01306       79, 0, 0, 0,
<a name="l01307"></a>01307       0, 0, 0, 0 };
<a name="l01308"></a>01308    <span class="keyword">static</span> <span class="keywordtype">int</span> SpeexInBandSz[] = { 
<a name="l01309"></a>01309       1, 1, 4, 4,
<a name="l01310"></a>01310       4, 4, 4, 4,
<a name="l01311"></a>01311       8, 8, 16, 16,
<a name="l01312"></a>01312       32, 32, 64, 64 };
<a name="l01313"></a>01313    <span class="keywordtype">int</span> bit = 0;
<a name="l01314"></a>01314    <span class="keywordtype">int</span> cnt = 0;
<a name="l01315"></a>01315    <span class="keywordtype">int</span> off;
<a name="l01316"></a>01316    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <span class="keywordflow">while</span> ((len * 8 - bit) &gt;= 5) {
<a name="l01319"></a>01319       <span class="comment">/* skip wideband frames */</span>
<a name="l01320"></a>01320       off = <a class="code" href="frame_8c.html#d0ff755f36e44b4462918d443b5e3a9b">speex_get_wb_sz_at</a>(data, len, bit);
<a name="l01321"></a>01321       <span class="keywordflow">if</span> (off &lt; 0)  {
<a name="l01322"></a>01322          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Had error while reading wideband frames for speex samples\n"</span>);
<a name="l01323"></a>01323          <span class="keywordflow">break</span>;
<a name="l01324"></a>01324       }
<a name="l01325"></a>01325       bit += off;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327       <span class="keywordflow">if</span> ((len * 8 - bit) &lt; 5) {
<a name="l01328"></a>01328          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Not enough bits remaining after wide band for speex samples.\n"</span>);
<a name="l01329"></a>01329          <span class="keywordflow">break</span>;
<a name="l01330"></a>01330       }
<a name="l01331"></a>01331 
<a name="l01332"></a>01332       <span class="comment">/* get control bits */</span>
<a name="l01333"></a>01333       c = <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 5, bit);
<a name="l01334"></a>01334       bit += 5;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336       <span class="keywordflow">if</span> (c == 15) { 
<a name="l01337"></a>01337          <span class="comment">/* terminator */</span>
<a name="l01338"></a>01338          <span class="keywordflow">break</span>; 
<a name="l01339"></a>01339       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == 14) {
<a name="l01340"></a>01340          <span class="comment">/* in-band signal; next 4 bits contain signal id */</span>
<a name="l01341"></a>01341          c = <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 4, bit);
<a name="l01342"></a>01342          bit += 4;
<a name="l01343"></a>01343          bit += SpeexInBandSz[c];
<a name="l01344"></a>01344       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == 13) {
<a name="l01345"></a>01345          <span class="comment">/* user in-band; next 5 bits contain msg len */</span>
<a name="l01346"></a>01346          c = <a class="code" href="frame_8c.html#d9e068478809dd4a437025f0b6f5e6c6">get_n_bits_at</a>(data, 5, bit);
<a name="l01347"></a>01347          bit += 5;
<a name="l01348"></a>01348          bit += c * 8;
<a name="l01349"></a>01349       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c &gt; 8) {
<a name="l01350"></a>01350          <span class="comment">/* unknown */</span>
<a name="l01351"></a>01351          <span class="keywordflow">break</span>;
<a name="l01352"></a>01352       } <span class="keywordflow">else</span> {
<a name="l01353"></a>01353          <span class="comment">/* skip number bits for submode (less the 5 control bits) */</span>
<a name="l01354"></a>01354          bit += SpeexSubModeSz[c] - 5;
<a name="l01355"></a>01355          cnt += 160; <span class="comment">/* new frame */</span>
<a name="l01356"></a>01356       }
<a name="l01357"></a>01357    }
<a name="l01358"></a>01358    <span class="keywordflow">return</span> cnt;
<a name="l01359"></a>01359 }
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="frame_8h.html#1c2e4fd774af6555c92272ab31d635ab">01361</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#1c2e4fd774af6555c92272ab31d635ab">ast_codec_get_samples</a>(<span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *f)
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363    <span class="keywordtype">int</span> samples=0;
<a name="l01364"></a>01364    <span class="keywordflow">switch</span>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>) {
<a name="l01365"></a>01365    <span class="keywordflow">case</span> AST_FORMAT_SPEEX:
<a name="l01366"></a>01366       samples = <a class="code" href="frame_8c.html#7c20a712f15b90d220464bfbfc1bb343">speex_samples</a>(f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l01367"></a>01367       <span class="keywordflow">break</span>;
<a name="l01368"></a>01368    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#0b4ea457c95753454e021c511a5daecc">AST_FORMAT_G723_1</a>:
<a name="l01369"></a>01369                 samples = <a class="code" href="frame_8c.html#c74b9ddb198c2982c8e773aaf905b4b0">g723_samples</a>(f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>);
<a name="l01370"></a>01370       <span class="keywordflow">break</span>;
<a name="l01371"></a>01371    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#c2f4d8d1a79322d795824fd91fb2706c">AST_FORMAT_ILBC</a>:
<a name="l01372"></a>01372       samples = 240 * (f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> / 50);
<a name="l01373"></a>01373       <span class="keywordflow">break</span>;
<a name="l01374"></a>01374    <span class="keywordflow">case</span> AST_FORMAT_GSM:
<a name="l01375"></a>01375       samples = 160 * (f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> / 33);
<a name="l01376"></a>01376       <span class="keywordflow">break</span>;
<a name="l01377"></a>01377    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#66b369abf91a6c6519ca7cad6c657ae7">AST_FORMAT_G729A</a>:
<a name="l01378"></a>01378       samples = f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> * 8;
<a name="l01379"></a>01379       <span class="keywordflow">break</span>;
<a name="l01380"></a>01380    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>:
<a name="l01381"></a>01381       samples = f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> / 2;
<a name="l01382"></a>01382       <span class="keywordflow">break</span>;
<a name="l01383"></a>01383    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#87eb67578117e5f22d34386b7c989e08">AST_FORMAT_LPC10</a>:
<a name="l01384"></a>01384                 <span class="comment">/* assumes that the RTP packet contains one LPC10 frame */</span>
<a name="l01385"></a>01385       samples = 22 * 8;
<a name="l01386"></a>01386       samples += (((<span class="keywordtype">char</span> *)(f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>))[7] &amp; 0x1) * 8;
<a name="l01387"></a>01387       <span class="keywordflow">break</span>;
<a name="l01388"></a>01388    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a71706b2c864525ec1c9fcf925ae3802">AST_FORMAT_ULAW</a>:
<a name="l01389"></a>01389    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#edc237300fef31677662db961c07484b">AST_FORMAT_ALAW</a>:
<a name="l01390"></a>01390    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#b418abcb13f17e85f68a691f34e99e1a">AST_FORMAT_G722</a>:
<a name="l01391"></a>01391       samples = f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a>;
<a name="l01392"></a>01392       <span class="keywordflow">break</span>;
<a name="l01393"></a>01393    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#b1048e305f2ee62aebab30899c88f8ce">AST_FORMAT_ADPCM</a>:
<a name="l01394"></a>01394    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a594899d5bea5f591eda7e20b5e2c161">AST_FORMAT_G726</a>:
<a name="l01395"></a>01395    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#3c0408e35d11793967a2e178f93256cd">AST_FORMAT_G726_AAL2</a>:
<a name="l01396"></a>01396       samples = f-&gt;<a class="code" href="structast__frame.html#106553e2afb20bec4268dd6bd02c952d">datalen</a> * 2;
<a name="l01397"></a>01397       <span class="keywordflow">break</span>;
<a name="l01398"></a>01398    <span class="keywordflow">default</span>:
<a name="l01399"></a>01399       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to calculate samples for format %s\n"</span>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a>));
<a name="l01400"></a>01400    }
<a name="l01401"></a>01401    <span class="keywordflow">return</span> samples;
<a name="l01402"></a>01402 }
<a name="l01403"></a>01403 
<a name="l01404"></a><a class="code" href="frame_8h.html#86a66efeb5a412e9c1cae13f92043c47">01404</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#86a66efeb5a412e9c1cae13f92043c47">ast_codec_get_len</a>(<span class="keywordtype">int</span> format, <span class="keywordtype">int</span> samples)
<a name="l01405"></a>01405 {
<a name="l01406"></a>01406    <span class="keywordtype">int</span> len = 0;
<a name="l01407"></a>01407 
<a name="l01408"></a>01408    <span class="comment">/* XXX Still need speex, g723, and lpc10 XXX */</span> 
<a name="l01409"></a>01409    <span class="keywordflow">switch</span>(format) {
<a name="l01410"></a>01410    <span class="keywordflow">case</span> AST_FORMAT_G723_1:
<a name="l01411"></a>01411       len = (samples / 240) * 20;
<a name="l01412"></a>01412       <span class="keywordflow">break</span>;
<a name="l01413"></a>01413    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#c2f4d8d1a79322d795824fd91fb2706c">AST_FORMAT_ILBC</a>:
<a name="l01414"></a>01414       len = (samples / 240) * 50;
<a name="l01415"></a>01415       <span class="keywordflow">break</span>;
<a name="l01416"></a>01416    <span class="keywordflow">case</span> AST_FORMAT_GSM:
<a name="l01417"></a>01417       len = (samples / 160) * 33;
<a name="l01418"></a>01418       <span class="keywordflow">break</span>;
<a name="l01419"></a>01419    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#66b369abf91a6c6519ca7cad6c657ae7">AST_FORMAT_G729A</a>:
<a name="l01420"></a>01420       len = samples / 8;
<a name="l01421"></a>01421       <span class="keywordflow">break</span>;
<a name="l01422"></a>01422    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>:
<a name="l01423"></a>01423       len = samples * 2;
<a name="l01424"></a>01424       <span class="keywordflow">break</span>;
<a name="l01425"></a>01425    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a71706b2c864525ec1c9fcf925ae3802">AST_FORMAT_ULAW</a>:
<a name="l01426"></a>01426    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#edc237300fef31677662db961c07484b">AST_FORMAT_ALAW</a>:
<a name="l01427"></a>01427       len = samples;
<a name="l01428"></a>01428       <span class="keywordflow">break</span>;
<a name="l01429"></a>01429    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#b1048e305f2ee62aebab30899c88f8ce">AST_FORMAT_ADPCM</a>:
<a name="l01430"></a>01430    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a594899d5bea5f591eda7e20b5e2c161">AST_FORMAT_G726</a>:
<a name="l01431"></a>01431    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#3c0408e35d11793967a2e178f93256cd">AST_FORMAT_G726_AAL2</a>:
<a name="l01432"></a>01432       len = samples / 2;
<a name="l01433"></a>01433       <span class="keywordflow">break</span>;
<a name="l01434"></a>01434    <span class="keywordflow">default</span>:
<a name="l01435"></a>01435       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to calculate sample length for format %s\n"</span>, <a class="code" href="frame_8c.html#fc9ce4e422290b7bda33cc8685094a97">ast_getformatname</a>(format));
<a name="l01436"></a>01436    }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="keywordflow">return</span> len;
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 
<a name="l01441"></a><a class="code" href="frame_8h.html#0f5d115410bf7f582584378b94d8d37b">01441</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#0f5d115410bf7f582584378b94d8d37b">ast_frame_adjust_volume</a>(<span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *f, <span class="keywordtype">int</span> adjustment)
<a name="l01442"></a>01442 {
<a name="l01443"></a>01443    <span class="keywordtype">int</span> count;
<a name="l01444"></a>01444    <span class="keywordtype">short</span> *fdata = f-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l01445"></a>01445    <span class="keywordtype">short</span> adjust_value = abs(adjustment);
<a name="l01446"></a>01446 
<a name="l01447"></a>01447    <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) || (f-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>))
<a name="l01448"></a>01448       <span class="keywordflow">return</span> -1;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450    <span class="keywordflow">if</span> (!adjustment)
<a name="l01451"></a>01451       <span class="keywordflow">return</span> 0;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453    <span class="keywordflow">for</span> (count = 0; count &lt; f-&gt;samples; count++) {
<a name="l01454"></a>01454       <span class="keywordflow">if</span> (adjustment &gt; 0) {
<a name="l01455"></a>01455          <a class="code" href="utils_8h.html#3e6bc0d1c74396cb84a71d5aba04a018">ast_slinear_saturated_multiply</a>(&amp;fdata[count], &amp;adjust_value);
<a name="l01456"></a>01456       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adjustment &lt; 0) {
<a name="l01457"></a>01457          <a class="code" href="utils_8h.html#e70c5d30f0332a7120376cb5c0b7d8cf">ast_slinear_saturated_divide</a>(&amp;fdata[count], &amp;adjust_value);
<a name="l01458"></a>01458       }
<a name="l01459"></a>01459    }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="keywordflow">return</span> 0;
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01464"></a><a class="code" href="frame_8h.html#8a78ed734b1cafea2ab42e1363a330d0">01464</a> <span class="keywordtype">int</span> <a class="code" href="frame_8c.html#8a78ed734b1cafea2ab42e1363a330d0">ast_frame_slinear_sum</a>(<span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *f1, <span class="keyword">struct</span> <a class="code" href="structast__frame.html">ast_frame</a> *f2)
<a name="l01465"></a>01465 {
<a name="l01466"></a>01466    <span class="keywordtype">int</span> count;
<a name="l01467"></a>01467    <span class="keywordtype">short</span> *data1, *data2;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469    <span class="keywordflow">if</span> ((f1-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) || (f1-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>))
<a name="l01470"></a>01470       <span class="keywordflow">return</span> -1;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472    <span class="keywordflow">if</span> ((f2-&gt;<a class="code" href="structast__frame.html#9574009b02f8256934a1a25cbac10e1d">frametype</a> != <a class="code" href="frame_8h.html#006fc84d03b57b7c7d571d6c0db69f9264fc4720a7b3982e2d4bf246fe3d9924">AST_FRAME_VOICE</a>) || (f2-&gt;<a class="code" href="structast__frame.html#c00578b472e008b51fd24237785fa428">subclass</a> != <a class="code" href="frame_8h.html#ce4d062ff9a85be84b636e7ec67a068b">AST_FORMAT_SLINEAR</a>))
<a name="l01473"></a>01473       <span class="keywordflow">return</span> -1;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475    <span class="keywordflow">if</span> (f1-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a> != f2-&gt;<a class="code" href="structast__frame.html#6ef9161b900632671022358216c7dfe7">samples</a>)
<a name="l01476"></a>01476       <span class="keywordflow">return</span> -1;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478    <span class="keywordflow">for</span> (count = 0, data1 = f1-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>, data2 = f2-&gt;<a class="code" href="structast__frame.html#8d777f385d3dfec8815d20f7496026dc">data</a>;
<a name="l01479"></a>01479         count &lt; f1-&gt;samples;
<a name="l01480"></a>01480         count++, data1++, data2++)
<a name="l01481"></a>01481       <a class="code" href="utils_8h.html#afc008c42bd9d63402c72031f38beb6e">ast_slinear_saturated_add</a>(data1, data2);
<a name="l01482"></a>01482 
<a name="l01483"></a>01483    <span class="keywordflow">return</span> 0;
<a name="l01484"></a>01484 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:42 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
