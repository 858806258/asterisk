<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:50 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_monitor.c</h1><a href="res__monitor_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief PBX channel monitoring</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025  
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 #include &lt;stdio.h&gt;
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;libgen.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="lock_8h.html">asterisk/lock.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="manager_8h.html">asterisk/manager.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="monitor_8h.html">asterisk/monitor.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <a class="code" href="lock_8h.html#4291c0bd75dfaf0052799003d3305e16">AST_MUTEX_DEFINE_STATIC</a>(monitorlock);
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">00054</a> <span class="preprocessor">#define LOCK_IF_NEEDED(lock, needed) do { \</span>
<a name="l00055"></a>00055 <span class="preprocessor">   if (needed) \</span>
<a name="l00056"></a>00056 <span class="preprocessor">      ast_channel_lock(lock); \</span>
<a name="l00057"></a>00057 <span class="preprocessor">   } while(0)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">00059</a> <span class="preprocessor">#define UNLOCK_IF_NEEDED(lock, needed) do { \</span>
<a name="l00060"></a>00060 <span class="preprocessor">   if (needed) \</span>
<a name="l00061"></a>00061 <span class="preprocessor">      ast_channel_unlock(lock); \</span>
<a name="l00062"></a>00062 <span class="preprocessor">   } while (0)</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="res__monitor_8c.html#e068c2de26d760f20cf10afc4b87ef0f">00064</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a> = 0;
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="res__monitor_8c.html#df3922cb467d96b1aae7041602d12c35">00066</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#df3922cb467d96b1aae7041602d12c35">monitor_synopsis</a> = <span class="stringliteral">"Monitor a channel"</span>;
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="res__monitor_8c.html#681043e0ddb4a9a1836d8ec08412eca8">00068</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#681043e0ddb4a9a1836d8ec08412eca8">monitor_descrip</a> = <span class="stringliteral">"Monitor([file_format[:urlbase]|[fname_base]|[options]]):\n"</span>
<a name="l00069"></a>00069 <span class="stringliteral">"Used to start monitoring a channel. The channel's input and output\n"</span>
<a name="l00070"></a>00070 <span class="stringliteral">"voice packets are logged to files until the channel hangs up or\n"</span>
<a name="l00071"></a>00071 <span class="stringliteral">"monitoring is stopped by the StopMonitor application.\n"</span>
<a name="l00072"></a>00072 <span class="stringliteral">"  file_format    optional, if not set, defaults to \"wav\"\n"</span>
<a name="l00073"></a>00073 <span class="stringliteral">"  fname_base     if set, changes the filename used to the one specified.\n"</span>
<a name="l00074"></a>00074 <span class="stringliteral">"  options:\n"</span>
<a name="l00075"></a>00075 <span class="stringliteral">"    m   - when the recording ends mix the two leg files into one and\n"</span>
<a name="l00076"></a>00076 <span class="stringliteral">"          delete the two leg files.  If the variable MONITOR_EXEC is set, the\n"</span>
<a name="l00077"></a>00077 <span class="stringliteral">"          application referenced in it will be executed instead of\n"</span>
<a name="l00078"></a>00078 <span class="stringliteral">"          soxmix and the raw leg files will NOT be deleted automatically.\n"</span>
<a name="l00079"></a>00079 <span class="stringliteral">"          soxmix or MONITOR_EXEC is handed 3 arguments, the two leg files\n"</span>
<a name="l00080"></a>00080 <span class="stringliteral">"          and a target mixed file name which is the same as the leg file names\n"</span>
<a name="l00081"></a>00081 <span class="stringliteral">"          only without the in/out designator.\n"</span>
<a name="l00082"></a>00082 <span class="stringliteral">"          If MONITOR_EXEC_ARGS is set, the contents will be passed on as\n"</span>
<a name="l00083"></a>00083 <span class="stringliteral">"          additional arguements to MONITOR_EXEC\n"</span>
<a name="l00084"></a>00084 <span class="stringliteral">"          Both MONITOR_EXEC and the Mix flag can be set from the\n"</span>
<a name="l00085"></a>00085 <span class="stringliteral">"          administrator interface\n"</span>
<a name="l00086"></a>00086 <span class="stringliteral">"\n"</span>
<a name="l00087"></a>00087 <span class="stringliteral">"    b   - Don't begin recording unless a call is bridged to another channel\n"</span>
<a name="l00088"></a>00088 <span class="stringliteral">"\nReturns -1 if monitor files can't be opened or if the channel is already\n"</span>
<a name="l00089"></a>00089 <span class="stringliteral">"monitored, otherwise 0.\n"</span>
<a name="l00090"></a>00090 ;
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="res__monitor_8c.html#d9cb00ce4df1736a36231353bfa99331">00092</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#d9cb00ce4df1736a36231353bfa99331">stopmonitor_synopsis</a> = <span class="stringliteral">"Stop monitoring a channel"</span>;
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="res__monitor_8c.html#8809f3d6c94380a4882693904571dcc7">00094</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#8809f3d6c94380a4882693904571dcc7">stopmonitor_descrip</a> = <span class="stringliteral">"StopMonitor\n"</span>
<a name="l00095"></a>00095    <span class="stringliteral">"Stops monitoring a channel. Has no effect if the channel is not monitored\n"</span>;
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="res__monitor_8c.html#a975422a90da2977d2baccceac5ff7bd">00097</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#a975422a90da2977d2baccceac5ff7bd">changemonitor_synopsis</a> = <span class="stringliteral">"Change monitoring filename of a channel"</span>;
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="res__monitor_8c.html#3451fedc38324771782eb144504a0755">00099</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#3451fedc38324771782eb144504a0755">changemonitor_descrip</a> = <span class="stringliteral">"ChangeMonitor(filename_base)\n"</span>
<a name="l00100"></a>00100    <span class="stringliteral">"Changes monitoring filename of a channel. Has no effect if the channel is not monitored\n"</span>
<a name="l00101"></a>00101    <span class="stringliteral">"The argument is the new filename base to use for monitoring this channel.\n"</span>;
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="res__monitor_8c.html#9d89d89fe7cdc2abd6ef1ead4b4a52d7">00103</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#9d89d89fe7cdc2abd6ef1ead4b4a52d7">pausemonitor_synopsis</a> = <span class="stringliteral">"Pause monitoring of a channel"</span>;
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="res__monitor_8c.html#361f387bf41f76944e8dd79fd2cc6419">00105</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#361f387bf41f76944e8dd79fd2cc6419">pausemonitor_descrip</a> = <span class="stringliteral">"PauseMonitor\n"</span>
<a name="l00106"></a>00106    <span class="stringliteral">"Pauses monitoring of a channel until it is re-enabled by a call to UnpauseMonitor.\n"</span>;
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="res__monitor_8c.html#ac04a66d69ebd954ce39f054d6fbcf94">00108</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#ac04a66d69ebd954ce39f054d6fbcf94">unpausemonitor_synopsis</a> = <span class="stringliteral">"Unpause monitoring of a channel"</span>;
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="res__monitor_8c.html#ff764e2301f43fd063914051e1ff3eed">00110</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#ff764e2301f43fd063914051e1ff3eed">unpausemonitor_descrip</a> = <span class="stringliteral">"UnpauseMonitor\n"</span>
<a name="l00111"></a>00111    <span class="stringliteral">"Unpauses monitoring of a channel on which monitoring had\n"</span>
<a name="l00112"></a>00112    <span class="stringliteral">"previously been paused with PauseMonitor.\n"</span>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">00114</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, 1);
<a name="l00117"></a>00117    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00118"></a>00118       <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, 1);
<a name="l00119"></a>00119       <span class="keywordflow">return</span> -1;
<a name="l00120"></a>00120    }
<a name="l00121"></a>00121    chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#9ed39e2ea931586b6a985a6942ef573e">state</a> = state;
<a name="l00122"></a>00122    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, 1);
<a name="l00123"></a>00123    <span class="keywordflow">return</span> 0;
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="comment">/* Start monitoring a channel */</span>
<a name="l00127"></a><a class="code" href="res__monitor_8c.html#4f4e162179064c9f0c8444a33f6fe27d">00127</a> <span class="keywordtype">int</span> <a class="code" href="monitor_8h.html#4f4e162179064c9f0c8444a33f6fe27d">ast_monitor_start</a>(  <span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *format_spec,
<a name="l00128"></a>00128       <span class="keyword">const</span> <span class="keywordtype">char</span> *fname_base, <span class="keywordtype">int</span> need_lock)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keywordtype">int</span> res = 0;
<a name="l00131"></a>00131    <span class="keywordtype">char</span> tmp[256];
<a name="l00132"></a>00132 
<a name="l00133"></a>00133    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135    <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>)) {
<a name="l00136"></a>00136       <span class="keyword">struct </span><a class="code" href="structast__channel__monitor.html">ast_channel_monitor</a> *<a class="code" href="chan__phone_8c.html#08b5411f848a2581a41672a759c87380">monitor</a>;
<a name="l00137"></a>00137       <span class="keywordtype">char</span> *channel_name, *p;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139       <span class="comment">/* Create monitoring directory if needed */</span>
<a name="l00140"></a>00140       <span class="keywordflow">if</span> (mkdir(<a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, 0770) &lt; 0) {
<a name="l00141"></a>00141          <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l00142"></a>00142             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Unable to create audio monitor directory: %s\n"</span>,
<a name="l00143"></a>00143                strerror(errno));
<a name="l00144"></a>00144          }
<a name="l00145"></a>00145       }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147       <span class="keywordflow">if</span> (!(monitor = <a class="code" href="utils_8h.html#27f1d0ddbd22dac569b18963c5cb7e19">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*monitor)))) {
<a name="l00148"></a>00148          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00149"></a>00149          <span class="keywordflow">return</span> -1;
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152       <span class="comment">/* Determine file names */</span>
<a name="l00153"></a>00153       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname_base)) {
<a name="l00154"></a>00154          <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00155"></a>00155          <span class="comment">/* try creating the directory just in case it doesn't exist */</span>
<a name="l00156"></a>00156          <span class="keywordflow">if</span> (directory) {
<a name="l00157"></a>00157             <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(fname_base);
<a name="l00158"></a>00158             snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"mkdir -p \"%s\""</span>,dirname(name));
<a name="l00159"></a>00159             <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(name);
<a name="l00160"></a>00160             <a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp);
<a name="l00161"></a>00161          }
<a name="l00162"></a>00162          snprintf(monitor-&gt;read_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s-in"</span>,
<a name="l00163"></a>00163                   directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, fname_base);
<a name="l00164"></a>00164          snprintf(monitor-&gt;write_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s-out"</span>,
<a name="l00165"></a>00165                   directory ? <span class="stringliteral">""</span> : ast_config_AST_MONITOR_DIR, fname_base);
<a name="l00166"></a>00166          ast_copy_string(monitor-&gt;filename_base, fname_base, <span class="keyword">sizeof</span>(monitor-&gt;filename_base));
<a name="l00167"></a>00167       } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168          <a class="code" href="lock_8h.html#b3c5e3093b325167f88db93c8b4b2421">ast_mutex_lock</a>(&amp;monitorlock);
<a name="l00169"></a>00169          snprintf(monitor-&gt;read_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/audio-in-%ld"</span>,
<a name="l00170"></a>00170                   <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>);
<a name="l00171"></a>00171          snprintf(monitor-&gt;write_filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/audio-out-%ld"</span>,
<a name="l00172"></a>00172                   <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>);
<a name="l00173"></a>00173          <a class="code" href="app__sms_8c.html#e068c2de26d760f20cf10afc4b87ef0f">seq</a>++;
<a name="l00174"></a>00174          <a class="code" href="lock_8h.html#1d33e3caf152f0901c5ebdb69c2d4d26">ast_mutex_unlock</a>(&amp;monitorlock);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176          channel_name = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(chan-&gt;name);
<a name="l00177"></a>00177          <span class="keywordflow">while</span> ((p = strchr(channel_name, <span class="charliteral">'/'</span>))) {
<a name="l00178"></a>00178             *p = <span class="charliteral">'-'</span>;
<a name="l00179"></a>00179          }
<a name="l00180"></a>00180          snprintf(monitor-&gt;filename_base, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%d-%s"</span>,
<a name="l00181"></a>00181                 <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, (<span class="keywordtype">int</span>)time(NULL), channel_name);
<a name="l00182"></a>00182          monitor-&gt;filename_changed = 1;
<a name="l00183"></a>00183       }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185       monitor-&gt;stop = <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       <span class="comment">/* Determine file format */</span>
<a name="l00188"></a>00188       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(format_spec)) {
<a name="l00189"></a>00189          monitor-&gt;format = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(format_spec);
<a name="l00190"></a>00190       } <span class="keywordflow">else</span> {
<a name="l00191"></a>00191          monitor-&gt;format = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(<span class="stringliteral">"wav"</span>);
<a name="l00192"></a>00192       }
<a name="l00193"></a>00193       
<a name="l00194"></a>00194       <span class="comment">/* open files */</span>
<a name="l00195"></a>00195       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(monitor-&gt;read_filename, NULL, NULL) &gt; 0) {
<a name="l00196"></a>00196          <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(monitor-&gt;read_filename, NULL);
<a name="l00197"></a>00197       }
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (!(monitor-&gt;read_stream = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(monitor-&gt;read_filename,
<a name="l00199"></a>00199                   monitor-&gt;format, NULL,
<a name="l00200"></a>00200                   O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>))) {
<a name="l00201"></a>00201          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not create file %s\n"</span>,
<a name="l00202"></a>00202                   monitor-&gt;read_filename);
<a name="l00203"></a>00203          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(monitor);
<a name="l00204"></a>00204          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00205"></a>00205          <span class="keywordflow">return</span> -1;
<a name="l00206"></a>00206       }
<a name="l00207"></a>00207       <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(monitor-&gt;write_filename, NULL, NULL) &gt; 0) {
<a name="l00208"></a>00208          <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(monitor-&gt;write_filename, NULL);
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (!(monitor-&gt;write_stream = <a class="code" href="file_8c.html#863a5fc977919f88d566c68efc408f7a">ast_writefile</a>(monitor-&gt;write_filename,
<a name="l00211"></a>00211                   monitor-&gt;format, NULL,
<a name="l00212"></a>00212                   O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#40c72ca4a20a53b69eb99c554e214a82">AST_FILE_MODE</a>))) {
<a name="l00213"></a>00213          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Could not create file %s\n"</span>,
<a name="l00214"></a>00214                   monitor-&gt;write_filename);
<a name="l00215"></a>00215          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(monitor-&gt;read_stream);
<a name="l00216"></a>00216          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(monitor);
<a name="l00217"></a>00217          <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00218"></a>00218          <span class="keywordflow">return</span> -1;
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = monitor;
<a name="l00221"></a>00221       <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>);
<a name="l00222"></a>00222       <span class="comment">/* so we know this call has been monitored in case we need to bill for it or something */</span>
<a name="l00223"></a>00223       <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">"__MONITORED"</span>,<span class="stringliteral">"true"</span>);
<a name="l00224"></a>00224    } <span class="keywordflow">else</span> {
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00226"></a>00226          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>,<span class="stringliteral">"Cannot start monitoring %s, already monitored\n"</span>,
<a name="l00227"></a>00227                   chan-&gt;name);
<a name="l00228"></a>00228       res = -1;
<a name="l00229"></a>00229    }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233    <span class="keywordflow">return</span> res;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="comment">/*</span>
<a name="l00237"></a>00237 <span class="comment"> * The file format extensions that Asterisk uses are not all the same as that</span>
<a name="l00238"></a>00238 <span class="comment"> * which soxmix expects.  This function ensures that the format used as the</span>
<a name="l00239"></a>00239 <span class="comment"> * extension on the filename is something soxmix will understand.</span>
<a name="l00240"></a>00240 <span class="comment"> */</span>
<a name="l00241"></a><a class="code" href="res__monitor_8c.html#50adae321837c2e2dfbfb1c620ce8f78">00241</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__monitor_8c.html#50adae321837c2e2dfbfb1c620ce8f78">get_soxmix_format</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243    <span class="keyword">const</span> <span class="keywordtype">char</span> *res = format;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245    <span class="keywordflow">if</span> (!strcasecmp(format,<span class="stringliteral">"ulaw"</span>))
<a name="l00246"></a>00246       res = <span class="stringliteral">"ul"</span>;
<a name="l00247"></a>00247    <span class="keywordflow">if</span> (!strcasecmp(format,<span class="stringliteral">"alaw"</span>))
<a name="l00248"></a>00248       res = <span class="stringliteral">"al"</span>;
<a name="l00249"></a>00249    
<a name="l00250"></a>00250    <span class="keywordflow">return</span> res;
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="comment">/* Stop monitoring a channel */</span>
<a name="l00254"></a><a class="code" href="res__monitor_8c.html#0105c193291bd5aa095b584f2f4ea126">00254</a> <span class="keywordtype">int</span> <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> need_lock)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256    <span class="keywordtype">int</span> delfiles = 0;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00261"></a>00261       <span class="keywordtype">char</span> filename[ <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a> ];
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>) {
<a name="l00264"></a>00264          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#0e9a7813e068d30d39010f7446e89aa8">read_stream</a>);
<a name="l00265"></a>00265       }
<a name="l00266"></a>00266       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>) {
<a name="l00267"></a>00267          <a class="code" href="file_8c.html#8d18ac7b6bb79201e6321c4b5cfadde2">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#439686cdff7be7eda400c1d1ed373c9d">write_stream</a>);
<a name="l00268"></a>00268       }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#df66eb304be2a1bf4a34beba678a82fd">filename_changed</a> &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>)) {
<a name="l00271"></a>00271          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00272"></a>00272             snprintf(filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s-in"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>);
<a name="l00273"></a>00273             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00274"></a>00274                <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(filename, NULL);
<a name="l00275"></a>00275             }
<a name="l00276"></a>00276             <a class="code" href="file_8c.html#6550c411c28c65446c5ad2a8307b50eb">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00277"></a>00277          } <span class="keywordflow">else</span> {
<a name="l00278"></a>00278             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s not found\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#beceae96d98e2e5f6809f1e67b3a3ed4">read_filename</a>);
<a name="l00279"></a>00279          }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281          <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00282"></a>00282             snprintf(filename, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s-out"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>);
<a name="l00283"></a>00283             <span class="keywordflow">if</span> (<a class="code" href="file_8c.html#5a3ec0398dc377f7850e62edc9e093df">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00284"></a>00284                <a class="code" href="file_8c.html#5a0cbe1f8c9ff2126997209a785679d5">ast_filedelete</a>(filename, NULL);
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286             <a class="code" href="file_8c.html#6550c411c28c65446c5ad2a8307b50eb">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00287"></a>00287          } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"File %s not found\n"</span>, chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#b32b44f84aea16ad38db9c9fda514d41">write_filename</a>);
<a name="l00289"></a>00289          }
<a name="l00290"></a>00290       }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#55dc53055b6d97c2c86b93c76c625b85">joinfiles</a> &amp;&amp; !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>)) {
<a name="l00293"></a>00293          <span class="keywordtype">char</span> tmp[1024];
<a name="l00294"></a>00294          <span class="keywordtype">char</span> tmp2[1024];
<a name="l00295"></a>00295          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = !strcasecmp(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>,<span class="stringliteral">"wav49"</span>) ? <span class="stringliteral">"WAV"</span> : chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>;
<a name="l00296"></a>00296          <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>;
<a name="l00297"></a>00297          <span class="keywordtype">int</span> directory = strchr(name, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00298"></a>00298          <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#736007832d2167baaae763fd3a3f3cf1">dir</a> = directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>;
<a name="l00299"></a>00299          <span class="keyword">const</span> <span class="keywordtype">char</span> *execute, *execute_args;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301          <span class="comment">/* Set the execute application */</span>
<a name="l00302"></a>00302          execute = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"MONITOR_EXEC"</span>);
<a name="l00303"></a>00303          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(execute)) { 
<a name="l00304"></a>00304             execute = <span class="stringliteral">"nice -n 19 soxmix"</span>;
<a name="l00305"></a>00305             format = <a class="code" href="res__monitor_8c.html#50adae321837c2e2dfbfb1c620ce8f78">get_soxmix_format</a>(format);
<a name="l00306"></a>00306             delfiles = 1;
<a name="l00307"></a>00307          } 
<a name="l00308"></a>00308          execute_args = <a class="code" href="pbx_8c.html#944d18aa90701f025b30e63d9644e448">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">"MONITOR_EXEC_ARGS"</span>);
<a name="l00309"></a>00309          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(execute_args)) {
<a name="l00310"></a>00310             execute_args = <span class="stringliteral">""</span>;
<a name="l00311"></a>00311          }
<a name="l00312"></a>00312          
<a name="l00313"></a>00313          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s \"%s/%s-in.%s\" \"%s/%s-out.%s\" \"%s/%s.%s\" %s &amp;"</span>, execute, dir, name, format, dir, name, format, dir, name, format,execute_args);
<a name="l00314"></a>00314          <span class="keywordflow">if</span> (delfiles) {
<a name="l00315"></a>00315             snprintf(tmp2,<span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">"( %s&amp; rm -f \"%s/%s-\"* ) &amp;"</span>,tmp, dir ,name); <span class="comment">/* remove legs when done mixing */</span>
<a name="l00316"></a>00316             ast_copy_string(tmp, tmp2, <span class="keyword">sizeof</span>(tmp));
<a name="l00317"></a>00317          }
<a name="l00318"></a>00318          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00319"></a>00319             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>,<span class="stringliteral">"monitor executing %s\n"</span>,tmp);
<a name="l00320"></a>00320          <span class="keywordflow">if</span> (<a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp) == -1)
<a name="l00321"></a>00321             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Execute of %s failed.\n"</span>,tmp);
<a name="l00322"></a>00322       }
<a name="l00323"></a>00323       
<a name="l00324"></a>00324       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a>);
<a name="l00325"></a>00325       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>);
<a name="l00326"></a>00326       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a> = NULL;
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="keywordflow">return</span> 0;
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="comment">/* Pause monitoring of a channel */</span>
<a name="l00336"></a><a class="code" href="res__monitor_8c.html#ce422ff6a5850f68e038e967a5b094ce">00336</a> <span class="keywordtype">int</span> <a class="code" href="monitor_8h.html#ce422ff6a5850f68e038e967a5b094ce">ast_monitor_pause</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c005088894eaba5a4c66fafb46b0c82d8f68996">AST_MONITOR_PAUSED</a>);
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">/* Unpause monitoring of a channel */</span>
<a name="l00342"></a><a class="code" href="res__monitor_8c.html#7cfb30d07bb72866508802173a655ba1">00342</a> <span class="keywordtype">int</span> <a class="code" href="monitor_8h.html#7cfb30d07bb72866508802173a655ba1">ast_monitor_unpause</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#53d963ce0ac197ee3969ae6c81e4e87b">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#68c252a4174f79a63bcedd9f1c0050884352f541f9b1e83d30923f2cec1777ef">AST_MONITOR_RUNNING</a>);
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a><a class="code" href="res__monitor_8c.html#1ee3ab9d4dd8fc24b6150e2ff24be88d">00347</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#1ee3ab9d4dd8fc24b6150e2ff24be88d">pause_monitor_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00348"></a>00348 {
<a name="l00349"></a>00349    <span class="keywordflow">return</span> <a class="code" href="monitor_8h.html#ce422ff6a5850f68e038e967a5b094ce">ast_monitor_pause</a>(chan);
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="res__monitor_8c.html#d841652a300b977fad6ff263c0351b0f">00352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#d841652a300b977fad6ff263c0351b0f">unpause_monitor_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354    <span class="keywordflow">return</span> <a class="code" href="monitor_8h.html#7cfb30d07bb72866508802173a655ba1">ast_monitor_unpause</a>(chan);
<a name="l00355"></a>00355 }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 <span class="comment">/* Change monitoring filename of a channel */</span>
<a name="l00358"></a><a class="code" href="res__monitor_8c.html#b920883a248d93215cda31effa692ed3">00358</a> <span class="keywordtype">int</span> <a class="code" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *fname_base, <span class="keywordtype">int</span> need_lock)
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360    <span class="keywordtype">char</span> tmp[256];
<a name="l00361"></a>00361    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname_base)) {
<a name="l00362"></a>00362       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot change monitor filename of channel %s to null\n"</span>, chan-&gt;name);
<a name="l00363"></a>00363       <span class="keywordflow">return</span> -1;
<a name="l00364"></a>00364    }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366    <a class="code" href="res__monitor_8c.html#f90045c6b3e543bfe3b3e5b57445f319">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>) {
<a name="l00369"></a>00369       <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">'/'</span>) ? 1 : 0;
<a name="l00370"></a>00370       <span class="comment">/* try creating the directory just in case it doesn't exist */</span>
<a name="l00371"></a>00371       <span class="keywordflow">if</span> (directory) {
<a name="l00372"></a>00372          <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(fname_base);
<a name="l00373"></a>00373          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"mkdir -p %s"</span>,dirname(name));
<a name="l00374"></a>00374          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(name);
<a name="l00375"></a>00375          <a class="code" href="asterisk_8c.html#ceb3925bf8c3e3d21d9246872548f5df">ast_safe_system</a>(tmp);
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378       snprintf(chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#cc4efa60a835b6bc8d83a75e15eaa1eb">filename_base</a>, <a class="code" href="private_8h.html#69c2543ab0f552b97b44602a910e7cce">FILENAME_MAX</a>, <span class="stringliteral">"%s/%s"</span>, directory ? <span class="stringliteral">""</span> : <a class="code" href="asterisk_8c.html#e30f110a2a02a50a63b05fe5ba3206b6">ast_config_AST_MONITOR_DIR</a>, fname_base);
<a name="l00379"></a>00379       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#df66eb304be2a1bf4a34beba678a82fd">filename_changed</a> = 1;
<a name="l00380"></a>00380    } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Cannot change monitor filename of channel %s to %s, monitoring not started\n"</span>, chan-&gt;name, fname_base);
<a name="l00382"></a>00382    }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <a class="code" href="res__monitor_8c.html#39a6544f75f8deaf513a27d704765af9">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    <span class="keywordflow">return</span> 0;
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="res__monitor_8c.html#8c8ffb4a06ac76e2003ebad5e996b7df">00389</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#8c8ffb4a06ac76e2003ebad5e996b7df">start_monitor_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391    <span class="keywordtype">char</span> *arg = NULL;
<a name="l00392"></a>00392    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = NULL;
<a name="l00393"></a>00393    <span class="keywordtype">char</span> *fname_base = NULL;
<a name="l00394"></a>00394    <span class="keywordtype">char</span> *options = NULL;
<a name="l00395"></a>00395    <span class="keywordtype">char</span> *delay = NULL;
<a name="l00396"></a>00396    <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#f9965ae528f5943624007b826db4fe90">urlprefix</a> = NULL;
<a name="l00397"></a>00397    <span class="keywordtype">char</span> tmp[256];
<a name="l00398"></a>00398    <span class="keywordtype">int</span> <a class="code" href="structast__channel__monitor.html#55dc53055b6d97c2c86b93c76c625b85">joinfiles</a> = 0;
<a name="l00399"></a>00399    <span class="keywordtype">int</span> waitforbridge = 0;
<a name="l00400"></a>00400    <span class="keywordtype">int</span> res = 0;
<a name="l00401"></a>00401    
<a name="l00402"></a>00402    <span class="comment">/* Parse arguments. */</span>
<a name="l00403"></a>00403    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>((<span class="keywordtype">char</span>*)data)) {
<a name="l00404"></a>00404       arg = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>((<span class="keywordtype">char</span>*)data);
<a name="l00405"></a>00405       format = arg;
<a name="l00406"></a>00406       fname_base = strchr(arg, <span class="charliteral">'|'</span>);
<a name="l00407"></a>00407       <span class="keywordflow">if</span> (fname_base) {
<a name="l00408"></a>00408          *fname_base = 0;
<a name="l00409"></a>00409          fname_base++;
<a name="l00410"></a>00410          <span class="keywordflow">if</span> ((options = strchr(fname_base, <span class="charliteral">'|'</span>))) {
<a name="l00411"></a>00411             *options = 0;
<a name="l00412"></a>00412             options++;
<a name="l00413"></a>00413             <span class="keywordflow">if</span> (strchr(options, <span class="charliteral">'m'</span>))
<a name="l00414"></a>00414                joinfiles = 1;
<a name="l00415"></a>00415             <span class="keywordflow">if</span> (strchr(options, <span class="charliteral">'b'</span>))
<a name="l00416"></a>00416                waitforbridge = 1;
<a name="l00417"></a>00417          }
<a name="l00418"></a>00418       }
<a name="l00419"></a>00419       arg = strchr(format,<span class="charliteral">':'</span>);
<a name="l00420"></a>00420       <span class="keywordflow">if</span> (arg) {
<a name="l00421"></a>00421          *arg++ = 0;
<a name="l00422"></a>00422          urlprefix = arg;
<a name="l00423"></a>00423       }
<a name="l00424"></a>00424    }
<a name="l00425"></a>00425    <span class="keywordflow">if</span> (urlprefix) {
<a name="l00426"></a>00426       snprintf(tmp,<span class="keyword">sizeof</span>(tmp) - 1,<span class="stringliteral">"%s/%s.%s"</span>,urlprefix,fname_base,
<a name="l00427"></a>00427          ((strcmp(format,<span class="stringliteral">"gsm"</span>)) ? <span class="stringliteral">"wav"</span> : <span class="stringliteral">"gsm"</span>));
<a name="l00428"></a>00428       <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> &amp;&amp; !(chan-&gt;<a class="code" href="structast__channel.html#30491931d0d510243046864dbc71a8c9">cdr</a> = <a class="code" href="cdr_8c.html#0dd431954a27c67f78c6e13be8a0b136">ast_cdr_alloc</a>()))
<a name="l00429"></a>00429          <span class="keywordflow">return</span> -1;
<a name="l00430"></a>00430       <a class="code" href="cdr_8c.html#7faf485af47fef9299ce51da70c13c8b">ast_cdr_setuserfield</a>(chan, tmp);
<a name="l00431"></a>00431    }
<a name="l00432"></a>00432    <span class="keywordflow">if</span> (waitforbridge) {
<a name="l00433"></a>00433       <span class="comment">/* We must remove the "b" option if listed.  In principle none of</span>
<a name="l00434"></a>00434 <span class="comment">         the following could give NULL results, but we check just to</span>
<a name="l00435"></a>00435 <span class="comment">         be pedantic. Reconstructing with checks for 'm' option does not</span>
<a name="l00436"></a>00436 <span class="comment">         work if we end up adding more options than 'm' in the future. */</span>
<a name="l00437"></a>00437       delay = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(data);
<a name="l00438"></a>00438       options = strrchr(delay, <span class="charliteral">'|'</span>);
<a name="l00439"></a>00439       <span class="keywordflow">if</span> (options) {
<a name="l00440"></a>00440          arg = strchr(options, <span class="charliteral">'b'</span>);
<a name="l00441"></a>00441          <span class="keywordflow">if</span> (arg) {
<a name="l00442"></a>00442             *arg = <span class="charliteral">'X'</span>;
<a name="l00443"></a>00443             <a class="code" href="pbx_8c.html#64407c916a2de6ae3f0efeca471c1b1d">pbx_builtin_setvar_helper</a>(chan,<span class="stringliteral">"AUTO_MONITOR"</span>,delay);
<a name="l00444"></a>00444          }
<a name="l00445"></a>00445       }
<a name="l00446"></a>00446       <span class="keywordflow">return</span> 0;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    res = <a class="code" href="monitor_8h.html#4f4e162179064c9f0c8444a33f6fe27d">ast_monitor_start</a>(chan, format, fname_base, 1);
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l00451"></a>00451       res = <a class="code" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a>(chan, fname_base, 1);
<a name="l00452"></a>00452    <a class="code" href="monitor_8h.html#21b1d71c9387ac99b6c5a7066a8a845c">ast_monitor_setjoinfiles</a>(chan, joinfiles);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <span class="keywordflow">return</span> res;
<a name="l00455"></a>00455 }
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="res__monitor_8c.html#00b0c4e9a4b3dd7484dde4e70ac92280">00457</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#00b0c4e9a4b3dd7484dde4e70ac92280">stop_monitor_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459    <span class="keywordflow">return</span> <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>(chan, 1);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="res__monitor_8c.html#8493693fbf9d36a242c39c5dfa74866e">00462</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#8493693fbf9d36a242c39c5dfa74866e">change_monitor_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464    <span class="keywordflow">return</span> <a class="code" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a>(chan, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)data, 1);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="res__monitor_8c.html#75e51867ced5678ac326cfc1405fd83b">00467</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__monitor_8c.html#75e51867ced5678ac326cfc1405fd83b">start_monitor_action_help</a>[] =
<a name="l00468"></a>00468 <span class="stringliteral">"Description: The 'Monitor' action may be used to record the audio on a\n"</span>
<a name="l00469"></a>00469 <span class="stringliteral">"  specified channel.  The following parameters may be used to control\n"</span>
<a name="l00470"></a>00470 <span class="stringliteral">"  this:\n"</span>
<a name="l00471"></a>00471 <span class="stringliteral">"  Channel     - Required.  Used to specify the channel to record.\n"</span>
<a name="l00472"></a>00472 <span class="stringliteral">"  File        - Optional.  Is the name of the file created in the\n"</span>
<a name="l00473"></a>00473 <span class="stringliteral">"                monitor spool directory.  Defaults to the same name\n"</span>
<a name="l00474"></a>00474 <span class="stringliteral">"                as the channel (with slashes replaced with dashes).\n"</span>
<a name="l00475"></a>00475 <span class="stringliteral">"  Format      - Optional.  Is the audio recording format.  Defaults\n"</span>
<a name="l00476"></a>00476 <span class="stringliteral">"                to \"wav\".\n"</span>
<a name="l00477"></a>00477 <span class="stringliteral">"  Mix         - Optional.  Boolean parameter as to whether to mix\n"</span>
<a name="l00478"></a>00478 <span class="stringliteral">"                the input and output channels together after the\n"</span>
<a name="l00479"></a>00479 <span class="stringliteral">"                recording is finished.\n"</span>;
<a name="l00480"></a>00480 
<a name="l00481"></a><a class="code" href="res__monitor_8c.html#26c78b57678e4241fab801599b3913ba">00481</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#26c78b57678e4241fab801599b3913ba">start_monitor_action</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l00484"></a>00484    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l00485"></a>00485    <span class="keyword">const</span> <span class="keywordtype">char</span> *fname = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"File"</span>);
<a name="l00486"></a>00486    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#1ddcb92ade31c8fbd370001f9b29a7d9">format</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Format"</span>);
<a name="l00487"></a>00487    <span class="keyword">const</span> <span class="keywordtype">char</span> *mix = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Mix"</span>);
<a name="l00488"></a>00488    <span class="keywordtype">char</span> *d;
<a name="l00489"></a>00489    
<a name="l00490"></a>00490    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l00491"></a>00491       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> 0;
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l00495"></a>00495    <span class="keywordflow">if</span> (!c) {
<a name="l00496"></a>00496       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l00497"></a>00497       <span class="keywordflow">return</span> 0;
<a name="l00498"></a>00498    }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname)) {
<a name="l00501"></a>00501       <span class="comment">/* No filename base specified, default to channel name as per CLI */</span>    
<a name="l00502"></a>00502       <span class="keywordflow">if</span> (!(fname = <a class="code" href="utils_8h.html#d67aacdb581292a9d103cf349d0d2862">ast_strdup</a>(c-&gt;name))) {
<a name="l00503"></a>00503          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Could not start monitoring channel"</span>);
<a name="l00504"></a>00504          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00505"></a>00505          <span class="keywordflow">return</span> 0;
<a name="l00506"></a>00506       }
<a name="l00507"></a>00507       <span class="comment">/* Channels have the format technology/channel_name - have to replace that /  */</span>
<a name="l00508"></a>00508       <span class="keywordflow">if</span> ((d = strchr(fname, <span class="charliteral">'/'</span>))) 
<a name="l00509"></a>00509          *d = <span class="charliteral">'-'</span>;
<a name="l00510"></a>00510    }
<a name="l00511"></a>00511    
<a name="l00512"></a>00512    <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#4f4e162179064c9f0c8444a33f6fe27d">ast_monitor_start</a>(c, format, fname, 1)) {
<a name="l00513"></a>00513       <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a>(c, fname, 1)) {
<a name="l00514"></a>00514          <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Could not start monitoring channel"</span>);
<a name="l00515"></a>00515          <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00516"></a>00516          <span class="keywordflow">return</span> 0;
<a name="l00517"></a>00517       }
<a name="l00518"></a>00518    }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(mix)) {
<a name="l00521"></a>00521       <a class="code" href="monitor_8h.html#21b1d71c9387ac99b6c5a7066a8a845c">ast_monitor_setjoinfiles</a>(c, 1);
<a name="l00522"></a>00522    }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00525"></a>00525    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Started monitoring channel"</span>);
<a name="l00526"></a>00526    <span class="keywordflow">return</span> 0;
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="res__monitor_8c.html#648a6d4f8e9ae37c4ef2bf38149a0f95">00529</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__monitor_8c.html#648a6d4f8e9ae37c4ef2bf38149a0f95">stop_monitor_action_help</a>[] =
<a name="l00530"></a>00530 <span class="stringliteral">"Description: The 'StopMonitor' action may be used to end a previously\n"</span>
<a name="l00531"></a>00531 <span class="stringliteral">"  started 'Monitor' action.  The only parameter is 'Channel', the name\n"</span>
<a name="l00532"></a>00532 <span class="stringliteral">"  of the channel monitored.\n"</span>;
<a name="l00533"></a>00533 
<a name="l00534"></a><a class="code" href="res__monitor_8c.html#58b9d45bc3bee946151e63afd5e3af82">00534</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#58b9d45bc3bee946151e63afd5e3af82">stop_monitor_action</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l00537"></a>00537    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l00538"></a>00538    <span class="keywordtype">int</span> res;
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l00540"></a>00540       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l00541"></a>00541       <span class="keywordflow">return</span> 0;
<a name="l00542"></a>00542    }
<a name="l00543"></a>00543    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l00544"></a>00544    <span class="keywordflow">if</span> (!c) {
<a name="l00545"></a>00545       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l00546"></a>00546       <span class="keywordflow">return</span> 0;
<a name="l00547"></a>00547    }
<a name="l00548"></a>00548    res = <a class="code" href="monitor_8h.html#0105c193291bd5aa095b584f2f4ea126">ast_monitor_stop</a>(c, 1);
<a name="l00549"></a>00549    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00550"></a>00550    <span class="keywordflow">if</span> (res) {
<a name="l00551"></a>00551       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Could not stop monitoring channel"</span>);
<a name="l00552"></a>00552       <span class="keywordflow">return</span> 0;
<a name="l00553"></a>00553    }
<a name="l00554"></a>00554    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Stopped monitoring channel"</span>);
<a name="l00555"></a>00555    <span class="keywordflow">return</span> 0;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a><a class="code" href="res__monitor_8c.html#860d493d5f2c49f9c46d3b0370087e63">00558</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__monitor_8c.html#860d493d5f2c49f9c46d3b0370087e63">change_monitor_action_help</a>[] =
<a name="l00559"></a>00559 <span class="stringliteral">"Description: The 'ChangeMonitor' action may be used to change the file\n"</span>
<a name="l00560"></a>00560 <span class="stringliteral">"  started by a previous 'Monitor' action.  The following parameters may\n"</span>
<a name="l00561"></a>00561 <span class="stringliteral">"  be used to control this:\n"</span>
<a name="l00562"></a>00562 <span class="stringliteral">"  Channel     - Required.  Used to specify the channel to record.\n"</span>
<a name="l00563"></a>00563 <span class="stringliteral">"  File        - Required.  Is the new name of the file created in the\n"</span>
<a name="l00564"></a>00564 <span class="stringliteral">"                monitor spool directory.\n"</span>;
<a name="l00565"></a>00565 
<a name="l00566"></a><a class="code" href="res__monitor_8c.html#5ea0fb3c84d771342d01a92f9234a6da">00566</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#5ea0fb3c84d771342d01a92f9234a6da">change_monitor_action</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l00569"></a>00569    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l00570"></a>00570    <span class="keyword">const</span> <span class="keywordtype">char</span> *fname = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"File"</span>);
<a name="l00571"></a>00571    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l00572"></a>00572       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l00573"></a>00573       <span class="keywordflow">return</span> 0;
<a name="l00574"></a>00574    }
<a name="l00575"></a>00575    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(fname)) {
<a name="l00576"></a>00576       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No filename specified"</span>);
<a name="l00577"></a>00577       <span class="keywordflow">return</span> 0;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l00580"></a>00580    <span class="keywordflow">if</span> (!c) {
<a name="l00581"></a>00581       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l00582"></a>00582       <span class="keywordflow">return</span> 0;
<a name="l00583"></a>00583    }
<a name="l00584"></a>00584    <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#b920883a248d93215cda31effa692ed3">ast_monitor_change_fname</a>(c, fname, 1)) {
<a name="l00585"></a>00585       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"Could not change monitored filename of channel"</span>);
<a name="l00586"></a>00586       <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00587"></a>00587       <span class="keywordflow">return</span> 0;
<a name="l00588"></a>00588    }
<a name="l00589"></a>00589    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00590"></a>00590    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, <span class="stringliteral">"Changed monitor filename"</span>);
<a name="l00591"></a>00591    <span class="keywordflow">return</span> 0;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a><a class="code" href="res__monitor_8c.html#21b1d71c9387ac99b6c5a7066a8a845c">00594</a> <span class="keywordtype">void</span> <a class="code" href="monitor_8h.html#21b1d71c9387ac99b6c5a7066a8a845c">ast_monitor_setjoinfiles</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">int</span> turnon)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>)
<a name="l00597"></a>00597       chan-&gt;<a class="code" href="structast__channel.html#08b5411f848a2581a41672a759c87380">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#55dc53055b6d97c2c86b93c76c625b85">joinfiles</a> = turnon;
<a name="l00598"></a>00598 }
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808">00600</a> <span class="keyword">enum</span> <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808">MONITOR_PAUSING_ACTION</a>
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602    <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808d5249337a1ee77f3527aa8a4e9d147a3">MONITOR_ACTION_PAUSE</a>,
<a name="l00603"></a>00603    <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808f66a95032107278b7f7d6a0fcc34b330">MONITOR_ACTION_UNPAUSE</a>
<a name="l00604"></a>00604 };
<a name="l00605"></a>00605      
<a name="l00606"></a><a class="code" href="res__monitor_8c.html#826d389d5bb7319e0a39ed9fa42d7b5f">00606</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#826d389d5bb7319e0a39ed9fa42d7b5f">do_pause_or_unpause</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">int</span> action)
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608    <span class="keyword">struct </span><a class="code" href="structast__channel.html">ast_channel</a> *c = NULL;
<a name="l00609"></a>00609    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a> = <a class="code" href="group__Group__AMI.html#gd208abe83c7bd47d8004134de94d1b4b">astman_get_header</a>(m, <span class="stringliteral">"Channel"</span>);
<a name="l00610"></a>00610    
<a name="l00611"></a>00611    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(name)) {
<a name="l00612"></a>00612       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No channel specified"</span>);
<a name="l00613"></a>00613       <span class="keywordflow">return</span> -1;
<a name="l00614"></a>00614    }
<a name="l00615"></a>00615    
<a name="l00616"></a>00616    c = <a class="code" href="channel_8c.html#e01fecb172f34785571d94adbc5c6558">ast_get_channel_by_name_locked</a>(name);
<a name="l00617"></a>00617    <span class="keywordflow">if</span> (!c) {
<a name="l00618"></a>00618       <a class="code" href="group__Group__AMI.html#g23a27dba104a8df4bb1c6a217a71e7e7">astman_send_error</a>(s, m, <span class="stringliteral">"No such channel"</span>);
<a name="l00619"></a>00619       <span class="keywordflow">return</span> -1;
<a name="l00620"></a>00620    }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622    <span class="keywordflow">if</span> (action == <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808d5249337a1ee77f3527aa8a4e9d147a3">MONITOR_ACTION_PAUSE</a>)
<a name="l00623"></a>00623       <a class="code" href="monitor_8h.html#ce422ff6a5850f68e038e967a5b094ce">ast_monitor_pause</a>(c);
<a name="l00624"></a>00624    <span class="keywordflow">else</span>
<a name="l00625"></a>00625       <a class="code" href="monitor_8h.html#7cfb30d07bb72866508802173a655ba1">ast_monitor_unpause</a>(c);
<a name="l00626"></a>00626    
<a name="l00627"></a>00627    <a class="code" href="lock_8h.html#a2fac4e1b143bef3b1ac807e0ab48f9f">ast_channel_unlock</a>(c);
<a name="l00628"></a>00628    <a class="code" href="group__Group__AMI.html#g0c64878b307241bfe01cea67e09f49e2">astman_send_ack</a>(s, m, (action == <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808d5249337a1ee77f3527aa8a4e9d147a3">MONITOR_ACTION_PAUSE</a> ? <span class="stringliteral">"Paused monitoring of the channel"</span> : <span class="stringliteral">"Unpaused monitoring of the channel"</span>));
<a name="l00629"></a>00629    <span class="keywordflow">return</span> 0;   
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00632"></a><a class="code" href="res__monitor_8c.html#6c3d197ea8953d85e1c9c07e03f469cf">00632</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__monitor_8c.html#6c3d197ea8953d85e1c9c07e03f469cf">pause_monitor_action_help</a>[] =
<a name="l00633"></a>00633    <span class="stringliteral">"Description: The 'PauseMonitor' action may be used to temporarily stop the\n"</span>
<a name="l00634"></a>00634    <span class="stringliteral">" recording of a channel.  The following parameters may\n"</span>
<a name="l00635"></a>00635    <span class="stringliteral">" be used to control this:\n"</span>
<a name="l00636"></a>00636    <span class="stringliteral">"  Channel     - Required.  Used to specify the channel to record.\n"</span>;
<a name="l00637"></a>00637 
<a name="l00638"></a><a class="code" href="res__monitor_8c.html#9a5d6283c7e1dce6f1eb3e36c0f8d91a">00638</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#9a5d6283c7e1dce6f1eb3e36c0f8d91a">pause_monitor_action</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#826d389d5bb7319e0a39ed9fa42d7b5f">do_pause_or_unpause</a>(s, m, <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808d5249337a1ee77f3527aa8a4e9d147a3">MONITOR_ACTION_PAUSE</a>);
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="res__monitor_8c.html#4300d9ae52421248c07e1dccf8a8db92">00643</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__monitor_8c.html#4300d9ae52421248c07e1dccf8a8db92">unpause_monitor_action_help</a>[] =
<a name="l00644"></a>00644    <span class="stringliteral">"Description: The 'UnpauseMonitor' action may be used to re-enable recording\n"</span>
<a name="l00645"></a>00645    <span class="stringliteral">"  of a channel after calling PauseMonitor.  The following parameters may\n"</span>
<a name="l00646"></a>00646    <span class="stringliteral">"  be used to control this:\n"</span>
<a name="l00647"></a>00647    <span class="stringliteral">"  Channel     - Required.  Used to specify the channel to record.\n"</span>;
<a name="l00648"></a>00648 
<a name="l00649"></a><a class="code" href="res__monitor_8c.html#7d893f85ee899d6ea8a678f3c7073497">00649</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__monitor_8c.html#7d893f85ee899d6ea8a678f3c7073497">unpause_monitor_action</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#826d389d5bb7319e0a39ed9fa42d7b5f">do_pause_or_unpause</a>(s, m, <a class="code" href="res__monitor_8c.html#b3c2654283d3b96950e8b01662a31808f66a95032107278b7f7d6a0fcc34b330">MONITOR_ACTION_UNPAUSE</a>);
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653    
<a name="l00654"></a>00654 
<a name="l00655"></a><a class="code" href="res__monitor_8c.html#8c304b271325d497b3ce1886465a1abe">00655</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<span class="stringliteral">"Monitor"</span>, <a class="code" href="res__monitor_8c.html#8c8ffb4a06ac76e2003ebad5e996b7df">start_monitor_exec</a>, <a class="code" href="res__monitor_8c.html#df3922cb467d96b1aae7041602d12c35">monitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#681043e0ddb4a9a1836d8ec08412eca8">monitor_descrip</a>);
<a name="l00658"></a>00658    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<span class="stringliteral">"StopMonitor"</span>, <a class="code" href="res__monitor_8c.html#00b0c4e9a4b3dd7484dde4e70ac92280">stop_monitor_exec</a>, <a class="code" href="res__monitor_8c.html#d9cb00ce4df1736a36231353bfa99331">stopmonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#8809f3d6c94380a4882693904571dcc7">stopmonitor_descrip</a>);
<a name="l00659"></a>00659    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<span class="stringliteral">"ChangeMonitor"</span>, <a class="code" href="res__monitor_8c.html#8493693fbf9d36a242c39c5dfa74866e">change_monitor_exec</a>, <a class="code" href="res__monitor_8c.html#a975422a90da2977d2baccceac5ff7bd">changemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#3451fedc38324771782eb144504a0755">changemonitor_descrip</a>);
<a name="l00660"></a>00660    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<span class="stringliteral">"PauseMonitor"</span>, <a class="code" href="res__monitor_8c.html#1ee3ab9d4dd8fc24b6150e2ff24be88d">pause_monitor_exec</a>, <a class="code" href="res__monitor_8c.html#9d89d89fe7cdc2abd6ef1ead4b4a52d7">pausemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#361f387bf41f76944e8dd79fd2cc6419">pausemonitor_descrip</a>);
<a name="l00661"></a>00661    <a class="code" href="pbx_8c.html#f8e9b339fed38c405332f222cceeec40">ast_register_application</a>(<span class="stringliteral">"UnpauseMonitor"</span>, <a class="code" href="res__monitor_8c.html#d841652a300b977fad6ff263c0351b0f">unpause_monitor_exec</a>, <a class="code" href="res__monitor_8c.html#ac04a66d69ebd954ce39f054d6fbcf94">unpausemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#ff764e2301f43fd063914051e1ff3eed">unpausemonitor_descrip</a>);
<a name="l00662"></a>00662    <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"Monitor"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__monitor_8c.html#26c78b57678e4241fab801599b3913ba">start_monitor_action</a>, <a class="code" href="res__monitor_8c.html#df3922cb467d96b1aae7041602d12c35">monitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#75e51867ced5678ac326cfc1405fd83b">start_monitor_action_help</a>);
<a name="l00663"></a>00663    <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"StopMonitor"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__monitor_8c.html#58b9d45bc3bee946151e63afd5e3af82">stop_monitor_action</a>, <a class="code" href="res__monitor_8c.html#d9cb00ce4df1736a36231353bfa99331">stopmonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#648a6d4f8e9ae37c4ef2bf38149a0f95">stop_monitor_action_help</a>);
<a name="l00664"></a>00664    <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"ChangeMonitor"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__monitor_8c.html#5ea0fb3c84d771342d01a92f9234a6da">change_monitor_action</a>, <a class="code" href="res__monitor_8c.html#a975422a90da2977d2baccceac5ff7bd">changemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#860d493d5f2c49f9c46d3b0370087e63">change_monitor_action_help</a>);
<a name="l00665"></a>00665    <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"PauseMonitor"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__monitor_8c.html#9a5d6283c7e1dce6f1eb3e36c0f8d91a">pause_monitor_action</a>, <a class="code" href="res__monitor_8c.html#9d89d89fe7cdc2abd6ef1ead4b4a52d7">pausemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#6c3d197ea8953d85e1c9c07e03f469cf">pause_monitor_action_help</a>);
<a name="l00666"></a>00666    <a class="code" href="group__Group__AMI.html#g84a70f66019d4cf74b8e203011d22431">ast_manager_register2</a>(<span class="stringliteral">"UnpauseMonitor"</span>, <a class="code" href="manager_8h.html#c81a36aac6503176bd649993386b23e4">EVENT_FLAG_CALL</a>, <a class="code" href="res__monitor_8c.html#7d893f85ee899d6ea8a678f3c7073497">unpause_monitor_action</a>, <a class="code" href="res__monitor_8c.html#ac04a66d69ebd954ce39f054d6fbcf94">unpausemonitor_synopsis</a>, <a class="code" href="res__monitor_8c.html#4300d9ae52421248c07e1dccf8a8db92">unpause_monitor_action_help</a>);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    <span class="keywordflow">return</span> 0;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="res__monitor_8c.html#eaf793e807a29b69460b0c6c94a79a0b">00671</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<span class="stringliteral">"Monitor"</span>);
<a name="l00674"></a>00674    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<span class="stringliteral">"StopMonitor"</span>);
<a name="l00675"></a>00675    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<span class="stringliteral">"ChangeMonitor"</span>);
<a name="l00676"></a>00676    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<span class="stringliteral">"PauseMonitor"</span>);
<a name="l00677"></a>00677    <a class="code" href="pbx_8c.html#4fc9ac8a7093a1f73637df0b9d6d6de9">ast_unregister_application</a>(<span class="stringliteral">"UnpauseMonitor"</span>);
<a name="l00678"></a>00678    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"Monitor"</span>);
<a name="l00679"></a>00679    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"StopMonitor"</span>);
<a name="l00680"></a>00680    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"ChangeMonitor"</span>);
<a name="l00681"></a>00681    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"PauseMonitor"</span>);
<a name="l00682"></a>00682    <a class="code" href="group__Group__AMI.html#g2ec5f3830dfb4a55fdf0ad8e78bc0db6">ast_manager_unregister</a>(<span class="stringliteral">"UnpauseMonitor"</span>);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684    <span class="keywordflow">return</span> 0;
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="comment">/* usecount semantics need to be defined */</span>
<a name="l00688"></a>00688 <a class="code" href="module_8h.html#237cb97341e39c38b6e3ecb88b7ea148">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#b4566594eeb42c8fc7d6733c7b4b6c0a0b99d39f1f6a9afeedd2f8e6632dd76c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">"Call Monitoring Resource"</span>,
<a name="l00689"></a>00689       .load = <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>,
<a name="l00690"></a>00690       .unload = <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>,
<a name="l00691"></a>00691       );
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:50 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
